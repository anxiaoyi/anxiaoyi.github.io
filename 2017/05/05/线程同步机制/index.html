<html>
<head>
	
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><title>线程同步机制</title>
	<meta name="keywords" content="代码人生,程序员,赵坤" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>

<body>

<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 id="线程同步机制"><a href="#线程同步机制" class="headerlink" title="线程同步机制"></a>线程同步机制</h2><h3 id="Linux-线程同步机制"><a href="#Linux-线程同步机制" class="headerlink" title="Linux 线程同步机制"></a>Linux 线程同步机制</h3><ul>
<li>mutexes - Mutual exclusion lock (互斥锁):</li>
<li>joins - 让一个线程等待其他线程结束</li>
<li>condition variables 条件变量 - 数据类型 <code>pthread_cond_t</code></li>
</ul>
<h3 id="1-Mutexes"><a href="#1-Mutexes" class="headerlink" title="1. Mutexes"></a>1. Mutexes</h3><p><strong>A <code>mutex</code> is basically a lock that we set (lock) before accessing a shared resource and release (unlock) when we’re done.</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Note scope of variable and mutex are the same */</span></div><div class="line"><span class="keyword">pthread_mutex_t</span> mutex1 = PTHREAD_MUTEX_INITIALIZER;</div><div class="line"><span class="keyword">int</span> counter=<span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="comment">/* Function C */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">functionC</span><span class="params">()</span> </span>&#123;</div><div class="line">    pthread_mutex_lock( &amp;mutex1 );</div><div class="line">    counter++;</div><div class="line">    pthread_mutex_unlock( &amp;mutex1 );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当使用两个或以上的 <strong>Mutexes</strong> 的时候，一定要注意防范死锁问题，切记对加锁的顺序问题重点关注。</p>
<h3 id="2-Joins"><a href="#2-Joins" class="headerlink" title="2. Joins"></a>2. Joins</h3><p>一个线程等待另外一个线程结束</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NTHREADS 10</span></div><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_function</span><span class="params">(<span class="keyword">void</span> *)</span></span>;</div><div class="line"><span class="keyword">pthread_mutex_t</span> mutex1 = PTHREAD_MUTEX_INITIALIZER;</div><div class="line"><span class="keyword">int</span>  counter = <span class="number">0</span>;</div><div class="line"></div><div class="line">main() &#123;</div><div class="line">    <span class="keyword">pthread_t</span> thread_id[NTHREADS];</div><div class="line">    <span class="keyword">int</span> i, j;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; NTHREADS; i++) &#123;</div><div class="line">        pthread_create( &amp;thread_id[i], <span class="literal">NULL</span>, thread_function, <span class="literal">NULL</span> );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>; j &lt; NTHREADS; j++) &#123;</div><div class="line">        <span class="comment">// 主线程等待 thread_id[j] 结束</span></div><div class="line">        pthread_join( thread_id[j], <span class="literal">NULL</span>); </div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="comment">// 走到这个地方说明所有线程都已经结束了</span></div><div class="line"></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Final counter value: %d\n"</span>, counter);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_function</span><span class="params">(<span class="keyword">void</span> *dummyPtr)</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Thread number %ld\n"</span>, pthread_self());</div><div class="line">    pthread_mutex_lock( &amp;mutex1 );</div><div class="line">    counter++;</div><div class="line">    pthread_mutex_unlock( &amp;mutex1 );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-Condition-Variables"><a href="#3-Condition-Variables" class="headerlink" title="3. Condition Variables"></a>3. Condition Variables</h3><p><strong>Condition Variables</strong> 总是应该和 <strong>Mutex</strong> 一块使用来避免竞态条件。使用 <strong>Condition Variables</strong> 的函数:</p>
<ul>
<li>创建/销毁<ul>
<li><code>pthread_cond_init</code></li>
<li><code>pthread_cond_t cond = PTHREAD_COND_INITIALIZER;</code></li>
<li><code>pthread_cond_destroy</code></li>
</ul>
</li>
<li>等待一个 Condition<ul>
<li><code>pthread_cond_wait</code></li>
<li><code>pthread_cond_timedwait</code> - 阻塞多久</li>
</ul>
</li>
<li>唤醒在某个 Condition 上的线程<ul>
<li><code>pthread_cond_signal</code></li>
<li><code>pthread_cond_broadcast</code> - 唤醒等待在这个 Condition 上的所有线程</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">pthread_mutex_t</span> condition_mutex = PTHREAD_MUTEX_INITIALIZER;</div><div class="line"><span class="keyword">pthread_cond_t</span>  condition_cond  = PTHREAD_COND_INITIALIZER;</div><div class="line"></div><div class="line"><span class="keyword">for</span>(;;) &#123;</div><div class="line">    <span class="comment">// 改变 condition_cond 状态之前，必须先锁住 Mutex</span></div><div class="line">    pthread_mutex_lock( &amp;condition_mutex );</div><div class="line">    <span class="keyword">while</span>( count &gt;= COUNT_HALT1 &amp;&amp; count &lt;= COUNT_HALT2 ) &#123;</div><div class="line">        pthread_cond_wait( &amp;condition_cond, &amp;condition_mutex );</div><div class="line">    &#125;</div><div class="line">    pthread_mutex_unlock( &amp;condition_mutex );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://www.cs.cmu.edu/afs/cs/academic/class/15492-f07/www/pthreads.html" target="_blank" rel="external">POSIX thread (pthread) libraries</a></li>
<li><a href="https://www.amazon.com/Advanced-Programming-UNIX-Environment-3rd/dp/0321637739/" target="_blank" rel="external">《Advanced Programming in the UNIX Environment 3rd Edition》</a></li>
</ul><!-- hexo-inject:begin --><!-- hexo-inject:end -->






</body>
</html>
