<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tomcat | 代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Tomcat 目录说明:  编译12cd $&amp;#123;tomcat.source&amp;#125;ant 编译成功之后，一个可以使用的 tomcat 被放在了目录: 1$&amp;#123;tomcat.source&amp;#125;/output/build  编译成 eclipse 项目，可以使用参考。 注意，在执行 ant ide-eclipse 之前必须先执行 ant 这个命令，否则执行不成功。 日志问题W">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat">
<meta property="og:url" content="http://blog.kunzhao.org/2017/06/14/Tomcat/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="Tomcat 目录说明:  编译12cd $&amp;#123;tomcat.source&amp;#125;ant 编译成功之后，一个可以使用的 tomcat 被放在了目录: 1$&amp;#123;tomcat.source&amp;#125;/output/build  编译成 eclipse 项目，可以使用参考。 注意，在执行 ant ide-eclipse 之前必须先执行 ant 这个命令，否则执行不成功。 日志问题W">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/tomcat_architecture.jpg">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/tomcat_folder.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/2017_12_29_23_09_10.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/2017_12_30_10_43_49.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/2017_12_30_14_05_37.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/2017_12_30_14_08_36.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/container.svg">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/wrapper_hierarchy.svg">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/valve_hierarchy.svg">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/17-06-15-15_28_10_377_316.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/17-06-15-15_28_40_212_474.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/17-06-15-15_54_12_1085_203.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/17-06-15-17_06_18_716_155.png">
<meta property="og:updated_time" content="2017-12-30T09:41:07.555Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tomcat">
<meta name="twitter:description" content="Tomcat 目录说明:  编译12cd $&amp;#123;tomcat.source&amp;#125;ant 编译成功之后，一个可以使用的 tomcat 被放在了目录: 1$&amp;#123;tomcat.source&amp;#125;/output/build  编译成 eclipse 项目，可以使用参考。 注意，在执行 ant ide-eclipse 之前必须先执行 ant 这个命令，否则执行不成功。 日志问题W">
<meta name="twitter:image" content="http://blog.kunzhao.org/2017/06/14/Tomcat/tomcat_architecture.jpg">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Tomcat" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/14/Tomcat/" class="article-date">
  <time datetime="2017-06-14T12:34:37.000Z" itemprop="datePublished">2017-06-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Tomcat
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h2><p><img src="tomcat_architecture.jpg" alt=""></p>
<p>目录说明:</p>
<p><img src="tomcat_folder.png" alt=""></p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd $&#123;tomcat.source&#125;</div><div class="line">ant</div></pre></td></tr></table></figure>
<p>编译成功之后，一个可以使用的 <code>tomcat</code> 被放在了目录:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$&#123;tomcat.source&#125;/output/build</div></pre></td></tr></table></figure>
<hr>
<p>编译成 <code>eclipse</code> 项目，可以使用<a href="https://tomcat.apache.org/tomcat-8.5-doc/building.html" target="_blank" rel="external">参考</a>。</p>
<p>注意，在执行 <code>ant ide-eclipse</code> 之前必须先执行 <code>ant</code> 这个命令，否则执行不成功。</p>
<h3 id="日志问题"><a href="#日志问题" class="headerlink" title="日志问题"></a>日志问题</h3><p>When running Tomcat on unixes, the <strong>console output (控制台输出)</strong> is usually redirected to the <strong>file (文件)</strong> named <code>catalina.out</code>.</p>
<p>要想从 <code>eclipse</code> 中启动能够查看 <code>Debug</code> 级别的<a href="https://stackoverflow.com/questions/2233053/where-can-i-view-tomcat-log-files-in-eclipse" target="_blank" rel="external">输出日志</a>，需要做如下两个步骤:</p>
<p>(1) 需要<strong>添加更多系统参数</strong>:</p>
<p><img src="2017_12_29_23_09_10.png" alt="start-tomcat"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-Dcatalina.home=$&#123;project_loc:/tomcat-<span class="number">9.0</span>.x/java/org/apache/catalina/startup/Bootstrap.java&#125;/output/build</div><div class="line">-Djava.util.logging.config.file=$&#123;project_loc:/tomcat-<span class="number">9.0</span>.x/java/org/apache/catalina/startup/Bootstrap.java&#125;/conf/logging.properties</div><div class="line">-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager</div></pre></td></tr></table></figure>
<p>(2) 另外一个重要的地方，就是需要编辑 <code>conf/logging.properties</code> 文件，添加如下一句话:</p>
<p><a href="2017_12_29_23_10_59.png">logging.properties</a></p>
<h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><ul>
<li><strong><code>org.apache.catalina.Lifecycle</code></strong>: 通用组件的声明周期接口, 可以 <code>start()</code>, <code>stop()</code>, <code>destroy()</code> 等</li>
<li><strong><code>org.apache.catalina.LifecycleListener</code></strong>: 监听一些重要事件</li>
</ul>
<p>容器为了实现自己的功能经常要绑定一些其他组件,这些组件的功能可能被共享,也可以被单独定制,下面是被使用的组件:</p>
<ul>
<li><strong><code>Loader</code></strong>:<code>ClassLoader</code>,加载 Java Classes;</li>
<li><strong><code>Logger</code></strong>:实现了 <code>ServletContext</code> 的 log 方法,用于记录日志;</li>
<li><strong><code>Manager</code></strong>:管理与容器绑定的 <code>Session</code> 池;</li>
<li><strong><code>Realm</code></strong>: 用户安全管理</li>
<li><strong><code>Resources</code></strong>: JNDI 资源访问</li>
<li><strong><code>org.apache.catalina.ContainerListener</code></strong>: 容器事件监听器</li>
</ul>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>启动 tomcat 有两种方式：</p>
<ul>
<li>双击 <code>bin/startup.sh</code></li>
<li>运行 <code>bin/catalina.sh run</code></li>
</ul>
<p>它们对应于 <code>Bootstrap</code> 与 <code>Catalina</code> 两个类，我们现在只关心 <code>Catalina</code> 这个类，这个类使用 <code>Apache Digester</code> 解析 <code>conf/server.xml</code> 文件生成 tomcat 组件，然后再调用 <code>Embedded</code>类的 <code>start</code> 方法启动 tomcat。</p>
<p>所以，集成 Tomcat 的方式就有以下两种了：</p>
<ul>
<li>沿用 tomcat 自身的 <code>server.xml</code></li>
<li>自己定义一个 <code>xml</code> 格式来配置 tocmat 的各参数，自己再写解析这段 xml，然后使用 tomcat 提供的 API 根据这些 xml 来生成 Tomcat 组件，最后调用 <code>Embedded</code> 类的 <code>start</code> 方法启动 tomcat</li>
</ul>
<p><strong>Bootstrap 初始化</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">initClassLoaders()</div></pre></td></tr></table></figure>
<p>创建三种类型的加载器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">createClassLoader(<span class="string">"common"</span>, <span class="keyword">null</span>);</div><div class="line">catalinaLoader = createClassLoader(<span class="string">"server"</span>, commonLoader);</div><div class="line">sharedLoader = createClassLoader(<span class="string">"shared"</span>, commonLoader);</div></pre></td></tr></table></figure>
<p><strong>Bootstrap main 执行命令</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (command.equals(<span class="string">"startd"</span>)) &#123;</div><div class="line">    daemon.start();</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stopd"</span>)) &#123;</div><div class="line">    daemon.stop();</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"start"</span>)) &#123;</div><div class="line">    daemon.start();</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stop"</span>)) &#123;</div><div class="line">    daemon.stopServer(args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<font color="red"><strong>(1) <code>ClassLoader</code> 加载 <code>jar</code> 包:</strong></font>

<p><strong>重点方法: <code>Bootstrap#initClassLoaders()</code></strong></p>
<p><img src="2017_12_30_10_43_49.png" alt="Boostrap"></p>
<font color="red"><strong>(2) 初始化 <code>Digester</code> 并解析 <code>conf/server.xml</code> 文件:</strong></font>

<p><strong>重点方法: <code>Catalina#load()</code></strong></p>
<p><code>Tomcat</code> 将 <code>server.xml</code> 中的各个<strong>元素的节点路径</strong>映射为一个 <code>pattern</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span></span></div><div class="line"><span class="tag">              <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span></span></div><div class="line"><span class="tag">              <span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span></span></div><div class="line"><span class="tag">              <span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span></span></div><div class="line"><span class="tag">              <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></div></pre></td></tr></table></figure>
<p>如上 <code>conf/server.xml</code> 片段可以映射为如下四个路径，也就是 <code>Tomcat</code> 概念里的 <code>pattern</code>:</p>
<ul>
<li><code>Server</code></li>
<li><code>Server/Listener</code></li>
<li><code>Server/Listener/GlobalNamingResources</code></li>
<li><code>Server/Listener/GlobalNamingResources/Resource</code></li>
</ul>
<p>当遇见一个 <code>pattern</code> 的时候，便执行相应的动作。如下，当遇见 <code>Server/GlobalNamingResources</code> 的时候，便创建一个 <code>NamingResourcesImpl</code> 类:</p>
<p><img src="2017_12_30_14_05_37.png" alt="GlobalNamingResources"></p>
<p>当遇见 <code>Server</code> 的时候，便创建一个 <code>StandardServer</code> 类:</p>
<p><img src="2017_12_30_14_08_36.png" alt="StandardServer"></p>
<font color="red"><strong>(3) 解析 <code>mbeans-descriptors.xml</code> 文件:</strong></font>

<p>其中 <code>mbeans-descriptors.xml</code> 的详细路径为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;TOMCAT_BASE&#125;.settings/output/org/apache/catalina/authenticator/mbeans-descriptors.xml</div><div class="line">&#123;TOMCAT_BASE&#125;.settings/output/org/apache/catalina/core/mbeans-descriptors.xml</div><div class="line">&#123;TOMCAT_BASE&#125;.settings/output/org/apache/catalina/mbeans-descriptors.xml</div><div class="line">...</div></pre></td></tr></table></figure>
<p><strong>Catalina 在 start() 中启动 Server</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">shutdownHook = <span class="keyword">new</span> CatalinaShutdownHook();</div><div class="line">Runtime.getRuntime().addShutdownHook(shutdownHook);</div></pre></td></tr></table></figure>
<p><strong>Catalina 在 stop() 删除容器</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Runtime.getRuntime().removeShutdownHook(shutdownHook);</div><div class="line">Server s = getServer();</div><div class="line">s.stop();</div></pre></td></tr></table></figure>
<p><strong>在 stopServer中 停止 Catalina 服务</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> (Socket socket = <span class="keyword">new</span> Socket(s.getAddress(), s.getPort());</div><div class="line">     OutputStream stream = socket.getOutputStream()) &#123;</div><div class="line">    String shutdown = s.getShutdown();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shutdown.length(); i++) &#123;</div><div class="line">        stream.write(shutdown.charAt(i));</div><div class="line">    &#125;</div><div class="line">    stream.flush();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h3><p><strong>容器是用来处理请求 <code>servlet</code> 资源，并为客户端填充 <code>response</code> 对象的模块。</strong> Tomcat 共有四种类型的容器:</p>
<ul>
<li><code>Engine</code>: 整个 <code>Catalina Servlet</code> 引擎</li>
<li><code>Host</code>: 表示包含有一个或者多个 <code>Context</code> 容器的虚拟主机</li>
<li><code>Context</code>: 表示一个 <code>Web</code> 应用程序，一个 <code>Context</code> 可以有多个 <code>Wrapper</code></li>
<li><code>Wrapper</code>: 表示一个独立的 <code>Servlet</code></li>
</ul>
<p><img src="container.svg" alt=""></p>
<h4 id="Wrapper"><a href="#Wrapper" class="headerlink" title="Wrapper"></a>Wrapper</h4><p><img src="wrapper_hierarchy.svg" alt=""></p>
<p><code>Wrapper</code> 中的 <code>allocate()</code> 方法会分配一个已经初始化的 <code>servlet</code> 实例，<code>load()</code> 方法载入并初始化 <code>Servlet</code> 类。</p>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p><code>Server</code> 的实现类: <code>org.apache.catalina.core.StandardServer.java</code></p>
<ul>
<li><strong><code>Server</code></strong>: 启动和监听服务端事件 (重启、关闭等)</li>
</ul>
<p><strong>读取资源</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">globalNamingResources = <span class="keyword">new</span> NamingResourcesImpl();</div><div class="line">globalNamingResources.setContainer(<span class="keyword">this</span>);</div></pre></td></tr></table></figure>
<p><strong>初始化</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    <span class="keyword">super</span>.initInternal();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">        services[i].init();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>启动所有 <code>Service</code></strong>:</p>
<p>在 <code>Tomcat</code> 中，组件的生命周期是通过 <code>Lifecycle</code> 接口来控制的，即父组件控制子组件的生命周期。如 <code>StandardServer</code> 启动多个 <code>Service</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">    fireLifecycleEvent(CONFIGURE_START_EVENT, <span class="keyword">null</span>);</div><div class="line">    setState(LifecycleState.STARTING);</div><div class="line"></div><div class="line">    globalNamingResources.start();</div><div class="line"></div><div class="line">    <span class="comment">// Start our defined Services</span></div><div class="line">    <span class="keyword">synchronized</span> (servicesLock) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">            services[i].start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即简单的循环启动所有 <code>Service</code> 组件的 <code>start</code> 方法。</p>
<p><strong>服务阶段</strong>:</p>
<p>启动一个线程，简历对本机上预定义的 <code>shutdown</code> 端口的 <code>ServerSocket</code> 对象的监听:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> String address = <span class="string">"localhost"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> port = <span class="number">8005</span>;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</div><div class="line">    awaitSocket =</div><div class="line">        <span class="keyword">new</span> ServerSocket(port,</div><div class="line">                         <span class="number">1</span>,</div><div class="line">                         InetAddress.getByName(address));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它循环监听该端口，一旦监听到该端口的字符串命令，就将该命令与配置的 shutdown 字符串进行对比，如果相同则终止当前的线程函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> String shutdown = <span class="string">"SHUTDOWN"</span>;</div><div class="line"><span class="keyword">boolean</span> match = command.toString().equals(shutdown);</div><div class="line"><span class="keyword">if</span> (match) &#123;</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>关闭</strong>:</p>
<p>当监听到关闭命令并执行关闭操作时，会调用 <code>stop</code> 函数执行关闭工作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">stopInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">        services[i].stop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p><code>Service</code> 的实现 <code>org.apache.catalina.core.StandardService</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardService</span></span></div><div class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">LifecycleMBeanBase</span></span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>初始化并启动</strong>:</p>
<p>初始化 <code>Engine</code>、所有的 <code>Executor</code>、所有的 <code>Connector</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    <span class="keyword">super</span>.initInternal();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</div><div class="line">        engine.init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize any Executors</span></div><div class="line">    <span class="keyword">for</span> (Executor executor : findExecutors()) &#123;</div><div class="line">        executor.init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize mapper listener</span></div><div class="line">    mapperListener.init();</div><div class="line"></div><div class="line">    <span class="comment">// Initialize our defined Connectors</span></div><div class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</div><div class="line">        <span class="keyword">for</span> (Connector connector : connectors) &#123;</div><div class="line">            connector.init();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>启动 <code>Engine</code>、所有的 <code>Executor</code>、所有的 <code>Connector</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    setState(LifecycleState.STARTING);</div><div class="line"></div><div class="line">    <span class="comment">// Start our defined Container first</span></div><div class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (engine) &#123;</div><div class="line">            engine.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (executors) &#123;</div><div class="line">        <span class="keyword">for</span> (Executor executor: executors) &#123;</div><div class="line">            executor.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mapperListener.start();</div><div class="line"></div><div class="line">    <span class="comment">// Start our defined Connectors second</span></div><div class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</div><div class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</div><div class="line">            connector.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>停止</strong>:</p>
<p>先暂停所有的 <code>Connector</code>，停止 <code>Engine</code>，停止所有的 <code>Connector</code>，停止 <code>mapperListener</code>，停止所有的 <code>Executor</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">stopInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Pause connectors first</span></div><div class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</div><div class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</div><div class="line">            connector.pause();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setState(LifecycleState.STOPPING);</div><div class="line"></div><div class="line">    <span class="comment">// Stop our defined Container second</span></div><div class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (engine) &#123;</div><div class="line">            engine.stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Now stop the connectors</span></div><div class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</div><div class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</div><div class="line">                connector.stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If the Server failed to start, the mapperListener won't have been</span></div><div class="line">    <span class="comment">// started</span></div><div class="line">    <span class="keyword">if</span> (mapperListener.getState() != LifecycleState.INITIALIZED) &#123;</div><div class="line">        mapperListener.stop();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (executors) &#123;</div><div class="line">        <span class="keyword">for</span> (Executor executor: executors) &#123;</div><div class="line">            executor.stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h3><p><code>Connector</code> 组件负责接受浏览器发过来的 TCP 连接请求，创建一个 <code>Request</code> 和 <code>Response</code> 对方分别用于和请求端交换数据，然后会产生一个线程来处理这个请求并把产生的 <code>Request</code> 和 <code>Response</code> 对象传给处理这个请求的线程，处理这个请求的线程就是 <code>Container</code> 组件要做的事情了。</p>
<p>通常我们会用到两种 <code>Connector</code>,一种叫 http connector,用来传递 http 请求;另一种叫 AJP Connector,在整合 Apache 与 Tomcat 工作的时候, Apache 与 Tomcat 之间就是通过这个协议来互动的。 (Apache 与 Tomcat 的整合工作, <strong>通常是为了让 Apache 获取静态资源，而让 Tomcat 来解析动态的 JSP 或者 Servlet</strong>。 )</p>
<p><code>Connector</code> 本身就是一个实现了 <code>LifecycleMBeanBase</code> 的类。</p>
<p><strong>构造加载协议</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName);</div><div class="line">p = (ProtocolHandler) clazz.getConstructor().newInstance();</div></pre></td></tr></table></figure>
<p><strong>启动</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    setState(LifecycleState.STARTING);</div><div class="line">    protocolHandler.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>请求</strong>:</p>
<p>在执行期间，连接器在接收到用户的请求时，会通过以下函数创建请求对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Request <span class="title">createRequest</span><span class="params">()</span> </span>&#123;</div><div class="line">    Request request = <span class="keyword">new</span> Request();</div><div class="line">    request.setConnector(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> (request);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该请求提交给 <code>Engine</code> 处理。</p>
<p><strong>响应</strong>:</p>
<p>当 <code>Engine</code> 返回处理结果给 <code>Connector</code> 时，它会创建一个响应对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">createResponse</span><span class="params">()</span> </span>&#123;</div><div class="line">    Response response = <span class="keyword">new</span> Response();</div><div class="line">    response.setConnector(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> (response);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>并将该对象返回给客户端。</p>
<p><strong>关闭</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">stopInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    setState(LifecycleState.STOPPING);</div><div class="line">    protocolHandler.stop();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="启动-Engine"><a href="#启动-Engine" class="headerlink" title="启动 Engine"></a>启动 Engine</h3><p>当 HTTP Connector 把请求传递给顶级的容器 —— <code>Engine</code> 时, 我们的视线就应该移动到 Container 这个层面来了。在 Container 层,包含了 3 种容器: Engine、Host 和 Context。<code>Engine</code> 收到 Connector 传递过来的请求,经过处理后,将结果返回给 Service(Service 是通过 Connector 这个媒介和 Engine 互动的) 。</p>
<p><code>Engine</code> 的实现类是 <code>org.apache.catalina.core.StandardEngine</code>。</p>
<p><strong>构造、创建过滤阀</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardEngine</span><span class="params">()</span> </span>&#123;</div><div class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardEngineValve());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="启动-Host"><a href="#启动-Host" class="headerlink" title="启动 Host"></a>启动 Host</h3><p><code>Engine</code> 收到 <code>Connector</code> 传递过来的请求后,不会自己处理,而是交给合适的 <code>Host</code> 来处理。Host 在这里就是虚拟主机的意思,通常我们只会使用 “localhost” ,即本地主机来处理。</p>
<p><code>Host</code> 的实现类是: <code>org.apache.catalina.core.StandardHost</code></p>
<p><strong>构造、创建过滤阀</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardHost</span><span class="params">()</span> </span>&#123;</div><div class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardHostValve());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>启动、初始化</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    String errorValve = getErrorReportValveClass();</div><div class="line">    Valve valve =</div><div class="line">        (Valve) Class.forName(errorValve).getConstructor().newInstance();</div><div class="line">    getPipeline().addValve(valve);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>处理请求</strong>:</p>
<p>代码可能不在这个类里面了</p>
<h3 id="启动-Context"><a href="#启动-Context" class="headerlink" title="启动 Context"></a>启动 Context</h3><p><code>Host</code> 接到了从 <code>Engine</code> 传过来的请求后,也不会自己处理,而是交给合适的 <code>Context</code> 来处理,例如 <a href="http://127.0.0.1:8080/foo/index.jsp" target="_blank" rel="external">http://127.0.0.1:8080/foo/index.jsp</a> 和 <a href="http://127.0.1:8080/bar/index.jsp。前者交给" target="_blank" rel="external">http://127.0.1:8080/bar/index.jsp。前者交给</a> foo 这个 <code>Context</code> 处理,后者交给 bar 这个 <code>Context</code> 来处理。</p>
<p><code>Context</code> 的实现类是: <code>org.apache.catalina.core.StandardContext</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardContext</span><span class="params">()</span> </span>&#123;</div><div class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardContextValve());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>启动、初始化</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">    setResources(<span class="keyword">new</span> StandardRoot(<span class="keyword">this</span>));</div><div class="line">    resourcesStart();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;</div><div class="line">        WebappLoader webappLoader = <span class="keyword">new</span> WebappLoader(getParentClassLoader());</div><div class="line">        webappLoader.setDelegate(getDelegate());</div><div class="line">        setLoader(webappLoader);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// An explicit cookie processor hasn't been specified; use the default</span></div><div class="line">    <span class="keyword">if</span> (cookieProcessor == <span class="keyword">null</span>) &#123;</div><div class="line">        cookieProcessor = <span class="keyword">new</span> Rfc6265CookieProcessor();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize character set mapper</span></div><div class="line">    getCharsetMapper();</div><div class="line"></div><div class="line">    <span class="comment">// Post work directory</span></div><div class="line">    postWorkDirectory();</div><div class="line"></div><div class="line">    NamingContextListener ncl = <span class="keyword">new</span> NamingContextListener();</div><div class="line">    ncl.setName(getNamingContextName());</div><div class="line">    ncl.setExceptionOnFailedWrite(getJndiExceptionOnFailedWrite());</div><div class="line">    addLifecycleListener(ncl);</div><div class="line">    setNamingContextListener(ncl);</div><div class="line"></div><div class="line">    <span class="comment">// Binding thread</span></div><div class="line">    ClassLoader oldCCL = bindThread();</div><div class="line"></div><div class="line">    <span class="comment">// Start our subordinate components, if any</span></div><div class="line">    Loader loader = getLoader();</div><div class="line">    ((Lifecycle) loader).start();</div><div class="line"></div><div class="line">    getLogger();</div><div class="line"></div><div class="line">    Realm realm = getRealmInternal();</div><div class="line">    ((Lifecycle) realm).start();</div><div class="line"></div><div class="line">    <span class="comment">// Start our child containers, if not already started</span></div><div class="line">    <span class="keyword">for</span> (Container child : findChildren()) &#123;</div><div class="line">        <span class="keyword">if</span> (!child.getState().isAvailable()) &#123;</div><div class="line">            child.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Start the Valves in our pipeline (including the basic),</span></div><div class="line">    <span class="comment">// if any</span></div><div class="line">    ((Lifecycle) pipeline).start();</div><div class="line">            </div><div class="line">    <span class="keyword">if</span> ( (getCluster() != <span class="keyword">null</span>) &amp;&amp; distributable) &#123;</div><div class="line">        contextManager = getCluster().createManager(getName());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        contextManager = <span class="keyword">new</span> StandardManager();</div><div class="line">    &#125;</div><div class="line">            </div><div class="line">    <span class="comment">// Configure default manager if none was specified</span></div><div class="line">    <span class="keyword">if</span> (contextManager != <span class="keyword">null</span>) &#123;</div><div class="line">        setManager(contextManager);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (manager!=<span class="keyword">null</span> &amp;&amp; (getCluster() != <span class="keyword">null</span>) &amp;&amp; distributable) &#123;</div><div class="line">        <span class="comment">//let the cluster know that there is a context that is distributable</span></div><div class="line">        <span class="comment">//and that it has its own manager</span></div><div class="line">        getCluster().registerManager(manager);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setInstanceManager(</div><div class="line">                       <span class="keyword">new</span> DefaultInstanceManager(context,</div><div class="line">                                                  injectionMap,</div><div class="line">                                                  <span class="keyword">this</span>,</div><div class="line">                                                  <span class="keyword">this</span>.getClass().getClassLoader()));</div><div class="line"></div><div class="line">    <span class="comment">// Start manager</span></div><div class="line">    ((Lifecycle) manager).start();</div><div class="line"></div><div class="line">    <span class="comment">// Start ContainerBackgroundProcessor thread</span></div><div class="line">    <span class="keyword">super</span>.threadStart();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="加载组件"><a href="#加载组件" class="headerlink" title="加载组件"></a>加载组件</h3><ul>
<li><strong><code>Manager</code></strong>: 管理 <code>Session</code></li>
<li><strong><code>Logger</code></strong>: 记录事件</li>
<li><strong><code>Loader</code></strong>: 启动 <code>Context</code></li>
<li><strong><code>Valve</code></strong>: 当一个容器决定了要把从上级传递过来的请求交给子容器的时候,它就把这个请求放进容器的管道 (pipeline) 里。而请求在管道里流动的时候,就会被管道里面的各个阀门拦截下来。第一个阀门叫做 <strong>“access_allow_vavle”</strong> ,当请求传递过来时,它会看这个请求是从哪个 IP 过来的,如果这个 IP 已经在黑名单中,请求就会被禁止掉。第二个阀门叫做 <strong>“default_access_valve”</strong> ,它会做例行的检查,如果通过检查,就把请求传递给当前容器的子容器。通过这种方式,请求在各个容器里面传递,最后抵达目的地。</li>
</ul>
<p>跟 <code>Valve</code> 相关的类和概念有如下两个:</p>
<ul>
<li><code>org.apache.catalina.Pipeline</code></li>
<li><code>org.apache.catalina.Valve</code></li>
</ul>
<p><img src="valve_hierarchy.svg" alt=""></p>
<h3 id="Tomcat-类加载器"><a href="#Tomcat-类加载器" class="headerlink" title="Tomcat 类加载器"></a>Tomcat 类加载器</h3><p>对于某个网络程序所<strong>特有</strong>的类和资源,这些未包装的类和资源放置在你的网络程序档案 <code>/WEB-INF/classes</code> 目录下面,或者,包含这些类和资源的 JAR 文件放置在你的网络程序档案 <code>/WEB-INF/lib</code> 目录下面;</p>
<p>对于必须被所有网络程序<strong>共享</strong>的类和资源, 未包装的这些类和资源放置在 <code>$CATALINA_HOME/shared/classes</code> 下面,或者,包含这些类和资源的 JAR 文件放置在 <code>$CATALINA_HOME/shared/lib</code> 下面。</p>
<p><strong>Tomcat 类加载器父子关系图</strong>:</p>
<p><img src="17-06-15-15_28_10_377_316.png" alt=""></p>
<p><strong>Tomcat 与 Java 类加载器关系图</strong>:</p>
<p><img src="17-06-15-15_28_40_212_474.png" alt=""></p>
<p><strong>catalina.sh 指定 CLASSPATH 内容</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Add on extra jar files to CLASSPATH</span></div><div class="line"><span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$CLASSPATH</span>"</span> ] ; <span class="keyword">then</span></div><div class="line">    CLASSPATH=<span class="string">"<span class="variable">$CLASSPATH</span>"</span>:</div><div class="line"><span class="keyword">fi</span></div><div class="line">CLASSPATH=<span class="string">"<span class="variable">$CLASSPATH</span>"</span><span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>/bin/bootstrap.jar</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -r <span class="string">"<span class="variable">$CATALINA_BASE</span>/bin/tomcat-juli.jar"</span> ] ; <span class="keyword">then</span></div><div class="line">    CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$CATALINA_BASE</span>/bin/tomcat-juli.jar</div><div class="line"><span class="keyword">else</span></div><div class="line">    CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$CATALINA_HOME</span>/bin/tomcat-juli.jar</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p><strong>Bootstrap.createClassLoader</strong>:</p>
<p>在 <code>conf/catalina.properties</code> 中定义了 <code>Common, Server, Shared</code> 三个 <code>ClassLoader</code> 载入类的路径以及一些包的安全权限:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">common.loader=&quot;$&#123;catalina.base&#125;/lib&quot;,&quot;$&#123;catalina.base&#125;/lib/*.jar&quot;,&quot;$&#123;catalina.home&#125;/lib&quot;,&quot;$&#123;catalina.home&#125;/lib/*.jar&quot;</div><div class="line">server.loader=</div><div class="line">shared.loader=</div></pre></td></tr></table></figure>
<p>加载 <code>tomcat85/output/build/lib/*.jar</code></p>
<p><img src="17-06-15-15_54_12_1085_203.png" alt=""></p>
<p><strong>ClassLoaderFactory.createClassLoader</strong>:</p>
<p>主要工作是进行加载路径的格式化</p>
<p><strong>Tomcat 热部署</strong>:</p>
<p>有两种方式:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span> <span class="attr">name</span>=<span class="string">"localhost"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">xmlNamespaceAware</span>=<span class="string">"false"</span> <span class="attr">xmlValidation</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Context</span> <span class="attr">docBase</span>=<span class="string">"CPCWeb"</span> <span class="attr">path</span>=<span class="string">"/CPCWeb"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> <span class="attr">source</span>=<span class="string">"org.eclipse.jst.j2ee.server:CPCWeb"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></div></pre></td></tr></table></figure>
<p>或</p>
<p>直接把项目放到 <code>webapps</code> 下面</p>
<p>实现方法如下:</p>
<p>所有继承了 <code>ContainerBase</code> 的容器如下:</p>
<p><img src="17-06-15-17_06_18_716_155.png" alt=""></p>
<p><code>ContainerBase</code> 在启动的时候启动了一个<strong>后台线程</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    threadStart();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">threadStart</span><span class="params">()</span> </span>&#123;</div><div class="line">    String threadName = <span class="string">"ContainerBackgroundProcessor["</span> + toString() + <span class="string">"]"</span>;</div><div class="line">    thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ContainerBackgroundProcessor(), threadName);</div><div class="line">    thread.setDaemon(<span class="keyword">true</span>);</div><div class="line">    thread.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>后台线程每隔一段时间就会调用 <code>processChildren</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (!threadDone) &#123;</div><div class="line">        Thread.sleep(backgroundProcessorDelay * <span class="number">1000L</span>);</div><div class="line">        <span class="keyword">if</span> (!threadDone) &#123;</div><div class="line">            processChildren(ContainerBase.<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>processChildren</code> 方法会调用 <code>ContainerBase</code> 自身的 <code>backgroundProcess</code> 方法，其中关于 <code>backgroundProcess</code> 方法中调用 loader 来重新加载类的方法定义在子类 <code>StandardContext</code> 中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</div><div class="line">    Loader loader = getLoader();</div><div class="line">    <span class="keyword">if</span> (loader != <span class="keyword">null</span>) &#123;</div><div class="line">        loader.backgroundProcess();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">super</span>.backgroundProcess();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>StandardContext</code> 的 <code>startInternal()</code> 方法中我们可以得知 <code>getLoader</code> 返回的是 <code>WebappLoader</code> 实例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;</div><div class="line">        WebappLoader webappLoader = <span class="keyword">new</span> WebappLoader(getParentClassLoader());</div><div class="line">        webappLoader.setDelegate(getDelegate());</div><div class="line">        setLoader(webappLoader);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>setLoader</code> 方法中又指定了 <code>loader</code> 的 <code>Context</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (loader != <span class="keyword">null</span>)</div><div class="line">    loader.setContext(<span class="keyword">this</span>);</div></pre></td></tr></table></figure>
<p><code>WebappLoader</code> 的 <code>backgroundProcess()</code> 方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (reloadable &amp;&amp; modified()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Thread.currentThread().setContextClassLoader</div><div class="line">                (WebappLoader.class.getClassLoader());</div><div class="line">            <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</div><div class="line">                context.reload();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (context != <span class="keyword">null</span> &amp;&amp; context.getLoader() != <span class="keyword">null</span>) &#123;</div><div class="line">                Thread.currentThread().setContextClassLoader</div><div class="line">                    (context.getLoader().getClassLoader());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义在 <code>WebappClassLoaderBase</code> 中的 <code>modified()</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">modified</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (Entry&lt;String,ResourceEntry&gt; entry : resourceEntries.entrySet()) &#123;</div><div class="line">        <span class="keyword">long</span> cachedLastModified = entry.getValue().lastModified;</div><div class="line">        <span class="keyword">long</span> lastModified = resources.getClassLoaderResource(</div><div class="line">                                                             entry.getKey()).getLastModified();</div><div class="line">        <span class="keyword">if</span> (lastModified != cachedLastModified) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Check if JARs have been added or removed</span></div><div class="line">    WebResource[] jars = resources.listResources(<span class="string">"/WEB-INF/lib"</span>);</div><div class="line">    <span class="comment">// Filter out non-JAR resources</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> jarCount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (WebResource jar : jars) &#123;</div><div class="line">        <span class="keyword">if</span> (jar.getName().endsWith(<span class="string">".jar"</span>) &amp;&amp; jar.isFile() &amp;&amp; jar.canRead()) &#123;</div><div class="line">            jarCount++;</div><div class="line">            Long recordedLastModified = jarModificationTimes.get(jar.getName());</div><div class="line">            <span class="keyword">if</span> (recordedLastModified == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Jar has been added</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (recordedLastModified.longValue() != jar.getLastModified()) &#123;</div><div class="line">                <span class="comment">// Jar has been changed</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (jarCount &lt; jarModificationTimes.size())&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// No classes have been modified</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由上文可知，<code>WebappLoader</code> 自身关联的 <code>Context</code> 实为 <code>StandardContext</code>，因此在 <code>backgroundProcess</code> 方法中调用 <code>context.reload()</code> 的时候，则是调用的 <code>StandardContext</code> 方法上的 <code>reload</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">reload</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Stop accepting requests temporarily.</span></div><div class="line">    setPaused(<span class="keyword">true</span>);</div><div class="line">    stop();</div><div class="line">    start();</div><div class="line">    setPaused(<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其就是将整个 <code>Context</code> 容器重启了一下，由此实现类的热加载部署。</p>
<h3 id="Task-任务"><a href="#Task-任务" class="headerlink" title="Task 任务"></a>Task 任务</h3><p><strong>Tomcat 的主要作用是提供静态资源和 JSP 动态资源的请求和响应服务</strong>。根据 Tomcat 服务的机制, 需要通过 Connector 监听服务请求, 进行匹配后转发到对应的 Host 和 Context。而作为核心服务单元的 Context,它在接收转发过来的服务之前,实际上已经建立了对服务的监听连接, 每一个 Context 都称作一个 Web 应用。</p>
<p>这些 Web 应用建立和管理监听的过程是由应用管理程序 manager 来完成的, 我们称这些操作为任务 (Task) 。 常见的任务有<strong>部署 (deploy) 、 查看 (list) 、启动(start) 、停止(stop) 、删除(updeploy) 、重载(reload) </strong>。</p>
<p>所有的 Tomcat 任务类都继承自 <code>AbstractCatalinaTask</code>。其统一实现任务请求命令的操作函数 <code>execute(command)</code> ,该函数的功能是实现 command 命令的管理功能,例如 deploy 等。<strong>它实现的方式是建立 HTTP 连接,并接收输入流的响应数据</strong>。该函数的代码和所做的工作如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(String command, InputStream istream, String contentType, <span class="keyword">long</span> contentLength)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BuildException </span>&#123;</div><div class="line"></div><div class="line">    URLConnection conn = <span class="keyword">null</span>;</div><div class="line">    InputStreamReader reader = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Create a connection for this command</span></div><div class="line">        conn = (<span class="keyword">new</span> URL(url + command)).openConnection();</div><div class="line">        HttpURLConnection hconn = (HttpURLConnection) conn;</div><div class="line"></div><div class="line">        <span class="comment">// Set up standard connection characteristics</span></div><div class="line">        hconn.setAllowUserInteraction(<span class="keyword">false</span>);</div><div class="line">        hconn.setDoInput(<span class="keyword">true</span>);</div><div class="line">        hconn.setUseCaches(<span class="keyword">false</span>);</div><div class="line">        <span class="keyword">if</span> (istream != <span class="keyword">null</span>) &#123;</div><div class="line">            hconn.setDoOutput(<span class="keyword">true</span>);</div><div class="line">            hconn.setRequestMethod(<span class="string">"PUT"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            hconn.setDoOutput(<span class="keyword">false</span>);</div><div class="line">            hconn.setRequestMethod(<span class="string">"GET"</span>);</div><div class="line">        &#125;</div><div class="line">        hconn.setRequestProperty(<span class="string">"User-Agent"</span>, <span class="string">"Catalina-Ant-Task/1.0"</span>);</div><div class="line">        <span class="comment">// Set up authorization with our credentials</span></div><div class="line">        Authenticator.setDefault(<span class="keyword">new</span> TaskAuthenticator(username, password));</div><div class="line">        <span class="comment">// Establish the connection with the server</span></div><div class="line">        hconn.connect();</div><div class="line">        <span class="comment">// Send the request data (if any)</span></div><div class="line">        <span class="keyword">if</span> (istream != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> (BufferedOutputStream ostream =</div><div class="line">                 <span class="keyword">new</span> BufferedOutputStream(hconn.getOutputStream(), <span class="number">1024</span>);) &#123;</div><div class="line">                <span class="keyword">byte</span> buffer[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> n = istream.read(buffer);</div><div class="line">                    ostream.write(buffer, <span class="number">0</span>, n);</div><div class="line">                &#125;</div><div class="line">                ostream.flush();</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                istream.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Process the response message</span></div><div class="line">        reader = <span class="keyword">new</span> InputStreamReader(hconn.getInputStream(), CHARSET);</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">int</span> ch = reader.read();</div><div class="line">            buff.append((<span class="keyword">char</span>) ch);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (buff.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">            handleOutput(buff.toString(), msgPriority);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        handleErrorOutput(e.getMessage());</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        reader.close();</div><div class="line">        istream.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 Tomcat 源代码的 <code>org.apache.catalina.ant</code> 目录下有一个任务文件 <code>catalina.tasks</code>, 该文件配置了各种不同的任务所映射的任务处理类, 包括以下四类任务:</p>
<p><strong>1. Catalina 任务</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">list=org.apache.catalina.ant.ListTask</div><div class="line">deploy=org.apache.catalina.ant.DeployTask</div><div class="line">start=org.apache.catalina.ant.StartTask</div><div class="line">reload=org.apache.catalina.ant.ReloadTask</div><div class="line">stop=org.apache.catalina.ant.StopTask</div><div class="line">undeploy=org.apache.catalina.ant.UndeployTask</div><div class="line">resources=org.apache.catalina.ant.ResourcesTask</div><div class="line">sessions=org.apache.catalina.ant.SessionsTask</div><div class="line">validator=org.apache.catalina.ant.ValidatorTask</div><div class="line">findleaks=org.apache.catalina.ant.FindLeaksTask</div><div class="line">vminfo=org.apache.catalina.ant.VminfoTask</div><div class="line">threaddump=org.apache.catalina.ant.ThreaddumpTask</div><div class="line">sslConnectorCiphers=org.apache.catalina.ant.SslConnectorCiphersTask</div></pre></td></tr></table></figure>
<p><strong>2. Jk 任务</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jkupdate=org.apache.catalina.ant.JKStatusUpdateTask</div></pre></td></tr></table></figure>
<p><strong>3. JMX 任务</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">jmxManagerSet=org.apache.catalina.ant.JMXSetTask</div><div class="line">jmxManagerGet=org.apache.catalina.ant.JMXGetTask</div><div class="line">jmxManagerQuery=org.apache.catalina.ant.JMXQueryTask</div></pre></td></tr></table></figure>
<p><strong>4. Jasper 任务</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jasper=org.apache.jasper.JspC</div></pre></td></tr></table></figure>
<hr>
<p><strong>部署应用任务类 DeployTask</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> BuildException </span>&#123;</div><div class="line">    <span class="keyword">super</span>.execute();</div><div class="line">    <span class="comment">// Building an input stream on the WAR to upload, if any</span></div><div class="line">    <span class="keyword">if</span> (war != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (PROTOCOL_PATTERN.matcher(war).lookingAt()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                URL url = <span class="keyword">new</span> URL(war);</div><div class="line">                URLConnection conn = url.openConnection();</div><div class="line">                contentLength = conn.getContentLengthLong();</div><div class="line">                stream = <span class="keyword">new</span> BufferedInputStream(conn.getInputStream(), <span class="number">1024</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(e);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            FileInputStream fsInput = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                fsInput = <span class="keyword">new</span> FileInputStream(war);</div><div class="line">                contentLength = fsInput.getChannel().size();</div><div class="line">                stream = <span class="keyword">new</span> BufferedInputStream(fsInput, <span class="number">1024</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                fsInput.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        contentType = <span class="string">"application/octet-stream"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Building URL</span></div><div class="line">    StringBuilder sb = createQueryString(<span class="string">"/deploy"</span>);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        execute(sb.toString(), stream, contentType, contentLength);</div><div class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">"Invalid 'charset' attribute: "</span> + getCharset());</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        stream.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>启动应用任务类 <code>StartTask</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> BuildException </span>&#123;</div><div class="line">    <span class="keyword">super</span>.execute();</div><div class="line">    execute(createQueryString(<span class="string">"/start"</span>).toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Servlet-类"><a href="#Servlet-类" class="headerlink" title="Servlet 类"></a>Servlet 类</h3><p>处理 <code>Servlet</code> 的类主要位于目录 <code>org.apache.catalina.servlets</code> 中。</p>
<p>Tomcat 能够响应的请求文件类型有 HTML、图片、CSS、Servlet、CGI、SSI、JSP。前三种属于静态资源,后四种属于动态资源。Tomcat 使用 <code>DefaultServlet</code> 响应静态资源, 使用 <code>CGIServlet</code> 响应 CGI 请求,使用 <code>org.apache.catalina.ssi.SSIServlet</code> 响应 SSI 请求,使用 <code>org.apache.jasper.servlet.JspServlet</code> 响应 JSP 请求。</p>
<p>所有的 Tomcat 的 Servlet 都继承一个父类 <code>javax.servlet.http.HttpServlet</code>,该类又继承自 <code>javax.servlet.GenericServlet</code>。</p>
<hr>
<p><strong><code>javax.servlet.GenericServlet</code></strong> 抽象类:</p>
<p><code>javax.servlet.GenericServlet</code> 实现了 <code>Servlet, ServletConfig, java.io.Serializable</code> 方法，写一个通用的 <code>servlet</code>，你只需要重写抽象方法 <code>Service</code> 即可</p>
<p><strong><code>javax.servlet.http.HttpServlet</code></strong>:</p>
<p><code>HttpServlet</code> 绑定资源文件: <code>javax.servlet.http.LocalStrings.properties</code>，供 HTTP 访问期间的错误和警告信息提示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LSTRING_FILE =</div><div class="line">    <span class="string">"javax.servlet.http.LocalStrings"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ResourceBundle lStrings =</div><div class="line">    ResourceBundle.getBundle(LSTRING_FILE);</div><div class="line"></div><div class="line">String msg = lStrings.getString(<span class="string">"http.method_get_not_supported"</span>);</div><div class="line"><span class="keyword">if</span> (protocol.endsWith(<span class="string">"1.1"</span>)) &#123;</div><div class="line">    resp.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, msg);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    resp.sendError(HttpServletResponse.SC_BAD_REQUEST, msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>访问 HTTP Header 信息，定义了两个变量:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_IFMODSINCE = <span class="string">"If-Modified-Since"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_LASTMOD = <span class="string">"Last-Modified"</span>;</div></pre></td></tr></table></figure>
<p>重写 HTTP 协议的 <code>Service</code> 函数，该a函数用以根据 HTTP 请求的命令，选择不同的函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"></div><div class="line">    String method = req.getMethod();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (method.equals(METHOD_GET)) &#123;</div><div class="line">        doGet(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_HEAD)) &#123;</div><div class="line">        doHead(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_POST)) &#123;</div><div class="line">        doPost(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_PUT)) &#123;</div><div class="line">        doPut(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_DELETE)) &#123;</div><div class="line">        doDelete(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_OPTIONS)) &#123;</div><div class="line">        doOptions(req,resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_TRACE)) &#123;</div><div class="line">        doTrace(req,resp);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>org.apache.catalina.servlets.DefaultServlet</code></strong>:</p>
<p><code>DefaultServlet</code> <strong>提供静态资源和目录列表解释服务</strong> (如果目录列表选项打开的话) ,该类重写了父类的 <code>doHead()、doGet()、doPost()、doPut()</code> 方法, 它们调用内部函数 <code>serveResource()</code> 来返回服务资源内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serveResource</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line"><span class="function"><span class="params">                             HttpServletResponse response,</span></span></div><div class="line"><span class="function"><span class="params">                             <span class="keyword">boolean</span> content,</span></span></div><div class="line"><span class="function"><span class="params">                             String encoding)</span></span></div></pre></td></tr></table></figure>
<p><strong><code>org.apache.catalina.servlets.CGIServlet</code></strong>:</p>
<p><code>cgiPathPrefix</code>: CGI 搜寻路径从 Web 应用程序的 root directory + File.separator + this.prefix 开始。默认的 <code>cgiPathPrefix</code> 是 <code>/WEB-INF/cgi</code>;</p>
<p><code>executable</code>: 用来运行 script 的可执行程序,默认是 <code>perl</code>;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">    CGIEnvironment cgiEnv = <span class="keyword">new</span> CGIEnvironment(req, getServletContext());</div><div class="line">    <span class="keyword">if</span> (cgiEnv.isValid()) &#123;</div><div class="line">        CGIRunner cgi = <span class="keyword">new</span> CGIRunner(cgiEnv.getCommand(),</div><div class="line">                                      cgiEnv.getEnvironment(),</div><div class="line">                                      cgiEnv.getWorkingDirectory(),</div><div class="line">                                      cgiEnv.getParameters());</div><div class="line"></div><div class="line">        cgi.setResponse(res);</div><div class="line">        cgi.run();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CGIRunner</code> 通过输入输出流执行 <code>CGI</code> 脚本，为 <code>doPost</code> 或  <code>doGet</code> 服务:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Runtime rt = <span class="keyword">null</span>;</div><div class="line">    Process proc = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    rt = Runtime.getRuntime();</div><div class="line">    proc = rt.exec(</div><div class="line">                   cmdAndArgs.toArray(<span class="keyword">new</span> String[cmdAndArgs.size()]),</div><div class="line">                   hashToStringArray(env), wd);</div><div class="line"></div><div class="line">    <span class="comment">//write output</span></div><div class="line">    <span class="keyword">byte</span>[] bBuf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</div><div class="line"></div><div class="line">    OutputStream out = response.getOutputStream();</div><div class="line">    cgiOutput = proc.getInputStream();</div><div class="line">    <span class="keyword">while</span> (!skipBody &amp;&amp; (bufRead = cgiOutput.read(bBuf)) != -<span class="number">1</span>) &#123;</div><div class="line">        out.write(bBuf, <span class="number">0</span>, bufRead);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>org.apache.catalina.ssi.SSIServlet</code></strong>:</p>
<p>类 <code>SSIProcessor</code> 才是真正解释 SSI 命令的类，它将 SSI 的各种命令映射到各种处理类进行处理:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addBuiltinCommands</span><span class="params">()</span> </span>&#123;</div><div class="line">    addCommand(<span class="string">"config"</span>, <span class="keyword">new</span> SSIConfig());</div><div class="line">    addCommand(<span class="string">"echo"</span>, <span class="keyword">new</span> SSIEcho());</div><div class="line">    <span class="keyword">if</span> (allowExec) &#123;</div><div class="line">        addCommand(<span class="string">"exec"</span>, <span class="keyword">new</span> SSIExec());</div><div class="line">    &#125;</div><div class="line">    addCommand(<span class="string">"include"</span>, <span class="keyword">new</span> SSIInclude());</div><div class="line">    addCommand(<span class="string">"flastmod"</span>, <span class="keyword">new</span> SSIFlastmod());</div><div class="line">    addCommand(<span class="string">"fsize"</span>, <span class="keyword">new</span> SSIFsize());</div><div class="line">    addCommand(<span class="string">"printenv"</span>, <span class="keyword">new</span> SSIPrintenv());</div><div class="line">    addCommand(<span class="string">"set"</span>, <span class="keyword">new</span> SSISet());</div><div class="line">    SSIConditional ssiConditional = <span class="keyword">new</span> SSIConditional();</div><div class="line">    addCommand(<span class="string">"if"</span>, ssiConditional);</div><div class="line">    addCommand(<span class="string">"elif"</span>, ssiConditional);</div><div class="line">    addCommand(<span class="string">"endif"</span>, ssiConditional);</div><div class="line">    addCommand(<span class="string">"else"</span>, ssiConditional);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>org.apache.jasper.servlet.JspServlet</code></strong>:</p>
<p>处理 <code>JSP</code> 请求:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span> <span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> precompile = preCompile(request);</div><div class="line">    serviceJspFile(request, response, jspUri, precompile);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>serviceJspFile</code> 是调用了 <code>JspServletWrapper</code> 的 <code>service</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceJspFile</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line"><span class="function"><span class="params">                            HttpServletResponse response, String jspUri,</span></span></div><div class="line"><span class="function"><span class="params">                            <span class="keyword">boolean</span> precompile)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"></div><div class="line">    JspServletWrapper wrapper = <span class="keyword">new</span> JspServletWrapper(config, options, jspUri,</div><div class="line">                                                      rctxt);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        wrapper.service(request, response, precompile);</div><div class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe) &#123;</div><div class="line">        handleMissingResource(request, response, jspUri);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>JspServletWrapper</code> 的 <code>service</code> 调用分为四个过程:</p>
<ul>
<li><strong>(1) Compile</strong>: <code>JspCompilationContext.compile()</code></li>
<li><strong>(2) (Re)load servlet class file</strong>: <code>servlet = getServlet()</code></li>
<li><strong>(3) Handle limitation of number of loaded Jsps</strong></li>
<li><strong>(4) Service request</strong>: <code>servlet.service(request, response)</code></li>
</ul>
<p><code>org.apache.jasper.JspCompilationContext</code> 的 <code>compile</code> 方法首先会创建并加载编译器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Compiler <span class="title">createCompiler</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (jspCompiler != <span class="keyword">null</span> ) &#123;</div><div class="line">        <span class="keyword">return</span> jspCompiler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    jspCompiler = createCompiler(<span class="string">"org.apache.jasper.compiler.JDTCompiler"</span>);</div><div class="line">    <span class="keyword">if</span> (jspCompiler == <span class="keyword">null</span>) &#123;</div><div class="line">        jspCompiler = createCompiler(<span class="string">"org.apache.jasper.compiler.AntCompiler"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    jspCompiler.init(<span class="keyword">this</span>, jsw);</div><div class="line">    <span class="keyword">return</span> jspCompiler;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>createCompiler</code> 方法用于实例化编译器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Compiler <span class="title">createCompiler</span><span class="params">(String className)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (Compiler) Class.forName(className).newInstance();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>紧接着会进行编译:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compile</span><span class="params">()</span> <span class="keyword">throws</span> JasperException, FileNotFoundException </span>&#123;</div><div class="line">    createCompiler();</div><div class="line">    <span class="keyword">if</span> (jspCompiler.isOutDated()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            jspCompiler.removeGeneratedFiles();</div><div class="line">            jspLoader = <span class="keyword">null</span>;</div><div class="line">            jspCompiler.compile();</div><div class="line">            jsw.setReload(<span class="keyword">true</span>);</div><div class="line">            jsw.setCompilationException(<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (JasperException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe) &#123;</div><div class="line">            <span class="keyword">throw</span> fnfe;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">            <span class="keyword">throw</span> je;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以 <code>org.apache.jasper.compiler.JDTCompiler</code> 为例，<code>JDTCompiler</code> 继承了 <code>Compiler</code> 类，<code>compile</code> 方法的实现是在 <code>Compiler</code> 类里面的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compile</span><span class="params">(<span class="keyword">boolean</span> compileClass, <span class="keyword">boolean</span> jspcMode)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> FileNotFoundException, JasperException, Exception </span>&#123;</div><div class="line">    String[] smap = generateJava();</div><div class="line">    File javaFile = <span class="keyword">new</span> File(ctxt.getServletJavaFileName());</div><div class="line">    Long jspLastModified = ctxt.getLastModified(ctxt.getJspFile());</div><div class="line">    javaFile.setLastModified(jspLastModified.longValue());</div><div class="line">    <span class="keyword">if</span> (compileClass) &#123;</div><div class="line">        generateClass(smap);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>generateJava</code> 方法用于将 <code>JSP</code> 文件转为 <code>Java</code> 文件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">String javaFileName = ctxt.getServletJavaFileName();</div><div class="line">ParserController parserCtl = <span class="keyword">new</span> ParserController(ctxt, <span class="keyword">this</span>);</div><div class="line"><span class="comment">// Pass 1 - the directives</span></div><div class="line">Node.Nodes directives =</div><div class="line">    parserCtl.parseDirectives(ctxt.getJspFile());</div><div class="line"><span class="comment">// Pass 2 - the whole translation unit</span></div><div class="line">pageNodes = parserCtl.parse(ctxt.getJspFile());</div><div class="line"><span class="comment">// generate servlet .java file</span></div><div class="line"><span class="keyword">try</span> (ServletWriter writer = setupContextWriter(javaFileName)) &#123;</div><div class="line">    Generator.generate(writer, <span class="keyword">this</span>, pageNodes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>generateClass</code> 由上述分析可知，有两个实现类:</p>
<ul>
<li><code>AntCompiler</code></li>
</ul>
<p><code>AntCompiler</code> 最后调用的是 <code>org.apache.tools.ant.taskdefs.Javac</code> 进行的编译:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">generateClass</span><span class="params">(String[] smap)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> FileNotFoundException, JasperException, Exception </span>&#123;</div><div class="line">    Javac javac = (Javac) project.createTask(<span class="string">"javac"</span>);</div><div class="line">    javac.execute();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>JDTCompiler</code></li>
</ul>
<p><code>JDTCompiler</code> 最后调用的是 <code>org.eclipse.jdt.internal.compiler.Compiler</code> 进行的编译:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">generateClass</span><span class="params">(String[] smap)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> FileNotFoundException, JasperException, Exception </span>&#123;</div><div class="line">    Compiler compiler =</div><div class="line">        <span class="keyword">new</span> Compiler(env, policy, cOptions, requestor, problemFactory);</div><div class="line">    compiler.compile(compilationUnits);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，JSP 的整个编译流程分析完毕。</p>
<h3 id="Tomcat-资源"><a href="#Tomcat-资源" class="headerlink" title="Tomcat 资源"></a>Tomcat 资源</h3><h3 id="基于-JMX-的管理"><a href="#基于-JMX-的管理" class="headerlink" title="基于 JMX 的管理"></a>基于 JMX 的管理</h3><p>关于 JMX 的<a href="https://github.com/anxiaoyi/java-interview/wiki/JMX" target="_blank" rel="external">详细介绍</a></p>
<p><code>Catalina</code> 在 <code>org.apache.catalina.mbeans</code> 包中提供了一系列的 MBean 类。这些 MBean 类直接或间接继承自 <code>org.apache.tomcat.util.modeler.BaseModelMBean</code> 类，我们接下来将会重点讨论几个最重要的 MBean，分别是 <code>ClassNameMBean</code>、和 <code>MBeanFactory</code> 类。</p>
<p><strong><code>ClassNameMBean</code></strong>: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassNameMBean</span> <span class="keyword">extends</span> <span class="title">BaseModelMBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassNameMBean</span><span class="params">()</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> MBeanException, RuntimeOperationsException </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClassName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.resource.getClass().getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>MBeanFactory</code></strong>: 用于创建管理 Tomcat 中各种资源的所有模型 MBean，还提供了删除这些 MBean 的方法</p>
<h3 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h3><p>什么是虚拟主机?虚拟主机是使用特殊的软硬件技术,把一台计算机主机分成一台台 “虚拟” 的主机, <strong>每一台虚拟主机都具有独立的域名和 IP 地址 (或共享的 IP 地址) </strong>,有完整的 Internet 服务器(WWW、FTP、Email 等)功能。利用“虚拟主机”技术,每一台虚拟主机和一台独立的主机完全一样,每一台虚拟主机都具有独立的域名,具有完整 Internet 服务器功能。</p>
<p>虚拟主机的配置方法有两种: <strong>基于 IP 和基于名称</strong>。</p>
<p><strong>1. 基于 IP 的虚拟主机</strong>:</p>
<p><strong>一台机器可以配置多个网卡,配置多个不同的 IP</strong>。每一个域名被分配到同一台主机,但是仍然拥有独立的 IP 地址。显然这种方式也占用了更多 IP 资源,并且需要增加更多的网卡来达到需求,当然也可以为一个网卡配置多个 IP。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> <span class="attr">192.168.0.1</span>&gt;</span></div><div class="line">  ServerName www.abc.com</div><div class="line">  DocumentRoot c:/root/www.abc.com</div><div class="line">  ServerAdmin support@abc.com</div><div class="line">  ErrorLog c:/errorlog/www.abc.com</div><div class="line">  TransferLog c:/transferlog/www.abc.com</div><div class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> <span class="attr">192.168.0.2</span>&gt;</span></div><div class="line">  ServerName www.def.com</div><div class="line">  DocumentRoot c:/root/www.def.com</div><div class="line">  ServerAdmin support@def.com</div><div class="line">  ErrorLog c:/errorlog/www.def.com</div><div class="line">  TransferLog c:/transferlog/www.def.com</div><div class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></div></pre></td></tr></table></figure>
<p>此处必须为 www.abc.com 和 www.def.com 分别配置 DNS 映射 192.168.0.1 和 192.168.0.2。这也要求,Apache Server 必须同时监听这两个 IP。如果 DNS 不能够按照这个匹配配置,也将不能够提供服务。</p>
<p><strong>2. 基于名称的虚拟主机</strong>:</p>
<p>当虚拟 IP 技术不能够满足成千上万的域名需求时,基于名称的虚拟技术是十分廉价的解决方式。这种方法是在同一个主机上建立多个站点的服务,每一个站点的服务虚拟到一个域名,当用户请求这些域名服务时,都被虚拟到这台主机的 IP,并被分配到不同的站点。例如,可以像下面这样在 Apache 中进行配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> <span class="attr">192.168.0.1</span>&gt;</span></div><div class="line">  ServerName www.abc.com</div><div class="line">  DocumentRoot c:/root/www.abc.com</div><div class="line">  ServerAdmin support@abc.com</div><div class="line">  ErrorLog c:/errorlog/www.abc.com</div><div class="line">  TransferLog c:/transferlog/www.abc.com</div><div class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> <span class="attr">192.168.0.1</span>&gt;</span></div><div class="line">  ServerName www.def.com</div><div class="line">  DocumentRoot c:/root/www.def.com</div><div class="line">  ServerAdmin support@def.com</div><div class="line">  ErrorLog c:/errorlog/www.def.com</div><div class="line">  TransferLog c:/transferlog/www.def.com</div><div class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这种方式的问题是, <strong>如果请求的是 IP 而不是域名,将不能区分请求的是哪个站点的服务</strong>。这种配置只能够适用于 HTTP 连接,不能配置 SSL 连接,SSL 服务只能够按照惟一 IP 配置,而且只支持 HTTP/1.1,不支持 HTTP/1.0。</p>
<p><strong>前面提到了独立 IP(基于 IP 的虚拟主机)和共享的 IP(基于名称的虚拟主机) </strong>。共享的 IP 模式就是所有的虚拟主机都使用同一 IP。目前国内 IDC 提供的虚拟主机都是这种模式。这种模式的优点是节约数量有限的 IP,缺点就是虚拟主机只能通过域名访问而不能通过 IP 访问(其实也不算是缺点,只对邮件系统中用户的访问方式有一点点影响) 。而另外一种独立 IP 模式主要应用在邮件服务中。</p>
<p>Tomcat 在 <code>server.xml</code> 中的 <code>Engine</code> 下配置虚拟主机:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"www.abc.com"</span> <span class="attr">appBase</span>=<span class="string">"c:\root\www.abc.com"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">      <span class="attr">autoDeploy</span>=<span class="string">"true"</span> <span class="attr">xmlValidation</span>=<span class="string">"false"</span> <span class="attr">xmlNamespaceAware</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span>www.abc.net<span class="tag">&lt;/<span class="name">alias</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span>www.abc.org<span class="tag">&lt;/<span class="name">alias</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"ROOT"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"www.def.com"</span> <span class="attr">appBase</span>=<span class="string">"c:\root\www.def.com"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">      <span class="attr">autoDeploy</span>=<span class="string">"true"</span> <span class="attr">xmlValidation</span>=<span class="string">"false"</span> <span class="attr">xmlNamespaceAware</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span>www.def.net<span class="tag">&lt;/<span class="name">alias</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span>www.def.org<span class="tag">&lt;/<span class="name">alias</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"ROOT"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></div></pre></td></tr></table></figure>
<p>为了使以上的虚拟主机生效,必须在 DNS 服务器中注册以上的虚拟主机名称和别名,使它们的 IP 地址都指向 Tomcat 服务器所在的机器。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 www.abc.com</div><div class="line">127.0.0.1 www.abc.net</div><div class="line">127.0.0.1 www.abc.org</div><div class="line">127.0.0.1 www.def.com</div><div class="line">127.0.0.1 www.def.net</div><div class="line">127.0.0.1 www.def.org</div></pre></td></tr></table></figure>
<p>当然,在实际环境中这样做是不行的, 需要在 DNS 上做相应的域名解析。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://www.infoq.com/cn/articles/zh-tomcat-http-request-1" target="_blank" rel="external">Tomcat处理HTTP请求源码分析（上）</a></li>
<li><a href="">精通 Tomcat</a></li>
<li><a href="http://blog.csdn.net/lantian0802/article/details/8870286" target="_blank" rel="external">Tomcat 热部署实现方式源码分析总结</a></li>
<li><a href="https://item.jd.com/10913619.html" target="_blank" rel="external">《深入剖析 Tomcat》</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/14/Tomcat/" data-id="cjcdlsfws0035diem5a4m6mme" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
 <script src="/blog/jquery/jquery.min.js"></script>
  <div id="random_posts">
    <h2>Recommended Posts</h2>
    <div class="random_posts_ul">
      <script>
          var random_count =4
          var site = {BASE_URI:'/blog/'};
          function load_random_posts(obj) {
              var arr=site.posts;
              if (!obj) return;
              // var count = $(obj).attr('data-count') || 6;
              for (var i, tmp, n = arr.length; n; i = Math.floor(Math.random() * n), tmp = arr[--n], arr[n] = arr[i], arr[i] = tmp);
              arr = arr.slice(0, random_count);
              var html = '<ul>';
            
              for(var j=0;j<arr.length;j++){
                var item=arr[j];
                html += '<li><strong>' + 
                item.date + ':&nbsp;&nbsp;<a href="' + (site.BASE_URI+item.uri) + '">' + 
                (item.title || item.uri) + '</a></strong>';
                if(item.excerpt){
                  html +='<div class="post-excerpt">'+item.excerpt+'</div>';
                }
                html +='</li>';
                
              }
              $(obj).html(html + '</ul>');
          }
          $('.random_posts_ul').each(function () {
              var c = this;
              if (!site.posts || !site.posts.length){
                  $.getJSON(site.BASE_URI + 'js/posts.js',function(json){site.posts = json;load_random_posts(c)});
              } 
               else{
                load_random_posts(c);
              }
          });
      </script>
    </div>
  </div>

    
<nav id="article-nav">
  
    <a href="/blog/2017/06/20/Redis一/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Redis一 - 动态字符串 (Simple Dynamic String)
        
      </div>
    </a>
  
  
    <a href="/blog/2017/06/09/java-command/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Java Command</div>
    </a>
  
</nav>

  
</article>
 
     
  

</section>
           
    <aside id="sidebar">
  
    

  
    
    <div class="widget-wrap">
    
      <div class="widget" id="toc-widget-fixed">
      
        <strong class="toc-title">Content</strong>
        <div class="toc-widget-list">
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat"><span class="toc-number">1.</span> <span class="toc-text">Tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#编译"><span class="toc-number">1.1.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志问题"><span class="toc-number">1.2.</span> <span class="toc-text">日志问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#核心类"><span class="toc-number">1.3.</span> <span class="toc-text">核心类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动"><span class="toc-number">1.4.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#容器"><span class="toc-number">1.5.</span> <span class="toc-text">容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Wrapper"><span class="toc-number">1.5.1.</span> <span class="toc-text">Wrapper</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Server"><span class="toc-number">1.6.</span> <span class="toc-text">Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-number">1.7.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connector"><span class="toc-number">1.8.</span> <span class="toc-text">Connector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-Engine"><span class="toc-number">1.9.</span> <span class="toc-text">启动 Engine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-Host"><span class="toc-number">1.10.</span> <span class="toc-text">启动 Host</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-Context"><span class="toc-number">1.11.</span> <span class="toc-text">启动 Context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加载组件"><span class="toc-number">1.12.</span> <span class="toc-text">加载组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat-类加载器"><span class="toc-number">1.13.</span> <span class="toc-text">Tomcat 类加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Task-任务"><span class="toc-number">1.14.</span> <span class="toc-text">Task 任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Servlet-类"><span class="toc-number">1.15.</span> <span class="toc-text">Servlet 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat-资源"><span class="toc-number">1.16.</span> <span class="toc-text">Tomcat 资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基于-JMX-的管理"><span class="toc-number">1.17.</span> <span class="toc-text">基于 JMX 的管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#虚拟主机"><span class="toc-number">1.18.</span> <span class="toc-text">虚拟主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-number">1.19.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
          </div>
      </div>
    </div>

  
    

  
    
  
    
  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>