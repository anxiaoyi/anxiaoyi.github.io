<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Spring (四) - Bean 的加载 | 代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Spring (四) - Bean 的加载 123456// AbstractBeanFactory.java@Overridepublic &amp;lt;T&amp;gt; T getBean(String name, Class&amp;lt;T&amp;gt; requiredType) throws BeansException &amp;#123;    return doGetBean(name, requiredType">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring (四) - Bean 的加载">
<meta property="og:url" content="http://blog.kunzhao.org/2017/06/30/Spring四/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="Spring (四) - Bean 的加载 123456// AbstractBeanFactory.java@Overridepublic &amp;lt;T&amp;gt; T getBean(String name, Class&amp;lt;T&amp;gt; requiredType) throws BeansException &amp;#123;    return doGetBean(name, requiredType">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://blog.kunzhao.org/2017/06/30/Spring四/BeanFactory.svg">
<meta property="og:updated_time" content="2017-08-30T03:10:30.809Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring (四) - Bean 的加载">
<meta name="twitter:description" content="Spring (四) - Bean 的加载 123456// AbstractBeanFactory.java@Overridepublic &amp;lt;T&amp;gt; T getBean(String name, Class&amp;lt;T&amp;gt; requiredType) throws BeansException &amp;#123;    return doGetBean(name, requiredType">
<meta name="twitter:image" content="http://blog.kunzhao.org/2017/06/30/Spring四/BeanFactory.svg">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Spring四" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/30/Spring四/" class="article-date">
  <time datetime="2017-06-30T03:42:14.000Z" itemprop="datePublished">2017-06-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spring (四) - Bean 的加载
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Spring-四-Bean-的加载"><a href="#Spring-四-Bean-的加载" class="headerlink" title="Spring (四) - Bean 的加载"></a>Spring (四) - Bean 的加载</h2><p><img src="BeanFactory.svg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    <span class="keyword">return</span> doGetBean(name, requiredType, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>doGetBean</code> 的整体框架:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Object[] args,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> typeCheckOnly)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> String beanName = transformedBeanName(name);</div><div class="line">    Object bean;</div><div class="line"></div><div class="line">    <span class="comment">// 如果缓存里面有单例</span></div><div class="line">    Object sharedInstance = getSingleton(beanName);</div><div class="line">    <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</div><div class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Check if bean definition exists in this factory.</span></div><div class="line">        BeanFactory parentBeanFactory = getParentBeanFactory();</div><div class="line">        <span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</div><div class="line">            <span class="comment">// 从父 BeanFactory 中加载</span></div><div class="line">            <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 缓存里面没有，创建一个单例</span></div><div class="line">        <span class="keyword">if</span> (mbd.isSingleton()) &#123;</div><div class="line">            sharedInstance = getSingleton(beanName,</div><div class="line">                                          <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;&#125;);</div><div class="line">            bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</div><div class="line">            bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">            bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Check if required type matches the type of the actual bean instance.</span></div><div class="line">    <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span> &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) &#123;</div><div class="line">        <span class="keyword">return</span> getTypeConverter().convertIfNecessary(bean, requiredType);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (T) bean;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面我们就一步一步地看一下 <code>doGetBean</code> 方法做的事情:</p>
<h3 id="转换-BeanName"><a href="#转换-BeanName" class="headerlink" title="转换 BeanName:"></a>转换 <code>BeanName</code>:</h3><p>去除 <code>FactoryBean</code> 的修饰符，取指定 alias 所表示的最终 beanName。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"><span class="keyword">final</span> String beanName = transformedBeanName(name);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Return the bean name, stripping out the factory dereference prefix if necessary,</span></div><div class="line"><span class="comment"> * and resolving aliases to canonical names.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">transformedBeanName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> canonicalName(BeanFactoryUtils.transformedBeanName(name));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="尝试加载单例"><a href="#尝试加载单例" class="headerlink" title="尝试加载单例:"></a>尝试加载单例:</h3><h4 id="从缓存中查找加载单例"><a href="#从缓存中查找加载单例" class="headerlink" title="从缓存中查找加载单例"></a>从缓存中查找加载单例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="comment">// Eagerly check singleton cache for manually registered singletons.</span></div><div class="line">Object sharedInstance = getSingleton(beanName);</div></pre></td></tr></table></figure>
<p><code>getSingleton</code> 方法的实现位于父类 <code>DefaultSingletonBeanRegistry</code> 中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultSingletonBeanRegistry.java</span></div><div class="line"></div><div class="line"><span class="comment">/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</div><div class="line"></div><div class="line"><span class="comment">/** Cache of early singleton objects: bean name --&gt; bean instance */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</div><div class="line"></div><div class="line"><span class="comment">/** Cache of singleton objects: bean name --&gt; bean instance */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</div><div class="line"></div><div class="line"><span class="comment">// Return the (raw) singleton object registered under the given name.</span></div><div class="line"><span class="comment">// Checks already instantiated singletons and also allows for an early</span></div><div class="line"><span class="comment">// reference to a currently created singleton (resolving a circular reference).</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</div><div class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</div><div class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</div><div class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</div><div class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</div><div class="line">                ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</div><div class="line">                <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</div><div class="line">                    singletonObject = singletonFactory.getObject();</div><div class="line">                    <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</div><div class="line">                    <span class="keyword">this</span>.singletonFactories.remove(beanName);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="缓存中没有，从头开始-bean-的加载过程"><a href="#缓存中没有，从头开始-bean-的加载过程" class="headerlink" title="缓存中没有，从头开始 bean 的加载过程"></a>缓存中没有，从头开始 <code>bean</code> 的加载过程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultSingletonBeanRegistry.java</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</div><div class="line">        Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</div><div class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 记录加载状态，，以便对循环依赖进行检测</span></div><div class="line">            beforeSingletonCreation(beanName);</div><div class="line">            singletonObject = singletonFactory.getObject();</div><div class="line">            <span class="comment">// 移除加载状态</span></div><div class="line">            afterSingletonCreation(beanName);</div><div class="line">            addSingleton(beanName, singletonObject);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>AbstractBeanFactory</code> 调用 <code>getSingleton</code> 方法的时候，传递了 <code>ObjectFactory</code> 对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Object[] args,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> typeCheckOnly)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    sharedInstance = getSingleton(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">                <span class="keyword">return</span> createBean(beanName, mbd, args);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="准备创建-Bean"><a href="#准备创建-Bean" class="headerlink" title="准备创建 Bean"></a>准备创建 Bean</h3><p><code>createBean</code> 实际上是由子类 <code>AbstractAutowireCapableBeanFactory</code> 实现的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> <span class="keyword">throws</span> BeanCreationException</span>;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutowireCapableBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> <span class="keyword">throws</span> BeanCreationException </span>&#123;</div><div class="line"></div><div class="line">    RootBeanDefinition mbdToUse = mbd;</div><div class="line"></div><div class="line">    <span class="comment">// Make sure bean class is actually resolved at this point, and</span></div><div class="line">    <span class="comment">// clone the bean definition in case of a dynamically resolved Class</span></div><div class="line">    <span class="comment">// which cannot be stored in the shared merged bean definition.</span></div><div class="line">    Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</div><div class="line">    <span class="keyword">if</span> (resolvedClass != <span class="keyword">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="keyword">null</span>) &#123;</div><div class="line">        mbdToUse = <span class="keyword">new</span> RootBeanDefinition(mbd);</div><div class="line">        mbdToUse.setBeanClass(resolvedClass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Prepare method overrides.</span></div><div class="line">    mbdToUse.prepareMethodOverrides();</div><div class="line"></div><div class="line">    <span class="comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span></div><div class="line">    Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</div><div class="line">    <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> bean;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Object beanInstance = doCreateBean(beanName, mbdToUse, args);</div><div class="line">    <span class="keyword">return</span> beanInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="从-bean-的实例中获取对象"><a href="#从-bean-的实例中获取对象" class="headerlink" title="从 bean 的实例中获取对象"></a>从 bean 的实例中获取对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line">bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</div><div class="line"></div><div class="line"><span class="comment">// Get the object for the given bean instance, either the bean</span></div><div class="line"><span class="comment">// instance itself or its created object in case of a FactoryBean.</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectForBeanInstance</span><span class="params">(Object beanInstance,</span></span></div><div class="line"><span class="function"><span class="params">                                          String name,</span></span></div><div class="line"><span class="function"><span class="params">                                          String beanName,</span></span></div><div class="line"><span class="function"><span class="params">                                          RootBeanDefinition mbd)</span> </span>&#123;</div><div class="line">    <span class="comment">// 核心代码委托给了 getObjectFromFactoryBean</span></div><div class="line">    Object object = getObjectFromFactoryBean(factory, beanName, !synthetic);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// FactoryBeanRegistrySupport.java</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectFromFactoryBean</span><span class="params">(FactoryBean&lt;?&gt; factory, String beanName, <span class="keyword">boolean</span> shouldPostProcess)</span> </span>&#123;</div><div class="line">    <span class="comment">// 如果是单例 ...</span></div><div class="line">    <span class="keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        object = doGetObjectFromFactoryBean(factory, beanName);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        Object object = doGetObjectFromFactoryBean(factory, beanName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (object != <span class="keyword">null</span> &amp;&amp; shouldPostProcess) &#123;</div><div class="line">        <span class="comment">// 后处理器</span></div><div class="line">        object = postProcessObjectFromFactoryBean(object, beanName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> object;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// FactoryBeanRegistrySupport.java</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">doGetObjectFromFactoryBean</span><span class="params">(<span class="keyword">final</span> FactoryBean&lt;?&gt; factory, <span class="keyword">final</span> String beanName)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeanCreationException </span>&#123;</div><div class="line">    <span class="comment">// 核心代码</span></div><div class="line">    Object object = factory.getObject();</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">return</span> object;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="原型模式的循环依赖检查"><a href="#原型模式的循环依赖检查" class="headerlink" title="原型模式的循环依赖检查"></a>原型模式的循环依赖检查</h3><p>只有在单例情况下才会尝试解决循环依赖。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="comment">/** Names of beans that are currently in creation */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Object&gt; prototypesCurrentlyInCreation =</div><div class="line">    <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Prototype beans currently in creation"</span>);</div><div class="line"></div><div class="line"><span class="comment">// Fail if we're already creating this bean instance:</span></div><div class="line"><span class="comment">// We're assumably within a circular reference.</span></div><div class="line"><span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isPrototypeCurrentlyInCreation</span><span class="params">(String beanName)</span> </span>&#123;</div><div class="line">    Object curVal = <span class="keyword">this</span>.prototypesCurrentlyInCreation.get();</div><div class="line">    <span class="keyword">return</span> (curVal != <span class="keyword">null</span> &amp;&amp;</div><div class="line">            (curVal.equals(beanName) || (curVal <span class="keyword">instanceof</span> Set &amp;&amp; ((Set&lt;?&gt;) curVal).contains(beanName))));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="构造器循环依赖"><a href="#构造器循环依赖" class="headerlink" title="构造器循环依赖"></a>构造器循环依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"A"</span> <span class="attr">class</span>=<span class="string">"com.zk.A"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"B"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"B"</span> <span class="attr">class</span>=<span class="string">"com.zk.B"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"C"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"C"</span> <span class="attr">class</span>=<span class="string">"com.zk.C"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"A"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>无法解决，只能抛出 <code>BeanCurrentlyInCreationException</code> 异常</p>
<h4 id="setter-循环依赖"><a href="#setter-循环依赖" class="headerlink" title="setter 循环依赖"></a><code>setter</code> 循环依赖</h4><p>Spring 容器提前暴露刚刚完成构造器注入，但是还未完成其他步骤 (如 setter 注入) 的 bean 来完成的，而且只能解决单例作用域的 bean 循环依赖:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutowireCapableBeanFactory.java</span></div><div class="line">addSingletonFactory(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">            <span class="keyword">return</span> getEarlyBeanReference(beanName, mbd, bean);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<h4 id="prototype-范围的依赖处理"><a href="#prototype-范围的依赖处理" class="headerlink" title="prototype 范围的依赖处理"></a>prototype 范围的依赖处理</h4><p>Spring 容器无法完成依赖注入，因为 Spring 容器不进行缓存 prototype 作用域的 bean，因此无法提前暴露一个创建中的 <code>bean</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"A"</span> <span class="attr">class</span>=<span class="string">"com.zk.A"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"B"</span> <span class="attr">ref</span>=<span class="string">"B"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"B"</span> <span class="attr">class</span>=<span class="string">"com.zk.B"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"C"</span> <span class="attr">ref</span>=<span class="string">"C"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"C"</span> <span class="attr">class</span>=<span class="string">"com.zk.C"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"A"</span> <span class="attr">ref</span>=<span class="string">"A"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="常规-bean-的创建"><a href="#常规-bean-的创建" class="headerlink" title="常规 bean 的创建"></a>常规 bean 的创建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutowireCapableBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> Object[] args)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeanCreationException </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 实例化 Bean</span></div><div class="line">    BeanWrapper instanceWrapper = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</div><div class="line">        instanceWrapper = createBeanInstance(beanName, mbd, args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></div><div class="line">    <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></div><div class="line">    <span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</div><div class="line">                                      isSingletonCurrentlyInCreation(beanName));</div><div class="line">    <span class="keyword">if</span> (earlySingletonExposure) &#123;</div><div class="line">        <span class="comment">// 记录创建 Bean 的 ObjectFactory</span></div><div class="line">        addSingletonFactory(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">					<span class="keyword">return</span> getEarlyBeanReference(beanName, mbd, bean);</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize the bean instance.</span></div><div class="line">    Object exposedObject = bean;</div><div class="line">    <span class="comment">// 属性注入</span></div><div class="line">    populateBean(beanName, mbd, instanceWrapper);</div><div class="line">    <span class="keyword">if</span> (exposedObject != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 调用初始化方法</span></div><div class="line">        exposedObject = initializeBean(beanName, exposedObject, mbd);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 用于销毁方法</span></div><div class="line">    registerDisposableBeanIfNecessary(beanName, bean, mbd);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> exposedObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(5) 检测 parentBeanFactory</p>
<p>如果缓存没有数据，即当前 XML 配置文件找不到 <code>beanName</code> 所对应的配置，就直接转到父类工厂方法去尝试加载了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="comment">// Check if bean definition exists in this factory.</span></div><div class="line">BeanFactory parentBeanFactory = getParentBeanFactory();</div><div class="line"><span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</div><div class="line">    <span class="comment">// Not found -&gt; check parent.</span></div><div class="line">    String nameToLookup = originalBeanName(name);</div><div class="line">    <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// Delegation to parent with explicit args.</span></div><div class="line">        <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// No args -&gt; delegate to standard getBean method.</span></div><div class="line">        <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(6) 将存储 XML 配置文件的 <code>GenericBeanDefinition</code> 转换为 <code>RootBeanDefinition</code></p>
<p>所有 <code>Bean</code> 的后续处理都是针对于 <code>RootBeanDefinition</code> 的，所以这里需要做一个转换，转换的同时，如果父类不为空的话，则会一并合并父类的属性:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</div></pre></td></tr></table></figure>
<p>(7) 寻找依赖</p>
<p><code>Bean</code> 的初始化过程可能会用到其他配置的 <code>Bean</code>，那么这个时候就需要先加载依赖的 <code>Bean</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="comment">// Guarantee initialization of beans that the current bean depends on.</span></div><div class="line">String[] dependsOn = mbd.getDependsOn();</div><div class="line"><span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">for</span> (String dep : dependsOn) &#123;</div><div class="line">        <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</div><div class="line">                                            <span class="string">"Circular depends-on relationship between '"</span> + beanName + <span class="string">"' and '"</span> + dep + <span class="string">"'"</span>);</div><div class="line">        &#125;</div><div class="line">        registerDependentBean(dep, beanName);</div><div class="line">        getBean(dep);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(8) 针对不同的 <code>scope</code> ，进行 <code>Bean</code> 的创建:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create bean instance.</span></div><div class="line"><span class="keyword">if</span> (mbd.isSingleton()) &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    String scopeName = mbd.getScope();</div><div class="line">    <span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(9) 类型转换</p>
<p>程序到这里返回 <code>Bean</code> 后就已经基本结束了，通常对该方法调用 <code>requiredType</code> 是空的，当然也有可能存在返回的 <code>Bean</code> 是一个 <code>String</code>，但是 <code>requiredType</code> 却传入 <code>Integer</code> 类型，那么就会尝试进行类型转换，Spring 提供了各种各样的类型转换器，用户也可以扩展类型转换器来满足需求:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Check if required type matches the type of the actual bean instance.</span></div><div class="line"><span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span> &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) &#123;</div><div class="line">    <span class="keyword">return</span> getTypeConverter().convertIfNecessary(bean, requiredType);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.iflym.com/index.php/code/201208280001.html" target="_blank" rel="external">Spring中循环引用的处理-1</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/30/Spring四/" data-id="cjcdlsfwe002fdiem3hxew4i7" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
 <script src="/blog/jquery/jquery.min.js"></script>
  <div id="random_posts">
    <h2>Recommended Posts</h2>
    <div class="random_posts_ul">
      <script>
          var random_count =4
          var site = {BASE_URI:'/blog/'};
          function load_random_posts(obj) {
              var arr=site.posts;
              if (!obj) return;
              // var count = $(obj).attr('data-count') || 6;
              for (var i, tmp, n = arr.length; n; i = Math.floor(Math.random() * n), tmp = arr[--n], arr[n] = arr[i], arr[i] = tmp);
              arr = arr.slice(0, random_count);
              var html = '<ul>';
            
              for(var j=0;j<arr.length;j++){
                var item=arr[j];
                html += '<li><strong>' + 
                item.date + ':&nbsp;&nbsp;<a href="' + (site.BASE_URI+item.uri) + '">' + 
                (item.title || item.uri) + '</a></strong>';
                if(item.excerpt){
                  html +='<div class="post-excerpt">'+item.excerpt+'</div>';
                }
                html +='</li>';
                
              }
              $(obj).html(html + '</ul>');
          }
          $('.random_posts_ul').each(function () {
              var c = this;
              if (!site.posts || !site.posts.length){
                  $.getJSON(site.BASE_URI + 'js/posts.js',function(json){site.posts = json;load_random_posts(c)});
              } 
               else{
                load_random_posts(c);
              }
          });
      </script>
    </div>
  </div>

    
<nav id="article-nav">
  
    <a href="/blog/2017/07/03/java-basic/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Java Basic
        
      </div>
    </a>
  
  
    <a href="/blog/2017/06/29/Spring三/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Spring (三) - 自定义标签的解析</div>
    </a>
  
</nav>

  
</article>
 
     
  

</section>
           
    <aside id="sidebar">
  
    

  
    
    <div class="widget-wrap">
    
      <div class="widget" id="toc-widget-fixed">
      
        <strong class="toc-title">Content</strong>
        <div class="toc-widget-list">
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-四-Bean-的加载"><span class="toc-number">1.</span> <span class="toc-text">Spring (四) - Bean 的加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#转换-BeanName"><span class="toc-number">1.1.</span> <span class="toc-text">转换 BeanName:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#尝试加载单例"><span class="toc-number">1.2.</span> <span class="toc-text">尝试加载单例:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#从缓存中查找加载单例"><span class="toc-number">1.2.1.</span> <span class="toc-text">从缓存中查找加载单例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#缓存中没有，从头开始-bean-的加载过程"><span class="toc-number">1.2.2.</span> <span class="toc-text">缓存中没有，从头开始 bean 的加载过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备创建-Bean"><span class="toc-number">1.3.</span> <span class="toc-text">准备创建 Bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从-bean-的实例中获取对象"><span class="toc-number">1.4.</span> <span class="toc-text">从 bean 的实例中获取对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原型模式的循环依赖检查"><span class="toc-number">1.5.</span> <span class="toc-text">原型模式的循环依赖检查</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#构造器循环依赖"><span class="toc-number">1.5.1.</span> <span class="toc-text">构造器循环依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setter-循环依赖"><span class="toc-number">1.5.2.</span> <span class="toc-text">setter 循环依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#prototype-范围的依赖处理"><span class="toc-number">1.5.3.</span> <span class="toc-text">prototype 范围的依赖处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常规-bean-的创建"><span class="toc-number">1.6.</span> <span class="toc-text">常规 bean 的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-number">1.7.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
          </div>
      </div>
    </div>

  
    

  
    
  
    
  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>