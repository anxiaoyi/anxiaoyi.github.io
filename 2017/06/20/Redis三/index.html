<html>
<head>
	
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><title>Redis 三 - 字典</title>
	<meta name="keywords" content="代码人生,程序员,赵坤" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>

<body>

<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 id="Redis-三-字典"><a href="#Redis-三-字典" class="headerlink" title="Redis 三 - 字典"></a>Redis 三 - 字典</h2><p>主要涉及到 <code>dict.c</code> 和 <code>dict.h</code> 文件</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>哈希表:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* This is our hash table structure. Every dictionary has two of this as we</span></div><div class="line"><span class="comment"> * implement incremental rehashing, for the old to the new table. */</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></div><div class="line">    <span class="comment">/* Hash Table Array */</span></div><div class="line">    dictEntry **table;</div><div class="line">    <span class="comment">/* Hash Table Size */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</div><div class="line">    <span class="comment">/* For calculate index */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;</div><div class="line">&#125; dictht;</div></pre></td></tr></table></figure>
<p><code>table</code> 属性是一个数组，数组中的每个元素都是一个指向 <code>dictEntry</code> 结构体的指针，每个 <code>dictEntry</code> 保存着一个键值对:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></div><div class="line">    <span class="comment">/* The Key */</span></div><div class="line">    <span class="keyword">void</span> *key;</div><div class="line">    <span class="comment">/* The Value */</span></div><div class="line">    <span class="comment">/* The Value Can be a pointer, </span></div><div class="line"><span class="comment">    or a uint64_t interger, </span></div><div class="line"><span class="comment">    or a int64_t interger,</span></div><div class="line"><span class="comment">    or a double value */</span></div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">void</span> *val;</div><div class="line">        <span class="keyword">uint64_t</span> u64;</div><div class="line">        <span class="keyword">int64_t</span> s64;</div><div class="line">        <span class="keyword">double</span> d;</div><div class="line">    &#125; v;</div><div class="line">    <span class="comment">/* The Pointer to The Next Node */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></div><div class="line">&#125; dictEntry;</div></pre></td></tr></table></figure>
<p><img src="20141017180001203.png" alt=""></p>
<p>字典由 <code>dict</code> 结构体表示:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></div><div class="line">    dictType *type;</div><div class="line">    <span class="keyword">void</span> *privdata;</div><div class="line">    dictht ht[<span class="number">2</span>];</div><div class="line">    <span class="keyword">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></div><div class="line">    <span class="keyword">int</span> iterators; <span class="comment">/* number of iterators currently running */</span></div><div class="line">&#125; dict;</div></pre></td></tr></table></figure>
<p><code>ht[0]</code> 用于存储数据，<code>ht[1]</code> 用于 <code>rehash</code> 的时候使用，当没有进行 <code>rehash</code> 的时候，<code>rehashidx</code> 的值为 -1</p>
<p><code>dictType</code> 保存了一簇用于操作特定类型键值对的函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></div><div class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*hashFunction)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span>;</div><div class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</div><div class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</div><div class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</div><div class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</div><div class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</div><div class="line">&#125; dictType;</div></pre></td></tr></table></figure>
<p>普通状态下的词典:</p>
<p><img src="dict.jpg" alt=""></p>
<h3 id="计算哈希值和索引值"><a href="#计算哈希值和索引值" class="headerlink" title="计算哈希值和索引值:"></a>计算哈希值和索引值:</h3><p>计算键的哈希值:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> dictHashKey(d, key) (d)-&gt;type-&gt;hashFunction(key)</span></div></pre></td></tr></table></figure>
<p>计算索引值:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">idx = h &amp; d-&gt;ht[table].sizemask;</div></pre></td></tr></table></figure>
<h3 id="Hash-算法"><a href="#Hash-算法" class="headerlink" title="Hash 算法"></a>Hash 算法</h3><p>Redis 目前使用两种不同的哈希算法：</p>
<p><strong>1. MurmurHash2 32 bit 算法</strong>：这种算法的分布率和速度都非常好。Redis，Memcached，Cassandra，HBase，Lucene, Hadoop, Nginx 等都在用 <code>MurmurHash</code> 算法，主要是因为算法快，速度快: 与 MD5 这些讲究安全性的摘要算法比，Redis 们内部为主键做个 Hash 而已，就不需要安全性了，因此 Google 家的 MurmurHash 这种 non-cryptographic 的速度会快几十倍</p>
<p>有些人看到 murmur 就想到了陌陌就想到了别的，其实是 <strong>multiply and rotate</strong> 的意思，因为算法的核心就是不断的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">x *= m; </div><div class="line">x = rotate_left(x,r);</div></pre></td></tr></table></figure>
<p><strong>2. 基于 djb 算法实现的一个大小写无关散列算法</strong>：具体信息请参考 <a href="http://www.cse.yorku.ca/~oz/hash.html" target="_blank" rel="external">http://www.cse.yorku.ca/~oz/hash.html</a> 。</p>
<h3 id="解决键冲突"><a href="#解决键冲突" class="headerlink" title="解决键冲突"></a>解决键冲突</h3><p>使用链地址法</p>
<h3 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.slideshare.net/tangfl/redis-9371197" target="_blank" rel="external">Redis 的坑</a></li>
<li><a href="http://calvin1978.blogcn.com/articles/murmur.html" target="_blank" rel="external">陌生但默默一统江湖的MurmurHash</a></li>
<li><a href="http://redisbook.readthedocs.io/en/latest/internal-datastruct/dict.html" target="_blank" rel="external">字典</a></li>
</ul><!-- hexo-inject:begin --><!-- hexo-inject:end -->






</body>
</html>
