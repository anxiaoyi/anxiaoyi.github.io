<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Architecture | 代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Architecture技术(1) 如何实现高并发、高可用的系统？ 高并发原则: 无状态、拆分、服务化、消息队列、数据异构、缓存银弹、并发化 高可用原则: 负载均衡与反向代理、隔离术、降级、限流、切流量、超时与重试、可回滚、压测与预案   以下摘自 《看透 Spring MVC 源代码分析与实践》:  (2) 负载均衡与反向代理 (3) 隔离术隔离手段: 线程池隔离、进程隔离、集群隔离、机房隔离、">
<meta property="og:type" content="article">
<meta property="og:title" content="Architecture">
<meta property="og:url" content="http://blog.kunzhao.org/2017/08/12/architecture/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="Architecture技术(1) 如何实现高并发、高可用的系统？ 高并发原则: 无状态、拆分、服务化、消息队列、数据异构、缓存银弹、并发化 高可用原则: 负载均衡与反向代理、隔离术、降级、限流、切流量、超时与重试、可回滚、压测与预案   以下摘自 《看透 Spring MVC 源代码分析与实践》:  (2) 负载均衡与反向代理 (3) 隔离术隔离手段: 线程池隔离、进程隔离、集群隔离、机房隔离、">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://blog.kunzhao.org/2017/08/12/architecture/2017_09_03_20_15_46.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/08/12/architecture/17-08-12-10_51_07_326_138.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/08/12/architecture/17-08-12-10_55_34_809_385.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/08/12/architecture/2.-BFS-Wave.png">
<meta property="og:image" content="http://blog.kunzhao.org/2017/08/12/architecture/bidirectional-breadth-first-search.jpg">
<meta property="og:updated_time" content="2017-11-03T04:56:39.928Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Architecture">
<meta name="twitter:description" content="Architecture技术(1) 如何实现高并发、高可用的系统？ 高并发原则: 无状态、拆分、服务化、消息队列、数据异构、缓存银弹、并发化 高可用原则: 负载均衡与反向代理、隔离术、降级、限流、切流量、超时与重试、可回滚、压测与预案   以下摘自 《看透 Spring MVC 源代码分析与实践》:  (2) 负载均衡与反向代理 (3) 隔离术隔离手段: 线程池隔离、进程隔离、集群隔离、机房隔离、">
<meta name="twitter:image" content="http://blog.kunzhao.org/2017/08/12/architecture/2017_09_03_20_15_46.png">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-architecture" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/08/12/architecture/" class="article-date">
  <time datetime="2017-08-12T02:21:37.000Z" itemprop="datePublished">2017-08-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/架构/">架构</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Architecture
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h1><h2 id="技术"><a href="#技术" class="headerlink" title="技术"></a>技术</h2><h3 id="1-如何实现高并发、高可用的系统？"><a href="#1-如何实现高并发、高可用的系统？" class="headerlink" title="(1) 如何实现高并发、高可用的系统？"></a>(1) 如何实现高并发、高可用的系统？</h3><ul>
<li><strong>高并发原则</strong>: 无状态、拆分、服务化、消息队列、数据异构、缓存银弹、并发化</li>
<li><strong>高可用原则</strong>: 负载均衡与反向代理、隔离术、降级、限流、切流量、超时与重试、可回滚、压测与预案</li>
</ul>
<hr>
<p>以下摘自 《看透 Spring MVC 源代码分析与实践》:</p>
<p><img src="2017_09_03_20_15_46.png" alt=""></p>
<h3 id="2-负载均衡与反向代理"><a href="#2-负载均衡与反向代理" class="headerlink" title="(2) 负载均衡与反向代理"></a>(2) 负载均衡与反向代理</h3><p><img src="17-08-12-10_51_07_326_138.png" alt=""></p>
<h3 id="3-隔离术"><a href="#3-隔离术" class="headerlink" title="(3) 隔离术"></a>(3) 隔离术</h3><p><strong>隔离手段</strong>: 线程池隔离、进程隔离、集群隔离、机房隔离、读写隔离、快慢隔离、动静隔离、爬虫隔离等。</p>
<p><img src="17-08-12-10_55_34_809_385.png" alt=""></p>
<hr>
<p><strong>如何测试响应时间</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">siege -c100 -t60s -b http://***.item.jd.com/92183</div></pre></td></tr></table></figure>
<h3 id="4-限流"><a href="#4-限流" class="headerlink" title="(4) 限流"></a>(4) 限流</h3><p><strong><a href="https://tomcat.apache.org/tomcat-7.0-doc/config/http.html" target="_blank" rel="external">Tomcat 限流</a></strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></div><div class="line"><span class="tag">           <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></div><div class="line"><span class="tag">           <span class="attr">redirectPort</span>=<span class="string">"8443"</span> <span class="attr">acceptCount</span>=<span class="string">"1000"</span> <span class="attr">maxConnections</span>=<span class="string">"500"</span> /&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li><strong>acceptCount</strong>: The maximum queue length for incoming connection requests when all possible request processing threads are in use. Any requests received when the queue is full will be refused. The default value is 100.</li>
<li><strong>maxConnections</strong>: The maximum number of connections that the server will accept and process at any given time. When this number has been reached, the server will accept, but not process, one further connection. </li>
<li><strong>maxThreads</strong>: The maximum number of request processing threads to be created by this Connector, which therefore determines the maximum number of simultaneous requests that can be handled.</li>
</ul>
<hr>
<p><strong><a href="https://dev.mysql.com/doc/refman/5.7/en/too-many-connections.html" target="_blank" rel="external">MySQL 限流</a></strong>:</p>
<p>The number of connections permitted is controlled by the <code>max_connections</code> system variable. The default value is 151 to improve performance when MySQL is used with the Apache Web server. (Previously, the default was 100.) If you need to support more connections, you should set a larger value for this variable.</p>
<hr>
<p><strong><a href="http://shokunin.co/blog/2014/11/11/operational_redis.html" target="_blank" rel="external">Redis 限流1</a>, <a href="https://www.techandme.se/performance-tips-for-redis-cache-server/" target="_blank" rel="external">Redis 限流2</a></strong>，Set tcp-backlog in <code>redis.conf</code>:</p>
<p>Newer versions of redis have their own backlog(积压) set to <code>511</code> and you will need this to be higher if you have many connections:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># TCP listen() backlog.</div><div class="line"># In high requests-per-second environments you need an high backlog in order</div><div class="line"># make sure to raise both the value of somaxconn and tcp_max_syn_backlog</div><div class="line">tcp-backlog 65536</div></pre></td></tr></table></figure>
<h3 id="5-降级"><a href="#5-降级" class="headerlink" title="(5) 降级"></a>(5) 降级</h3><p>我们需要通过<strong>配置方式</strong>来开启/关闭降级开关: 使用 <code>properties</code> 文件作为配置文件，借助 JDK 7 <strong><code>WatchService</code> 实现文件变更通知</strong>。</p>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><h3 id="1-如何从-Facebook-或-LinkedIn-中找出两个人之间的最短路径？"><a href="#1-如何从-Facebook-或-LinkedIn-中找出两个人之间的最短路径？" class="headerlink" title="(1) 如何从 Facebook 或 LinkedIn 中找出两个人之间的最短路径？"></a>(1) 如何从 <code>Facebook</code> 或 <code>LinkedIn</code> 中找出两个人之间的最短路径？</h3><p><strong>步骤一</strong>: Simplify the Problem - <strong>忘记</strong> the Millions of Users</p>
<p><strong>1. 广度优先搜索</strong>:</p>
<p><img src="2.-BFS-Wave.png" alt=""></p>
<p><strong>2. bidirectional 广度优先搜索</strong>:</p>
<p><img src="bidirectional-breadth-first-search.jpg" alt=""></p>
<p><strong>步骤二</strong>: Handle the Millions of Users</p>
<ul>
<li><strong>1. For each friend ID: <code>int machine index = getMachineIDForUser(personID);</code></strong></li>
<li><strong>2. Go to machine <code>#machine_index</code></strong></li>
<li><strong>3. On that machine, do: <code>Person friend = getPersonWithID(person_id);</code></strong></li>
</ul>
<h3 id="2-如何放置爬虫陷入无止境的循环中？"><a href="#2-如何放置爬虫陷入无止境的循环中？" class="headerlink" title="(2) 如何放置爬虫陷入无止境的循环中？"></a>(2) 如何放置爬虫陷入无止境的循环中？</h3><p>we must recognize that URL parameters might indicate a completely different page. For example, the page <code>www.careercup.com/page?pid=microsoft-interviewquestionsis</code> totally different from the page <code>www.careercup.com/page?pid=google-interviewquestions</code>. But, we can also append URL parameters arbitrarily to any URL without truly changing the page, provided it’s not a parameter that the web application recognizes and handles. The page <code>www.careercup.com?foobar=hello</code> is the same as <code>www.careercup.com</code>.</p>
<h3 id="3-检测有无重复-URL"><a href="#3-检测有无重复-URL" class="headerlink" title="(3) 检测有无重复 URL"></a>(3) 检测有无重复 URL</h3><p>Just how much space do 1O billion URLs take up? If each URL is an average of 100 characters, and each character is 4 bytes, then this list of 1O billion URLs will take up about <strong>4 TB</strong>. We are probably not going to hold that much data in memory.</p>
<p>Let’s just pretend for a moment that we were <strong>想象我们可以放到内存中</strong>, since it’s useful to first construct a solution for the simple version. Under this version of the problem, we would just create a <strong>哈希表</strong> where each URL maps to true if it’s already been found elsewhere in the list. (As an alternative solution, we could <strong>排序</strong> and look for the duplicate values that way. That will take a bunch of extra time and offers few advantages.)</p>
<p><strong>方案一: 磁盘存储</strong>:</p>
<p>将所有这些 URL 拆成 4000 份，<strong>每份 1GB</strong>. An easy way to do that might be to store each URL <code>u</code> in a file named <code>&lt;x&gt;.txt</code> where <code>x = hash(u) % 4000</code>. load each file into memory, create a hash table of the URLs, and look for duplicates.</p>
<p><strong>方案二: 多台机器</strong>:</p>
<p>The main pro is that we can <strong>并行操作</strong>, such that all 4000 chunks are <strong>同时处理</strong>. For large amounts of data, this might result in a faster solution.</p>
<h3 id="4-为-100-台机器设计缓存"><a href="#4-为-100-台机器设计缓存" class="headerlink" title="(4) 为 100 台机器设计缓存"></a>(4) 为 100 台机器设计缓存</h3><p><strong>1. Design a Cache for a Single System</strong>:</p>
<p>how would you create a data structure that enables you to easily purge old data and also efficiently look up a value based on a key?</p>
<p><strong>2. Expand to Many Machines</strong>:</p>
<ul>
<li>每台机器都拥有自己的缓存</li>
<li>每台机器都有一份缓存的拷贝</li>
<li>每台机器都拥有一部分缓存</li>
</ul>
<p><strong>3. Updating results when contents change</strong>:</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/08/12/architecture/" data-id="cjc5qrt0p002f5cemh6h6ywfg" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
 <script src="/blog/jquery/jquery.min.js"></script>
  <div id="random_posts">
    <h2>Recommended Posts</h2>
    <div class="random_posts_ul">
      <script>
          var random_count =4
          var site = {BASE_URI:'/blog/'};
          function load_random_posts(obj) {
              var arr=site.posts;
              if (!obj) return;
              // var count = $(obj).attr('data-count') || 6;
              for (var i, tmp, n = arr.length; n; i = Math.floor(Math.random() * n), tmp = arr[--n], arr[n] = arr[i], arr[i] = tmp);
              arr = arr.slice(0, random_count);
              var html = '<ul>';
            
              for(var j=0;j<arr.length;j++){
                var item=arr[j];
                html += '<li><strong>' + 
                item.date + ':&nbsp;&nbsp;<a href="' + (site.BASE_URI+item.uri) + '">' + 
                (item.title || item.uri) + '</a></strong>';
                if(item.excerpt){
                  html +='<div class="post-excerpt">'+item.excerpt+'</div>';
                }
                html +='</li>';
                
              }
              $(obj).html(html + '</ul>');
          }
          $('.random_posts_ul').each(function () {
              var c = this;
              if (!site.posts || !site.posts.length){
                  $.getJSON(site.BASE_URI + 'js/posts.js',function(json){site.posts = json;load_random_posts(c)});
              } 
               else{
                load_random_posts(c);
              }
          });
      </script>
    </div>
  </div>

    
<nav id="article-nav">
  
    <a href="/blog/2017/08/14/windows/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Windows
        
      </div>
    </a>
  
  
    <a href="/blog/2017/08/06/redis/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Redis</div>
    </a>
  
</nav>

  
</article>
 
     
  

</section>
           
    <aside id="sidebar">
  
    

  
    
    <div class="widget-wrap">
    
      <div class="widget" id="toc-widget-fixed">
      
        <strong class="toc-title">Content</strong>
        <div class="toc-widget-list">
              <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Architecture"><span class="toc-number">1.</span> <span class="toc-text">Architecture</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#技术"><span class="toc-number">1.1.</span> <span class="toc-text">技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-如何实现高并发、高可用的系统？"><span class="toc-number">1.1.1.</span> <span class="toc-text">(1) 如何实现高并发、高可用的系统？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-负载均衡与反向代理"><span class="toc-number">1.1.2.</span> <span class="toc-text">(2) 负载均衡与反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-隔离术"><span class="toc-number">1.1.3.</span> <span class="toc-text">(3) 隔离术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-限流"><span class="toc-number">1.1.4.</span> <span class="toc-text">(4) 限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-降级"><span class="toc-number">1.1.5.</span> <span class="toc-text">(5) 降级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设计"><span class="toc-number">1.2.</span> <span class="toc-text">设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-如何从-Facebook-或-LinkedIn-中找出两个人之间的最短路径？"><span class="toc-number">1.2.1.</span> <span class="toc-text">(1) 如何从 Facebook 或 LinkedIn 中找出两个人之间的最短路径？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-如何放置爬虫陷入无止境的循环中？"><span class="toc-number">1.2.2.</span> <span class="toc-text">(2) 如何放置爬虫陷入无止境的循环中？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-检测有无重复-URL"><span class="toc-number">1.2.3.</span> <span class="toc-text">(3) 检测有无重复 URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-为-100-台机器设计缓存"><span class="toc-number">1.2.4.</span> <span class="toc-text">(4) 为 100 台机器设计缓存</span></a></li></ol></li></ol></li></ol>
          </div>
      </div>
    </div>

  
    

  
    
  
    
  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>