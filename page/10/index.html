<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="赵坤的个人网站">
<meta property="og:type" content="website">
<meta property="og:title" content="代码人生">
<meta property="og:url" content="http://blog.kunzhao.org/page/10/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="赵坤的个人网站">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码人生">
<meta name="twitter:description" content="赵坤的个人网站">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-JUnit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/31/JUnit/" class="article-date">
  <time datetime="2017-07-31T07:58:28.000Z" itemprop="datePublished">2017-07-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/31/JUnit/">JUnit</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="JUnit"><a href="#JUnit" class="headerlink" title="JUnit"></a>JUnit</h2><p>添加依赖:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;junit&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;junit&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.12&lt;/version&gt;</div><div class="line">    &lt;scope&gt;test&lt;/scope&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<h3 id="Annotation-to-make-a-private-method-public-only-for-test-classes"><a href="#Annotation-to-make-a-private-method-public-only-for-test-classes" class="headerlink" title="Annotation to make a private method public only for test classes"></a>Annotation to make a private method public only for test classes</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">somePublicMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">        ....</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@PublicForTests</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">somePrivateMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">        ....</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>The <strong>common way</strong> is to make the private method <strong>protected or package-private</strong> and to put the unit test for this method in the <strong>same package</strong> as the class under test. Guava has a <code>@VisibleForTesting</code> annotation, but it’s only for documentation purpose.</p>
<hr>
<p>If your test coverage is good on all the public method inside the tested class, the <strong>privates methods called by the public one</strong> will be <strong>自动测试</strong> since you will assert all the possible case.</p>
<p>The <code>JUnit</code> Doc says:</p>
<p>Testing private methods may be an indication that those methods should be moved into another class to promote reusability. But if you must… If you are using JDK 1.3 or higher, you can use <strong>反射</strong> to subvert the access control mechanism with the aid of the <code>PrivilegedAccessor</code>. For details on how to use it, read <a href="http://onjava.com/pub/a/onjava/2003/11/12/reflection.html" target="_blank" rel="external">this article</a>.</p>
<hr>
<p>Consider using <strong>使用接口暴露 API 方法</strong>, using <strong>factories or DI</strong> to publish the objects so the consumers know them only by the interface. The interface describes the published API. That way you can make whatever you want public on the implementation objects and the consumers of them see only those methods exposed through the interface.</p>
<h3 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h3><p><code>Rules</code> are used to <strong>添加额外功能</strong> which applies to <strong>所有测试</strong> within a test class, but <strong>以一种更加通用的方式</strong>.</p>
<p>For instance, <code>ExternalResource</code> executes code before and after a test method, without having to use <code>@Before</code> and <code>@After</code>. Using an <code>ExternalResource</code> rather than <code>@Before</code> and <code>@After</code> gives opportunities for <strong>更号的代码复用</strong>; the same rule can be used from two different test classes.</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JunitRuleTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Rule</span></div><div class="line">    <span class="keyword">public</span> TemporaryFolder tempFolder = <span class="keyword">new</span> TemporaryFolder();</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRule</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        File newFolder = tempFolder.newFolder(<span class="string">"Temp Folder"</span>);</div><div class="line">        assertTrue(newFolder.exists());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Every time the above test method is executed, a temporary folder is created and <strong>方法执行完就会自动删除</strong>. This is an example of an out-of-box rule provided by Junit.</p>
<hr>
<p>官方示例/提供的 <code>Rules</code> 请参考: <a href="https://github.com/junit-team/junit4/wiki/Rules" target="_blank" rel="external">Rules-Wiki</a></p>
<h3 id="mockito"><a href="#mockito" class="headerlink" title="mockito"></a>mockito</h3><p>如何 <code>mock</code> 一个 <code>HostProvider</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HostProvider</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> InetSocketAddress <span class="title">next</span><span class="params">(<span class="keyword">long</span> spinDelay)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnected</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">updateServerList</span><span class="params">(Collection&lt;InetSocketAddress&gt; serverAddresses,</span></span></div><div class="line"><span class="function"><span class="params">                             InetSocketAddress currentHost)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 <code>org.mockito.mock</code> 方法来 <code>mock</code> 它:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">HostProvider hostProvider = mock(HostProvider.class);</div><div class="line">when(hostProvider.size()).thenReturn(<span class="number">1</span>);</div><div class="line">InetSocketAddress inaddr = <span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>, <span class="number">1111</span>);</div><div class="line">when(hostProvider.next(anyLong())).thenReturn(inaddr);</div></pre></td></tr></table></figure>
<p>也可以 <code>mock</code> 具体的类 (如 <code>Zookeeper.java</code>) :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ZooKeeper zk = mock(ZooKeeper.class);</div><div class="line">when(zk.getClientConfig()).thenReturn(<span class="keyword">new</span> ZKClientConfig());</div></pre></td></tr></table></figure>
<h3 id="RunWith"><a href="#RunWith" class="headerlink" title="@RunWith"></a>@RunWith</h3><p>默认的 <code>Runner</code> 是 <code>BlockJUnit4ClassRunner</code>，使用 <code>@RunWith</code> 可以显示声明<strong>e当运行测试的时候需要 <code>invoke</code> 的类</strong>。</p>
<h3 id="如何测试没有异常抛出"><a href="#如何测试没有异常抛出" class="headerlink" title="如何测试没有异常抛出"></a>如何测试没有异常抛出</h3><p>如果异常抛出的话，那么测试会<strong>自动失败</strong></p>
<h3 id="好的单元测试应具有的品质"><a href="#好的单元测试应具有的品质" class="headerlink" title="好的单元测试应具有的品质"></a>好的单元测试应具有的品质</h3><ul>
<li>运行快</li>
<li>能够帮助我们定位问题所在</li>
</ul>
<blockquote>
<p>一个需要耗时十分之一秒才能执行完的单元测试就已算是一个慢的单元测试了。</p>
</blockquote>
<hr>
<p>下面这些测试不是单元测试:</p>
<ul>
<li>跟数据库有交互</li>
<li>进行了网络通信</li>
<li>调用了文件系统</li>
<li>需要你对环境做特定的准备 (如编辑配置文件) 才能运行的</li>
</ul>
<hr>
<p>当一个类直接依赖 (构造器依赖) 某些难以在测试中使用的东西 (<code>DBConnection</code>, <code>InvoceUpdateServlet</code>) 时，这个类就是难以修改和处理的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvoiceUpdateResponder</span><span class="params">(DBConnection conn, InvoceiUpdateServlet servlet)</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于某个特定的类来说，不改变它就难以为它编写测试的话，那么<strong>转而去测试使用它的那些类</strong>往往会简单一些。我们可以解开 <code>InvoiceUpdateResponder</code> 对 <code>InvoiceUpdateServlet</code> 的依赖：只需将 <code>InvoiceUpdateResponder</code> <strong>真正需要的东西传给它</strong>就行。同样我们也可以解开 <code>InvoiceUpdateResponder</code> 对 <code>DBConnection</code> 的依赖，只需要引入一个<strong>接口</strong> <code>IDBConnection</code>，并将 <code>InvoiceUpdateResponder</code> 改为使用该接口即可。</p>
<p>实际上，在没有测试保护的情况下进行上述的重构依然是<strong>安全</strong>的。</p>
<hr>
<p>依赖性往往是进行测试的最为明显的障碍。表现在两个方面:</p>
<ul>
<li>难以在测试用具中<strong>实例化</strong>目标对象</li>
<li>难以在测试用具中<strong>运行方法</strong></li>
</ul>
<hr>
<p>当 <code>scan</code> 被调用的时候，<code>Sale</code> 对象需要在收银机的显示器上显示出被扫描商品的名称及价格:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">------------------------</div><div class="line">|         Sale        |</div><div class="line">------------------------</div><div class="line">|+scan(barcode: String)|</div><div class="line">------------------------</div></pre></td></tr></table></figure>
<p>假如我们想测试一下 <code>Sale</code> 对象能否在显示器上正确显示商品的名称及价格，那么我们该怎么做？ 倘若我们能够找到实际刷新的那行代码…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">------------------------         --------------------------</div><div class="line">|         Sale        |          |      ArtR56Display    |</div><div class="line">--------------------------------&gt;--------------------------</div><div class="line">|+scan(barcode: String)|         | +showLine(line: String)|</div><div class="line">------------------------         --------------------------</div></pre></td></tr></table></figure>
<p>如此改动一番之后，我们就可以进一步得到如下设计:</p>
<p><img src="2017_11_06_21_05_51.png" alt=""></p>
<p>我们的测试类就可以这么写:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDisplayAnItem</span><span class="params">()</span> </span>&#123;</div><div class="line">    FakeDisplay display = <span class="keyword">new</span> FakeDisplay();</div><div class="line">    Sale sale = <span class="keyword">new</span> Sale(display);</div><div class="line">    sale.scan(<span class="string">"1"</span>);</div><div class="line">    assertEquals(<span class="string">"Milk $3.99"</span>, display.getLastLine());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果要编写许许多多的伪对象的话，建议你考虑一种更高级的伪对象，即所谓的 <code>Mock Object</code>。</p>
<h3 id="库依赖问题"><a href="#库依赖问题" class="headerlink" title="库依赖问题"></a>库依赖问题</h3><blockquote>
<p>尽量避免在你的代码中到处出现对库的直接调用。你可能会觉得永远也不会去修改这些调用，但最终可能只是自欺欺人。</p>
</blockquote>
<h3 id="应用毫无架构可言"><a href="#应用毫无架构可言" class="headerlink" title="应用毫无架构可言"></a>应用毫无架构可言</h3><p>通常架构师的任务就是<strong>掌控全局</strong>，为团队做出能够维持系统整体架构不变的决策。有一个特别需要注意的地方，那就是架构师必须得跟团队的其他成员打成一片，否则代码就会逐渐偏离主航向。</p>
<p>要想发挥架构师的最大作用，关键还是要看团队的成员是否能够清楚架构师到底意味着什么，并能够感到架构师是跟他们休戚相关的一个角色。每一个接触代码的人都应该了解架构，如果团队里每个人都有共同的想法，那么整体的力量就会大大增强。如果你有一个 20 人的团队，其中只有 3 个人了解架构细节，则要么这 3 人需要<strong>多做额外的工作</strong>来让其余 17 人都能够跟上，要么就等着其余 17 人因<strong>对大局不熟而犯错误</strong>吧。</p>
<p>我们怎样才能获得读一个大型系统的整体认识呢？方法很多。Serge Derneyer、Stephane Ducasse 和 Oscar M. Nicrstrasz 合著的 《Object-Oriented Reengineering Patterns》 一书中就包含了一组用来解决这些问题的技术。还有几个相当强大的技术，如果你常在团队里实践这些技术，就会发现它们能够使你的团队始终保持对架构的关注，对于架构的维持来说，或许没有什么比这个还要重要的了。</p>
<h3 id="需要修改大量相同的代码"><a href="#需要修改大量相同的代码" class="headerlink" title="需要修改大量相同的代码"></a>需要修改大量相同的代码</h3><p>面对代码重复，其实只需要<strong>从删除小块重复代码开始</strong>就行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">c</span><span class="params">()</span> </span>&#123;</div><div class="line">    a();</div><div class="line">    a();</div><div class="line">    b();</div><div class="line">    a();</div><div class="line">    b();</div><div class="line">    b();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">c</span><span class="params">()</span> </span>&#123;</div><div class="line">    aa();</div><div class="line">    b();</div><div class="line">    a();</div><div class="line">    bb();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">c</span><span class="params">()</span> </span>&#123;</div><div class="line">    a();</div><div class="line">    ab();</div><div class="line">    ab();</div><div class="line">    b();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="解依赖技术"><a href="#解依赖技术" class="headerlink" title="解依赖技术"></a>解依赖技术</h3><p>将类解依赖以使它们能被置于测试之下的技术:</p>
<ul>
<li><strong>接口提取</strong></li>
</ul>
<p>在对方法作改动时有时会发现难以创建所需的参数，又比如需要测试某方法对其某个参数的影响。在参数依赖问题上，<strong>接口提取</strong>往往是不二之选。</p>
<p><img src="2017_11_06_21_38_43.png" alt=""></p>
<p>将参数类型外覆起来，从而完全解除对 <code>API</code> 接口的依赖:</p>
<p><img src="2017_11_06_21_39_53.png" alt=""></p>
<blockquote>
<p>接口应该传达职责而非实现细节，这样的接口令代码易于阅读和维护。</p>
</blockquote>
<p><img src="2017_11_06_21_42_30.png" alt=""></p>
<p><img src="2017_11_06_21_43_01.png" alt=""></p>
<p>遗留代码基中的一个普遍问题就是<strong>抽象层次不够</strong>。系统中最重要的代码往往跟底层 <code>API</code> 耦合在一起。</p>
<ul>
<li><strong>分解出方法对象</strong></li>
<li><strong>封装全局引用</strong></li>
</ul>
<blockquote>
<p>如果若干个全局变量总是被一起使用一起修改，则它们应该属同一个类。</p>
</blockquote>
<ul>
<li><strong>暴露静态方法</strong></li>
</ul>
<p>假如你有一个方法，该方法<strong>不使用实例变量或其他方法</strong>，就可以将它设置成静态的。</p>
<ul>
<li><strong>提取并重写调用</strong></li>
</ul>
<p><img src="2017_11_06_22_14_39.png" alt=""></p>
<p><img src="2017_11_06_22_16_07.png" alt=""></p>
<ul>
<li><strong>实现提取</strong></li>
</ul>
<p>提取一个接口，却发现我想给它取的名字已经被当前类给占用了。</p>
<ul>
<li><strong>接口提取</strong></li>
</ul>
<p>在编写新类时，最简单的事情莫过于起个简单的名字了，即便是对于大型的抽象也是如此。例如，如果我们正在编写一个 <code>account</code> 包，则我们可以从一个就叫 <code>Account</code> 的类开始。然后开始编写测试添加新的特性，随着系统的增长，迟早你会想要把 <code>Account</code> 做成一个接口。这时可以在 <code>Account</code> 下创建一个派生类，并将 <code>Account</code> 中的所有数据方法都转移到它里面，将 <code>Account</code> <strong>架空成一个接口</strong>，这么做的好处就是你无需将代码中所有引用 <code>Account</code> 的地方修改成引用新的接口。</p>
<p>许多时候，在得到足够的测试覆盖之前，最好避免大规模的改动。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://book.douban.com/subject/2248759/" target="_blank" rel="external">《修改代码的艺术》</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/31/JUnit/" data-id="cjc5qrsug00055cem9yr7h3v1" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Log" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/31/Log/" class="article-date">
  <time datetime="2017-07-31T07:43:24.000Z" itemprop="datePublished">2017-07-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/31/Log/">Log</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><h3 id="常见-Log-框架"><a href="#常见-Log-框架" class="headerlink" title="常见 Log 框架"></a>常见 <code>Log</code> 框架</h3><ul>
<li><strong><code>JDK Logger</code></strong>: 鸡肋，很少在线上系统中被使用</li>
<li><strong><code>Apache Commons Logging</code> + <code>Apache Log4j</code></strong>: 前者提供<strong>通用日志接口</strong>，后者提供实现</li>
<li><strong><code>Slf4j</code> + <code>Logback</code></strong>: 前者<strong>提供统一接口</strong></li>
<li><strong><code>Apache Log4j2</code></strong></li>
</ul>
<h3 id="Apache-Commons-Logging-Apache-Log4j"><a href="#Apache-Commons-Logging-Apache-Log4j" class="headerlink" title="Apache Commons Logging + Apache Log4j"></a>Apache Commons Logging + Apache Log4j</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 通用日志接口 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Log log = LogFactory.getLog(CommonsLoggingDemo.class);</div></pre></td></tr></table></figure>
<h3 id="1-slf4j"><a href="#1-slf4j" class="headerlink" title="(1) slf4j"></a>(1) <code>slf4j</code></h3><p>添加 <a href="https://www.slf4j.org/manual.html" target="_blank" rel="external"><code>slf4j</code></a> 依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.slf4j/slf4j-api --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>需要<strong>结合</strong>任意一个实现，比如 <code>Log4j</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>注: 添加这个依赖之后，就不需要添加其它的 <code>log4j Maven</code> 依赖了</p>
</blockquote>
<p><strong>如何使用</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Wombat</span> </span>&#123;</div><div class="line">  </div><div class="line">    <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(Wombat.class);</div><div class="line">    Integer t;</div><div class="line">    Integer oldT;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTemperature</span><span class="params">(Integer temperature)</span> </span>&#123;</div><div class="line">    </div><div class="line">        oldT = t;</div><div class="line">        t = temperature;</div><div class="line"></div><div class="line">        logger.debug(<span class="string">"Temperature set to &#123;&#125;. Old temperature was &#123;&#125;."</span>, t, oldT);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(temperature.intValue() &gt; <span class="number">50</span>) &#123;</div><div class="line">            logger.info(<span class="string">"Temperature has risen above 50 degrees."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Failed to load class org.slf4j.impl.StaticLoggerBinder</div></pre></td></tr></table></figure>
<p>This warning message is reported when the <code>org.slf4j.impl.StaticLoggerBinder</code> class could not be loaded into memory. This happens when no appropriate SLF4J binding could be found on the class path. <strong>Placing one (and only one)</strong> of <code>slf4j-nop.jar, slf4j-simple.jar, slf4j-log4j12.jar, slf4j-jdk14.jar or logback-classic.jar</code> on the class path should solve the problem.</p>
<h4 id="logback"><a href="#logback" class="headerlink" title="logback"></a><code>logback</code></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/ch.qos.logback/logback-core --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><a href="https://logback.qos.ch" target="_blank" rel="external"><code>logback</code></a> 是由 <code>log4j</code> 创始人设计的又一个开源日志组件。程序运行时，<code>logback</code> 会查找默认的配置文件 <code>logback.xml</code> 或者 <code>logback-test.xml</code> 文件，如果没有找到它就会使用默认的配置，将日志打印到 <code>console</code> 中。下面是一个<a href="https://logback.qos.ch/manual/configuration.html" target="_blank" rel="external">简单配置文件</a>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- encoders are assigned the type</span></div><div class="line"><span class="comment">         ch.qos.logback.classic.encoder.PatternLayoutEncoder by default --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"debug"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<hr>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"DefaultAppender"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;user.home&#125;/logs/rocketmqlogs/tools_default.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">append</span>&gt;</span>true<span class="tag">&lt;/<span class="name">append</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.FixedWindowRollingPolicy"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.home&#125;/logs/rocketmqlogs/otherdays/tools_default.%i.log</div><div class="line">    <span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">minIndex</span>&gt;</span>1<span class="tag">&lt;/<span class="name">minIndex</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">maxIndex</span>&gt;</span>5<span class="tag">&lt;/<span class="name">maxIndex</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">triggeringPolicy</span></span></div><div class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyy-MM-dd HH:mm:ss,GMT+8&#125; %p %t - %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">charset</span> <span class="attr">class</span>=<span class="string">"java.nio.charset.Charset"</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li><strong><code>FixedWindowRollingPolicy</code></strong>: 当保存了 5 个文档之后，<strong>将覆盖最早的日志</strong>。</li>
</ul>
<h3 id="2-log4j"><a href="#2-log4j" class="headerlink" title="(2) log4j"></a>(2) <code>log4j</code></h3><blockquote>
<p><code>log4j</code> 是线程安全的</p>
</blockquote>
<p>添加依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/log4j/log4j --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><img src="log-levels.png" alt=""></p>
<h4 id="2-1-打印到-Console"><a href="#2-1-打印到-Console" class="headerlink" title="2.1 打印到 Console:"></a>2.1 打印到 <code>Console</code>:</h4><p><strong><code>log4j.properties</code></strong> 文件的内容:</p>
<p><img src="17-08-05-16_34_39_745_152.png" alt=""></p>
<p>使用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Logger classLogger = Logger.getLogger(Foo.class);</div><div class="line">    <span class="keyword">final</span> Logger infoLogger = Logger.getLogger(<span class="string">"INFO"</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Foo</span><span class="params">()</span> </span>&#123;</div><div class="line">        classLogger.info(<span class="string">"new Foo"</span>);</div><div class="line">        infoLogger.info(<span class="string">"new Foo"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> Foo();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-同时打印到-Console-和文件-log-out-中"><a href="#2-2-同时打印到-Console-和文件-log-out-中" class="headerlink" title="2.2 同时打印到 Console 和文件 log.out 中:"></a>2.2 同时打印到 <code>Console</code> 和文件 <code>log.out</code> 中:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">log4j.rootLogger = DEBUG, console, file</div><div class="line"></div><div class="line">log4j.appender.console = org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.layout=org.apache.log4j.PatternLayout</div><div class="line"></div><div class="line">log4j.appender.file = org.apache.log4j.RollingFileAppender</div><div class="line">log4j.appender.file.file = log.out</div><div class="line">log4j.appender.file.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.file.layout.ConversionPattern=%<span class="number">5</span>p [%t] (%F:%L) - %m%n</div></pre></td></tr></table></figure>
<p>在 <code>Intellij Idea</code> 中直接运行后 <code>log.out</code> 文件存放的位置:</p>
<p><img src="17-08-05-16_50_11_355_205.png" alt=""></p>
<p>打成 <code>Jar</code> 包以后运行后 <code>log.out</code> 文件存放的位置:</p>
<p><img src="17-08-05-16_54_16_1164_84.png" alt=""></p>
<h4 id="2-3-单独指定某个类的日志输出到指定文件中"><a href="#2-3-单独指定某个类的日志输出到指定文件中" class="headerlink" title="2.3 单独指定某个类的日志输出到指定文件中"></a>2.3 单独指定某个类的日志输出到指定文件中</h4><p>你需要<strong>自定义 <code>Logger</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">log4j.logger.com.zk.Foo = DEBUG, fooFile</div><div class="line"></div><div class="line">log4j.appender.fooFile.file = fooFile.out</div><div class="line">log4j.appender.fooFile = org.apache.log4j.RollingFileAppender</div><div class="line">log4j.appender.fooFile.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.fooFile.layout.ConversionPattern=%<span class="number">5</span>p [%t] (%F:%L) - %m%n</div></pre></td></tr></table></figure>
<p>使用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Logger classLogger = Logger.getLogger(Foo.class);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Foo</span><span class="params">()</span> </span>&#123;</div><div class="line">        classLogger.info(<span class="string">"new Foo"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-4-避免自定义-Logger-的内容同时输出到-rootLogger-中"><a href="#2-4-避免自定义-Logger-的内容同时输出到-rootLogger-中" class="headerlink" title="2.4 避免自定义 Logger 的内容同时输出到 rootLogger 中"></a>2.4 避免自定义 <code>Logger</code> 的内容同时输出到 <code>rootLogger</code> 中</h4><p>默认情况下 <code>com.zk.Foo</code> 这个 <code>Logger</code> 输出的内容会在 <code>rootLogger</code> 和 <code>com.zk.Foo</code> 都打印一份:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">log4j.rootLogger = DEBUG, console, file</div><div class="line"></div><div class="line">log4j.appender.console = org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.layout=org.apache.log4j.PatternLayout</div><div class="line"></div><div class="line">log4j.appender.file = org.apache.log4j.RollingFileAppender</div><div class="line">log4j.appender.file.file = log.out</div><div class="line">log4j.appender.file.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.file.layout.ConversionPattern=%5p [%t] (%F:%L) - %m%n</div><div class="line"></div><div class="line">log4j.logger.com.zk.Foo = DEBUG, fooFile</div><div class="line">log4j.additivity.com.zk.Foo = false</div><div class="line"></div><div class="line">log4j.appender.fooFile.file = fooFile.out</div><div class="line">log4j.appender.fooFile = org.apache.log4j.RollingFileAppender</div><div class="line">log4j.appender.fooFile.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.fooFile.layout.ConversionPattern=%5p [%t] (%F:%L) - %m%n</div></pre></td></tr></table></figure>
<p>添加这行代码可以只使用 <code>com.zk.Foo</code> 这个 <code>Logger</code> 来打印:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">log4j.additivity.com.zk.Foo = <span class="keyword">false</span></div></pre></td></tr></table></figure>
<h4 id="2-5-ConversionPattern-可用的描述符号"><a href="#2-5-ConversionPattern-可用的描述符号" class="headerlink" title="2.5 ConversionPattern 可用的描述符号"></a>2.5 <code>ConversionPattern</code> 可用的描述符号</h4><ul>
<li><strong>c</strong>: The <code>Logger</code> used to invoke this logging request.</li>
<li><strong>C</strong>: The fully qualified name of the <code>Logger</code> invoking this logging request.</li>
<li><strong>d</strong>: The date of the logging request.</li>
<li><strong>F</strong>: 调用打印日志的代码所在的文件</li>
<li><strong>l</strong>: The location information.</li>
<li><strong>L</strong>: 行号</li>
<li><strong>m</strong>: 消息</li>
<li><strong>M</strong>: 方法</li>
<li><strong>n</strong>: 行分隔符</li>
<li><strong>p</strong>: Level</li>
<li><strong>r</strong>: 相对毫秒</li>
<li><strong>t</strong>: 线程</li>
<li><strong>x</strong>: NDC 信息</li>
<li><strong>X</strong>: MDC 信息</li>
<li><strong>%</strong>: 字面量</li>
</ul>
<h4 id="RollingFileAppender"><a href="#RollingFileAppender" class="headerlink" title="RollingFileAppender"></a>RollingFileAppender</h4><h4 id="Log4j-通过代码配置一个-Console-输出-Appender"><a href="#Log4j-通过代码配置一个-Console-输出-Appender" class="headerlink" title="Log4j 通过代码配置一个 Console 输出 Appender:"></a><code>Log4j</code> 通过代码配置一个 <code>Console</code> 输出 <code>Appender</code>:</h4><p>把这段代码放到 <code>main</code> 函数所在类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    ConsoleAppender consoleAppender = <span class="keyword">new</span> ConsoleAppender();</div><div class="line">    consoleAppender.setLayout(<span class="keyword">new</span> PatternLayout(PatternLayout.DEFAULT_CONVERSION_PATTERN));</div><div class="line">    consoleAppender.activateOptions();</div><div class="line">    org.apache.log4j.BasicConfigurator.configure(consoleAppender);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Log4j-的问题"><a href="#Log4j-的问题" class="headerlink" title="Log4j 的问题"></a><code>Log4j</code> 的问题</h4><p>默认 <code>Appenders</code> 采用<strong>同步锁</strong>实现,太多日志会使服务的性能下降。</p>
<hr>
<p><strong>改进</strong>: 把同步操作改为异步操作 (使用一个<strong>缓冲队列</strong>)，然后用单独的消费者线程去消费缓冲队列，异步地将缓冲队列的日志内容打印到日志文件中。</p>
<p>不要使用 <code>ConcurrentLinkedQueue</code> 作为缓冲队列，<code>ConcurrentLinkedQueue</code> 的 <code>size()</code> 方法的实现并不是常量时间复杂度的，而是 <code>O(n)</code> 的，即每次调用 <code>size()</code> 方法都需要实时计算队列的大小，导致 <code>CPU</code> 利用率加大。 建议采用 <code>ArrayBlockingQueue</code> 来实现。</p>
<p>在消费缓冲队列时，可以:</p>
<ul>
<li>一条一条地顺序消费，就是使用一个<strong>无限循环</strong>的队列，<strong>只要</strong>缓冲队列不为空，就从队列中取日志后写入日志文件中。</li>
<li>批量消费模式会<strong>定时</strong>地取批量日志事件然后写入日志文件中。</li>
</ul>
<hr>
<p><code>Log4j</code> 是通过<strong>构建异常</strong>从异常堆栈中提取<strong>方法名、文件名和行号</strong>的，不推荐在日志中使用 <code>%L, %M, %F, %l</code> 占位符来显示相关信息等，但可以使用 <strong><code>%c</code></strong> 来打印类名。</p>
<h3 id="3-log4j-2-X-版本"><a href="#3-log4j-2-X-版本" class="headerlink" title="(3) log4j 2.X 版本"></a>(3) <code>log4j 2.X</code> 版本</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong><code>log4j2.xml</code></strong> 文件的内容如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">Configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"Console"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"trace"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="我的编程习惯-–-日志建议"><a href="#我的编程习惯-–-日志建议" class="headerlink" title="我的编程习惯 – 日志建议"></a>我的编程习惯 – 日志建议</h3><p>对日志的最少有以下2点要求：</p>
<ul>
<li>能找到那个机器</li>
</ul>
<p><img src="395bd130d20a8478ec8aa38a4fcb7f45.png" alt=""></p>
<p>这样，从返回头里面就能知道是<strong>哪台机器</strong>处理的请求，返回的响应:</p>
<p><img src="459592bfa3f6e6a23e7d8856360f3592.png" alt=""></p>
<ul>
<li>能找到<strong>用户做了什么</strong></li>
</ul>
<h3 id="读取日志文件目录"><a href="#读取日志文件目录" class="headerlink" title="读取日志文件目录"></a>读取日志文件目录</h3><p>读取第一个匹配的日志文件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    org.apache.log4j.Logger logger = LogManager.getRootLogger();</div><div class="line">    <span class="keyword">if</span> (logger != <span class="keyword">null</span>) &#123;</div><div class="line">        Enumeration&lt;Appender&gt; appenders = logger.getAllAppenders();</div><div class="line">        <span class="keyword">if</span> (appenders != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">while</span> (appenders.hasMoreElements()) &#123;</div><div class="line">                Appender appender = appenders.nextElement();</div><div class="line">                <span class="keyword">if</span> (appender <span class="keyword">instanceof</span> FileAppender) &#123;</div><div class="line">                    FileAppender fileAppender = (FileAppender) appender;</div><div class="line">                    String filename = fileAppender.getFile();</div><div class="line">                    file = <span class="keyword">new</span> File(filename);</div><div class="line">                    <span class="keyword">break</span>; </div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="log4j-properties"><a href="#log4j-properties" class="headerlink" title="log4j.properties"></a><code>log4j.properties</code></h3><p>有如下日志文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">log4j.rootLogger = DEBUG,I,E,S,W,stdout</div><div class="line"></div><div class="line">#console</div><div class="line">log4j.appender.S = org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.S.Threshold = INFO</div><div class="line">log4j.appender.S.Target = System.out</div><div class="line">log4j.appender.S.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.S.layout.ConversionPattern = %d&#123;yyyy-MM-dd HH:mm:ss&#125; %-5p %F:%L %-16t - %m%n</div><div class="line"></div><div class="line">#其他的将会省略…</div></pre></td></tr></table></figure>
<p>这个 <code>log4j.properties</code> 最终会被转为:</p>
<p><img src="2017_12_13_22_37_35.png" alt=""></p>
<hr>
<p>上述介绍的是 <code>rootLogger</code>，当你自定义 <code>logger</code> 的时候:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">log4j.logger.pageTask = INFO, pageTaskFile, S</div><div class="line">log4j.additivity.pageTask = false</div><div class="line"></div><div class="line">log4j.appender.pageTaskFile = org.apache.log4j.DailyRollingFileAppender</div><div class="line">log4j.appender.pageTaskFile.file = ./log/pageTaskFile.log</div><div class="line">log4j.appender.pageTaskFile.Append = true</div><div class="line">log4j.appender.pageTaskFile.Threshold = INFO</div><div class="line">log4j.appender.pageTaskFile.layout = org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.pageTaskFile.layout.ConversionPattern = %d&#123;yyyy-MM-dd HH:mm:ss&#125; %-5p %F:%L %-16t - %m%n</div></pre></td></tr></table></figure>
<p>这个最终被转为了:</p>
<p><img src="2017_12_13_22_42_52.png" alt=""></p>
<p>调用代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Logger logger = Logger.getLogger(<span class="string">"pageTask"</span>);</div><div class="line">logger.info(<span class="string">"aaa"</span>);</div></pre></td></tr></table></figure>
<p><code>Logger</code> 类控制的是一个大的方向，如果通过的话，才会进一步进入附属在 <code>Appender</code> 上的各个 <code>Appender</code> 进行打印日志。然后迭代对各个 <code>Appender</code> 进行 <code>Threshold</code> 验证，如果通过就打印，如果不通过就不打印。</p>
<hr>
<p>寻找 <code>Logger</code> 的过程，如果找不到，最终会落到 <code>rootLogger</code> 上:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Category</span> <span class="keyword">implements</span> <span class="title">AppenderAttachable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Level <span class="title">getEffectiveLevel</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span>(Category c = <span class="keyword">this</span>; c != <span class="keyword">null</span>; c=c.parent) &#123;</div><div class="line">            <span class="keyword">if</span>(c.level != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> c.level;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// If reached will cause an NullPointerException.</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>声明如下的 <code>log4j.properties</code> 日志文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">log4j.logger.com.buptnsrc.appcrawl.mapper = DEBUG, S</div><div class="line">log4j.additivity.com.buptnsrc.appcrawl.mapper = false</div></pre></td></tr></table></figure>
<p>则最终 <code>Logger</code> 的继承关系为:</p>
<p><img src="2017_12_14_14_56_27.png" alt=""></p>
<hr>
<p><code>additivity</code> 的作用:</p>
<p><img src="2017_12_14_14_58_34.png" alt=""></p>
<h3 id="log4j-的性能问题"><a href="#log4j-的性能问题" class="headerlink" title="log4j 的性能问题"></a><code>log4j</code> 的性能问题</h3><p>(1) <code>log4j 1.2.18</code>:</p>
<p>多个线程使用同一个 <code>Logger</code> 加锁：</p>
<p><img src="2017_12_14_15_03_07.png" alt=""></p>
<p>多个线程使用同一个 <code>Appender</code> 加锁:</p>
<p><img src="2017_12_14_15_06_47.png" alt=""></p>
<p>这两个锁对于系统的性能影响是很大的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/31/Log/" data-id="cjc5qrsv1000a5cembjydp0jh" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-tcpip-high-performance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/30/tcpip-high-performance/" class="article-date">
  <time datetime="2017-07-30T06:12:51.000Z" itemprop="datePublished">2017-07-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/30/tcpip-high-performance/">TCP/IP High Performance</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="TCP-IP-High-Performance"><a href="#TCP-IP-High-Performance" class="headerlink" title="TCP/IP High Performance"></a>TCP/IP High Performance</h2><h3 id="1-套接字-API-调用过程"><a href="#1-套接字-API-调用过程" class="headerlink" title="(1) 套接字 API 调用过程"></a>(1) 套接字 API 调用过程</h3><p><strong>服务器</strong>套接字 API 调用过程:</p>
<p><img src="17-07-31-09_24_37_375_535.png" alt=""></p>
<h3 id="2-理解面向连接和无连接协议之间的区别"><a href="#2-理解面向连接和无连接协议之间的区别" class="headerlink" title="(2) 理解面向连接和无连接协议之间的区别"></a>(2) 理解面向连接和无连接协议之间的区别</h3><p>它们的本质区别在于，<strong>对无连接协议来说，每个分组的处理都独立于所有其他分组，而对免息那个连接的协议来说，协议实现则维护了与后继分组有关的状态信息</strong>。</p>
<p>TCP 向基本的 IP 服务中添加了三项功能:</p>
<ul>
<li>为数据提供校验和</li>
<li>为每字节分配了一个序列号</li>
<li>提供确认-重传机制: TCP 段到达时，序列号在接受窗口范围之外的所有数据都会被丢弃。</li>
</ul>
<p>UDP 向底层的 IP 协议中添加了两项功能:</p>
<ul>
<li>可选的校验和检测数据的损坏情况</li>
<li>端口的概念</li>
</ul>
<p>IP 也有校验和，但是它<strong>只对 IP 分组首</strong>部进行计算。</p>
<h3 id="3-理解子网和-CIDR-概念"><a href="#3-理解子网和-CIDR-概念" class="headerlink" title="(3) 理解子网和 CIDR 概念"></a>(3) 理解子网和 CIDR 概念</h3><p>IP 地址为 32 比特长。通常会以点分十进制法来写 IP 地址，其中每 4 个字节由一个十进制数表示，并用点将其分割开来。因此，可以将地址 0x11345678 写作 17.52.86.120 。</p>
<p>传统 IP 地址划分为 5 类，这种划分称之为<strong>分类编址 (classful addressing)</strong>:</p>
<p><img src="ipclasses.png" alt=""></p>
<p>我们希望有一种方法，使用很小的路由表，并使单个网络 ID 的 IP 地址空间得到有效利用，而且享有每个网段具有独立网络 ID 时所提供的路由便捷性。实现这种功能的机制被称为 — <strong>子网划分 (subnetting)</strong>:</p>
<p><img src="subnetting1.jpg" alt=""></p>
<p>每个子网都有一个与之相关的<strong>子网掩码 (subnet mask)</strong>，用来说明地址中组合了网络和子网络的部分。尽管被称为<strong>子网掩码，实际上它说明的是地址中的网络和子网部分 — 也就是除了主机部分之外所有的内容</strong>。和子网掩码进行与操作，解析出 IP 地址的网络部分:</p>
<p><img src="17-07-31-09_52_34_531_150.png" alt=""></p>
<p>大部分中等及较大规模的组织所需的 IP 地址都比 C 类网络 ID 所能提供的地址要多，CIDR (Classless Inter Domain Routing) 完全抛弃了分类的概念，掩码只是一个被称为前缀的数字，说明了地址中网络部分的比特长度。</p>
<h3 id="4-理解私有地址和-NAT"><a href="#4-理解私有地址和-NAT" class="headerlink" title="(4) 理解私有地址和 NAT"></a>(4) 理解私有地址和 NAT</h3><p><img src="Private-IP-Address.jpg" alt=""></p>
<p>使用私有 IP 地址的主机如何跟因特网或其他外网上的主机进行通信呢？这个问题最常见的答案就是使用 <strong>NAT (Network Address Translation)</strong>:</p>
<p><img src="image0021083244899217.jpg" alt=""></p>
<h3 id="5-记住，TCP-是一种流协议"><a href="#5-记住，TCP-是一种流协议" class="headerlink" title="(5) 记住，TCP 是一种流协议"></a>(5) 记住，TCP 是一种流协议</h3><p>读取 TCP 数据就像从串行端口读取数据一样 — <strong>无法预先得知在一次指定的读调用中会返回多少字节</strong>，调用两次 <code>send</code> 来发送的错误假想模型:</p>
<p><img src="17-07-31-10_12_57_577_113.png" alt=""></p>
<p>实际上，<code>send</code> 只是将数据复制到主机 A 的 TCP/IP 栈中，就返回了。由 TCP 来决定需要立即发送多少数据，更为可能的是如下的一些方式:</p>
<p><img src="17-07-31-10_14_08_518_310.png" alt=""></p>
<p>所以可以根据如下几种方式读取:</p>
<ul>
<li>划分成行:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">/**  char *fgets(dst,max,fp) -- get string from stream */</span></div><div class="line"></div><div class="line"><span class="keyword">char</span> *</div><div class="line">fgets(<span class="keyword">char</span> *dst, <span class="keyword">int</span> max, FILE *fp)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> c;</div><div class="line">	<span class="keyword">char</span> *p;</div><div class="line"></div><div class="line">	<span class="comment">/* get max bytes or upto a newline */</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span> (p = dst, max--; max &gt; <span class="number">0</span>; max--) &#123;</div><div class="line">		<span class="keyword">if</span> ((c = fgetc (fp)) == EOF)</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		*p++ = c;</div><div class="line">		<span class="keyword">if</span> (c == <span class="string">'\n'</span>)</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	*p = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (p == dst || c == EOF)</div><div class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">	<span class="keyword">return</span> (p);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>定长报文:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">recv(s, msg, <span class="keyword">sizeof</span>(msg), <span class="number">0</span>);</div></pre></td></tr></table></figure>
<ul>
<li>每条报文前面添加一个首部</li>
</ul>
<h3 id="不是绝对可靠"><a href="#不是绝对可靠" class="headerlink" title="不是绝对可靠"></a>不是绝对可靠</h3><ul>
<li>网络中断: 读操作被挂起，会返回一条错误状况，并将 <code>errno</code> 置位 <code>ETIMEOUT</code>。</li>
<li>对等实体崩溃: 从应用程序的角度来看，对等实体崩溃与对等实体调用 <code>close</code> 和 <code>exit</code> 是无法区分的。这两种情况下，对等实体的 TCP 都会向我们的 TCP 发送一个 <code>FIN</code></li>
<li>对等实体的主机崩溃: 对等实体的 TCP 无法通过 <code>FIN</code> 来通知我们的应用沉痼，其对等实体已经不在运行了</li>
</ul>
<h3 id="总是设置-SO-REUSEADDR-选项"><a href="#总是设置-SO-REUSEADDR-选项" class="headerlink" title="总是设置 SO_REUSEADDR 选项"></a>总是设置 <code>SO_REUSEADDR</code> 选项</h3><p><strong>终止服务器</strong>的时候可能会出现这种 <code>Address already in use</code> 问题:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ badserver</div><div class="line">^C</div><div class="line">$ badserver</div><div class="line">badserver: Could not <span class="built_in">bind</span> socket:</div><div class="line">Address already <span class="keyword">in</span> use (48)</div></pre></td></tr></table></figure>
<p>TCP 连接中进行主动关闭 (发送第一个 <code>FIN</code>) 的那一端会进入 <code>TIME-WAIT</code> 状态，并在此状态停留 <code>2MSL</code>，通过<strong>设置 <code>SO_REUSEADDR</code></strong>，指示 TCP 允许我们绑定到一个已经在使用的端口上去，这样就<strong>不用等待前一条连接的 <code>TIME-WAIT</code> 状态过期，就可以重启服务器。</strong></p>
<h3 id="如何使-connect-调用超时"><a href="#如何使-connect-调用超时" class="headerlink" title="如何使 connect 调用超时"></a>如何使 <code>connect</code> 调用超时</h3><p><img src="17-07-30-14_37_21_750_432.png" alt=""></p>
<p>通常在套接字阻塞的情况下，<strong>在收到对客户端 <code>SYN</code> 的 <code>ACK</code> 之前，<code>connect</code> 是不会返回的</strong>，所以允许 <code>connect</code> 超时是一项很有用的功能。当然，TCP 最终也会放弃 <code>connect</code> 调用的，但默认时间 (典型值是 75 秒) 比我们希望等待的时间要长。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/30/tcpip-high-performance/" data-id="cjc5qrt2u005h5cemyqx6uema" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-java-quartz" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/29/java-quartz/" class="article-date">
  <time datetime="2017-07-29T07:48:57.000Z" itemprop="datePublished">2017-07-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/29/java-quartz/">java-quartz</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Java-Quartz"><a href="#Java-Quartz" class="headerlink" title="Java Quartz"></a>Java Quartz</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><img src="logo-quartz-scheduler.png" alt=""></p>
<p><code>Quartz</code> can be used to create simple or complex schedules for executing tens, hundreds, or even tens-of-thousands of jobs.</p>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="每隔多长时间运行一次"><a href="#每隔多长时间运行一次" class="headerlink" title="每隔多长时间运行一次"></a>每隔多长时间运行一次</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    JobDetail job = JobBuilder.newJob(HelloJob.class)</div><div class="line">        .withIdentity(<span class="string">"job1"</span>, <span class="string">"group1"</span>)</div><div class="line">        .build();</div><div class="line"></div><div class="line">    Trigger trigger = TriggerBuilder.newTrigger()</div><div class="line">        .withIdentity(<span class="string">"trigger1"</span>, <span class="string">"group1"</span>)</div><div class="line">        .startNow()</div><div class="line">        .withSchedule(</div><div class="line">                      SimpleScheduleBuilder.simpleSchedule()</div><div class="line">                      .withIntervalInSeconds(<span class="number">5</span>)</div><div class="line">                      .repeatForever())</div><div class="line">        .build();</div><div class="line"></div><div class="line">    Scheduler scheduler = StdSchedulerFactory.getDefaultScheduler();</div><div class="line">    scheduler.scheduleJob(job, trigger);</div><div class="line"></div><div class="line">    scheduler.start();</div><div class="line">&#125; <span class="keyword">catch</span> (SchedulerException se) &#123;</div><div class="line">    se.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Trigger-does-not-reference-given-job"><a href="#Trigger-does-not-reference-given-job" class="headerlink" title="Trigger does not reference given job"></a>Trigger does not reference given job</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">org.quartz.SchedulerException: Trigger does not reference given job!</div><div class="line">	at org.quartz.core.QuartzScheduler.scheduleJob(QuartzScheduler.java:<span class="number">869</span>)</div><div class="line">	at org.quartz.impl.StdScheduler.scheduleJob(StdScheduler.java:<span class="number">249</span>)</div></pre></td></tr></table></figure>
<p>一个 <code>Job</code> 可以有多个 <code>Trigger</code>，但是多个 <code>Job</code> 不能对应同一个 <code>Trigger</code>。</p>
<h3 id="org-quartz-ObjectAlreadyExistsException"><a href="#org-quartz-ObjectAlreadyExistsException" class="headerlink" title="org.quartz.ObjectAlreadyExistsException"></a>org.quartz.ObjectAlreadyExistsException</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">org.quartz.ObjectAlreadyExistsException: Unable to store Trigger with name: <span class="string">'QuartzQueryTaskTrigger'</span> and group: <span class="string">'QuartzQueryTaskGroup'</span>, because one already exists with <span class="keyword">this</span> identification.</div><div class="line">	at org.quartz.simpl.RAMJobStore.storeTrigger(RAMJobStore.java:<span class="number">415</span>)</div><div class="line">	at org.quartz.simpl.RAMJobStore.storeJobAndTrigger(RAMJobStore.java:<span class="number">252</span>)</div><div class="line">	at org.quartz.core.QuartzScheduler.scheduleJob(QuartzScheduler.java:<span class="number">886</span>)</div><div class="line">	at org.quartz.impl.StdScheduler.scheduleJob(StdScheduler.java:<span class="number">249</span>)</div></pre></td></tr></table></figure>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a><code>Job</code></h3><p><code>Job</code> 必须提供一个<strong>无参</strong>的公共构造函数</p>
<h3 id="嵌套类"><a href="#嵌套类" class="headerlink" title="嵌套类"></a>嵌套类</h3><p><img src="2017_11_09_10_53_09.png" alt=""></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li><a href="http://www.quartz-scheduler.org/documentation/quartz-2.1.x/configuration/" target="_blank" rel="external">参考</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/29/java-quartz/" data-id="cjc5qrt2500415cem23kbb7x7" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-java-proxy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/29/java-proxy/" class="article-date">
  <time datetime="2017-07-29T02:03:29.000Z" itemprop="datePublished">2017-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/29/java-proxy/">Java AOP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Java-AOP"><a href="#Java-AOP" class="headerlink" title="Java AOP"></a>Java AOP</h2><h3 id="运行期代理"><a href="#运行期代理" class="headerlink" title="运行期代理"></a>运行期代理</h3><h4 id="1-JDK-动态代理"><a href="#1-JDK-动态代理" class="headerlink" title="(1) JDK 动态代理"></a>(1) JDK 动态代理</h4><p><code>Proxy</code> 利用 <code>InvocationHandler</code> <strong>动态创建一个符合某一接口的实例</strong>，生成目标类的代理对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">//do something "dynamic"</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">InvocationHandler handler = <span class="keyword">new</span> MyInvocationHandler();</div><div class="line">InvocationHandler handler = <span class="keyword">new</span> MyInvocationHandler();</div><div class="line">MyInterface proxy = (MyInterface) Proxy.newProxyInstance(</div><div class="line">                            MyInterface.class.getClassLoader(),</div><div class="line">                            <span class="keyword">new</span> Class[] &#123; MyInterface.class &#125;,</div><div class="line">                            handler);</div></pre></td></tr></table></figure>
<h4 id="2-CGLib-动态代理"><a href="#2-CGLib-动态代理" class="headerlink" title="(2) CGLib 动态代理"></a>(2) <a href="https://dzone.com/articles/cglib-missing-manual" target="_blank" rel="external">CGLib 动态代理</a></h4><p><code>CGLib</code> 采用底层的<strong>字节码</strong>技术，<strong>可以为一个类创建子类</strong>，在子类中采用方法拦截的技术拦截所有父类方法的调用并顺势织入横切逻辑。</p>
<p>An enhancer allows the creation of Java proxies for non-interface types. The <code>Enhancer</code> can be compared with the Java standard library’s <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Proxy.html" target="_blank" rel="external"><code>Proxy</code></a> class which was introduced in Java 1.3. The <code>Enhancer</code> dynamically creates a subclass of a given type but intercepts all method calls. Other than with the <code>Proxy</code> class, this <strong>works for both class and interface types.</strong> </p>
<p>Even though constructors are only methods on the Java byte code level, the Enhancer class <strong>cannot instrument constructors. Neither can it instrument static or final classes</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethodInterceptor</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">    enhancer.setSuperclass(SampleClass.class);</div><div class="line">    enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span></span></div><div class="line"><span class="function">                <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="keyword">if</span>(method.getDeclaringClass() != Object.class </div><div class="line">                   &amp;&amp; method.getReturnType() == String.class) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="string">"Hello cglib!"</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    proxy.invokeSuper(obj, args);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    SampleClass proxy = (SampleClass) enhancer.create();</div><div class="line">    assertEquals(<span class="string">"Hello cglib!"</span>, proxy.test(<span class="keyword">null</span>));</div><div class="line">    assertNotEquals(<span class="string">"Hello cglib!"</span>, proxy.toString());</div><div class="line">    proxy.hashCode(); <span class="comment">// Does not throw an exception or result in an endless loop.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>A Final Word of Warning</strong>:</p>
<p>All cglib classes generate byte code which results in additional classes being stored in a special section of the JVM’s memory: The so called perm space. This permanent space is, as the name suggests, used for permanent objects that do not usually get garbage collected. This is however not completely true: Once a <code>Class</code> is loaded, it cannot be unloaded until the loading <code>ClassLoader</code> becomes available for garbage collection. This is only the case the <code>Class</code> was loaded with a custom <code>ClassLoader</code> which is not a native JVM system <code>ClassLoader</code>. This <code>ClassLoader</code> can be garbage collected if itself, all Classes it ever loaded and all instances of all Classes it ever loaded become available for garbage collection. This means: If you create more and more classes throughout the life of a Java application and if you do not take care of the removal of these classes, you will sooner or later run of of perm space what will result in your application’s death by the hands of an <code>OutOfMemoryError</code>. Therefore, use cglib sparingly (节俭地). However, if you use cglib wisely and carefully, you can really do amazing things with it that go beyond what you can do with non-instrumented Java applications.</p>
<h3 id="类加载期代理"><a href="#类加载期代理" class="headerlink" title="类加载期代理"></a>类加载期代理</h3><p>在类加载期通过<strong>字节码编辑技术</strong>将切面织入目标类中，这种织入方式称之为 <strong>LTW (Load Time Weaving)</strong>。<code>AspectJ LTW</code> 使用 Java 5.0 所提供的代理功能 (agent) 完成加载期切面织入工作。JDK 的代理功能能够让代理器访问到 JVM 的底层部件，<strong>借此向 JVM 注册类文件转换器，在类加载时对类文件的字节码进行转换</strong>。AspectJ LTW 由于基于 JDK 动态代理技术工作，而 JDK 动态代理的作用范围是整个 JVM，所以这种工作方式比较粗放，对于单一 JVM 多个应用的情况尤其不适合。Spring 为 LTW 的过程提供了细粒度的控制，它<strong>支持在单个 <code>ClassLoader</code> 范围内实施类文件转换</strong>，且配置更为简单。</p>
<p><code>Java 5.0</code> 新增了一个 <code>java.lang.instrument</code> 包，该包中有两个能对 JVM 底层组件进行访问的类。具体地说，就是通过 JVM 的 <code>-javaagent</code> 代理参数在启动时获取 <code>JVM</code> 内部组件的引用，以便在后续流程中使用。借助 JDK 动态代理，可以<strong>在 JVM 启动时装配并应用 <code>ClassTransformer</code></strong>，对类字节码进行转换，实现 AOP 的功能。</p>
<p><code>java.lang.instrument</code> 包中定义了两个重要的接口。</p>
<ul>
<li><code>ClassFileTransformer</code>: <strong><code>Class</code> 文件转换器接口</strong>，该接口有一个唯一的方法，如下:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClassFileTransformer</span> </span>&#123;</div><div class="line">    <span class="keyword">byte</span>[]</div><div class="line">    transform(  ClassLoader         loader,</div><div class="line">                String              className,</div><div class="line">                Class&lt;?&gt;            classBeingRedefined,</div><div class="line">                ProtectionDomain    protectionDomain,</div><div class="line">                <span class="keyword">byte</span>[]              classfileBuffer)</div><div class="line">        <span class="keyword">throws</span> IllegalClassFormatException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该接口对 <code>Class</code> 文件的字节码进行转换，<code>classfileBuffer</code> 是类文件对应的字节码数组，返回的 <code>byte[]</code> 是转换后的字节码。如果返回 <code>null</code>，则表示不进行字节码处理。</p>
<ul>
<li><code>Instrumentation</code>: 代表 JVM 内部的一个构件，可以通过该接口的方法向 JVM 的内部 “组件” 注册一些 <code>ClassFileTransformer</code>:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Instrumentation</span> </span>&#123;</div><div class="line">    <span class="keyword">void</span></div><div class="line">    addTransformer(ClassFileTransformer transformer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当 <code>ClassFileTransformer</code> 实例注册到 <code>JVM</code> 后，<code>JVM</code> 在加载 <code>Class</code> 文件时，会 先调用这个 <code>ClassFileTransformer</code> 的 <code>transform()</code> 方法对 <code>Class</code> 文件的字节码进行转换。如果向 <code>JVM</code> 中注册多个 <code>ClassFileTransformer</code>，它们将按照注册的顺序组成链式的调用。这样 <code>ClassFileTransformer</code> 的实现者就可以<strong>从 <code>JVM</code> 层面截获所有类的字节码</strong>，并引入希望添加的逻辑，如让每个类拥有性能监视的能力、织入特殊用途的增强代码等。</p>
<p><img src="17-07-29-11_05_18_810_499.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/29/java-proxy/" data-id="cjc5qrt21003z5cemtaxxebuc" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/blog/page/9/">&laquo; 上一页</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/8/">8</a><a class="page-number" href="/blog/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/blog/page/11/">11</a><a class="page-number" href="/blog/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/23/">23</a><a class="extend next" rel="next" href="/blog/page/11/">下一页&raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    

  
    
  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/01/06/where-the-time-actually-gone/">时间都去哪儿了</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/dev-reflection/">开发反思</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/my-microblog/">我的微博</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/gcc-basic/">gcc-basic</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/java-internal/">Java Internal</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>