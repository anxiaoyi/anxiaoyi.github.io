<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="赵坤的个人网站">
<meta property="og:type" content="website">
<meta property="og:title" content="代码人生">
<meta property="og:url" content="http://blog.kunzhao.org/page/16/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="赵坤的个人网站">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码人生">
<meta name="twitter:description" content="赵坤的个人网站">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Peopleware" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/28/Peopleware/" class="article-date">
  <time datetime="2017-06-28T07:51:09.000Z" itemprop="datePublished">2017-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/笔记本/">笔记本</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/28/Peopleware/">Peopleware</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Peopleware"><a href="#Peopleware" class="headerlink" title="Peopleware"></a>Peopleware</h2><p>我们工作中的问题，更多属于社会学范畴，而非技术范畴。</p>
<p>压力不会让人们工作地更好，只是工作地更快。</p>
<p>平均 100 行代码，就有 1 ~ 3 个缺陷。</p>
<blockquote>
<p>苦杏素是从杏树里提炼出来的无色液体。在瑞典，超市里就可以买到这样的东西，价格跟杏仁提取物相当。然而在墨西哥，你花 50 美金只能买到这么一滴，因为它可以 “治愈” 致命的癌症。事实上，苦杏素不能治愈任何疾病。所有证据都揭示这其实是一个残忍的骗局，但在走投无路的情况下，无论这种说法多么离谱，病人最终还是会接受苦杏素小贩们的说法。<strong>处于绝望中的人们是不会理性去看待证据的。</strong></p>
</blockquote>
<p>同理，不少管理人员也 “足够绝望”，需求如此迫切，他们就会忽略对证据的审视。</p>
<p><strong>软件管理的七个假象</strong>:</p>
<ul>
<li>有一个你不知道的新窍门可以让产能飙升。</li>
<li>其他管理者正在收过 100%、200% 乃至更多的增长！</li>
<li>技术日新月异，你已经过时了！ — 技术确实日新月异，但你所做的大部分工作并不是真正的高科技。</li>
<li>改变程序语言会给你带来巨大提升。— 被夸大的宣传把一些新的程序语言塑造成了苦杏素。</li>
<li>因为库存 (backlog) 的缘故，你需要马上让产能翻倍。</li>
<li>你自动化了其他所有东西，难道不是要你自动化掉你的软件开发人员吗？</li>
<li>你的员工在巨大压力下工作得更好。</li>
</ul>
<p><strong>这就是管理</strong>:</p>
<p>管理者的作用不是让大家去工作，而是创造环境，让大家可以顺利开展工作。</p>
<blockquote>
<p>一个下雪天，我拖着身体搭建着我们那不够完善的系统，准备用户演示。莎伦进来，发现我在控制台前强撑着精神做事。她转身离开，几分钟后，她端着一碗热汤出现了。喝完她给的热汤，我精神一震，然后问她在管理工作如此繁忙的同时，怎么有时间来做这些。她给了我一个招牌式的微笑，然后说：“汤姆，这就是管理。”</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/28/Peopleware/" data-id="cjc5qrsvu000r5cemc1lrpv99" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-OperatingSystem" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/28/OperatingSystem/" class="article-date">
  <time datetime="2017-06-28T02:48:05.000Z" itemprop="datePublished">2017-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/理解计算机/">理解计算机</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/28/OperatingSystem/">Operating System (操作系统)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Operating-System-操作系统"><a href="#Operating-System-操作系统" class="headerlink" title="Operating System (操作系统)"></a>Operating System (操作系统)</h2><h3 id="What-is-wrong-with-the-code-x-x-a-in-context-of-a-concurrent-system"><a href="#What-is-wrong-with-the-code-x-x-a-in-context-of-a-concurrent-system" class="headerlink" title="What is wrong with the code : x = x + a , in context of a concurrent system?"></a>What is wrong with the code : <code>x = x + a</code> , in context of a concurrent system?</h3><p>At machine level, <code>x = x + a</code> is implemented in multiple instructions :</p>
<ul>
<li>Load the value of <code>x</code> into register.</li>
<li>Add <code>a</code> to the register value.</li>
<li>Store the value from register.</li>
</ul>
<p>For concurrent systems, race condition can come and result in multiple processes/threads reading the old value simultaneously and updating independently. This will result in overwriting results from each other. To implement the code safely, we need to acquire write-lock (mutually exclusive lock) before writing our value. This will result in updating of value sequentially which will avoid the race condition:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(x, a)</span> </span>&#123;</div><div class="line">    lockW(x);</div><div class="line">    x = x + a;</div><div class="line">    unlockW(x);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="What-is-inode-in-file-system"><a href="#What-is-inode-in-file-system" class="headerlink" title="What is inode in file system?"></a>What is <code>inode</code> in file system?</h3><p><code>inode</code> is a type of <strong>data-structure</strong> in a UNIX-style file system, and is used to <strong>store a file’s metadata</strong> such as block location, owner, time of last change, etc.</p>
<p>In Linux Operaing System, <strong>Two files can have same inode number</strong>: In linux kernel Inode numbers are <strong>filesystem-specific</strong> and are created to index files locally. There is no mechanism for filesystems to coordinate across partitions and devices and future-connected devices to decide unique inode numbers. A file is identified by first identifying the device and an inode within the device. therefore two files on different devices or partitions can have same inode number. <strong>Hardlink is a good example.</strong></p>
<h3 id="Scheduling"><a href="#Scheduling" class="headerlink" title="Scheduling"></a>Scheduling</h3><p>The scheduler is an operating system module that <strong>selects the next jobs</strong> to be admitted into the system and the next process to run. </p>
<ul>
<li><strong>Long-term scheduling</strong>: decides which jobs or processes are to be admitted (from the secondary memory) to the ready queue (in main memory).</li>
<li><strong>Medium-term scheduling</strong>: The medium-term scheduler temporarily removes processes from main memory and places them in secondary memory.</li>
<li><strong>Short-term scheduling</strong>: decides which of the ready, in-memory processes is to be executed (allocated a CPU) after a clock interrupt, an I/O interrupt, an operating system call or another form of signal.</li>
</ul>
<h3 id="Example-of-fork-system-call"><a href="#Example-of-fork-system-call" class="headerlink" title="Example of fork() system call"></a>Example of <code>fork()</code> system call</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// From Advanced Programming in the Unix Environment Figure 8.1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">int</span> glob = <span class="number">6</span>; </div><div class="line"><span class="keyword">int</span></div><div class="line">main(<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> var; </div><div class="line">    <span class="keyword">pid_t</span> pid; </div><div class="line">    var = <span class="number">88</span>;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"before fork\n"</span>); </div><div class="line">    <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>) &#123;</div><div class="line">        err_sys(<span class="string">"fork error"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">        glob++; </div><div class="line">        var++;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        sleep(<span class="number">2</span>); </div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"pid = %d, glob = %d, var = %d\n"</span>, getpid(), glob, var);</div><div class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The <code>fork()</code> system call is <strong>called once and returns twice</strong>. In child process, when we modify the local and global variables which are located in stack and heap respectively of the child process, only the child process will be affected with output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">before fork</div><div class="line">pid = 9894, glob = 7, var = 89 // child output</div><div class="line">pid = 9893, glob = 6, var = 88 // parent output after 2 seconds</div></pre></td></tr></table></figure>
<p><img src="3_10_C_fork.jpg" alt=""></p>
<p><img src="3_10_ProcessCreation.jpg" alt=""></p>
<h3 id="Zombie-Processes-amp-Prevention"><a href="#Zombie-Processes-amp-Prevention" class="headerlink" title="Zombie Processes &amp; Prevention"></a>Zombie Processes &amp; Prevention</h3><p>When a process is created in UNIX using <code>fork()</code> system call, the address space of the Parent process is replicated. If the parent process calls <code>wait()</code> system call, then the execution of parent is suspended until the child is terminated. <strong>At the termination of the child, a ‘SIGCHLD’ signal is generated which is delivered to the parent by the kernel</strong>. Parent, on receipt of ‘SIGCHLD’ reaps the status of the child from the process table. Even though, the child is terminated, there is an entry in the process table corresponding to the child where the status is stored. When parent collects the status, this entry is deleted. Thus, all the traces of the child process are removed from the system. If the parent decides not to wait for the child’s termination and it executes its subsequent task, then at the termination of the child, the exit status is not read. Hence, there remains an entry in the process table even after the termination of the child. This state of the child process is known as the Zombie state.</p>
<p>Different ways in which creation of Zombie can be prevented:-</p>
<ul>
<li><strong>Using <code>wait()</code> system call</strong> : When the parent process calls wait(), after the creation of child, it indicates that, it will wait for the child to complete and it will reap the exit status of the child. The parent process is suspended(waits in a waiting queue) until the child is terminated. It must be understood that during this period, the parent process does nothing just waits.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// A C program to demonstrate working of</span></div><div class="line"><span class="comment">// fork()/wait() and Zombie processes</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">int</span> pid = fork();</div><div class="line">    <span class="keyword">if</span> (pid==<span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">20</span>; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"I am Child\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        wait(<span class="literal">NULL</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"I am Parent\n"</span>);</div><div class="line">        <span class="keyword">while</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>By ignoring the <code>SIGCHLD</code> signal</strong> : When a child is terminated, a corresponding SIGCHLD signal is delivered to the parent, if we call the ‘signal(SIGCHLD,SIG_IGN)’, then the SIGCHLD signal is ignored by the system, and the child process entry is deleted from the process table. Thus, no zombie is created. However, in this case, the parent cannot know about the exit status of the child.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// A C program to demonstrate ignoring </span></div><div class="line"><span class="comment">// SIGCHLD signal to prevent Zombie processes</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">int</span> pid = fork();</div><div class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</div><div class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">20</span>; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"I am Child\n"</span>);</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        signal(SIGCHLD, SIG_IGN);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"I am Parent\n"</span>);</div><div class="line">        <span class="keyword">while</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>By using a signal handler</strong> : The parent process installs a signal handler for the <code>SIGCHLD</code> signal. The signal handler calls <code>wait()</code> system call within it. In this senario, when the child terminated, the SIGCHLD is delivered to the parent.On receipt of SIGCHLD, the corresponding handler is activated, which in turn calls the <code>wait()</code> system call. Hence, the parent collects the exit status almost immediately and the child entry in the process table is cleared. Thus no zombie is created.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// A C program to demonstrate handling of</span></div><div class="line"><span class="comment">// SIGCHLD signal to prevent Zombie processes.</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> signum)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    wait(<span class="literal">NULL</span>);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">int</span> pid = fork();</div><div class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</div><div class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">20</span>; i++)</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"I am Child\n"</span>);</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        signal(SIGCHLD, func);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"I am Parent\n"</span>);</div><div class="line">        <span class="keyword">while</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Elaborate-what-happens-under-the-hood-after-typing-ls"><a href="#Elaborate-what-happens-under-the-hood-after-typing-ls" class="headerlink" title="Elaborate what happens under the hood after typing ls?"></a>Elaborate what happens under the hood after typing <code>ls</code>?</h3><p>First of all, whenever we press a key on keyboard, the keyboard controller will <strong>emit an interrupt signal to processor(CPU)</strong> indicating there is an event that needs immediate attention. As <strong>interrupts usually have high priority</strong>, the processor will suspending its current execution, save its state, and call an interrupt handler(should be the one that handles keyboard interrupt). Suppose <strong>we type ‘l’ then this character will be written the file that fd stdout points to</strong>, while shell’s stdout usually points to screen (a device, in *nix familiy, everything “looks” like a file), then “l” will be shown on the screen. After the interrupt handler finishes its job, the process will resume its original work.</p>
<p>We type ‘ls’ and hit enter, then shell will first <strong>check out $PATH environment variable</strong> to see if there is a program ‘ls’ under each given path. Suppose we find <code>/usr/bin/ls</code>. Shell will <strong>call <code>fork()</code></strong>, followed by <code>execve(&quot;/usr/bin/ls&quot;)</code>. <code>fork()</code> will create an identical child process and return twice. In parent(shell), it will typically call <code>wait()</code> to wait child process to complete. In child, it will execute <code>execve()</code> and a successful <code>execve()</code> will replace original data(including text, data, heap and stack, etc) in the child process’s address space with new data in order to run the new executable. Note that file descriptors opened by parent will be kept(that is why output from ls will be displayed on screen like shell).</p>
<p>Then the child process will be one that runs <code>/usr/bin/ls</code> code, it will make system calls(<code>open(2), printf(3c)</code> etc.) to list directory entries in the current working directory. After the child process finishes its job, it will call <code>exit()</code>(usually called implicitly by ‘return’ in <code>main()</code>). Then all of the fds, streams will be closed. The parent process(in this case the shell) will be notified of child’s termination, so <code>wait()</code> will be return and <strong>child exit code could be read from <code>wait()</code></strong>. Then parent process(the shell) can proceed, waiting for next command to run.</p>
<p>What will happen if another interrupt is received while the processor is running interrupt handler code?</p>
<p>A: Different OS may have different ways to deal with this situation. For linux, task of an interrupt handler is split into two halves, top half and bottom half. Top half runs with interrupts disabled and respond to the interrupt as fast as possible, then bottom half runs with interrupts enabled for as long as it needs and could be preempted.</p>
<p>How does shell implement I/O redirection if we want to redirect output of <code>ls</code> to another command as its input? like <code>ls | sort</code>:</p>
<p>A: Briefly speaking, shell will call a <code>pipe()</code> before <code>fork()</code> to <strong>get two fds</strong>, <code>rfd</code> for read end and <code>wfd</code> for write end, then call <strong>dup2(wfd, 1)</strong> in <code>ls</code> and <strong>dup2(rfd, 0)</strong> in <code>sort</code>.</p>
<p>There are <strong>two types of interrupts</strong>: <strong>hardware interrupt</strong>(which caused by external device, like keyboard, mouse, disk, etc) and <strong>software interrupt</strong>(which caused by program, like system call, divide-by-zero)</p>
<h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>If a 进程 wishes to access another process’ resources, inter-process communications have to be used. These include <strong>管道, 文件, socks, and other forms</strong>.</p>
<h3 id="上下文切换-如何测量时间？-Cracking-The-Coding-Interview"><a href="#上下文切换-如何测量时间？-Cracking-The-Coding-Interview" class="headerlink" title="上下文切换: 如何测量时间？ - Cracking The Coding Interview"></a>上下文切换: 如何测量时间？ - Cracking The Coding Interview</h3><p>A context switch is the time spent switching between two processes. This happens in multitasking. The operating system must bring the state information of waiting processes into memory and save the state information of the currently running process.</p>
<p><strong>怎么知道发生了上下文切换</strong>: 我们不知道。</p>
<p>Another issue is that swapping is governed by the scheduling algorithm of the operating system and there may be many kernel level threads which are also doing context switches</p>
<p>In order to overcome these obstacles, <strong>构建环境</strong> such that after P1 executes, <strong>任务调度器立马选择 P2 去运行</strong>. This may be accomplished by constructing a data channel, such as <strong>管道</strong>, between P1 and P2 and having the two processes play a game of ping-pong with a data token.</p>
<p>That is, let’s allow P1 to be the initial sender and P2 to be the receiver. Initially, P2 is blocked (sleeping) as it awaits the data token. When P1 executes, it delivers the token over the data channel to P2 and immediately attempts to read a response token. However, since P2 has not yet had a chance to run, no such token is available for P1 and the process is blocked.This relinquishes the CPU.</p>
<p>A context switch results and the task scheduler must select another process to run. Since P2 is now in a ready-to-run state, it is a desirable candidate to be selected by the task scheduler for execution. When P2 runs, the roles of P1 and P2 are swapped. P2 is now acting as the sender and P1 as the blocked receiver. The game ends when P2 returns the token to P1.</p>
<ul>
<li>进程2 正在等待来自进程1 的数据</li>
<li>进程1 记录开始时间</li>
<li>进程1 发送 Token 给进程2</li>
<li>进程1 尝试从 进程2 读取响应，这会触发一个<strong>上下文切换</strong></li>
<li>进程2 被调度然后收到 Token</li>
<li>进程2 发送一个 Token 响应给进程1</li>
<li>进程2 尝试读取来自 进程1 的 Token 响应，这会触发一个<strong>上下文切换</strong></li>
<li>进程1 被调度然后收到了 Token</li>
<li>进程1 记录结束时间</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">T = 2 * (Time of deliver + Time of context switch + Time of receive)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">P1 ---token---&gt; CPU Context Switch ---token---&gt; P2</div><div class="line">P2 ---response---&gt; CPU Context Switch ---response ---&gt; P1</div></pre></td></tr></table></figure>
<p>P1 will be able to easily compute <code>T</code>, since this is just the time between events 3 and 8. So, to solve for Tc’ we must first determine the value of Td + Tr·</p>
<p>How can we do this? We can do this by measuring the length of time it takes P1 to send and receive a token to itself. This will not induce a context switch <strong>因为 P1 发送的时候已经运行在 CPU 上了，并不会阻塞它</strong>.</p>
<p>The game is played a number of iterations to average out any variability in the elapsed time between steps 2 and 9 that may result from unexpected kernel interrupts and additional kernel threads contendingfor the CPU. We select the smallest observed context switch time as our final answer.</p>
<p>However, all we can ultimately say that this is an approximation which depends on the underlying system. For example, <strong>我们假设一旦数据准备好，P2立马被调度运行</strong>. However, this is dependent on the implementation of the task scheduler and we cannot make any guarantees.</p>
<p>That’s okay; it’s important in an interview to recognize when your solution might not be perfect</p>
<h3 id="哲学家进餐问题，如何防止死锁-Cracking-The-Coding-Interview"><a href="#哲学家进餐问题，如何防止死锁-Cracking-The-Coding-Interview" class="headerlink" title="哲学家进餐问题，如何防止死锁 - Cracking The Coding Interview"></a>哲学家进餐问题，如何防止死锁 - Cracking The Coding Interview</h3><p><strong>(1) 要么成要么不成</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chopstick</span> </span>&#123;</div><div class="line">    <span class="comment">/* same as before */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">pickUp</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> lock.tryLock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (pickUp()) &#123;</div><div class="line">            chew();</div><div class="line">            putDown();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">pickUp</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!left.pickUp()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!right.pickUp()) &#123;</div><div class="line">            left.putDown();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>(2) 优先级筷子</strong>:</p>
<p>为每一根筷子赋予一个数字 <code>0 ~ N-1</code>，每一位哲学家都得<strong>优先获取数字较小的那根筷子</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Chopstick lower, higher;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(Chopstick left, Chopstick right)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (left.getNumber() &lt; right.getNumber()) &#123;</div><div class="line">            <span class="keyword">this</span>.lower = left;</div><div class="line">            <span class="keyword">this</span>.higher = right;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.lower = right;</div><div class="line">            <span class="keyword">this</span>.higher = left;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</div><div class="line">        pickup();</div><div class="line">        chew();</div><div class="line">        putDown();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pickUp</span><span class="params">()</span> </span>&#123;</div><div class="line">        lower.pickup();</div><div class="line">        higher.pickup();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putDown</span><span class="params">()</span> </span>&#123;</div><div class="line">        higher.putDown();</div><div class="line">        lower.putDown();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="保证不会出现死锁的时候才提供的锁-Cracking-The-Coding-Interview"><a href="#保证不会出现死锁的时候才提供的锁-Cracking-The-Coding-Interview" class="headerlink" title="保证不会出现死锁的时候才提供的锁 - Cracking The Coding Interview"></a>保证不会出现死锁的时候才提供的锁 - Cracking The Coding Interview</h3><p>There are several common ways to prevent deadlocks. One of the popular ways is to require a process to declare upfront what locks it will need. We can then verify if a deadlock would be created by issuing these locks, and we can fail if so.</p>
<h3 id="保证三个线程顺序执行-Cracking-The-Coding-Interview"><a href="#保证三个线程顺序执行-Cracking-The-Coding-Interview" class="headerlink" title="保证三个线程顺序执行 - Cracking The Coding Interview"></a>保证三个线程顺序执行 - Cracking The Coding Interview</h3><p>A lock in Java is owned by <strong>相同的线程</strong> which locked it.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> Semaphore seml, sem2;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Foo</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            sem1 = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</div><div class="line">            sem2 = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</div><div class="line">            <span class="comment">// ...</span></div><div class="line">            sem1.acquire();</div><div class="line">            sem2.acquire();</div><div class="line">        &#125; <span class="keyword">catch</span> (...) &#123; ... &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">first</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">            sem1.release();</div><div class="line">        &#125; <span class="keyword">catch</span> (...) &#123; ... &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">second</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            sem1.acquire();</div><div class="line">            sem1.release();</div><div class="line">            <span class="comment">// ...</span></div><div class="line">            sem2.release();</div><div class="line">        &#125; <span class="keyword">catch</span> (...) &#123; ... &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">third</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            sem2.acquire();</div><div class="line">            sem2.release();</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (...) &#123; ... &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="文件系统格式"><a href="#文件系统格式" class="headerlink" title="文件系统格式"></a>文件系统格式</h3><ul>
<li><code>FAT32</code> 支持的最大文件大小: <code>FAT32</code> was implemented on 32-bit hardware for a 32-bit operating system with a 32-bit compiler, so it’s an obvious choice and anything beyond 32 bits would have cost precious processor cycles, disk space and programming time. (In those days, we thought <strong>4GB</strong> was pretty large for an HD, let alone for a single file.) </li>
</ul>
<p><a href="https://www2.cs.uic.edu/~jbell/CourseNotes/OperatingSystems/" target="_blank" rel="external">特别好的操作系统课程</a></p>
<h3 id="进程被分为几部分"><a href="#进程被分为几部分" class="headerlink" title="进程被分为几部分"></a>进程被分为几部分</h3><ul>
<li>Process memory is divided into <strong>四部分</strong> as shown in Figure 3.1 below:<ul>
<li>The <strong>text section</strong> comprises the compiled program code <strong>编译后的程序</strong>, read in from non-volatile storage when the program is launched.</li>
<li>The <strong>data section</strong> stores global and static variables <strong>全局、静态变量</strong>, allocated and initialized prior to executing main.</li>
<li>The heap is used for <strong>dynamic memory allocation 动态内存分配</strong>, and is managed via calls to new, delete, malloc, free, etc.</li>
<li>The stack is used for <strong>local variables</strong>. Space on the stack is reserved for local variables when they are declared ( at function entrance or elsewhere, depending on the language ), and the space is freed up when the variables go out of scope. Note that the stack is also used for function return values, and the exact mechanisms of stack management may be language specific.</li>
<li>Note that the stack and the heap start at opposite ends of the process’s free space and grow towards each other. If they should ever meet, then either a stack overflow error will occur, or else a call to new or malloc will fail due to insufficient memory available.</li>
</ul>
</li>
</ul>
<p><img src="3_01_Process_Memory.jpg" alt=""></p>
<h3 id="进程结束"><a href="#进程结束" class="headerlink" title="进程结束"></a>进程结束</h3><p>child code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> exitCode;</div><div class="line"><span class="built_in">exit</span>( exitCode );  <span class="comment">// return exitCode; has the same effect when executed from main( )</span></div></pre></td></tr></table></figure>
<p>parent code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">pid_t</span> pid;</div><div class="line"><span class="keyword">int</span> status</div><div class="line">pid = wait( &amp;status ); </div><div class="line"><span class="comment">// pid indicates which child exited. exitCode in low-order bits of status</span></div><div class="line"><span class="comment">// macros can test the high-order bits of status for why it stopped</span></div></pre></td></tr></table></figure>
<p>Processes may also be terminated by the system for a variety of reasons, including:</p>
<ul>
<li>The inability of the system to deliver necessary system resources.</li>
<li>In response to a <code>KILL</code> command, or other un handled process interrupt.</li>
<li>A parent may kill its children if the task assigned to them is no longer needed.</li>
<li>If the parent exits, the system may or may not allow the child to continue <strong>没有父进程</strong>. ( On UNIX systems, orphaned processes are generally inherited by init, which then proceeds to kill them. The UNIX <strong><code>nohup</code></strong> command allows a child to <strong>继续执行</strong> after <strong>父进程已经退出</strong>. )</li>
</ul>
<h3 id="进程协调"><a href="#进程协调" class="headerlink" title="进程协调"></a>进程协调</h3><p>Communications models: </p>
<ul>
<li><strong>Message passing</strong></li>
<li><strong>Shared memory</strong></li>
</ul>
<p><img src="3_12_CommunicationsModels.jpg" alt=""></p>
<ul>
<li>Shared Memory is faster once it is set up, because no system calls are required and access occurs at normal memory speeds. However it is more complicated to set up, and doesn’t work as well across multiple computers. Shared memory is generally preferable when large amounts of information must be shared quickly on the same computer.</li>
<li>Message Passing requires system calls for every message transfer, and is therefore slower, but it is simpler to set up and works well across multiple computers. Message passing is generally preferable when the amount and/or frequency of data transfers is small, or when multiple computers are involved.</li>
</ul>
<h4 id="Shared-Memory-消费者-生产者"><a href="#Shared-Memory-消费者-生产者" class="headerlink" title="Shared Memory 消费者-生产者"></a>Shared Memory 消费者-生产者</h4><h3 id="以下哪种方式，在读取磁盘上多个顺序数据块时的效率最高？"><a href="#以下哪种方式，在读取磁盘上多个顺序数据块时的效率最高？" class="headerlink" title="以下哪种方式，在读取磁盘上多个顺序数据块时的效率最高？"></a>以下哪种方式，在读取磁盘上多个顺序数据块时的效率最高？</h3><ul>
<li>程序直接访问方式跟循环检测IO方式，应该是一个意思吧，是最古老的方式。CPU和IO串行，<strong>每读一个字节（或字）</strong>，CPU都需要不断检测状态寄存器的busy标志，当busy=1时，表示IO还没完成；当 <code>busy=0</code> 时，表示IO完成。此时读取一个字的过程才结束，接着读取下一个字。</li>
<li>中断控制方式：循环检测先进些，IO设备和CPU可以并行工作，<strong>只有在开始IO和结束IO时，才需要CPU。但每次只能读取一个字</strong>。</li>
<li>DMA方式：Direct Memory Access，直接存储器访问，比中断先进的地方是每次可以<strong>读取一个块</strong>，而不是一个字。</li>
<li><font color="red"><strong>通道方式</strong></font>：比DMA先进的地方是，每次<strong>可以处理多个块</strong>，而不只是一个块。</li>
</ul>
<h3 id="大端小端"><a href="#大端小端" class="headerlink" title="大端小端"></a>大端小端</h3><p><img src="Big-Endian.svg.png" alt=""><br><img src="280px-Little-Endian.svg.png" alt=""></p>
<h3 id="上下文切换-Context-Switching"><a href="#上下文切换-Context-Switching" class="headerlink" title="上下文切换 Context Switching"></a>上下文切换 Context Switching</h3><h4 id="1-什么是上下文切换"><a href="#1-什么是上下文切换" class="headerlink" title="1. 什么是上下文切换"></a>1. 什么是上下文切换</h4><p><img src="2017_11_26_13_09_58.png" alt=""></p>
<h4 id="2-什么触发了上下文切换"><a href="#2-什么触发了上下文切换" class="headerlink" title="2. 什么触发了上下文切换"></a>2. 什么触发了上下文切换</h4><p>情景一 (当一个进程由 <code>RUNNING</code> 进入 <code>BLOCKED</code> 状态的时候):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">char</span> str[<span class="number">10</span>];</div><div class="line">	<span class="comment">// 执行到这句话的时候，需要等待用户输入</span></div><div class="line">	<span class="comment">// 这个时候进程的状态 RUNNING -&gt; BLOCKED</span></div><div class="line">	<span class="comment">// 操作系统变回处罚 Context Switching</span></div><div class="line">	<span class="comment">// 将其它进程调度进来，让它拥有 CPU</span></div><div class="line">	scanf(<span class="string">"%s"</span>, str);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>情景二 (当一个进程结束的时候):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> a = <span class="number">4</span>;</div><div class="line">	printf(<span class="string">"%d\n"</span>, a);</div><div class="line">	<span class="comment">// RUNNING -&gt; ZOMBIE</span></div><div class="line">	exit(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>情景三 (RUNNING -&gt; READY):</p>
<p>An (hardware) interrupt occurs. 一个非常 popular interrupt 是 <code>Timer Interrupt</code>，周期性(10ms ~ 200ms)地发送 <code>interrupt</code> 给 CPU。</p>
<p><img src="2017_11_26_13_26_52.png" alt=""></p>
<p>对于每一个 <code>process</code>，the kernel store some metadata, essentially there are three metadata:</p>
<ul>
<li>pocess control block</li>
<li>the kernel stack</li>
<li>the page tables corresponding to that process</li>
</ul>
<p>当发生上下文切换的时候:</p>
<ul>
<li>entire context gets stored in the kernel stack, this context is stored in a structure known as the <strong><code>trap frame</code></strong>.</li>
<li>Context switches to the scheduler’s context.</li>
</ul>
<h4 id="3-Context-Switching-Overhead"><a href="#3-Context-Switching-Overhead" class="headerlink" title="3. Context Switching Overhead"></a>3. Context Switching Overhead</h4><p><img src="2017_11_26_14_03_38.png" alt=""> </p>
<h3 id="Memory-page-size-页大小"><a href="#Memory-page-size-页大小" class="headerlink" title="Memory page size 页大小"></a>Memory page size 页大小</h3><p>A <strong>page, memory page, or virtual page</strong> is a <strong>fixed-length (固定长度的)</strong> contiguous block of <strong>virtual memory (虚拟内存)</strong>, described by a single entry in the <strong>page table</strong>. It is the <strong>smallest unit (最小单位)</strong> of data for memory management in a virtual memory operating system. Similarly, a <strong>page frame (页帧)</strong> is the smallest fixed-length contiguous block of <strong>physical memory (物理内存)</strong> into which memory pages are mapped by the operating system.</p>
<p>Linux 检测页大小:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;unistd.h&gt; /* sysconf(3) */</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    <span class="comment">// The page size for this system is 4096 bytes.</span></div><div class="line">	printf(<span class="string">"The page size for this system is %ld bytes.\n"</span>,</div><div class="line">	       sysconf(_SC_PAGESIZE)); <span class="comment">/* _SC_PAGE_SIZE is OK too. */</span></div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In many Unix systems, the command line utility <code>getconf</code> can be used. For example, <strong><code>getconf PAGESIZE</code></strong> will return the page size in bytes.</p>
<p>目前基本上大多数电脑都是 4KB 页大小。</p>
<hr>
<p><a href="https://www.ibm.com/developerworks/cn/linux/l-cache/index.html" target="_blank" rel="external">参考</a>在 <code>Linux</code> 的实现中，文件 <code>Cache</code> 分为两个层面，一是 <code>Page Cache</code>，另一个 <code>Buffer Cache</code>，每一个 <code>Page Cache</code> 包含若干 <code>Buffer Cache</code>。Page Cache、Buffer Cache、文件以及磁盘之间的关系如图所示:</p>
<p><img src="file_page_buffer_disk_relationship.jpg" alt="file_page_buffer_block_disk"></p>
<p>Linux内核中<strong>文件预读算法</strong>的具体过程是这样的：对于每个文件的第一个读请求，<strong>系统读入所请求的页面并读入紧随其后的少数几个页面(不少于一个页面，通常是三个页面)</strong>，这时的预读称为<strong>同步预读</strong>。对于第二次读请求，如果所读页面不在Cache中，即不在前次预读的group中，则表明文件访问不是顺序访问，系统继续采用同步预读；如果所读页面在Cache中，则表明前次预读命中，操作系统把预读group扩大一倍，并让底层文件系统读入group中剩下尚不在Cache中的文件数据块，这时的预读称为异步预读。无论第二次读请求是否命中，系统都要更新当前预读group的大小。此外，系统中定义了一个window，它包括前一次预读的group和本次预读的group。任何接下来的读请求都会处于两种情况之一：第一种情况是所请求的页面处于预读window中，这时继续进行异步预读并更新相应的window和group；第二种情况是所请求的页面处于预读window之外，这时系统就要进行同步预读并重置相应的window和group。图5是Linux内核预读机制的一个示意图，其中a是某次读操作之前的情况，b是读操作所请求页面不在window中的情况，而c是读操作所请求页面在window中的情况。</p>
<p><code>Linux</code>内核中与文件<code>Cache</code>操作相关的<code>API</code>有很多，按其使用方式可以分成两类：一类是以<strong>拷贝</strong>方式操作的相关接口， 如<code>read</code>/<code>write</code>/<code>sendfile</code>等，其中<code>sendfile</code>在2.6系列的内核中已经不再支持；另一类是以<strong>地址映射</strong>方式操作的相关接口，如<code>mmap</code>等。</p>
<p>第一种类型的<code>API</code>在不同文件的<code>Cache</code>之间或者<code>Cache</code>与应用程序所提供的用户空间<code>buffer</code>之间拷贝数据，其实现原理如图所示:</p>
<p><img src="read_write_sendfile.gif" alt="read_write_sendfile"></p>
<p>第二种类型的<code>API</code>将<code>Cache</code>项<strong>映射</strong>到用户空间，使得应用程序可以像使用内存指针一样访问文件，<code>Memory map</code>访问<code>Cache</code>的方式在内核中是采用<strong>请求页面机制</strong>实现的，其工作过程如图所示:</p>
<p><img src="memory_map.gif" alt="memory_map"></p>
<p>首先，应用程序调用<code>mmap</code>（图中1），陷入到内核中后调用<code>do_mmap_pgoff</code>（图中2）。该函数从应用程序的地址空间中分配一段区域作为映射的内存地址，并使用一个<code>VMA</code>（<code>vm_area_struct</code>）结构代表该区域，之后就返回到应用程序（图中3）。当应用程序访问<code>mmap</code>所返回的地址指针时（图中4），由于虚实映射尚未建立，会触发<strong>缺页中断</strong>（图中5）。之后系统会调用<strong>缺页中断处理函数</strong>（图中6），在缺页中断处理函数中，内核通过相应区域的<code>VMA</code>结构判断出该区域属于文件映射，于是调用具体文件系统的接口读入相应的<code>Page Cache</code>项（图中7、8、9），并填写相应的虚实映射表。经过这些步骤之后，应用程序就可以正常访问相应的内存区域了。</p>
<hr>
<p><a href="http://hackershell.cn/?p=956" target="_blank" rel="external">参考</a> 在<code>Linux</code>下，<code>Page Cache</code>可以<strong>加速访问磁盘上的文件</strong>，这是因为，当它第一次读或写数据到类似硬盘一样的存储介质时，<code>Linux</code>会存储这些数据到闲置的内存区域，它充当于一个<strong>缓存</strong>的角色，如果以后读取数据，他就可以迅速的在缓存中读取:</p>
<p>在<code>Linux</code>下，有多少内存被<code>Page Cache</code>使用，可以用<code>free -m</code>查看<code>Cached</code>那一列，例如：</p>
<p><img src="2017_12_28_15_07_59.png" alt="page_cache_linux_memory"></p>
<p><strong>数据写入</strong></p>
<p>如果数据被写入，他<strong>首先会写到<code>Page Cache</code></strong>，并把其作为一个<strong>脏页</strong>(dirty page)进行管理，“dirty”意味着数据存储在<code>Page Cache</code>中，但<strong>需要</strong>先写入到底层的存储设备，这些脏页的内容会被周期性的转移（系统调用<code>sync</code>或<code>fsync</code>）到底层的存储设备上。</p>
<p>下面的例子将会展示创建<code>10M</code>的文件，它首先将会写入到<code>Page Cache</code>中，相应的<strong>脏页</strong>将会增加，直到他把数据写到磁盘上，在这种情况下我们将会使用<code>sync</code>命令</p>
<p><img src="2017_12_28_15_12_26.png" alt="dirty_page_linux_sync"></p>
<p><strong>数据读取</strong></p>
<p>文件的写入操作不仅仅只有写入，也有读的操作，例如，当你读取同一个<code>40M</code>的文件两次，<strong>第二次读取将会变快</strong>，因为文件的<code>block</code>直接来自<code>Page Cache</code>的内存而不会去读取磁盘。</p>
<hr>
<p><a href="http://www.linuxprobe.com/linux-read-write-tuning.html" target="_blank" rel="external">参考</a></p>
<p><strong>读文件</strong>:</p>
<ol>
<li>用户发起<code>read</code>操作</li>
<li>操作系统查找页缓存<br>a. 若未命中，则产生<strong>缺页异常</strong>，然后创建页缓存，并<strong>从磁盘读取相应页填充页缓存</strong><br>b. 若命中，则直接从页缓存返回要读取的内容</li>
<li>用户<code>read</code>调用完成</li>
</ol>
<p><strong>写文件</strong>:</p>
<ol>
<li>用户发起<code>write</code>操作</li>
<li>操作系统查找页缓存<br>a. 若未命中，则产生缺页异常，然后创建页缓存，将用户传入的内容写入页缓存<br>b. 若命中，则直接将用户传入的内容写入页缓存</li>
<li>用户<code>write</code>调用完成</li>
<li>页被修改后成为<strong>脏页</strong>，操作系统有两种机制将脏页写回磁盘</li>
<li>用户手动调用<code>fsync()</code></li>
<li>由<code>pdflush</code>进程定时将脏页写回磁盘</li>
</ol>
<p><code>mmap</code>除了可以减少<code>read</code>,<code>write</code>等系统调用以外，还可以<strong>减少内存的拷贝次数</strong>，比如在<code>read</code>调用时，一个完整的流程是<font color="red"><strong>操作系统读磁盘文件到页缓存，再从页缓存将数据拷贝到<code>read</code>传递的<code>buffer</code></strong></font>里，而如果使用<code>mmap</code>之后，操作系统<font color="red"><strong>只需要将磁盘读到页缓存</strong></font>，然后用户就可以直接通过指针的方式操作<code>mmap</code>映射的内存，<strong>减少了从内核态到用户态的数据拷贝</strong>。</p>
<p><code>mmap</code>适合于<strong>对同一块区域频繁读写</strong>的情况，比如一个<code>64M</code>的文件存储了一些索引信息，我们需要频繁修改并持久化到磁盘，这样可以将文件通过<code>mmap</code>映射到用户虚拟内存，然后通过指针的方式修改内存区域，由操作系统自动将修改的部分刷回磁盘，也可以自己调用<code>fsync</code>手动刷磁盘。</p>
<p><img src="wKioL1fhTeyxJpMqAAA7whzZS-Q963.jpg" alt="mmap"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/28/OperatingSystem/" data-id="cjc5qrsw0000t5cemorq7fnb9" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Spring二" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/28/Spring二/" class="article-date">
  <time datetime="2017-06-28T01:52:16.000Z" itemprop="datePublished">2017-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/28/Spring二/">Spring (二) - 默认标签的解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Spring-二-默认标签的解析"><a href="#Spring-二-默认标签的解析" class="headerlink" title="Spring (二) - 默认标签的解析"></a>Spring (二) - 默认标签的解析</h2><h3 id="1-默认标签的解析"><a href="#1-默认标签的解析" class="headerlink" title="1. 默认标签的解析"></a>1. 默认标签的解析</h3><p><code>parseDefaultElement</code> 对 4 种不同的标签 <code>import</code>、<code>alias</code>、<code>bean</code>、<code>beans</code> 做了不同的处理:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</div><div class="line">        importBeanDefinitionResource(ele);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</div><div class="line">        processAliasRegistration(ele);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</div><div class="line">        processBeanDefinition(ele, delegate);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</div><div class="line">        <span class="comment">// recurse</span></div><div class="line">        doRegisterBeanDefinitions(ele);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-解析-bean-标签并注册"><a href="#2-解析-bean-标签并注册" class="headerlink" title="2. 解析 bean 标签并注册"></a>2. 解析 bean 标签并注册</h3><p><code>processBeanDefinition</code> 方法调用的时序图:</p>
<p><img src="processBeanDefinition.svg" alt=""></p>
<h4 id="2-1-解析-bean"><a href="#2-1-解析-bean" class="headerlink" title="2.1 解析 bean:"></a>2.1 解析 <code>bean</code>:</h4><p>解析 <code>id</code> 和 <code>name</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BeanDefinitionParserDelegate.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele, BeanDefinition containingBean)</span> </span>&#123;</div><div class="line">    String id = ele.getAttribute(ID_ATTRIBUTE);</div><div class="line">    String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>进一步解析其他属性并统一封装至 <code>GenericBeanDefinition</code> 中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BeanDefinitionParserDelegate.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> AbstractBeanDefinition <span class="title">createBeanDefinition</span><span class="params">(String className, String parentName)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">    <span class="keyword">return</span> BeanDefinitionReaderUtils</div><div class="line">        .createBeanDefinition(parentName,</div><div class="line">                              className,</div><div class="line">                              <span class="keyword">this</span>.readerContext.getBeanClassLoader());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// BeanDefinitionReaderUtils.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> AbstractBeanDefinition</div><div class="line">    createBeanDefinition(String parentName,</div><div class="line">                         String className,</div><div class="line">                         ClassLoader classLoader)</div><div class="line">    <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line"></div><div class="line">    GenericBeanDefinition bd = <span class="keyword">new</span> GenericBeanDefinition();</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">return</span> bd;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>BeanDefinition</code> 是 <code>&lt;bean&gt;</code> 在容器中的内部表示形式，<code>BeanDefinition</code> 和 <code>&lt;bean&gt;</code> 是一一对应的。<code>BeanDefinition</code> 会被注册到 <code>BeanDefinitionRegistry</code> 中，<code>BeanDefinitionRegistry</code> 就像 <code>Spring</code> 配置信息的内存数据库。</p>
<p><img src="AbstractBeanDefinition.svg" alt=""></p>
<p>如果 <code>bean</code> 没有指定名字，那么使用默认规则生成 <code>beanName</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BeanDefinitionParserDelegate.java</span></div><div class="line">beanName = BeanDefinitionReaderUtils</div><div class="line">    .generateBeanName(beanDefinition, <span class="keyword">this</span>.readerContext.getRegistry(), <span class="keyword">true</span>);</div></pre></td></tr></table></figure>
<p>将获取到的信息封装到 <code>BeanDefinitionHolder</code> 实例中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BeanDefinitionParserDelegate.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele, BeanDefinition containingBean)</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName, aliasesArray);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-注册解析的-BeanDefinition"><a href="#2-2-注册解析的-BeanDefinition" class="headerlink" title="2.2 注册解析的 BeanDefinition:"></a>2.2 注册解析的 <code>BeanDefinition</code>:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BeanDefinitionReaderUtils.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(BeanDefinitionHolder definitionHolder,</span></span></div><div class="line"><span class="function"><span class="params">                                          BeanDefinitionRegistry registry)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Register bean definition under primary name.</span></div><div class="line">    String beanName = definitionHolder.getBeanName();</div><div class="line">    registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</div><div class="line"></div><div class="line">    <span class="comment">// Register aliases for bean name, if any.</span></div><div class="line">    String[] aliases = definitionHolder.getAliases();</div><div class="line">    <span class="keyword">if</span> (aliases != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (String alias : aliases) &#123;</div><div class="line">            registry.registerAlias(beanName, alias);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="BeanDefinitionRegistry.svg" alt=""></p>
<p><code>BeanDefinitionRegistry</code> 是用户代码自己提供的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">BeanDefinitionRegistry beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</div><div class="line">XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</div></pre></td></tr></table></figure>
<p>因此我们分析 <code>DefaultListableBeanFactory</code> 中的 <code>registerBeanDefinition</code> 方法即可:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultListableBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="comment">/** Map of bean definition objects, keyed by bean name */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</div><div class="line">        ((AbstractBeanDefinition) beanDefinition).validate();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    oldBeanDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</div><div class="line">    <span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</div><div class="line">            <span class="comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span></div><div class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</div><div class="line">                <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而沿着类的继承链会发现 <code>registerAlias</code> 的方法是在 <code>SimpleAliasRegistry</code> 中实现的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Map from alias to canonical name */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; aliasMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String name, String alias)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (alias.equals(name)) &#123;</div><div class="line">        <span class="keyword">this</span>.aliasMap.remove(alias);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        String registeredName = <span class="keyword">this</span>.aliasMap.get(alias);</div><div class="line">        <span class="keyword">if</span> (registeredName != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (registeredName.equals(name)) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        checkForAliasCircle(name, alias);</div><div class="line">        <span class="keyword">this</span>.aliasMap.put(alias, name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>checkForAliasCircle</code> 用于检查 <code>alias</code> 循环依赖</strong>，当 <code>A -&gt; B</code> 存在时，若再次出现 <code>A -&gt; C -&gt; B</code> 则会抛出异常:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkForAliasCircle</span><span class="params">(String name, String alias)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (hasAlias(alias, name)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasAlias</span><span class="params">(String name, String alias)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : <span class="keyword">this</span>.aliasMap.entrySet()) &#123;</div><div class="line">        String registeredName = entry.getValue();</div><div class="line">        <span class="keyword">if</span> (registeredName.equals(name)) &#123;</div><div class="line">            String registeredAlias = entry.getKey();</div><div class="line">            <span class="keyword">return</span> (registeredAlias.equals(alias) || hasAlias(registeredAlias, alias));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-3-通知监听器解析及注册完成"><a href="#2-3-通知监听器解析及注册完成" class="headerlink" title="2.3 通知监听器解析及注册完成"></a>2.3 通知监听器解析及注册完成</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></div><div class="line">getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</div></pre></td></tr></table></figure>
<p>其中 <code>ReaderContext</code> 是在类 <code>XmlBeanDefinitionReader</code> 中调用 <code>createReaderContext</code> 生成的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// XmlBeanDefinitionReader.java</span></div><div class="line"><span class="keyword">private</span> ReaderEventListener eventListener = <span class="keyword">new</span> EmptyReaderEventListener();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> XmlReaderContext <span class="title">createReaderContext</span><span class="params">(Resource resource)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> XmlReaderContext(resource,</div><div class="line">                                <span class="keyword">this</span>.problemReporter,</div><div class="line">                                <span class="keyword">this</span>.eventListener,</div><div class="line">                                <span class="keyword">this</span>.sourceExtractor,</div><div class="line">                                <span class="keyword">this</span>,</div><div class="line">                                getNamespaceHandlerResolver());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ReaderContext</code> 调用的是 <code>EventListener</code> 的 <code>componentRegistered</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderContext</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReaderContext</span><span class="params">(Resource resource,</span></span></div><div class="line"><span class="function"><span class="params">                         ProblemReporter problemReporter,</span></span></div><div class="line"><span class="function"><span class="params">                         ReaderEventListener eventListener,</span></span></div><div class="line"><span class="function"><span class="params">                         SourceExtractor sourceExtractor)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.resource = resource;</div><div class="line">		<span class="keyword">this</span>.problemReporter = problemReporter;</div><div class="line">		<span class="keyword">this</span>.eventListener = eventListener;</div><div class="line">		<span class="keyword">this</span>.sourceExtractor = sourceExtractor;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireComponentRegistered</span><span class="params">(ComponentDefinition componentDefinition)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.eventListener.componentRegistered(componentDefinition);</div><div class="line">	&#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="EventListener.svg" alt=""></p>
<p>由此可见，这里的事件通知只为扩展，目前 <code>Spring</code> 没有对此事件做任何逻辑处理。</p>
<h3 id="3-解析-Alias-标签"><a href="#3-解析-Alias-标签" class="headerlink" title="3. 解析 Alias 标签:"></a>3. 解析 Alias 标签:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAliasRegistration</span><span class="params">(Element ele)</span> </span>&#123;</div><div class="line">    String name = ele.getAttribute(NAME_ATTRIBUTE);</div><div class="line">    String alias = ele.getAttribute(ALIAS_ATTRIBUTE);</div><div class="line">    getReaderContext().getRegistry().registerAlias(name, alias);</div><div class="line">    getReaderContext().fireAliasRegistered(name, alias, extractSource(ele));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-解析-import-标签"><a href="#4-解析-import-标签" class="headerlink" title="4. 解析 import 标签:"></a>4. 解析 import 标签:</h3><p>获取位于 <code>&lt;resource&gt;</code> 属性中所表示的路径，然后判断是相对路径还是绝对路径，最后重新进行这个路径上 <code>bean</code> 资源文件的读取与加载:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">importBeanDefinitionResource</span><span class="params">(Element ele)</span> </span>&#123;</div><div class="line">    String location = ele.getAttribute(RESOURCE_ATTRIBUTE);</div><div class="line"></div><div class="line">    <span class="comment">// Resolve system properties: e.g. "$&#123;user.dir&#125;"</span></div><div class="line">    location = getReaderContext().getEnvironment().resolveRequiredPlaceholders(location);</div><div class="line"></div><div class="line">    <span class="comment">// Discover whether the location is an absolute or relative URI</span></div><div class="line">    <span class="keyword">boolean</span> absoluteLocation = ResourcePatternUtils.isUrl(location) || ResourceUtils.toURI(location).isAbsolute();</div><div class="line"></div><div class="line">    <span class="comment">// Absolute or relative?</span></div><div class="line">    <span class="keyword">if</span> (absoluteLocation) &#123;</div><div class="line">        <span class="comment">// Another parse</span></div><div class="line">        getReaderContext().getReader().loadBeanDefinitions(location, actualResources);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Convert relative to absolute path</span></div><div class="line">        <span class="keyword">int</span> importCount;</div><div class="line">        Resource relativeResource = getReaderContext().getResource().createRelative(location);</div><div class="line">        <span class="keyword">if</span> (relativeResource.exists()) &#123;</div><div class="line">            importCount = getReaderContext().getReader().loadBeanDefinitions(relativeResource);</div><div class="line">         &#125;</div><div class="line">    &#125;</div><div class="line">    getReaderContext().fireImportProcessed(location, actResArray, extractSource(ele));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5-嵌入式-beans-标签的解析"><a href="#5-嵌入式-beans-标签的解析" class="headerlink" title="5. 嵌入式 beans 标签的解析"></a>5. 嵌入式 beans 标签的解析</h3><p>递归调用 <code>beans</code> 的解析过程</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/28/Spring二/" data-id="cjc5qrsxu001j5cemr6irc7wp" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Spring一" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/27/Spring一/" class="article-date">
  <time datetime="2017-06-27T13:56:57.000Z" itemprop="datePublished">2017-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/27/Spring一/">Spring (一) - XML 文件解析与 Bean 的注册</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Spring-一-XML-文件解析与-Bean-的注册"><a href="#Spring-一-XML-文件解析与-Bean-的注册" class="headerlink" title="Spring (一) - XML 文件解析与 Bean 的注册"></a>Spring (一) - XML 文件解析与 Bean 的注册</h2><h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BeanDefinitionRegistry beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</div><div class="line">XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</div><div class="line">reader.loadBeanDefinitions(<span class="keyword">new</span> ClassPathResource(<span class="string">"beans.xml"</span>));</div></pre></td></tr></table></figure>
<p><code>DefaultListableBeanFactory</code> 是 <code>Spring</code> 注册及加载 <code>bean</code> 的默认实现</p>
<h3 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h3><p>通过 <code>Resource</code> 接口来实现对 File、URL、Classpath 等资源的管理，<strong><code>Resource</code> 负责对配置文件进行读取，即将配置文件封装为 <code>Resource</code></strong>，然后交给 <code>XmlBeanDefinitionReader</code> 来处理。</p>
<p><img src="ClassPathResource.svg" alt=""></p>
<h3 id="XML-文件解析"><a href="#XML-文件解析" class="headerlink" title="XML 文件解析"></a>XML 文件解析</h3><p><img src="XmlBeanDefinitionReader.svg" alt=""></p>
<p><code>XmlBeanDefinitionReader</code> 是 <code>Spring</code> 资源文件读取、解析、注册的实现，重点关注这个类。</p>
<p><strong>1. 使用 <code>org.xml.sax</code> 解析 XML</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// XmlBeanDefinitionReader.java</span></div><div class="line">InputStream inputStream = encodedResource.getResource().getInputStream();</div><div class="line">InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</div><div class="line">doLoadBeanDefinitions(inputSource, encodedResource.getResource());</div></pre></td></tr></table></figure>
<p><strong>2. 获取对 <code>XML</code> 文件的验证模式</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// XmlBeanDefinitionReader.java</span></div><div class="line">getValidationModeForResource(resource)</div></pre></td></tr></table></figure>
<p>常见的 XML 文件验证模式有:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlValidationModeDetector</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * Indicates that DTD validation should be used (we found a "DOCTYPE" declaration).</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALIDATION_DTD = <span class="number">2</span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * Indicates that XSD validation should be used (found no "DOCTYPE" declaration).</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALIDATION_XSD = <span class="number">3</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>3. 加载 <code>XML</code> 并获得对应的 <code>org.w3c.dom.Document</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Document doc = doLoadDocument(inputSource, resource);</div></pre></td></tr></table></figure>
<p><img src="DocumentLoader.svg" alt=""></p>
<p>在 <code>loadDocument</code> 方法中涉及到一个参数 <code>EntityResolver</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function">Document <span class="title">loadDocument</span><span class="params">(InputSource inputSource,</span></span></div><div class="line"><span class="function"><span class="params">                      EntityResolver entityResolver,</span></span></div><div class="line"><span class="function"><span class="params">                      ErrorHandler errorHandler,</span></span></div><div class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> validationMode,</span></span></div><div class="line"><span class="function"><span class="params">                      <span class="keyword">boolean</span> namespaceAware)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure>
<p>何为 <code>EntityResolver</code> ? 官方解释: 如果 SAX 应用程序需要实现自定义处理外部实体，则必须实现此接口，并使用setEntityResolver方法向SAX 驱动器注册一个实例。也就是说，对于解析一个 xml，sax 首先会读取该 xml 文档上的声明，根据声明去寻找相应的 DTD 定义，以便对文档的进行验证，默认的寻找规则，(即:通过网络,实现上就是声明 DTD 的地址 URI 地址来下载 DTD 声明)，并进行认证，下载的过程是一个漫长的过程，而且当网络不可用时，这里会报错，就是因为相应的 dtd 没找到。</p>
<p><code>EntityResolver</code> 的作用是项目本身就可以提供一个如何寻找 DTD 声明的方法，即由程序来实现寻找 DTD 的过程，这样就避免了通过网络来寻找相应的声明。</p>
<p><img src="EntityResolver.svg" alt=""></p>
<p><code>EntityResolver</code> 接受两个参数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">InputSource <span class="title">resolveEntity</span> <span class="params">(String publicId, String systemId)</span></span></div></pre></td></tr></table></figure>
<p><strong>3.1 XSD</strong> 配置文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></div><div class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- bean definitions here --&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>解析到如下两个参数:</p>
<ul>
<li><code>publicId</code>: null</li>
<li><code>systemId</code>: <a href="http://www.springframework.org/schema/beans/spring-beans.xsd" target="_blank" rel="external">http://www.springframework.org/schema/beans/spring-beans.xsd</a></li>
</ul>
<p><strong>3.2 DTD</strong> 配置文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN 2.0//EN"</span></div><div class="line"><span class="meta">        "http://www.springframework.org/dtd/spring-beans-2.0.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- bean definitions here --&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>解析到如下两个参数:</p>
<ul>
<li><code>publicId</code>: -//SPRING//DTD BEAN 2.0//EN</li>
<li><code>systemId</code>: <a href="http://www.springframework.org/dtd/spring-beans-2.0.dtd" target="_blank" rel="external">http://www.springframework.org/dtd/spring-beans-2.0.dtd</a></li>
</ul>
<p><strong><code>Spring</code> 使用 <code>DelegatingEntityResolver</code> 来解析 <code>EntityResolver</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DelegatingEntityResolver.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> InputSource <span class="title">resolveEntity</span><span class="params">(String publicId, String systemId)</span> <span class="keyword">throws</span> SAXException, IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (systemId != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (systemId.endsWith(DTD_SUFFIX)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.dtdResolver.resolveEntity(publicId, systemId);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (systemId.endsWith(XSD_SUFFIX)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.schemaResolver.resolveEntity(publicId, systemId);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看到针对不同的模式，采用了不同的解析器，其中 <code>DTD</code> 采用的是 <code>BeansDtdResolver</code> 来解析的；<code>XSD</code> 采用的是 <code>PluggableSchemaResolver</code> 来解析的。</p>
<p><strong>4. 根据 <code>Document</code> 注册 <code>Bean</code> 信息</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// XmlBeanDefinitionReader.java</span></div><div class="line">BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</div><div class="line">documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</div></pre></td></tr></table></figure>
<p><img src="BeanDefinitionDocumentReader.svg" alt=""></p>
<p><strong>4.1 提取 root</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></div><div class="line">Element root = doc.getDocumentElement();</div><div class="line">doRegisterBeanDefinitions(root);</div></pre></td></tr></table></figure>
<p><strong>4.2 解析 <code>profile</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    </div><div class="line">    <span class="comment">// Empty Implementation</span></div><div class="line">    preProcessXml(root);</div><div class="line">    parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</div><div class="line">    <span class="comment">// Empty Implementation</span></div><div class="line">    postProcessXml(root);</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.delegate = parent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>处理 XML 采用了 <strong>模板方法模式</strong></p>
<p><strong>4.3 解析并注册 <code>BeanDefinition</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</div><div class="line">        NodeList nl = root.getChildNodes();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</div><div class="line">            Node node = nl.item(i);</div><div class="line">            <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</div><div class="line">                Element ele = (Element) node;</div><div class="line">                <span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</div><div class="line">                    parseDefaultElement(ele, delegate);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    delegate.parseCustomElement(ele);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        delegate.parseCustomElement(root);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码主要是针对不同的 <code>Bean</code> 命名空间采用不同的解析方式: <strong>默认或者自定义</strong>，判别命名空间是根据判断命名空间字符串是否一致来判断的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEANS_NAMESPACE_URI = <span class="string">"http://www.springframework.org/schema/beans"</span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDefaultNamespace</span><span class="params">(String namespaceUri)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (!StringUtils.hasLength(namespaceUri) || BEANS_NAMESPACE_URI.equals(namespaceUri));</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/27/Spring一/" data-id="cjc5qrsxa001d5cemgaisrldx" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Dubbo一" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/27/Dubbo一/" class="article-date">
  <time datetime="2017-06-27T07:31:54.000Z" itemprop="datePublished">2017-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/27/Dubbo一/">Dubbo一</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Dubbo-一-RPC"><a href="#Dubbo-一-RPC" class="headerlink" title="Dubbo (一) - RPC"></a>Dubbo (一) - RPC</h2><p><img src="invoker.svg" alt=""></p>
<h3 id="限流策略"><a href="#限流策略" class="headerlink" title="限流策略"></a>限流策略</h3><p><img src="TPSLimiter.svg" alt=""></p>
<p><code>DefaultTPSLimiter</code> 有一个 <code>Map</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, StatItem&gt; stats</div><div class="line">        = <span class="keyword">new</span> ConcurrentHashMap&lt;String, StatItem&gt;();</div></pre></td></tr></table></figure>
<p><code>Map</code> 中存储的是:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> rate = url.getParameter(Constants.TPS_LIMIT_RATE_KEY, -<span class="number">1</span>);</div><div class="line"><span class="keyword">long</span> interval = url.getParameter(Constants.TPS_LIMIT_INTERVAL_KEY,</div><div class="line">                                 Constants.DEFAULT_TPS_LIMIT_INTERVAL);</div><div class="line">String serviceKey = url.getServiceKey();</div><div class="line">stats.putIfAbsent(serviceKey, <span class="keyword">new</span> StatItem(serviceKey, rate, interval));</div></pre></td></tr></table></figure>
<p>限流两大决定点:</p>
<ul>
<li><strong>频率</strong></li>
<li><strong>间隔</strong></li>
</ul>
<p>位于类 <code>StatItem</code> 中限流的核心算法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAllowable</span><span class="params">(URL url, Invocation invocation)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">    <span class="comment">// reset rate to initial rate</span></div><div class="line">    <span class="keyword">if</span> (now &gt; lastResetTime + interval) &#123;</div><div class="line">        token.set(rate);</div><div class="line">        lastResetTime = now;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// rate--</span></div><div class="line">    <span class="keyword">int</span> value = token.get();</div><div class="line">    <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">while</span> (value &gt; <span class="number">0</span> &amp;&amp; !flag) &#123;</div><div class="line">        flag = token.compareAndSet(value, value - <span class="number">1</span>);</div><div class="line">        value = token.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> flag;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即<strong>在指定间隔内调用的次数不超过 <code>rate</code> 次</strong></p>
<h3 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h3><p><img src="Filter.svg" alt=""></p>
<h3 id="代理工厂"><a href="#代理工厂" class="headerlink" title="代理工厂"></a>代理工厂</h3><p><img src="ProxyFactory.svg" alt=""></p>
<h3 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h3><p><img src="Protocol.svg" alt=""></p>
<p>Dubbo 支持的远程调用协议:</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://blog.csdn.net/xlgen157387/article/details/51865289" target="_blank" rel="external">Dubbo详细介绍与安装使用过程</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/27/Dubbo一/" data-id="cjc5qrsuu00095cem9cqf68wj" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/blog/page/15/">&laquo; Prev</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/14/">14</a><a class="page-number" href="/blog/page/15/">15</a><span class="page-number current">16</span><a class="page-number" href="/blog/page/17/">17</a><a class="page-number" href="/blog/page/18/">18</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/23/">23</a><a class="extend next" rel="next" href="/blog/page/17/">Next&raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    

  
    
  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/01/06/where-the-time-actually-gone/">时间都去哪儿了</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/dev-reflection/">开发反思</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/my-microblog/">我的微博</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/gcc-basic/">gcc-basic</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/java-internal/">Java Internal</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>