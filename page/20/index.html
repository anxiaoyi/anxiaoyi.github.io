<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="赵坤的个人网站">
<meta property="og:type" content="website">
<meta property="og:title" content="代码人生">
<meta property="og:url" content="http://blog.kunzhao.org/page/20/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="赵坤的个人网站">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码人生">
<meta name="twitter:description" content="赵坤的个人网站">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-play-with-linux" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/05/22/play-with-linux/" class="article-date">
  <time datetime="2017-05-22T06:51:37.000Z" itemprop="datePublished">2017-05-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/05/22/play-with-linux/">Play With Linux</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Play-With-Linux"><a href="#Play-With-Linux" class="headerlink" title="Play With Linux"></a>Play With Linux</h2><h3 id="1-Terminal"><a href="#1-Terminal" class="headerlink" title="1 Terminal"></a>1 Terminal</h3><h4 id="1-1-Ubuntu-Could-not-get-lock"><a href="#1-1-Ubuntu-Could-not-get-lock" class="headerlink" title="1.1 Ubuntu Could not get lock"></a>1.1 Ubuntu Could not get lock</h4><p><img src="17-05-22-14_52_30_1224_154.png" alt=""></p>
<p>解决方案:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo rm /var/lib/apt/lists/lock</div><div class="line">sudo rm /var/cache/apt/archives/lock</div><div class="line">sudo rm /var/lib/dpkg/lock</div><div class="line">sudo apt clean</div><div class="line">sudo apt update</div></pre></td></tr></table></figure>
<p>(2) 另外一种常见的问题是在执行 <code>sudo apt update</code> 的时候遇见的 <strong>Hash Sum mismatch</strong> 问题:</p>
<p><img src="17-07-17-09_11_43_1299_195.png" alt=""></p>
<p>其大多数情况都是因为添加了其他 PPA 源导致的:</p>
<p><img src="17-07-17-09_16_59_903_443.png" alt=""></p>
<p>通用做法一般是<strong>去除掉这个 PPA 源</strong>，另外一种是<strong>手动从源代码编译来安装</strong>。</p>
<h4 id="GPG-error"><a href="#GPG-error" class="headerlink" title="GPG error"></a>GPG error</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E: GPG error:h ttp://cn.archive.ubuntu.com trusty InRelease: Clearsigned file isn&apos;t valid, got &apos;NODATA&apos; (does the network require authentication?)</div></pre></td></tr></table></figure>
<h4 id="软件更新源"><a href="#软件更新源" class="headerlink" title="软件更新源"></a>软件更新源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/apt/sources.list</div></pre></td></tr></table></figure>
<hr>
<p>在为 <code>deepin</code> 系统安装 <code>mysql-server</code> 的时候，执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install mysql-server</div></pre></td></tr></table></figure>
<p>卡在了 <code>connecting...</code> 界面，于是把 <code>Ubuntu</code> 的源覆盖了 <code>deepin</code> 的默认源，开始工作了，但是最后报 <code>broken package</code> 错误… 其原因就在于正确的解决方法应该是<strong>寻找适合 <code>deepin</code> 系统的源 (比如 清华大学, 163 等源), 而不是直接拷贝 <code>Ubuntu</code> 的源</strong>。</p>
<hr>
<p>在安装 <code>Python</code> 一些依赖的时候，遇见了一些典型问题:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cannot compile &apos;Python.h&apos; ...</div></pre></td></tr></table></figure>
<p>尝试安装按照网络上教程安装 <code>python-dev</code> 依赖的时候又提示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">The following packages have unmet dependencies:</div><div class="line"> python-dev : Depends: python2.7-dev (&gt;= 2.7.3) but it is not going to be installed</div><div class="line">E: Unable to correct problems, you have held broken packages.</div></pre></td></tr></table></figure>
<p>接着一顿乱试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get clean</div><div class="line">sudo apt-get autoclean</div><div class="line">sudo apt-get -f install</div><div class="line">...</div></pre></td></tr></table></figure>
<p>最终<strong>换了一个<a href="http://www.cnblogs.com/littlemonsters/p/5783690.html" target="_blank" rel="external">阿里源</a></strong>搞定了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">deb http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse</div></pre></td></tr></table></figure>
<blockquote>
<p>注: 上述问题发生在 <code>Ubuntu 14.04</code> 系统上</p>
</blockquote>
<p>换源，虽然能够修复一部分问题，但是也有可能出现如下情况，软件包不一致的问题:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql-server : </div><div class="line">    Depends: mysql-server-5.5 but it is not going to be installed</div></pre></td></tr></table></figure>
<p>再重新切换回原来的源就又好了</p>
<h4 id="1-2-解压缩"><a href="#1-2-解压缩" class="headerlink" title="1.2 解压缩"></a>1.2 解压缩</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unrar e 文件.rar 解压之后保存的路径</div></pre></td></tr></table></figure>
<h4 id="1-3-登录文件"><a href="#1-3-登录文件" class="headerlink" title="1.3 登录文件"></a>1.3 登录文件</h4><p>每次启动 <code>terminal</code> 都会执行一遍文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~/.bashrc</div></pre></td></tr></table></figure>
<h3 id="2-Shell"><a href="#2-Shell" class="headerlink" title="2. Shell"></a>2. Shell</h3><h4 id="2-1-Flow-Control"><a href="#2-1-Flow-Control" class="headerlink" title="2.1 Flow Control"></a>2.1 Flow Control</h4><p>(1) If 语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> [ -r /bin/netstat ]; <span class="keyword">then</span></div><div class="line">/bin/netstat -an &gt; <span class="variable">$DATE_DIR</span>/netstat.dump 2&gt;&amp;1</div><div class="line"><span class="built_in">echo</span> -e <span class="string">".\c"</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>if … else … 句式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"restart"</span> ]; <span class="keyword">then</span></div><div class="line">	./restart.sh</div><div class="line"><span class="keyword">else</span></div><div class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"dump"</span> ]; <span class="keyword">then</span></div><div class="line">		./dump.sh</div><div class="line">	<span class="keyword">else</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"ERROR: Please input argument: start or stop or debug or restart or dump"</span></div><div class="line">		<span class="built_in">exit</span> 1</div><div class="line">	<span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>(2) For 语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> -e <span class="string">"Dumping the <span class="variable">$SERVER_NAME</span> ...\c"</span></div><div class="line"><span class="keyword">for</span> PID <span class="keyword">in</span> <span class="variable">$PIDS</span> ; <span class="keyword">do</span></div><div class="line">	jstack <span class="variable">$PID</span> &gt; <span class="variable">$DATE_DIR</span>/jstack-<span class="variable">$PID</span>.dump 2&gt;&amp;1</div><div class="line">	<span class="built_in">echo</span> -e <span class="string">".\c"</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<p>(3) Switch 语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">main</span></span>() &#123;</div><div class="line">    <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></div><div class="line">	    <span class="string">'scp'</span>)</div><div class="line">		    scp_to_server</div><div class="line">		    ;;</div><div class="line">	    <span class="string">'ssh'</span>)</div><div class="line">		    ssh_to_server</div><div class="line">		    ;;</div><div class="line">	    *)</div><div class="line">		    <span class="built_in">echo</span> <span class="string">'Usage: ./deploy [scp | ssh]'</span></div><div class="line">		    ;;</div><div class="line">    <span class="keyword">esac</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">main <span class="variable">$1</span></div></pre></td></tr></table></figure>
<h4 id="2-2-String"><a href="#2-2-String" class="headerlink" title="2.2 String"></a>2.2 String</h4><table>
<thead>
<tr>
<th>语句</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[[ $str1 == $str2 ]]</code></td>
<td>判断两个字符串是否相同</td>
</tr>
<tr>
<td><code>[[ $str1 != $str2 ]]</code></td>
<td>判断两个字符串是否不同</td>
</tr>
<tr>
<td><code>[[ -z $str1 ]]</code></td>
<td>判断 <code>$str1</code> 是否是一个空字符串</td>
</tr>
<tr>
<td><code>[[ -n $str1 ]]</code></td>
<td>判断 <code>$str1</code> 是否是一个非空字符串</td>
</tr>
</tbody>
</table>
<h4 id="2-3-Sed-a-stream-editor"><a href="#2-3-Sed-a-stream-editor" class="headerlink" title="2.3 Sed - a stream editor"></a>2.3 Sed - a stream editor</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/pattern/action</div></pre></td></tr></table></figure>
<ul>
<li><strong>pattern</strong>: 正则表达式</li>
<li><strong>action</strong>: <code>p</code>, <code>d</code>, <code>s/pattern1/pattern2/</code></li>
</ul>
<p>(1) 行的地址与范围:</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>4,10d</code></td>
<td>删除第 4 到第 10 行</td>
</tr>
<tr>
<td><code>4,+2d</code></td>
<td>删除 4,5,6 行</td>
</tr>
<tr>
<td><code>2,5!d</code></td>
<td>删除除了第 2 到第 5 行外的所有的行</td>
</tr>
<tr>
<td><code>1~3d</code></td>
<td>删除第 1,4,7,10 行</td>
</tr>
<tr>
<td><code>4,10p</code></td>
<td>打印第 4 到第 10 行</td>
</tr>
<tr>
<td><code>4,d</code></td>
<td>语法错误</td>
</tr>
<tr>
<td><code>,10d</code></td>
<td>语法错误</td>
</tr>
</tbody>
</table>
<p>(1) 查找并替换:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i -e <span class="string">'s/few/asd/g'</span> hello.txt</div></pre></td></tr></table></figure>
<p>使用一个不同的分隔符:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i -e <span class="string">'s:few:asd:g'</span> hello.txt</div></pre></td></tr></table></figure>
<p>使用空字符串替换:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /etc/passed | sed <span class="string">'s/root//g'</span></div></pre></td></tr></table></figure>
<p>只替换某一行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /etc/passwd | sed <span class="string">'10s/sh/quiet/g'</span></div></pre></td></tr></table></figure>
<p>替换 1 到 5 行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /etc/passwd | sed <span class="string">'1,5s/sh/quiet/g'</span></div></pre></td></tr></table></figure>
<ul>
<li><strong>-i[SUFFIX]</strong>: 对文件 <code>hello.txt</code> edit <strong>i</strong>n place</li>
<li><strong>–in-place[=SUFFIX]</strong>: 同上</li>
<li><strong>-e script</strong>: 指明 <strong>e</strong>xpression/command to run</li>
<li><strong>–expression=script</strong>: 同上</li>
<li><strong>-E</strong>:</li>
<li><strong>-r</strong>:</li>
<li><strong>–regexp-extended</strong>: 使用扩展正则表达式</li>
<li><strong>s/</strong>: 表示替换</li>
<li><strong>/g</strong>: 替换整行</li>
</ul>
<p>(2) 打印指定行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -n <span class="string">'45p'</span> file.txt</div></pre></td></tr></table></figure>
<ul>
<li><strong>-n</strong>: 抑制输出，默认情况下 Sed 会打印所有的输入文件的内容</li>
<li><strong>p</strong>: 打印指定的行</li>
</ul>
<p>(3) 删除指定范围的行:</p>
<p>删除指定范围的行，然后把未删除的内容写入到 <code>output.txt</code> 文件中去:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'30,35d'</span> input.txt &gt; output.txt</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">task_name=<span class="variable">$1</span></div><div class="line">main_class=<span class="variable">$2</span></div><div class="line">rp_task_name_cmd=<span class="string">'s_&lt;artifactId&gt;task&lt;/artifactId&gt;_&lt;artifactId&gt;'</span><span class="variable">$task_name</span><span class="string">'&lt;/artifactId&gt;_g'</span></div><div class="line">rp_main_class_cmd=<span class="string">'s_&lt;mainClass&gt;.*&lt;/mainClass&gt;_&lt;mainClass&gt;'</span><span class="variable">$main_class</span><span class="string">'&lt;/mainClass&gt;_g'</span></div><div class="line">sed -i <span class="variable">$rp_task_name_cmd</span> <span class="variable">$POM_FILE</span></div><div class="line">sed -i <span class="variable">$rp_main_class_cmd</span> <span class="variable">$POM_FILE</span></div></pre></td></tr></table></figure>
<h4 id="2-4-文件系统"><a href="#2-4-文件系统" class="headerlink" title="2.4 文件系统"></a>2.4 文件系统</h4><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[ -f $file_var ]</code></td>
<td>测试这个变量是否是一个正则表达式文件路径或文件名</td>
</tr>
<tr>
<td><code>[ -e $var ]</code></td>
<td>测试是否是一个可执行的文件路径</td>
</tr>
<tr>
<td><code>[ -d $var ]</code></td>
<td>测试是否是一个目录路径 (<strong>可以用来测试文件夹是否存在</strong>)</td>
</tr>
<tr>
<td><code>[ -e $var ]</code></td>
<td>文件是否存在</td>
</tr>
<tr>
<td><code>[ -c $var ]</code></td>
<td>文件是否是一个 character device 文件</td>
</tr>
<tr>
<td><code>[ -b $var ]</code></td>
<td>文件是否是一个 block device 文件</td>
</tr>
<tr>
<td><code>[ -w $var ]</code></td>
<td>文件路径是否可写</td>
</tr>
<tr>
<td><code>[ -r $var ]</code></td>
<td>文件路径是否可读</td>
</tr>
<tr>
<td><code>[ -L $var ]</code></td>
<td>文件是否是一个 symlink 路径</td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DUMP_DATE=`date +%Y%m%d%H%M%S`</div><div class="line">DATE_DIR=<span class="variable">$DUMP_DIR</span>/<span class="variable">$DUMP_DATE</span></div><div class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$DATE_DIR</span> ]; <span class="keyword">then</span></div><div class="line">	mkdir <span class="variable">$DATE_DIR</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<h4 id="2-5-date"><a href="#2-5-date" class="headerlink" title="2.5 date"></a>2.5 date</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ date +%Y%m%d%H%M%S</div><div class="line">20170701165459</div></pre></td></tr></table></figure>
<h4 id="2-6-echo"><a href="#2-6-echo" class="headerlink" title="2.6 echo"></a>2.6 echo</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> -e <span class="string">"Dumping the <span class="variable">$SERVER_NAME</span> ...\c"</span></div></pre></td></tr></table></figure>
<ul>
<li><strong>-e</strong>: Enable echo’s interpretation of additional instances of the newline character as well as the interpretation of other special characters, such as a horizontal tab, which is represented by <code>\t</code></li>
</ul>
<h4 id="2-7-tr-translate-or-delete-characters"><a href="#2-7-tr-translate-or-delete-characters" class="headerlink" title="2.7 tr - translate or delete characters"></a>2.7 tr - translate or delete characters</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tr [OPTION]... SET1 [SET2]</div></pre></td></tr></table></figure>
<ul>
<li><strong>-d</strong>:</li>
<li><strong>–delete</strong>: 删除在 SET1 中的字符</li>
<li><strong>-s</strong>:</li>
<li><strong>–squeeze-repeats</strong>: 挤压字符</li>
</ul>
<p>(1) 删除字符 <code>t</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"the geek stuff"</span> | tr -d <span class="string">'t'</span></div></pre></td></tr></table></figure>
<p>Text files created on DOS/Windows machines have different line endings than files created on Unix/Linux. <strong>DOS uses carriage return and line feed (“\r\n”) as a line ending, which Unix uses just line feed (“\n”)</strong>. 删除 <code>\r</code> 字符:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tr -d <span class="string">'\r'</span></div></pre></td></tr></table></figure>
<p><strong>删除空格, Tab 键产生的空格等</strong>用这个 <code>tr</code> 命令就行了，AWK 正则匹配很不靠谱:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tr -d <span class="string">' \t'</span></div></pre></td></tr></table></figure>
<p>(2) 小写转成大写，必须手动输入需要转换的字符，然后回车才会显示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ tr [:lower:] [:upper:]</div><div class="line">thegeekstuff</div><div class="line">THEGEEKSTUFF</div></pre></td></tr></table></figure>
<p>(3) 保留一个空格，删除其他空格</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"This  is  for testing"</span> | tr -s [:space:] <span class="string">' '</span></div></pre></td></tr></table></figure>
<h4 id="2-8-文件描述符和重定向"><a href="#2-8-文件描述符和重定向" class="headerlink" title="2.8 文件描述符和重定向"></a>2.8 文件描述符和重定向</h4><p>将标准错误转为标准输出:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">kill</span> <span class="variable">$PID</span> &gt; /dev/null 2&gt;&amp;1</div></pre></td></tr></table></figure>
<h4 id="2-9-文件参数"><a href="#2-9-文件参数" class="headerlink" title="2.9 文件参数"></a>2.9 文件参数</h4><ul>
<li><strong>$0</strong>: 文件名</li>
<li><strong>$1</strong>: 参数1</li>
<li><strong>$2</strong>: 参数2</li>
<li><strong>$@</strong>: 文件名 参数1 参数2 …</li>
<li><strong>$*</strong>: 文件名 “参数1 参数2 …”</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># alibaba druid 项目的脚本文件 druidStat.sh</span></div><div class="line"><span class="string">"<span class="variable">$JAVA_HOME</span>/bin/java"</span> -Dfile.encoding=<span class="string">"UTF-8"</span> -cp <span class="string">"./druid-0.2.6.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar"</span> com.alibaba.druid.support.console.DruidStat <span class="variable">$@</span></div></pre></td></tr></table></figure>
<hr>
<p>传递参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./deploy.sh <span class="built_in">test</span> -y 2017 -m 6</div></pre></td></tr></table></figure>
<p>现在我想在 <code>deploy.sh</code> 脚本中获取到 <code>-y 2017 -m 6</code> 这个参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">shift</span></div><div class="line"><span class="built_in">echo</span> <span class="variable">$@</span></div></pre></td></tr></table></figure>
<p>输出的就是 <code>-y 2017 -m 6</code> 这个参数</p>
<h4 id="数字比较"><a href="#数字比较" class="headerlink" title="数字比较"></a>数字比较</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[ <span class="variable">$var</span> -eq 0 ] <span class="comment"># It returns true when $var equal to 0.</span></div><div class="line">[ <span class="variable">$var</span> -ne 0 ] <span class="comment"># It returns true when $var not equals 0</span></div></pre></td></tr></table></figure>
<ul>
<li><code>-gt</code>: Greater than</li>
<li><code>-lt</code>: Less than</li>
<li><code>-ge</code>: Greater than or equal to</li>
<li><code>-le</code>: Less than or equal to</li>
</ul>
<h4 id="数学计算"><a href="#数学计算" class="headerlink" title="数学计算"></a>数学计算</h4><p>The <code>let</code> command can be used to perform basic operations directly:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#求和</span></div><div class="line"><span class="built_in">let</span> result=no1+no2</div><div class="line"><span class="built_in">echo</span> <span class="variable">$result</span></div><div class="line"><span class="comment">#自增</span></div><div class="line"><span class="built_in">let</span> no1++</div></pre></td></tr></table></figure>
<p>使用 <code>[]</code> 可以达到和 <code>let</code> 相同的目的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result=$[ no1 + no2 ]</div></pre></td></tr></table></figure>
<p>使用 <code>$</code> 前缀是可以的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result=$[ <span class="variable">$no1</span> + 5 ]</div></pre></td></tr></table></figure>
<p>也可以使用 <code>(())</code> ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result=$(( no1 + 50 ))</div></pre></td></tr></table></figure>
<p><code>expr</code> can also be used for basic operations:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">result=`expr 3 + 4`</div><div class="line">result=$(expr <span class="variable">$no1</span> + 5)</div></pre></td></tr></table></figure>
<p>All of the above methods do not support floating point numbers, and operate on <strong>整数</strong> only.</p>
<h4 id="if-多个条件"><a href="#if-多个条件" class="headerlink" title="if 多个条件"></a><code>if</code> 多个条件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># AND -a 和</span></div><div class="line">[ <span class="variable">$var1</span> -ne 0 -a <span class="variable">$var2</span> -gt 2 ]</div><div class="line"></div><div class="line"><span class="comment"># OR -r 或</span></div><div class="line">[ <span class="variable">$var1</span> -ne 0 -o <span class="variable">$var2</span> -gt 2 ]</div></pre></td></tr></table></figure>
<h3 id="xxd-make-a-hexdump-or-do-the-reverse"><a href="#xxd-make-a-hexdump-or-do-the-reverse" class="headerlink" title="xxd - make a hexdump or do the reverse"></a>xxd - make a hexdump or do the reverse</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 二进制</div><div class="line">xxd -b file</div><div class="line">// 十六进制</div><div class="line">xxd file</div></pre></td></tr></table></figure>
<h3 id="od-dump-files-in-octal-and-other-formats"><a href="#od-dump-files-in-octal-and-other-formats" class="headerlink" title="od - dump files in octal and other formats"></a>od - dump files in octal and other formats</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// ASCII 编码方式打印</div><div class="line">od -c file</div><div class="line">// 十六进制</div><div class="line">od -cx file</div></pre></td></tr></table></figure>
<h3 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h3><ul>
<li><strong>-v</strong>: </li>
<li><strong>–invert-match</strong>: 反匹配</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Redis 查询输出缓冲区不为 0 的客户端连接</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'CLIENT LIST'</span> | redis-cli | grep -v <span class="string">'omem=0'</span></div><div class="line"><span class="comment"># 只在指定类型的文件中进行搜索</span></div><div class="line">grep <span class="string">'void'</span> -Rn . --include \*.java --include \*.c</div></pre></td></tr></table></figure>
<hr>
<p><strong>Basic vs Extended Regular Expressions</strong>:</p>
<p>In <strong>basic regular</strong> expressions the meta-characters ‘?’, ‘+’, ‘{’, ‘|’, ‘(’, and ‘)’ <strong>失去</strong> their special meaning; instead use the <strong>反斜线版本</strong> ‘\?’, ‘+’, ‘{’, ‘|’, ‘(’, and ‘)’.</p>
<p>Traditional egrep did not support the ‘{’ meta-character, and some egrep implementations support ‘{’ instead, so portable scripts should avoid ‘{’ in ‘grep -E’ patterns and should use ‘[{]’ to match a literal ‘{’.</p>
<hr>
<p><strong>默认情况下 <code>.</code> 是匹配单个字符</strong>的，<b><code>*</code> 是匹配多个字符</b>的，这两个是默认生效的。所以下面这行命令对 <code>abcdef</code> 和 <code>ab.def</code> 都能匹配上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">'ab.def'</span> -Rn .</div></pre></td></tr></table></figure>
<p>如果就想要匹配一个点，那么需要转义:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">'ab\.def'</span> -Rn .</div></pre></td></tr></table></figure>
<hr>
<p><strong>默认情况下，<code>grep</code> 是区分大小写的</strong>，可以使用 <code>-i</code> 来不区分大小写:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">"ab.def"</span> -Rni .</div></pre></td></tr></table></figure>
<hr>
<p><strong><code>grep</code></strong> OR 匹配:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -e <span class="string">'select'</span> -e <span class="string">'insert'</span> aaa.log</div></pre></td></tr></table></figure>
<p><img src="2017_11_23_10_59_38.png" alt=""></p>
<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><blockquote>
<p><code>curl</code> 命令执行之前一定要 <code>unset http_proxy</code>，尤其是 <code>curl http://localhost:8080</code></p>
</blockquote>
<h4 id="1-curl-加上头"><a href="#1-curl-加上头" class="headerlink" title="(1) curl - 加上头"></a>(1) curl - 加上头</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -H <span class="string">'Accept:application/json'</span> http://localhost:8080</div></pre></td></tr></table></figure>
<h4 id="2-curl-只获取服务器返回的头"><a href="#2-curl-只获取服务器返回的头" class="headerlink" title="(2) curl - 只获取服务器返回的头"></a>(2) curl - 只获取服务器返回的头</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -I http://localhost:8080</div></pre></td></tr></table></figure>
<h4 id="3-curl-进行-POST-请求"><a href="#3-curl-进行-POST-请求" class="headerlink" title="(3) curl - 进行 POST 请求"></a>(3) curl - 进行 POST 请求</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -X POST -d <span class="string">'&#123;"username":"xyz","password":"123"&#125;'</span> http://localhost/8080/api/login</div></pre></td></tr></table></figure>
<ul>
<li><strong>-d</strong>: 暗含了执行 <code>POST</code> 请求，所以 <code>-X</code> 可以不加</li>
</ul>
<h4 id="4-curl-进行-https-请求"><a href="#4-curl-进行-https-请求" class="headerlink" title="(4) curl - 进行 https 请求"></a>(4) curl - 进行 <code>https</code> 请求</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl: (35) error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol</div></pre></td></tr></table></figure>
<p>暂时不知道如何解决</p>
<h3 id="wc"><a href="#wc" class="headerlink" title="wc"></a>wc</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 统计总行数 (A 文件行 +　Ｂ 文件行 + ...)</div><div class="line"># 而且,子目录也会被搜索</div><div class="line">find . -name &apos;*.java&apos; | xargs wc -l</div><div class="line"># 排除子目录</div><div class="line">find . -name &apos;*.java&apos; -maxdepth 1</div><div class="line"># 统计文件数</div><div class="line">find . -name &apos;*.java&apos; | awk &apos;&#123; print &#125; END &#123; print NR &#125;&apos;</div></pre></td></tr></table></figure>
<h3 id="大文件传输"><a href="#大文件传输" class="headerlink" title="大文件传输"></a>大文件传输</h3><p><img src="17-07-28-22_31_30_1033_401.png" alt=""></p>
<p><img src="17-07-28-23_07_28_1027_381.png" alt=""></p>
<p><img src="17-07-28-23_08_45_1024_573.png" alt=""></p>
<p><img src="17-07-28-22_36_14_1044_239.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rsync all.sql zk@10.108.113.85:~/Desktop/</div></pre></td></tr></table></figure>
<h3 id="apt-get"><a href="#apt-get" class="headerlink" title="apt-get"></a><code>apt-get</code></h3><p>删除文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dpkg -l | grep sogoupinyin</div><div class="line">sudo apt remove --purge sogoupinyin</div></pre></td></tr></table></figure>
<h3 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a><code>netstat</code></h3><p>There’s a few parameters to <code>netstat</code> that are useful for how to check the opened/closed port on my computer:</p>
<ul>
<li><code>-l</code> or <code>--listening</code> shows only the sockets currently listening for incoming connection.</li>
<li><code>-a</code> or <code>--all</code> shows all sockets currently in use.</li>
<li><code>-t</code> or <code>--tcp</code> shows the tcp sockets.</li>
<li><code>-u</code> or <code>--udp</code> shows the udp sockets.</li>
<li><code>-n</code> or <code>--numeric</code> shows the hosts and ports as numbers, instead of resolving in dns and looking in /etc/services.</li>
<li><code>-p</code> or <code>--program</code> Show the PID and name of the program to which each socket belongs.</li>
<li><code>-e</code>, <code>--extend</code> Display additional information.  Use this option twice for maximum detail.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo netstat -peanut | grep 3306</div></pre></td></tr></table></figure>
<h3 id="磁盘管理"><a href="#磁盘管理" class="headerlink" title="磁盘管理"></a>磁盘管理</h3><h4 id="1-查看磁盘剩余空间"><a href="#1-查看磁盘剩余空间" class="headerlink" title="(1) 查看磁盘剩余空间"></a>(1) 查看磁盘剩余空间</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df -h</div></pre></td></tr></table></figure>
<h4 id="2-查看目录或文件占用多大空间"><a href="#2-查看目录或文件占用多大空间" class="headerlink" title="(2) 查看目录或文件占用多大空间"></a>(2) 查看目录或文件占用多大空间</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">du -h target/</div></pre></td></tr></table></figure>
<h3 id="SSH-免密登录"><a href="#SSH-免密登录" class="headerlink" title="SSH 免密登录"></a>SSH 免密登录</h3><p><strong>服务器端</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> .ssh</div><div class="line">ssh-keygen -t rsa  (hit <span class="built_in">return</span> through prompts)</div><div class="line">cat id_rsa.pub &gt;&gt; authorized_keys</div><div class="line">chmod 600 authorized_keys</div><div class="line">rm id_rsa.pub</div></pre></td></tr></table></figure>
<p><strong>客户端</strong>:</p>
<p>把自己的 <strong><code>./ssh/id_rsa.pub</code></strong> 文件里面的<strong>所有内容</strong> 都拷贝到服务器端的 <code>authorized_keys</code> 文件中去。</p>
<h3 id="AWK"><a href="#AWK" class="headerlink" title="AWK"></a>AWK</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'$2 ~ /^org.*/ &#123;print $2&#125;'</span> .java_process</div></pre></td></tr></table></figure>
<hr>
<p>对如下 <code>combined_log</code> 日志文件进行分析:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">66.249.64.13 - - [18/Sep/2004:11:07:48 +1000] &quot;GET /robots.txt HTTP/1.0&quot; 200 468 &quot;-&quot; &quot;Googlebot/2.1&quot;</div><div class="line">66.249.64.13 - - [18/Sep/2004:11:07:48 +1000] &quot;GET / HTTP/1.0&quot; 200 6433 &quot;-&quot; &quot;Googlebot/2.1&quot;</div></pre></td></tr></table></figure>
<p><strong>打印所有 IP</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $1&#125;'</span> combined_log</div></pre></td></tr></table></figure>
<hr>
<p><strong>AWK 默认以空格为分隔符，现在我们修改为 <code>&quot;</code></strong>，打印所有请求行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk -F\<span class="string">" '&#123;print <span class="variable">$2</span>&#125;' combined_log</span></div></pre></td></tr></table></figure>
<hr>
<p>按照 <code>User Agent</code> 出现的次数<strong>降序</strong>排序:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk -F\<span class="string">" '&#123;print <span class="variable">$6</span>&#125;' combined_log | sort | uniq -c | sort -fr</span></div></pre></td></tr></table></figure>
<ul>
<li><strong><code>sort -r</code></strong>: reverse 的意思，<strong>降序排序</strong></li>
<li><strong><code>sort -f</code></strong>: <code>--ignore-case</code> 的意思，<strong>忽略大小写</strong></li>
<li><strong><code>uniq -c</code></strong>: <code>--count</code>，在每行之前显示这行<strong>出现的次数</strong></li>
</ul>
<p>参考: <a href="http://www.the-art-of-web.com/system/logs/" target="_blank" rel="external">System: Analyzing Apache Log Files</a></p>
<h3 id="Bash-字符串"><a href="#Bash-字符串" class="headerlink" title="Bash 字符串"></a>Bash 字符串</h3><h4 id="1-字符串连接"><a href="#1-字符串连接" class="headerlink" title="(1) 字符串连接"></a>(1) 字符串连接</h4><p>注意字符串连接的时候，几个<strong>字符串之间没有空格</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AWK_PROGRAM=<span class="string">'$2 ~ /^'</span><span class="variable">$PROCESS_NAME</span><span class="string">'.*/ &#123; print $1 &#125;'</span></div><div class="line"><span class="built_in">echo</span> `awk <span class="string">"<span class="variable">$AWK_PROGRAM</span>"</span> .java_process`</div></pre></td></tr></table></figure>
<h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h3><p><strong><code>cp</code></strong> 的时候一定要<strong>注意目标地址的文件夹是否存在</strong>的问题:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># auto_creat_folder 一开始不存在，auto_creat_folder 将会自动被创建，目录结构变为: auto_creat_folder/**</span></div><div class="line">cp -r ../resources/ auto_creat_folder/</div><div class="line"><span class="comment"># exist_folder 已经存在了, 这个时候，目录结构会变为 exist_folder/resources/**</span></div><div class="line">cp -r ../resources exist_folder/</div></pre></td></tr></table></figure>
<h3 id="脚本启动的问题"><a href="#脚本启动的问题" class="headerlink" title="脚本启动的问题"></a>脚本启动的问题</h3><p>这样写是不行的，下一个命令会等待上一个命令执行结束:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ./start.sh</span></div><div class="line"></div><div class="line">java -jar a.jar</div><div class="line">java -jar b.jar</div><div class="line">java -jar c.jar</div></pre></td></tr></table></figure>
<p>所以应该都添加 <code>&amp;</code> 来确保其一块启动起来:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ./start.sh</span></div><div class="line"></div><div class="line">java -jar a.jar &amp;</div><div class="line">java -jar b.jar &amp;</div><div class="line">java -jar c.jar &amp;</div></pre></td></tr></table></figure>
<h3 id="kill-vs-kill-9"><a href="#kill-vs-kill-9" class="headerlink" title="kill vs kill -9"></a><code>kill</code> vs <code>kill -9</code></h3><p><code>kill -9</code> Meaning: The process will be killed by the kernel; this signal cannot be ignored. 9 means KILL signal <strong>that is not catchable or ignorable</strong></p>
<p>Uses: <code>SIGKILL</code> singal</p>
<p><code>Kill</code> Meaning: The kill command without any signal passes the signal 15, which terminates the process the normal way.</p>
<p>Uses: <code>SIGTERM</code> signal, <strong>which can be handled by programmers</strong></p>
<h3 id="etc-init-vs-etc-init-d"><a href="#etc-init-vs-etc-init-d" class="headerlink" title="/etc/init/ vs /etc/init.d/"></a><code>/etc/init/</code> vs <code>/etc/init.d/</code></h3><p><code>/etc/init.d</code> contains <strong>脚本</strong> used by the <strong>System V</strong> init tools (SysVinit). This is the traditional service management package for Linux, containing the <strong>初始化</strong> program (the first process that is run when the kernel has finished initializing¹) as well as some infrastructure to start and stop services and configure them. Specifically, files in <code>/etc/init.d</code> are shell scripts that respond to <code>start</code>, <code>stop</code>, <code>restart</code>, and (when supported) <code>reload</code> commands to manage a particular service. These scripts can be invoked directly or (most commonly) via some other trigger (typically the presence of a symbolic link in <code>/etc/rc?.d/</code>).</p>
<p><code>/etc/init</code> contains configuration files used by <strong>Upstart</strong>. Upstart is a young service management package championed by <strong>Ubuntu</strong>. Files in <code>/etc/init</code> are configuration files telling Upstart how and when to start, stop, reload the configuration, or query the status of a service. As of lucid, Ubuntu is transitioning from SysVinit to Upstart, which explains why many services come with SysVinit scripts even though Upstart configuration files are preferred. In fact, the SysVinit scripts are processed by a compatibility layer in Upstart.</p>
<p><code>.d</code> in directory names typically indicates a <strong>目录</strong> containing many configuration files or scripts for a particular situation (e.g. <code>/etc/apt/sources.list.d</code> contains files that are concatenated to make a virtual sources.list; <code>/etc/network/if-up.d</code> contains scripts that are executed when a network interface is activated). This structure is usually used when each entry in the directory is provided by a different source, so that each package can deposit its own plug-in without having to parse a single configuration file to reference itself. In this case, it just happens that “init” is a logical name for the directory, <code>SysVinit</code> <strong>来的比较早</strong> and used <code>init.d</code>, and <code>Upstart</code> used plain init for a directory with <strong>相同的目的</strong> (it would have been more “mainstream”, and perhaps less arrogant, if they’d used <code>/etc/upstart.d</code> instead).</p>
<p>参考: <a href="https://askubuntu.com/questions/5039/what-is-the-difference-between-etc-init-and-etc-init-d" target="_blank" rel="external">What is the difference between /etc/init/ and /etc/init.d/?</a></p>
<h3 id="查看所有用户"><a href="#查看所有用户" class="headerlink" title="查看所有用户"></a>查看所有用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cat /etc/passwd</div><div class="line"><span class="comment"># 或者</span></div><div class="line">awk -F<span class="string">':'</span> <span class="string">'&#123; print $1&#125;'</span> /etc/passwd</div></pre></td></tr></table></figure>
<h3 id="nohup"><a href="#nohup" class="headerlink" title="nohup"></a>nohup</h3><p><code>nohup</code> is a POSIX command to ignore the <strong>HUP (hangup) signal</strong>. The HUP signal is, by convention, the way a terminal warns dependent processes of logout.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ nohup abcd &amp;</div><div class="line">$ <span class="built_in">exit</span></div></pre></td></tr></table></figure>
<p>Note that nohupping backgrounded jobs is typically used to avoid terminating them when logging off from a remote SSH session. A different issue that often arises in this situation is that <code>ssh</code> is <strong>拒绝退出 (“hangs”)</strong>, since it refuses to lose any data from/to the background job(s). This problem can also be overcome by <strong>重定向</strong> all three I/O streams:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nohup ./myprogram &gt; foo.out <span class="number">2</span>&gt; foo.err &lt; /dev/<span class="keyword">null</span> &amp;</div></pre></td></tr></table></figure>
<h3 id="Cron"><a href="#Cron" class="headerlink" title="Cron"></a>Cron</h3><p>The software utility <a href="https://en.wikipedia.org/wiki/Cron" target="_blank" rel="external"><code>Cron</code></a> is a time-based job scheduler in Unix-like computer operating systems. People who set up and maintain software environments use cron to <strong>调度任务(命令或者脚本)</strong> to run periodically at fixed times, dates, or intervals.</p>
<p><code>Cron</code> is driven by a <code>crontab</code> (cron table) file, a configuration file that specifies shell commands to run periodically on a given schedule. The crontab files are stored where the lists of jobs and other instructions to the cron daemon are kept. Users can have their own individual crontab files and often there is a system-wide crontab file (usually in <code>/etc</code> or a subdirectory of <code>/etc</code>) that only system administrators can edit.</p>
<p>Each line of a crontab file represents a job, and looks like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">┌───────────── minute (0 - 59)</div><div class="line">│ ┌───────────── hour (0 - 23)</div><div class="line">│ │ ┌───────────── day of month (1 - 31)</div><div class="line">│ │ │ ┌───────────── month (1 - 12)</div><div class="line">│ │ │ │ ┌───────────── day of week (0 - 6) (Sunday to Saturday;</div><div class="line">│ │ │ │ │                                       7 is also Sunday on some systems)</div><div class="line">│ │ │ │ │</div><div class="line">│ │ │ │ │</div><div class="line">* * * * *  command to execute</div></pre></td></tr></table></figure>
<p>一些示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 每天 00:01 分清空一下这个日志文件的内容</span></div><div class="line">1 0 * * * <span class="built_in">printf</span> &gt; /var/<span class="built_in">log</span>/apache/error_log</div><div class="line"></div><div class="line"><span class="comment"># 每周六 23:45 分调用一下 dump.sh 这个脚本</span></div><div class="line">45 23 * * 6 /home/oracle/scripts/export_dump.sh</div><div class="line"></div><div class="line"><span class="comment"># 每小时的第一分钟开始执行</span></div><div class="line">@hourly /scripts/script.sh</div><div class="line"></div><div class="line"><span class="comment"># 每天的第一分钟开始执行</span></div><div class="line">@daily /scripts/script.sh</div><div class="line"></div><div class="line"><span class="comment"># 每周的第一分钟开始执行</span></div><div class="line">@weekly /bin/script.sh</div><div class="line"></div><div class="line"><span class="comment"># 没月的第一分钟开始执行</span></div><div class="line">@monthly /scripts/script.sh</div><div class="line"></div><div class="line"><span class="comment"># 每年的第一分钟开始执行</span></div><div class="line">@yearly /scripts/script.sh</div><div class="line"></div><div class="line"><span class="comment"># 重启执行</span></div><div class="line">@reboot /scripts/script.sh</div></pre></td></tr></table></figure>
<hr>
<p>编辑文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 打开 crontab 文件用当前用户进行编辑/添加</span></div><div class="line">crontab -e</div><div class="line"></div><div class="line"><span class="comment"># 可能需要使用 sudo 权限</span></div><div class="line">sudo crontab -e</div><div class="line"></div><div class="line"><span class="comment"># 列举任务</span></div><div class="line">crontab -l</div></pre></td></tr></table></figure>
<hr>
<p><strong>每分钟</strong>运行一次脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">* * * * * script.sh</div></pre></td></tr></table></figure>
<hr>
<p><strong>每 10 分钟</strong>运行一次脚本:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*/10 * * * * script.sh</div></pre></td></tr></table></figure>
<hr>
<p>查看 <code>crontab</code> 的日志:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail -f /var/<span class="built_in">log</span>/syslog</div></pre></td></tr></table></figure>
<p><img src="2017_11_21_14_59_09.png" alt=""></p>
<p>This happens because your cron jobs are producing output and then the cron daemon tries to <strong>发送邮件</strong> that output to you. If you don’t need that output, the easiest way to solve this is to <strong>丢弃</strong> it at the crontab:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">* * * * * yourCommand &gt;/dev/null 2&gt;&amp;1</div></pre></td></tr></table></figure>
<hr>
<p><code>cron</code> 环境的问题:</p>
<p><code>Cron</code> provides only this environment by default :</p>
<ul>
<li><code>HOME</code> user’s home directory</li>
<li><code>LOGNAME</code> user’s login</li>
<li><code>PATH</code>=<code>/usr/bin:/usr/sbin</code></li>
<li><code>SHELL</code>=<code>/usr/bin/sh</code></li>
</ul>
<p>If you need more you can <strong><code>source</code> a script</strong> where you define your environment before the scheduling table in the crontab.</p>
<p>或者在自己写的脚本里面，指明路径:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">export</span> JAVA_HOME=/path/to/jdk</div><div class="line"></div><div class="line">some-other-command</div></pre></td></tr></table></figure>
<hr>
<p><code>top</code> 命令在 <code>cron</code> 里面没有输出的问题:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 应该加上 -b 参数</span></div><div class="line"><span class="comment"># :Batch-mode operation </span></div><div class="line"><span class="comment"># Starts top in Batch mode, which could be useful for sending output from top to other programs or to a file. </span></div><div class="line">top -b</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://stackoverflow.com/questions/2229825/where-can-i-set-environment-variables-that-crontab-will-use" target="_blank" rel="external">参考</a></li>
</ul>
<h3 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h3><p><img src="17-08-16-16_46_41_784_270.png" alt=""></p>
<h3 id="ps-ef-和-ps-aux"><a href="#ps-ef-和-ps-aux" class="headerlink" title="ps -ef 和 ps -aux"></a><code>ps -ef</code> 和 <code>ps -aux</code></h3><ul>
<li><code>ps -ef</code>:</li>
</ul>
<p><img src="17-08-16-17_12_47_853_203.png" alt=""></p>
<ul>
<li><code>ps -aux</code>:</li>
</ul>
<p><img src="17-08-16-17_03_22_1080_253.png" alt=""></p>
<h3 id="add-apt-repository"><a href="#add-apt-repository" class="headerlink" title="add-apt-repository"></a>add-apt-repository</h3><p>平常如果需要安装东西的时候，比如 <code>jdk8</code>，那么可能需要使用 <code>add-apt-repository</code> 这个命令，敲击回车后，如果提示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">spider@hadoop-master:~$ sudo add-apt-repository ppa:webupd8team/java</div><div class="line">sudo: add-apt-repository: <span class="built_in">command</span> not found</div></pre></td></tr></table></figure>
<p>那么请执行如下命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">spider@hadoop-master:~$ sudo apt-get install software-properties-common python-software-properties</div></pre></td></tr></table></figure>
<p>如果发现<strong>需要配置代理</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> http_proxy=http://&lt;proxy&gt;:&lt;port&gt;</div><div class="line"><span class="built_in">export</span> https_proxy=http://&lt;proxy&gt;:&lt;port&gt;</div><div class="line">sudo -E add-apt-repository ppa:linaro-maintainers/toolchain</div></pre></td></tr></table></figure>
<ul>
<li><strong>-E</strong>: 保留环境变量</li>
</ul>
<h3 id="启动项"><a href="#启动项" class="headerlink" title="启动项"></a>启动项</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vi /etc/default/grub</div></pre></td></tr></table></figure>
<p>然后把 <code>GRUB_DEFAULT=0</code> 后面的数字修改为任何想要的数字:</p>
<p><img src="1mMje.jpg" alt=""></p>
<p>最后不要忘记执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo update-grub</div></pre></td></tr></table></figure>
<h3 id="如何查看-Linux-内核版本"><a href="#如何查看-Linux-内核版本" class="headerlink" title="如何查看 Linux 内核版本"></a>如何查看 Linux 内核版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uname -r</div></pre></td></tr></table></figure>
<h3 id="Linux-命令中考没考虑过管道大小，管道满了怎么办"><a href="#Linux-命令中考没考虑过管道大小，管道满了怎么办" class="headerlink" title="Linux 命令中考没考虑过管道大小，管道满了怎么办"></a>Linux 命令中考没考虑过管道大小，管道满了怎么办</h3><p><strong>Pipe 容量</strong>:</p>
<p>A pipe has a limited capacity.  If the pipe is full, then a <strong><code>write(2)</code></strong> will block or fail <strong>阻塞或者失败</strong>, depending on whether the <code>O_NONBLOCK</code> flag is set (see below).  Different implementations have different limits for the pipe capacity.  Applications should not rely on a particular capacity: an application should be designed so that a reading process consumes data as soon as it is available, so that a writing process does not remain blocked.</p>
<p>In Linux versions before 2.6.11, the capacity of a pipe was the same as the <strong>system page size</strong> (e.g., 4096 bytes on i386).  Since Linux 2.6.11, the pipe capacity is <strong>16 pages</strong> (i.e., 65,536 bytes in a system with a page size of 4096 bytes).  Since Linux 2.6.35, the default pipe capacity is 16 pages, but the capacity can be queried and set using the fcntl(2) <code>F_GETPIPE_SZ</code> and <code>F_SETPIPE_SZ</code> operations.  See fcntl(2) for more information. The following ioctl(2) operation, which can be applied to a file descriptor that refers to either end of a pipe, places a count of the number of unread bytes in the pipe in the int buffer pointed to by the final argument of the call:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ioctl(fd, FIONREAD, &amp;nbytes);</div></pre></td></tr></table></figure>
<p>The FIONREAD operation is not specified in any standard, but is provided on many implementations.</p>
<hr>
<p>参考: </p>
<ul>
<li><a href="http://man7.org/linux/man-pages/man7/pipe.7.html" target="_blank" rel="external">http://man7.org/linux/man-pages/man7/pipe.7.html</a></li>
</ul>
<h3 id="Linux-零拷贝"><a href="#Linux-零拷贝" class="headerlink" title="Linux 零拷贝"></a>Linux 零拷贝</h3><p><strong>“Zero-copy”</strong> describes computer operations in which the CPU does not perform the task of copying data from one memory area to another. This is frequently used to <strong>save CPU cycles and memory bandwidth</strong> when transmitting a file over a network. Also, zero-copy operations reduce the number of time-consuming mode switches between user space and kernel space. <strong>减少用户空间和内核空间的切换</strong></p>
<hr>
<p><strong>不用 Zero Copy 的问题所在</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">read(file, tmp_buf, len);</div><div class="line">write(socket, tmp_buf, len);</div></pre></td></tr></table></figure>
<p>Looks simple enough; you would think there is not much overhead with only those two system calls. In reality, this couldn’t be further from the truth. Behind those two calls, the data has been copied at least four times <strong>数据至少拷贝 4 次</strong>, and almost as many user/kernel context switches have been performed. (Actually this process is much more complicated, but I wanted to keep it simple). To get a better idea of the process involved, take a look at Figure 1. The top side shows context switches, and the bottom side shows copy operations.</p>
<p><img src="6345f1.jpg" alt=""></p>
<p><strong>1) 第一步</strong>: the <code>read</code> system call causes a context switch <strong>上下文切换</strong> from user mode to kernel mode. The first copy is performed by the DMA engine, which reads file contents from the disk and stores them into a kernel address space buffer <strong>DMA 从磁盘拷贝到内核缓冲区</strong>.</p>
<p><strong>2) 第二步</strong>: data is copied from the kernel buffer into the user buffer <strong>数据从内核缓冲区拷贝到用户缓冲区</strong>, and the <code>read</code> system call returns. The return from the call caused a context switch from kernel back to user mode. Now the data is stored in the user address space buffer, and it can begin its way down again.</p>
<p><strong>3) 第三步</strong>: the <code>write</code> system call causes a context switch <strong>上下文切换</strong> from user mode to kernel mode. A third copy is performed to put the data into a kernel address space buffer again. This time, though, the data is put into a different buffer, a buffer that is associated with sockets specifically.</p>
<p><strong>4) 第四步</strong>: the <code>write</code> system call returns, creating our fourth context switch. Independently and asynchronously, a fourth copy happens as the DMA engine <strong>DMA 引擎</strong> passes the data from the kernel buffer to the protocol engine. You are probably asking yourself, “What do you mean independently and asynchronously? Wasn’t the data transmitted before the call returned?” Call return, in fact, doesn’t guarantee transmission; it doesn’t even guarantee the start of the transmission. It simply means the Ethernet driver had free descriptors in its queue and has accepted our data for transmission. There could be numerous packets queued before ours. Unless the driver/hardware implements priority rings or queues, data is transmitted on a first-in-first-out basis. (The forked DMA copy in Figure 1 illustrates the fact that the last copy can be delayed).</p>
<p>As you can see, a lot of data duplication is not really necessary <strong>不是特别有必要</strong> to hold things up. Some of the duplication could be eliminated to decrease overhead and increase performance. As a driver developer, I work with hardware that has some pretty advanced features. Some hardware can bypass the main memory altogether and transmit data directly to another device. This feature eliminates a copy in the system memory and is a nice thing to have, but not all hardware supports it. There is also the issue of the data from the disk having to be repackaged for the network, which introduces some complications. To eliminate overhead, we could start by eliminating some of the copying between the kernel and user buffers <strong>取消一些内核和用户空间的拷贝</strong>.</p>
<hr>
<p>One way to eliminate a copy is to <strong>跳过</strong> calling <code>read</code> and instead call <code>mmap</code>. For example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tmp_buf = mmap(file, len);</div><div class="line">write(socket, tmp_buf, len);</div></pre></td></tr></table></figure>
<p>To get a better idea of the process involved, take a look at Figure 2. Context switches remain the same.</p>
<p><img src="6345f2.jpg" alt=""></p>
<p><strong>1) 第一步</strong>: the <code>mmap</code> system call causes the file contents to be copied into a kernel buffer by the DMA engine. The buffer is shared then with the user process <strong>缓冲区同时被内核和用户区共享</strong>, without any copy being performed between the kernel and user memory spaces.</p>
<p><strong>2) 第二步</strong>: the <code>write</code> system call causes the kernel to copy the data from the original kernel buffers into the kernel buffers associated with sockets.</p>
<p><strong>3) 第三步</strong>: the third copy happens as the DMA engine passes the data from the kernel socket buffers to the protocol engine.</p>
<p>By using <code>mmap</code> instead of <code>read</code>, we’ve cut in half the amount of data the kernel has to copy. This yields reasonably good results when a lot of data is being transmitted. However, this improvement doesn’t come without a price; there are hidden pitfalls <strong>缺点</strong> when using the <code>mmap+write</code> method. You will fall into one of them when you memory map a file and then call write while another process <strong>其他进程截断</strong> truncates the same file. Your <code>write</code> system call will be interrupted by the bus error <strong>BUS 错误</strong> signal <code>SIGBUS</code>, because you performed a bad memory access <strong>坏内存访问</strong>. The default behavior for that signal is to kill the process and dump core—not the most desirable operation for a network server. There are two ways to get around this problem.</p>
<p>The first way is to install a signal handler for the <code>SIGBUS</code> signal, and then simply call return in the handler. By doing this the <code>write</code> system call returns with the number of bytes it wrote <strong>已经写的字节数</strong> before it got interrupted and the errno set to success. Let me point out that this would be a bad solution, one that treats the symptoms and not the cause of the problem. Because <code>SIGBUS</code> signals that something has gone seriously wrong with the process, I would discourage using this as a solution.</p>
<p>The second solution involves file leasing <strong>文件租赁</strong> (which is called “opportunistic locking” in Microsoft Windows) from the kernel. This is the correct way to fix this problem. By using leasing on the file descriptor, you take a lease <strong>租约</strong> with the kernel on a particular file. You then can request a <code>read/write</code> lease from the kernel. When another process tries to truncate the file you are transmitting, the kernel sends you a real-time signal, the <code>RT_SIGNAL_LEASE</code> signal. It tells you the kernel is breaking <strong>毁约</strong> your <code>write</code> or <code>read</code> lease on that file. Your <code>write</code> call is interrupted <strong><code>write</code> 提前被打断</strong> before your program accesses an invalid address and gets killed by the <code>SIGBUS</code> signal. The return value of the <code>write</code> call is the number of bytes written before the interruption, and the errno will be set to success. Here is some sample code that shows how to get a lease from the kernel:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(fcntl(fd, F_SETSIG, RT_SIGNAL_LEASE) == <span class="number">-1</span>) &#123;</div><div class="line">    perror(<span class="string">"kernel lease set signal"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/* l_type can be F_RDLCK F_WRLCK */</span></div><div class="line"><span class="keyword">if</span>(fcntl(fd, F_SETLEASE, l_type))&#123;</div><div class="line">    perror(<span class="string">"kernel lease set type"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You should get your lease before mmaping the file, and break your lease after you are done. This is achieved by calling <code>fcntl F_SETLEASE</code> with the lease type of <code>F_UNLCK</code>.</p>
<hr>
<p>In kernel version 2.1, the <code>sendfile</code> system call was introduced to simplify the transmission of data <strong>简化数据传输</strong> over the network and between two local files. Introduction of <code>sendfile</code> not only reduces data copying, it also reduces context switches. Use it like this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sendfile(socket, file, len);</div></pre></td></tr></table></figure>
<p>To get a better idea of the process involved, take a look at Figure 3.</p>
<p><img src="6345f3.jpg" alt=""></p>
<p><strong>1) 第一步</strong>: the <code>sendfile</code> system call causes the file contents to be copied into a kernel buffer by the DMA engine. Then the data is copied by the kernel into the kernel buffer associated with sockets.</p>
<p><strong>2) 第二步</strong>: the third copy happens as the DMA engine passes the data from the kernel socket buffers to the protocol engine.</p>
<p>You are probably wondering what happens if another process truncates the file we are transmitting with the <code>sendfile</code> system call. If we don’t register any signal handlers, the sendfile call simply returns with the number of bytes it transferred before it got interrupted, and the errno will be set to success.</p>
<p>If we get a lease from the kernel on the file before we call <code>sendfile</code>, however, the behavior and the return status are exactly the same. We also get the <code>RT_SIGNAL_LEASE</code> signal before the <code>sendfile</code> call returns.</p>
<p>So far, we have been able to avoid having the kernel make several copies, but we are still left with one copy. Can that be avoided too? Absolutely, with a little help from the hardware. To eliminate all the data duplication done by the kernel, we need a network interface that supports gather operations <strong>网卡支持 <code>gather</code> 操作</strong>. This simply means that data awaiting transmission doesn’t need to be in consecutive memory <strong>数据不用放在连续内存中</strong>; it can be scattered <strong>可以被聚合</strong> through various memory locations. In kernel version 2.4, the socket buffer descriptor was modified to accommodate those requirements—what is known as zero copy <strong>零拷贝</strong> under Linux. This approach not only reduces multiple context switches, it also eliminates data duplication done by the processor. For user-level applications nothing has changed, so the code still looks like this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sendfile(socket, file, len);</div></pre></td></tr></table></figure>
<p>To get a better idea of the process involved, take a look at Figure 4.</p>
<p><img src="6345f4.jpg" alt=""></p>
<p><strong>1) 第一步</strong>: the <code>sendfile</code> system call causes the file contents to be copied into a kernel buffer by the DMA engine.</p>
<p><strong>2) 第二步</strong>: no data is copied into the socket buffer. Instead, only descriptors with information about the whereabouts and length of the data are appended to the socket buffer. The DMA engine passes data directly from the kernel buffer to the protocol engine <strong>DMA 直接将数据从内核区传参给协议引擎</strong>, thus eliminating the remaining final copy.</p>
<p>Because data still is actually copied from the disk to the memory and from the memory to the wire, some might argue this is not a true zero copy. This is zero copy from the operating system standpoint, though, because the data is not duplicated between kernel buffers. When using zero copy, other performance benefits can be had besides copy avoidance, such as fewer context switches <strong>更少的上下文切换</strong>, less CPU data cache pollution <strong>更少的 CPU 缓存污染</strong> and no CPU checksum calculations <strong>CPU 不用计算校验</strong>.</p>
<p>Now that we know what zero copy is, let’s put theory into practice and write some code. You can download the full source code from <a href="www.xalien.org/articles/source/sfl-src.tgz">www.xalien.org/articles/source/sfl-src.tgz</a>. To unpack the source code, type <code>tar -zxvf sfl-src.tgz</code> at the prompt. To compile the code and create the random data file <code>data.bin</code>, run <code>make</code>.</p>
<p>Looking at the code starting with header files:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* sfl.c sendfile example program</span></div><div class="line"><span class="comment">Dragan Stancevic &lt;</span></div><div class="line"><span class="comment">header name                 function / variable</span></div><div class="line"><span class="comment">-------------------------------------------------*/</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;          /* printf, perror */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;          /* open */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;         /* close */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;          /* errno */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;         /* memset */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;     /* socket */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;     /* sockaddr_in */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sendfile.h&gt;   /* sendfile */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;      /* inet_addr */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFF_SIZE (10*1024) <span class="comment">/* size of the tmp</span></span></div><div class="line"><span class="meta"><span class="comment">                               buffer */</span></span></div></pre></td></tr></table></figure>
<p>Besides the regular <code>&lt;sys/socket.h&gt;</code> and <code>&lt;netinet/in.h&gt;</code> required for basic socket operation, we need a prototype definition of the <code>sendfile</code> system call. This can be found in the <code>&lt;sys/sendfile.h&gt;</code> server flag:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* are we sending or receiving */</span></div><div class="line"><span class="keyword">if</span>(argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'s'</span>) is_server++;</div><div class="line"><span class="comment">/* open descriptors */</span></div><div class="line">sd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line"><span class="keyword">if</span>(is_server) fd = open(<span class="string">"data.bin"</span>, O_RDONLY);</div></pre></td></tr></table></figure>
<p>The same program can act as either a server/sender or a client/receiver. We have to check one of the command-prompt parameters, and then set the flag <code>is_server</code> to run in sender mode. We also open a stream socket of the INET protocol family. As part of running in server mode we need some type of data to transmit to a client, so we open our data file. We are using the system call <code>sendfile</code> to transmit data, so <strong>we don’t have to read the actual contents of the file and store it in our program memory buffer</strong>. Here’s the server address:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* clear the memory */</span></div><div class="line"><span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_in));</div><div class="line"><span class="comment">/* initialize structure */</span></div><div class="line">sa.sin_family = PF_INET;</div><div class="line">sa.sin_port = htons(<span class="number">1033</span>);</div><div class="line">sa.sin_addr.s_addr = inet_addr(argv[<span class="number">2</span>]);</div></pre></td></tr></table></figure>
<p>We clear the server address structure and assign the protocol family, port and IP address of the server. The address of the server is passed as a command-line parameter. The port number is hard coded to unassigned port 1033. This port number was chosen because it is above the port range requiring root access to the system.</p>
<p>Here is the server execution branch:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(is_server)&#123;</div><div class="line">    <span class="keyword">int</span> client; <span class="comment">/* new client socket */</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Server binding to [%s]\n"</span>, argv[<span class="number">2</span>]);</div><div class="line">    <span class="keyword">if</span>(bind(sd, (struct sockaddr *)&amp;sa,</div><div class="line">                      <span class="keyword">sizeof</span>(sa)) &lt; <span class="number">0</span>)&#123;</div><div class="line">        perror(<span class="string">"bind"</span>);</div><div class="line">        <span class="built_in">exit</span>(errno);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>As a server, we need to assign an address to our socket descriptor. This is achieved by the system call <code>bind</code>, which assigns the socket descriptor (sd) a server address (sa):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(listen(sd,<span class="number">1</span>) &lt; <span class="number">0</span>)&#123;</div><div class="line">    perror(<span class="string">"listen"</span>);</div><div class="line">    <span class="built_in">exit</span>(errno);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Because we are using a stream socket, we have to advertise our willingness to accept incoming connections and set the connection queue size. I’ve set the backlog queue to 1, but it is common to set the backlog a bit higher for established connections waiting to be accepted. In older versions of the kernel, the backlog queue <strong>backlog 队列</strong> was used to prevent syn flood attacks <strong>防止 SYN 洪泛攻击</strong>. Because the system call listen changed to set parameters for only established connections, the backlog queue feature has been deprecated for this call. The kernel parameter <code>tcp_max_syn_backlog</code> has taken over the role of protecting the system from syn flood attacks:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>((client = accept(sd, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>)&#123;</div><div class="line">    perror(<span class="string">"accept"</span>);</div><div class="line">    <span class="built_in">exit</span>(errno);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The system call accept creates a new connected socket from the first connection request on the pending connections queue. The return value from the call is a descriptor for a newly created connection; the socket is now ready for read, write or <code>poll/select</code> system calls:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>((cnt = sendfile(client,fd,&amp;off,</div><div class="line">                          BUFF_SIZE)) &lt; <span class="number">0</span>)&#123;</div><div class="line">    perror(<span class="string">"sendfile"</span>);</div><div class="line">    <span class="built_in">exit</span>(errno);</div><div class="line">&#125;</div><div class="line"><span class="built_in">printf</span>(<span class="string">"Server sent %d bytes.\n"</span>, cnt);</div><div class="line">close(client);</div></pre></td></tr></table></figure>
<p>A connection is established on the client socket descriptor, so we can start transmitting data to the remote system. We do this by calling the <code>sendfile</code> system call, which is prototyped under Linux in the following manner:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="keyword">ssize_t</span></div><div class="line">sendfile (<span class="keyword">int</span> __out_fd, <span class="keyword">int</span> __in_fd, <span class="keyword">off_t</span> *offset,</div><div class="line">          <span class="keyword">size_t</span> __count) __THROW;</div></pre></td></tr></table></figure>
<p>The first two parameters are file descriptors. The third parameter points to an offset from which sendfile should start sending data. The fourth parameter is the number of bytes we want to transmit. In order for the sendfile transmit to use zero-copy functionality, you need memory gather operation support from your networking card. You also need checksum capabilities for protocols that implement checksums, such as TCP or UDP. If your NIC is outdated and doesn’t support <strong>如果不支持</strong> those features, you still can use sendfile to transmit files. The difference is the kernel will merge the buffers <strong>内核在传送之前合并缓冲区</strong> before transmitting them.</p>
<hr>
<p>Portability Issues <strong>移植问题</strong>:</p>
<p>One of the problems with the <code>sendfile</code> system call, in general, is the lack of a standard implementation, as there is for the open system call. <code>Sendfile</code> implementations in Linux, Solaris or HP-UX are quite different. This poses a problem for developers who wish to use zero copy in their network data transmission code.</p>
<p>One of the implementation differences is Linux provides a <code>sendfile</code> that defines an interface for transmitting data between two file descriptors (<strong>file-to-file</strong>) and (<strong>file-to-socket</strong>). HP-UX and Solaris, on the other hand, can be used only for file-to-socket submissions.</p>
<p>The second difference is Linux doesn’t implement vectored transfers. Solaris sendfile and HP-UX sendfile have extra parameters that eliminate overhead associated with prepending headers to the data being transmitted.</p>
<hr>
<p>Looking Ahead</p>
<p>The implementation of zero copy under Linux is far from finished and is likely to change in the near future. More functionality should be added. For example, the <code>sendfile</code> call doesn’t support vectored transfers <strong>不支持矢量传输</strong>, and servers such as Samba and Apache have to use multiple sendfile calls with the <code>TCP_CORK</code> flag set. This flag tells the system more data is coming through in the next sendfile calls. <code>TCP_CORK</code> also is incompatible with <code>TCP_NODELAY</code> and is used when we want to prepend or append headers to the data. This is a perfect example of where a vectored call would eliminate the need for multiple <code>sendfile</code> calls <strong>需要多个 <code>sendfile</code> 调用</strong> and delays mandated by the current implementation.</p>
<p>One rather unpleasant limitation in the current <code>sendfile</code> is it cannot be used when transferring files greater than 2GB <strong>不能超过 2GB</strong>. Files of such size are not all that uncommon today, and it’s rather disappointing having to duplicate all that data on its way out. Because both <code>sendfile</code> and <code>mmap</code> methods are unusable in this case, a <code>sendfile64</code> would be really handy in a future kernel version.</p>
<hr>
<p><strong>编程访问</strong>:</p>
<p>The Linux kernel supports zero-copy through various system calls, such as <code>sys/socket.h</code>‘s <code>sendfile</code>, <code>sendfile64</code>, and <code>splice</code>. Some of them are specified in POSIX and thus also present in the BSD kernels or IBM AIX, some are unique to the Linux kernel API.</p>
<p>Java input streams can support zero-copy through the <code>java.nio.channels.FileChannel</code>‘s <strong><code>transferTo()</code></strong> method if the underlying operating system also supports zero copy.</p>
<hr>
<p>参考:</p>
<ul>
<li><a href="http://www.linuxjournal.com/article/6345" target="_blank" rel="external">Zero Copy I: User-Mode Perspective</a></li>
</ul>
<h3 id="Linux-的内核同步"><a href="#Linux-的内核同步" class="headerlink" title="Linux 的内核同步"></a>Linux 的内核同步</h3><hr>
<p>参考:</p>
<ul>
<li><a href="https://www.ibm.com/developerworks/library/l-linux-synchronization/index.html" target="_blank" rel="external">https://www.ibm.com/developerworks/library/l-linux-synchronization/index.html</a></li>
</ul>
<h3 id="写复制"><a href="#写复制" class="headerlink" title="写复制"></a>写复制</h3><p><strong>Copy-on-write in 虚拟内存管理</strong>:</p>
<p>Copy-on-write finds its main use in <strong>共享虚拟内存</strong> of operating system processes, in the implementation of the <strong><code>fork</code> 系统调用</strong>. Typically, the process does not modify any memory and immediately executes a new process, replacing the address space entirely. Thus, it would be wasteful to copy all of the process’s memory <strong>拷贝所有内存是机器浪费的</strong> during a fork, and instead the copy-on-write technique is used. It can be implemented efficiently using the page table <strong>页表</strong> by marking certain pages of memory as read-only and keeping a count of the number of references to the page. When data is written to these pages, the kernel intercepts the write attempt and allocates a new physical page <strong>拦截写操作，并分配新的物理页</strong>, initialized with the copy-on-write data, although the allocation can be skipped if there is only one reference. The kernel then updates the page table with the new (writable) page, decrements the number of references, and performs the write. The new allocation ensures that a change in the memory of one process is not visible in another’s. The copy-on-write technique can be extended to support efficient memory allocation by having a page of physical memory filled with zeros. When the memory is allocated, all the pages returned refer to the page of zeros and are all marked copy-on-write. This way, physical memory is not allocated for the process until data is written, allowing processes to reserve more virtual memory than physical memory and use memory sparsely, at the risk of running out of virtual address space. The combined algorithm is similar to demand paging.</p>
<p>Copy-on-write pages are also used in the Linux kernel’s kernel same-page merging feature.</p>
<p><img src="slide_29.jpg" alt=""></p>
<h3 id="poll-vs-epoll-vs-select-区别和各自使用场景-epoll-和-select-底层使用的数据结构"><a href="#poll-vs-epoll-vs-select-区别和各自使用场景-epoll-和-select-底层使用的数据结构" class="headerlink" title="poll vs epoll vs select 区别和各自使用场景, epoll 和 select 底层使用的数据结构"></a><code>poll</code> vs <code>epoll</code> vs <code>select</code> 区别和各自使用场景, <code>epoll</code> 和 <code>select</code> 底层使用的数据结构</h3><p>When designing a high performance networking application with <strong>非阻塞</strong> socket I/O, the architect needs to decide which polling method to use to monitor the events generated by those sockets. There are several such methods, and the use cases for each of them are different. Choosing the correct method may be critical to satisfy the application needs.</p>
<h4 id="1-Polling-with-select"><a href="#1-Polling-with-select" class="headerlink" title="(1) Polling with select()"></a>(1) Polling with <code>select()</code></h4><p>Old, trusted workforce from the times the sockets were still called Berkeley sockets. It didn’t make it into the first specification though since there were <strong>还没有非阻塞 I/O 的概念</strong> of non-blocking I/O at that moment, but it did make it around <strong>八十年代</strong>, and nothing changed since that in its interface.</p>
<p>To use select, the developer needs to initialize and fill up several <code>fd_set</code> structures with the descriptors and the events to monitor, and then call <code>select()</code>. A typical workflow looks like that:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">fd_set fd_in, fd_out;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></div><div class="line"> </div><div class="line"><span class="comment">// Reset the sets</span></div><div class="line">FD_ZERO( &amp;fd_in );</div><div class="line">FD_ZERO( &amp;fd_out );</div><div class="line"> </div><div class="line"><span class="comment">// Monitor sock1 for input events</span></div><div class="line">FD_SET( sock1, &amp;fd_in );</div><div class="line"> </div><div class="line"><span class="comment">// Monitor sock2 for output events</span></div><div class="line">FD_SET( sock2, &amp;fd_out );</div><div class="line"> </div><div class="line"><span class="comment">// Find out which socket has the largest numeric value as select requires it</span></div><div class="line"><span class="keyword">int</span> largest_sock = sock1 &gt; sock2 ? sock1 : sock2;</div><div class="line"> </div><div class="line"><span class="comment">// Wait up to 10 seconds</span></div><div class="line">tv.tv_sec = <span class="number">10</span>;</div><div class="line">tv.tv_usec = <span class="number">0</span>;</div><div class="line"> </div><div class="line"><span class="comment">// Call the select</span></div><div class="line"><span class="keyword">int</span> ret = select( largest_sock + <span class="number">1</span>, &amp;fd_in, &amp;fd_out, <span class="literal">NULL</span>, &amp;tv );</div><div class="line"> </div><div class="line"><span class="comment">// Check if select actually succeed</span></div><div class="line"><span class="keyword">if</span> ( ret == <span class="number">-1</span> )</div><div class="line">    <span class="comment">// report error and abort</span></div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( ret == <span class="number">0</span> )</div><div class="line">    <span class="comment">// timeout; no event detected</span></div><div class="line"><span class="keyword">else</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> ( FD_ISSET( sock1, &amp;fd_in ) )</div><div class="line">        <span class="comment">// input event on sock1</span></div><div class="line"> </div><div class="line">    <span class="keyword">if</span> ( FD_ISSET( sock2, &amp;fd_out ) )</div><div class="line">        <span class="comment">// output event on sock2</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>When the select interface was designed and developed, nobody probably expected there would be multi-threaded applications serving many thousands connections. Hence select carries quite a few <strong>设计缺陷</strong> which make it undesirable as a polling mechanism in the modern networking application. The major disadvantages include:</p>
<ul>
<li>select modifies the passed <code>fd_sets</code> so <strong>无法重用</strong>. Even if you don’t need to change anything – such as if one of descriptors received data and needs to receive more data – a whole set <strong>整个 set</strong> has to be either recreated again (argh!) or restored from a backup copy via <code>FD_COPY</code>. And this has to be done each time the select is called.</li>
<li>To find out which descriptors raised the events you have to manually iterate <strong>遍历</strong> through all the descriptors in the set and call <code>FD_ISSET</code> on each one of them. When you have 2,000 of those descriptors and only one of them is active – and, likely, the last one – you’re wasting CPU cycles each time you wait.</li>
<li>Did I just mention 2,000 descriptors? Well, select cannot support that much <strong>文件描述符受限</strong>. At least on Linux. The maximum number of the supported descriptors is defined by the <code>FD_SETSIZE</code> constant, which Linux happily defines as 1024. And while some operating systems allow you to hack this restriction by redefining the <code>FD_SETSIZE</code> before including the <code>sys/select.h</code>, this is not portable. Indeed, Linux would just ignore this hack and the limit will stay the same.</li>
<li>You cannot modify the descriptor set <strong>无法修改描述符集</strong> from a different thread <strong>从不同线程中</strong> while waiting. Suppose a thread is executing the code above. Now suppose you have a housekeeping thread which decided that sock1 has been waiting too long for the input data, and it is time to cut the cord. Since this socket could be reused to serve another paying working client, the housekeeping thread wants to close the socket. However the socket is in the <code>fd_set</code> which select is waiting for. Now what happens when this socket is closed? man select has the answer, and you won’t like it. The answer is, “If a file descriptor being monitored by <code>select()</code> is closed in another thread, the result is unspecified”.</li>
<li>Same problem arises if another thread suddenly decides to send something via sock1. It is not possible to start monitoring the socket for the output event until select returns.</li>
<li>The choice of the events to wait for is limited; <strong>能检测的事件类型有限</strong> for example, to detect whether the remote socket is closed you have to a) monitor it for input and b) actually attempt to read the data from socket to detect the closure (read will return 0). Which is fine if you want to read from this socket, but what if you’re sending a file and do not care about any input right now?</li>
<li>select puts extra burden on you when filling up the descriptor list to calculate the largest descriptor number and provide it as a function parameter.</li>
</ul>
<p>Of course the operating system developers recognized those drawbacks and addressed most of them when designing the <code>poll</code> method. Therefore you may ask, is there is any reason to use select at all? <strong>还有没有使用 <code>select</code> 的理由？</strong> Why don’t just store it in the shelf of the Computer Science Museum? Then you may be pleased to know that yes, there are two reasons <strong>两个理由</strong>, which may be either very important to you or not important at all.</p>
<p>The first reason is portability <strong>移植性</strong>. select has been around for ages, and you can be sure that every single platform around which has network support and nonblocking sockets will have a working select implementation while it might not have poll at all. And unfortunately I’m not talking about the tubes and ENIAC here; <strong><code>poll</code></strong> is only available on <strong>Windows Vista</strong> and above which includes Windows XP – still used by the whooping 34% of users as of Sep 2013 despite the Microsoft pressure. Another option would be to still use <code>poll</code> on those platforms and emulate it with select on those which do not have it; it is up to you whether you consider it reasonable investment.</p>
<p>The second reason is more exotic, and is related to the fact that select can – theoretically – handle the timeouts <strong>超时</strong> withing the one nanosecond <strong>纳秒精度</strong> precision, while both <code>poll</code> and <code>epoll</code> can only handle the one millisecond precision. This is not likely to be a concern on a desktop or server system, which clocks doesn’t even run with such precision, but it may be necessary on a realtime embedded platform <strong>嵌入式平台</strong> while interacting with some hardware components. Such as lowering control rods to shut down a nuclear reactor – in this case, please, use select to make sure we’re all stay safe!</p>
<p>The case above would probably be the only case where you would have to use select and could not use anything else. However if you are writing an application which would never have to handle more than a handful of sockets (like, 200), the difference between using poll and select would not be based on performance, but more on personal preference or other factors.</p>
<h4 id="2-Polling-with-poll"><a href="#2-Polling-with-poll" class="headerlink" title="(2) Polling with poll()"></a>(2) Polling with poll()</h4><p><code>poll</code> is a newer polling method which probably was created immediately after someone actually tried to write the high performance networking server. It is much better designed and doesn’t suffer from most of the problems which select has. In the vast majority of cases you would be choosing between <code>poll</code> and <code>epoll/libevent</code>.</p>
<p>To use <code>poll</code>, the developer needs to initialize the members of <code>struct pollfd</code> structure with the descriptors and events to monitor, and call the <code>poll()</code>. A typical workflow looks like that:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// The structure for two events</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span>[2];</span></div><div class="line"> </div><div class="line"><span class="comment">// Monitor sock1 for input</span></div><div class="line">fds[<span class="number">0</span>].fd = sock1;</div><div class="line">fds[<span class="number">0</span>].events = POLLIN;</div><div class="line"> </div><div class="line"><span class="comment">// Monitor sock2 for output</span></div><div class="line">fds[<span class="number">1</span>].fd = sock2;</div><div class="line">fds[<span class="number">1</span>].events = POLLOUT;</div><div class="line"> </div><div class="line"><span class="comment">// Wait 10 seconds</span></div><div class="line"><span class="keyword">int</span> ret = poll( &amp;fds, <span class="number">2</span>, <span class="number">10000</span> );</div><div class="line"><span class="comment">// Check if poll actually succeed</span></div><div class="line"><span class="keyword">if</span> ( ret == <span class="number">-1</span> )</div><div class="line">    <span class="comment">// report error and abort</span></div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( ret == <span class="number">0</span> )</div><div class="line">    <span class="comment">// timeout; no event detected</span></div><div class="line"><span class="keyword">else</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// If we detect the event, zero it out so we can reuse the structure</span></div><div class="line">    <span class="keyword">if</span> ( pfd[<span class="number">0</span>].revents &amp; POLLIN )</div><div class="line">        pfd[<span class="number">0</span>].revents = <span class="number">0</span>;</div><div class="line">        <span class="comment">// input event on sock1</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( pfd[<span class="number">1</span>].revents &amp; POLLOUT )</div><div class="line">        pfd[<span class="number">1</span>].revents = <span class="number">0</span>;</div><div class="line">        <span class="comment">// output event on sock2</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>poll</code> was mainly created to fix <strong>修复</strong> the pending problems <code>select</code> had, so it has the following advantages over it:</p>
<ul>
<li>There is no hard limit on the number of descriptors poll can monitor, so the limit of 1024 does not apply here.</li>
<li>It does not modify <strong>不修改</strong> the data passed in the struct pollfd data. Therefore it could be reused between the <code>poll()</code> calls as long as set to zero the revents member for those descriptors which generated the events. The IEEE specification states that “In each pollfd structure, <code>poll()</code> shall clear the revents member, except that where the application requested a report on a condition by setting one of the bits of events listed above, <code>poll()</code> shall set the corresponding bit in revents if the requested condition is true“. However in my experience at least one platform did not follow this recommendation, and <code>man 2 poll</code> on Linux does not make such guarantee either (<code>man 3p poll</code> does though).</li>
<li>It allows more fine-grained control of events comparing to select. For example, it can detect remote peer shutdown <strong>检测远程关闭</strong> without monitoring for read events.</li>
</ul>
<p>There are a few disadvantages as well, which were mentioned above at the end of the select section. Notably, <code>poll</code> is not present on <strong>Microsoft Windows older than Vista</strong>; on Vista and above it is called <code>WSAPoll</code> although the prototype is the same, and it could be defined as simply as:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined (WIN32)</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">poll</span><span class="params">( struct pollfd *pfd, <span class="keyword">int</span> nfds, <span class="keyword">int</span> timeout)</span> </span>&#123; <span class="keyword">return</span> WSAPoll ( pfd, nfds, timeout ); &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<p>And, as mentioned above, poll timeout has the 1ms precision <strong>毫秒精度</strong>, which again is very unlikely to be a concern in most scenarios. Nevertheless poll still has a few issues <strong>仍然有一些问题</strong> which need to be kept in mind:</p>
<ul>
<li>Like select, it is still not possible to find out which descriptors have the events triggered without iterating through the whole list and checking the revents <strong>仍然需要遍历</strong>. Worse, the same happens in the kernel space as well, as the kernel has to iterate through the list of file descriptors to find out which sockets are monitored, and iterate through the whole list again to set up the events.</li>
<li>Like select, it is not possible to dynamically modify the set <strong>无法动态修改集合</strong> or close the socket which is being polled <strong>无法关闭正在 <code>polled</code> 的 <code>socket</code></strong> (see above).</li>
</ul>
<p>Please keep in mind, however, that those issues might be considered unimportant for most client networking applications – the only exception would be client software such as <strong>P2P</strong> which may require handling of thousands of open connections. Those issues might not be important even for some server applications. Therefore poll should be your default choice over select unless you have specific reasons mentioned above. More, poll should be your preferred method even over <code>epoll</code> if the following is true:</p>
<ul>
<li>You need to support more than just Linux <strong>支持更多操作系统</strong>, and do not want to use epoll wrappers such as libevent (epoll is Linux only);</li>
<li>Your application needs to monitor less than 1000 sockets <strong>一次监控小于 1000 个 <code>sockets</code></strong> at a time (you are not likely to see any benefits from using epoll);</li>
<li>Your application needs to monitor more than 1000 sockets at a time, but the connections are very short-lived <strong>都是短连接</strong> (this is a close case, but most likely in this scenario you are not likely to see any benefits from using epoll because the speedup in event waiting would be wasted on adding those new descriptors into the set – see below)</li>
<li>Your application is not designed the way that it changes the events while another thread is waiting for them (i.e. you’re not porting an app using <code>kqueue</code> or IO Completion Ports).</li>
</ul>
<h4 id="3-Polling-with-epoll"><a href="#3-Polling-with-epoll" class="headerlink" title="(3) Polling with epoll()"></a>(3) Polling with epoll()</h4><p><code>epoll</code> is the latest, greatest, newest polling method in Linux (and only Linux <strong>只有 <code>Linux</code></strong>). Well, it was actually added to kernel in 2002, so it is not so new. It differs both from <code>poll</code> and <code>select</code> in such a way that it keeps the information about the currently monitored descriptors and associated events inside the kernel, and exports the API to <code>add/remove/modify</code> those.</p>
<p>To use <code>epoll</code>, much more preparation is needed. A developer needs to:</p>
<ul>
<li><strong>创建</strong> the epoll descriptor by calling <code>epoll_create</code>;</li>
<li><strong>初始化</strong> the <code>struct epoll</code> structure with the wanted events <strong>事件</strong> and the context data pointer <strong>上下文数据指针</strong>. Context could be anything, epoll passes this value directly to the returned events structure. We store there a pointer to our Connection class.</li>
<li>Call <code>epoll_ctl( … EPOLL_CTL_ADD )</code> to <strong>添加</strong> the descriptor into the monitoring set</li>
<li>Call <code>epoll_wait()</code> to wait for 20 events for which we reserve the storage space. Unlike previous methods, this call receives an empty structure, and fills it up only with the triggered events. For example, if there are 200 descriptors and 5 of them have events pending, the <code>epoll_wait</code> will return 5, and only the first five members of the pevents structure will be initialized. If 50 descriptors have events pending, the first 20 would be copied and 30 would be left in queue, they won’t get lost.</li>
<li><strong>遍历</strong> through the returned items. This will be a short iteration since the only events returned are those which are triggered.</li>
</ul>
<p>A typical workflow looks like that:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create the epoll descriptor. Only one is needed per app, and is used to monitor all sockets.</span></div><div class="line"><span class="comment">// The function argument is ignored (it was not before, but now it is), so put your favorite number here</span></div><div class="line"><span class="keyword">int</span> pollingfd = epoll_create( <span class="number">0xCAFE</span> ); </div><div class="line"></div><div class="line"><span class="keyword">if</span> ( pollingfd &lt; <span class="number">0</span> )</div><div class="line"> <span class="comment">// report error</span></div><div class="line"></div><div class="line"><span class="comment">// Initialize the epoll structure in case more members are added in future</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span> = &#123;</span> <span class="number">0</span> &#125;;</div><div class="line"></div><div class="line"><span class="comment">// Associate the connection class instance with the event. You can associate anything</span></div><div class="line"><span class="comment">// you want, epoll does not use this information. We store a connection class pointer, pConnection1</span></div><div class="line">ev.data.ptr = pConnection1;</div><div class="line"></div><div class="line"><span class="comment">// Monitor for input, and do not automatically rearm the descriptor after the event</span></div><div class="line">ev.events = EPOLLIN | EPOLLONESHOT;</div><div class="line"><span class="comment">// Add the descriptor into the monitoring list. We can do it even if another thread is </span></div><div class="line"><span class="comment">// waiting in epoll_wait - the descriptor will be properly added</span></div><div class="line"><span class="keyword">if</span> ( epoll_ctl( epollfd, EPOLL_CTL_ADD, pConnection1-&gt;getSocket(), &amp;ev ) != <span class="number">0</span> )</div><div class="line">    <span class="comment">// report error</span></div><div class="line"></div><div class="line"><span class="comment">// Wait for up to 20 events (assuming we have added maybe 200 sockets before that it may happen)</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">pevents</span>[ 20 ];</span></div><div class="line"></div><div class="line"><span class="comment">// Wait for 10 seconds</span></div><div class="line"><span class="keyword">int</span> ready = epoll_wait( pollingfd, pevents, <span class="number">20</span>, <span class="number">10000</span> );</div><div class="line"><span class="comment">// Check if epoll actually succeed</span></div><div class="line"><span class="keyword">if</span> ( ret == <span class="number">-1</span> )</div><div class="line">    <span class="comment">// report error and abort</span></div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( ret == <span class="number">0</span> )</div><div class="line">    <span class="comment">// timeout; no event detected</span></div><div class="line"><span class="keyword">else</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Check if any events detected</span></div><div class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ret; i++ )</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> ( pevents[i].events &amp; EPOLLIN )</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Get back our connection pointer</span></div><div class="line">            Connection * c = (Connection*) pevents[i].data.ptr;</div><div class="line">            c-&gt;handleReadEvent();</div><div class="line">         &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Just looking at the implementation alone should give you the hint of what are the disadvantages of <code>epoll</code>, which we will mention firs. It is more complex to use <strong>更加复杂</strong>, and requires you to write more code <strong>更多代码</strong>, and it requires more library calls comparing to other polling methods.</p>
<p>However <code>epoll</code> has some significant advantages <strong>更大优势</strong> over <code>select/poll</code> both in terms of performance and functionality:</p>
<ul>
<li><code>epoll</code> returns only the list of descriptors which triggered the events <strong>只返回触发事件的描述符</strong>. No need to iterate through 10,000 descriptors anymore to find that one which triggered the event!</li>
<li>You can attach meaningful context <strong>附加有意义的上下文</strong> to the monitored event instead of socket file descriptors. In our example we attached the class pointers which could be called directly, saving you another lookup.</li>
<li>You can add sockets or remove them from monitoring anytime <strong>任意添加/删除</strong>, even if another thread is in the <code>epoll_wait</code> function. You can even modify the descriptor events. Everything will work properly, and this behavior is supported and documented. This gives you much more flexibility in implementation.</li>
<li>Since the kernel knows all the monitoring descriptors, it can register the events happening on them even when nobody is calling <code>epoll_wait</code>. This allows implementing interesting features such as edge triggering, which will be described in a separate article.</li>
<li>It is possible to have the multiple threads waiting <strong>多线程等待</strong> on the same <code>epoll</code> queue with <code>epoll_wait()</code>, something you cannot do with <code>select/poll</code>. In fact it is not only possible with <code>epoll</code>, but the recommended method in the edge triggering mode.</li>
</ul>
<p>However you need to keep in mind that <strong>epoll is not a “better poll”</strong>, and it also has <strong>缺点</strong> when comparing to poll:</p>
<ul>
<li>Changing the event flags (i.e. from READ to WRITE) requires the <code>epoll_ctl</code> syscall, while when using poll this is a simple <strong>bitmask operation</strong> done entirely in <strong>userspace</strong>. Switching 5,000 sockets from reading to writing with epoll would require 5,000 syscalls and hence context switches <strong>上下文切换</strong> (as of 2014 calls to <code>epoll_ctl</code> still  could not be batched, and each descriptor must be changed separately), while in poll it would require a single loop over the <code>pollfd</code> structure.</li>
<li>Each <code>accept()</code>ed socket needs to be added to the set, and same as above, with <code>epoll</code> it has to be done by calling <code>epoll_ctl</code> – which means there are two required syscalls <strong>每个连接需要两个系统调用</strong> per new connection socket instead of one for <code>poll</code>. If your server has many short-lived connections which send or receive little traffic, <code>epoll</code> will likely take longer than poll to serve them.</li>
<li><code>epoll</code> is exclusively Linux domain, and while other platforms have similar mechanisms, they are not exactly the same – edge triggering, for example, is pretty unique (FreeBSD’s kqueue supports it too though).</li>
<li>High performance processing logic is more complex and hence more difficult to debug <strong>难以调试</strong>, especially for edge triggering which is prone to deadlocks if you miss extra read/write.</li>
</ul>
<p>Therefore you should only use epoll if all following is true:</p>
<ul>
<li>Your application runs a thread poll which handles many network connections by a handful of threads <strong>多线程</strong>. You would lose most of epoll benefits in a single-threaded application, and most likely it won’t outperform poll.</li>
<li>You expect to have a reasonably large number of sockets <strong>大量的</strong> to monitor (at least 1,000); with a smaller number epoll is not likely to have any performance benefits over poll and may actually worse the performance;</li>
<li>Your connections are relatively long-lived <strong>生命周期长</strong>; as stated above <code>epoll</code> will be slower than poll in a situation when a new connection sends a few bytes of data and immediately disconnects because of extra system call required to add the descriptor into epoll set;</li>
<li>Your app depends on other Linux-specific features (so in case portability question would suddenly pop up, epoll wouldn’t be the only roadblock), or you can provide wrappers for other supported systems. In the last case you should strongly consider libevent.</li>
</ul>
<p>If all the items above aren’t true, you should be better served by using poll instead.</p>
<h4 id="4-Polling-with-libevent"><a href="#4-Polling-with-libevent" class="headerlink" title="(4) Polling with libevent"></a>(4) Polling with libevent</h4><p><a href="http://libevent.org/" target="_blank" rel="external">libebent</a> is a library which wraps the polling methods listed in this article (and some others) in an uniform API.Its main advantage is that it allows you to write the code once and compile and run it on many operating systems without the need to change the code <strong>各个操作系统兼容性</strong>. It is important to understand that libevent it is just a wrapper built on top of the existing polling methods, and therefore it inherits the issues those polling methods have. It will not make select supporting more than 1024 sockets on Linux or allow epoll to modify the polling events without a syscall/context switch. Therefore it is still important to understand each method’s pros and cons.</p>
<p>Having to provide access to the functionality from the dramatically different methods, libevent has a rather complex API which is much more difficult to use than poll or even epoll. It is however easier to use libevent than to write two separate backends if you need to support FreeBSD (epoll and kqueue). Hence it is a viable alternative which should be considered if:</p>
<ul>
<li>Your application requirements indicate that you must use <code>epoll</code>, and using just <code>poll</code> would not be enough (if poll would satisfy your needs, it is extremely unlikely libevent would offer you any benefits)</li>
<li>You need to support other OS than Linux, or may expect such need to arise in future. Again, this depends on other features of your application – if it is tied up to many other Linux-specific things you’re not going to achieve anything by using libevent instead of <code>epoll</code>.</li>
</ul>
<hr>
<p>参考</p>
<ul>
<li><a href="https://www.ulduzsoft.com/2014/01/select-poll-epoll-practical-difference-for-system-architects/" target="_blank" rel="external">select / poll / epoll: practical difference for system architects</a></li>
</ul>
<h3 id="libevent-实现，IO-定时-信号事件如何集成统一"><a href="#libevent-实现，IO-定时-信号事件如何集成统一" class="headerlink" title="libevent 实现，IO + 定时 + 信号事件如何集成统一"></a><code>libevent</code> 实现，IO + 定时 + 信号事件如何集成统一</h3><h3 id="PPA"><a href="#PPA" class="headerlink" title="PPA"></a>PPA</h3><p>A <strong>Personal Package Archive (PPA)</strong> is a software repository for uploading source packages to be built and published as an <strong>Advanced Packaging Tool (APT)</strong> repository by Launchpad.</p>
<h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -xvf filename.tar.xz</div></pre></td></tr></table></figure>
<h3 id="目录结构问题"><a href="#目录结构问题" class="headerlink" title="目录结构问题"></a>目录结构问题</h3><p><code>/usr/lib/x86_64-linux-gnu</code> is <code>/usr/lib64</code>, This changed when Ubuntu 12.04 came out.</p>
<h3 id="包搜索问题"><a href="#包搜索问题" class="headerlink" title="包搜索问题"></a>包搜索问题</h3><p>使用 <code>apt search</code> 来搜索包，有的时候示例文档提示的需要的依赖，可能并不精确:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt search libaio</div></pre></td></tr></table></figure>
<h3 id="man-问题"><a href="#man-问题" class="headerlink" title="man 问题"></a><code>man</code> 问题</h3><p>查看第 8 节:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">man 8 apt-get</div></pre></td></tr></table></figure>
<p>通过这个可以了解到，平常 <code>apt-get</code> 后面跟的 <code>-y</code> 选项代表的是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-y, --yes, --assume-yes</div><div class="line">           Automatic yes to prompts; assume &quot;yes&quot; as answer to all prompts and run</div><div class="line">           non-interactively. If an undesirable situation, such as changing a held package,</div><div class="line">           trying to install a unauthenticated package or removing an essential package occurs</div><div class="line">           then apt-get will abort.</div></pre></td></tr></table></figure>
<h3 id="如何只在文件夹不存在的情况下才创建文件夹"><a href="#如何只在文件夹不存在的情况下才创建文件夹" class="headerlink" title="如何只在文件夹不存在的情况下才创建文件夹"></a>如何只在文件夹不存在的情况下才创建文件夹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir -p crawler/<span class="built_in">log</span></div></pre></td></tr></table></figure>
<h3 id="telnet-的正确使用方法"><a href="#telnet-的正确使用方法" class="headerlink" title="telnet 的正确使用方法"></a><code>telnet</code> 的正确使用方法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">telnet 10.108.112.218 1099</div></pre></td></tr></table></figure>
<p><code>telnet</code> 可以连接到任何 <strong>TCP</strong> 服务器，包括 <strong>HTTP</strong> 服务器:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">zk@zk-pc:~/Documents$ telnet www.kunzhao.org 80</div><div class="line">Trying 59.110.168.119...</div><div class="line">Connected to www.kunzhao.org.</div><div class="line">Escape character is <span class="string">'^]'</span>.</div><div class="line">GET / HTTP/1.1 &lt;- 输入这行</div><div class="line">&lt;- 输入回车行</div><div class="line">HTTP/1.1 200 OK &lt;- 服务器开始返回内容</div><div class="line">X-Powered-By: Hexo</div><div class="line">Content-Type: text/html</div><div class="line">Date: Mon, 11 Sep 2017 01:37:21 GMT</div><div class="line">Connection: keep-alive</div><div class="line">Transfer-Encoding: chunked</div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="切换为-root-用户的正确操作"><a href="#切换为-root-用户的正确操作" class="headerlink" title="切换为 root 用户的正确操作"></a>切换为 <code>root</code> 用户的正确操作</h3><p>The root account is <strong>disabled by default</strong> in Ubuntu, so there is <strong>no root password</strong>, that’s why <code>su</code> fails with an authentication error.</p>
<p>Use <code>sudo -i</code> to become root:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">zk@zk-pc:~/Documents$ su root</div><div class="line">Password: </div><div class="line">su: Authentication failure</div><div class="line">zk@zk-pc:~/Documents$ sudo -i</div><div class="line">root@zk-pc:~<span class="comment">#</span></div></pre></td></tr></table></figure>
<h3 id="Ubuntu-设置启动项菜单引导"><a href="#Ubuntu-设置启动项菜单引导" class="headerlink" title="Ubuntu 设置启动项菜单引导"></a><code>Ubuntu</code> 设置启动项菜单引导</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository ppa:danielrichter2007/grub-customizer</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install grub-customizer</div></pre></td></tr></table></figure>
<h3 id="Ubuntu-卸载其它系统"><a href="#Ubuntu-卸载其它系统" class="headerlink" title="Ubuntu 卸载其它系统"></a><code>Ubuntu</code> 卸载其它系统</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository ppa:yannubuntu/boot-repair</div><div class="line">sudo apt-get update; sudo apt-get install -y os-uninstaller &amp;&amp; os-uninstaller</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://help.ubuntu.com/community/OS-Uninstaller" target="_blank" rel="external">OS-Uninstaller</a></li>
</ul>
<h3 id="get-full-path-of-original-file-of-a-soft-symbolic-link"><a href="#get-full-path-of-original-file-of-a-soft-symbolic-link" class="headerlink" title="get full path of original file of a soft symbolic link"></a>get full path of original file of a soft symbolic link</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">readlink -f `<span class="built_in">which</span> emacs`</div></pre></td></tr></table></figure>
<h3 id="make-a-soft-symbolic-link"><a href="#make-a-soft-symbolic-link" class="headerlink" title="make a soft symbolic link"></a>make a soft symbolic link</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/bin</div><div class="line">sudo ln -s /usr/lib/intellij_idea/idea-IC-172.3968.16/bin/idea.sh idea</div></pre></td></tr></table></figure>
<h3 id="mount"><a href="#mount" class="headerlink" title="mount"></a><code>mount</code></h3><p><strong>1) Determine what device a directory is located on</strong>:</p>
<p>Use <code>df -h</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">zk@zk-pc:/dev$ df -h /media/zk/Documents/</div><div class="line">Filesystem      Size  Used Avail Use% Mounted on</div><div class="line">/dev/sda3       209G   17G  192G   9% /media/zk/Documents</div></pre></td></tr></table></figure>
<p><strong>2) Unmount</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">umount Documents/</div></pre></td></tr></table></figure>
<p>必须等待不忙的时候再 <code>umount</code>，否则会出现如下错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">zk@zk-pc:/media/zk$ umount Documents/</div><div class="line">Error unmounting block device 8:3: GDBus.Error:org.freedesktop.UDisks2.Error.DeviceBusy: Error unmounting /dev/sda3: Command-line `umount  &quot;/media/zk/Documents&quot;&apos; exited with non-zero exit status 32: umount: /media/zk/Documents: target is busy</div><div class="line">        (In some cases useful info about processes that</div><div class="line">         use the device is found by lsof(8) or fuser(1).)</div></pre></td></tr></table></figure>
<p><strong>3) Mount</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /media/zk</div><div class="line">sudo mkdir Documents/ <span class="comment"># 必须先创建文件夹</span></div><div class="line">sudo mount /dev/sda3 Documents</div></pre></td></tr></table></figure>
<h3 id="必备软件"><a href="#必备软件" class="headerlink" title="必备软件"></a>必备软件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 分区软件</span></div><div class="line">sudo apt install gparted</div><div class="line"></div><div class="line"><span class="comment"># 截屏软件</span></div><div class="line">sudo add-apt-repository ppa:shutter/ppa</div><div class="line">sudo apt-get update &amp;&amp; sudo apt-get install shutter</div><div class="line"></div><div class="line"><span class="comment"># 办公软件 http://community.wps.cn/download/</span></div><div class="line"></div><div class="line"><span class="comment"># PDF 阅读软件 https://www.foxitsoftware.cn/downloads/</span></div></pre></td></tr></table></figure>
<p><strong>1) Shutter 配置</strong>:</p>
<p>禁止掉原来的截屏快捷键:</p>
<p><img src="2017_08_30_13_30_14.png" alt=""></p>
<p>添加 <code>Shutter</code> 截屏快捷键:</p>
<p><img src="2017_08_30_13_32_32.png" alt=""></p>
<p>配置 <code>Shutter</code> 截屏后的文件名，自动拷贝路径等:</p>
<p><img src="2017_08_30_13_34_18.png" alt=""></p>
<h3 id="获得文件信息"><a href="#获得文件信息" class="headerlink" title="获得文件信息"></a>获得文件信息</h3><p><strong>1) 显示文件路径</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dirname <span class="variable">$file</span></div></pre></td></tr></table></figure>
<p><strong>2) 显示文件名</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">basename <span class="variable">$file</span></div></pre></td></tr></table></figure>
<h3 id="隐藏活动记录"><a href="#隐藏活动记录" class="headerlink" title="隐藏活动记录"></a>隐藏活动记录</h3><ul>
<li><a href="https://askubuntu.com/questions/29559/how-can-i-keep-recent-files-from-appearing-in-unity" target="_blank" rel="external">How can I keep recent files from appearing in Unity?</a></li>
</ul>
<h3 id="安装-QQ"><a href="#安装-QQ" class="headerlink" title="安装 QQ"></a>安装 <code>QQ</code></h3><ul>
<li><a href="http://blog.csdn.net/ysy950803/article/details/52958538" target="_blank" rel="external">教你如何在Ubuntu上安装最新版QQ</a></li>
</ul>
<h3 id="Windows-硬盘安装-Ubuntu"><a href="#Windows-硬盘安装-Ubuntu" class="headerlink" title="Windows 硬盘安装 Ubuntu"></a>Windows 硬盘安装 Ubuntu</h3><ul>
<li>下载安装 <code>EasyBCD</code>:</li>
</ul>
<p><img src="easybcd.png" alt=""></p>
<ul>
<li>进行配置，内容如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># NeoSmart NeoGrub Bootloader Configuration File</div><div class="line">#</div><div class="line"># This is the NeoGrub configuration file, and should be located at C:\NST\menu.lst</div><div class="line"># Please see the EasyBCD Documentation for information on how to create/modify entries:</div><div class="line"># http://neosmart.net/wiki/display/EBCD/</div><div class="line"></div><div class="line">title Install Ubuntu</div><div class="line">root (hd0,0)</div><div class="line">kernel (hd0,0)/vmlinuz.efi boot=casper iso-scan/filename=/ubuntu-16.04.3-desktop-amd64.iso ro quiet splash locale=zh_CN.UTF-8</div><div class="line">initrd (hd0,0)/initrd.lz</div><div class="line">title reboot</div><div class="line">reboot</div><div class="line">title halt</div><div class="line">halt</div></pre></td></tr></table></figure>
<ul>
<li>解压 <code>ubuntu.iso</code> 提取两个文件:</li>
</ul>
<p><img src="uncompress_ubuntu_iso.png" alt=""></p>
<ul>
<li>将三个重要文件放到 <code>C</code> 盘目录:</li>
</ul>
<p><img src="c_files.png" alt=""></p>
<ul>
<li>重新启动，进入 <code>Ubuntu 引导启动加载</code>，进行安装</li>
</ul>
<hr>
<p>参考:</p>
<ul>
<li><a href="http://blog.sina.com.cn/s/blog_4618a6280102vhwy.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_4618a6280102vhwy.html</a></li>
<li><a href="https://zhidao.baidu.com/question/512380327.html" target="_blank" rel="external">https://zhidao.baidu.com/question/512380327.html</a></li>
</ul>
<h3 id="openssh-server"><a href="#openssh-server" class="headerlink" title="openssh-server"></a>openssh-server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install openssh-server</div><div class="line">sudo ufw allow 22</div><div class="line">sudo iptables -L</div><div class="line">sudo iptables -A INPUT -p tcp --dport ssh -j ACCEPT</div></pre></td></tr></table></figure>
<h3 id="Windows-行结尾符转为-UNIX-结尾符"><a href="#Windows-行结尾符转为-UNIX-结尾符" class="headerlink" title="Windows 行结尾符转为 UNIX 结尾符"></a>Windows 行结尾符转为 UNIX 结尾符</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo apt install dos2unix</div><div class="line"><span class="comment"># Replace all CR from all lines, in place operation.</span></div><div class="line">dos2unix file.txt</div><div class="line"><span class="comment"># To save the output in a different file</span></div><div class="line">dos2unix -n file.txt output.txt</div></pre></td></tr></table></figure>
<h3 id="Ubuntu-引导项重新扫描"><a href="#Ubuntu-引导项重新扫描" class="headerlink" title="Ubuntu 引导项重新扫描"></a>Ubuntu 引导项重新扫描</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo update-grub</div></pre></td></tr></table></figure>
<h3 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h3><p>不要 <code>.git</code> 文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip -r bitvolution.zip bitvolution -x \*.git\*</div></pre></td></tr></table></figure>
<h3 id="添加新的用户"><a href="#添加新的用户" class="headerlink" title="添加新的用户"></a>添加新的用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 创建用户</span></div><div class="line">sudo useradd -d /home/tom -m tom -s /bin/bash</div><div class="line"></div><div class="line"><span class="comment"># 设置密码</span></div><div class="line">sudo passwd tom</div><div class="line"></div><div class="line"><span class="comment"># 添加 sudo 权限</span></div><div class="line">sudo adduser tom sudo</div></pre></td></tr></table></figure>
<h3 id="Linux-上安装虚拟机"><a href="#Linux-上安装虚拟机" class="headerlink" title="Linux 上安装虚拟机"></a>Linux 上安装虚拟机</h3><p>应该搜索的是 <code>virtualbox</code> 而不是 <code>vmware</code>，另外也需要 <a href="https://www.askvg.com/download-free-windows-xp-vista-and-windows-7-vhd-image-files-for-microsoft-virtual-pc/" target="_blank" rel="external"><code>Windows 32bit vhd</code></a> 文件才行</p>
<h3 id="Linux-修改组"><a href="#Linux-修改组" class="headerlink" title="Linux 修改组"></a>Linux 修改组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 添加一个组 zk</span></div><div class="line">sudo groupadd zk</div><div class="line"><span class="comment"># 组下面添加一个用户</span></div><div class="line">sudo usermod -a -G zk zk</div><div class="line"><span class="comment"># 改变文件组</span></div><div class="line">chgrp zk sample_file.txt </div><div class="line">chgrp -R zk sample_folder/</div><div class="line"><span class="comment"># 查看一个用户属于哪些组</span></div><div class="line">groups zk</div><div class="line"><span class="comment"># 查看 primary group</span></div><div class="line">id -g zk</div><div class="line"><span class="comment"># 改变用户分组</span></div><div class="line">usermod -g primaryGroupName zk</div></pre></td></tr></table></figure>
<p><img src="Selection_001.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 修改 Group Owner</span></div><div class="line">chgrp zk file.txt</div><div class="line"><span class="comment"># 修改 Owner</span></div><div class="line">chown zk file.txt</div></pre></td></tr></table></figure>
<p><img src="2017_10_30_10_21_17.png" alt=""></p>
<h3 id="循环所有文件"><a href="#循环所有文件" class="headerlink" title="循环所有文件"></a>循环所有文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="built_in">echo</span> `basename <span class="variable">$file</span>`<span class="string">"\t"</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<h3 id="合并所有文件"><a href="#合并所有文件" class="headerlink" title="合并所有文件"></a>合并所有文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat * &gt; merged-file</div></pre></td></tr></table></figure>
<h3 id="tmux"><a href="#tmux" class="headerlink" title="tmux"></a><code>tmux</code></h3><p>创建一个新的会话:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tmux new -s &lt;name-of-my-session&gt;</div></pre></td></tr></table></figure>
<p>重新返回先前开启的会话:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tmux a -t &lt;name-of-my-session&gt;</div></pre></td></tr></table></figure>
<p>断开会话，返回到桌面:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Ctrl-b d</div></pre></td></tr></table></figure>
<p>关闭会话:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tmux <span class="built_in">kill</span>-session -t &lt;name-of-my-session&gt;</div></pre></td></tr></table></figure>
<p>注意，在 <code>tmux</code> 会话里面的话，如果输入 <code>exit</code> 的话，会直接杀死并退出。</p>
<h3 id="ftp"><a href="#ftp" class="headerlink" title="ftp"></a><code>ftp</code></h3><p><strong>连接</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ftp 10.108.118.176 2121</div></pre></td></tr></table></figure>
<p><strong>本地文件传输到手机上</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">put /home/zk/Desktop/xxx.pdf ./xxx.pdf</div></pre></td></tr></table></figure>
<blockquote>
<p>注意，这个地方<strong>必须指明</strong>要传输的文件在手机端的<strong>文件名字</strong></p>
</blockquote>
<p><strong>断开连接</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">bye</span></div></pre></td></tr></table></figure>
<p>可以使用 <code>ls</code>, <code>cd</code>, <code>pwd</code> 等命令在手机的目录上来回切换。</p>
<hr>
<p><strong>想要显示进度条，请使用 <code>ncftp</code></strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt install ncftp</div><div class="line">ncftp -P 2121 10.108.112.24</div><div class="line">put /home/zk/Desktop/xxx.pdf ./</div></pre></td></tr></table></figure>
<h3 id="unzip-乱码问题"><a href="#unzip-乱码问题" class="headerlink" title="unzip 乱码问题"></a><code>unzip</code> 乱码问题</h3><p><img src="2017_11_19_15_16_09.png" alt=""></p>
<p>使用 <code>unzip -O GBK xxx.zip</code> 命令即可</p>
<h3 id="进入-MySQL-日志目录"><a href="#进入-MySQL-日志目录" class="headerlink" title="进入 MySQL 日志目录"></a>进入 <code>MySQL</code> 日志目录</h3><p><img src="2017_11_22_22_57_50.png" alt=""></p>
<p>这个时候执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo su -</div></pre></td></tr></table></figure>
<p>就可以进来。</p>
<h3 id="split-以及-merge"><a href="#split-以及-merge" class="headerlink" title="split 以及 merge"></a><code>split</code> 以及 <code>merge</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 大文件切割为小文件</span></div><div class="line"><span class="comment"># 将会生成 WinXP_img_aa</span></div><div class="line"><span class="comment"># 将会生成 WinXP_img_ab</span></div><div class="line">split --bytes=2048m WinXP.img WinXP_img_</div><div class="line"></div><div class="line"><span class="comment"># 小文件合并成大文件</span></div><div class="line">cat WinXP_img_a* WinXP.img</div></pre></td></tr></table></figure>
<h3 id="计算文件的-MD5-大小"><a href="#计算文件的-MD5-大小" class="headerlink" title="计算文件的 MD5 大小"></a>计算文件的 <code>MD5</code> 大小</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">md5sum xxx.iso</div></pre></td></tr></table></figure>
<h3 id="查询-DNS"><a href="#查询-DNS" class="headerlink" title="查询 DNS"></a>查询 <code>DNS</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nmcli device show eno1 | grep IP4.DNS</div></pre></td></tr></table></figure>
<h3 id="解决-bash-乱码问题"><a href="#解决-bash-乱码问题" class="headerlink" title="解决 bash 乱码问题"></a>解决 <code>bash</code> 乱码问题</h3><p>在 <code>~/.bashrc</code> 里面加入:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> LANG=<span class="string">'UTC-8'</span></div><div class="line"><span class="built_in">export</span> LC_ALL=<span class="string">'en_US.UTF-8'</span></div></pre></td></tr></table></figure>
<p>在本地和登录到服务器输入 <code>locale</code> 回车会显示下面内容:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">LANG=en_US.UTF-8</div><div class="line">LANGUAGE=en_US</div><div class="line">LC_CTYPE=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_NUMERIC=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_TIME=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_COLLATE=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_MONETARY=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_MESSAGES=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_PAPER=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_NAME=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_ADDRESS=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_TELEPHONE=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_MEASUREMENT=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_IDENTIFICATION=<span class="string">"en_US.UTF-8"</span></div><div class="line">LC_ALL=en_US.UTF-8</div></pre></td></tr></table></figure>
<h3 id="Ubuntu-自建热点问题"><a href="#Ubuntu-自建热点问题" class="headerlink" title="Ubuntu 自建热点问题"></a>Ubuntu 自建热点问题</h3><p>要创建一个热点，<strong>必须有无线网卡</strong>，且该网卡支持<code>AP</code>模式，具体可以用如下命令查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install iw</div><div class="line">iw list</div></pre></td></tr></table></figure>
<p>如果出现如下包含<code>AP</code>的关键字，则表示支持<code>AP</code>模式：</p>
<p><img src="20170513210537410.png" alt="AP"></p>
<p><code>ubuntu</code>下使用<code>networkmanger</code>可以很方便的建立<code>ad-hoc</code>的<code>wifi</code>热点。。但是<code>android</code>默认不支持<code>ad-hoc</code>的<code>wifi</code>。</p>
<p>安装下面这个软件可以将 <code>ad-hoc</code> 模式改为 <code>access-point</code> 模式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install plasma-nm</div><div class="line">kde5-nm-connection-editor</div></pre></td></tr></table></figure>
<p>这样 Android 手机就可以识别了。</p>
<h3 id="tcpdump-命令"><a href="#tcpdump-命令" class="headerlink" title="tcpdump 命令"></a><code>tcpdump</code> 命令</h3><p>抓取 <code>TCP</code> 报文段:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo tcpdump -ntx -i eth0 port 54321</div></pre></td></tr></table></figure>
<h3 id="获取刚刚运行的-Java-进程-ID"><a href="#获取刚刚运行的-Java-进程-ID" class="headerlink" title="获取刚刚运行的 Java 进程 ID"></a>获取刚刚运行的 <code>Java</code> 进程 ID</h3><p>If the starting is automated by a shell script, you can write the pid of the just-started-process which is in the variable <code>$!</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">java ...... &amp;</div><div class="line"><span class="built_in">echo</span> <span class="string">"$!"</span> &gt; myjavaprogram.pid</div></pre></td></tr></table></figure>
<p>When you need to kill it, just do:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">kill</span> `cat myjavaprogram.pid`</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.tutorialspoint.com/unix/unix-regular-expressions.htm" target="_blank" rel="external">Unix - Regular Expressions with SED</a></li>
<li><a href="http://www.linfo.org/echo.html" target="_blank" rel="external">The echo Command</a></li>
<li><a href="http://www.cs.toronto.edu/~krueger/csc209h/tut/line-endings.html" target="_blank" rel="external">DOS vs. Unix Line Endings</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/05/22/play-with-linux/" data-id="cjcdlsgsa0074diemb4ohzmn4" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-frontend-dev" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/05/22/frontend-dev/" class="article-date">
  <time datetime="2017-05-22T03:38:58.000Z" itemprop="datePublished">2017-05-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/05/22/frontend-dev/">Front-End Developer Skills</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Front-End-Developer-Skills"><a href="#Front-End-Developer-Skills" class="headerlink" title="Front End Developer Skills"></a>Front End Developer Skills</h2><h3 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h3><h4 id="1-去除重复元素"><a href="#1-去除重复元素" class="headerlink" title="1. 去除重复元素"></a>1. 去除重复元素</h4><p><strong><code>native way</code></strong> 实现:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">uniqueArray = array.filter(<span class="function"><span class="keyword">function</span>(<span class="params">item, pos</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> array.indexOf( item ) == pos;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><strong><code>underscore</code></strong> 实现:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> result = [];</div><div class="line">a.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">     <span class="keyword">if</span>(result.indexOf(item) &lt; <span class="number">0</span>) &#123;</div><div class="line">         result.push(item);</div><div class="line">     &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong><code>ES6</code></strong> 实现:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">uniq</span>(<span class="params">a</span>) </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="built_in">Array</span>.from(<span class="keyword">new</span> <span class="built_in">Set</span>(a));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="http://stackoverflow.com/questions/9229645/remove-duplicates-from-javascript-array" target="_blank" rel="external">参考 - stackoverflow</a></p>
<h4 id="2-Date"><a href="#2-Date" class="headerlink" title="2. Date"></a>2. Date</h4><table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Date.now()</code></td>
<td>返回自 1970 00:00:00 UTC 的<strong>毫秒数</strong></td>
</tr>
<tr>
<td><code>Date.parse(&#39;Thu, 01 Jan 1970 00:00:00 GMT-0400&#39;)</code></td>
<td>解析时间字符串</td>
</tr>
<tr>
<td><code>new Date( milliseconds )</code></td>
<td>使用毫秒构造 <code>Date</code> 对象</td>
</tr>
</tbody>
</table>
<h4 id="3-从-URL-提取参数"><a href="#3-从-URL-提取参数" class="headerlink" title="3. 从 URL 提取参数"></a>3. 从 URL 提取参数</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUrlParameter</span>(<span class="params">sParam</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> sPageURL = <span class="built_in">decodeURIComponent</span>(<span class="built_in">window</span>.location.search.substring(<span class="number">1</span>)),</div><div class="line">        sURLVariables = sPageURL.split(<span class="string">'&amp;'</span>),</div><div class="line">        sParameterName,</div><div class="line">        i;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sURLVariables.length; i++) &#123;</div><div class="line">        sParameterName = sURLVariables[i].split(<span class="string">'='</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (sParameterName[<span class="number">0</span>] === sParam) &#123;</div><div class="line">            <span class="keyword">return</span> sParameterName[<span class="number">1</span>] === <span class="literal">undefined</span> ? <span class="literal">true</span> : sParameterName[<span class="number">1</span>];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="4-滚动条位置"><a href="#4-滚动条位置" class="headerlink" title="4. 滚动条位置"></a>4. 滚动条位置</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$(<span class="built_in">window</span>).scroll(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> scroll = $(<span class="built_in">window</span>).scrollTop();</div><div class="line">    <span class="comment">// Do something</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="5-获取-Viewport-宽度和高度"><a href="#5-获取-Viewport-宽度和高度" class="headerlink" title="5. 获取 Viewport 宽度和高度"></a>5. 获取 Viewport 宽度和高度</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> w = <span class="built_in">Math</span>.max(<span class="built_in">document</span>.documentElement.clientWidth, <span class="built_in">window</span>.innerWidth || <span class="number">0</span>);</div><div class="line"><span class="keyword">var</span> h = <span class="built_in">Math</span>.max(<span class="built_in">document</span>.documentElement.clientHeight, <span class="built_in">window</span>.innerHeight || <span class="number">0</span>);</div><div class="line">jQuery( <span class="built_in">window</span> ).width(); <span class="comment">// height of browser viewport</span></div><div class="line">jQuery( <span class="built_in">window</span> ).height(); <span class="comment">// width of browser viewport</span></div></pre></td></tr></table></figure>
<p>返回 HTML document 的宽度和高度:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">jQuery(<span class="built_in">document</span>).height(); <span class="comment">// return height of HTML document</span></div><div class="line">jQuery(<span class="built_in">document</span>).width();  <span class="comment">// return width of HTML document</span></div></pre></td></tr></table></figure>
<ul>
<li><a href="https://stackoverflow.com/questions/1248081/get-the-browser-viewport-dimensions-with-javascript" target="_blank" rel="external">参考 - StackOverflow</a></li>
</ul>
<h4 id="6-String"><a href="#6-String" class="headerlink" title="6. String"></a>6. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/prototype" target="_blank" rel="external">String</a></h4><table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>charAt(index)</code></td>
<td>取得字符</td>
</tr>
<tr>
<td><code>includes(searchString, position)</code></td>
<td>字符串是否存在</td>
</tr>
<tr>
<td><code>startsWith(searchString, position)</code></td>
<td>以字符串开始</td>
</tr>
<tr>
<td><code>endsWith(searchString, position)</code></td>
<td>以字符串结尾</td>
</tr>
<tr>
<td><code>indexOf(searchValue, fromIndex)</code></td>
<td>返回首次出现的下标</td>
</tr>
<tr>
<td><code>match(regexp)</code></td>
<td>返回匹配的数组</td>
</tr>
<tr>
<td><code>split(string &#124; regular, limit)</code></td>
<td><code>limit</code> 用来限制切割的数量</td>
</tr>
<tr>
<td><code>substring(indexStart, indexEnd)</code></td>
<td>返回子字符串</td>
</tr>
<tr>
<td>`str.replace(regexp</td>
<td>substr, newSubstr</td>
<td>function)`</td>
<td>返回替换后的字符串</td>
</tr>
</tbody>
</table>
<h4 id="7-动态传递参数"><a href="#7-动态传递参数" class="headerlink" title="7. 动态传递参数"></a>7. 动态传递参数</h4><p>把一个数组中的所有值当做参数列表传递给一个函数:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> args = [ <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span> ];</div><div class="line"><span class="function"><span class="keyword">function</span>.<span class="title">apply</span>(<span class="params"> null, args </span>);</span></div><div class="line"><span class="function"><span class="title">function</span>(<span class="params"> ...args </span>); // <span class="title">ES6</span> <span class="title">Style</span></span></div></pre></td></tr></table></figure>
<p>将一个函数的所有参数列表当做一个数组来接受:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="built_in">arguments</span>.length; i++) &#123;</div><div class="line">        <span class="built_in">console</span>.log( <span class="built_in">arguments</span>[ i ] );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="jQuery"><a href="#jQuery" class="headerlink" title="jQuery"></a>jQuery</h3><h4 id="1-扩展-jQuery-Animation"><a href="#1-扩展-jQuery-Animation" class="headerlink" title="1. 扩展 jQuery Animation"></a>1. 扩展 jQuery Animation</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">$</span>) </span>&#123;</div><div class="line"></div><div class="line">    $.extend($.easing, &#123;</div><div class="line">        easeInQuart: <span class="function"><span class="keyword">function</span> (<span class="params">x, t, b, c, d</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> c*(t/=d)*t*t*t + b;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">&#125;)($);</div></pre></td></tr></table></figure>
<p><a href="http://gsgd.co.uk/sandbox/jquery/easing/" target="_blank" rel="external">参考</a></p>
<h4 id="2-jQuery-Loading-Bar"><a href="#2-jQuery-Loading-Bar" class="headerlink" title="2. jQuery Loading Bar"></a>2. jQuery Loading Bar</h4><ul>
<li><a href="http://ricostacruz.com/nprogress/" target="_blank" rel="external">NProgress.js</a></li>
</ul>
<h4 id="3-图标类"><a href="#3-图标类" class="headerlink" title="3. 图标类"></a>3. 图标类</h4><ul>
<li><a href="http://www.chartjs.org/" target="_blank" rel="external">Chart.js</a></li>
</ul>
<h4 id="4-DOM-操作"><a href="#4-DOM-操作" class="headerlink" title="4. DOM 操作"></a>4. DOM 操作</h4><table>
<thead>
<tr>
<th>方法</th>
<th>用法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://api.jquery.com/nth-child-selector/" target="_blank" rel="external">nth-child-selector</a></td>
<td><code>$( &quot;ul li:nth-child(2)&quot; )</code></td>
<td><strong>索引从 1 开始</strong></td>
</tr>
<tr>
<td><a href="https://api.jquery.com/eq/" target="_blank" rel="external">eq</a></td>
<td><code>$( &quot;li&quot; ).eq( 2 )</code></td>
<td><strong>索引从 0 开始</strong></td>
</tr>
</tbody>
</table>
<h4 id="5-Promise"><a href="#5-Promise" class="headerlink" title="5. Promise"></a>5. Promise</h4><p>模拟一个 <strong><code>Promise</code></strong> 操作:</p>
<p><img src="17-05-23-09_28_51_533_235.png" alt=""></p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://api.jquery.com/deferred.resolve/" target="_blank" rel="external">deferred.resolve( [args ] )</a></td>
<td>调用 <code>doneCallbacks</code></td>
</tr>
<tr>
<td><a href="https://api.jquery.com/deferred.reject/" target="_blank" rel="external">deferred.reject( [args] )</a></td>
<td>调用 <code>failCallbacks</code></td>
</tr>
<tr>
<td>deferred.then( doneFilter [, failFilter ] [, progressFilter ] )</td>
<td>当 resolved 或 rejected 后被调用</td>
</tr>
</tbody>
</table>
<p><a href="https://api.jquery.com/jquery.when/" target="_blank" rel="external">合并</a>多个 <code>Ajax</code> 请求:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$.when( $.ajax( <span class="string">"/page1.php"</span> ), $.ajax( <span class="string">"/page2.php"</span> ) ).done(function( a1, a2 ) &#123;</div><div class="line">  <span class="comment">// a1 and a2 are arguments resolved for the page1 and page2 ajax requests, respectively.</span></div><div class="line">  <span class="comment">// Each argument is an array with the following structure: [ data, statusText, jqXHR ]</span></div><div class="line">  var data = a1[ <span class="number">0</span> ] + a2[ <span class="number">0</span> ]; <span class="comment">// a1[ 0 ] = "Whip", a2[ 0 ] = " It"</span></div><div class="line">  <span class="keyword">if</span> ( /Whip It/.test( data ) ) &#123;</div><div class="line">    alert( <span class="string">"We got what we came for!"</span> );</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="6-Pagination"><a href="#6-Pagination" class="headerlink" title="6. Pagination"></a>6. Pagination</h4><ul>
<li><a href="http://esimakin.github.io/twbs-pagination/" target="_blank" rel="external">jQuery Pagination Plugin</a></li>
</ul>
<h4 id="7-window-resize"><a href="#7-window-resize" class="headerlink" title="7. window resize"></a>7. window resize</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$( window ).resize(<span class="function"><span class="title">function</span></span>() &#123;</div><div class="line">    $( <span class="string">"#log"</span> ).append( <span class="string">"&lt;div&gt;Handler for .resize() called.&lt;/div&gt;"</span> );</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="8-响应-Enter-Key"><a href="#8-响应-Enter-Key" class="headerlink" title="8. 响应 Enter Key"></a>8. 响应 Enter Key</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">"#id_of_textbox"</span>).keyup(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(event.keyCode == <span class="number">13</span>)&#123;</div><div class="line">        $(<span class="string">"#id_of_button"</span>).click();</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="9-时间格式化"><a href="#9-时间格式化" class="headerlink" title="9. 时间格式化"></a>9. 时间格式化</h4><ul>
<li><a href="https://momentjs.com/" target="_blank" rel="external">momentjs</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">moment.locale( <span class="string">'zh-cn'</span> );</div><div class="line">moment.unix( timestampInSeconds ).format( <span class="string">'L'</span> );</div></pre></td></tr></table></figure>
<h4 id="10-AMD"><a href="#10-AMD" class="headerlink" title="10. AMD"></a>10. AMD</h4><ul>
<li><a href="http://requirejs.org/" target="_blank" rel="external">requirejs</a></li>
<li><a href="http://browserify.org/" target="_blank" rel="external">Browserify</a></li>
</ul>
<h4 id="11-Fullpage-效果"><a href="#11-Fullpage-效果" class="headerlink" title="11. Fullpage 效果"></a>11. Fullpage 效果</h4><ul>
<li><a href="https://alvarotrigo.com/fullPage" target="_blank" rel="external">fullPage</a></li>
</ul>
<h4 id="12-轮播-slider-效果"><a href="#12-轮播-slider-效果" class="headerlink" title="12. 轮播 slider 效果"></a>12. 轮播 slider 效果</h4><ul>
<li><a href="https://github.com/jssor/slider" target="_blank" rel="external">jssor-slider</a></li>
<li><a href="https://github.com/bqworks/slider-pro" target="_blank" rel="external">slider-pro</a></li>
<li><a href="https://github.com/kenwheeler/slick" target="_blank" rel="external">slick</a></li>
<li><a href="http://excolo.github.io/Excolo-Slider/" target="_blank" rel="external">Excolo Slider</a></li>
</ul>
<h4 id="13-Ajax"><a href="#13-Ajax" class="headerlink" title="13. Ajax"></a>13. <a href="http://api.jquery.com/jquery.ajax/" target="_blank" rel="external">Ajax</a></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$</div><div class="line">    .ajax( &#123;</div><div class="line">        url: <span class="string">'url'</span>,</div><div class="line">        data: &#123; id: myDataId &#125;,</div><div class="line">        <span class="comment">// The type of data that you're expecting back from the server</span></div><div class="line">        <span class="comment">// Default: Intelligent Guess (xml, json, script, or html)</span></div><div class="line">        dataType: <span class="string">'html'</span>,</div><div class="line">        <span class="comment">// When sending data to the server, use this content type.</span></div><div class="line">        <span class="comment">// Default is "application/x-www-form-urlencoded; charset=UTF-8", which is fine for most cases</span></div><div class="line">        contentType: <span class="string">'application/x-www-form-urlencoded; charset=UTF-8'</span></div><div class="line">    &#125; )</div><div class="line">    .done( function( data, textStatus, jqXHR ) &#123;</div><div class="line">        </div><div class="line">    &#125; )</div><div class="line">    .fail( function( jqXHR, textStatus, errorThrown ) &#123;</div><div class="line">        </div><div class="line">    &#125; )</div></pre></td></tr></table></figure>
<h3 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h3><h4 id="1-居中-span-h1-h2-…"><a href="#1-居中-span-h1-h2-…" class="headerlink" title="1. 居中 span, h1, h2, …"></a>1. 居中 span, h1, h2, …</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 父元素 */</span></div><div class="line"><span class="selector-class">.parent</span> &#123;</div><div class="line">    <span class="attribute">text-align</span>: center;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-重置-a-标签默认样式"><a href="#2-重置-a-标签默认样式" class="headerlink" title="2. 重置 a 标签默认样式"></a>2. 重置 a 标签默认样式</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">a</span> &#123;</div><div class="line">    <span class="attribute">text-decoration</span>: none;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:hover</span>,</div><div class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:visited</span>,</div><div class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:active</span>,</div><div class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:link</span>,</div><div class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:focus</span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-去除-input-默认样式"><a href="#3-去除-input-默认样式" class="headerlink" title="3. 去除 input 默认样式"></a>3. 去除 input 默认样式</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">input</span><span class="selector-pseudo">:focus</span> &#123;</div><div class="line">    <span class="attribute">outline</span>: none;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-父元素无法正确计算设置了-float-的子元素"><a href="#4-父元素无法正确计算设置了-float-的子元素" class="headerlink" title="4. 父元素无法正确计算设置了 float 的子元素"></a>4. 父元素无法正确计算设置了 float 的子元素</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 父元素添加 clearfix */</span></div><div class="line"><span class="selector-class">.clearfix</span><span class="selector-pseudo">::after</span> &#123;</div><div class="line">    <span class="attribute">content</span>: <span class="string">" "</span>;</div><div class="line">    <span class="attribute">display</span>: block; </div><div class="line">    <span class="attribute">height</span>: <span class="number">0</span>; </div><div class="line">    <span class="attribute">clear</span>: both;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="5-fixed"><a href="#5-fixed" class="headerlink" title="5. fixed"></a>5. fixed</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 一定要设置 top: 0px */</span></div><div class="line"><span class="selector-tag">nav</span><span class="selector-class">.fixed</span> &#123;</div><div class="line">    <span class="attribute">position</span>: fixed;</div><div class="line">    <span class="attribute">top</span>: <span class="number">0px</span>;</div><div class="line">    <span class="attribute">z-index</span>: <span class="number">123</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="6-居中-Div"><a href="#6-居中-Div" class="headerlink" title="6. 居中 Div"></a>6. 居中 Div</h4><p><strong>水平居中</strong>:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 设置子元素宽度很重要 */</span></div><div class="line"><span class="selector-id">#inner</span> &#123;</div><div class="line">    <span class="attribute">width</span>: <span class="number">50%</span>;</div><div class="line">    <span class="attribute">margin</span>: <span class="number">0</span> auto;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>垂直居中</strong>:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">div</span><span class="selector-class">.outer-div</span> &#123;</div><div class="line">    <span class="attribute">height</span>: <span class="number">170px</span>;</div><div class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</div><div class="line">    <span class="attribute">background-color</span>: lightgray;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">div</span><span class="selector-class">.inner-div</span> &#123;</div><div class="line">    <span class="attribute">position</span>: relative;</div><div class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</div><div class="line">    <span class="attribute">-webkit-transform</span>: <span class="built_in">translateY</span>(-50%);</div><div class="line">    <span class="attribute">-ms-transform</span>: <span class="built_in">translateY</span>(-50%);</div><div class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-50%);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>flex 居中</strong>:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.outer</span> &#123;</div><div class="line">    <span class="attribute">display</span>: -webkit-flex;</div><div class="line">    <span class="attribute">display</span>: flex;</div><div class="line">    <span class="attribute">align-items</span>: center;</div><div class="line">    <span class="attribute">justify-content</span>: center;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参考: </p>
<ul>
<li><a href="http://www.sketchingwithcss.com/samplechapter/cheatsheet.html" target="_blank" rel="external">Sketching CSS</a></li>
<li><a href="https://css-tricks.com/snippets/css/a-guide-to-flexbox/" target="_blank" rel="external">A Complete Guide to Flexbox</a></li>
</ul>
<h4 id="7-span-margin"><a href="#7-span-margin" class="headerlink" title="7. span margin"></a>7. span margin</h4><p>向 <code>span</code> 上设置 <code>margin-top, margin-bottom</code> 是不管用的，必须设定为 <code>block</code> 系列的样式:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">span</span> &#123;</div><div class="line">    <span class="attribute">display</span>: block;</div><div class="line">    <span class="attribute">display</span>: inline-block;</div><div class="line">    <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="8-修改-span-为单行显示"><a href="#8-修改-span-为单行显示" class="headerlink" title="8. 修改 span 为单行显示"></a>8. 修改 span 为单行显示</h4><p>不用 <code>span</code>，用 <code>p</code> 来代替:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">p</span> &#123;</div><div class="line">    <span class="attribute">white-space</span>: nowrap;</div><div class="line">    <span class="attribute">text-overflow</span>: ellipsis;</div><div class="line">    <span class="attribute">overflow</span>: hidden;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="9-图片全屏"><a href="#9-图片全屏" class="headerlink" title="9. 图片全屏"></a>9. 图片全屏</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">min-width</span>: 100%;</div><div class="line"><span class="selector-tag">min-height</span>: 100%;</div></pre></td></tr></table></figure>
<p>这篇<a href="https://css-tricks.com/perfect-full-page-background-image/" target="_blank" rel="external">文章</a>写得非常好</p>
<h4 id="10-图片维持比例"><a href="#10-图片维持比例" class="headerlink" title="10. 图片维持比例"></a>10. 图片维持比例</h4><p>应该在图片外面使用 <code>div</code> 来维持最大比例:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.outer-div</span> &#123;</div><div class="line">    <span class="attribute">width</span>: <span class="number">128px</span>;</div><div class="line">    <span class="attribute">height</span>: <span class="number">128px</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.outer-div</span> <span class="selector-tag">img</span> &#123;</div><div class="line">    <span class="attribute">max-width</span>: <span class="number">100%</span>;</div><div class="line">    <span class="attribute">height</span>: auto;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="11-media-query"><a href="#11-media-query" class="headerlink" title="11. media query"></a>11. media query</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">media</span> screen and (min-height: <span class="number">800px</span>) and (max-height: <span class="number">850px</span>) &#123;</div><div class="line">    <span class="selector-class">.large-item</span> &#123;</div><div class="line">        <span class="attribute">margin-top</span>: <span class="number">70px</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="12-Absolute-元素居中"><a href="#12-Absolute-元素居中" class="headerlink" title="12. Absolute 元素居中"></a>12. Absolute 元素居中</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.parent</span> &#123;</div><div class="line">    <span class="attribute">position </span>: relative;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.child</span> &#123;</div><div class="line">    <span class="attribute">position </span>: absolute;</div><div class="line"></div><div class="line">    <span class="attribute">top</span>: <span class="number">0</span> ;</div><div class="line">    <span class="attribute">right</span>: <span class="number">0</span> ;</div><div class="line">    <span class="attribute">bottom </span>: <span class="number">0</span> ;</div><div class="line">    <span class="attribute">left </span>: <span class="number">0</span> ;</div><div class="line"></div><div class="line">    <span class="attribute">margin </span>: auto;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* these are addtional rules */</span></div><div class="line"></div><div class="line"><span class="selector-class">.parent</span> &#123;</div><div class="line">    <span class="attribute">width </span>: <span class="number">300px</span>;</div><div class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</div><div class="line">    <span class="attribute">background </span>: red;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.child</span> &#123;</div><div class="line">    <span class="attribute">width</span>:<span class="number">100px</span>;</div><div class="line">    <span class="attribute">height</span>:<span class="number">100px</span>;</div><div class="line">    <span class="attribute">background</span>:blue;</div><div class="line">    <span class="attribute">text-align</span>:center;</div><div class="line">    <span class="attribute">line-height</span>:<span class="number">100px</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="http://jsbin.com/qeyiwezuso/edit?html,css,js,output" target="_blank" rel="external">查看效果</a></p>
<h4 id="13-重置-ul-样式"><a href="#13-重置-ul-样式" class="headerlink" title="13. 重置 ul 样式"></a>13. 重置 ul 样式</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">ul</span>, <span class="selector-tag">li</span> &#123;</div><div class="line">    <span class="attribute">list-style-type</span>: none;</div><div class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</div><div class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SCSS"><a href="#SCSS" class="headerlink" title="SCSS"></a>SCSS</h3><ul>
<li><a href="http://sass-lang.com/install" target="_blank" rel="external">安装</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line"><span class="comment"># 安装 rbenv 和 Ruby 依赖</span></div><div class="line">sudo apt-get install git-core curl zlib1g-dev build-essential libssl-dev libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev libcurl4-openssl-dev python-software-properties libffi-dev</div><div class="line"><span class="comment"># 安装 rbenv</span></div><div class="line"><span class="built_in">cd</span></div><div class="line">git <span class="built_in">clone</span> git://github.com/sstephenson/rbenv.git .rbenv</div><div class="line"><span class="built_in">echo</span> <span class="string">'export PATH="$HOME/.rbenv/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</div><div class="line"><span class="built_in">echo</span> <span class="string">'eval "$(rbenv init -)"'</span> &gt;&gt; ~/.bash_profile</div><div class="line"></div><div class="line">git <span class="built_in">clone</span> git://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build</div><div class="line"><span class="built_in">echo</span> <span class="string">'export PATH="$HOME/.rbenv/plugins/ruby-build/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</div><div class="line"><span class="built_in">source</span> ~/.bash_profile</div><div class="line"><span class="comment"># 安装 Ruby 查看最新版本: https://www.ruby-lang.org/en/downloads/</span></div><div class="line">rbenv install -v 2.2.3</div><div class="line">rbenv global 2.2.3</div><div class="line"><span class="comment"># 查看 Ruby 版本号</span></div><div class="line">ruby -v</div><div class="line"><span class="comment"># 可能还需要安装 gem</span></div><div class="line">sudo apt-get install rubygems-integration</div><div class="line">sudo apt-get install rubygems</div><div class="line"><span class="comment"># 安装 SASS</span></div><div class="line">sudo su -c <span class="string">"gem install sass"</span></div></pre></td></tr></table></figure>
<p>参考: <a href="https://www.digitalocean.com/community/tutorials/how-to-install-ruby-on-rails-with-rbenv-on-ubuntu-14-04" target="_blank" rel="external">How To Install Ruby on Rails with rbenv on Ubuntu 14.04</a></p>
<ul>
<li>语法说明: <a href="http://sass-lang.com/guide" target="_blank" rel="external">http://sass-lang.com/guide</a></li>
<li>用法: </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># a.scss =&gt; a.css</span></div><div class="line">sass --watch a.scss:a.css --style compressed</div><div class="line"></div><div class="line"><span class="comment"># dev folder =&gt; public folder</span></div><div class="line">sass --watch dev:public --style compressed</div></pre></td></tr></table></figure>
<h3 id="Angular-1-X"><a href="#Angular-1-X" class="headerlink" title="Angular 1.X"></a>Angular 1.X</h3><h4 id="1-Module"><a href="#1-Module" class="headerlink" title="1. Module"></a>1. Module</h4><p><img src="17-05-22-20_24_24_758_191.png" alt=""></p>
<h4 id="2-Controller"><a href="#2-Controller" class="headerlink" title="2. Controller"></a>2. Controller</h4><p><strong><code>Controller</code></strong> 只应该关心向谁要数据，而不要关心数据从哪里来。通常 **<code>Controller</code> 干两件事:</p>
<p><img src="17-05-22-20_38_23_798_212.png" alt=""><br><img src="17-05-22-20_42_15_769_212.png" alt=""></p>
<p>通常 <strong><code>Controller</code></strong> 不应该干:</p>
<ul>
<li>操作 DOM</li>
<li>格式化输入</li>
<li>过滤输出</li>
<li>共享状态或代码</li>
<li>管理其他组件的生命周期</li>
</ul>
<p>使用 <strong><code>controllerAs</code></strong> 风格:</p>
<p><img src="17-05-22-20_56_00_591_169.png" alt=""><br><img src="17-05-22-20_59_58_626_125.png" alt=""></p>
<h4 id="3-Services"><a href="#3-Services" class="headerlink" title="3. Services"></a>3. Services</h4><p>服务的两个特性:</p>
<ul>
<li>懒加载</li>
<li>单例</li>
</ul>
<p><img src="17-05-22-21_39_04_447_487.png" alt=""></p>
<p><strong><code>Factories</code></strong> 风格:</p>
<p><img src="17-05-22-21_42_29_373_360.png" alt=""></p>
<h4 id="4-Directives"><a href="#4-Directives" class="headerlink" title="4. Directives"></a>4. Directives</h4><p><img src="17-05-22-22_02_39_962_672.png" alt=""></p>
<p><strong>restrict</strong>:</p>
<p><img src="17-05-23-10_45_19_410_111.png" alt=""></p>
<p><strong>transclude</strong>:</p>
<ul>
<li><strong>不使用 transclude</strong>：</li>
</ul>
<p>定义一个 myCard 指令:</p>
<p><img src="17-05-23-11_05_21_467_233.png" alt=""></p>
<p>定义 myCard 模板:</p>
<p><img src="17-05-23-11_21_05_518_149.png" alt=""></p>
<p>使用:</p>
<p><img src="17-05-23-11_07_55_1293_153.png" alt=""></p>
<p>发现不方便了没有！那些大段的文字我们只能使用大段的文字来取代 <code>content</code> 内容，而不能像正常的嵌套 <strong>HTML</strong> 似的来使用。</p>
<ul>
<li><strong>引入 <code>transclude</code></strong> :</li>
</ul>
<p>指令:</p>
<p><img src="17-05-23-11_23_58_705_279.png" alt=""></p>
<p>模板类修改为:</p>
<p><img src="17-05-23-11_25_23_519_147.png" alt=""></p>
<p>使用:</p>
<p><img src="17-05-23-11_26_30_1302_169.png" alt=""></p>
<ul>
<li><strong>使用 directive controller</strong>:</li>
</ul>
<p>指令:</p>
<p><img src="17-05-23-11_34_03_698_319.png" alt=""></p>
<p>模板:</p>
<p><img src="17-05-23-11_35_12_517_152.png" alt=""></p>
<p>使用还是和前面一样</p>
<ul>
<li><strong>自定义一个指令 <code>myContentTransclusionPoint</code> 定义插入位置</strong>:</li>
</ul>
<p><img src="17-05-23-14_56_34_695_444.png" alt=""></p>
<p>模板:</p>
<p><img src="17-05-23-14_57_34_527_154.png" alt=""></p>
<p>使用和前面一样</p>
<ul>
<li><strong>使用 AngularJS 自带的 <code>ngTransclude</code> 指令来定义插入位置</strong>:</li>
</ul>
<p>模板:</p>
<p><img src="17-05-23-15_00_25_517_150.png" alt=""></p>
<p>其他都不用变</p>
<ul>
<li><strong>Transclusion Scopes</strong>:</li>
</ul>
<p>模板:</p>
<p><img src="17-05-23-15_05_09_550_359.png" alt=""></p>
<p>指令:</p>
<p><img src="17-05-23-15_07_34_1302_571.png" alt=""></p>
<p>此时的作用域:</p>
<p><img src="transclusion_scopes_proto.png" alt=""></p>
<p>为了保证当父 $scope 被销毁的时候， 指令的 $scope 也能即使被销毁，所以:</p>
<p><img src="transclusion_scopes_proto_structural.png" alt=""></p>
<h3 id="Grunt"><a href="#Grunt" class="headerlink" title="Grunt"></a>Grunt</h3><h3 id="Gulp"><a href="#Gulp" class="headerlink" title="Gulp"></a>Gulp</h3><h4 id="常见-npm-包"><a href="#常见-npm-包" class="headerlink" title="常见 npm 包"></a>常见 npm 包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">npm install --save-dev gulp-clean-css</div><div class="line">npm install --save-dev gulp-concat</div><div class="line">npm install --save-dev gulp-uglify</div></pre></td></tr></table></figure>
<h4 id="默认任务"><a href="#默认任务" class="headerlink" title="默认任务"></a>默认任务</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义一个默认任务</span></div><div class="line">gulp.task(<span class="string">'default'</span>, [<span class="string">'任务1'</span>, <span class="string">'任务2'</span>, ...])</div></pre></td></tr></table></figure>
<h4 id="Gulp-Watch"><a href="#Gulp-Watch" class="headerlink" title="Gulp Watch"></a>Gulp Watch</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义一个 watch 任务</span></div><div class="line">gulp.task(<span class="string">'watch'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    gulp.watch(<span class="string">'需要观测的文件'</span>, [<span class="string">'文件变化后执行的任务1'</span>, <span class="string">'文件变化后执行的任务2'</span>, ...]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="连接文件"><a href="#连接文件" class="headerlink" title="连接文件"></a>连接文件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'concat'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> gulp.src([<span class="string">'文件1'</span>, <span class="string">'文件2'</span>, ...])</div><div class="line">        .pipe(concat(<span class="string">'连接后的文件名字'</span>))</div><div class="line">        .pipe(gulp.dest(<span class="string">'连接后的文件保存的目录'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h3><p>新建 <code>package.json</code> 文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm init -f</div></pre></td></tr></table></figure>
<ul>
<li><strong>npm</strong> 默认<a href="https://docs.npmjs.com/files/folders" target="_blank" rel="external">安装位置</a></li>
<li><strong>npm -g</strong> 默认安装位置: <code>npm root -g</code></li>
<li><strong>npm 设置代理</strong>: <code>npm --proxy http://proxy.asec.buptnsrc.com:8001</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo cnpm --proxy http://proxy.asec.buptnsrc.com:8001 install -g hexo-cli</div></pre></td></tr></table></figure>
<p><code>--proxy</code> 不能放到后面，否则会提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TypeError: You must specify a &quot;protocol&quot; for the proxy type (http, https, socks, socks4, socks4a, socks5, socks5h, pac+data, pac+file, pac+ftp, pac+http, pac+https)</div></pre></td></tr></table></figure>
<ul>
<li><strong>npm 命令行输出下载过程</strong>： <code>npm -d</code></li>
<li><strong>npm 安装 cnpm</strong>: <code>npm install -g cnpm --registry=https://registry.npm.taobao.org</code></li>
</ul>
<blockquote>
<p><code>npm install -g</code> 命令必须有 <code>root</code> 权限才行</p>
</blockquote>
<hr>
<p><strong>Install NodeJS</strong>:</p>
<ul>
<li>访问 <a href="https://nodejs.org/en/download/" target="_blank" rel="external">https://nodejs.org/en/download/</a></li>
<li>点击页面的 <code>Installing Node.js via package manager</code> 链接</li>
<li>默认安装完成后 <code>nodejs</code> 和 <code>node</code> 这两个命令都就有了</li>
</ul>
<h3 id="使用-expressjs-快速构建服务器"><a href="#使用-expressjs-快速构建服务器" class="headerlink" title="使用 expressjs 快速构建服务器"></a>使用 <a href="https://expressjs.com/" target="_blank" rel="external">expressjs</a> 快速构建服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install express --save</div></pre></td></tr></table></figure>
<h4 id="1-HelloWorld"><a href="#1-HelloWorld" class="headerlink" title="1. HelloWorld"></a>1. HelloWorld</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</div><div class="line"><span class="keyword">const</span> app = express()</div><div class="line"></div><div class="line">app.use(express.static(<span class="string">'public'</span>))</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">'Hello World!'</span>)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Example app listening on port 3000!'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h3><p><a href="http://tool.oschina.net/commons" target="_blank" rel="external">oschina - 在线工具</a>: 包含 <strong>HTTP Content-type, HTML 转义字符, RGB 颜色参考, ASCII 对照表, HTTP 状态码详解</strong> 等</p>
<p>(1) 关于 Content-type 问题:</p>
<p>客户端发送至服务器与服务器发送至客户端的文件都有一种称之为 Content-Type 附着在上面，以标明它的资源究竟是何种类型:</p>
<ul>
<li>CSS 文件: <code>text/css</code></li>
<li>JS 文件: <code>text/javascript; charset=UTF-8</code>，也有写成 <code>application/javascript; charset=utf-8</code> 的</li>
<li>PNG 文件: <code>image/png</code></li>
<li>无后缀文件: <code>multipart/mixed; boundary=&quot;n:,DRy620B&#39;u+CoBnMws&quot;</code></li>
<li>HTML 文件: <code>text/html; charset=utf-8</code></li>
<li>XML 文件: <code>application/xml; charset=UTF-8</code></li>
</ul>
<p>当由服务器返回一些特殊媒体资源的时候，一定要在客户端和服务器端之间声明好这种资源的媒体类型，如下就是因为没有在 <code>Spring</code> 中恰当定义返回的 XML 媒体资源类型导致的乱码问题:</p>
<p><img src="17-07-17-11_20_56_1291_392.png" alt=""></p>
<p>最后通过如下方法完美解决:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/pets/&#123;petId&#125;"</span>, method = RequestMethod.GET, produces=<span class="string">"application/xml"</span>)</div><div class="line"><span class="meta">@ResponseBody</span></div><div class="line"><span class="function"><span class="keyword">public</span> Pet <span class="title">getPet</span><span class="params">(@PathVariable String petId, Model model)</span> </span>&#123;</div><div class="line">    <span class="comment">// implementation omitted</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(2) 关于 HTML 转义问题</p>
<p>从服务器传回来的内容中 <code>content</code> 包含有 <code>&gt;</code> 字符，前台使用拼接字符串的方式构建 HTML 元素:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> html = <span class="string">'&lt;form&gt;'</span> + content + <span class="string">'&lt;/form&gt;'</span></div></pre></td></tr></table></figure>
<p>这样的话，<code>&lt;form&gt;</code> 会提前因为遇见 <code>&gt;</code> 字符而闭合，因此需要在前台替换一下才可以正常工作:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">content = content.replace( <span class="regexp">/&gt;/g</span>, <span class="string">'&amp;gt;'</span> )</div></pre></td></tr></table></figure>
<h3 id="获取-Chrome-浏览器页面的编码"><a href="#获取-Chrome-浏览器页面的编码" class="headerlink" title="获取 Chrome 浏览器页面的编码"></a>获取 Chrome 浏览器页面的编码</h3><p>The <code>Document.characterSet</code> read-only property returns the character encoding of the current document. The character encoding is the character set used for <strong>rendering (渲染)</strong> the document, which may be different from the encoding specified by the page. (The user can override the encoding.).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">document</span>.characterSet</div></pre></td></tr></table></figure>
<h3 id="Chrome-调试技巧"><a href="#Chrome-调试技巧" class="headerlink" title="Chrome 调试技巧"></a><code>Chrome</code> 调试技巧</h3><p><img src="2017_11_24_14_11_06.png" alt=""><br><img src="2017_11_24_14_16_02.png" alt=""></p>
<h3 id="免费图片"><a href="#免费图片" class="headerlink" title="免费图片"></a>免费图片</h3><ul>
<li><a href="https://pixabay.com/" target="_blank" rel="external">pixabay</a></li>
<li><a href="https://www.pexels.com/" target="_blank" rel="external">pexels</a></li>
<li><a href="http://www.taopic.com/" target="_blank" rel="external">淘图网</a></li>
<li><a href="https://pixlr.com/editor/" target="_blank" rel="external">PS Online</a></li>
</ul>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://github.com/johnpapa/angular-styleguide/blob/master/a1/README.md" target="_blank" rel="external">Angular 1 Style Guide</a></li>
<li><a href="https://angularjs.org/" target="_blank" rel="external">Angular 1.X</a></li>
<li><a href="http://teropa.info/blog/2015/06/09/transclusion.html" target="_blank" rel="external">A Guide To Transclusion in AngularJS</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/05/22/frontend-dev/" data-id="cjcdlsfxn0041diem9hoppqi6" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-ZooKeeper源码分析三" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/05/18/ZooKeeper源码分析三/" class="article-date">
  <time datetime="2017-05-18T02:52:44.000Z" itemprop="datePublished">2017-05-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/05/18/ZooKeeper源码分析三/">ZooKeeper源码分析(三) - 会话管理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="ZooKeeper源码分析-三-会话管理"><a href="#ZooKeeper源码分析-三-会话管理" class="headerlink" title="ZooKeeper源码分析(三) - 会话管理"></a>ZooKeeper源码分析(三) - 会话管理</h2><h3 id="创建会话"><a href="#创建会话" class="headerlink" title="创建会话"></a>创建会话</h3><p>当有新的连接请求时，<code>NIOServerCnxn</code> 会检查 <code>ConnectRequest</code> 携带的 <code>sessionId</code>。如果为 0，那么 <code>ZooKeeper</code> 会为这个连接创建一个新的 <code>Session</code>，而在 <code>Session</code> 确定为有效之前，这个时候不会尝试从客户端读取任何数据:</p>
<p><img src="17-05-18-14_45_33_931_278.png" alt=""></p>
<p><code>ZooKeeper</code> 中的会话机制由 <code>SessionTrackerImpl</code> 来实现和管理。<code>SessionTrackerImpl</code> 继承了 <code>Thread</code> 线程，在其构造函数内部，默认调用了 <code>start</code> 方法。当 <code>ZooKeeperServer</code> 实例化 <code>SessionTrackerImpl</code> 就会作为一个单独的线程运行起来:</p>
<p><img src="17-05-18-14_56_52_955_361.png" alt=""></p>
<p>我们看一下 <code>Session</code> 是如何被创建的:</p>
<p><img src="17-05-18-15_00_11_751_192.png" alt=""></p>
<p><code>ZooKeeper</code> 选用系统当前时间，然后右移 24 位作为会话的起始 Id，之后，每多一个连接，这个起始会话 Id，就会加 1，以此分配给不同的连接。创建完成的 <code>Session</code> 会以 <code>sessionId</code> 作为键，<code>session</code> 最为值存放到 <code>sessionsById</code> 这个字典中。</p>
<p><img src="17-05-18-15_06_52_825_299.png" alt=""></p>
<h3 id="重新打开会话"><a href="#重新打开会话" class="headerlink" title="重新打开会话"></a>重新打开会话</h3><p>什么情况下客户端发送过来的 <code>sessionId</code> 不是为 0 呢，答案就是之前客户端连接过某服务器 (假设为 A)，从 A 服务器成功分配过 <code>sessionId</code>，但是 A 服务器之后由于某种原因退出了，这个时候客户端会重新选择新的服务器进行连接，然后拿着这个从 A 服务器分配的 <code>sessionId</code> 继续连接 B 服务器，这个时候 B 服务器会检测到 <code>sessionId</code> 不为 0，<code>ZooKeeperServer</code> 会尝试重新打开会话:</p>
<p><img src="17-05-18-15_17_09_926_277.png" alt=""></p>
<p>这个时候，<code>ZooKeeperServer</code> 会对来访者的这个会话标识进行认证，让它证明自己是合法连接，怎么证明呢，就是使用 <code>ConnectRequest</code> 传入的 16 字节的 passwd 来认证:</p>
<p><img src="17-05-18-15_24_16_740_275.png" alt=""></p>
<p>如果之前创建调用 <code>createSession</code> 成功过的话，那么 <code>passwd</code> 会随着 <code>ConnectResponse</code> 回传到客户端，客户端然后再更新自己本地的 <code>sessionPasswd</code>。其中 <code>passwd</code> 与 <code>sessionId</code> 息息相关，具体生成规则如下:</p>
<p><img src="17-05-18-15_46_17_657_216.png" alt=""></p>
<p>现在 <code>ZooKeeperServer</code> 要对这个客户端携带的 <code>passwd</code> 进行有效性检测:</p>
<p><img src="17-05-18-15_48_31_772_126.png" alt=""></p>
<p>如果检测失败，那么直接调用 <code>finishSessionInit(false)</code> 通知客户端认证失败；如果成功，那么会调用 <code>revalidateSession</code> 来刷新 <code>session</code>:</p>
<p><img src="17-05-18-15_56_37_878_191.png" alt=""></p>
<h3 id="会话超时"><a href="#会话超时" class="headerlink" title="会话超时"></a>会话超时</h3><p>在创建会话的时候，我们注意到其通过 <code>new Session(id, 0)</code> 来创建的会话，参数 <code>0</code> 代表的是这个新建会话的 <code>tickTime</code> 为 0。<code>tickTime</code> 代表的是一个会话能够维持多长时间，如果其超过指定的过期时间 <code>expireTime</code>，那么就要删除掉这个会话。比如设定的会话的持续时间为 10 分钟，随着时间的增加，<code>expireTime</code> 也在一直增加，逐渐逼近 10 分钟，当超过以后，就要删除这个会话，认为这个会话过期了，失效了。</p>
<p><img src="17-05-26-20_45_52_917_255.png" alt=""></p>
<p>在 <code>SessionTrackerImpl</code> 的内部，<code>ZooKeeper</code> 按照会话的 <code>tickTime</code> 的不同，来将不同的会话放入相同的 <code>SessionSet</code> 中。如图所示，左侧维持的都是能够持续 5 分钟的会话，中间维持的都是能够持续 10 分钟的…… 当超时之后，从相应的 <code>SessionSet</code> 中移除这个会话，并设置新的 <code>tickTime</code> 来放入新的 <code>SessionSet</code> 中。注意，不存在 <code>tickTime</code> 为 0 的 <code>SessionSet</code>，如果为 0 则代表新创建成功。</p>
<p><img src="17-05-26-21_21_04_710_241.png" alt=""></p>
<p>上述源码如下:</p>
<p><img src="17-05-26-21_44_36_873_468.png" alt=""></p>
<p>当然在源码的实现中，<code>tickTime</code> 存储的并不是像 5 分钟，10 分钟这样的时间间隔，而是一个时间点，即它能维持的会话有效的时间点。时间在不停地向前行走，那么旧的 <code>SessionSet</code> 被逐渐销毁，新的 <code>SessionSet</code> 被创建出来:</p>
<p><img src="17-05-26-22_25_19_702_287.png" alt=""></p>
<p>销毁 <code>SessionSet</code> 的过程是在 <code>run</code> 方法中做的:</p>
<p><img src="17-05-26-22_28_50_704_508.png" alt=""></p>
<p>我们注意到，当在销毁 <code>SessionSet</code> 的时候，其会对位于 <code>SessionSet</code> 中的所有会话做两件事:</p>
<ol>
<li>从 <code>sessionsById</code> 中移除这个会话</li>
<li>使用 <code>expirer</code> 通知这个会话过期</li>
</ol>
<p><code>expire</code> 方法的实现在是写在 <code>ZooKeeperServer</code> 中的，<code>ZooKeeperServer</code> 实现了 <code>SessionExpirer</code> 接口，并在创建 <code>SessionTracker</code> 实现的时候，将 <code>ZooKeeperServer</code> 本身作为构造器参数传入了进来，因此我们查看位于 <code>ZooKeeperServer</code> 内部的 <code>expire</code> 方法即可:</p>
<p><img src="17-05-26-22_52_26_867_301.png" alt=""></p>
<p>哦… 原来当移除 <code>SessionSet</code> 的时候，还对每一个会话都提交了一个 <code>OpCode.closeSession</code> 请求啊。另外这个地方，还应该注意的是 <code>submitRequest</code> 方法传递的 <code>cnxn</code> 参数为 <code>null</code>，下面会用到这个的。</p>
<p>当提交请求后，<code>OpCode.closeSession</code> 请求沿着调用链:</p>
<ol>
<li><code>PreRequestProcessor</code></li>
<li><code>SyncRequestProcessor</code></li>
<li><code>FinalRequestProcessor</code></li>
</ol>
<p>向前行进，在 <code>PreRequestProcessor</code> 中创建了一个 <code>TxnHeader</code> 对象对参数等进行一些封装。再交由 <code>FinalRequestProcessor</code> 进行处理 ( <code>SyncRequestProcessor</code> 对其执行逻辑无干扰，我们这里先跳过这个处理器 ):</p>
<p><img src="17-05-27-11_11_33_834_360.png" alt=""></p>
<p><code>FinalRequestProcessor</code> 当检测到其类型为 <code>OpCode.closeSession</code> 的时候，会调用 <code>removeSession</code> 来将这个会话从 <code>ZooKeeperServer</code> 中删除。<code>removeSession</code> 方法的具体实现如下:</p>
<p><img src="17-05-27-11_14_45_703_278.png" alt=""></p>
<p>回到刚才，我们知道提交请求的时候，传递的参数 <code>cnxn</code> 为 <code>null</code>，那么上面你可以看到 <code>FinalRequestProcessor</code> 在检测到 <code>cnxn</code> 为 <code>null</code> 的时候，会直接 <code>return</code>。也就是说 <code>OpCode.closeSession</code> 的响应并不会发送给客户端。一般而言，当行走到 <code>closeSesison</code> 的时候，这也就意味着客户端出现了问题，再下一节我们会看到客户端和服务器会不停的依靠心跳检测来不停地激活这个会话，当服务器检测到某个会话超时之后，即没有即使地从旧的 <code>SessionSet</code> 中迁移到新的 <code>SessionSet</code> 中去，那么说明服务器已经没有收到客户端发来的心跳包了，因此会删除这个会话。</p>
<h3 id="会话激活"><a href="#会话激活" class="headerlink" title="会话激活"></a>会话激活</h3><p>时间的车轮滚滚向前，永不停止。在上一小节我们提到，<code>SessionTrackerImpl</code> 内部维持了一个 <code>while (running)</code> 循环，通过每隔一段时间向前行走一个指定的间隔 <code>expirationInterval</code>, 进而一个一个把旧的 <code>SessionSet</code> 给删除掉。我们也提到 <code>ZooKeeperServer</code> 通过 <code>touchSession</code> 方法进行会话迁移，及时地把一些存活的会话不停地转移到一个新的 <code>SessionSet</code> 中去，进而维持会话的有效性。那么是谁在调用 <code>touchSession</code> 内？谁在不停的迁移整个会话呢？答案就在心跳检测不停的 <code>ping, ping, ping</code> 中…</p>
<p>回到 <code>NIOServerCnxn</code> 类，当其读到一个请求的时候，其会立即将这个请求 <code>submit</code> 出去 (除了 <code>OpCode.auth</code> 请求)，如下代码所示:</p>
<p><img src="17-05-27-16_26_22_811_256.png" alt=""></p>
<p>我们再往下看 <code>submitRequest</code> 方法:</p>
<p><img src="17-05-27-16_28_55_908_490.png" alt=""></p>
<p>我们会发现在每次 <code>submitRequest</code> 的时候，都会去调用 <code>touchSession</code> 方法，看这个会话是否需要迁移，客户端发来的每一种不同的操作类型 (除 <code>OpCode.auth</code> 类型) ，例如 <code>ping, setData, getData</code> 等都会调用 <code>touchSession</code> 方法。我们将 <code>touchSession</code> 称之为会话激活，也即会话迁移。这里最重要的就是 <code>ping</code> 请求的提交。我们在上一章中提到过，客户端会不停的往服务器发送心跳包，于此同时，客户端会间隔性的激活这个会话。只要收到心跳包不止，服务器就始终认为这个会话存在，始终认为其仍然有效。那些没有及时发送、或者因为网络原因断掉的客户端只能因为没有进行会话迁移而被服务器移除会话请单，可见维持好网络的畅通无阻，尽量保证延时时间的间隔要小是一件非常重要的事情。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/05/18/ZooKeeper源码分析三/" data-id="cjcdlsfwh002ldiemw27duvtw" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-ZooKeeper源码分析二" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/05/18/ZooKeeper源码分析二/" class="article-date">
  <time datetime="2017-05-18T00:23:19.000Z" itemprop="datePublished">2017-05-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/05/18/ZooKeeper源码分析二/">ZooKeeper源码分析(二) - Ping, Ping, Ping</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="ZooKeeper源码分析-二-Ping-Ping-Ping"><a href="#ZooKeeper源码分析-二-Ping-Ping-Ping" class="headerlink" title="ZooKeeper源码分析(二) - Ping, Ping, Ping"></a>ZooKeeper源码分析(二) - Ping, Ping, Ping</h2><p>在客户端与服务器建立连接之后，那么接下来客户端就开始不停地对服务器发送 <strong>Ping, Ping, Ping</strong> 心跳包检测了。当空闲时间 idle 超过 timeout 时间的时候，将会调用 <code>sendPing</code> 方法，默认情况下大概是 2 秒钟发送一次:</p>
<p><img src="17-05-18-09_43_03_885_614.png" alt=""></p>
<p>lastHeard 是上一次读写操作的时间，是在进行完 <code>doIO</code> 操作之后进行的:</p>
<p><img src="17-05-18-09_57_47_849_420.png" alt=""></p>
<p>当发送完 Ping 包之后，timeout 时间被重置为 readTimeout 时间，当读取到来自服务器的响应的时候，timeout 又被重置为 readTimeout 时间的一半，这个时候又可以发送心跳包了:</p>
<p><img src="17-05-18-09_55_35_570_150.png" alt=""></p>
<p><code>sendPing</code> 方法送入一个 <code>Packet</code> 到 <code>outgoingQueue</code> 队列，发送的数据格式如下:</p>
<p><img src="17-05-18-10_26_51_308_123.png" alt=""></p>
<p>与此相对应，服务器端的 <code>FinalRequestProcessor</code> 收到类型为 <code>OpCode.ping</code> 的请求之后，便会发送一个响应过去:</p>
<p><img src="17-05-18-10_34_29_903_214.png" alt=""></p>
<p>数据格式如下:</p>
<p><img src="17-05-18-10_38_18_379_112.png" alt=""></p>
<p>客户端在收到 <code>ping</code> 的响应之后直接丢弃掉:</p>
<p><img src="17-05-18-10_40_37_573_213.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/05/18/ZooKeeper源码分析二/" data-id="cjcdlsfwi002ndiemaar8w4c5" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-ZooKeeper源码分析一" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/05/16/ZooKeeper源码分析一/" class="article-date">
  <time datetime="2017-05-16T12:42:13.000Z" itemprop="datePublished">2017-05-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/05/16/ZooKeeper源码分析一/">ZooKeeper源码分析(一) - 建立连接</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="ZooKeeper源码分析-一-建立连接"><a href="#ZooKeeper源码分析-一-建立连接" class="headerlink" title="ZooKeeper源码分析(一) - 建立连接"></a>ZooKeeper源码分析(一) - 建立连接</h2><h3 id="版本选择"><a href="#版本选择" class="headerlink" title="版本选择"></a>版本选择</h3><p>从 Github 下载源码，执行命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> zookeeper</div><div class="line">git checkout e048893ec04a250fcb50853d6b47594fa81b0ea2</div><div class="line">ant</div></pre></td></tr></table></figure>
<p>编译成功后，将文件夹 <code>build/java/generated</code> 中的源文件拷贝到 <code>src</code> 目录下面，以便我们从源码运行程序。如果导入到 <strong>idea</strong> 的话，需要将 <code>src</code> 文件夹标记为源码根路径。</p>
<p>我们之所以要切换到这一个不同的分支上，是因为这个阶段的代码处于 ZooKeeper 的早期阶段，且功能较为成型，有助于简化我们对 ZooKeeper 的分析。</p>
<p><img src="17-05-17-11:17:08_374_434.png" alt=""></p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>在 <strong>idea</strong> 中，打开文件 <code>ZooKeeperServer.java</code>，点击右上角的 <code>Edit Configurations</code>，配置参数</p>
<p><img src="17-05-16-20:49:42_748_138.png" alt=""></p>
<p>之后，右击 <code>Apply</code> ，然后运行 <code>ZooKeeperServer.main()</code> 启动 ZooKeeper 服务器。</p>
<p>同理，我们需要配置 <code>ZooKeeper.java</code> 参数为:</p>
<p><img src="17-05-16-20:52:59_738_169.png" alt="">，之后运行 <code>ZooKeeper.main()</code> 方法启动 ZooKeeper 客户端。</p>
<h3 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h3><p>为了简化节省篇幅，着重描述核心处理流程，我在不影响运行逻辑的情况下，对代码片段进行了简化与修改，将一些异常处理机制，上下文等信息都去掉了，方便我们分析整个执行流程。</p>
<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><h4 id="服务器地址的选择"><a href="#服务器地址的选择" class="headerlink" title="服务器地址的选择"></a>服务器地址的选择</h4><p>在创建 <code>ClientCnxn</code> 对象的时候，其 <code>hosts</code> 参数允许你传入一系列服务器地址，就像下面这样:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public ClientCnxn(&quot;192.168.1.2:2181,192.168.1.3:2181&quot;, ...)</div></pre></td></tr></table></figure>
<p>之后客户端会把这些地址全部放入 <code>serverAddrs</code> 数组列表中，然后随机打乱:</p>
<p><img src="17-05-18-11_12_02_959_509.png" alt=""></p>
<p>当客户端每次尝试连接的时候，便会从这些列表中按照顺序选择下一个地址进行连接尝试:</p>
<p><img src="17-05-18-11_18_14_787_278.png" alt=""></p>
<p>当指针 <code>nextAddrToTry</code> 到达服务器列表地址的时候，将会重新归置为 0 ，然后从头开始选择地址。值得说明的是，<code>SendThread</code> 线程的主体代码整个都被包含在一个大大的 <code>try ... catch ...</code> 语句块中，任何异常 <code>Exception</code> 的捕获，都将导致客户端回到初始状态，关闭 <code>socketChannel</code> 的连接等，设置 <code>sockKey</code> 为 <code>null</code>，然后进行新一轮的 <code>startConnect</code> 连接:</p>
<p><img src="17-05-18-11_29_12_818_593.png" alt=""></p>
<h4 id="客户端发送-ConnectRequest-对象"><a href="#客户端发送-ConnectRequest-对象" class="headerlink" title="客户端发送 ConnectRequest 对象"></a>客户端发送 ConnectRequest 对象</h4><p>在 <code>SendThread</code> 启动以后，它会尝试与服务器建立连接:</p>
<p><img src="17-05-17-09_02_51_698_568.png" alt=""></p>
<p>注意，由于 <code>SocketChannel</code> 被配置成了非阻塞模式，所以 <code>sock.connect</code> 在成功连接上之前会立即返回 false。在非阻塞模式下，应该通过检测 <code>finishConnect</code> 方法来查看是否已经连接上服务器:</p>
<p><img src="17-05-18-09_04_07_843_445.png" alt=""></p>
<p>如果已经连接上，那么它将会调用 <code>primeConnection</code> 方法；否则抛出异常，进行下一轮重连:</p>
<p><img src="17-05-17-09_08_21_1106_572.png" alt=""></p>
<p>我们可以看到在 <code>primeConnection</code> 方法中，构建了一个 <code>ConnectRequest</code> 对象，最终将其写到 <code>ByteBuffer</code> 对象中，然后用 <code>Packet</code> 对象封装 <code>ByteBuffer</code> 对象，并放入 <code>outgoingQueue</code> 中。<code>outgoingQueue</code> 的定义如下:</p>
<p><img src="17-05-17-09_14_30_815_64.png" alt=""></p>
<p>最终 <code>ByteBuffer</code> 对象中存储的是下面的一些字段:</p>
<p><img src="17-05-17-09_33_07_757_129.png" alt=""></p>
<p>括号里面的数字表示字段长度。位于密码字段的 (4 + 16) 表示，发送了 4 个字节的长度和 16 字节的字节数组，<code>BinaryOutputArchive</code> 在写字节数组的时候，会先写进去长度，然后再写实际的字节数组进去。由上图可知，客户端在尝试建立连接的时候，给服务器发送了共 48 字节的数据。</p>
<p><img src="17-05-17-09_35_56_678_149.png" alt=""></p>
<p>当客户端检测到有可读或者可写事件的时候，它会调用 <code>doIO</code> 方法，来让我们处理可读或者可写的数据，<code>outgoingQueue</code> 会从头部取出第一个 <code>Packet</code>，然后通过 <code>SocketChannel</code> 发送出去:</p>
<p><img src="17-05-17-10_20_36_855_653.png" alt=""></p>
<h4 id="服务器接受-ConnectRequest-对象"><a href="#服务器接受-ConnectRequest-对象" class="headerlink" title="服务器接受 ConnectRequest 对象"></a>服务器接受 ConnectRequest 对象</h4><p>与客户端一样，当服务器端有可读数据的时候，在 <code>doIO</code> 方法中会读取 <code>ConnectRequest</code> 对象:</p>
<p><img src="17-05-17-10_51_22_710_402.png" alt=""></p>
<p>当读取到 <code>ConnectRequest</code> 对象的时候，才会将 <code>initialized</code> 标志设为 <code>true</code>:</p>
<p><img src="17-05-17-10_55_11_937_611.png" alt=""></p>
<p>前面讲到，客户端在发送 <code>ConnectRequest</code> 对象的时候，在前面还发送了一个 4 字节长的长度，然后再发送的 <code>ConnectRequest</code> 对象的那些字段，再读取 <code>ConnectRequest</code> 对象数据之前，服务器端会先把这个长度给读取了:</p>
<p><img src="17-05-17-11_10_18_747_513.png" alt=""></p>
<h4 id="服务器返回-ConnectResponse-对象"><a href="#服务器返回-ConnectResponse-对象" class="headerlink" title="服务器返回 ConnectResponse 对象"></a>服务器返回 ConnectResponse 对象</h4><p>当服务器发现有连接过来的时候，便会检查该客户端的 <code>session</code> 状况，如果 <code>sessionId</code> 不为 0，那么则重新打开 <code>session</code>，否则会创建新的 <code>session</code>。<code>session</code> 具体的执行机制我们后续会讲到，这里先假设按照正常逻辑执行，请求创建 <code>session</code>，会提交一个类型为 <code>OpCode.createSession</code> 请求:</p>
<p><img src="17-05-17-22_00_22_845_169.png" alt=""></p>
<p>这个请求沿着调用链执行过去，最终会在 <code>FinalRequestProcessor</code> 停下来:</p>
<p><img src="17-05-17-22_08_06_787_85.png" alt=""></p>
<p><code>FinalRequestProcessor</code> 对象会根据请求的类型来执行相应的方法。当创建会话完成的时候，这个时候 ZooKeeper 调用了 <code>finishSessionInit</code> 方法:</p>
<p><img src="17-05-17-21_45_20_540_150.png" alt=""></p>
<p>在 <code>finishSessionInit</code> 方法内部，服务器会发送一个 <code>ConnectResponse</code> 对象给客户端，告诉其会话创建完毕，也意味着初始化完毕，可以干其他事情了:</p>
<p><img src="17-05-17-21_48_35_1148_341.png" alt=""></p>
<p>其中 <code>ConnectRequest</code> 的构成如下所示:</p>
<p><img src="17-05-17-22_11_39_682_141.png" alt=""></p>
<p>所谓 <code>sendBuffer</code> 其实就是将 <code>ByteBuffer</code> 对象放入了阻塞队列 <code>outgoingBuffers</code> 队列中，等待发送。这部分机制与客户端发送机制大同小异，如此不在赘述。</p>
<h4 id="客户端收到-ConnectResponse-对象"><a href="#客户端收到-ConnectResponse-对象" class="headerlink" title="客户端收到 ConnectResponse 对象"></a>客户端收到 ConnectResponse 对象</h4><p>当客户端准备好数据开始往客户端写的时候，与此同时久久等待的客户端早已经翘首以盼了。在自己的 <code>doIO</code> 方法里一旦检测到有数据可读便立马着手处理了…</p>
<p><img src="17-05-17-22_21_04_667_256.png" alt=""><br><img src="17-05-17-22_23_17_869_426.png" alt=""></p>
<h4 id="客户端与服务器的交互机制"><a href="#客户端与服务器的交互机制" class="headerlink" title="客户端与服务器的交互机制"></a>客户端与服务器的交互机制</h4><p><img src="17-05-17-22_29_44_524_371.png" alt=""></p>
<p>这一去一回的交互机制，主要是为了建立客户端到服务器的一个会话信任机制。</p>
<h4 id="客户端的连接失败情况"><a href="#客户端的连接失败情况" class="headerlink" title="客户端的连接失败情况"></a>客户端的连接失败情况</h4><p>上述我们讲到的是，当服务器接收到来自客户端的 <code>ConnectRequest</code> 对象的时候，初始化成功；当客户端接收到返回自服务器的 <code>ConnectResponse</code> 的时候，客户端初始化成功。那么什么时候客户端会初始化失败呢？有这么几种情况:</p>
<ul>
<li>客户端携带的 <code>sessionId</code> 与 <code>passwd</code> 不匹配</li>
<li>客户端携带的 <code>sessionId</code> 在服务器端并不存在</li>
</ul>
<p>在这两种情况下，服务器会往客户端发送一个长度为 0 字节的 <code>ByteBuffer</code>:</p>
<p><img src="17-05-17-22_59_02_736_196.png" alt=""></p>
<p>而客户端 <code>ClientCnxn</code> 在收到这样一个 0 字节数据的时候，会抛出异常:</p>
<p><img src="17-05-17-23_03_56_820_277.png" alt=""></p>
<p>这个时候，客户端会稍稍调整，以准备下一次重新发送 <code>ConnectRequest</code> 对象给服务器。</p>
<h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><h4 id="SessionId-的生成"><a href="#SessionId-的生成" class="headerlink" title="SessionId 的生成"></a>SessionId 的生成</h4><p><img src="17-05-16-21_12_56_849_69.png" alt=""></p>
<p>在生成完 <code>Session</code> 之后，会将其保存到两个地方，一个是 <code>sessionsWithTimeout</code> 字典里面，另外一个是 <code>sessionsById</code> 字典里面:</p>
<p><img src="17-05-16-21_25_26_862_278.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/05/16/ZooKeeper源码分析一/" data-id="cjcdlsfwg002jdiemvpj7256z" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/blog/page/19/">&laquo; Prev</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/18/">18</a><a class="page-number" href="/blog/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/blog/page/21/">21</a><a class="page-number" href="/blog/page/22/">22</a><a class="page-number" href="/blog/page/23/">23</a><a class="extend next" rel="next" href="/blog/page/21/">Next&raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    

  
    
  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/01/06/where-the-time-actually-gone/">时间都去哪儿了</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/dev-reflection/">开发反思</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/my-microblog/">我的微博</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/gcc-basic/">gcc-basic</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/java-internal/">Java Internal</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>