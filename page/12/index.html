<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="赵坤的个人网站">
<meta property="og:type" content="website">
<meta property="og:title" content="代码人生">
<meta property="og:url" content="http://blog.kunzhao.org/page/12/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="赵坤的个人网站">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码人生">
<meta name="twitter:description" content="赵坤的个人网站">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-spring" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/21/spring/" class="article-date">
  <time datetime="2017-07-21T08:29:17.000Z" itemprop="datePublished">2017-07-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/21/spring/">Spring</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h2><h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="Main-入口"><a href="#Main-入口" class="headerlink" title="Main 入口"></a>Main 入口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String...args)</span> </span>&#123;</div><div class="line">    ApplicationContext context =</div><div class="line">        <span class="keyword">new</span> AnnotationConfigApplicationContext(Config.class);</div><div class="line">    Person person = (Person) context.getBean(<span class="string">"person"</span>);</div><div class="line">    person.drive();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="基于-Groovy"><a href="#基于-Groovy" class="headerlink" title="基于 Groovy"></a>基于 Groovy</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">beans &#123;</div><div class="line">    xmlns([<span class="string">ctx:</span><span class="string">'http://www.springframework.org/schema/context'</span>])</div><div class="line">    ctx.<span class="string">'component-scan'</span>(<span class="string">'base-package'</span>:<span class="string">'com.zk'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="把值放入-Spring-中-Component-方式"><a href="#把值放入-Spring-中-Component-方式" class="headerlink" title="把值放入 Spring 中 - @Component 方式"></a>把值放入 <code>Spring</code> 中 - <code>@Component</code> 方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Truck</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Truck"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与此同时，还要<strong>开启 <code>@ComponentScan</code> </strong>方式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@ComponentScan</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="把值放入-Spring-中-Bean-方式"><a href="#把值放入-Spring-中-Bean-方式" class="headerlink" title="把值放入 Spring 中 - @Bean 方式"></a>把值放入 <code>Spring</code> 中 - <code>@Bean</code> 方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">truck</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Truck();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="从-Spring-中获取值-Autowired"><a href="#从-Spring-中获取值-Autowired" class="headerlink" title="从 Spring 中获取值 - @Autowired"></a>从 <code>Spring</code> 中获取值 - <code>@Autowired</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> Car car;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(Car car)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.car = car;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCar</span><span class="params">(Car car)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.car = car;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drive</span><span class="params">()</span> </span>&#123;</div><div class="line">        car.go();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>当自己 <code>new</code> 一个对象的时候，这个对象就不归 <code>Spring</code> 管理了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sample</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@AutoWired</span></div><div class="line">    Foo foo;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后使用 <code>new</code> 来创建对象，其 <code>foo</code> 字段并不会被自动注解:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Sample();</div></pre></td></tr></table></figure>
<h3 id="从-Spring-的多个可选值中获取值-Primary"><a href="#从-Spring-的多个可选值中获取值-Primary" class="headerlink" title="从 Spring 的多个可选值中获取值 - @Primary"></a>从 <code>Spring</code> 的多个可选值中获取值 - <code>@Primary</code></h3><p>当有多个合适的候选 <code>@Bean</code> 的时候，使用 <code>@Primary</code> 来指定默认想要获取的值:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="meta">@Primary</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">bicycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Bicycle();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="选择自己喜欢的口味"><a href="#选择自己喜欢的口味" class="headerlink" title="选择自己喜欢的口味"></a>选择自己喜欢的口味</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@Qualifier</span>(<span class="string">"cold"</span>)</div><div class="line"><span class="meta">@Qualifier</span>(<span class="string">"creamy"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IceCream</span> <span class="keyword">implements</span> <span class="title">Dessert</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@Qualifier</span>(<span class="string">"cold"</span>)</div><div class="line"><span class="meta">@Qualifier</span>(<span class="string">"fruity"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Popsicle</span> <span class="keyword">implements</span> <span class="title">Dessert</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure>
<p>注入:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="meta">@Qualifier</span>(<span class="string">"cold"</span>)</div><div class="line"><span class="meta">@Qualifier</span>(<span class="string">"creamy"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDessert</span><span class="params">(Dessert dessert)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.dessert = dessert;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Bean-的作用域"><a href="#Bean-的作用域" class="headerlink" title="Bean 的作用域"></a><code>Bean</code> 的作用域</h3><p><strong>By default, all beans created in the Spring application context are created as singletons</strong>. That is to say, no matter how many times a given bean is injected into other beans, it’s always the same instance that is injected each time.</p>
<p>Spring defines several scopes under which a bean can be created, including the following:</p>
<ul>
<li><code>Singleton</code> — One instance of the bean is created for the entire application.</li>
<li><code>Prototype</code> — One instance of the bean is created every time the bean is injected into or retrieved from the Spring application context.</li>
<li><code>Session</code> — In a web application, one instance of the bean is <strong>created for each session</strong>.</li>
<li><code>Request</code> — In a web application, one instance of the bean is <strong>created for each request</strong>.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@Scope</span>(value=WebApplicationContext.SCOPE_SESSION,</div><div class="line">       proxyMode=ScopedProxyMode.INTERFACES)</div><div class="line"><span class="function"><span class="keyword">public</span> ShoppingCart <span class="title">cart</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>As configured, <code>proxyMode</code> is set to <code>ScopedProxyMode.INTERFACES</code>, indicating that the proxy should implement the <strong><code>ShoppingCart</code> interface</strong> and delegate to the implementation bean.</p>
<p>This is fine (and the most ideal proxy mode) as long as <strong><code>ShoppingCart</code> is an interface</strong> and not a class. But if <code>ShoppingCart</code> is a concrete class, there’s no way Spring can create an interface-based proxy. Instead, it must <strong>use <code>CGLib</code> to generate a class-based proxy</strong>. So, if the bean type is a concrete class, you must set <code>proxyMode</code> to <code>ScopedProxyMode.TARGET_CLASS</code> to indicate that the proxy should be generated as an extension of the target class.</p>
<p><img src="17-07-21-20_42_47_1316_722.png" alt=""></p>
<h3 id="Bean-的生命周期"><a href="#Bean-的生命周期" class="headerlink" title="Bean 的生命周期"></a><code>Bean</code> 的生命周期</h3><p>使用 <code>initMethod</code> 和 <code>destroyMethod</code> 方法来声明<strong>初始化和销毁</strong>的时候调用的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Primary</span></div><div class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"init"</span>, destroyMethod = <span class="string">"destroy"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">bicycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Bicycle();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与此同时，<code>Bicycle</code> 类中一定要有这两个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bicycle</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"===create==="</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Bicycle go"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"===destroy==="</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用 <code>close</code> 方法以便我们能够观察到 <code>Bicycle</code> 的 <code>destroyMethod</code> 方法的执行:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">AnnotationConfigApplicationContext context =</div><div class="line">    <span class="keyword">new</span> AnnotationConfigApplicationContext(Config.class);</div><div class="line">Person person = (Person) context.getBean(<span class="string">"person"</span>);</div><div class="line">person.drive();</div><div class="line">context.close();</div></pre></td></tr></table></figure>
<h3 id="激活-Profile"><a href="#激活-Profile" class="headerlink" title="激活 Profile"></a>激活 Profile</h3><p>先<strong>调整环境参数</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">AnnotationConfigApplicationContext context =</div><div class="line">    <span class="keyword">new</span> AnnotationConfigApplicationContext();</div><div class="line">context.getEnvironment().setActiveProfiles(<span class="string">"production"</span>);</div><div class="line">context.register(Config.class);</div><div class="line">context.refresh();</div></pre></td></tr></table></figure>
<p>所有涉及到<strong>候选 <code>Bean</code></strong> 的地方都得表明 <code>@Profile</code> 的类型:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Profile</span>(<span class="string">"production"</span>)</div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Automobile</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@Profile</span>(<span class="string">"dev"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Truck</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@ComponentScan</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Profile</span>(<span class="string">"dev"</span>)</div><div class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"init"</span>, destroyMethod = <span class="string">"destroy"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">bicycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Bicycle();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>添加依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>编写测试代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(classes = Config.class)</div><div class="line"><span class="meta">@ActiveProfiles</span>(<span class="string">"production"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CarInjectionTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> Car car;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">carShouldBeAutomobile</span><span class="params">()</span> </span>&#123;</div><div class="line">        Assert.assertTrue(car.toString().contains(<span class="string">"Automobile"</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/test/context/ContextConfiguration.html" target="_blank" rel="external"><code>@ContextConfiguration</code> 简介</a></strong>:</p>
<p>Prior to Spring 3.1, only path-based resource locations (typically XML configuration files) were supported. As of Spring 3.1, context loaders may choose to support either path-based or class-based resources. As of Spring 4.0.4, context loaders may choose to support <strong>path-based and class-based resources</strong> simultaneously. Consequently <code>@ContextConfiguration</code> can be used to declare either path-based resource locations (via the <code>locations()</code> or <code>value()</code> attribute) or annotated classes (via the <code>classes()</code> attribute).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ContextConfiguration</span>(locations = <span class="string">"classpath:spring-beans.xml"</span>)</div><div class="line"><span class="meta">@ContextConfiguration</span>(classes = Config.class)</div></pre></td></tr></table></figure>
<p>测试的时候，<strong>类上一定要标注上这两行注解</strong>，否则会抛出异常:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</div><div class="line"><span class="meta">@ContextConfiguration</span>(classes = Config.class)</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/21/spring/" data-id="cjcdlsfyv005zdiemko04dggd" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-springboot" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/21/springboot/" class="article-date">
  <time datetime="2017-07-21T07:08:32.000Z" itemprop="datePublished">2017-07-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/21/springboot/">Spring Boot</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a><a href="http://docs.spring.io/spring-boot/docs/1.5.4.RELEASE/reference/htmlsingle/" target="_blank" rel="external">Spring Boot</a></h2><h3 id="谨记"><a href="#谨记" class="headerlink" title="谨记"></a>谨记</h3><ul>
<li><code>Spring Boot</code> <strong>官方推荐使用 <code>Java 1.8</code> 来运行</strong></li>
<li>默认带有 <strong><a href="http://docs.spring.io/spring-boot/docs/1.5.4.RELEASE/reference/htmlsingle/#_servlet_containers" target="_blank" rel="external"><code>Tomcat</code>, <code>Jetty</code>, <code>Undertow</code></a></strong> 这三款 Servlet 容器</li>
</ul>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h3><p>默认使用 <a href="https://github.com/spring-projects/spring-boot/blob/v1.5.4.RELEASE/spring-boot-starters/spring-boot-starter-web/pom.xml" target="_blank" rel="external"><code>spring-boot-starter-tomcat</code></a> 来运行:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@EnableAutoConfiguration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function">String <span class="title">home</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello World!"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        SpringApplication.run(HomeController.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>添加 <code>spring-boot-starter-jetty</code> 切换为 <code>Jetty</code> 启动:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p><code>SpringBoot</code> 使用全局配置 <code>application.properties</code> 或 <code>application.yml</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">server.port=8082</div><div class="line">server.context-path=/hello</div></pre></td></tr></table></figure>
<h3 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h3><h3 id="Profile-配置"><a href="#Profile-配置" class="headerlink" title="Profile 配置"></a>Profile 配置</h3><p>名字: <code>application-{profile}.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># application.properties</div><div class="line">spring.profiles.active=prod</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/21/springboot/" data-id="cjcdlsfyw0061diemsnzi4zx3" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-springmvc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/19/springmvc/" class="article-date">
  <time datetime="2017-07-19T02:12:19.000Z" itemprop="datePublished">2017-07-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/19/springmvc/">Spring Web MVC</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Spring-Web-MVC"><a href="#Spring-Web-MVC" class="headerlink" title="Spring Web MVC"></a>Spring Web MVC</h2><h3 id="Spring-启动"><a href="#Spring-启动" class="headerlink" title="Spring 启动"></a><code>Spring</code> 启动</h3><p><img src="2017_10_19_09_20_05.png" alt=""></p>
<hr>
<p><code>Jetty</code> 重要的启动类:</p>
<ul>
<li><code>ServletContainerInitializersStarter</code></li>
<li><code>AnnotationConfiguration</code></li>
<li><code>org.eclipse.jetty.embedded.ServerWithAnnotations</code></li>
<li><code>ContainerLifeCycle</code></li>
</ul>
<p>(1) 从 <code>AbstractJettyMojo</code> 插件开始启动:</p>
<p><img src="2017_10_19_11_38_16.png" alt=""><br><img src="2017_10_19_11_58_57.png" alt=""></p>
<p>其中默认 <code>Configuration</code> 类有:</p>
<p><img src="2017_10_19_11_49_14.png" alt=""><br><img src="2017_10_19_11_46_49.png" alt=""></p>
<p>(2) 当调用 <code>start()</code> 方法的时候:</p>
<p><img src="2017_10_19_12_00_50.png" alt=""></p>
<p>(3) 加载 <code>Configuration</code>:</p>
<p><img src="2017_10_19_12_04_10.png" alt=""><br><img src="2017_10_19_12_08_04.png" alt=""></p>
<hr>
<p><code>Jetty</code> 哪个类扫描了 <code>Spring</code> 中实现了 <code>ServletContainerInitializersStarter</code> 接口的类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">org.eclipse.jetty.annotations.AnnotationConfiguration</div></pre></td></tr></table></figure>
<p>(4) 接受客户端请求</p>
<ul>
<li><code>jetty-server</code> 模块</li>
</ul>
<h3 id="谁调用了-service-方法"><a href="#谁调用了-service-方法" class="headerlink" title="谁调用了 service 方法"></a>谁调用了 <code>service</code> 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHolder.java</div></pre></td></tr></table></figure>
<h3 id="Jetty-相关"><a href="#Jetty-相关" class="headerlink" title="Jetty 相关"></a><code>Jetty</code> 相关</h3><p>打成 <code>war</code> 包放到 <code>webapps</code> 目录下面即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://hostname.com/contextPath/servletPath/pathInfo</div></pre></td></tr></table></figure>
<ul>
<li>If the WAR file is named <code>myapp.war</code>, then the context will be deployed with a context path of <strong><code>/myapp</code></strong></li>
<li>If the WAR file is named <code>ROOT.WAR</code> (or any case insensitive variation), then the context will be deployed with a context path of <strong><code>/</code></strong></li>
<li>If the WAR file is named <code>ROOT-foobar.war</code> ( or any case insensitive variation), then the context will be deployed with a context path of / and a virtual host of <strong><code>&quot;foobar&quot;</code></strong></li>
</ul>
<h3 id="web-xml-启动"><a href="#web-xml-启动" class="headerlink" title="web.xml 启动"></a><code>web.xml</code> 启动</h3><ul>
<li>从 Spring 3.0 开始就不需要写 <code>WEB-INF/web.xml</code></li>
</ul>
<p>运行 <code>Spring MVC</code>:</p>
<ul>
<li>配置 <code>DispatcherServlet</code><ul>
<li><code>web.xml</code></li>
<li>3.0 之后，<code>AbstractAnnotationConfigDispatcherServletInitializer</code></li>
</ul>
</li>
</ul>
<p>Any class that extends <code>AbstractAnnotationConfigDispatcherServletInitializer</code> will <strong>自动</strong> be used to configure <code>DispatcherServlet</code> and the Spring application context in the application’s servlet context.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 这个类自动用来配置 DispatcherServlet</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebAppInitializer</span> <span class="keyword">extends</span> <span class="title">AbstractAnnotationConfigDispatcherServletInitializer</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class[<span class="number">0</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 加载 beans</span></div><div class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class[] &#123; WebConfig.class &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// DispatcherServlet 映射的多个路径</span></div><div class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123; <span class="string">"/"</span> &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">AbstractAnnotationConfigDispatcherServletInitializer</div><div class="line">                     | 创</div><div class="line">                     | 建</div><div class="line">                     | 了</div><div class="line">                     V</div><div class="line">    DispatcherServlet (getServletConfigClasses)</div><div class="line">   ContextLoaderListener (getRootConfigClasses)</div></pre></td></tr></table></figure>
<p><img src="664811d1be029d66250bfe66d65fbe4f__1.JPG" alt=""></p>
<p><code>ContextLoaderListener</code> 初始化的上下文加载的 <code>Bean</code> 是对于<strong>整个应用程序共享</strong>的，不管是使用什么表现层技术，一般如 <code>DAO</code> 层、<code>Service</code> 层 <code>Bean</code>； <code>DispatcherServlet</code> 初始化的上下文加载的 <code>Bean</code> 是只对 Spring Web MVC 有效的 <code>Bean</code>，如 <code>Controller</code>、<code>HandlerMapping</code>、<code>HandlerAdapter</code> 等等，该初始化上下文应该<strong>只加载 Web 相关组件</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 默认采用 BeanNameViewResolver (查看 Bean 的 ID)</span></div><div class="line"><span class="comment">// 默认 Component Scan 没有开启</span></div><div class="line"><span class="comment">// 默认 DispatcherServlet 接受所有请求 (图片、css等)</span></div><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableWebMvc</span></div><div class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.zk"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableWebMvc</span></div><div class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.zk"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 配置一个 JSP 视图解析器</span></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;</div><div class="line">        InternalResourceViewResolver resolver =</div><div class="line">                <span class="keyword">new</span> InternalResourceViewResolver();</div><div class="line">        resolver.setPrefix(<span class="string">"/WEB-INF/views/"</span>);</div><div class="line">        resolver.setSuffix(<span class="string">".jsp"</span>);</div><div class="line">        resolver.setExposeContextBeansAsAttributes(<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">return</span> resolver;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 转发静态资源请求到 Servlet 容器的默认的 Servlet</span></div><div class="line">    <span class="comment">// 而不是自己去处理静态资源</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> </span>&#123;</div><div class="line">        configurer.enable();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WebApplicationInitializer-启动"><a href="#WebApplicationInitializer-启动" class="headerlink" title="WebApplicationInitializer 启动"></a><code>WebApplicationInitializer</code> 启动</h3><p>Servlets of release 3 can be configured programatically, without any <code>web.xml</code>. With Spring and its Java-configuration <strong>创建一个配置类</strong> that <strong>实现 <code>org.springframework.web.WebApplicationInitializer</code></strong>.</p>
<p>Spring will automatically find all classes that implement this interface and <strong>运行</strong> the according servlet contexts. <strong>More excatly its not Spring that searches for those classes, its the servlet container (e.g. <code>jetty</code> or <code>tomcat</code> )</strong>.</p>
<h3 id="DispatcherServlet"><a href="#DispatcherServlet" class="headerlink" title="DispatcherServlet"></a><code>DispatcherServlet</code></h3><p>Spring’s web MVC framework is, like many other web MVC frameworks, request-driven, designed around a <strong>中心</strong> servlet that <strong>分发请求</strong> to controllers and offers other functionality that facilitates the development of web applications. Spring’s <strong><code>DispatcherServlet</code></strong> however, does more than just that. It is completely integrated with the Spring IoC container and as such allows you to use every other feature that Spring has.</p>
<p>The request processing workflow of the Spring Web MVC <code>DispatcherServlet</code> is illustrated in the following diagram. The pattern-savvy reader will recognize that the DispatcherServlet is an expression of the “Front Controller” design pattern (this is a pattern that Spring Web MVC shares with many other leading web frameworks).</p>
<p><img src="mvc.png" alt=""></p>
<h3 id="WebApplicationInitializer-启动-1"><a href="#WebApplicationInitializer-启动-1" class="headerlink" title="WebApplicationInitializer 启动"></a><code>WebApplicationInitializer</code> 启动</h3><p>Servlets of release 3 can be configured programatically, without any <code>web.xml</code>. With Spring and its Java-configuration you create a configuration class that implements <code>org.springframework.web.WebApplicationInitializer</code>.</p>
<p>Spring will automatically find all classes that implement this interface and start the according servlet contexts. <strong>More excatly its not Spring that searches for those classes, its the servlet container (e.g. <code>jetty</code> or <code>tomcat</code> )</strong>.</p>
<h3 id="添加项目依赖"><a href="#添加项目依赖" class="headerlink" title="添加项目依赖"></a>添加项目依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="添加-Servlet-容器插件"><a href="#添加-Servlet-容器插件" class="headerlink" title="添加 Servlet 容器插件"></a>添加 <code>Servlet</code> 容器插件</h3><h4 id="1-使用-Jetty"><a href="#1-使用-Jetty" class="headerlink" title="(1) 使用 Jetty"></a>(1) 使用 <a href="http://www.eclipse.org/jetty/documentation/current/jetty-maven-plugin.html" target="_blank" rel="external"><code>Jetty</code></a></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">  </div><div class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.4.6.v20170531<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">scanIntervalSeconds</span>&gt;</span>10<span class="tag">&lt;/<span class="name">scanIntervalSeconds</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">webApp</span>&gt;</span></div><div class="line">          <span class="comment">&lt;!-- 访问路径前缀 --&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">contextPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">contextPath</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">webApp</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    </div><div class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<p>运行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn jetty:run</div></pre></td></tr></table></figure>
<h3 id="访问-Html-Jsp-页面"><a href="#访问-Html-Jsp-页面" class="headerlink" title="访问 Html(Jsp) 页面"></a>访问 Html(Jsp) 页面</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/"</span>, method = RequestMethod.GET)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">home</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// 返回的是 View 的名字</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"home"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对应的 <code>home.jsp</code> 的位置是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">├── src</div><div class="line">│   ├── main</div><div class="line">│   │   └── webapp</div><div class="line">│   │       └── WEB-INF</div><div class="line">│   │           └── views</div><div class="line">│   │               └── home.jsp</div></pre></td></tr></table></figure>
<p>默认解析 <code>View</code> 的是 <code>BeanNameViewResolver</code>，所以需要配置自己的 <code>Jsp</code> 解析器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableWebMvc</span></div><div class="line"><span class="meta">@ComponentScan</span>()</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;</div><div class="line">        InternalResourceViewResolver resourceViewResolver = <span class="keyword">new</span> InternalResourceViewResolver();</div><div class="line">        resourceViewResolver.setPrefix(<span class="string">"/WEB-INF/views/"</span>);</div><div class="line">        resourceViewResolver.setSuffix(<span class="string">".jsp"</span>);</div><div class="line">        resourceViewResolver.setExposeContextBeansAsAttributes(<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">return</span> resourceViewResolver;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="访问需要动态填写值的-Html-Jsp-页面"><a href="#访问需要动态填写值的-Html-Jsp-页面" class="headerlink" title="访问需要动态填写值的 Html(Jsp) 页面"></a>访问需要动态填写值的 Html(Jsp) 页面</h3><p>首先添加 <code>JSTL</code> 依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>然后使用 <code>Model</code> 传值给 <code>JSP</code> 页面:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/page-with-dynamic-value"</span>, method = RequestMethod.GET)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">pageWithDynamicValue</span><span class="params">(Model model)</span> </span>&#123;</div><div class="line">        model.addAttribute(<span class="string">"dynamicTitle"</span>, <span class="string">"Dynamic Title"</span>);</div><div class="line">        model.addAttribute(<span class="string">"dynamicValue"</span>, <span class="string">"Dynamic Value"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"page-with-dynamic-value"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>page-with-dynamic-value.jsp</code> 内容为:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">uri</span>=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> <span class="attr">prefix</span>=<span class="string">"c"</span> %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;dynamicTitle&#125;"</span> /&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;dynamicValue&#125;"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>注: key 的命名最好不要有特殊符号，一开始我用 <code>dynamic-title</code> 怎么也不出来，在这里浪费了好长时间</p>
</blockquote>
<h3 id="访问静态文件"><a href="#访问静态文件" class="headerlink" title="访问静态文件"></a>访问静态文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableWebMvc</span></div><div class="line"><span class="meta">@ComponentScan</span>()</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> </span>&#123;</div><div class="line">        <span class="comment">// 允许静态内容访问</span></div><div class="line">        configurer.enable();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们通过输入 <code>http://localhost:8080/public/js/hello.js</code> 来访问 <code>hello.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">├── src</div><div class="line">│   ├── main</div><div class="line">│   │   └── webapp</div><div class="line">│   │       ├── public</div><div class="line">│   │       │   └── js</div><div class="line">│   │       │       └── hello.js</div></pre></td></tr></table></figure>
<h3 id="解析请求参数"><a href="#解析请求参数" class="headerlink" title="解析请求参数"></a>解析请求参数</h3><p>使用 <code>@RequestParam</code> 来读取用户输入的参数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/request-with-parameter"</span>, method = RequestMethod.GET)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">requestWithParameter</span> <span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">         @RequestParam(value=<span class="string">"resourceID"</span>, defaultValue = <span class="string">"100"</span>)</span> <span class="keyword">long</span> resourceID,</span></div><div class="line"><span class="function">         Model model</span></div><div class="line"><span class="function">         ) </span>&#123;</div><div class="line">        model.addAttribute(<span class="string">"resourceID"</span>, resourceID);</div><div class="line">        <span class="keyword">return</span> <span class="string">"request-with-parameter"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后使用如下 URL 来访问，可以在页面上观察到读取到的用户传入的参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:8080/request-with-parameter?resourceID=1</div></pre></td></tr></table></figure>
<blockquote>
<p>注: <code>@RequestParam</code> 也能接受 <code>POST</code> 请求的参数</p>
</blockquote>
<h3 id="从路径中解析参数"><a href="#从路径中解析参数" class="headerlink" title="从路径中解析参数"></a>从路径中解析参数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/request-based-path-parameter/&#123;resourceID&#125;"</span>, method = RequestMethod.GET)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">requestBasedPathParameter</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">            @PathVariable(<span class="string">"resourceID"</span>)</span> <span class="keyword">long</span> resourceID,</span></div><div class="line"><span class="function">            Model model</span></div><div class="line"><span class="function">    ) </span>&#123;</div><div class="line">        model.addAttribute(<span class="string">"resourceID"</span>, resourceID);</div><div class="line">        <span class="keyword">return</span> <span class="string">"request-with-parameter"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后使用如下 URL 来访问，可以在页面上观察到从路径中读取到的用户传入的参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:8080/request-based-path-parameter/1</div></pre></td></tr></table></figure>
<h3 id="从表单中解析参数"><a href="#从表单中解析参数" class="headerlink" title="从表单中解析参数"></a>从表单中解析参数</h3><p>表单:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/submit-form"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></div><div class="line">  Name:<span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">  Password:<span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
<p>注意这次用来接受表单参数的是一个 <code>User</code> 对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/submit-form"</span>, method = RequestMethod.POST)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleForm</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">        System.out.println(user);</div><div class="line">        <span class="keyword">return</span> <span class="string">"redirect:/"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>User</code> 其实就是一个简单的 <code>Bean</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> String password;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> name; &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">this</span>.name = name; &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> password; &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123; <span class="keyword">this</span>.password = password; &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在提交表单之后，浏览器的 URL 会自动被<strong>重定向</strong>到首页，注意<strong>浏览器的地址也会变化</strong>。</p>
<blockquote>
<p><strong>注意: <code>form</code> 表单默认使用 <code>GET</code> 提交表单</strong>，所以大多数情况下都应该指定 <code>method</code> 为 <code>POST</code> 提交</p>
</blockquote>
<h3 id="接受-JSON-数据"><a href="#接受-JSON-数据" class="headerlink" title="接受 JSON 数据"></a>接受 <code>JSON</code> 数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">insert</span><span class="params">(@RequestBody String requestBody)</span> </span>&#123;</div><div class="line">    net.sf.json.JSONObject jsonObject =</div><div class="line">        net.sf.json.JSONObject.fromObject(requestBody);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -X POST -d <span class="string">'&#123;key: value&#125;'</span> http://localhost:8080/test.json -H <span class="string">'Content-Type:application/json'</span></div></pre></td></tr></table></figure>
<ul>
<li>一定要设置上 <code>-H &#39;Content-Type:application/json&#39;</code> 这个头，否则服务器不认为这是一个 <code>json</code> 字符串</li>
</ul>
<h3 id="重定向的时候携带参数-URL-拼接"><a href="#重定向的时候携带参数-URL-拼接" class="headerlink" title="重定向的时候携带参数 - URL 拼接"></a>重定向的时候携带参数 - URL 拼接</h3><p>直接将参数放进 URL 里面即可:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/submit-params-form"</span>, method = RequestMethod.POST)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleRedirectWithParamsForm</span><span class="params">(User user, Model model)</span> </span>&#123;</div><div class="line">        model.addAttribute(<span class="string">"userName"</span>, user.getName());</div><div class="line">        <span class="keyword">return</span> <span class="string">"redirect:/redirect-page/&#123;userName&#125;"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="重定向的时候携带参数-使用-FlastAttribute"><a href="#重定向的时候携带参数-使用-FlastAttribute" class="headerlink" title="重定向的时候携带参数 - 使用 FlastAttribute"></a>重定向的时候携带参数 - 使用 <code>FlastAttribute</code></h3><p><strong>使用 <code>RedirectAttributes</code> 的方法 <code>addFlashAttribute</code></strong> 可以在重定向的时候传递复杂一点的对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/submit-flash-attribute-form"</span>, method = RequestMethod.POST)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleRedirectWithFlashAttributeForm</span><span class="params">(User user, RedirectAttributes model)</span> </span>&#123;</div><div class="line">        model.addFlashAttribute(<span class="string">"user"</span>, user);</div><div class="line">        <span class="keyword">return</span> <span class="string">"redirect:/redirect-flash-attribute-page"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/redirect-flash-attribute-page"</span>, method = RequestMethod.GET)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">redirectWithFlashAttributePage</span><span class="params">(Model model)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!model.containsAttribute(<span class="string">"user"</span>)) &#123;</div><div class="line">            System.err.println(<span class="string">"Fatal error!"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">"redirect-flash-attribute-page"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="返回-JSON-数据"><a href="#返回-JSON-数据" class="headerlink" title="返回 JSON 数据"></a>返回 JSON 数据</h3><p>首先添加依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0.pr4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0.pr4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>然后使用 <code>@ResponseBody</code> 来标记返回结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/users"</span>,</div><div class="line">            method = RequestMethod.GET)</div><div class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">List&lt;User&gt; <span class="title">allUsers</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;User&gt;(<span class="number">2</span>);</div><div class="line">        users.add(createUser(<span class="string">"Tom"</span>, <span class="string">"123"</span>));</div><div class="line">        users.add(createUser(<span class="string">"Jerry"</span>, <span class="string">"456"</span>));</div><div class="line">        <span class="keyword">return</span> users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>请求:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl http://localhost:8080/ucurl http://localhost:8080/users -H <span class="string">'Accept: application/json'</span></div></pre></td></tr></table></figure>
<hr>
<p>另外一种方式是标注返回类型为 <code>String</code>，然后 <a href="https://stackoverflow.com/questions/3907929/should-i-declare-jacksons-objectmapper-as-a-static-field" target="_blank" rel="external"><code>ObjectMapper</code></a> 将 <code>Object</code> 转为 <code>Json</code> 字符串:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">return</span> objectMapper.writeValueAsString(map);</div><div class="line">&#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</div><div class="line">    <span class="keyword">return</span> e.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="返回-XML-数据"><a href="#返回-XML-数据" class="headerlink" title="返回 XML 数据"></a>返回 XML 数据</h3><p>需要添加依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0.pr4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0.pr4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>同样也需要使用 <code>@ResponseBody</code> 来标注返回结果，然后进行请求:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl http://localhost:8080/ucurl http://localhost:8080/users -H <span class="string">'Accept: application/xml'</span></div></pre></td></tr></table></figure>
<h3 id="返回-JSON-或者-XML-数据的注意事项"><a href="#返回-JSON-或者-XML-数据的注意事项" class="headerlink" title="返回 JSON 或者 XML 数据的注意事项"></a>返回 JSON 或者 XML 数据的注意事项</h3><p>默认情况下，<code>Spring</code> 会根据客户端携带的 <code>Accept</code> 请求头进行返回格式的猜测:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl http://localhost:8080/ucurl http://localhost:8080/users -H <span class="string">'Accept: application/xml'</span></div><div class="line">curl http://localhost:8080/ucurl http://localhost:8080/users -H <span class="string">'Accept: application/json'</span></div></pre></td></tr></table></figure>
<p>同样，也可以使用 <code>produces</code> 来指明返回内容 <code>Content-Type</code> 的设置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/users"</span>,</div><div class="line">                method = RequestMethod.GET,</div><div class="line">                produces = <span class="string">"application/json"</span>)</div><div class="line">                <span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">List&lt;User&gt; <span class="title">allUsers</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;User&gt;(<span class="number">2</span>);</div><div class="line">    users.add(createUser(<span class="string">"Tom"</span>, <span class="string">"123"</span>));</div><div class="line">    users.add(createUser(<span class="string">"Jerry"</span>, <span class="string">"456"</span>));</div><div class="line">    <span class="keyword">return</span> users;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当客户端能接受的 <code>Accept: application/json</code> 与服务器能够返回的数据 <code>Content-Type: application/xml</code> 不匹配的时候，将会产生 406 请求错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 406 Not Acceptable</div><div class="line">Date: Thu, 20 Jul 2017 09:11:37 GMT</div><div class="line">Cache-Control: must-revalidate,no-cache,no-store</div><div class="line">Content-Length: 0</div><div class="line">Server: Jetty(9.4.6.v20170531)</div></pre></td></tr></table></figure>
<p>另外添加依赖的时候，也要注意相同 <code>version</code> 统一的问题。</p>
<h3 id="用户认证自动跳转到登录页"><a href="#用户认证自动跳转到登录页" class="headerlink" title="用户认证自动跳转到登录页"></a>用户认证自动跳转到登录页</h3><p>添加安全认证依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityWebInitializer</span> <span class="keyword">extends</span> <span class="title">AbstractSecurityWebApplicationInitializer</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>进行用户配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableWebSecurity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        auth.inMemoryAuthentication()</div><div class="line">            .withUser(<span class="string">"Tom"</span>).password(<span class="string">"123"</span>).roles(<span class="string">"USER"</span>).and()</div><div class="line">            .withUser(<span class="string">"Jerry"</span>).password(<span class="string">"456"</span>).roles(<span class="string">"USER"</span>, <span class="string">"ADMIN"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当用户首次访问的时候，将会默认跳转到登录页面:</p>
<p><img src="17-07-20-18_50_13_366_222.png" alt=""></p>
<hr>
<p>注意，当开启 Web 安全认证机制的时候，为了防止 <code>CSRF</code> 问题，所有表单提交的时候，<a href="http://docs.spring.io/spring-security/site/docs/3.2.7.RELEASE/reference/htmlsingle/#csrf-include-csrf-token" target="_blank" rel="external">都应该携带一个 <code>_csrf</code> 字段</a>，否则会出现如下错误。<strong>Starting with Spring Security 3.2, CSRF protection is enabled by default.</strong> In fact, unless you take steps to work with CSRF protection or disable it, you’ll probably have trouble getting the forms in your application to submit successfully:</p>
<p><img src="17-07-20-20_28_19_779_159.png" alt=""></p>
<p>通过在表单中引入如下语句即可解决问题:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;form action=<span class="string">"/submit-params-form"</span> method=<span class="string">"POST"</span>&gt;</div><div class="line">  Name:&lt;br&gt;</div><div class="line">  &lt;input type=<span class="string">"text"</span> name=<span class="string">"name"</span> /&gt;&lt;br&gt;</div><div class="line">  Password:&lt;br&gt;</div><div class="line">  &lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span> /&gt;&lt;br&gt;</div><div class="line">  &lt;input type=<span class="string">"submit"</span> value=<span class="string">"Submit"</span> /&gt;</div><div class="line">  &lt;input type=<span class="string">"hidden"</span></div><div class="line">         name=<span class="string">"$&#123;_csrf.parameterName&#125;"</span></div><div class="line">         value=<span class="string">"$&#123;_csrf.token&#125;"</span> /&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>
<p>当需要上传文件的时候，一定要确保配置了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpittrWebAppInitializer</span></span></div><div class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractAnnotationConfigDispatcherServletInitializer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizeRegistration</span><span class="params">(javax.servlet.ServletRegistration.Dynamic registration)</span> </span>&#123;</div><div class="line">        registration.setMultipartConfig(<span class="keyword">new</span> MultipartConfigElement(<span class="string">"/tmp/"</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>否则还是会报 CSRF 错误问题</p>
<h3 id="页面拦截"><a href="#页面拦截" class="headerlink" title="页面拦截"></a>页面拦截</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableWebSecurity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// 不加 formLogin， 会返回 403</span></div><div class="line">        http.formLogin()</div><div class="line">            <span class="comment">// .loginPage("/login")</span></div><div class="line">            .and()</div><div class="line">            .authorizeRequests()</div><div class="line">            .antMatchers(HttpMethod.GET, <span class="string">"/home"</span>).hasRole(<span class="string">"USER"</span>)</div><div class="line">            .regexMatchers(<span class="string">"/.*form.*"</span>).authenticated()</div><div class="line">            .anyRequest().permitAll();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>添加依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>使用 <code>@CachePut</code> 来缓存这个方法返回的数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@CachePut</span>(<span class="string">"userList"</span>)</div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/users"</span>,</div><div class="line">            method = RequestMethod.GET,</div><div class="line">            produces = <span class="string">"application/json"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">List&lt;User&gt; <span class="title">allUsers</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;User&gt;(<span class="number">2</span>);</div><div class="line">        users.add(createUser(<span class="string">"Tom"</span>, <span class="string">"123"</span>));</div><div class="line">        users.add(createUser(<span class="string">"Jerry"</span>, <span class="string">"456"</span>));</div><div class="line">        <span class="keyword">return</span> users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与此同时，<code>User</code> 类必须能够序列化:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="访问数据库"><a href="#访问数据库" class="headerlink" title="访问数据库"></a>访问数据库</h3><p>添加依赖:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">  &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">  &lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;</div><div class="line">  &lt;version&gt;4.3.9.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line"></div><div class="line">&lt;dependency&gt;</div><div class="line">  &lt;groupId&gt;mysql&lt;/groupId&gt;</div><div class="line">  &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</div><div class="line">  &lt;version&gt;6.0.6&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>配置数据源:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</div><div class="line">        dataSource.setDriverClassName(<span class="string">"com.mysql.cj.jdbc.Driver"</span>);</div><div class="line">        dataSource.setUsername(<span class="string">"root"</span>);</div><div class="line">        dataSource.setPassword(<span class="string">"root"</span>);</div><div class="line">        dataSource.setUrl(<span class="string">"jdbc:mysql://localhost:3306/crawl"</span>);</div><div class="line">        <span class="keyword">return</span> dataSource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> UserRepository <span class="title">userRepository</span><span class="params">(JdbcTemplate jdbcTemplate)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcUserRepository(jdbcTemplate);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>数据库操作实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcUserRepository</span> <span class="keyword">implements</span> <span class="title">UserRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdbcUserRepository</span><span class="params">(JdbcTemplate jdbcTemplate)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findOne</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(<span class="string">"select id, name, password from users where id=?"</span>, <span class="keyword">new</span> UserRowMapper(), id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRowMapper</span> <span class="keyword">implements</span> <span class="title">RowMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">mapRow</span><span class="params">(ResultSet resultSet, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">            <span class="keyword">long</span> id = resultSet.getLong(<span class="string">"id"</span>);</div><div class="line">            String userName = resultSet.getString(<span class="string">"name"</span>);</div><div class="line">            String password = resultSet.getString(<span class="string">"password"</span>);</div><div class="line">            <span class="keyword">return</span> createUser(id, userName, password);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用数据库:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserRepository userRepository;</div><div class="line"></div><div class="line">    <span class="meta">@CachePut</span>(<span class="string">"userList"</span>)</div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/users"</span>,</div><div class="line">                    method = RequestMethod.GET,</div><div class="line">                    produces = <span class="string">"application/json"</span>)</div><div class="line">                    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">List&lt;User&gt; <span class="title">allUsers</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;User&gt;(<span class="number">4</span>);</div><div class="line">        User user = userRepository.findOne(<span class="number">1</span>);</div><div class="line">        users.add(user);</div><div class="line">        <span class="keyword">return</span> users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="中文支持"><a href="#中文支持" class="headerlink" title="中文支持"></a>中文支持</h3><p>首先 <code>JSP</code> 页面需要加入:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">language</span>=<span class="string">"java"</span> <span class="attr">pageEncoding</span>=<span class="string">"UTF-8"</span>%&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> %&gt;</span></div></pre></td></tr></table></figure>
<p>另外还需要加入 <a href="https://stackoverflow.com/questions/20863489/characterencodingfilter-dont-work-together-with-spring-security-3-2-0" target="_blank" rel="external"><code>CharacterEncodingFilter</code></a> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableWebSecurity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        CharacterEncodingFilter filter = <span class="keyword">new</span> CharacterEncodingFilter();</div><div class="line">        filter.setEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">        filter.setForceEncoding(<span class="keyword">true</span>);</div><div class="line">        http.addFilterBefore(filter, CsrfFilter.class);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h3><p>添加可选依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 可以方便我们操作，不是必须的 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>form</code> 表单标注 <code>enctype</code> 为 <code>multipart/form-data</code>, This tells the browser to submit the form as multipart data instead of form data. <strong>Each field has its own part in the multipart request</strong>:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/post-multipart-file-upload-form"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></div><div class="line">  Name:<span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">  Password:<span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span></span></div><div class="line"><span class="tag">         <span class="attr">name</span>=<span class="string">"$&#123;_csrf.parameterName&#125;"</span></span></div><div class="line"><span class="tag">         <span class="attr">value</span>=<span class="string">"$&#123;_csrf.token&#125;"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
<p>然后使用 <code>MultipartFile</code> 来接受上传的文件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/post-multipart-file-upload-form"</span>, method = RequestMethod.POST)</div><div class="line"><span class="meta">@ResponseBody</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uploadForm</span><span class="params">(MultipartFile file, @RequestParam(name = <span class="string">"name"</span>)</span> String name,</span></div><div class="line"><span class="function">                         @<span class="title">RequestParam</span><span class="params">(name = <span class="string">"password"</span>)</span> String password) </span>&#123;</div><div class="line">    System.out.println(String.format(<span class="string">"name=%s, password=%s"</span>, name, password));</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        FileUtils.writeByteArrayToFile(<span class="keyword">new</span> File(getFileSaveFolderPath() + file.getOriginalFilename()),</div><div class="line">                                       file.getBytes());</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="keyword">return</span> e.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">"OK"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="上传多个文件"><a href="#上传多个文件" class="headerlink" title="上传多个文件"></a>上传多个文件</h3><p>使用 <code>@RequestPart</code> 和 <code>javax.servlet.http.Part</code> 能够方便我们上传多个文件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/post-multiple-file"</span>, method = RequestMethod.POST)</div><div class="line"><span class="meta">@ResponseBody</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uploadMultipleFile</span><span class="params">(@RequestPart(<span class="string">"file1"</span>)</span> Part filePart1,</span></div><div class="line"><span class="function">                                 @<span class="title">RequestPart</span><span class="params">(<span class="string">"file2"</span>)</span> Part filePart2,</span></div><div class="line"><span class="function">                                 @RequestParam String name) </span>&#123;</div><div class="line">    File file = <span class="keyword">new</span> File(getFileSaveFolderPath() + filePart1.getSubmittedFileName())</div><div class="line">    FileUtils.copyInputStreamToFile(filePart1.getInputStream(), file);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>检查文件是否存在不能用如下代码来判断:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (filePart1 != <span class="keyword">null</span>) &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而应该判断输入流的可读字节长度:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasFile</span><span class="params">(Part apkFilePart)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        InputStream inputStream = apkFilePart.getInputStream();</div><div class="line">        <span class="keyword">return</span> inputStream.available() &gt; <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="comment">// Ignore It</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="上传文件的时候遇见的异常"><a href="#上传文件的时候遇见的异常" class="headerlink" title="上传文件的时候遇见的异常"></a>上传文件的时候遇见的异常</h3><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalStateException: Form too large: <span class="number">19857233</span> &gt; <span class="number">200000</span></div><div class="line">        at org.eclipse.jetty.server.Request.extractFormParameters(Request.java:<span class="number">365</span>) ~[jetty-server-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.server.Request.extractContentParameters(Request.java:<span class="number">303</span>) ~[jetty-server-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.server.Request.extractParameters(Request.java:<span class="number">257</span>) ~[jetty-server-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.server.Request.getParameter(Request.java:<span class="number">826</span>) ~[jetty-server-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at javax.servlet.ServletRequestWrapper.getParameter(ServletRequestWrapper.java:<span class="number">194</span>) ~[javax.servlet-api-<span class="number">3.1</span>.0.jar:<span class="number">3.1</span>.0]</div><div class="line">        at javax.servlet.ServletRequestWrapper.getParameter(ServletRequestWrapper.java:<span class="number">194</span>) ~[javax.servlet-api-<span class="number">3.1</span>.0.jar:<span class="number">3.1</span>.0]</div><div class="line">        at org.jasig.cas.client.util.CommonUtils.safeGetParameter(CommonUtils.java:<span class="number">380</span>) ~[cas-client-core-<span class="number">3.4</span>.1.jar:<span class="number">3.4</span>.1]</div></pre></td></tr></table></figure>
<p>见 <a href="https://github.com/eclipse/jetty.project/blob/jetty-9.4.x/jetty-server/src/main/java/org/eclipse/jetty/server/Request.java#L486" target="_blank" rel="external">Request.java</a></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">gretty &#123;</div><div class="line">    jvmArgs = [<span class="string">'-Dorg.eclipse.jetty.server.Request.maxFormContentSize=100000000'</span>]</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">org.eclipse.jetty.util.Utf8Appendable$NotUtf8Exception: Not valid UTF8! <span class="keyword">byte</span> Ef in state <span class="number">2</span></div><div class="line">        at org.eclipse.jetty.util.Utf8Appendable.appendByte(Utf8Appendable.java:<span class="number">195</span>) ~[jetty-util-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.util.Utf8Appendable.append(Utf8Appendable.java:<span class="number">134</span>) ~[jetty-util-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.util.UrlEncoded.decodeUtf8To(UrlEncoded.java:<span class="number">595</span>) ~[jetty-util-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.util.UrlEncoded.decodeTo(UrlEncoded.java:<span class="number">636</span>) ~[jetty-util-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.server.Request.extractFormParameters(Request.java:<span class="number">371</span>) ~[jetty-server-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.server.Request.extractContentParameters(Request.java:<span class="number">303</span>) ~[jetty-server-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.server.Request.extractParameters(Request.java:<span class="number">257</span>) ~[jetty-server-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div><div class="line">        at org.eclipse.jetty.server.Request.getParameter(Request.java:<span class="number">826</span>) ~[jetty-server-<span class="number">9.2</span>.15.v20160210.jar:<span class="number">9.2</span>.15.v20160210]</div></pre></td></tr></table></figure>
<p><img src="17-07-28-09_13_12_993_157.png" alt=""></p>
<h3 id="测试-Controller"><a href="#测试-Controller" class="headerlink" title="测试 Controller"></a>测试 <code>Controller</code></h3><p>添加依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>执行测试，首先创建 <code>MockMvc</code> 对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">MockMvc mockMvc;</div><div class="line"></div><div class="line"><span class="meta">@Before</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</div><div class="line">    InternalResourceViewResolver resourceViewResolver = <span class="keyword">new</span> InternalResourceViewResolver();</div><div class="line">    resourceViewResolver.setPrefix(<span class="string">"/WEB-INF/views/"</span>);</div><div class="line">    resourceViewResolver.setSuffix(<span class="string">".jsp"</span>);</div><div class="line">    resourceViewResolver.setExposeContextBeansAsAttributes(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    mockMvc = MockMvcBuilders.standaloneSetup(<span class="keyword">new</span> HomeController())</div><div class="line">        .setViewResolvers(resourceViewResolver)</div><div class="line">        .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意在这里，一定要<a href="https://myshittycode.com/2014/01/17/mockmvc-circular-view-path-view-would-dispatch-back-to-the-current-handler-url-view-again/" target="_blank" rel="external">显示地设置上 <code>ViewResolver</code></a> ，否则会出现如下错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MockMvc : Circular view path [view]: would dispatch back to the current handler URL [/view] again</div></pre></td></tr></table></figure>
<p>然后模拟请求并测试返回内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPageWithDynamicValue</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/page-with-dynamic-value"</span>))</div><div class="line">        .andExpect(MockMvcResultMatchers.status().isOk())</div><div class="line">        .andExpect(MockMvcResultMatchers.view().name(<span class="string">"page-with-dynamic-value"</span>))</div><div class="line">        .andExpect(MockMvcResultMatchers.model().attributeExists(<span class="string">"dynamicValue"</span>))</div><div class="line">        .andExpect(MockMvcResultMatchers.model().attribute(<span class="string">"dynamicValue"</span>, <span class="string">"Dynamic Value"</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><a href="http://blog.trifork.com/2012/12/11/properly-testing-spring-mvc-controllers/" target="_blank" rel="external">如何正确的测试 <code>Controller</code></a></p>
<p>一般测试 <code>Controller</code>，都是通过 <strong><code>Mock Service</code></strong> 来测的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeopleControllerTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@InjectMocks</span></div><div class="line">    PeopleController controller;</div><div class="line"></div><div class="line">    <span class="meta">@Mock</span></div><div class="line">    PeopleService mockPeopleService;</div><div class="line"></div><div class="line">    <span class="meta">@Before</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testListPeopleInGroup</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;Person&gt; expectedPeople = asList(<span class="keyword">new</span> Person());</div><div class="line">        when(mockPeopleService.listPeople(<span class="string">"group"</span>)).thenReturn(expectedPeople);</div><div class="line"></div><div class="line">        ModelMap modelMap = <span class="keyword">new</span> ModelMap();</div><div class="line">        String viewName = controller.listPeopleInGroup(<span class="string">"group"</span>, modelMap);</div><div class="line"></div><div class="line">        assertEquals(<span class="string">"peopleList"</span>, viewName);</div><div class="line">        assertThat(modelMap, hasEntry(<span class="string">"people"</span>, (Object) expectedPeople));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 <code>Spring MVC Test</code> 框架之后:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeopleControllerTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@InjectMocks</span></div><div class="line">    PeopleController controller;</div><div class="line"></div><div class="line">    <span class="meta">@Mock</span></div><div class="line">    PeopleService mockPeopleService;</div><div class="line"></div><div class="line">    <span class="meta">@Mock</span></div><div class="line">    View mockView;</div><div class="line"></div><div class="line">    MockMvc mockMvc;</div><div class="line"></div><div class="line">    <span class="meta">@Before</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</div><div class="line">        mockMvc = standaloneSetup(controller)</div><div class="line">                .setSingleView(mockView)</div><div class="line">                .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testListPeopleInGroup</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        List&lt;Person&gt; expectedPeople = asList(<span class="keyword">new</span> Person());</div><div class="line">        when(mockPeopleService.listPeople(<span class="string">"someGroup"</span>)).thenReturn(expectedPeople);</div><div class="line"></div><div class="line">        mockMvc.perform(get(<span class="string">"/people/someGroup"</span>))</div><div class="line">                .andExpect(status().isOk())</div><div class="line">                .andExpect(model().attribute(<span class="string">"people"</span>, expectedPeople))</div><div class="line">                .andExpect(view().name(<span class="string">"peopleList"</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Spring-MyBatis-Transaction-Management"><a href="#Spring-MyBatis-Transaction-Management" class="headerlink" title="Spring + MyBatis + Transaction Management"></a><a href="http://www.mybatis.org/spring/transactions.html" target="_blank" rel="external">Spring + MyBatis + Transaction Management</a></h3><p>MyBatis <code>SqlSession</code> provides you with <strong>特定方法</strong> to handle transactions <strong>通过编程</strong>. But when using MyBatis-Spring your beans will be injected with a Spring managed SqlSession or a Spring managed mapper. That means that <strong>Spring will always handle your transactions</strong>.</p>
<p>You <strong>不能调用</strong> <code>SqlSession.commit()</code>, <code>SqlSession.rollback()</code> or <code>SqlSession.close()</code> over a Spring managed SqlSession. If you try to do so, a <code>UnsupportedOperationException</code> exception will be thrown. Note these methods are not exposed in injected mapper classes.</p>
<p>Regardless of your JDBC connection’s autocommit setting, any execution of a SqlSession data method or any call to a mapper method outside a Spring transaction will be automatically committed.</p>
<p>If you want to control your transactions programmatically please refer to chapter 10.6 of the Spring reference manual. This code shows how to handle a transaction manually using the <code>PlatformTransactionManager</code> described in section 10.6.2.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">DefaultTransactionDefinition def = <span class="keyword">new</span> DefaultTransactionDefinition();</div><div class="line">def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</div><div class="line"></div><div class="line">TransactionStatus status = txManager.getTransaction(def);</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    userMapper.insertUser(user);</div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span> (MyException ex) &#123;</div><div class="line">    txManager.rollback(status);</div><div class="line">    <span class="keyword">throw</span> ex;</div><div class="line">&#125;</div><div class="line"></div><div class="line">txManager.commit(status);</div></pre></td></tr></table></figure>
<hr>
<ul>
<li><strong><code>Spring</code> 默认事务隔离级别</strong>: <code>Isolation.DEFAULT</code>:</li>
</ul>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html" target="_blank" rel="external"><code>MySQL</code> 默认事务隔离级别</a>: InnoDB offers all four transaction isolation levels described by the SQL:1992 standard: <code>READ UNCOMMITTED</code>, <code>READ COMMITTED</code>, <code>REPEATABLE READ</code>, and <code>SERIALIZABLE</code>. <strong>The default isolation level for InnoDB is <code>REPEATABLE READ</code> 可重复读</strong>.</p>
<ul>
<li><strong><code>Spring</code> 默认事务传播机制</strong>: <code>Propagation.REQUIRED</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Inherited</span></div><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Transactional &#123;</div><div class="line">	<span class="function">Propagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED</span>;</div><div class="line">	<span class="function">Isolation <span class="title">isolation</span><span class="params">()</span> <span class="keyword">default</span> Isolation.DEFAULT</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="IsolationLevels2.png" alt=""></p>
<p><strong>性能</strong>: 脏读 &gt; 读写提交 &gt; 可重复读 &gt; 序列化</p>
<p><a href="http://www.byteslounge.com/tutorials/spring-transaction-isolation-tutorial" target="_blank" rel="external">四种事务</a>解释如下:</p>
<p><strong>(1) READ_UNCOMMITTED</strong>:</p>
<p>READ_UNCOMMITTED isolation level states that <strong>a transaction may read data that is still uncommitted by other transactions 一个事务可能会读到一个其它事务未提交的脏数据</strong></p>
<p><img src="READ_UNCOMMITTED.jpg" alt=""></p>
<p><img src="2017_08_31_21_16_32.png" alt=""></p>
<p><strong>(2) READ_COMMITTED 读写提交</strong>:</p>
<p>READ_COMMITTED isolation level states that <strong>a transaction can’t read data that is not yet committed by other transactions 一个事务无法阅读其它事务还未提交的数据</strong>.</p>
<p><img src="non_repeatable_read.png" alt=""></p>
<p><img src="2017_08_31_21_18_35.png" alt=""></p>
<p><strong>读写提交产生的问题</strong>:</p>
<p><img src="2017_08_31_21_08_14.png" alt=""></p>
<p><strong>(3) REPEATABLE READ</strong>:</p>
<p>可重复读是针对于<strong>同一条记录</strong>而言的，对于不同的记录会发生下面的场景:</p>
<p><img src="2017_08_31_21_09_38.png" alt=""></p>
<p>幻读是针对<strong>删除和插入</strong>的。</p>
<p><strong>(4) SERIALIZABLE</strong>:</p>
<p>所有的操作都会按照顺序执行，不会出现脏读、不可重读和幻读的情况:</p>
<p><img src="2017_08_31_21_11_24.png" alt=""></p>
<h3 id="任务调度-Quartz"><a href="#任务调度-Quartz" class="headerlink" title="任务调度 - Quartz"></a>任务调度 - <a href="http://www.quartz-scheduler.org/" target="_blank" rel="external"><code>Quartz</code></a></h3><h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a><code>web.xml</code></h3><h4 id="context-param"><a href="#context-param" class="headerlink" title="context-param"></a>context-param</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">"2.5"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></div><div class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">&lt;!-- 值可以被所有的 Servlets 读取 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 根上下文的位置 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/spring/root-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="listener"><a href="#listener" class="headerlink" title="listener"></a>listener</h4><p>监听 web 容器中的事件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> javax.servlet.ServletContextEvent;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletContextListener;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Bootstrap listener to start up and shut down Spring's root.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextLoaderListener</span> <span class="keyword">extends</span> <span class="title">ContextLoader</span></span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 初始化根 web 应用的上下文</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</div><div class="line">        initWebApplicationContext(event.getServletContext());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 关闭根 web 应用的上下文</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</div><div class="line">        closeWebApplicationContext(event.getServletContext());</div><div class="line">        ContextCleanupListener.cleanupAttributes(event.getServletContext());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h4><p><img src="2017_10_07_11_17_30.png" alt=""></p>
<p><code>servlet</code> 是一个 <code>Java</code> 编写的程序，其生命周期分为: <strong>初始化、运行和销毁</strong>。</p>
<h5 id="1-初始化"><a href="#1-初始化" class="headerlink" title="(1) 初始化"></a>(1) 初始化</h5><ul>
<li><code>servlet</code> 容器加载 <code>servlet</code> 类，把 <code>servlet</code> 类的 <code>.class</code> 文件读取到内存中</li>
<li><code>servlet</code> 容器创建一个 <code>ServletConfig</code> 对象。<code>ServletConfig</code> 对象包含了 <code>servlet</code> 的初始化配置信息。</li>
<li><code>servlet</code> 容器创建一个 <code>servlet</code> 对象</li>
<li><code>servlet</code> 容器调用 <code>servlet</code> 对象的 <code>init</code> 方法进行初始化</li>
</ul>
<h5 id="2-运行"><a href="#2-运行" class="headerlink" title="(2) 运行"></a>(2) 运行</h5><p>当 <code>servlet</code> 容器接收到一个请求时，<code>servlet</code> 容器会针对这个请求创建 <code>ServletRequest</code> 和 <code>ServletResponse</code> 对象，然后调用 <code>service</code> 方法。</p>
<h5 id="3-销毁"><a href="#3-销毁" class="headerlink" title="(3) 销毁"></a>(3) 销毁</h5><ul>
<li><code>servlet</code> 容器先调用 <code>servlet</code> 对象的 <code>destroy</code> 方法，然后再销毁 <code>servlet</code> 对象，以及 <code>ServletConfig</code> 对象。</li>
</ul>
<h4 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<p>自定义 <code>filter</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>userinfofilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>plm.common.filters.UserFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>userinfofilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="Tomcat-读取-web-xml-各个节点的顺序"><a href="#Tomcat-读取-web-xml-各个节点的顺序" class="headerlink" title="Tomcat 读取 web.xml 各个节点的顺序"></a><code>Tomcat</code> 读取 <code>web.xml</code> 各个节点的顺序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardContext</span> <span class="keyword">extends</span> <span class="title">ContainerBase</span></span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Context</span>, <span class="title">NotificationEmitter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">        <span class="comment">// Merge the context initialization parameters specified in the application</span></div><div class="line">        <span class="comment">// deployment descriptor with the application parameters described in the</span></div><div class="line">        <span class="comment">// server configuration.</span></div><div class="line">        mergeParameters();</div><div class="line">        </div><div class="line">        <span class="comment">// Configure and call application event listeners</span></div><div class="line">        <span class="keyword">if</span> (ok) &#123;</div><div class="line">            <span class="keyword">if</span> (!listenerStart()) &#123;</div><div class="line">                ok = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">            </div><div class="line">        <span class="comment">// Configure and call application filters</span></div><div class="line">        <span class="keyword">if</span> (ok) &#123;</div><div class="line">            <span class="keyword">if</span> (!filterStart()) &#123;</div><div class="line">                log.error(sm.getString(<span class="string">"standardContext.filterFail"</span>));</div><div class="line">                ok = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Load and initialize all "load on startup" servlets</span></div><div class="line">        <span class="keyword">if</span> (ok) &#123;</div><div class="line">            <span class="keyword">if</span> (!loadOnStartup(findChildren()))&#123;</div><div class="line">                log.error(sm.getString(<span class="string">"standardContext.servletFail"</span>));</div><div class="line">                ok = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mergeParameters</span><span class="params">()</span> </span>&#123;</div><div class="line">        ServletContext sc = getServletContext();</div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;String,String&gt; entry : mergedParams.entrySet()) &#123;</div><div class="line">            sc.setInitParameter(entry.getKey(), entry.getValue());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Tomcat-解析-web-xml"><a href="#Tomcat-解析-web-xml" class="headerlink" title="Tomcat 解析 web.xml"></a><code>Tomcat</code> 解析 <code>web.xml</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextConfig</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Scan the web.xml files that apply to the web application and merge them</span></div><div class="line"><span class="comment">     * using the rules defined in the spec.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">webConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">        WebXmlParser webXmlParser = <span class="keyword">new</span> WebXmlParser(context.getXmlNamespaceAware(),</div><div class="line">                context.getXmlValidation(), context.getXmlBlockExternal());</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (!webXmlParser.parseWebXml(contextWebXml, webXml, <span class="keyword">false</span>)) &#123;</div><div class="line">            ok = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 <code>org.xml.sax</code> 来解析，<code>SAX</code> 基于事件的解析，解析器在一次读取 <code>XML</code> 文件中根据读取的数据<strong>产生相应的事件</strong>，由应用程序实现相应的事件处理逻辑，即它是一种<strong>“推”</strong>的解析方式；这种解析方法<strong>速度快、占用内存少</strong>，但是它需要应用程序自己处理解析器的状态，实现起来会比较麻烦。</p>
<p>JAVA 解析 XML 通常有两种方式， <strong><code>org.w3c.dom</code> 和 <code>SAX</code></strong>。DOM 虽然是 W3C 的标准，提供了标准的解析方式，但它的解析效率一直不尽如人意，因为使用 DOM 解析 XML 时，解析器<strong>读入整个文档并构建一个驻留内存的树结构（节点树）</strong>，然后您的代码才可以使用 DOM 的标准接口来操作这个树结构。但大部分情况下我们只对文档的部分内容感兴趣，根本就不用先解析整个文档，并且从节点树的根节点来索引一些我们需要的数据也是非常耗时的。</p>
<p>SAX是一种XML解析的替代方法。相比于文档对象模型DOM，SAX 是读取和操作 XML 数据的更快速、更轻量的方法。SAX 允许您在读取文档时处理它，从而不必等待整个文档被存储之后才采取操作。它不涉及 DOM 所必需的开销和概念跳跃。 SAX API是一个基于事件的API ，适用于处理数据流，即<strong>随着数据的流动而依次处理数据</strong>。SAX API 在其解析您的文档时发生一定事件的时候会通知您。在您对其响应时，您不作保存的数据将会被抛弃。</p>
<h3 id="Spring-如何映射-RequestMapping"><a href="#Spring-如何映射-RequestMapping" class="headerlink" title="Spring 如何映射 RequestMapping"></a>Spring 如何映射 RequestMapping</h3><p>重点关注 <code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</code> 这个类。</p>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p><img src="2017_10_14_15_25_34.png" alt=""></p>
<h3 id="No-Converter"><a href="#No-Converter" class="headerlink" title="No Converter"></a>No Converter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Caused by: java.lang.IllegalArgumentException: No converter found for return value of type: class com.zk.ResultBean</div></pre></td></tr></table></figure>
<p>The problem was that one of the nested objects in <code>Foo</code> didn’t have any <code>getter/setter</code></p>
<h3 id="WEB-INF"><a href="#WEB-INF" class="headerlink" title="WEB-INF"></a>WEB-INF</h3><p>部署 <code>Java EE</code> 项目必须遵守规范:</p>
<ul>
<li>The servlet container (e.g Tomcat)</li>
<li><code>Servlet</code> 规范</li>
</ul>
<p><img src="2017_10_23_22_16_33.png" alt=""></p>
<ul>
<li><code>WEB-INF</code> 目录不是 <code>public</code> 目录,<strong>浏览器不能直接访问</strong></li>
<li>使用 <strong><code>ServletContext</code></strong> 类上面的 <code>getResource</code> 和 <code>getResourceAsStream</code> 方法能够直接访问 <code>WEB-INF</code> 目录</li>
<li>确保开发项目的目录结构和最后打成 <code>WAR</code> 包的目录结构不同,开发项目的目录结构,经过 <code>build</code> 过程,变为 <code>WAR</code> 包的目录结构</li>
<li><code>src/main/java</code> 和 <code>src/main/resources</code> 目录编译后会被放进 <code>WEB-INF/classes</code> 目录下面</li>
<li><code>Servlet 3.0</code> 之后, 放置在 <code>WEB-INF/lib/xxx.jar/META-INF/resources</code> 目录下的也可以能够被浏览器直接访问了:</li>
</ul>
<p><img src="resources-jar.png" alt=""></p>
<p>以上文件可以用如下 <code>URL</code> 分别访问:</p>
<ul>
<li><code>http://host:port/webcontext/scripts.js</code></li>
<li><code>http://host:port/webcontext/styles.css</code></li>
<li><code>http://host:port/webcontext/welcome.png</code></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/19/springmvc/" data-id="cjcdlsfyy0065diemayxldfzj" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-vim" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/13/vim/" class="article-date">
  <time datetime="2017-07-13T02:59:59.000Z" itemprop="datePublished">2017-07-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/13/vim/">vim</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Vim"><a href="#Vim" class="headerlink" title="Vim"></a>Vim</h2><h3 id="1-帮助"><a href="#1-帮助" class="headerlink" title="(1) 帮助"></a>(1) 帮助</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:h x</div></pre></td></tr></table></figure>
<h3 id="2-删除字符"><a href="#2-删除字符" class="headerlink" title="(2) 删除字符"></a>(2) 删除字符</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 删除一个字符</span></div><div class="line">x</div><div class="line"><span class="comment"># 删除一个字符，并进入 Insert 模式</span></div><div class="line">s</div><div class="line"><span class="comment"># 删除整行</span></div><div class="line">dd</div><div class="line"><span class="comment"># 向后删除，但是保留光标下的字符</span></div><div class="line">db</div><div class="line"><span class="comment"># 向前删除，连同光标下的字符一块删除</span></div><div class="line">dw</div><div class="line"><span class="comment"># 删除一个单词，即使你位于这个单词的中间，它也能删除掉这个单词</span></div><div class="line">daw</div></pre></td></tr></table></figure>
<h3 id="3-缩进"><a href="#3-缩进" class="headerlink" title="(3) 缩进"></a>(3) 缩进</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 将 [当前行 -&gt; 文件末尾的所有行] 统一向右缩进</span></div><div class="line">&gt;G</div></pre></td></tr></table></figure>
<h3 id="4-移动"><a href="#4-移动" class="headerlink" title="(4) 移动"></a>(4) 移动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 移动到这一行末尾</span></div><div class="line">$</div></pre></td></tr></table></figure>
<h3 id="5-编辑"><a href="#5-编辑" class="headerlink" title="(5) 编辑"></a>(5) 编辑</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 在当前光标右侧编辑</span></div><div class="line">a</div><div class="line"><span class="comment"># 在当前行尾编辑</span></div><div class="line">A</div></pre></td></tr></table></figure>
<h3 id="6-搜索"><a href="#6-搜索" class="headerlink" title="(6) 搜索"></a>(6) 搜索</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 跳转到这一行中 a 字符出现的下一个地方</span></div><div class="line">fa</div><div class="line"><span class="comment"># 跳转到这一行中 a 字符出现的上一个地方</span></div><div class="line">Fa</div><div class="line"><span class="comment"># 跳转到所有搜索到的字符的下一个目标</span></div><div class="line">;</div><div class="line"><span class="comment"># 跳转到所有搜索到的字符的上一个目标</span></div><div class="line">,</div><div class="line"><span class="comment"># 全文正则搜索 content</span></div><div class="line">/content</div><div class="line"><span class="comment"># 如果想要搜索 http://www.uzzf.com/apk/383198.html</span></div><div class="line">/http:\/\/www\.uzzf\.com\/apk\/383198\.html</div><div class="line"><span class="comment"># 向下匹配</span></div><div class="line">n</div><div class="line"><span class="comment"># 向上匹配</span></div><div class="line">N</div></pre></td></tr></table></figure>
<h3 id="7-Operator-Motion-Action"><a href="#7-Operator-Motion-Action" class="headerlink" title="(7) Operator + Motion = Action"></a>(7) Operator + Motion = Action</h3><h3 id="8-返回正常模式"><a href="#8-返回正常模式" class="headerlink" title="(8) 返回正常模式"></a>(8) 返回正常模式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Esc</div><div class="line">Ctrl - [</div></pre></td></tr></table></figure>
<h3 id="9-Visual-Mode"><a href="#9-Visual-Mode" class="headerlink" title="(9) Visual Mode"></a>(9) Visual Mode</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Enable character-wise Visual mode</span></div><div class="line">v</div><div class="line"><span class="comment"># Enable line-wise Visual mode</span></div><div class="line">V</div><div class="line"><span class="comment"># Enable block-wise Visual mode</span></div><div class="line">Ctrl - v</div></pre></td></tr></table></figure>
<h3 id="10-删除空白行"><a href="#10-删除空白行" class="headerlink" title="(10) 删除空白行"></a>(10) 删除空白行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:g/^$/d</div></pre></td></tr></table></figure>
<p><code>:g</code> will execute a command on lines which match a regex. The regex is ‘blank line’ and the command is <code>:d</code> (delete)</p>
<h3 id="11-显示-tab-符号"><a href="#11-显示-tab-符号" class="headerlink" title="(11) 显示 tab 符号"></a>(11) 显示 <code>tab</code> 符号</h3><p>Easiest method is to do <strong><code>:set list</code></strong>, which will show tabs as <strong><code>^I</code></strong> and end of line as <code>$</code>.</p>
<p><img src="17-08-27-23_32_26_995_124.png" alt=""></p>
<p>使用 <code>:set nolist</code> 来取消显示</p>
<h3 id="查找文件"><a href="#查找文件" class="headerlink" title="查找文件"></a>查找文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:find SimpleExecutor.java</div></pre></td></tr></table></figure>
<h3 id="多窗口"><a href="#多窗口" class="headerlink" title="多窗口"></a>多窗口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 关闭当前窗口</span></div><div class="line">&lt;C-w&gt;c</div><div class="line"><span class="comment"># 仅保留当前窗口</span></div><div class="line">&lt;C-w&gt;o</div><div class="line"><span class="comment"># 窗口分割为上下两个窗口</span></div><div class="line">&lt;C-w&gt;s</div><div class="line"><span class="comment"># 窗口分割为左右两个窗口</span></div><div class="line">&lt;C-w&gt;v</div><div class="line"><span class="comment"># 在所有打开的窗口中切换焦点&gt;</span></div><div class="line">&lt;C-w&gt;w</div></pre></td></tr></table></figure>
<h3 id="工作路径"><a href="#工作路径" class="headerlink" title="工作路径"></a>工作路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 查看当前工作路径</div><div class="line">：pwd</div><div class="line"># 查看当前文件所在的全路径</div><div class="line">&lt;C-g&gt;</div><div class="line"># 在工作区的子目录下递归搜索文件 (最好把这句话放在 vimrc 中)</div><div class="line">set path=$PWD/**</div><div class="line"># 打开当前文件所在的目录</div><div class="line">:Ex</div></pre></td></tr></table></figure>
<h3 id="上下移动"><a href="#上下移动" class="headerlink" title="上下移动"></a>上下移动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 向下移动半个屏幕</span></div><div class="line">&lt;C<span class="_">-d</span>&gt;</div><div class="line"><span class="comment"># 向上移动半个屏幕</span></div><div class="line">&lt;C-u&gt;</div><div class="line"><span class="comment"># 向下一行一行移动</span></div><div class="line">j</div><div class="line"><span class="comment"># 向上一行一行移动</span></div><div class="line">k</div></pre></td></tr></table></figure>
<h3 id="不响应键盘的时候"><a href="#不响应键盘的时候" class="headerlink" title="不响应键盘的时候"></a>不响应键盘的时候</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Ctrl - Q</div></pre></td></tr></table></figure>
<p>退出</p>
<h3 id="vimrc-文件的注释行"><a href="#vimrc-文件的注释行" class="headerlink" title="vimrc 文件的注释行"></a><code>vimrc</code> 文件的注释行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;This is a comment in vimrc. It does not have a closing quote</div></pre></td></tr></table></figure>
<h3 id="查找并替换"><a href="#查找并替换" class="headerlink" title="查找并替换"></a>查找并替换</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 替换整个文件的所有匹配的</span></div><div class="line">:%s/foo/bar/g</div><div class="line"></div><div class="line"><span class="comment"># 只是替换当前行的所有匹配的</span></div><div class="line">:s/foo/bar/g</div><div class="line"></div><div class="line"><span class="comment"># 询问是否替换，需要确认</span></div><div class="line">:%s/foo/bar/gc</div><div class="line"></div><div class="line"><span class="comment"># 5(包括)-12(不包括) 行进行替换</span></div><div class="line">:5,12s/foo/bar/g</div></pre></td></tr></table></figure>
<h3 id="借助-tmux-实现分屏"><a href="#借助-tmux-实现分屏" class="headerlink" title="借助 tmux 实现分屏"></a>借助 <code>tmux</code> 实现分屏</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 水平分屏</span></div><div class="line">Ctrl - b <span class="string">"</span></div><div class="line"><span class="string"># 垂直分屏</span></div><div class="line"><span class="string">Ctrl - b %</span></div><div class="line"><span class="string"># 显示窗口号</span></div><div class="line"><span class="string">Ctrl - b q</span></div><div class="line"><span class="string"># 在窗口间切换光标</span></div><div class="line"><span class="string">Ctrl - b ←↑→↓</span></div><div class="line"><span class="string"># 关闭当前窗口</span></div><div class="line"><span class="string">Ctrl - b x</span></div></pre></td></tr></table></figure>
<h3 id="临时显示文件路径"><a href="#临时显示文件路径" class="headerlink" title="临时显示文件路径"></a>临时显示文件路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Ctrl - G</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/13/vim/" data-id="cjcdlsfz6006gdiemfave1h85" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-queue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/13/queue/" class="article-date">
  <time datetime="2017-07-13T01:03:59.000Z" itemprop="datePublished">2017-07-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/13/queue/">java-messaging</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Java-Messaging"><a href="#Java-Messaging" class="headerlink" title="Java Messaging"></a>Java Messaging</h2><p>XMPP: Extensible Messaging and Presence Protocol<br>AMQP: Advanced Messaging Queueing Protocol</p>
<h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动 RabbitMQ-Server</span></div><div class="line">sudo rabbitmq-server</div><div class="line"><span class="comment"># 关闭 RabbitMQ-Server</span></div><div class="line">sudo -u rabbitmq rabbitmqctl stop</div><div class="line"><span class="comment"># 检查服务器状态</span></div><div class="line">sudo rabbitmqctl status</div><div class="line"><span class="comment"># 查看日志文件</span></div><div class="line">cat /var/<span class="built_in">log</span>/rabbitmq/rabbit@zk-pc.log</div><div class="line"><span class="comment"># 监控，http://localhost:15672</span></div><div class="line">sudo rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://oriolrius.cat/blog/series/amqp-and-rabbitmq/" target="_blank" rel="external">Hello World using ‘kombu’ library and python</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/13/queue/" data-id="cjcdlsfyp005pdiema2q2xem7" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/blog/page/11/">&laquo; Prev</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/10/">10</a><a class="page-number" href="/blog/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/blog/page/13/">13</a><a class="page-number" href="/blog/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/23/">23</a><a class="extend next" rel="next" href="/blog/page/13/">Next&raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    

  
    
  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/01/06/where-the-time-actually-gone/">时间都去哪儿了</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/dev-reflection/">开发反思</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/my-microblog/">我的微博</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/gcc-basic/">gcc-basic</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/java-internal/">Java Internal</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>