<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="赵坤的个人网站">
<meta property="og:type" content="website">
<meta property="og:title" content="代码人生">
<meta property="og:url" content="http://blog.kunzhao.org/page/19/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="赵坤的个人网站">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码人生">
<meta name="twitter:description" content="赵坤的个人网站">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Tomcat" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/14/Tomcat/" class="article-date">
  <time datetime="2017-06-14T12:34:37.000Z" itemprop="datePublished">2017-06-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/14/Tomcat/">Tomcat</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h2><p><img src="tomcat_architecture.jpg" alt=""></p>
<p>目录说明:</p>
<p><img src="tomcat_folder.png" alt=""></p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd $&#123;tomcat.source&#125;</div><div class="line">ant</div></pre></td></tr></table></figure>
<p>编译成功之后，一个可以使用的 <code>tomcat</code> 被放在了目录:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$&#123;tomcat.source&#125;/output/build</div></pre></td></tr></table></figure>
<hr>
<p>编译成 <code>eclipse</code> 项目，可以使用<a href="https://tomcat.apache.org/tomcat-8.5-doc/building.html" target="_blank" rel="external">参考</a>。</p>
<p>注意，在执行 <code>ant ide-eclipse</code> 之前必须先执行 <code>ant</code> 这个命令，否则执行不成功。</p>
<h3 id="日志问题"><a href="#日志问题" class="headerlink" title="日志问题"></a>日志问题</h3><p>When running Tomcat on unixes, the <strong>console output (控制台输出)</strong> is usually redirected to the <strong>file (文件)</strong> named <code>catalina.out</code>.</p>
<p>要想从 <code>eclipse</code> 中启动能够查看 <code>Debug</code> 级别的<a href="https://stackoverflow.com/questions/2233053/where-can-i-view-tomcat-log-files-in-eclipse" target="_blank" rel="external">输出日志</a>，需要做如下两个步骤:</p>
<p>(1) 需要<strong>添加更多系统参数</strong>:</p>
<p><img src="2017_12_29_23_09_10.png" alt="start-tomcat"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-Dcatalina.home=$&#123;project_loc:/tomcat-<span class="number">9.0</span>.x/java/org/apache/catalina/startup/Bootstrap.java&#125;/output/build</div><div class="line">-Djava.util.logging.config.file=$&#123;project_loc:/tomcat-<span class="number">9.0</span>.x/java/org/apache/catalina/startup/Bootstrap.java&#125;/conf/logging.properties</div><div class="line">-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager</div></pre></td></tr></table></figure>
<p>(2) 另外一个重要的地方，就是需要编辑 <code>conf/logging.properties</code> 文件，添加如下一句话:</p>
<p><a href="2017_12_29_23_10_59.png">logging.properties</a></p>
<h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><ul>
<li><strong><code>org.apache.catalina.Lifecycle</code></strong>: 通用组件的声明周期接口, 可以 <code>start()</code>, <code>stop()</code>, <code>destroy()</code> 等</li>
<li><strong><code>org.apache.catalina.LifecycleListener</code></strong>: 监听一些重要事件</li>
</ul>
<p>容器为了实现自己的功能经常要绑定一些其他组件,这些组件的功能可能被共享,也可以被单独定制,下面是被使用的组件:</p>
<ul>
<li><strong><code>Loader</code></strong>:<code>ClassLoader</code>,加载 Java Classes;</li>
<li><strong><code>Logger</code></strong>:实现了 <code>ServletContext</code> 的 log 方法,用于记录日志;</li>
<li><strong><code>Manager</code></strong>:管理与容器绑定的 <code>Session</code> 池;</li>
<li><strong><code>Realm</code></strong>: 用户安全管理</li>
<li><strong><code>Resources</code></strong>: JNDI 资源访问</li>
<li><strong><code>org.apache.catalina.ContainerListener</code></strong>: 容器事件监听器</li>
</ul>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>启动 tomcat 有两种方式：</p>
<ul>
<li>双击 <code>bin/startup.sh</code></li>
<li>运行 <code>bin/catalina.sh run</code></li>
</ul>
<p>它们对应于 <code>Bootstrap</code> 与 <code>Catalina</code> 两个类，我们现在只关心 <code>Catalina</code> 这个类，这个类使用 <code>Apache Digester</code> 解析 <code>conf/server.xml</code> 文件生成 tomcat 组件，然后再调用 <code>Embedded</code>类的 <code>start</code> 方法启动 tomcat。</p>
<p>所以，集成 Tomcat 的方式就有以下两种了：</p>
<ul>
<li>沿用 tomcat 自身的 <code>server.xml</code></li>
<li>自己定义一个 <code>xml</code> 格式来配置 tocmat 的各参数，自己再写解析这段 xml，然后使用 tomcat 提供的 API 根据这些 xml 来生成 Tomcat 组件，最后调用 <code>Embedded</code> 类的 <code>start</code> 方法启动 tomcat</li>
</ul>
<p><strong>Bootstrap 初始化</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">initClassLoaders()</div></pre></td></tr></table></figure>
<p>创建三种类型的加载器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">createClassLoader(<span class="string">"common"</span>, <span class="keyword">null</span>);</div><div class="line">catalinaLoader = createClassLoader(<span class="string">"server"</span>, commonLoader);</div><div class="line">sharedLoader = createClassLoader(<span class="string">"shared"</span>, commonLoader);</div></pre></td></tr></table></figure>
<p><strong>Bootstrap main 执行命令</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (command.equals(<span class="string">"startd"</span>)) &#123;</div><div class="line">    daemon.start();</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stopd"</span>)) &#123;</div><div class="line">    daemon.stop();</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"start"</span>)) &#123;</div><div class="line">    daemon.start();</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stop"</span>)) &#123;</div><div class="line">    daemon.stopServer(args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<font color="red"><strong>(1) <code>ClassLoader</code> 加载 <code>jar</code> 包:</strong></font>

<p><strong>重点方法: <code>Bootstrap#initClassLoaders()</code></strong></p>
<p><img src="2017_12_30_10_43_49.png" alt="Boostrap"></p>
<font color="red"><strong>(2) 初始化 <code>Digester</code> 并解析 <code>conf/server.xml</code> 文件:</strong></font>

<p><strong>重点方法: <code>Catalina#load()</code></strong></p>
<p><code>Tomcat</code> 将 <code>server.xml</code> 中的各个<strong>元素的节点路径</strong>映射为一个 <code>pattern</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span></span></div><div class="line"><span class="tag">              <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span></span></div><div class="line"><span class="tag">              <span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span></span></div><div class="line"><span class="tag">              <span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span></span></div><div class="line"><span class="tag">              <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></div></pre></td></tr></table></figure>
<p>如上 <code>conf/server.xml</code> 片段可以映射为如下四个路径，也就是 <code>Tomcat</code> 概念里的 <code>pattern</code>:</p>
<ul>
<li><code>Server</code></li>
<li><code>Server/Listener</code></li>
<li><code>Server/Listener/GlobalNamingResources</code></li>
<li><code>Server/Listener/GlobalNamingResources/Resource</code></li>
</ul>
<p>当遇见一个 <code>pattern</code> 的时候，便执行相应的动作。如下，当遇见 <code>Server/GlobalNamingResources</code> 的时候，便创建一个 <code>NamingResourcesImpl</code> 类:</p>
<p><img src="2017_12_30_14_05_37.png" alt="GlobalNamingResources"></p>
<p>当遇见 <code>Server</code> 的时候，便创建一个 <code>StandardServer</code> 类:</p>
<p><img src="2017_12_30_14_08_36.png" alt="StandardServer"></p>
<font color="red"><strong>(3) 解析 <code>mbeans-descriptors.xml</code> 文件:</strong></font>

<p>其中 <code>mbeans-descriptors.xml</code> 的详细路径为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;TOMCAT_BASE&#125;.settings/output/org/apache/catalina/authenticator/mbeans-descriptors.xml</div><div class="line">&#123;TOMCAT_BASE&#125;.settings/output/org/apache/catalina/core/mbeans-descriptors.xml</div><div class="line">&#123;TOMCAT_BASE&#125;.settings/output/org/apache/catalina/mbeans-descriptors.xml</div><div class="line">...</div></pre></td></tr></table></figure>
<p><strong>Catalina 在 start() 中启动 Server</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">shutdownHook = <span class="keyword">new</span> CatalinaShutdownHook();</div><div class="line">Runtime.getRuntime().addShutdownHook(shutdownHook);</div></pre></td></tr></table></figure>
<p><strong>Catalina 在 stop() 删除容器</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Runtime.getRuntime().removeShutdownHook(shutdownHook);</div><div class="line">Server s = getServer();</div><div class="line">s.stop();</div></pre></td></tr></table></figure>
<p><strong>在 stopServer中 停止 Catalina 服务</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> (Socket socket = <span class="keyword">new</span> Socket(s.getAddress(), s.getPort());</div><div class="line">     OutputStream stream = socket.getOutputStream()) &#123;</div><div class="line">    String shutdown = s.getShutdown();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shutdown.length(); i++) &#123;</div><div class="line">        stream.write(shutdown.charAt(i));</div><div class="line">    &#125;</div><div class="line">    stream.flush();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h3><p><strong>容器是用来处理请求 <code>servlet</code> 资源，并为客户端填充 <code>response</code> 对象的模块。</strong> Tomcat 共有四种类型的容器:</p>
<ul>
<li><code>Engine</code>: 整个 <code>Catalina Servlet</code> 引擎</li>
<li><code>Host</code>: 表示包含有一个或者多个 <code>Context</code> 容器的虚拟主机</li>
<li><code>Context</code>: 表示一个 <code>Web</code> 应用程序，一个 <code>Context</code> 可以有多个 <code>Wrapper</code></li>
<li><code>Wrapper</code>: 表示一个独立的 <code>Servlet</code></li>
</ul>
<p><img src="container.svg" alt=""></p>
<h4 id="Wrapper"><a href="#Wrapper" class="headerlink" title="Wrapper"></a>Wrapper</h4><p><img src="wrapper_hierarchy.svg" alt=""></p>
<p><code>Wrapper</code> 中的 <code>allocate()</code> 方法会分配一个已经初始化的 <code>servlet</code> 实例，<code>load()</code> 方法载入并初始化 <code>Servlet</code> 类。</p>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p><code>Server</code> 的实现类: <code>org.apache.catalina.core.StandardServer.java</code></p>
<ul>
<li><strong><code>Server</code></strong>: 启动和监听服务端事件 (重启、关闭等)</li>
</ul>
<p><strong>读取资源</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">globalNamingResources = <span class="keyword">new</span> NamingResourcesImpl();</div><div class="line">globalNamingResources.setContainer(<span class="keyword">this</span>);</div></pre></td></tr></table></figure>
<p><strong>初始化</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    <span class="keyword">super</span>.initInternal();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">        services[i].init();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>启动所有 <code>Service</code></strong>:</p>
<p>在 <code>Tomcat</code> 中，组件的生命周期是通过 <code>Lifecycle</code> 接口来控制的，即父组件控制子组件的生命周期。如 <code>StandardServer</code> 启动多个 <code>Service</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">    fireLifecycleEvent(CONFIGURE_START_EVENT, <span class="keyword">null</span>);</div><div class="line">    setState(LifecycleState.STARTING);</div><div class="line"></div><div class="line">    globalNamingResources.start();</div><div class="line"></div><div class="line">    <span class="comment">// Start our defined Services</span></div><div class="line">    <span class="keyword">synchronized</span> (servicesLock) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">            services[i].start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即简单的循环启动所有 <code>Service</code> 组件的 <code>start</code> 方法。</p>
<p><strong>服务阶段</strong>:</p>
<p>启动一个线程，简历对本机上预定义的 <code>shutdown</code> 端口的 <code>ServerSocket</code> 对象的监听:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> String address = <span class="string">"localhost"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> port = <span class="number">8005</span>;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</div><div class="line">    awaitSocket =</div><div class="line">        <span class="keyword">new</span> ServerSocket(port,</div><div class="line">                         <span class="number">1</span>,</div><div class="line">                         InetAddress.getByName(address));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它循环监听该端口，一旦监听到该端口的字符串命令，就将该命令与配置的 shutdown 字符串进行对比，如果相同则终止当前的线程函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> String shutdown = <span class="string">"SHUTDOWN"</span>;</div><div class="line"><span class="keyword">boolean</span> match = command.toString().equals(shutdown);</div><div class="line"><span class="keyword">if</span> (match) &#123;</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>关闭</strong>:</p>
<p>当监听到关闭命令并执行关闭操作时，会调用 <code>stop</code> 函数执行关闭工作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">stopInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">        services[i].stop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p><code>Service</code> 的实现 <code>org.apache.catalina.core.StandardService</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardService</span></span></div><div class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">LifecycleMBeanBase</span></span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>初始化并启动</strong>:</p>
<p>初始化 <code>Engine</code>、所有的 <code>Executor</code>、所有的 <code>Connector</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    <span class="keyword">super</span>.initInternal();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</div><div class="line">        engine.init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize any Executors</span></div><div class="line">    <span class="keyword">for</span> (Executor executor : findExecutors()) &#123;</div><div class="line">        executor.init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize mapper listener</span></div><div class="line">    mapperListener.init();</div><div class="line"></div><div class="line">    <span class="comment">// Initialize our defined Connectors</span></div><div class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</div><div class="line">        <span class="keyword">for</span> (Connector connector : connectors) &#123;</div><div class="line">            connector.init();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>启动 <code>Engine</code>、所有的 <code>Executor</code>、所有的 <code>Connector</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    setState(LifecycleState.STARTING);</div><div class="line"></div><div class="line">    <span class="comment">// Start our defined Container first</span></div><div class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (engine) &#123;</div><div class="line">            engine.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (executors) &#123;</div><div class="line">        <span class="keyword">for</span> (Executor executor: executors) &#123;</div><div class="line">            executor.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mapperListener.start();</div><div class="line"></div><div class="line">    <span class="comment">// Start our defined Connectors second</span></div><div class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</div><div class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</div><div class="line">            connector.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>停止</strong>:</p>
<p>先暂停所有的 <code>Connector</code>，停止 <code>Engine</code>，停止所有的 <code>Connector</code>，停止 <code>mapperListener</code>，停止所有的 <code>Executor</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">stopInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Pause connectors first</span></div><div class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</div><div class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</div><div class="line">            connector.pause();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setState(LifecycleState.STOPPING);</div><div class="line"></div><div class="line">    <span class="comment">// Stop our defined Container second</span></div><div class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (engine) &#123;</div><div class="line">            engine.stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Now stop the connectors</span></div><div class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</div><div class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</div><div class="line">                connector.stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If the Server failed to start, the mapperListener won't have been</span></div><div class="line">    <span class="comment">// started</span></div><div class="line">    <span class="keyword">if</span> (mapperListener.getState() != LifecycleState.INITIALIZED) &#123;</div><div class="line">        mapperListener.stop();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (executors) &#123;</div><div class="line">        <span class="keyword">for</span> (Executor executor: executors) &#123;</div><div class="line">            executor.stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h3><p><code>Connector</code> 组件负责接受浏览器发过来的 TCP 连接请求，创建一个 <code>Request</code> 和 <code>Response</code> 对方分别用于和请求端交换数据，然后会产生一个线程来处理这个请求并把产生的 <code>Request</code> 和 <code>Response</code> 对象传给处理这个请求的线程，处理这个请求的线程就是 <code>Container</code> 组件要做的事情了。</p>
<p>通常我们会用到两种 <code>Connector</code>,一种叫 http connector,用来传递 http 请求;另一种叫 AJP Connector,在整合 Apache 与 Tomcat 工作的时候, Apache 与 Tomcat 之间就是通过这个协议来互动的。 (Apache 与 Tomcat 的整合工作, <strong>通常是为了让 Apache 获取静态资源，而让 Tomcat 来解析动态的 JSP 或者 Servlet</strong>。 )</p>
<p><code>Connector</code> 本身就是一个实现了 <code>LifecycleMBeanBase</code> 的类。</p>
<p><strong>构造加载协议</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName);</div><div class="line">p = (ProtocolHandler) clazz.getConstructor().newInstance();</div></pre></td></tr></table></figure>
<p><strong>启动</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    setState(LifecycleState.STARTING);</div><div class="line">    protocolHandler.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>请求</strong>:</p>
<p>在执行期间，连接器在接收到用户的请求时，会通过以下函数创建请求对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Request <span class="title">createRequest</span><span class="params">()</span> </span>&#123;</div><div class="line">    Request request = <span class="keyword">new</span> Request();</div><div class="line">    request.setConnector(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> (request);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该请求提交给 <code>Engine</code> 处理。</p>
<p><strong>响应</strong>:</p>
<p>当 <code>Engine</code> 返回处理结果给 <code>Connector</code> 时，它会创建一个响应对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">createResponse</span><span class="params">()</span> </span>&#123;</div><div class="line">    Response response = <span class="keyword">new</span> Response();</div><div class="line">    response.setConnector(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> (response);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>并将该对象返回给客户端。</p>
<p><strong>关闭</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">stopInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    setState(LifecycleState.STOPPING);</div><div class="line">    protocolHandler.stop();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="启动-Engine"><a href="#启动-Engine" class="headerlink" title="启动 Engine"></a>启动 Engine</h3><p>当 HTTP Connector 把请求传递给顶级的容器 —— <code>Engine</code> 时, 我们的视线就应该移动到 Container 这个层面来了。在 Container 层,包含了 3 种容器: Engine、Host 和 Context。<code>Engine</code> 收到 Connector 传递过来的请求,经过处理后,将结果返回给 Service(Service 是通过 Connector 这个媒介和 Engine 互动的) 。</p>
<p><code>Engine</code> 的实现类是 <code>org.apache.catalina.core.StandardEngine</code>。</p>
<p><strong>构造、创建过滤阀</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardEngine</span><span class="params">()</span> </span>&#123;</div><div class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardEngineValve());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="启动-Host"><a href="#启动-Host" class="headerlink" title="启动 Host"></a>启动 Host</h3><p><code>Engine</code> 收到 <code>Connector</code> 传递过来的请求后,不会自己处理,而是交给合适的 <code>Host</code> 来处理。Host 在这里就是虚拟主机的意思,通常我们只会使用 “localhost” ,即本地主机来处理。</p>
<p><code>Host</code> 的实现类是: <code>org.apache.catalina.core.StandardHost</code></p>
<p><strong>构造、创建过滤阀</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardHost</span><span class="params">()</span> </span>&#123;</div><div class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardHostValve());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>启动、初始化</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    String errorValve = getErrorReportValveClass();</div><div class="line">    Valve valve =</div><div class="line">        (Valve) Class.forName(errorValve).getConstructor().newInstance();</div><div class="line">    getPipeline().addValve(valve);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>处理请求</strong>:</p>
<p>代码可能不在这个类里面了</p>
<h3 id="启动-Context"><a href="#启动-Context" class="headerlink" title="启动 Context"></a>启动 Context</h3><p><code>Host</code> 接到了从 <code>Engine</code> 传过来的请求后,也不会自己处理,而是交给合适的 <code>Context</code> 来处理,例如 <a href="http://127.0.0.1:8080/foo/index.jsp" target="_blank" rel="external">http://127.0.0.1:8080/foo/index.jsp</a> 和 <a href="http://127.0.1:8080/bar/index.jsp。前者交给" target="_blank" rel="external">http://127.0.1:8080/bar/index.jsp。前者交给</a> foo 这个 <code>Context</code> 处理,后者交给 bar 这个 <code>Context</code> 来处理。</p>
<p><code>Context</code> 的实现类是: <code>org.apache.catalina.core.StandardContext</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardContext</span><span class="params">()</span> </span>&#123;</div><div class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardContextValve());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>启动、初始化</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">    setResources(<span class="keyword">new</span> StandardRoot(<span class="keyword">this</span>));</div><div class="line">    resourcesStart();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;</div><div class="line">        WebappLoader webappLoader = <span class="keyword">new</span> WebappLoader(getParentClassLoader());</div><div class="line">        webappLoader.setDelegate(getDelegate());</div><div class="line">        setLoader(webappLoader);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// An explicit cookie processor hasn't been specified; use the default</span></div><div class="line">    <span class="keyword">if</span> (cookieProcessor == <span class="keyword">null</span>) &#123;</div><div class="line">        cookieProcessor = <span class="keyword">new</span> Rfc6265CookieProcessor();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize character set mapper</span></div><div class="line">    getCharsetMapper();</div><div class="line"></div><div class="line">    <span class="comment">// Post work directory</span></div><div class="line">    postWorkDirectory();</div><div class="line"></div><div class="line">    NamingContextListener ncl = <span class="keyword">new</span> NamingContextListener();</div><div class="line">    ncl.setName(getNamingContextName());</div><div class="line">    ncl.setExceptionOnFailedWrite(getJndiExceptionOnFailedWrite());</div><div class="line">    addLifecycleListener(ncl);</div><div class="line">    setNamingContextListener(ncl);</div><div class="line"></div><div class="line">    <span class="comment">// Binding thread</span></div><div class="line">    ClassLoader oldCCL = bindThread();</div><div class="line"></div><div class="line">    <span class="comment">// Start our subordinate components, if any</span></div><div class="line">    Loader loader = getLoader();</div><div class="line">    ((Lifecycle) loader).start();</div><div class="line"></div><div class="line">    getLogger();</div><div class="line"></div><div class="line">    Realm realm = getRealmInternal();</div><div class="line">    ((Lifecycle) realm).start();</div><div class="line"></div><div class="line">    <span class="comment">// Start our child containers, if not already started</span></div><div class="line">    <span class="keyword">for</span> (Container child : findChildren()) &#123;</div><div class="line">        <span class="keyword">if</span> (!child.getState().isAvailable()) &#123;</div><div class="line">            child.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Start the Valves in our pipeline (including the basic),</span></div><div class="line">    <span class="comment">// if any</span></div><div class="line">    ((Lifecycle) pipeline).start();</div><div class="line">            </div><div class="line">    <span class="keyword">if</span> ( (getCluster() != <span class="keyword">null</span>) &amp;&amp; distributable) &#123;</div><div class="line">        contextManager = getCluster().createManager(getName());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        contextManager = <span class="keyword">new</span> StandardManager();</div><div class="line">    &#125;</div><div class="line">            </div><div class="line">    <span class="comment">// Configure default manager if none was specified</span></div><div class="line">    <span class="keyword">if</span> (contextManager != <span class="keyword">null</span>) &#123;</div><div class="line">        setManager(contextManager);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (manager!=<span class="keyword">null</span> &amp;&amp; (getCluster() != <span class="keyword">null</span>) &amp;&amp; distributable) &#123;</div><div class="line">        <span class="comment">//let the cluster know that there is a context that is distributable</span></div><div class="line">        <span class="comment">//and that it has its own manager</span></div><div class="line">        getCluster().registerManager(manager);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setInstanceManager(</div><div class="line">                       <span class="keyword">new</span> DefaultInstanceManager(context,</div><div class="line">                                                  injectionMap,</div><div class="line">                                                  <span class="keyword">this</span>,</div><div class="line">                                                  <span class="keyword">this</span>.getClass().getClassLoader()));</div><div class="line"></div><div class="line">    <span class="comment">// Start manager</span></div><div class="line">    ((Lifecycle) manager).start();</div><div class="line"></div><div class="line">    <span class="comment">// Start ContainerBackgroundProcessor thread</span></div><div class="line">    <span class="keyword">super</span>.threadStart();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="加载组件"><a href="#加载组件" class="headerlink" title="加载组件"></a>加载组件</h3><ul>
<li><strong><code>Manager</code></strong>: 管理 <code>Session</code></li>
<li><strong><code>Logger</code></strong>: 记录事件</li>
<li><strong><code>Loader</code></strong>: 启动 <code>Context</code></li>
<li><strong><code>Valve</code></strong>: 当一个容器决定了要把从上级传递过来的请求交给子容器的时候,它就把这个请求放进容器的管道 (pipeline) 里。而请求在管道里流动的时候,就会被管道里面的各个阀门拦截下来。第一个阀门叫做 <strong>“access_allow_vavle”</strong> ,当请求传递过来时,它会看这个请求是从哪个 IP 过来的,如果这个 IP 已经在黑名单中,请求就会被禁止掉。第二个阀门叫做 <strong>“default_access_valve”</strong> ,它会做例行的检查,如果通过检查,就把请求传递给当前容器的子容器。通过这种方式,请求在各个容器里面传递,最后抵达目的地。</li>
</ul>
<p>跟 <code>Valve</code> 相关的类和概念有如下两个:</p>
<ul>
<li><code>org.apache.catalina.Pipeline</code></li>
<li><code>org.apache.catalina.Valve</code></li>
</ul>
<p><img src="valve_hierarchy.svg" alt=""></p>
<h3 id="Tomcat-类加载器"><a href="#Tomcat-类加载器" class="headerlink" title="Tomcat 类加载器"></a>Tomcat 类加载器</h3><p>对于某个网络程序所<strong>特有</strong>的类和资源,这些未包装的类和资源放置在你的网络程序档案 <code>/WEB-INF/classes</code> 目录下面,或者,包含这些类和资源的 JAR 文件放置在你的网络程序档案 <code>/WEB-INF/lib</code> 目录下面;</p>
<p>对于必须被所有网络程序<strong>共享</strong>的类和资源, 未包装的这些类和资源放置在 <code>$CATALINA_HOME/shared/classes</code> 下面,或者,包含这些类和资源的 JAR 文件放置在 <code>$CATALINA_HOME/shared/lib</code> 下面。</p>
<p><strong>Tomcat 类加载器父子关系图</strong>:</p>
<p><img src="17-06-15-15_28_10_377_316.png" alt=""></p>
<p><strong>Tomcat 与 Java 类加载器关系图</strong>:</p>
<p><img src="17-06-15-15_28_40_212_474.png" alt=""></p>
<p><strong>catalina.sh 指定 CLASSPATH 内容</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Add on extra jar files to CLASSPATH</span></div><div class="line"><span class="keyword">if</span> [ ! -z <span class="string">"<span class="variable">$CLASSPATH</span>"</span> ] ; <span class="keyword">then</span></div><div class="line">    CLASSPATH=<span class="string">"<span class="variable">$CLASSPATH</span>"</span>:</div><div class="line"><span class="keyword">fi</span></div><div class="line">CLASSPATH=<span class="string">"<span class="variable">$CLASSPATH</span>"</span><span class="string">"<span class="variable">$CATALINA_HOME</span>"</span>/bin/bootstrap.jar</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -r <span class="string">"<span class="variable">$CATALINA_BASE</span>/bin/tomcat-juli.jar"</span> ] ; <span class="keyword">then</span></div><div class="line">    CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$CATALINA_BASE</span>/bin/tomcat-juli.jar</div><div class="line"><span class="keyword">else</span></div><div class="line">    CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$CATALINA_HOME</span>/bin/tomcat-juli.jar</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p><strong>Bootstrap.createClassLoader</strong>:</p>
<p>在 <code>conf/catalina.properties</code> 中定义了 <code>Common, Server, Shared</code> 三个 <code>ClassLoader</code> 载入类的路径以及一些包的安全权限:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">common.loader=&quot;$&#123;catalina.base&#125;/lib&quot;,&quot;$&#123;catalina.base&#125;/lib/*.jar&quot;,&quot;$&#123;catalina.home&#125;/lib&quot;,&quot;$&#123;catalina.home&#125;/lib/*.jar&quot;</div><div class="line">server.loader=</div><div class="line">shared.loader=</div></pre></td></tr></table></figure>
<p>加载 <code>tomcat85/output/build/lib/*.jar</code></p>
<p><img src="17-06-15-15_54_12_1085_203.png" alt=""></p>
<p><strong>ClassLoaderFactory.createClassLoader</strong>:</p>
<p>主要工作是进行加载路径的格式化</p>
<p><strong>Tomcat 热部署</strong>:</p>
<p>有两种方式:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span> <span class="attr">name</span>=<span class="string">"localhost"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">xmlNamespaceAware</span>=<span class="string">"false"</span> <span class="attr">xmlValidation</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Context</span> <span class="attr">docBase</span>=<span class="string">"CPCWeb"</span> <span class="attr">path</span>=<span class="string">"/CPCWeb"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> <span class="attr">source</span>=<span class="string">"org.eclipse.jst.j2ee.server:CPCWeb"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></div></pre></td></tr></table></figure>
<p>或</p>
<p>直接把项目放到 <code>webapps</code> 下面</p>
<p>实现方法如下:</p>
<p>所有继承了 <code>ContainerBase</code> 的容器如下:</p>
<p><img src="17-06-15-17_06_18_716_155.png" alt=""></p>
<p><code>ContainerBase</code> 在启动的时候启动了一个<strong>后台线程</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">    threadStart();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">threadStart</span><span class="params">()</span> </span>&#123;</div><div class="line">    String threadName = <span class="string">"ContainerBackgroundProcessor["</span> + toString() + <span class="string">"]"</span>;</div><div class="line">    thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ContainerBackgroundProcessor(), threadName);</div><div class="line">    thread.setDaemon(<span class="keyword">true</span>);</div><div class="line">    thread.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>后台线程每隔一段时间就会调用 <code>processChildren</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (!threadDone) &#123;</div><div class="line">        Thread.sleep(backgroundProcessorDelay * <span class="number">1000L</span>);</div><div class="line">        <span class="keyword">if</span> (!threadDone) &#123;</div><div class="line">            processChildren(ContainerBase.<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>processChildren</code> 方法会调用 <code>ContainerBase</code> 自身的 <code>backgroundProcess</code> 方法，其中关于 <code>backgroundProcess</code> 方法中调用 loader 来重新加载类的方法定义在子类 <code>StandardContext</code> 中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</div><div class="line">    Loader loader = getLoader();</div><div class="line">    <span class="keyword">if</span> (loader != <span class="keyword">null</span>) &#123;</div><div class="line">        loader.backgroundProcess();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">super</span>.backgroundProcess();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>StandardContext</code> 的 <code>startInternal()</code> 方法中我们可以得知 <code>getLoader</code> 返回的是 <code>WebappLoader</code> 实例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;</div><div class="line">        WebappLoader webappLoader = <span class="keyword">new</span> WebappLoader(getParentClassLoader());</div><div class="line">        webappLoader.setDelegate(getDelegate());</div><div class="line">        setLoader(webappLoader);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>setLoader</code> 方法中又指定了 <code>loader</code> 的 <code>Context</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (loader != <span class="keyword">null</span>)</div><div class="line">    loader.setContext(<span class="keyword">this</span>);</div></pre></td></tr></table></figure>
<p><code>WebappLoader</code> 的 <code>backgroundProcess()</code> 方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (reloadable &amp;&amp; modified()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Thread.currentThread().setContextClassLoader</div><div class="line">                (WebappLoader.class.getClassLoader());</div><div class="line">            <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</div><div class="line">                context.reload();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (context != <span class="keyword">null</span> &amp;&amp; context.getLoader() != <span class="keyword">null</span>) &#123;</div><div class="line">                Thread.currentThread().setContextClassLoader</div><div class="line">                    (context.getLoader().getClassLoader());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义在 <code>WebappClassLoaderBase</code> 中的 <code>modified()</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">modified</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (Entry&lt;String,ResourceEntry&gt; entry : resourceEntries.entrySet()) &#123;</div><div class="line">        <span class="keyword">long</span> cachedLastModified = entry.getValue().lastModified;</div><div class="line">        <span class="keyword">long</span> lastModified = resources.getClassLoaderResource(</div><div class="line">                                                             entry.getKey()).getLastModified();</div><div class="line">        <span class="keyword">if</span> (lastModified != cachedLastModified) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Check if JARs have been added or removed</span></div><div class="line">    WebResource[] jars = resources.listResources(<span class="string">"/WEB-INF/lib"</span>);</div><div class="line">    <span class="comment">// Filter out non-JAR resources</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> jarCount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (WebResource jar : jars) &#123;</div><div class="line">        <span class="keyword">if</span> (jar.getName().endsWith(<span class="string">".jar"</span>) &amp;&amp; jar.isFile() &amp;&amp; jar.canRead()) &#123;</div><div class="line">            jarCount++;</div><div class="line">            Long recordedLastModified = jarModificationTimes.get(jar.getName());</div><div class="line">            <span class="keyword">if</span> (recordedLastModified == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Jar has been added</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (recordedLastModified.longValue() != jar.getLastModified()) &#123;</div><div class="line">                <span class="comment">// Jar has been changed</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (jarCount &lt; jarModificationTimes.size())&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// No classes have been modified</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由上文可知，<code>WebappLoader</code> 自身关联的 <code>Context</code> 实为 <code>StandardContext</code>，因此在 <code>backgroundProcess</code> 方法中调用 <code>context.reload()</code> 的时候，则是调用的 <code>StandardContext</code> 方法上的 <code>reload</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">reload</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Stop accepting requests temporarily.</span></div><div class="line">    setPaused(<span class="keyword">true</span>);</div><div class="line">    stop();</div><div class="line">    start();</div><div class="line">    setPaused(<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其就是将整个 <code>Context</code> 容器重启了一下，由此实现类的热加载部署。</p>
<h3 id="Task-任务"><a href="#Task-任务" class="headerlink" title="Task 任务"></a>Task 任务</h3><p><strong>Tomcat 的主要作用是提供静态资源和 JSP 动态资源的请求和响应服务</strong>。根据 Tomcat 服务的机制, 需要通过 Connector 监听服务请求, 进行匹配后转发到对应的 Host 和 Context。而作为核心服务单元的 Context,它在接收转发过来的服务之前,实际上已经建立了对服务的监听连接, 每一个 Context 都称作一个 Web 应用。</p>
<p>这些 Web 应用建立和管理监听的过程是由应用管理程序 manager 来完成的, 我们称这些操作为任务 (Task) 。 常见的任务有<strong>部署 (deploy) 、 查看 (list) 、启动(start) 、停止(stop) 、删除(updeploy) 、重载(reload) </strong>。</p>
<p>所有的 Tomcat 任务类都继承自 <code>AbstractCatalinaTask</code>。其统一实现任务请求命令的操作函数 <code>execute(command)</code> ,该函数的功能是实现 command 命令的管理功能,例如 deploy 等。<strong>它实现的方式是建立 HTTP 连接,并接收输入流的响应数据</strong>。该函数的代码和所做的工作如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(String command, InputStream istream, String contentType, <span class="keyword">long</span> contentLength)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BuildException </span>&#123;</div><div class="line"></div><div class="line">    URLConnection conn = <span class="keyword">null</span>;</div><div class="line">    InputStreamReader reader = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Create a connection for this command</span></div><div class="line">        conn = (<span class="keyword">new</span> URL(url + command)).openConnection();</div><div class="line">        HttpURLConnection hconn = (HttpURLConnection) conn;</div><div class="line"></div><div class="line">        <span class="comment">// Set up standard connection characteristics</span></div><div class="line">        hconn.setAllowUserInteraction(<span class="keyword">false</span>);</div><div class="line">        hconn.setDoInput(<span class="keyword">true</span>);</div><div class="line">        hconn.setUseCaches(<span class="keyword">false</span>);</div><div class="line">        <span class="keyword">if</span> (istream != <span class="keyword">null</span>) &#123;</div><div class="line">            hconn.setDoOutput(<span class="keyword">true</span>);</div><div class="line">            hconn.setRequestMethod(<span class="string">"PUT"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            hconn.setDoOutput(<span class="keyword">false</span>);</div><div class="line">            hconn.setRequestMethod(<span class="string">"GET"</span>);</div><div class="line">        &#125;</div><div class="line">        hconn.setRequestProperty(<span class="string">"User-Agent"</span>, <span class="string">"Catalina-Ant-Task/1.0"</span>);</div><div class="line">        <span class="comment">// Set up authorization with our credentials</span></div><div class="line">        Authenticator.setDefault(<span class="keyword">new</span> TaskAuthenticator(username, password));</div><div class="line">        <span class="comment">// Establish the connection with the server</span></div><div class="line">        hconn.connect();</div><div class="line">        <span class="comment">// Send the request data (if any)</span></div><div class="line">        <span class="keyword">if</span> (istream != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> (BufferedOutputStream ostream =</div><div class="line">                 <span class="keyword">new</span> BufferedOutputStream(hconn.getOutputStream(), <span class="number">1024</span>);) &#123;</div><div class="line">                <span class="keyword">byte</span> buffer[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> n = istream.read(buffer);</div><div class="line">                    ostream.write(buffer, <span class="number">0</span>, n);</div><div class="line">                &#125;</div><div class="line">                ostream.flush();</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                istream.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Process the response message</span></div><div class="line">        reader = <span class="keyword">new</span> InputStreamReader(hconn.getInputStream(), CHARSET);</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">int</span> ch = reader.read();</div><div class="line">            buff.append((<span class="keyword">char</span>) ch);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (buff.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">            handleOutput(buff.toString(), msgPriority);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        handleErrorOutput(e.getMessage());</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        reader.close();</div><div class="line">        istream.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 Tomcat 源代码的 <code>org.apache.catalina.ant</code> 目录下有一个任务文件 <code>catalina.tasks</code>, 该文件配置了各种不同的任务所映射的任务处理类, 包括以下四类任务:</p>
<p><strong>1. Catalina 任务</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">list=org.apache.catalina.ant.ListTask</div><div class="line">deploy=org.apache.catalina.ant.DeployTask</div><div class="line">start=org.apache.catalina.ant.StartTask</div><div class="line">reload=org.apache.catalina.ant.ReloadTask</div><div class="line">stop=org.apache.catalina.ant.StopTask</div><div class="line">undeploy=org.apache.catalina.ant.UndeployTask</div><div class="line">resources=org.apache.catalina.ant.ResourcesTask</div><div class="line">sessions=org.apache.catalina.ant.SessionsTask</div><div class="line">validator=org.apache.catalina.ant.ValidatorTask</div><div class="line">findleaks=org.apache.catalina.ant.FindLeaksTask</div><div class="line">vminfo=org.apache.catalina.ant.VminfoTask</div><div class="line">threaddump=org.apache.catalina.ant.ThreaddumpTask</div><div class="line">sslConnectorCiphers=org.apache.catalina.ant.SslConnectorCiphersTask</div></pre></td></tr></table></figure>
<p><strong>2. Jk 任务</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jkupdate=org.apache.catalina.ant.JKStatusUpdateTask</div></pre></td></tr></table></figure>
<p><strong>3. JMX 任务</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">jmxManagerSet=org.apache.catalina.ant.JMXSetTask</div><div class="line">jmxManagerGet=org.apache.catalina.ant.JMXGetTask</div><div class="line">jmxManagerQuery=org.apache.catalina.ant.JMXQueryTask</div></pre></td></tr></table></figure>
<p><strong>4. Jasper 任务</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jasper=org.apache.jasper.JspC</div></pre></td></tr></table></figure>
<hr>
<p><strong>部署应用任务类 DeployTask</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> BuildException </span>&#123;</div><div class="line">    <span class="keyword">super</span>.execute();</div><div class="line">    <span class="comment">// Building an input stream on the WAR to upload, if any</span></div><div class="line">    <span class="keyword">if</span> (war != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (PROTOCOL_PATTERN.matcher(war).lookingAt()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                URL url = <span class="keyword">new</span> URL(war);</div><div class="line">                URLConnection conn = url.openConnection();</div><div class="line">                contentLength = conn.getContentLengthLong();</div><div class="line">                stream = <span class="keyword">new</span> BufferedInputStream(conn.getInputStream(), <span class="number">1024</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(e);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            FileInputStream fsInput = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                fsInput = <span class="keyword">new</span> FileInputStream(war);</div><div class="line">                contentLength = fsInput.getChannel().size();</div><div class="line">                stream = <span class="keyword">new</span> BufferedInputStream(fsInput, <span class="number">1024</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                fsInput.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        contentType = <span class="string">"application/octet-stream"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Building URL</span></div><div class="line">    StringBuilder sb = createQueryString(<span class="string">"/deploy"</span>);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        execute(sb.toString(), stream, contentType, contentLength);</div><div class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">"Invalid 'charset' attribute: "</span> + getCharset());</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        stream.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>启动应用任务类 <code>StartTask</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> BuildException </span>&#123;</div><div class="line">    <span class="keyword">super</span>.execute();</div><div class="line">    execute(createQueryString(<span class="string">"/start"</span>).toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Servlet-类"><a href="#Servlet-类" class="headerlink" title="Servlet 类"></a>Servlet 类</h3><p>处理 <code>Servlet</code> 的类主要位于目录 <code>org.apache.catalina.servlets</code> 中。</p>
<p>Tomcat 能够响应的请求文件类型有 HTML、图片、CSS、Servlet、CGI、SSI、JSP。前三种属于静态资源,后四种属于动态资源。Tomcat 使用 <code>DefaultServlet</code> 响应静态资源, 使用 <code>CGIServlet</code> 响应 CGI 请求,使用 <code>org.apache.catalina.ssi.SSIServlet</code> 响应 SSI 请求,使用 <code>org.apache.jasper.servlet.JspServlet</code> 响应 JSP 请求。</p>
<p>所有的 Tomcat 的 Servlet 都继承一个父类 <code>javax.servlet.http.HttpServlet</code>,该类又继承自 <code>javax.servlet.GenericServlet</code>。</p>
<hr>
<p><strong><code>javax.servlet.GenericServlet</code></strong> 抽象类:</p>
<p><code>javax.servlet.GenericServlet</code> 实现了 <code>Servlet, ServletConfig, java.io.Serializable</code> 方法，写一个通用的 <code>servlet</code>，你只需要重写抽象方法 <code>Service</code> 即可</p>
<p><strong><code>javax.servlet.http.HttpServlet</code></strong>:</p>
<p><code>HttpServlet</code> 绑定资源文件: <code>javax.servlet.http.LocalStrings.properties</code>，供 HTTP 访问期间的错误和警告信息提示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LSTRING_FILE =</div><div class="line">    <span class="string">"javax.servlet.http.LocalStrings"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ResourceBundle lStrings =</div><div class="line">    ResourceBundle.getBundle(LSTRING_FILE);</div><div class="line"></div><div class="line">String msg = lStrings.getString(<span class="string">"http.method_get_not_supported"</span>);</div><div class="line"><span class="keyword">if</span> (protocol.endsWith(<span class="string">"1.1"</span>)) &#123;</div><div class="line">    resp.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, msg);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    resp.sendError(HttpServletResponse.SC_BAD_REQUEST, msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>访问 HTTP Header 信息，定义了两个变量:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_IFMODSINCE = <span class="string">"If-Modified-Since"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_LASTMOD = <span class="string">"Last-Modified"</span>;</div></pre></td></tr></table></figure>
<p>重写 HTTP 协议的 <code>Service</code> 函数，该a函数用以根据 HTTP 请求的命令，选择不同的函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"></div><div class="line">    String method = req.getMethod();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (method.equals(METHOD_GET)) &#123;</div><div class="line">        doGet(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_HEAD)) &#123;</div><div class="line">        doHead(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_POST)) &#123;</div><div class="line">        doPost(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_PUT)) &#123;</div><div class="line">        doPut(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_DELETE)) &#123;</div><div class="line">        doDelete(req, resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_OPTIONS)) &#123;</div><div class="line">        doOptions(req,resp);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_TRACE)) &#123;</div><div class="line">        doTrace(req,resp);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>org.apache.catalina.servlets.DefaultServlet</code></strong>:</p>
<p><code>DefaultServlet</code> <strong>提供静态资源和目录列表解释服务</strong> (如果目录列表选项打开的话) ,该类重写了父类的 <code>doHead()、doGet()、doPost()、doPut()</code> 方法, 它们调用内部函数 <code>serveResource()</code> 来返回服务资源内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serveResource</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line"><span class="function"><span class="params">                             HttpServletResponse response,</span></span></div><div class="line"><span class="function"><span class="params">                             <span class="keyword">boolean</span> content,</span></span></div><div class="line"><span class="function"><span class="params">                             String encoding)</span></span></div></pre></td></tr></table></figure>
<p><strong><code>org.apache.catalina.servlets.CGIServlet</code></strong>:</p>
<p><code>cgiPathPrefix</code>: CGI 搜寻路径从 Web 应用程序的 root directory + File.separator + this.prefix 开始。默认的 <code>cgiPathPrefix</code> 是 <code>/WEB-INF/cgi</code>;</p>
<p><code>executable</code>: 用来运行 script 的可执行程序,默认是 <code>perl</code>;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">    CGIEnvironment cgiEnv = <span class="keyword">new</span> CGIEnvironment(req, getServletContext());</div><div class="line">    <span class="keyword">if</span> (cgiEnv.isValid()) &#123;</div><div class="line">        CGIRunner cgi = <span class="keyword">new</span> CGIRunner(cgiEnv.getCommand(),</div><div class="line">                                      cgiEnv.getEnvironment(),</div><div class="line">                                      cgiEnv.getWorkingDirectory(),</div><div class="line">                                      cgiEnv.getParameters());</div><div class="line"></div><div class="line">        cgi.setResponse(res);</div><div class="line">        cgi.run();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CGIRunner</code> 通过输入输出流执行 <code>CGI</code> 脚本，为 <code>doPost</code> 或  <code>doGet</code> 服务:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Runtime rt = <span class="keyword">null</span>;</div><div class="line">    Process proc = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    rt = Runtime.getRuntime();</div><div class="line">    proc = rt.exec(</div><div class="line">                   cmdAndArgs.toArray(<span class="keyword">new</span> String[cmdAndArgs.size()]),</div><div class="line">                   hashToStringArray(env), wd);</div><div class="line"></div><div class="line">    <span class="comment">//write output</span></div><div class="line">    <span class="keyword">byte</span>[] bBuf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</div><div class="line"></div><div class="line">    OutputStream out = response.getOutputStream();</div><div class="line">    cgiOutput = proc.getInputStream();</div><div class="line">    <span class="keyword">while</span> (!skipBody &amp;&amp; (bufRead = cgiOutput.read(bBuf)) != -<span class="number">1</span>) &#123;</div><div class="line">        out.write(bBuf, <span class="number">0</span>, bufRead);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>org.apache.catalina.ssi.SSIServlet</code></strong>:</p>
<p>类 <code>SSIProcessor</code> 才是真正解释 SSI 命令的类，它将 SSI 的各种命令映射到各种处理类进行处理:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addBuiltinCommands</span><span class="params">()</span> </span>&#123;</div><div class="line">    addCommand(<span class="string">"config"</span>, <span class="keyword">new</span> SSIConfig());</div><div class="line">    addCommand(<span class="string">"echo"</span>, <span class="keyword">new</span> SSIEcho());</div><div class="line">    <span class="keyword">if</span> (allowExec) &#123;</div><div class="line">        addCommand(<span class="string">"exec"</span>, <span class="keyword">new</span> SSIExec());</div><div class="line">    &#125;</div><div class="line">    addCommand(<span class="string">"include"</span>, <span class="keyword">new</span> SSIInclude());</div><div class="line">    addCommand(<span class="string">"flastmod"</span>, <span class="keyword">new</span> SSIFlastmod());</div><div class="line">    addCommand(<span class="string">"fsize"</span>, <span class="keyword">new</span> SSIFsize());</div><div class="line">    addCommand(<span class="string">"printenv"</span>, <span class="keyword">new</span> SSIPrintenv());</div><div class="line">    addCommand(<span class="string">"set"</span>, <span class="keyword">new</span> SSISet());</div><div class="line">    SSIConditional ssiConditional = <span class="keyword">new</span> SSIConditional();</div><div class="line">    addCommand(<span class="string">"if"</span>, ssiConditional);</div><div class="line">    addCommand(<span class="string">"elif"</span>, ssiConditional);</div><div class="line">    addCommand(<span class="string">"endif"</span>, ssiConditional);</div><div class="line">    addCommand(<span class="string">"else"</span>, ssiConditional);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>org.apache.jasper.servlet.JspServlet</code></strong>:</p>
<p>处理 <code>JSP</code> 请求:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span> <span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> precompile = preCompile(request);</div><div class="line">    serviceJspFile(request, response, jspUri, precompile);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>serviceJspFile</code> 是调用了 <code>JspServletWrapper</code> 的 <code>service</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceJspFile</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line"><span class="function"><span class="params">                            HttpServletResponse response, String jspUri,</span></span></div><div class="line"><span class="function"><span class="params">                            <span class="keyword">boolean</span> precompile)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"></div><div class="line">    JspServletWrapper wrapper = <span class="keyword">new</span> JspServletWrapper(config, options, jspUri,</div><div class="line">                                                      rctxt);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        wrapper.service(request, response, precompile);</div><div class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe) &#123;</div><div class="line">        handleMissingResource(request, response, jspUri);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>JspServletWrapper</code> 的 <code>service</code> 调用分为四个过程:</p>
<ul>
<li><strong>(1) Compile</strong>: <code>JspCompilationContext.compile()</code></li>
<li><strong>(2) (Re)load servlet class file</strong>: <code>servlet = getServlet()</code></li>
<li><strong>(3) Handle limitation of number of loaded Jsps</strong></li>
<li><strong>(4) Service request</strong>: <code>servlet.service(request, response)</code></li>
</ul>
<p><code>org.apache.jasper.JspCompilationContext</code> 的 <code>compile</code> 方法首先会创建并加载编译器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Compiler <span class="title">createCompiler</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (jspCompiler != <span class="keyword">null</span> ) &#123;</div><div class="line">        <span class="keyword">return</span> jspCompiler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    jspCompiler = createCompiler(<span class="string">"org.apache.jasper.compiler.JDTCompiler"</span>);</div><div class="line">    <span class="keyword">if</span> (jspCompiler == <span class="keyword">null</span>) &#123;</div><div class="line">        jspCompiler = createCompiler(<span class="string">"org.apache.jasper.compiler.AntCompiler"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    jspCompiler.init(<span class="keyword">this</span>, jsw);</div><div class="line">    <span class="keyword">return</span> jspCompiler;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>createCompiler</code> 方法用于实例化编译器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Compiler <span class="title">createCompiler</span><span class="params">(String className)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (Compiler) Class.forName(className).newInstance();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>紧接着会进行编译:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compile</span><span class="params">()</span> <span class="keyword">throws</span> JasperException, FileNotFoundException </span>&#123;</div><div class="line">    createCompiler();</div><div class="line">    <span class="keyword">if</span> (jspCompiler.isOutDated()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            jspCompiler.removeGeneratedFiles();</div><div class="line">            jspLoader = <span class="keyword">null</span>;</div><div class="line">            jspCompiler.compile();</div><div class="line">            jsw.setReload(<span class="keyword">true</span>);</div><div class="line">            jsw.setCompilationException(<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (JasperException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe) &#123;</div><div class="line">            <span class="keyword">throw</span> fnfe;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">            <span class="keyword">throw</span> je;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以 <code>org.apache.jasper.compiler.JDTCompiler</code> 为例，<code>JDTCompiler</code> 继承了 <code>Compiler</code> 类，<code>compile</code> 方法的实现是在 <code>Compiler</code> 类里面的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compile</span><span class="params">(<span class="keyword">boolean</span> compileClass, <span class="keyword">boolean</span> jspcMode)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> FileNotFoundException, JasperException, Exception </span>&#123;</div><div class="line">    String[] smap = generateJava();</div><div class="line">    File javaFile = <span class="keyword">new</span> File(ctxt.getServletJavaFileName());</div><div class="line">    Long jspLastModified = ctxt.getLastModified(ctxt.getJspFile());</div><div class="line">    javaFile.setLastModified(jspLastModified.longValue());</div><div class="line">    <span class="keyword">if</span> (compileClass) &#123;</div><div class="line">        generateClass(smap);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>generateJava</code> 方法用于将 <code>JSP</code> 文件转为 <code>Java</code> 文件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">String javaFileName = ctxt.getServletJavaFileName();</div><div class="line">ParserController parserCtl = <span class="keyword">new</span> ParserController(ctxt, <span class="keyword">this</span>);</div><div class="line"><span class="comment">// Pass 1 - the directives</span></div><div class="line">Node.Nodes directives =</div><div class="line">    parserCtl.parseDirectives(ctxt.getJspFile());</div><div class="line"><span class="comment">// Pass 2 - the whole translation unit</span></div><div class="line">pageNodes = parserCtl.parse(ctxt.getJspFile());</div><div class="line"><span class="comment">// generate servlet .java file</span></div><div class="line"><span class="keyword">try</span> (ServletWriter writer = setupContextWriter(javaFileName)) &#123;</div><div class="line">    Generator.generate(writer, <span class="keyword">this</span>, pageNodes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>generateClass</code> 由上述分析可知，有两个实现类:</p>
<ul>
<li><code>AntCompiler</code></li>
</ul>
<p><code>AntCompiler</code> 最后调用的是 <code>org.apache.tools.ant.taskdefs.Javac</code> 进行的编译:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">generateClass</span><span class="params">(String[] smap)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> FileNotFoundException, JasperException, Exception </span>&#123;</div><div class="line">    Javac javac = (Javac) project.createTask(<span class="string">"javac"</span>);</div><div class="line">    javac.execute();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>JDTCompiler</code></li>
</ul>
<p><code>JDTCompiler</code> 最后调用的是 <code>org.eclipse.jdt.internal.compiler.Compiler</code> 进行的编译:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">generateClass</span><span class="params">(String[] smap)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> FileNotFoundException, JasperException, Exception </span>&#123;</div><div class="line">    Compiler compiler =</div><div class="line">        <span class="keyword">new</span> Compiler(env, policy, cOptions, requestor, problemFactory);</div><div class="line">    compiler.compile(compilationUnits);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，JSP 的整个编译流程分析完毕。</p>
<h3 id="Tomcat-资源"><a href="#Tomcat-资源" class="headerlink" title="Tomcat 资源"></a>Tomcat 资源</h3><h3 id="基于-JMX-的管理"><a href="#基于-JMX-的管理" class="headerlink" title="基于 JMX 的管理"></a>基于 JMX 的管理</h3><p>关于 JMX 的<a href="https://github.com/anxiaoyi/java-interview/wiki/JMX" target="_blank" rel="external">详细介绍</a></p>
<p><code>Catalina</code> 在 <code>org.apache.catalina.mbeans</code> 包中提供了一系列的 MBean 类。这些 MBean 类直接或间接继承自 <code>org.apache.tomcat.util.modeler.BaseModelMBean</code> 类，我们接下来将会重点讨论几个最重要的 MBean，分别是 <code>ClassNameMBean</code>、和 <code>MBeanFactory</code> 类。</p>
<p><strong><code>ClassNameMBean</code></strong>: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassNameMBean</span> <span class="keyword">extends</span> <span class="title">BaseModelMBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassNameMBean</span><span class="params">()</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> MBeanException, RuntimeOperationsException </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClassName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.resource.getClass().getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>MBeanFactory</code></strong>: 用于创建管理 Tomcat 中各种资源的所有模型 MBean，还提供了删除这些 MBean 的方法</p>
<h3 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h3><p>什么是虚拟主机?虚拟主机是使用特殊的软硬件技术,把一台计算机主机分成一台台 “虚拟” 的主机, <strong>每一台虚拟主机都具有独立的域名和 IP 地址 (或共享的 IP 地址) </strong>,有完整的 Internet 服务器(WWW、FTP、Email 等)功能。利用“虚拟主机”技术,每一台虚拟主机和一台独立的主机完全一样,每一台虚拟主机都具有独立的域名,具有完整 Internet 服务器功能。</p>
<p>虚拟主机的配置方法有两种: <strong>基于 IP 和基于名称</strong>。</p>
<p><strong>1. 基于 IP 的虚拟主机</strong>:</p>
<p><strong>一台机器可以配置多个网卡,配置多个不同的 IP</strong>。每一个域名被分配到同一台主机,但是仍然拥有独立的 IP 地址。显然这种方式也占用了更多 IP 资源,并且需要增加更多的网卡来达到需求,当然也可以为一个网卡配置多个 IP。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> <span class="attr">192.168.0.1</span>&gt;</span></div><div class="line">  ServerName www.abc.com</div><div class="line">  DocumentRoot c:/root/www.abc.com</div><div class="line">  ServerAdmin support@abc.com</div><div class="line">  ErrorLog c:/errorlog/www.abc.com</div><div class="line">  TransferLog c:/transferlog/www.abc.com</div><div class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> <span class="attr">192.168.0.2</span>&gt;</span></div><div class="line">  ServerName www.def.com</div><div class="line">  DocumentRoot c:/root/www.def.com</div><div class="line">  ServerAdmin support@def.com</div><div class="line">  ErrorLog c:/errorlog/www.def.com</div><div class="line">  TransferLog c:/transferlog/www.def.com</div><div class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></div></pre></td></tr></table></figure>
<p>此处必须为 www.abc.com 和 www.def.com 分别配置 DNS 映射 192.168.0.1 和 192.168.0.2。这也要求,Apache Server 必须同时监听这两个 IP。如果 DNS 不能够按照这个匹配配置,也将不能够提供服务。</p>
<p><strong>2. 基于名称的虚拟主机</strong>:</p>
<p>当虚拟 IP 技术不能够满足成千上万的域名需求时,基于名称的虚拟技术是十分廉价的解决方式。这种方法是在同一个主机上建立多个站点的服务,每一个站点的服务虚拟到一个域名,当用户请求这些域名服务时,都被虚拟到这台主机的 IP,并被分配到不同的站点。例如,可以像下面这样在 Apache 中进行配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> <span class="attr">192.168.0.1</span>&gt;</span></div><div class="line">  ServerName www.abc.com</div><div class="line">  DocumentRoot c:/root/www.abc.com</div><div class="line">  ServerAdmin support@abc.com</div><div class="line">  ErrorLog c:/errorlog/www.abc.com</div><div class="line">  TransferLog c:/transferlog/www.abc.com</div><div class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> <span class="attr">192.168.0.1</span>&gt;</span></div><div class="line">  ServerName www.def.com</div><div class="line">  DocumentRoot c:/root/www.def.com</div><div class="line">  ServerAdmin support@def.com</div><div class="line">  ErrorLog c:/errorlog/www.def.com</div><div class="line">  TransferLog c:/transferlog/www.def.com</div><div class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这种方式的问题是, <strong>如果请求的是 IP 而不是域名,将不能区分请求的是哪个站点的服务</strong>。这种配置只能够适用于 HTTP 连接,不能配置 SSL 连接,SSL 服务只能够按照惟一 IP 配置,而且只支持 HTTP/1.1,不支持 HTTP/1.0。</p>
<p><strong>前面提到了独立 IP(基于 IP 的虚拟主机)和共享的 IP(基于名称的虚拟主机) </strong>。共享的 IP 模式就是所有的虚拟主机都使用同一 IP。目前国内 IDC 提供的虚拟主机都是这种模式。这种模式的优点是节约数量有限的 IP,缺点就是虚拟主机只能通过域名访问而不能通过 IP 访问(其实也不算是缺点,只对邮件系统中用户的访问方式有一点点影响) 。而另外一种独立 IP 模式主要应用在邮件服务中。</p>
<p>Tomcat 在 <code>server.xml</code> 中的 <code>Engine</code> 下配置虚拟主机:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"www.abc.com"</span> <span class="attr">appBase</span>=<span class="string">"c:\root\www.abc.com"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">      <span class="attr">autoDeploy</span>=<span class="string">"true"</span> <span class="attr">xmlValidation</span>=<span class="string">"false"</span> <span class="attr">xmlNamespaceAware</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span>www.abc.net<span class="tag">&lt;/<span class="name">alias</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span>www.abc.org<span class="tag">&lt;/<span class="name">alias</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"ROOT"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"www.def.com"</span> <span class="attr">appBase</span>=<span class="string">"c:\root\www.def.com"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">      <span class="attr">autoDeploy</span>=<span class="string">"true"</span> <span class="attr">xmlValidation</span>=<span class="string">"false"</span> <span class="attr">xmlNamespaceAware</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span>www.def.net<span class="tag">&lt;/<span class="name">alias</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span>www.def.org<span class="tag">&lt;/<span class="name">alias</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"ROOT"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></div></pre></td></tr></table></figure>
<p>为了使以上的虚拟主机生效,必须在 DNS 服务器中注册以上的虚拟主机名称和别名,使它们的 IP 地址都指向 Tomcat 服务器所在的机器。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 www.abc.com</div><div class="line">127.0.0.1 www.abc.net</div><div class="line">127.0.0.1 www.abc.org</div><div class="line">127.0.0.1 www.def.com</div><div class="line">127.0.0.1 www.def.net</div><div class="line">127.0.0.1 www.def.org</div></pre></td></tr></table></figure>
<p>当然,在实际环境中这样做是不行的, 需要在 DNS 上做相应的域名解析。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://www.infoq.com/cn/articles/zh-tomcat-http-request-1" target="_blank" rel="external">Tomcat处理HTTP请求源码分析（上）</a></li>
<li><a href="">精通 Tomcat</a></li>
<li><a href="http://blog.csdn.net/lantian0802/article/details/8870286" target="_blank" rel="external">Tomcat 热部署实现方式源码分析总结</a></li>
<li><a href="https://item.jd.com/10913619.html" target="_blank" rel="external">《深入剖析 Tomcat》</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/14/Tomcat/" data-id="cjc5qrsza001z5cemvt2yiuf9" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-java-command" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/09/java-command/" class="article-date">
  <time datetime="2017-06-09T08:32:17.000Z" itemprop="datePublished">2017-06-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/09/java-command/">Java Command</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Java-Command"><a href="#Java-Command" class="headerlink" title="Java Command"></a>Java Command</h2><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">javac Main.java -cp jar1.jar:jar2.jar</div></pre></td></tr></table></figure>
<p><strong><code>Main.java</code> 放在前面还是放在后面都可以编译成功</strong></p>
<ul>
<li><strong>-d</strong>: 指定编译之后类保存的目录，<strong>目录必须提前创建好</strong></li>
</ul>
<p>在引用 <code>maven repository</code> 库的时候，必须明确指定 <code>jar</code> 文件的名称，因为 Maven 在下载的时候可能会同时下载 <code>source.jar</code> 和 <code>lib.jar</code> ，会造成引入错误，所以必须明确指定:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">javac PrimitiveServlet.java  -cp ~/.m2/repository/javax/servlet/javax.servlet-api/3.1.0/javax.servlet-api-3.1.0.jar:./</div></pre></td></tr></table></figure>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>运行的时候<strong>必须站在包的顶级目录执行</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">java -cp .:jar1.jar:jar2.jar Main</div><div class="line">java org.apache.log4j.helpers.Loader</div></pre></td></tr></table></figure>
<h3 id="运行-jar"><a href="#运行-jar" class="headerlink" title="运行 jar"></a>运行 <code>jar</code></h3><p>官方示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar mybatis-generator-core-1.3.6-SNAPSHOT.jar -configfile generatorConfig.xml -overwrite</div></pre></td></tr></table></figure>
<p>可是 <code>mybatis-generator-core-1.3.6-SNAPSHOT.jar</code> 要依赖 <code>mysql-connector</code> ，所以应该添加 <code>classpath</code>，而 <strong><code>-cp</code> 和 <code>-jar</code> 这两个命令是不能同时使用的</strong>，所以唯有指定 <code>main class</code> 这种办法了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -cp mybatis-generator-core-1.3.6-SNAPSHOT.jar:mysql-connector-java-6.0.6.jar org.mybatis.generator.api.ShellRunner -configfile generatorConfig.xml -overwrite</div></pre></td></tr></table></figure>
<p>其中 <code>main</code> 方法所在的类，是通过搜过 <code>mybatis-generator</code> 的源代码找到的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">zk@zk-pc:~/Documents/github/generator$ grep <span class="string">"main(String"</span> -Rn .</div><div class="line">./core/mybatis-generator-core/src/main/java/org/mybatis/generator/api/ShellRunner.java:53:    public static void main(String[] args) &#123;</div></pre></td></tr></table></figure>
<h3 id="反编译"><a href="#反编译" class="headerlink" title="反编译"></a>反编译</h3><p><strong><code>javap</code></strong>: Disassembles one or more class files</p>
<ul>
<li><strong><code>-c</code></strong>: Prints disassembled code, for example, the instructions that comprise the Java bytecodes, for each of the methods in the class.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">javap -c DocFooter.class</div></pre></td></tr></table></figure>
<h3 id="jar-包"><a href="#jar-包" class="headerlink" title="jar 包"></a>jar 包</h3><table>
<thead>
<tr>
<th>命令</th>
<th>操作</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jar cf jar-file input-file(s)</code></td>
<td>创建一个 JAR 文件</td>
</tr>
<tr>
<td><code>jar tf jar-file</code></td>
<td>查看 JAR 内容</td>
</tr>
<tr>
<td><code>jar xf jar-file</code></td>
<td>提取内容</td>
</tr>
<tr>
<td><code>java -jar app.jar</code></td>
<td>运行 JAR 文件</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>-c</strong>: 创建</li>
<li><strong>-f</strong>: 你想要输出到文件，而不是命令行</li>
<li><strong>-m</strong>: 你想要从一个已经存在的文件合并消息到 manifest 文件中</li>
<li><strong>-t</strong>: 列举包的 table</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jar cfm app.jar manifest.txt com/zk/HelloWorld.class</div></pre></td></tr></table></figure>
<p>manifest.txt 文件内容如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Main-Class: com.zk.HelloWorld</div></pre></td></tr></table></figure>
<p>创建出来的 MANIFEST.MF 文件如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Manifest-Version: 1.0</div><div class="line">Created-By: 1.7.0_06 (Oracle Corporation)</div><div class="line">Main-Class: com.zk.HelloWorld</div></pre></td></tr></table></figure>
<hr>
<p><strong>添加 <code>Main-Class</code></strong>:</p>
<ul>
<li><strong>-e</strong>: entrypoint</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jar cfe app.jar com.zk.HelloWorld com/zk/HelloWorld.class</div></pre></td></tr></table></figure>
<hr>
<p><strong>打包 resources</strong>:</p>
<p>打包的过程是严格按照路径结构来的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jar cf log4jtest.jar Log4jTest.java resources/*</div></pre></td></tr></table></figure>
<p>生成的 <code>log4jtest.jar</code> 的目录结构如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">META-INF/</div><div class="line">META-INF/MANIFEST.MF</div><div class="line">Log4jTest.java</div><div class="line">resources/log4j.properties</div></pre></td></tr></table></figure>
<h3 id="jps-列举运行的-JVM-信息"><a href="#jps-列举运行的-JVM-信息" class="headerlink" title="jps - 列举运行的 JVM 信息"></a>jps - 列举运行的 JVM 信息</h3><ul>
<li><strong>-m</strong>: 列举传递给 <code>main</code> 方法的参数</li>
<li><strong>-l</strong>: 列举完整的包名或完整的 JAR 文件的路径</li>
<li><strong>-v</strong>: 列举传递给 <code>JVM</code> 的参数</li>
</ul>
<h3 id="Java-资源加载"><a href="#Java-资源加载" class="headerlink" title="Java 资源加载"></a>Java 资源加载</h3><p>目录:</p>
<p><img src="17-06-14-15_48_00_421_95.png" alt=""></p>
<p><code>a.properties</code> 和 <code>ResourcePositionA.class</code> 位于同一级目录(同一个包)下，<code>a.properties</code> 挪到其它地方就找不到了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.net.URL url = <span class="keyword">this</span>.getClass().getResource(<span class="string">"a.properties"</span>)</div></pre></td></tr></table></figure>
<hr>
<p>目录:</p>
<p><img src="17-06-14-15_57_08_418_126.png" alt=""></p>
<p><code>system.properties</code> 位于顶级目录，<code>system.properties</code> 挪到其它地方就找不到了，在 <code>ResourcePositionA.java</code> 中有如下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.net.URL systemResource = ClassLoader.getSystemResource(<span class="string">"system.properties"</span>);</div></pre></td></tr></table></figure>
<p>从顶级目录获取资源也可以使用 <code>this.getClass().getResource()</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.getClass().getResource(<span class="string">"/system.properties"</span>)</div></pre></td></tr></table></figure>
<hr>
<p>还有一种 <code>getResource</code> 的方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Thread.currentThread().getContextClassLoader().getResource(resourceName)</div></pre></td></tr></table></figure>
<p><code>ClassLoader</code> can be passed <strong>(shared)</strong> when creating a new thread using Thread.setContextClassLoader, so that different thread contexts can load each other classes/resources. If not set, the default is the <code>ClassLoader</code> context of the parent Thread. This method is not appropriate if we want to load resources inside the packages unless we use complete paths starting from root.</p>
<hr>
<p><strong><code>Log4j</code> 查找 <code>log4j.properties</code> 的逻辑</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URL <span class="title">getResource</span><span class="params">(String resource)</span> </span>&#123;</div><div class="line">    ClassLoader classLoader = <span class="keyword">null</span>;</div><div class="line">    URL url = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 1. find by thread context class loader</span></div><div class="line">    classLoader = Thread.currentThread().getContextClassLoader();</div><div class="line">    url = classLoader.getResource(resource);</div><div class="line">    <span class="keyword">if</span> (url != <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> url;</div><div class="line"></div><div class="line">    <span class="comment">// 2. find by classloader</span></div><div class="line">    classLoader = Loader.class.getClassLoader();</div><div class="line">    url = classLoader.getResource(resource);</div><div class="line">    <span class="keyword">if</span> (url != <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> url;</div><div class="line"></div><div class="line">    <span class="comment">// 3. get the resource from the class path</span></div><div class="line">    <span class="keyword">return</span> ClassLoader.getSystemResource(resource);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir output</div><div class="line">javac Loader.java -d output/</div></pre></td></tr></table></figure>
<p>无论将 <code>log4j.properties</code> 放到编译后的类文件旁边，还是直接打包进 <code>jar</code> 包中，都可以实现加载与查找。站在 <code>output</code> 文件夹执行命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jar cfe log4j.jar org.apache.log4j.helpers.Loader log4j.properties org/apache/log4j/helpers/Loader*</div></pre></td></tr></table></figure>
<p>执行命令如下所示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar log4j.jar</div></pre></td></tr></table></figure>
<p>执行结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Trying to find [log4j.properties] using context classloader sun.misc.Launcher$AppClassLoader@42a57993.</div><div class="line">jar:file:/home/zk/Documents/github/java-interview/log4jtest/org/apache/log4j/helpers/output/log4j.jar!/log4j.properties</div></pre></td></tr></table></figure>
<p>具体源代码可以参考 <code>log4j</code> 的 <code>github</code> 的两个源文件:</p>
<ul>
<li><code>org.apache.log4j.helpers.Loader.java</code></li>
<li><code>org.apache.log4j.LogManager.java</code></li>
</ul>
<hr>
<p>使用 <code>Maven</code> 或者 <code>Gradle</code> 帮助我们编译项目的时候，资源文件需要放到 <code>resources</code> 目录下面:</p>
<p><img src="17-07-26-16_58_15_330_43.png" alt=""></p>
<p>编译之后，<code>aa.txt</code> 会拷贝到 <code>target/classes/</code> 目录下面:</p>
<p><img src="17-07-26-16_56_45_331_89.png" alt=""></p>
<hr>
<p>当尝试从 <code>Jar</code> 文件中读取资源的时候，遇到如下问题:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; java.lang.IllegalArgumentException: URI is not hierarchical</div><div class="line">	at java.io.File.&lt;init&gt;(File.java:418)</div><div class="line">	at com.zk.ExcelFactory.createExcelFromResource(ExcelFactory.java:19)</div><div class="line">	at com.zk.Application.main(Application.java:22)</div></pre></td></tr></table></figure>
<p>以下是 <a href="https://stackoverflow.com/questions/10144210/java-jar-file-use-resource-errors-uri-is-not-hierarchical" target="_blank" rel="external">stackoverflow</a> 给出的解释:</p>
<p>You cannot do this</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">File src = <span class="keyword">new</span> File(resourceUrLol.toURI()); <span class="comment">//ERROR HERE</span></div></pre></td></tr></table></figure>
<p>与此相对应，我就是使用了这样的错误获取资源的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> WorkbookFactory.create(<span class="keyword">new</span> File(getURL(excelName).toURI()));</div></pre></td></tr></table></figure>
<p>it is not a file! When you run from the ide you don’t have any error, because you don’t run a <code>jar</code> file. In the IDE classes and resources are extracted on the file system.</p>
<p>But you can open an <code>InputStream</code> in this way:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">InputStream in = Model.class.getClassLoader().getResourceAsStream(<span class="string">"/data.sav"</span>);</div></pre></td></tr></table></figure>
<p>Remove “/resource”. Generally the IDEs separates on file system classes and resources. But when the jar is created they are put all together. So the folder level “/resource” is used only for classes and resources separation.</p>
<p>When you get a resource from classloader you have to specify the path that the resource has inside the jar, that is the real package hierarchy.</p>
<p>或者通过 <code>URL</code> 自身携带的方法 <a href="http://docs.oracle.com/javase/6/docs/api/java/net/URL.html#openStream(" target="_blank" rel="external"><code>java.net.URL#openStream()</code></a>) 转为 <code>InputStream</code> 来操作</p>
<hr>
<p>文件转为 <code>URL</code> 的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(path).toURI().toURL();</div></pre></td></tr></table></figure>
<hr>
<p>注意文件转为 <code>URL</code> 意味着什么，路径 <code>/home/abc - def.jar</code> 将会被转化为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/home/abc/abc%20-%20def.jar</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /home/abc - def.jar</span></div><div class="line"><span class="keyword">new</span> File(<span class="string">"/home/abc - def.jar"</span>).toPath().toString();</div><div class="line"><span class="comment">// /home/abc/abc%20-%20def.jar</span></div><div class="line"><span class="keyword">new</span> File(<span class="string">"/home/abc - def.jar"</span>).toURI().toURL().getPath();</div></pre></td></tr></table></figure>
<p>想要<strong>转为正常路径</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">URLDecoder.decode(<span class="string">"/home/abc/abc%20-%20def.jar"</span>, <span class="string">"UTF-8"</span>);</div></pre></td></tr></table></figure>
<p>另外千万不要傻傻的自己来拼接 URL:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> URL(<span class="string">"file://"</span> + filePath);</div></pre></td></tr></table></figure>
<p>在 <code>UNIX</code> 系统上可能还发现没问题，但是到 <code>Windows</code> 系统上直接 GG:</p>
<p><img src="TIM图片20170811080148.png" alt=""></p>
<h3 id="Extensions"><a href="#Extensions" class="headerlink" title="Extensions"></a>Extensions</h3><p><strong>installed extensions</strong>: 放在 <code>lib/ext</code> 目录下面的 <code>jar</code> 包</p>
<p><img src="extb1.gif" alt=""></p>
<p>生成 <code>jar</code> 包:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir build</div><div class="line">javac -d ./build RectangleArea.java</div><div class="line"><span class="built_in">cd</span> build</div><div class="line">jar cvf area.jar RectangleArea.class</div></pre></td></tr></table></figure>
<p>编译:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">javac -classpath ./build/area.jar AreaApp.java</div></pre></td></tr></table></figure>
<p>运行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -classpath .:./build/area.jar AreaApp</div></pre></td></tr></table></figure>
<hr>
<p><strong>Download Extensions</strong>: 每次都需要下载，略过</p>
<hr>
<h4 id="Understanding-Extension-Class-Loading"><a href="#Understanding-Extension-Class-Loading" class="headerlink" title="Understanding Extension Class Loading"></a>Understanding Extension Class Loading</h4><p><code>class</code> 寻找路径:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Bootstrap classes ( rt.jar、i18n.jar )</div><div class="line">              |</div><div class="line">              V</div><div class="line">Installed extensions( jre/lib/ext/ )</div><div class="line">              |</div><div class="line">              V</div><div class="line">The class path (java.class.path, -classpath, -cp, CLASSPATH)</div></pre></td></tr></table></figure>
<p><img src="image03.png" alt=""></p>
<p>JVM 的各提供商使用本地代码来实现 <code>Bootstrap</code> 类加载器。</p>
<p><strong>类加载特性</strong>:</p>
<ul>
<li>延迟加载</li>
<li>当一个类被加载时,它的所有父类都必须被加载</li>
<li><strong>类缓存</strong>: 当一个类已经被请求,被类加载器加载之后,就会在 JVM 运行期间一直驻留在内存。当再次被请求时,就不需要再次加载,直接调用就可以了。</li>
<li><strong>独立的命名空间</strong>:<strong>不同的类加载器有自己独立的命名空间</strong>。例如 <code>Bootstrap</code> 类加载器加载了 <code>com.test.ClassA</code>, <code>System</code> 类加载器加载了 <code>com.test.ClassB</code>, 那么这两个类将被当作不同包中的类,它们之间的私有成员不能互相访问。</li>
</ul>
<p><img src="092514_0637_javaclasslo1.png" alt=""></p>
<p><strong>自定义类加载器</strong>:</p>
<p>在 J2SE 中提供了两个默认的实现类, <code>SecureClassLoader</code> 和 <code>URLClassLoader</code> 。<code>SecureClassLoader</code> 是对 <code>ClassLoader</code> 类的包装, 它使用了 Java 安全模型机制。 <code>URLClassLoader</code> 是 <code>SecureClassLoader</code> 的子类, 用于定位磁盘和网络上的 Jar 和类文件。<code>Extension</code> 类加载器和 <code>System</code> 类加载器均继承自 <code>URL</code> 类加载器。</p>
<hr>
<p>得到当前程序的所有 <code>classpath</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.getProperty(<span class="string">"java.class.path"</span>)</div></pre></td></tr></table></figure>
<h4 id="创建一个-Extensible-应用"><a href="#创建一个-Extensible-应用" class="headerlink" title="创建一个 Extensible 应用"></a>创建一个 Extensible 应用</h4><ul>
<li><strong>Extensible application</strong>: 你可以不用修改它原来的 <strong>code base</strong>，就能 <strong>extend</strong> 的应用，可理解为插件或者模块话</li>
<li><strong>Service</strong>: 一系列提供某些功能的接口</li>
<li><strong>Service provider interface (SPI)</strong>: 一个 <strong>Service</strong> 所定义的开放接口或抽象类</li>
<li><strong>Service Provider</strong>: 实现了 <strong>SPI</strong></li>
</ul>
<p>SPI 的全名为 Service Provider Interface.大多数开发人员可能不熟悉，因为这个是针对厂商或者插件的。在 <code>java.util.ServiceLoader</code> 的文档里有比较详细的介绍。简单的总结下 java spi 机制的思想。我们系统里抽象的各个模块，往往有很多不同的实现方案，比如日志模块的方案，xml 解析模块、jdbc 模块的方案等。面向的对象的设计里，我们一般推荐模块之间基于接口编程，模块之间不对实现类进行硬编码。一旦代码里涉及具体的实现类，就违反了可拔插的原则，如果需要替换一种实现，就需要修改代码。为了实现在模块装配的时候能不在程序里动态指明，这就需要一种<strong>服务发现机制</strong>。 java spi 就是提供这样的一个机制：<strong>为某个接口寻找服务实现的机制</strong>。有点类似 IOC 的思想，就是将装配的控制权移到程序之外，在模块化设计中这个机制尤其重要。</p>
<p>java spi 的具体约定为:当服务的提供者，提供了服务接口的一种实现之后，在 jar 包的 <code>META-INF/services/</code> 目录里同时创建一个<strong>以服务接口命名</strong>的文件。<strong>该文件里就是实现该服务接口的具体实现类</strong>。而当外部程序装配这个模块的时候，就能通过该 jar 包 <code>META-INF/services/</code> 里的配置文件找到具体的实现类名，并装载实例化，完成模块的注入。 基于这样一个约定就能很好的找到服务接口的实现类，而不需要再代码里制定。jdk 提供服务实现查找的一个工具类：<code>java.util.ServiceLoader</code></p>
<p>用法示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> ServiceLoader&lt;CodecSet&gt; codecSetLoader</div><div class="line">    = ServiceLoader.load(CodecSet.class);</div><div class="line">     </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Encoder <span class="title">getEncoder</span><span class="params">(String encodingName)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (CodecSet cp : codecSetLoader) &#123;</div><div class="line">        Encoder enc = cp.getEncoder(encodingName);</div><div class="line">        <span class="keyword">if</span> (enc != <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> enc;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>注册</strong>:</p>
<p>把一个文件放在 <code>META-INF/services</code> 目录下，文件名: 类的全名，文件必须 UTF-8 编码，在开头可以使用 # 来注释</p>
<p><strong>配置文件为什么要放在 <code>META-INF/services</code> 下面</strong>:</p>
<p><code>ServiceLoader</code> 源码已经写死了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">"META-INF/services/"</span>;</div></pre></td></tr></table></figure>
<p><strong><code>ServiceLoader</code> 读取实现类是什么时候实例化的</strong>:</p>
<p><code>ServiceLoader.LazyIterator.nextService</code> 中实例化，即 <code>load</code> 的结果迭代时才会被实例化。</p>
<hr>
<p><strong><code>ServiceLoader</code></strong> 类: 帮助你查找、加载、使用 <strong>service providers</strong>，他会搜索你的 <strong>class path</strong> 来查找 <code>service provider</code>，<code>ServiceLoader</code> 被 <code>final</code> 声明，意味着你无法覆盖它的算法</p>
<hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -Djava.ext.dirs=../DictionaryServiceProvider/dist:../ExtendedDictionary/dist -cp dist/DictionaryDemo.jar dictionary.DictionaryDemo</div></pre></td></tr></table></figure>
<ul>
<li><strong>java.ext.dirs</strong>: 指定从哪里加载 <strong>extension mechanism</strong> 所需要的类，通常用来给 JRE 或其他库添加功能</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://docs.oracle.com/javase/tutorial/ext/basics/index.html" target="_blank" rel="external">Creating and Using Extensions</a></li>
<li><a href="https://docs.oracle.com/javase/tutorial/deployment/jar/index.html" target="_blank" rel="external">Lesson: Packaging Programs in JAR Files</a></li>
<li><a href="http://blog.csdn.net/unei66/article/details/47051017" target="_blank" rel="external">Java ServiceLoader(SPI)学习</a></li>
<li><a href="http://www.logicbig.com/how-to/java/different-ways-to-load-resources/" target="_blank" rel="external">Different ways to load classpath resources in Java</a></li>
<li><a href="">《精通 Tomcat》</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/09/java-command/" data-id="cjc5qrt1u003q5cema6dlnjj5" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Motan" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/07/Motan/" class="article-date">
  <time datetime="2017-06-07T09:23:33.000Z" itemprop="datePublished">2017-06-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/07/Motan/">Motan</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Motan-服务注册中心"><a href="#Motan-服务注册中心" class="headerlink" title="Motan - 服务注册中心"></a>Motan - 服务注册中心</h2><ul>
<li><strong><code>RegistryService</code> 接口</strong>: 注册、设置 URL 的可用</li>
<li><strong><code>DiscoveryService</code> 接口</strong>: 订阅 URL</li>
<li><strong><code>Registry</code> 接口</strong>: 一个 URL 就是一个 <code>Registry</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Registry</span></span></div><div class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">RegistryService</span>, <span class="title">DiscoveryService</span> </span>&#123;</div><div class="line">    <span class="function">URL <span class="title">getUrl</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong><code>RegistryFactory</code> 接口</strong>: 根据 URL 创建 <code>Registry</code></li>
</ul>
<h2 id="Motan-代理"><a href="#Motan-代理" class="headerlink" title="Motan - 代理"></a>Motan - 代理</h2><ul>
<li><strong><code>ProxyFactory</code> 接口</strong>: 创建某个类的代理</li>
</ul>
<p>关注实现类 <code>RefererInvocationHandler</code> 的 <code>invoke</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( 是本地方法( method ) ) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> async = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> ( method 以 <span class="string">'Async'</span> 结尾 ||</div><div class="line">         method 返回 ResponseFuture.class ) &#123;</div><div class="line">        async = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Request 请求 = <span class="keyword">new</span> Request( 请求 Id );</div><div class="line"></div><div class="line">    <span class="keyword">for</span> ( 集群: 所有集群 ) &#123;</div><div class="line">        <span class="keyword">if</span> ( 集群关了 )</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Response r = 集群.call( 请求 );</div><div class="line">            <span class="keyword">if</span> ( async )</div><div class="line">                <span class="keyword">return</span> response;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                <span class="keyword">return</span> response.value;</div><div class="line">        &#125; <span class="keyword">catch</span>( RuntimeException e ) &#123;</div><div class="line">            <span class="keyword">if</span> ( 业务方逻辑抛出的异常 )</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Motan-数据传输"><a href="#Motan-数据传输" class="headerlink" title="Motan - 数据传输"></a>Motan - 数据传输</h2><h3 id="异步请求"><a href="#异步请求" class="headerlink" title="异步请求"></a>异步请求</h3><p>在源码编译阶段，让编译器创建一个类名为 <code>{interfaceName}Async</code> ，同时所有方法以 <code>Async</code> 结尾的生成类，并默认放在目录 <code>target/generated-sources/annotations/</code> 下面:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations,</span></span></div><div class="line"><span class="function"><span class="params">                       RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> ( Element c: 所有注解了 MotanAsync.class 的类) &#123;</div><div class="line">        <span class="keyword">if</span> ( c 是接口 ) &#123;</div><div class="line"></div><div class="line">            </div><div class="line">            </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="传输"><a href="#传输" class="headerlink" title="传输"></a>传输</h3><ul>
<li><strong><code>Transport</code> 接口</strong>: 将 <code>byte[]</code> 请求从这头发送到那一头，并返回 <code>byte[]</code></li>
<li><strong><code>Channel</code> 接口</strong>: 将 <code>Request</code> 请求从这头发送到另一头，并返回 <code>Response</code></li>
<li><strong><code>Endpoint</code> 接口</strong>: 继承 <code>Channel</code></li>
<li><strong><code>Clent</code> 接口</strong>: 继承 <code>Endpoint</code>，异步发送心跳包请求</li>
<li><strong><code>Server</code> 接口</strong>: 继承 <code>Endpoint</code>，可以得到所有的 <code>Channels</code></li>
<li><strong><code>MessageHandler</code> 接口</strong>: 处理一个 <code>Channel</code> 上的 <code>message</code>，并返回 <code>Object</code> 类型</li>
<li><strong><code>EndpointFactory</code> 接口</strong>: 可以创建 <code>Server</code> 和 <code>Client</code></li>
<li><strong><code>EndpointManager</code> 接口</strong>: 可以初始化/销毁，也可以添加/移除 <code>Endpoint</code></li>
<li><strong><code>HeartbeatFactory</code> 接口</strong>: 创建心跳包请求，对 <code>MessageHandler</code> 进行包装</li>
</ul>
<p>下面看 <code>AbstractClient</code> 的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractClient</span></span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Client</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> InetSocketAddress localAddress;</div><div class="line">    <span class="keyword">protected</span> InetSocketAddress remoteAddress;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> ChannelState state = <span class="string">'未初始化状态'</span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>AbstractServer</code> 的实现和 <code>AbstractClient</code> 的实现大同小异，不再赘述。</p>
<p><code>AbstractPoolClient</code> 的实现，实际上内部使用了 <code>org.apache.commons.pool.impl.GenericObjectPool</code> 作为默认对象池的实现，其可以支持如下机制:</p>
<ul>
<li>设置最小空闲对象个数</li>
<li>设置最大空闲对象个数</li>
<li>设置最大活跃对象个数</li>
<li>设置最大等待对象个数</li>
<li>设置以 LIFO 或 FIFO 机制来借对象<ul>
<li>LIFO: 借对象的时候会返回上次归还的 <code>idle</code> 对象</li>
<li>FIFO: 借对象的时候会返回很久未使用过的 <code>idle</code> 对象</li>
</ul>
</li>
<li>如果非延迟初始化，则会添加最小空闲个数量的对象</li>
<li>借对象</li>
<li>使对象失效</li>
<li>还对象</li>
</ul>
<p><code>DefaultRpcHeartbeatFactory</code> 的实现如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRpcHeartbeatFactory</span></span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">HeartbeatFactory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Request <span class="title">createRequest</span><span class="params">()</span> </span>&#123;</div><div class="line">        Request request = <span class="keyword">new</span> Request();</div><div class="line">        request.接口名(<span class="string">"com.weibo.api.motan.rpc.heartbeat"</span>);</div><div class="line">        request.方法名(<span class="string">"heartbeat"</span>);</div><div class="line">        request.参数(<span class="string">"void"</span>);</div><div class="line">        <span class="keyword">return</span> request;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MessageHandler <span class="title">wrapMessageHandler</span><span class="params">(MessageHandler handler)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HeartMessageHandleWrapper(handler);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartMessageHandleWrapper</span></span></div><div class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">MessageHandler</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">handle</span><span class="params">(Channel channel, Object message)</span> </span>&#123;</div><div class="line">            <span class="comment">// 根据接口名、方法名、参数来判断是否是心跳包请求</span></div><div class="line">            <span class="keyword">if</span> ( 是心跳包请求(message) ) &#123;</div><div class="line">                DefaultResponse response = <span class="keyword">new</span> DefaultResponse();</div><div class="line">                response.setValue(<span class="string">"heartbeat"</span>);</div><div class="line">                <span class="keyword">return</span> response;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> messageHandler.handle(channel, message);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>HeartbeatClientEndpointManager</code> 中有一个核心数据结构:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ConcurrentMap&lt;Client, HeartbeatFactory&gt; endpoints;</div></pre></td></tr></table></figure>
<p>然后在构造器中又开启了一个 <code>ScheduledExecutorService</code> 服务，每隔 500 ms 检查一下 <code>Client</code> 是否联通:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 如果节点是存活状态，那么没必要走心跳</span></div><div class="line"><span class="keyword">if</span> (endpoint.isAvailable()) &#123;</div><div class="line">    <span class="keyword">continue</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">HeartbeatFactory factory = entry.getValue();</div><div class="line">endpoint.heartbeat(factory.createRequest());</div></pre></td></tr></table></figure>
<h2 id="Motan-集群"><a href="#Motan-集群" class="headerlink" title="Motan - 集群"></a>Motan - 集群</h2><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><ul>
<li><strong><code>LoadBalance&lt;T&gt;</code> 接口</strong>: 对请求选择 <code>Referer</code></li>
<li><strong><code>AbstractLoadBalance&lt;T&gt;</code> 抽象类</strong>: 实现了 <code>LoadBalance&lt;T&gt;</code> 接口，主要对可用的 <code>Referer&lt;T&gt;</code> 在数量上进行了一些检查，并交由子类来实现 <code>doSelect</code> 方法</li>
</ul>
<p>Motan 主要提供了如下几种负载均衡算法，所有算法均继承自 <code>AbstractLoadBalance&lt;T&gt;</code>:</p>
<h4 id="ActiveWeightLoadBalance-lt-T-gt-低并发优化负载均衡"><a href="#ActiveWeightLoadBalance-lt-T-gt-低并发优化负载均衡" class="headerlink" title="ActiveWeightLoadBalance&lt;T&gt;: 低并发优化负载均衡"></a><strong><code>ActiveWeightLoadBalance&lt;T&gt;</code></strong>: 低并发优化负载均衡</h4><ul>
<li>随机抽取 10 台服务器，筛选出 <code>activeRefererCount</code> 值最小的可用的 <code>Referer</code></li>
</ul>
<h4 id="ConsistentHashLoadBalance-lt-T-gt-一致性-Hash"><a href="#ConsistentHashLoadBalance-lt-T-gt-一致性-Hash" class="headerlink" title="ConsistentHashLoadBalance&lt;T&gt;: 一致性 Hash"></a><strong><code>ConsistentHashLoadBalance&lt;T&gt;</code></strong>: 一致性 Hash</h4><p>生成一致性 <code>Hash</code> 数组算法:</p>
<ul>
<li>把所有 <code>referers</code> 全部打乱</li>
<li>每打乱一次，就放进数组里面，</li>
<li>上述两步骤重复 1000 次</li>
<li>然后最终使 <code>consistentHashReferers</code> 指向这个数组</li>
</ul>
<p><code>Hash</code> 算法的生成:</p>
<ul>
<li>无参数，就基于 <code>Request</code> 对象本身生成 <code>hashCode</code></li>
<li>有参数，就使用 <code>Arrays.hashCode(request.getArguments())</code> 来生成 <code>hashCode</code></li>
<li>最后，使用 <code>0x7fffffff &amp; originValue</code> 来得到最终的 <code>hash</code> 值</li>
</ul>
<p>请求选择 <code>Referer</code>:</p>
<ul>
<li>遍历所有的 <code>referers</code></li>
<li>然后进行下面的取余操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ref = consistentHashReferers.get((hash + i) % consistentHashReferers.size());</div></pre></td></tr></table></figure>
<ul>
<li>如果这个 <code>ref</code> 可用，那么直接返回</li>
</ul>
<h4 id="LocalFirstLoadBalance-lt-T-gt-本地服务优先"><a href="#LocalFirstLoadBalance-lt-T-gt-本地服务优先" class="headerlink" title="LocalFirstLoadBalance&lt;T&gt;: 本地服务优先"></a><strong><code>LocalFirstLoadBalance&lt;T&gt;</code></strong>: 本地服务优先</h4><p>当 <code>referers</code> 里面包含本地暴露的服务时，并此服务为 <code>available</code> 的情况下，优先使用此服务。当不存在本地暴露的服务时，默认使用低并发 <code>ActiveWeight</code> 负载均衡策略。</p>
<p>对 <code>referers</code> 根据 <code>ip</code> 顺序查找本地服务，多存在多个本地服务，获取 <code>Active</code> 最小的本地服务进行服务。当不存在本地服务，但是存在远程 <code>RPC</code> 服务，则根据 <code>ActivWeight</code> 获取远程 <code>RPC</code> 服务，当两者都存在，所有本地服务都应优先于远程服务，本地 <code>RPC</code> 服务与远程 <code>RPC</code> 服务内部则根据 <code>ActiveWeight</code> 进行.</p>
<p><strong>获取本地 IP 算法</strong>: 检查缓存 -&gt; 检查 <code>Hostname</code> -&gt; 根据 <code>Socket</code> -&gt; 根据网口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">IP 得到本地IP() &#123;</div><div class="line">    <span class="keyword">if</span> (本地缓存了)</div><div class="line">        <span class="keyword">return</span> 缓存的;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (InetAddress.getLocalHost())</div><div class="line">        <span class="keyword">return</span> InetAddress.getLocalHost();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (创建 Socket 连接指定目标地址)</div><div class="line">        <span class="keyword">return</span> socket.getLocalAddress();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (NetworkInterface.getNetworkInterfaces())</div><div class="line">        <span class="keyword">return</span> 轮询到的 IP;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>找到本地 IP 后，会将 <code>Referres</code> 里面所有等于这个 <code>IP</code> 的 <code>Referer</code> 筛选出来，然后从这几个 <code>Referer</code> 中找到 <code>Referer.activeRefererCount()</code> 数量最少的的 <code>Referer</code></p>
<h4 id="RandomLoadBalance-lt-T-gt-随机负载均衡"><a href="#RandomLoadBalance-lt-T-gt-随机负载均衡" class="headerlink" title="RandomLoadBalance&lt;T&gt;: 随机负载均衡"></a><strong><code>RandomLoadBalance&lt;T&gt;</code></strong>: 随机负载均衡</h4><p>随机从 <code>referers</code> 中挑选一个可用的 <code>Referer</code> 返回</p>
<h4 id="RoundRobinLoadBalance-lt-T-gt-轮询负载均衡"><a href="#RoundRobinLoadBalance-lt-T-gt-轮询负载均衡" class="headerlink" title="RoundRobinLoadBalance&lt;T&gt;: 轮询负载均衡"></a><code>RoundRobinLoadBalance&lt;T&gt;</code>: 轮询负载均衡</h4><p>在 <code>referers</code> 上轮询可用的 <code>Referer</code>，其中获取下一个索引的算法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> AtomicInteger idx = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getNextPositive</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> MathUtil.getPositive(idx.incrementAndGet());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ConfigurableWeightLoadBalance-lt-T-gt-权重可配置的负载均衡"><a href="#ConfigurableWeightLoadBalance-lt-T-gt-权重可配置的负载均衡" class="headerlink" title="ConfigurableWeightLoadBalance&lt;T&gt;: 权重可配置的负载均衡"></a><code>ConfigurableWeightLoadBalance&lt;T&gt;</code>: 权重可配置的负载均衡</h4><p><strong>TODO</strong></p>
<h3 id="HaStrategy-高可用策略"><a href="#HaStrategy-高可用策略" class="headerlink" title="HaStrategy: 高可用策略"></a>HaStrategy: 高可用策略</h3><p><strong><code>HaStrategy&lt;T&gt;</code></strong> 接口定义如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HaStrategy</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(URL url)</span></span>;</div><div class="line">    <span class="function">Response <span class="title">call</span><span class="params">(Request request, LoadBalance&lt;T&gt; loadBalance)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>AbstractHaStrategy&lt;T&gt;</code></strong> 抽象类主要是定义了一个 <code>URL</code> 字段，目前主要提供两种策略:</p>
<ul>
<li><strong><code>FailfastHaStrategy&lt;T&gt;</code></strong>: 快速失败策略</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">call</span><span class="params">(Request request, LoadBalance&lt;T&gt; loadBalance)</span> </span>&#123;</div><div class="line">    Referer&lt;T&gt; refer = loadBalance.select(request);</div><div class="line">    <span class="keyword">return</span> refer.call(request);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong><code>FailoverHaStrategy&lt;T&gt;</code></strong>: 失败重试策略</li>
</ul>
<p>先使用负载均衡筛选出一批符合策略的 <code>referers</code>，然后轮询重试:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tryCount; i++) &#123;</div><div class="line">    Referer&lt;T&gt; refer = referers.get(i % referers.size());</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        request.setRetries(i);</div><div class="line">        <span class="keyword">return</span> refer.call(request);</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">        <span class="comment">// 对于业务异常，直接抛出</span></div><div class="line">        <span class="keyword">if</span> (ExceptionUtil.isBizException(e)) &#123;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i &gt;= tryCount) &#123;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Motan-序列化"><a href="#Motan-序列化" class="headerlink" title="Motan - 序列化"></a>Motan - 序列化</h2><p>实现 <code>Object</code> 和 <code>byte[]</code> 之间的相互转化:</p>
<ul>
<li><code>FactJson</code> 序列化</li>
<li><code>Hessian2</code> 序列化</li>
</ul>
<h2 id="Motan-服务开关"><a href="#Motan-服务开关" class="headerlink" title="Motan - 服务开关"></a>Motan - 服务开关</h2><ul>
<li><strong><code>SwitchListener</code> 接口</strong>: 通知服务开/关了</li>
<li><strong>Switcher</strong>: 代表一个开关</li>
</ul>
<p>两个核心数据结构:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, Switcher&gt; switchers;</div><div class="line"><span class="keyword">private</span> Map&lt;String, List&lt;SwitcherListener&gt;&gt; listenerMap;</div></pre></td></tr></table></figure>
<p>每次 <code>setValue</code> 的时候，都会遍历这个开关上的所有 <code>SwitchListener</code> 来通知值变了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(String switcherName, <span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">    putSwitcher(<span class="keyword">new</span> Switcher(switcherName, value));</div><div class="line"></div><div class="line">    List&lt;SwitcherListener&gt; listeners = listenerMap.get(switcherName);</div><div class="line">    <span class="keyword">if</span>(listeners != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (SwitcherListener listener : listeners) &#123;</div><div class="line">            listener.onValueChanged(switcherName, value);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="SPI-扩展"><a href="#SPI-扩展" class="headerlink" title="SPI 扩展"></a>SPI 扩展</h2><ul>
<li><strong><code>DefaultThreadFactory</code></strong>: 默认线程工厂</li>
<li><strong><code>Spi</code> 注解</strong>: </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Spi &#123;</div><div class="line">    <span class="function">Scope <span class="title">scope</span><span class="params">()</span> <span class="keyword">default</span> Scope.PROTOTYPE</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>作用域可以设置为:</p>
<ul>
<li><code>Scope.SINGLETON</code>: 单例模式</li>
<li><code>Scope.PROTOTYPE</code>: 多例模式</li>
</ul>
</li>
<li><p><strong><code>SpiMeta</code> 注解</strong>: Spi 元信息</p>
</li>
<li><strong><code>Activation</code> 注解</strong>: 用来对 Spi 的实现根据条件进行过滤、排序等</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Activation &#123;</div><div class="line"></div><div class="line">    <span class="comment">/** seq号越小，在返回的list&lt;Instance&gt;中的位置越靠前，尽量使用 0-100以内的数字 */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sequence</span><span class="params">()</span> <span class="keyword">default</span> 20</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** spi 的key，获取spi列表时，根据key进行匹配，当key中存在待过滤的search-key时，匹配成功 */</span></div><div class="line">    String[] key() <span class="keyword">default</span> <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** 是否支持重试的时候也调用 */</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">retry</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong><code>ActivationComparator</code></strong>: 比较器</li>
<li><strong><code>ExtensionLoader&lt;T&gt;</code></strong>: 自己实现的 <code>ServiceProvider</code></li>
</ul>
<p>构造器，需要传入想要实例化的接口，如 <code>com.weibo.api.motan.cluster.HaStrategy.class</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">ExtensionLoader</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.type = type;</div><div class="line">    <span class="keyword">this</span>.classLoader = Thread.currentThread().getContextClassLoader();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从资源文件夹加载 <code>URL</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String fullName = <span class="string">"META-INF/services/"</span> + type.getName();</div><div class="line">Enumeration&lt;URL&gt; urls = classLoader.getResources(fullName);</div></pre></td></tr></table></figure>
<p>然后解析文件中的所有声明的实现类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">    indexNumber++;</div><div class="line">    parseLine(type, url, line, indexNumber, classNames);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>解析完类之后，装载类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clz = (Class&lt;T&gt;) Class.forName(className, <span class="keyword">true</span>, classLoader);</div></pre></td></tr></table></figure>
<p>这里的 <code>true</code> 参数代表所有位于这个<strong>类中的所有静态块都被初始化</strong>。</p>
<p>接着检查刚装载的类是否符合实现要求:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// check is class public</span></div><div class="line"><span class="keyword">if</span> (!Modifier.isPublic(clz.getModifiers())) &#123;</div><div class="line">    failThrows(clz, <span class="string">"Error is not a public class"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// check is constructor public</span></div><div class="line">Constructor&lt;?&gt;[] constructors = clz.getConstructors();</div><div class="line"><span class="keyword">if</span> (constructors == <span class="keyword">null</span> || constructors.length == <span class="number">0</span>) &#123;</div><div class="line">    failThrows(clz, <span class="string">"Error has no public no-args constructor"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> (Constructor&lt;?&gt; constructor : constructors) &#123;</div><div class="line">    <span class="keyword">if</span> (Modifier.isPublic(constructor.getModifiers()) &amp;&amp; constructor.getParameterTypes().length == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// check inherit</span></div><div class="line"><span class="keyword">if</span> (!type.isAssignableFrom(clz)) &#123;</div><div class="line">    failThrows(clz, <span class="string">"Error is not instanceof "</span> + type.getName());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>获取单例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Spi spi = type.getAnnotation(Spi.class);</div><div class="line"><span class="keyword">if</span> (spi.scope() == Scope.SINGLETON) &#123;</div><div class="line">    <span class="keyword">synchronized</span> (singletonInstances) &#123;</div><div class="line">        obj = singletonInstances.get(name);</div><div class="line">        <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> obj;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        obj = clz.newInstance();</div><div class="line">        singletonInstances.put(name, obj);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>获取 PROTOTYPE 类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Class&lt;T&gt; clz = extensionClasses.get(name);</div><div class="line"><span class="keyword">return</span> clz.newInstance();</div></pre></td></tr></table></figure>
<p>获取所有扩展:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">List&lt;T&gt; exts = <span class="keyword">new</span> ArrayList&lt;T&gt;(extensionClasses.size());</div><div class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Class&lt;T&gt;&gt; entry : extensionClasses.entrySet()) &#123;</div><div class="line">    Activation activation = entry.getValue().getAnnotation(Activation.class);</div><div class="line">    <span class="keyword">if</span> (StringUtils.isBlank(key)) &#123;</div><div class="line">        exts.add(getExtension(entry.getKey()));</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activation != <span class="keyword">null</span> &amp;&amp; activation.key() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (String k : activation.key()) &#123;</div><div class="line">            <span class="keyword">if</span> (key.equals(k)) &#123;</div><div class="line">                exts.add(getExtension(entry.getKey()));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">Collections.sort(exts, <span class="keyword">new</span> ActivationComparator&lt;T&gt;());</div><div class="line"><span class="keyword">return</span> exts;</div></pre></td></tr></table></figure>
<h2 id="Motan-Config-配置"><a href="#Motan-Config-配置" class="headerlink" title="Motan - Config 配置"></a>Motan - Config 配置</h2><ul>
<li><strong><code>AbstractConfig</code></strong>: </li>
</ul>
<p>从像下面的这样的方法中提取 <code>key</code> 以及执行方法获取 <code>value</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public boolean isXXX() &#123;</div><div class="line">    return false;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public String getName() &#123;</div><div class="line">    return &quot;&quot;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong><code>ProtocolConfig</code></strong>:</li>
</ul>
<table>
<thead>
<tr>
<th>属性</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>服务协议</td>
</tr>
<tr>
<td>serialization</td>
<td>序列化方式</td>
</tr>
<tr>
<td>codec</td>
<td>协议编码</td>
</tr>
<tr>
<td>iothreads</td>
<td>IO 线程池大小</td>
</tr>
<tr>
<td>requestTimeout</td>
<td>请求超时</td>
</tr>
<tr>
<td>minClientConnection</td>
<td>最小连接数</td>
</tr>
<tr>
<td>maxClientConnection</td>
<td>最大连接数</td>
</tr>
<tr>
<td>minWorkerThread</td>
<td>最小工作池线程数</td>
</tr>
<tr>
<td>maxWorkerThread</td>
<td>最大工作池线程数</td>
</tr>
<tr>
<td>maxContentLength</td>
<td>请求响应包的最大长度限制</td>
</tr>
<tr>
<td>maxServerConnection</td>
<td>Server 支持的最大连接数</td>
</tr>
<tr>
<td>poolLifo</td>
<td>连接池管理方式，是否 LIFO</td>
</tr>
<tr>
<td>lazyInit</td>
<td>是否延迟</td>
</tr>
<tr>
<td>endpointFactory</td>
<td>endpointFactory</td>
</tr>
<tr>
<td>cluster</td>
<td>采用哪种 cluster 的实现</td>
</tr>
<tr>
<td>loadbalance</td>
<td>负载均衡方式</td>
</tr>
<tr>
<td>haStrategy</td>
<td>high available strategy</td>
</tr>
<tr>
<td>workerQueueSize</td>
<td>server worker queue size</td>
</tr>
<tr>
<td>server accept connections count</td>
<td>acceptConnections</td>
</tr>
<tr>
<td>proxy</td>
<td>proxy type, like jdk or javassist</td>
</tr>
<tr>
<td>filter</td>
<td>filter, 多个filter用”,”分割，blank string 表示采用默认的filter配置</td>
</tr>
<tr>
<td>retries</td>
<td>retry count if call failure</td>
</tr>
<tr>
<td>async</td>
<td>if the request is called async, a taskFuture result will be sent back</td>
</tr>
<tr>
<td>isDefault</td>
<td>是否缺省配置</td>
</tr>
<tr>
<td>Map<string, string=""> parameters</string,></td>
<td>扩展参数</td>
</tr>
</tbody>
</table>
<h2 id="Motan-Spring-扩展"><a href="#Motan-Spring-扩展" class="headerlink" title="Motan - Spring 扩展"></a>Motan - Spring 扩展</h2><p>先简单介绍一下几个扩展 <code>Spring</code> 的重要接口:</p>
<h3 id="InitializingBean"><a href="#InitializingBean" class="headerlink" title="InitializingBean"></a>InitializingBean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InitializingBean</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当 <code>Bean</code> 的所有属性均被设置完的时候，此方法会被调用</p>
<h3 id="DisposableBean"><a href="#DisposableBean" class="headerlink" title="DisposableBean"></a>DisposableBean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DisposableBean</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当 <code>Spring</code> 容器释放这个 <code>Bean</code> 的时候，次方法会被调用</p>
<h3 id="BeanFactoryAware"><a href="#BeanFactoryAware" class="headerlink" title="BeanFactoryAware"></a>BeanFactoryAware</h3><p>Interface to be implemented by beans <strong>that wish to be aware of their owning <code>BeanFactory</code></strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactoryAware</span> <span class="keyword">extends</span> <span class="title">Aware</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory var1)</span> <span class="keyword">throws</span> BeansException</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Aware</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h3><p>The <code>BeanPostProcessor</code> interface defines <strong>callback methods</strong> that you can implement to <strong>provide your own (or override the container’s default) instantiation logic, dependency-resolution logic</strong>, and so forth. If you want to implement some custom logic after the Spring container finishes instantiating, configuring, and initializing a bean, you can plug in one or more BeanPostProcessor implementations.</p>
<h2 id="Motan-log"><a href="#Motan-log" class="headerlink" title="Motan - log"></a>Motan - log</h2><ul>
<li><strong><code>LogService</code></strong>: 常见的 Log 方法</li>
</ul>
<p>默认实现 <code>DefaultLogService</code> 采用的是: <code>org.slf4j.Logger</code></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://weibo.com/ttarticle/p/show?id=2309404032432130125498" target="_blank" rel="external">Motan：支撑微博千亿调用的轻量级RPC框架</a></li>
<li><a href="http://weibo.com/ttarticle/p/show?id=2309403951077522312320" target="_blank" rel="external">支撑微博千亿调用的轻量级RPC框架：Motan</a></li>
<li><a href="http://hannesdorfmann.com/annotation-processing/annotationprocessing101" target="_blank" rel="external">ANNOTATION PROCESSING 101</a></li>
<li><a href="https://stackoverflow.com/questions/23396033/random-over-threadlocalrandom" target="_blank" rel="external">Random over ThreadLocalRandom</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/07/Motan/" data-id="cjc5qrsv4000d5cemw1igifvz" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-computer-hardware" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/06/computer-hardware/" class="article-date">
  <time datetime="2017-06-06T13:00:25.000Z" itemprop="datePublished">2017-06-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/理解计算机/">理解计算机</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/06/computer-hardware/">System Hardware &amp; 计算机体系结构</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="System-Hardware-amp-计算机体系结构"><a href="#System-Hardware-amp-计算机体系结构" class="headerlink" title="System Hardware &amp; 计算机体系结构"></a>System Hardware &amp; 计算机体系结构</h2><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>The CPU has several layers of cache between it and main memory (RAM), because even accessing main memory is too slow.</p>
<p><strong>The closer the cache is to the CPU, the faster it is and the smaller it is</strong>.  L1 cache is small and very fast, and right next to the core that uses it.  L2 is bigger and slower, and still only used by a single core.  L3 is more common with modern multi-core machines, and is bigger again, slower again, and shared across cores on a single socket.  Finally you have main memory, which is shared across all cores and all sockets.</p>
<table>
<thead>
<tr>
<th>Latency from CPU to…</th>
<th>Approx. number of CPU cycles</th>
<th>Approx. time in nanoseconds</th>
</tr>
</thead>
<tbody>
<tr>
<td>Main memory</td>
<td></td>
<td>~60-80ns</td>
</tr>
<tr>
<td>QPI transit (between sockets, not drawn)</td>
<td></td>
<td>~20ns</td>
</tr>
<tr>
<td>L3 cache</td>
<td>~40-45 cycles,</td>
<td>~15ns</td>
</tr>
<tr>
<td>L2 cache</td>
<td>~10 cycles,</td>
<td>~3ns</td>
</tr>
<tr>
<td>L1 cache</td>
<td>~3-4 cycles,</td>
<td>~1ns</td>
</tr>
<tr>
<td>Register</td>
<td>1 cycle</td>
<td></td>
</tr>
</tbody>
</table>
<p><img src="CacheHierarchy.jpg" alt=""><br><img src="CacheCoherency.jpg" alt=""><br><img src="cacheline.png" alt=""></p>
<p><strong>(1) Cache lines</strong></p>
<p>Now the interesting thing to note is that it’s not individual items that get stored in the cache - i.e. it’s not a single variable, a single pointer.  The cache is made up of cache lines, typically 64 bytes, and it effectively references a location in main memory.  A Java long is 8 bytes, so in a single cache line you could have 8 long variables.</p>
<p><img src="CacheLines.png" alt=""></p>
<p>参考 <a href="http://mechanitis.blogspot.jp/2011/07/dissecting-disruptor-why-its-so-fast_22.html" target="_blank" rel="external">Dissecting the Disruptor: Why it’s so fast (part two) - Magic cache line padding</a></p>
<h4 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h4><p>It is a basic Law of Computing that given <strong>a single CPU</strong> resource, <strong>executing A and B sequentially will always be faster than executing A and B “simultaneously” through time-slicing</strong>. Once the number of threads exceeds the number of CPU cores, you’re going slower by adding more threads, not faster.</p>
<p>Don’t be tricked into thinking, “SSDs are faster and therefore I can have more threads”. That is exactly 180 degrees backwards. Faster, no seeks, no rotational delays means less blocking and therefore fewer threads [closer to core count] will perform better than more threads. <strong>More threads only perform better when blocking creates opportunities for executing</strong>.</p>
<h4 id="False-Sharing"><a href="#False-Sharing" class="headerlink" title="False Sharing"></a>False Sharing</h4><p>多个线程修改共享一个 Cache Line 的独立变量的时候，会造成这个 Cache Line 中的其他变量缓存失效，这被称之为 False sharing</p>
<p><img src="cache-line.png" alt=""></p>
<p>在核心 1 上运行的线程想更新变量 X，同时核心2上的线程想要更新变量 Y。不幸的是，这两个变量在同一个缓存行中。每个线程都要去竞争缓存行的所有权来更新变量。如果核心 1 获得了所有权，缓存子系统将会使核心 2 中对应的缓存行失效。当核心 2 获得了所有权然后执行更新操作，核心 1 就要使自己对应的缓存行失效。这会来来回回的经过 L3 缓存，大大影响了性能。如果互相竞争的核心位于不同的插槽，就要额外横跨插槽 (socket interconnect) 连接，问题可能更加严重。</p>
<p><img src="5-4-figure-1.gif" alt=""></p>
<p><strong>False sharing occurs when threads on different processors modify variables that reside on the same cache line. This invalidates the cache line and forces a memory update to maintain cache coherency</strong>.</p>
<p>(1) Java 6 通过填充缓存行 (padding the cache) 来避免:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RingBufferPad</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> p1, p2, p3, p4, p5, p6, p7;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参考 <a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java" target="_blank" rel="external">RingBuffer.java</a></p>
<p>(2) Java 7</p>
<p>It seems Java 7 <strong>got clever and eliminated or re-ordered the unused fields</strong>, thus re-introducing false sharing.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">sumPaddingToPreventOptimisation</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    PaddedAtomicLong v = longs[index];</div><div class="line">    <span class="keyword">return</span> v.p1 + v.p2 + v.p3 + v.p4 + v.p5 + v.p6;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PaddedAtomicLong</span> <span class="keyword">extends</span> <span class="title">AtomicLong</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">long</span> p1, p2, p3, p4, p5, p6 = <span class="number">7L</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参考 <a href="https://mechanical-sympathy.blogspot.jp/2011/08/false-sharing-java-7.html" target="_blank" rel="external">False Sharing &amp;&amp; Java 7</a></p>
<p>(3) Java 8 通过声明 <code>sun.misc.Contended</code> 注解加启动参数 <code>-XX:-RestrictContended</code> 来搞定:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ConcurrentMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@sun</span>.misc.Contended</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</div><div class="line">        <span class="keyword">volatile</span> <span class="keyword">long</span> value;</div><div class="line">        CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参考 <a href="http://budairenqin.iteye.com/blog/2048257" target="_blank" rel="external">Java8 中用 <code>sun.misc.Contended</code> 避免伪共享(false sharing)</a></p>
<h3 id="位数"><a href="#位数" class="headerlink" title="位数"></a>位数</h3><p>虽然 32 位使用较小的指针大小可以节约内存，但由于操作系统的<strong>寻址受限</strong>，它在缓冲区大小设置上存在固有的约束，理论上，每个进程在 32 为系统上的最大可用内存为 4GB，实际上在很多系统上这个数值很小。</p>
<h3 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h3><p>关于磁盘，你需要关注<strong>磁盘读延迟</strong> (每次读访问需要多长时间) 和 <strong><code>fsync</code> 延迟</strong> (每个 <code>fsync</code> 耗时多少)，大多数存储引擎是针对硬盘读写优化的，所以不要指望固态硬盘能够出现什么性能上的奇迹。</p>
<hr>
<ul>
<li><code>Hd(0,0)</code> is the <strong>1st</strong> partition of the <strong>1st physical disk</strong>.</li>
<li><code>Hd(0,1)</code> is the <strong>2nd</strong> partition of the <strong>1st physical disk</strong>.</li>
</ul>
<p>I believe that</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sda = hd0, </div><div class="line">sdb = hd1,</div></pre></td></tr></table></figure>
<p>so on etc. etc. <code>sdc = hd2</code> When it says <code>sda1</code> that would be <code>(hd0, 0)</code> and <code>sda2 (hd0, 1)</code> and <code>sda3 (hd0, 2)</code> and <code>sdb1 (hd1, 0)</code> so on and so forth…</p>
<h3 id="Hello-World-的运行过程"><a href="#Hello-World-的运行过程" class="headerlink" title="Hello World 的运行过程"></a><code>Hello World</code> 的运行过程</h3><h3 id="信息的表示和处理"><a href="#信息的表示和处理" class="headerlink" title="信息的表示和处理"></a>信息的表示和处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *byte_pointer;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_bytes</span><span class="params">(byte_pointer start, <span class="keyword">int</span> len)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%.2x"</span>, start[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_int</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">    show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_float</span><span class="params">(<span class="keyword">float</span> x)</span> </span>&#123;</div><div class="line">    show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_pointer</span><span class="params">(<span class="keyword">void</span> *x)</span> </span>&#123;</div><div class="line">    show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong><code>%.2x</code></strong> 表示整数必须用至少两个数字的十六进制格式输出。</li>
</ul>
<hr>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> val = <span class="number">0x87654321</span>;</div><div class="line">byte_pointer = (byte_pointer) &amp;val;</div><div class="line"></div><div class="line">show_bytes(valp, <span class="number">1</span>);</div><div class="line">show_bytes(valp, <span class="number">2</span>);</div><div class="line">show_bytes(valp, <span class="number">3</span>);</div></pre></td></tr></table></figure>
<ul>
<li>小端法: <code>21</code> 大端法: <code>87</code></li>
<li>小端法: <code>21 43</code> 大端法: <code>87 65</code></li>
<li>小端法: <code>21 43 65</code> 大端法: <code>87 65 43</code></li>
<li>小端法: <code>21 43 65 87</code> 大端法: <code>87 65 43 21</code></li>
</ul>
<hr>
<p>整数和浮点数的编码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_show_bytes</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> ival = val;</div><div class="line">    <span class="keyword">float</span> fval = (<span class="keyword">float</span>) val;</div><div class="line">    <span class="keyword">int</span> *pval = &amp;ival;</div><div class="line"></div><div class="line">    show_int(ival);</div><div class="line">    show_float(fval);</div><div class="line">    show_pointer(pval);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    test_show_bytes(<span class="number">12345</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>整数 <code>12345</code> 的编码: <code>39300000</code></li>
<li>浮点数 <code>12345.0</code> 的编码: <code>00e44046</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0011 1001 0011 0000 0000 0000 0000 0000</div><div class="line">0000 0000 1110 0100 0100 0000 0100 0110</div></pre></td></tr></table></figure>
<p>你会发现整数和浮点数有一部分是交叉重复的。</p>
<hr>
<p>位级运算一个常见用法就是实现<strong>掩码</strong>运算，表示从一个字中选出的位的集合。</p>
<ul>
<li><code>0xFF</code> 表示一个字的低位字节</li>
<li><code>x &amp; 0xFF</code> 生成一个由 <code>x</code> 的最低有效字节组成的值，而其他字节置位 <code>0</code></li>
<li><code>~0xFF</code> 表示 <code>8</code> 个最低位为 <code>0</code>，而其余的位都是 <code>1</code></li>
<li><code>~0</code> 生成一个全 <code>1</code> 的掩码，不管机器的字是多少。尽管对于一个 32 位的机器来说，同样的掩码可以写成 <code>0xFFFFFFFF</code>，但是这样的代码是不可移植的。</li>
</ul>
<p>实际中较为常用的几种模式：</p>
<ul>
<li><code>x</code> 的最低有效字节，其他位均置位 <code>0</code>: <code>x &amp;0xFF</code></li>
<li>除了 <code>x</code> 的最低有效字节外，其他的位都取补，最低有效字节保持不变: <code>x ^ ~0xFF</code></li>
<li><code>x</code> 的最低有效字节设置成全 <code>1</code>，其他字节保持变: <code>x | 0xFF</code></li>
</ul>
<hr>
<p>对于 <code>0x87 ([10000111])</code> 来说，不同的移位操作:</p>
<ul>
<li><code>x &lt;&lt; 3</code>: <code>[00111000]</code></li>
<li><code>x &gt;&gt; 2 (逻辑)</code>: <code>[00100001]</code></li>
<li><code>x &gt;&gt; 2 (算术)</code>: <code>[11100001]</code></li>
</ul>
<hr>
<p><strong>反汇编器</strong>是一种将可执行程序文件转换回可读性更好的 <code>ASCII</code> 码形式的程序。这些文件包含许多十六进制数字，<strong>都是用典型的补码形式来表示这些值</strong>。能够认识这些数字并理解它们的意义 (例如，它们是正数还是负数)，是<strong>一项重要的技能</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">8048337: 81 ec b8 01 00 00    sub    $0x1b8,%esp    440</div></pre></td></tr></table></figure>
<p><code>81 ec b8 01 00 00</code> 是一条指令的字节级表示，取出后 4 个字节 <code>b8 01 00 00</code> 按照相反的顺序写出来，我们得到 <code>00 00 01 b8</code>，这就是等价的十进制 <code>440</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">8048343: 8b 85 58 fe ff ff    mov    0xfffffe58(%ebp),%eax   -424</div></pre></td></tr></table></figure>
<p><code>58 fe ff ff</code> 相反顺序: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ff ff fe 58</div><div class="line">// 以二进制表示</div><div class="line">11111111 11111111 11111110 01011000</div><div class="line">// 取反 + 1，这个是正数 424，因此原值为 -424</div><div class="line">00000000 00000000 00000001 10101000</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在无符 word 上进行的，算是逻辑移位</span></div><div class="line"><span class="comment">// 从参数的低 8 位中提取一个值，得到范围 0 ~ 155 之间的一个整数</span></div><div class="line"><span class="comment">// 0x00000076 -&gt; 0x00000076</span></div><div class="line"><span class="comment">// 0x87654321 -&gt; 0x00000021</span></div><div class="line"><span class="comment">// 0x000000C9 -&gt; 0x000000C9</span></div><div class="line"><span class="comment">// 0xEDCBA987 -&gt; 0x00000087</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun1</span><span class="params">(<span class="keyword">unsigned</span> word)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) ((word &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">24</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// word 强制转换为 int</span></div><div class="line"><span class="comment">// 进行算术移位</span></div><div class="line"><span class="comment">// 从这个参数的低 8 位中提取一个值，但是它还要执行符号扩展。结果将是介于 -128 ~ 127 之间的一个数</span></div><div class="line"><span class="comment">// 0x00000076 -&gt; 0x00000076</span></div><div class="line"><span class="comment">// 0x87654321 -&gt; 0x00000021</span></div><div class="line"><span class="comment">// 0x000000C9 -&gt; 0xFFFFFFC9</span></div><div class="line"><span class="comment">// 0xEDCBA987 -&gt; 0xFFFFFF87</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun2</span><span class="params">(<span class="keyword">unsigned</span> word)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ((<span class="keyword">int</span>) word &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">24</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>参数 <code>length</code> 是无符的，计算 <code>0-1</code> 将进行<strong>无符号运算</strong>，这等价于模数加法。结果得到 <code>unsigned max</code>，任何数都是小于或者等于 <code>unsigned max</code> 的，所以这个比较总是真！</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Bug fix (1):</span></div><div class="line"><span class="comment">// float sum_elements(float a[], int length) &#123;&#125;</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Bug fix (2):</span></div><div class="line"><span class="comment">// for (i=0; i&lt;length; i++) &#123;&#125;</span></div><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">sum_elements</span><span class="params">(<span class="keyword">float</span> a[], <span class="keyword">unsigned</span> length)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    </div><div class="line">    <span class="keyword">float</span> result = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;=length - <span class="number">1</span>; i++) &#123;</div><div class="line">        result += a[i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>阅读下面这个小测试:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> length = <span class="number">0</span>;</div><div class="line">    <span class="keyword">unsigned</span> ret = length - <span class="number">1</span>;</div><div class="line">    <span class="comment">// 4294967295</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%u"</span>, ret);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">size_t</span> <span class="built_in">strlen</span>(<span class="keyword">const</span> <span class="keyword">char</span> *s);</div><div class="line"></div><div class="line"><span class="comment">// 当 `s` 比 `t` 短的时候，该函数会不正确的返回 1</span></div><div class="line"><span class="comment">// strlen(s) - strlen(t) 会为负</span></div><div class="line"><span class="comment">// 变成了一个很大的无符号数，且大于 0</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Bug Fix (1):</span></div><div class="line"><span class="comment">// return strlen(s) &gt; strlen(t);</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">strlonger</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">char</span> *t)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">strlen</span>(s) - <span class="built_in">strlen</span>(t) &gt; <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>size_t</code> 在 32 位机器上典型的被定义为 <code>unsigned int</code>，看下面这个示例:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">size_t</span> lenA = <span class="built_in">strlen</span>(<span class="string">"a"</span>);</div><div class="line">    <span class="keyword">size_t</span> lenB = <span class="built_in">strlen</span>(<span class="string">"abcdefg"</span>);</div><div class="line">    <span class="comment">// 18446744073709551610</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%lu"</span>, lenA - lenB);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>%lu</code> for unsigned long</li>
<li><code>%llu</code> for unsigned long long</li>
</ul>
<h3 id="虚拟内存-Virtual-Memory"><a href="#虚拟内存-Virtual-Memory" class="headerlink" title="虚拟内存 Virtual Memory"></a>虚拟内存 Virtual Memory</h3><p>In computing, virtual memory (also virtual storage) is a <strong>memory management technique (内存管理技巧)</strong> that provides an “idealized abstraction of the storage resources that are actually available on a given machine” which <strong>“creates the illusion to users of a very large (main) memory.” (给用户一种我有很大内存的感觉)</strong></p>
<p>Virtual memory combines active RAM and inactive memory on DASD to form a large range of contiguous addresses.</p>
<p><img src="500px-Virtual_memory.svg.png" alt="Virtual_Memory"></p>
<p><strong>Address translation hardware (地址转换硬件)</strong> in the CPU, often referred to as a memory management unit or <strong>MMU</strong>, automatically translates virtual addresses to physical addresses.</p>
<h3 id="Interrupt-中断"><a href="#Interrupt-中断" class="headerlink" title="Interrupt 中断"></a>Interrupt 中断</h3><p>In system programming, an interrupt is a <strong>signal (信号)</strong> to the <strong>processor (处理器)</strong> emitted by <strong>hardware or software (硬件或者软件发出的)</strong> indicating an event that needs <strong>immediate (立即处理)</strong> attention. The processor responds by <strong>suspending (挂起)</strong> its current activities, saving its state, and executing a function called an <strong>interrupt handler (中断回调)</strong> (or an interrupt service routine, ISR) to deal with the event. This interruption is temporary, and, after the interrupt handler finishes, the processor <strong>resumes (恢复)</strong> normal activities.</p>
<p><strong>Types of interrupts:</strong></p>
<p><strong>(1) Level-triggered (电平触发，也被称为条件触发):</strong> A level-triggered interrupt is an interrupt signaled by maintaining the interrupt line at a high or low logic level. 电平触发是在<strong>高或低电平保持的时间</strong>内触发。只要<strong>满足条件</strong>，就触发一个事件(<strong>只要有数据没有被获取，内核就不断通知你</strong>)</p>
<p><strong>(2) Edge-triggered (边沿触发):</strong> An edge-triggered interrupt is an interrupt signalled by a level transition on the interrupt line, either a falling edge (high to low) or a rising edge (low to high). 边沿触发是<strong>由高到低或由低到高这一瞬间触发</strong>。每<strong>当状态变化</strong>时，触发一个事件。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://fuzzyreflection.com/" target="_blank" rel="external">Knowing the hardware</a></li>
<li><a href="https://confluence.csiro.au/display/SC/Multi+CPU+Optimisation" target="_blank" rel="external">Multi CPU Optimisation</a></li>
<li><a href="https://item.jd.com/11741440.html" target="_blank" rel="external">《MySQL 排错指南》</a></li>
<li><a href="https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing" target="_blank" rel="external">HikariCP - About Pool Sizing</a></li>
<li><a href="https://www.amazon.cn/gp/product/B01N03IQK4" target="_blank" rel="external">《深入理解计算机系统》</a></li>
<li><a href="https://www.cnblogs.com/Blub-xinye1/p/5513549.html" target="_blank" rel="external">边沿触发和电平触发的区别</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/06/computer-hardware/" data-id="cjc5qrt18002n5cemj6gq405i" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-ZooKeeper源码分析四" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/01/ZooKeeper源码分析四/" class="article-date">
  <time datetime="2017-06-01T01:59:19.000Z" itemprop="datePublished">2017-06-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/01/ZooKeeper源码分析四/">ZooKeeper源码分析(四) - dataTree</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="ZooKeeper源码分析-四-dataTree"><a href="#ZooKeeper源码分析-四-dataTree" class="headerlink" title="ZooKeeper源码分析(四) - dataTree"></a>ZooKeeper源码分析(四) - dataTree</h2><h3 id="创建-snapshot"><a href="#创建-snapshot" class="headerlink" title="创建 snapshot"></a>创建 <code>snapshot</code></h3><p>我们在运行 <code>ZooKeeperServer</code> 的时候，需要至少传入两个参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2181 /home/zk/Documents/github/zookeeper/zookeeper/datadir</div></pre></td></tr></table></figure>
<p>一个是服务器监听的端口号，另外一个是 <code>ZooKeeperServer</code> 用来存放数据的文件夹 (注意，此文件夹一定要实现创建好，<code>ZooKeeperServer</code> 是不会默认为你创建的)。接下来我们就会对这个文件夹内创建的文件做详细分析。<code>ZooKeeperServer</code> 的 <code>main</code> 方法实例化了 <code>ZooKeeperServer</code> 服务，并调用了自身的 <code>startup</code> 方法来启动服务，在 <code>startup</code> 方法其会尝试进行加载数据:</p>
<p><img src="17-06-01-10_12_19_793_168.png" alt=""></p>
<p>在首次运行 <code>ZooKeeperServer</code> 的时候，这个文件夹是空的，所以位于 <code>loadData()</code> 中的一些代码并不会执行，简而言之，<code>loadData()</code> 首次运行主要是创建了一个文件: <code>snapshot.0</code> ，其中 <code>0</code> 代表的是事务 ID，由于首次事务 ID 从 <code>0</code> 开始，所以第一个运行 <code>ZooKeeperServer</code> 就会创建这个文件。<code>snapshot</code> 方法接着会将这个文件写到文件夹中去:</p>
<p><img src="17-06-01-10_27_40_886_234.png" alt=""></p>
<h3 id="序列化-dataTree-到-snapshot-中"><a href="#序列化-dataTree-到-snapshot-中" class="headerlink" title="序列化 dataTree 到 snapshot 中"></a>序列化 <code>dataTree</code> 到 <code>snapshot</code> 中</h3><p>在关闭 <code>snapshot</code> 的输出流之前，会序列化一些数据到这个文件中去，首先在 <code>snapshot(BinaryOutputArchive oa)</code> 这个方法中会把一些会话超时信息序列化到文件中去，然后接着会调用 <code>dataTree.serialize</code> 方法来序列化整个 <code>dataTree</code> 的信息到这个文件中去:</p>
<p><img src="17-06-01-10_29_25_802_316.png" alt=""></p>
<p><code>serialize</code> 方法，会从空字符串的路径开始序列化整个数据树，并采用深度优先算法依次调用 <code>serializeNode</code> 方法来序列化每一个节点:</p>
<p><img src="17-06-01-10_49_40_664_254.png" alt=""></p>
<p><code>serializeNode</code> 会依次拼接子路径，然后将路径字符串和节点信息一并写到文件中去:</p>
<p><img src="17-06-01-11_12_25_717_529.png" alt=""></p>
<p>在 <code>DataNode</code> 中，会看到每个节点，主要是把 <code>data、acl、stat</code> 这三个信息序列化到文件中去了:</p>
<p><img src="17-06-01-11_00_41_852_381.png" alt=""></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>data</code></td>
<td>每个节点存储的二进制字节数据</td>
</tr>
<tr>
<td><code>acl</code></td>
<td>用于对节点的访问控制</td>
</tr>
<tr>
<td><code>stat</code></td>
<td>每个节点的状态信息</td>
</tr>
</tbody>
</table>
<p><code>Stat</code> 结构中存储并将会序列化的信息如下:</p>
<p><img src="17-06-01-11_19_47_456_212.png" alt=""></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>czxid</code></td>
<td>创建这个节点的事务 ID</td>
</tr>
<tr>
<td><code>mzxid</code></td>
<td>上一次修改这个节点的事务 ID</td>
</tr>
<tr>
<td><code>ctime</code></td>
<td>创建的时间戳</td>
</tr>
<tr>
<td><code>mtime</code></td>
<td>修改的时间戳</td>
</tr>
<tr>
<td><code>version</code></td>
<td>这个节点中的数据变化的次数</td>
</tr>
<tr>
<td><code>cversion</code></td>
<td>这个节点的孩子中的数据变化的次数</td>
</tr>
<tr>
<td><code>aversion</code></td>
<td>这个节点中 ACL 变化的次数</td>
</tr>
<tr>
<td><code>ephemeralOwner</code></td>
<td>临时节点 (如果是) 的会话 ID 的拥有者，如果不是，则默认为 0</td>
</tr>
</tbody>
</table>
<h3 id="当第一次客户端连接"><a href="#当第一次客户端连接" class="headerlink" title="当第一次客户端连接"></a>当第一次客户端连接</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html" target="_blank" rel="external">ZooKeeper Programmer’s Guide</a></li>
<li><a href="https://zookeeper.apache.org/doc/r3.3.2/zookeeperInternals.html" target="_blank" rel="external">ZooKeeper Internals</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/01/ZooKeeper源码分析四/" data-id="cjc5qrsz1001x5cemzkshwfq1" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/blog/page/18/">&laquo; 上一页</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/17/">17</a><a class="page-number" href="/blog/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/blog/page/20/">20</a><a class="page-number" href="/blog/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/23/">23</a><a class="extend next" rel="next" href="/blog/page/20/">下一页&raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    

  
    
  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/01/06/where-the-time-actually-gone/">时间都去哪儿了</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/dev-reflection/">开发反思</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/my-microblog/">我的微博</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/gcc-basic/">gcc-basic</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/java-internal/">Java Internal</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>