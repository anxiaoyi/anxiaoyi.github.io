<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="赵坤的个人网站">
<meta property="og:type" content="website">
<meta property="og:title" content="代码人生">
<meta property="og:url" content="http://blog.kunzhao.org/page/15/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="赵坤的个人网站">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码人生">
<meta name="twitter:description" content="赵坤的个人网站">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Spring五" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/03/Spring五/" class="article-date">
  <time datetime="2017-07-03T14:25:10.000Z" itemprop="datePublished">2017-07-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/03/Spring五/">Spring (五) - 容器的功能扩展</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Spring-五-容器的功能扩展"><a href="#Spring-五-容器的功能扩展" class="headerlink" title="Spring (五) - 容器的功能扩展"></a>Spring (五) - 容器的功能扩展</h2><p>使用 <code>BeanFactory</code> 加载 XML:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">BeanFactory bf = <span class="keyword">new</span> DefaultListableFactory(<span class="keyword">new</span> ClassPathResource(<span class="string">"beanFactoryTest.xml"</span>));</div></pre></td></tr></table></figure>
<p>使用 <code>ApplicationContext</code> 加载 XML:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ApplicationContext bf = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"beanFactoryTest.xml"</span>);</div></pre></td></tr></table></figure>
<p>支持将配置文件路径以数组的方式传入:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ClassPathXmlApplicationContext.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(String configLocation)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    <span class="keyword">this</span>(<span class="keyword">new</span> String[] &#123;configLocation&#125;, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractRefreshableConfigApplicationContext.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfigLocations</span><span class="params">(String... locations)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (locations != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.configLocations = <span class="keyword">new</span> String[locations.length];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; locations.length; i++) &#123;</div><div class="line">            <span class="keyword">this</span>.configLocations[i] = resolvePath(locations[i]).trim();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>设置了路径之后，便可以根据路径做配置文件的解析以及各种功能的实现了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractApplicationContext.java</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</div><div class="line">        <span class="comment">// 对系统属性或者环境变量进行准备及验证</span></div><div class="line">        prepareRefresh();</div><div class="line">        <span class="comment">// 初始化 BeanFactory，并进行 XML 文件读取</span></div><div class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</div><div class="line">        <span class="comment">// 对 BeanFactory 进行各种功能填充</span></div><div class="line">        <span class="comment">// @Qualifier 与 @Autowired 应该是大家非常熟悉的注解</span></div><div class="line">        prepareBeanFactory(beanFactory);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 空实现，方便程序员做进一步业务扩展</span></div><div class="line">            postProcessBeanFactory(beanFactory);</div><div class="line">            <span class="comment">// 激活各种 BeanFactory 处理器</span></div><div class="line">            invokeBeanFactoryPostProcessors(beanFactory);</div><div class="line">            <span class="comment">// 注册拦截 Bean 创建的 Bean 处理器，这里只是注册，真正的调用是在 getBean 的时候</span></div><div class="line">            registerBeanPostProcessors(beanFactory);</div><div class="line">            <span class="comment">// 为上下文初始化 Message 源，即国际化处理</span></div><div class="line">            initMessageSource();</div><div class="line">            <span class="comment">// 初始化应用消息广播器</span></div><div class="line">            initApplicationEventMulticaster();</div><div class="line">            <span class="comment">// 留给子类来初始化其他的 Bean</span></div><div class="line">            onRefresh();</div><div class="line">            <span class="comment">// 在所有注册的 Bean 中查找 Listener Bean，并注册到消息广播中</span></div><div class="line">            registerListeners();</div><div class="line">            <span class="comment">// 初始化剩下的单实例</span></div><div class="line">            finishBeanFactoryInitialization(beanFactory);</div><div class="line">            <span class="comment">// 通知生命周期处理器刷新过程，同时发出事件通知别人</span></div><div class="line">            finishRefresh();</div><div class="line">        &#125; <span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="ApplicationContext.svg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/03/Spring五/" data-id="cjc5qrsy0001l5cemfg58xseo" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-java-basic" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/03/java-basic/" class="article-date">
  <time datetime="2017-07-03T01:58:05.000Z" itemprop="datePublished">2017-07-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/03/java-basic/">Java Basic</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Java-Basic"><a href="#Java-Basic" class="headerlink" title="Java Basic"></a>Java Basic</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository ppa:webupd8team/java</div><div class="line">sudo apt update</div><div class="line">sudo apt install oracle-java8-set-default</div></pre></td></tr></table></figure>
<hr>
<p>手动安装:</p>
<ul>
<li>下载 a <code>.tar.gz</code> from <a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="external">Oracle</a> (here I will be using <code>jdk-8u20-linux-x64.tar.gz</code>);</li>
<li>解压</li>
<li><code>sudo mv /path/to/jdk1.8.0_20 /usr/lib/jvm/oracle_jdk8</code></li>
<li>Before addin this jdk as an alternative, you can see that the new alternative is not listed:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo update-alternatives --query java</div><div class="line">sudo update-alternatives --query javac</div></pre></td></tr></table></figure>
<ul>
<li>Next, add the new jdk alternatives (2000 is the priority and feel free to pick a different number):</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/oracle_jdk8/jre/bin/java 2000</div><div class="line">sudo update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/oracle_jdk8/bin/javac 2000</div></pre></td></tr></table></figure>
<ul>
<li>Now you should see the new jdk listed and you can switch between the alternatives with this command:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo update-alternatives --config java</div><div class="line">sudo update-alternatives --config javac</div></pre></td></tr></table></figure>
<hr>
<p>安装完成后记得，导出 <code>Java</code> 常用命令的路径到环境变量 <code>PATH</code> 中:</p>
<p><img src="2017_09_01_12_19_07.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="string">"/usr/lib/jvm/oracle_jdk8/jdk1.8.0_144/bin"</span></div></pre></td></tr></table></figure>
<ul>
<li>参考: <a href="https://askubuntu.com/questions/521145/how-to-install-oracle-java-on-ubuntu-14-04" target="_blank" rel="external">How to install Oracle Java on Ubuntu 14.04?</a></li>
</ul>
<h3 id="如何获取源代码"><a href="#如何获取源代码" class="headerlink" title="如何获取源代码"></a>如何获取源代码</h3><p><img src="2017_09_03_20_52_31.png" alt=""></p>
<p>然而这部分代码不包含 <code>rt.jar</code> 的源码</p>
<h3 id="Java-Enum"><a href="#Java-Enum" class="headerlink" title="Java Enum"></a>Java Enum</h3><p>(1) Java 枚举内部可以放置静态方法:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public enum JavaBeanAccessor &#123;</div><div class="line"></div><div class="line">    /** Field accessor. */</div><div class="line">    FIELD,</div><div class="line">    /** Method accessor.*/</div><div class="line">    METHO,D</div><div class="line">    /** Method prefer to field. */</div><div class="line">    ALL;</div><div class="line"></div><div class="line">    public static boolean isAccessByMethod(JavaBeanAccessor accessor) &#123;</div><div class="line">        <span class="built_in">return</span> METHOD.equals(accessor) || ALL.equals(accessor);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Java-排序"><a href="#Java-排序" class="headerlink" title="Java 排序"></a>Java 排序</h3><p>关于 <code>Comparable&lt;T&gt;</code> 接口: Returns a <strong>负数, 0, 正数</strong> as this object is <strong>小于, 等于, 大于</strong> the specified object. 默认是按照 Sorts the specified list into <strong>升序</strong>排列:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Collections.sort(appSiteList);</div><div class="line">Collections.reverse(appSiteList);</div></pre></td></tr></table></figure>
<h3 id="Java-Operate-Time"><a href="#Java-Operate-Time" class="headerlink" title="Java Operate Time"></a>Java Operate Time</h3><ul>
<li><a href="https://stackoverflow.com/questions/999172/how-to-parse-a-date" target="_blank" rel="external">How to parse date</a></li>
<li>如何加减时间</li>
</ul>
<hr>
<p><strong>字符串转为 <code>java.util.Date</code> 对象</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">String input = <span class="string">"Thu Jun 18 20:56:02 EDT 2009"</span>;</div><div class="line">SimpleDateFormat parser = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"EEE MMM d HH:mm:ss zzz yyyy"</span>, Locale.ENGLISH);</div><div class="line">Date date = parser.parse(input);</div></pre></td></tr></table></figure>
<hr>
<p><strong>Java 8 字符串转为 <code>java.util.Date</code> 对象</strong>:</p>
<p>If you happen to be on Java 8 already, then use <a href="https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html" target="_blank" rel="external"><code>DateTimeFormatter</code></a> (also here, click the link to see all predefined formatters and available format patterns; <a href="https://docs.oracle.com/javase/tutorial/datetime/iso/format.html" target="_blank" rel="external">the tutorial is available here</a>).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String string = <span class="string">"January 2, 2010"</span>;</div><div class="line">DateTimeFormatter formatter = DateTimeFormatter.ofPattern(<span class="string">"MMMM d, yyyy"</span>, Locale.ENGLISH);</div><div class="line">LocalDate date = LocalDate.parse(string, formatter);</div><div class="line">System.out.println(date); <span class="comment">// 2010-01-02</span></div></pre></td></tr></table></figure>
<p>如何将 <code>LocalDate</code> 转为 <code>Date</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.util.Date date = java.sql.Date.valueOf(localDate);</div></pre></td></tr></table></figure>
<hr>
<p>如何将 <code>java.sql.Time</code> 转为 <code>millseconds</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">time.getTime()</div></pre></td></tr></table></figure>
<hr>
<p>如何 <code>millseconds</code> 创建 <code>java.sql.Time</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Constructs a &lt;code&gt;Time&lt;/code&gt; object using a milliseconds time value.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> time milliseconds since January 1, 1970, 00:00:00 GMT;</span></div><div class="line"><span class="comment"> *             a negative number is milliseconds before</span></div><div class="line"><span class="comment"> *               January 1, 1970, 00:00:00 GMT</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Time</span><span class="params">(<span class="keyword">long</span> time)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(time);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong><code>java.util.Date</code> 对象格式化为字符串</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SimpleDateFormat formatter = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>, Locale.ENGLISH);</div><div class="line">String formattedDate = formatter.format(date);</div></pre></td></tr></table></figure>
<p>Note the importance of explicit <code>Locale</code> argument. If you omit it, then it will use the <a href="http://docs.oracle.com/javase/8/docs/api/java/util/Locale.html#getDefault--" target="_blank" rel="external">default locale</a> which is not necessarily English as used in the month name of the input string. If the locale doesn’t match with the input string, then you would confusingly get a <code>java.text.ParseException</code> even though when the format pattern seems valid.</p>
<hr>
<p><strong>时间戳转为 <code>java.util.Date</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> java.util.Date(System.currentTimeMillis())</div></pre></td></tr></table></figure>
<hr>
<p><strong>时间加减</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LocalDateTime currentTime = LocalDateTime.now(ZoneId.of(<span class="string">"UTC"</span>));</div><div class="line">LocalDateTime nextTime = currentTime.plusHours(<span class="number">12</span>);</div></pre></td></tr></table></figure>
<p>这个构造 <code>LocalDateTime</code> 的时候，必须使用参数 <code>Clock.systemUTC()</code>，否则算出来的时间是错误的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LocalDateTime currentTime = LocalDateTime.now(Clock.systemUTC());</div></pre></td></tr></table></figure>
<p><strong><code>LocalDateTime</code></strong> 转为 <strong><code>java.util.Date</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Instant instant = localDateTime.toInstant(ZoneOffset.UTC);</div><div class="line">Date date = Date.from(instant);</div></pre></td></tr></table></figure>
<p><strong><code>java.util.Date</code></strong> 转为 <strong><code>LocalDateTime</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Instant instant = Instant.ofEpochMilli(date.getTime());</div><div class="line">LocalDateTime ldt = LocalDateTime.ofInstant(instant, ZoneOffset.UTC);</div></pre></td></tr></table></figure>
<hr>
<p><strong>格式化模式</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">Letter  Date or Time Component  Presentation        Examples</div><div class="line">------  ----------------------  ------------------  -------------------------------------</div><div class="line">G       Era designator          Text                AD</div><div class="line">y       Year                    Year                1996; 96</div><div class="line">Y       Week year               Year                2009; 09</div><div class="line">M/L     Month in year           Month               July; Jul; 07</div><div class="line">w       Week in year            Number              27</div><div class="line">W       Week in month           Number              2</div><div class="line">D       Day in year             Number              189</div><div class="line">d       Day in month            Number              10</div><div class="line">F       Day of week in month    Number              2</div><div class="line">E       Day in week             Text                Tuesday; Tue</div><div class="line">u       Day number of week      Number              1</div><div class="line">a       Am/pm marker            Text                PM</div><div class="line">H       Hour in day (0-23)      Number              0</div><div class="line">k       Hour in day (1-24)      Number              24</div><div class="line">K       Hour in am/pm (0-11)    Number              0</div><div class="line">h       Hour in am/pm (1-12)    Number              12</div><div class="line">m       Minute in hour          Number              30</div><div class="line">s       Second in minute        Number              55</div><div class="line">S       Millisecond             Number              978</div><div class="line">z       Time zone               General time zone   Pacific Standard Time; PST; GMT-08:00</div><div class="line">Z       Time zone               RFC 822 time zone   -0800</div><div class="line">X       Time zone               ISO 8601 time zone  -08; -0800; -08:00</div></pre></td></tr></table></figure>
<hr>
<p><code>SimpleDateFormat</code> 示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Input string                            Pattern</div><div class="line">------------------------------------    ----------------------------</div><div class="line">2001.07.04 AD at 12:08:56 PDT           yyyy.MM.dd G &apos;at&apos; HH:mm:ss z</div><div class="line">Wed, Jul 4, &apos;01                         EEE, MMM d, &apos;&apos;yy</div><div class="line">12:08 PM                                h:mm a</div><div class="line">12 o&apos;clock PM, Pacific Daylight Time    hh &apos;o&apos;&apos;clock&apos; a, zzzz</div><div class="line">0:08 PM, PDT                            K:mm a, z</div><div class="line">02001.July.04 AD 12:08 PM               yyyyy.MMMM.dd GGG hh:mm aaa</div><div class="line">Wed, 4 Jul 2001 12:08:56 -0700          EEE, d MMM yyyy HH:mm:ss Z</div><div class="line">010704120856-0700                       yyMMddHHmmssZ</div><div class="line">2001-07-04T12:08:56.235-0700            yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSSZ</div><div class="line">2001-07-04T12:08:56.235-07:00           yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSSXXX</div><div class="line">2001-W27-3                              YYYY-&apos;W&apos;ww-u</div></pre></td></tr></table></figure>
<p>Important note is that <code>SimpleDateFormat</code> is <strong>非线程安全</strong>. In other words, you should <strong>永远不要</strong> declare and assign it as a <strong>静态</strong> or <strong>实例变量</strong> and then reuse from different methods/threads. You should always create it brand new within the method local scope.</p>
<hr>
<p>根据 <a href="https://docs.oracle.com/javase/8/docs/api/java/time/package-summary.html" target="_blank" rel="external">The main API for dates, times, instants, and durations</a>，定义在 <code>java.time</code> 包下面的所有类都是 <strong>immutable and thread-safe</strong> 的。</p>
<hr>
<ul>
<li><strong>格林威治标准时间 <code>GMT</code></strong></li>
</ul>
<p>十七世纪，格林威治皇家天文台为了<strong>海上霸权的扩张计划</strong>而进行天体观测。1675年旧皇家观测所(Old Royal Observatory) 正式成立，到了1884年<strong>决定以通过格林威治的子午线作为划分地球东西两半球的经度零度</strong>。观测所门口墙上有一个标志24小时的时钟，显示当下的时间，对全球而言，<strong>这里所设定的时间是世界时间参考点</strong>，全球都以格林威治的时间作为标准来设定时间，这就是我们耳熟能详的「格林威治标准时间」(Greenwich Mean Time，简称G.M.T.)的由来，标示在手表上，则代表此表具有两地时间功能，也就是同时可以显示原居地和另一个国度的时间。</p>
<ul>
<li><strong>世界协调时间 <code>UTC</code></strong>:</li>
</ul>
<p>多数的两地时间表都以 <code>GMT</code> 来表示，但也有些两地时间表上看不到 <code>GMT</code> 字样，出现的反而是 <code>UTC</code> 这3个英文字母，究竟何谓 <code>UTC</code>？事实上，UTC指的是Coordinated Universal Time－ 世界协调时间（又称世界标准时间、世界统一时间），是经过平均太阳时(以格林威治时间GMT为准)、地轴运动修正后的新时标以及以「秒」为单位的国际原子时所综合精算而成的时间，计算过程相当严谨精密，因此若以「世界标准时间」的角度来说，<strong>UTC比GMT来得更加精准。其误差值必须保持在0.9秒以内</strong>，若大于0.9秒则由位于巴黎的国际地球自转事务中央局发布闰秒，使UTC与地球自转周期一致。所以基本上UTC的本质强调的是比GMT更为精确的世界时间标准，不过对于现行表款来说，GMT与UTC的功能与精确度是没有差别的。</p>
<p>通过下面这样获取的时间比真实的北京时间<strong>慢 8 个小时</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> Date currentTime = <span class="keyword">new</span> Date();</div><div class="line"></div><div class="line"><span class="keyword">final</span> SimpleDateFormat sdf =</div><div class="line">    <span class="keyword">new</span> SimpleDateFormat(<span class="string">"EEE, MMM d, yyyy hh:mm:ss a z"</span>);</div><div class="line"></div><div class="line"><span class="comment">// Give it to me in GMT time.</span></div><div class="line">sdf.setTimeZone(TimeZone.getTimeZone(<span class="string">"GMT"</span>));</div><div class="line">System.out.println(<span class="string">"GMT time: "</span> + sdf.format(currentTime));</div></pre></td></tr></table></figure>
<p><code>GMT</code> 是中央时区,<strong>北京在东8区,相差8个小时</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sdf.setTimeZone(TimeZone.getTimeZone(<span class="string">"GMT+8"</span>));</div></pre></td></tr></table></figure>
<p><code>RocketMQ</code> 的 <code>logback</code> 日志的时间戳配置:</p>
<p><img src="2017_12_18_11_03_58.png" alt=""></p>
<h3 id="Java-正则表达式"><a href="#Java-正则表达式" class="headerlink" title="Java 正则表达式"></a>Java 正则表达式</h3><p><strong>查找并替换</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">String oldSequence = <span class="string">"(?&lt;=[A-Z])(%d)"</span>;</div><div class="line">String newSequence = <span class="string">"新的字符串"</span>;</div><div class="line"></div><div class="line">Pattern pattern = Pattern.compile(oldSequence);</div><div class="line">Matcher matcher = pattern.matcher(input);</div><div class="line"></div><div class="line">StringBuffer sb = <span class="keyword">new</span> StringBuffer(input.length());</div><div class="line"><span class="keyword">while</span> (matcher.find()) &#123;</div><div class="line">    <span class="comment">// (%d) 部分将会被替换，(%d) 前面的部分并不会被替换</span></div><div class="line">    matcher.appendReplacement(sb, Matcher.quoteReplacement(<span class="string">"新的字符串"</span>));</div><div class="line">&#125;</div><div class="line">matcher.appendTail(sb);</div><div class="line"></div><div class="line">System.out.println(sb.toString());</div></pre></td></tr></table></figure>
<hr>
<p>如何找到匹配的字符串:</p>
<p>假设原来的字符串 (即使没有括号) 为: <code>http://down6.apk8.com:8020/qu/星座运程-求签测字[www.apkxyx.com].apk</code>，那么用如下代码运行后:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern ILLEGAL_URL_CHARACTER =</div><div class="line">            Pattern.compile(<span class="string">"[\\u4e00-\\u9fa5|\\[|\\]]+"</span>);</div><div class="line"></div><div class="line"><span class="keyword">while</span> (matcher.find()) &#123;</div><div class="line">    String matched = originDownloadURL.substring(matcher.start(), matcher.end());</div><div class="line">    matcher.appendReplacement(stringBuilder,</div><div class="line">                              Matcher.quoteReplacement(URLEncoder.encode(matched, <span class="string">"UTF-8"</span>)));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>matched</code> 的值依次是:</p>
<ul>
<li><code>星座运程</code></li>
<li><code>求签测字[</code></li>
<li><code>]</code></li>
</ul>
<hr>
<p><a href="http://www.rexegg.com/regex-lookarounds.html" target="_blank" rel="external">Mastering Lookahead and Lookbehind</a></p>
<table>
<thead>
<tr>
<th>Lookaround</th>
<th>Name</th>
<th>What it Does</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>(?=foo)</code></td>
<td>Lookahead</td>
<td>Asserts that <strong>what immediately follows</strong> the current position in the string is foo</td>
</tr>
<tr>
<td><code>(?&lt;=foo)</code></td>
<td>Lookbehind</td>
<td>Asserts that <strong>what immediately precedes</strong> the current position in the string is foo</td>
</tr>
<tr>
<td><code>(?!foo)</code></td>
<td>Negative Lookahead</td>
<td>Asserts that <strong>what immediately follows</strong> the current position in the string <strong>is not</strong> foo</td>
</tr>
<tr>
<td><code>(?&lt;!foo)</code></td>
<td>Negative Lookbehind</td>
<td>Asserts that <strong>what immediately precedes</strong> the current position in the string <strong>is not</strong> foo</td>
</tr>
</tbody>
</table>
<hr>
<p><strong>查找匹配的 Group</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">String line = <span class="string">"This order was placed for QT3000! OK?"</span>;</div><div class="line">Pattern pattern = Pattern.compile(<span class="string">"(.*?)(\\d+)(.*)"</span>);</div><div class="line">Matcher matcher = pattern.matcher(line);</div><div class="line"><span class="keyword">while</span> (matcher.find()) &#123;</div><div class="line">    System.out.println(<span class="string">"group 0: "</span> + matcher.group(<span class="number">0</span>));</div><div class="line">    System.out.println(<span class="string">"group 1: "</span> + matcher.group(<span class="number">1</span>));</div><div class="line">    System.out.println(<span class="string">"group 2: "</span> + matcher.group(<span class="number">2</span>));</div><div class="line">    System.out.println(<span class="string">"group 3: "</span> + matcher.group(<span class="number">3</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">group 0: This order was placed for QT3000! OK?</div><div class="line">group 1: This order was placed for QT</div><div class="line">group 2: 3000</div><div class="line">group 3: ! OK?</div></pre></td></tr></table></figure>
<ul>
<li><strong><code>group(0)</code></strong>: 总是匹配整个正则表达式能覆盖的所有区域</li>
</ul>
<p>Capturing groups are indexed from left to right, <strong>从 1 开始</strong>.  Group zero denotes the entire pattern, so the expression <strong><code>m.group(0)</code></strong> is equivalent to <strong><code>m.group()</code></strong>.</p>
<p>参考: <a href="https://stackoverflow.com/questions/17969436/java-regex-capturing-groups" target="_blank" rel="external">Java Regex Capturing Groups</a></p>
<hr>
<p><strong>Predefined character classes</strong>:</p>
<table>
<thead>
<tr>
<th>正则表达式</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.</code></td>
<td>Any character (may or may not match line terminators)</td>
</tr>
<tr>
<td><code>\d</code></td>
<td>A digit: <code>[0-9]</code></td>
</tr>
<tr>
<td><code>\D</code></td>
<td>A non-digit: <code>[^0-9]</code></td>
</tr>
<tr>
<td><code>\s</code></td>
<td>A whitespace character: <code>[ \t\n\x0B\f\r]</code></td>
</tr>
<tr>
<td><code>\S</code></td>
<td>A non-whitespace character: <code>[^\s]</code></td>
</tr>
<tr>
<td><code>\w</code></td>
<td>A word character: <code>[a-zA-Z_0-9]</code></td>
</tr>
<tr>
<td><code>\W</code></td>
<td>A non-word character: <code>[^\w]</code></td>
</tr>
</tbody>
</table>
<p><strong>Character classes</strong>:</p>
<table>
<thead>
<tr>
<th>正则表达式</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>[abc]</td>
<td>a, b, or c (simple class)</td>
</tr>
<tr>
<td>[\^abc]</td>
<td>除了 a, b, or c 之外的任何字符 (negation)</td>
</tr>
<tr>
<td>[a-zA-Z]</td>
<td>a through z or A through Z, inclusive (range)</td>
</tr>
</tbody>
</table>
<p><strong>Greedy quantifiers</strong>:</p>
<table>
<thead>
<tr>
<th>正则表达式</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>X{n}</td>
<td>X, exactly n times</td>
</tr>
<tr>
<td>X{n,}</td>
<td>X, at least n times</td>
</tr>
<tr>
<td>X{n,m}</td>
<td>X, at least n but not more than m times</td>
</tr>
</tbody>
</table>
<hr>
<p>正则表达式如下这样写，是可以正确匹配的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// N: "http://download.pchome.net/ios/list-377-1-1.html"</span></div><div class="line"><span class="comment">// Y: "http://download.pchome.net/ios/list-957-1-1.html"</span></div><div class="line"><span class="comment">// Y: "http://download.pchome.net/ios/list-956-1-1.html"</span></div><div class="line"><span class="keyword">final</span> String PAGINATION_URL_REGEX = <span class="string">"http://download\\.pchome\\.net/ios/list-(955|956|957)-1-\\d+\\.html"</span>;</div></pre></td></tr></table></figure>
<hr>
<p><strong>贪婪非贪婪 (直接写 <code>.*</code> 的话，就是贪婪匹配)</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">*  - zero or more</div><div class="line">*? - zero or more (non-greedy)</div><div class="line">+  - one or more</div><div class="line">+? - one or more (non-greedy)</div><div class="line">?  - zero or one</div><div class="line">?? - zero or one (non-greedy)</div></pre></td></tr></table></figure>
<hr>
<p><code>\</code> is special character in regex (used for instance to create <code>\d</code> - character class representing digits). To make regex treat <code>\</code> as normal character you need to place <strong>另外一个</strong> <code>\</code> before it to turn off its special meaning (you need to escape it). So regex which we are trying to create is <code>\\</code>.</p>
<p>But to create string representing <code>\\</code> so you could pass it to regex engine you need to write it as <strong>四个 <code>\</code> (“\\“)</strong>, because <code>\</code> is also special character in String (it can be used for instance as <code>\t</code> to represent tabulator) so you also need to escape both <code>\</code> there.</p>
<p>将 <code>http:\/\/chelpus.defcon5.biz\/LuckyPatcher.apk</code> 中的反斜杠替换为空字符串：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">url.replaceAll(<span class="string">"\\\\"</span>, <span class="string">""</span>);</div></pre></td></tr></table></figure>
<p>最终结果为: <code>http://chelpus.defcon5.biz/LuckyPatcher.apk</code></p>
<p>但是如果你 <strong>不想用正则</strong> 替换的话，那么可以写:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"http:\\/\\/chelpus.defcon5.biz\\/LuckyPatcher.apk"</span>.replace(<span class="string">"\\"</span>, <span class="string">""</span>)</div></pre></td></tr></table></figure>
<p>也能达到相同的效果。</p>
<hr>
<p><strong>Java Special MetaCharacters</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;([&#123;\^-=$!|]&#125;)?*+.&gt;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"something"</span>.split(<span class="string">"\""</span>);</div></pre></td></tr></table></figure>
<h3 id="Java-Properties"><a href="#Java-Properties" class="headerlink" title="Java Properties"></a>Java Properties</h3><p><img src="17-08-08-09_57_08_605_310.png" alt=""></p>
<h3 id="indexOf"><a href="#indexOf" class="headerlink" title="indexOf"></a><code>indexOf</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> index = <span class="string">"abcdefghijklmn"</span>.indexOf( <span class="string">"def"</span> );</div></pre></td></tr></table></figure>
<p><strong><code>index</code> 的值是指向的 <code>d</code></strong>，而不是 <code>f</code> 的下标:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">   ↓</div><div class="line">abcdefghijklmn</div></pre></td></tr></table></figure>
<h3 id="Java-异常"><a href="#Java-异常" class="headerlink" title="Java 异常"></a>Java 异常</h3><p><strong>红颜色 are checked exceptions</strong>. Any checked exceptions that may be thrown in a method <strong>must either 被捕获 or declared in the method’s throws clause</strong>. Checked exceptions must be caught <strong>在编译阶段</strong>. Checked exceptions are so called because both the Java compiler and the Java virtual machine check to make sure this rule is obeyed. <strong>绿颜色 are uncheck exceptions</strong>. They are exceptions that are not expected to be recovered, such as null pointer, divide by 0, etc.</p>
<p><img src="Exception-Hierarchy-Diagram.jpeg" alt=""></p>
<p><strong>(1) 空指针异常</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Integer status;</div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> STATUS = <span class="number">1</span>;</div><div class="line"><span class="keyword">if</span> (obj.getStatus() == STATUS) &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这句话当 <code>obj.getStatus()</code> 返回 <code>null</code> 的时候，会<strong>直接抛出空指针异常</strong></p>
<p><strong>(2) Java Doc 注释异常</strong>:</p>
<p><img src="17-07-28-17_05_46_661_130.png" alt=""></p>
<p><code>Maven</code> 或者 <code>Gradle</code> 在编译这样的代码的时候，也<strong>有可能报异常</strong>，因此在 <strong>Refactor</strong> 代码的时候，最好采用 <code>Intellij Idea</code> 编译器本身自带的 <code>Refactor</code> 功能来进行代码的重构与优化，避免出现此类错误。</p>
<p><strong>(3) Java Content-Type 判断错误</strong>:</p>
<p>仅在 <code>Ubuntu</code> 系统下用 <code>Chrome</code> 浏览器上传 APK 文件，然后服务器这边获取到了 <code>APK</code> 文件的 <code>Content-Type</code>，就仅通过下面这句代码来判断是否是 <code>APK</code> 文件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">contentType.equals(<span class="string">"application/vnd.android.package-archive"</span>)</div></pre></td></tr></table></figure>
<p>最终出现的状况就是，在 <code>Windows</code> 和在 <code>Mac</code> 操作系统上，<code>APK</code> 文件都被判断为非 <code>APK</code> 文件了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">isApk = contentType.equals(<span class="string">"application/octet-stream"</span>) ||</div><div class="line">        contentType.equals(<span class="string">"application/vnd.android.package-archive"</span>);</div></pre></td></tr></table></figure>
<p>同样的问题也出现在，做的单页面网站<strong>在 <code>Windows</code> 操作系统下</strong>，使用 <code>IE</code> 内核出现各种意想不到的错误与问题。</p>
<h3 id="Return-from-Finally"><a href="#Return-from-Finally" class="headerlink" title="Return from Finally"></a>Return from Finally</h3><p>下面代码结构的 <code>finally</code> 依然会执行:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Java-较旧的版本安装的问题"><a href="#Java-较旧的版本安装的问题" class="headerlink" title="Java 较旧的版本安装的问题"></a><code>Java</code> 较旧的版本安装的问题</h3><p>下载 <code>Java</code> 较为旧的版本，<a href="http://www.oracle.com/technetwork/java/javasebusiness/downloads/java-archive-downloads-javase5-419410.html" target="_blank" rel="external">官网</a>一般会提供一种叫做 <code>.bin</code> 格式的文件:</p>
<p><img src="2017_08_31_20_46_17.png" alt=""></p>
<p>参考 <a href="http://www.oracle.com/technetwork/java/javase/install-linux-64-self-extracting-142068.html" target="_blank" rel="external">JDK Self-Extracting Installation for Linux (64-bit)</a>，其实这种文件的解压很简单，执行下面这些命令就可以进行解压到旁边的文件夹了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chmod u+x jdk-1_5_0_22-linux-amd64.bin</div><div class="line">./jdk-1_5_0_22-linux-amd64.bin</div></pre></td></tr></table></figure>
<h3 id="自定义-Exception-的写法"><a href="#自定义-Exception-的写法" class="headerlink" title="自定义 Exception 的写法"></a>自定义 <code>Exception</code> 的写法</h3><p>一定要记得定义 <strong><code>serialVersionUID</code></strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQClientException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5758410930844185841L</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> responseCode;</div><div class="line">    <span class="keyword">private</span> String errorMessage;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MQClientException</span><span class="params">(String errorMessage, Throwable cause)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(FAQUrl.attachDefaultURL(errorMessage), cause);</div><div class="line">        <span class="keyword">this</span>.responseCode = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">this</span>.errorMessage = errorMessage;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>为什么一定要定义 <code>serialVersionUID</code>，其实就是因为基类实现了这个接口，<strong>语言就是这么设计的</strong>，作者可能想要能够让这些异常信息在网络上传输:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Throwable</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;&#125;</div></pre></td></tr></table></figure>
<h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p><a href="https://stackoverflow.com/questions/16966629/what-is-the-difference-between-getfields-and-getdeclaredfields-in-java-reflectio" target="_blank" rel="external">https://stackoverflow.com/questions/16966629/what-is-the-difference-between-getfields-and-getdeclaredfields-in-java-reflectio</a></p>
<h3 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h3><p><img src="2017_09_12_09_19_08.png" alt=""></p>
<ul>
<li><code>RetentionPolicy.SOURCE</code>: Discard during the compile. These annotations don’t make any sense after the compile has completed, so they <strong>aren’t written to the bytecode</strong>. Example: <code>@Override</code>, <code>@SuppressWarnings</code></li>
<li><code>RetentionPolicy.CLASS</code>: Discard during class load. Useful when doing bytecode-level post-processing. Somewhat surprisingly, this is the default. Appear in the decompiled class, but can’t be inspected at run-time with reflection with <code>getAnnotations()</code>.</li>
<li><font color="red"><strong><code>RetentionPolicy.RUNTIME</code></strong></font>: Do not discard. The annotation should be available for reflection at runtime. Example: <code>@Deprecated</code>. Appear in the decompiled class, and can be inspected at run-time with reflection with <code>getAnnotations()</code>.</li>
</ul>
<p><strong>Language level</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</div><div class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</div><div class="line"></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</div><div class="line"><span class="meta">@interface</span> RetentionSource &#123;&#125;</div><div class="line"></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="meta">@interface</span> RetentionClass &#123;&#125;</div><div class="line"></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@interface</span> RetentionRuntime &#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    <span class="meta">@RetentionSource</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;&#125;</div><div class="line">    <span class="keyword">assert</span> B.class.getAnnotations().length == <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="meta">@RetentionClass</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;&#125;</div><div class="line">    <span class="keyword">assert</span> C.class.getAnnotations().length == <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="meta">@RetentionRuntime</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;&#125;</div><div class="line">    <span class="keyword">assert</span> D.class.getAnnotations().length == <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Bytecode level</strong>: using <code>javap</code> we observe that the <code>Retention.CLASS</code> annotated class gets a <code>RuntimeInvisible</code> class attribute:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#14 = Utf8               LRetentionClass;</div><div class="line">[...]</div><div class="line">RuntimeInvisibleAnnotations:</div><div class="line">  0: #14()</div></pre></td></tr></table></figure>
<p>while <code>Retention.RUNTIME</code> annotation gets a <code>RuntimeVisible</code> class attribute:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#14 = Utf8               LRetentionRuntime;</div><div class="line">[...]</div><div class="line">RuntimeVisibleAnnotations:</div><div class="line">  0: #14()</div></pre></td></tr></table></figure>
<p>and the <code>Runtime.SOURCE</code> annotated <code>.class</code> does not get any annotation.</p>
<hr>
<p><img src="2017_09_12_09_22_08.png" alt=""></p>
<p>可选 <strong><code>ElementType</code></strong> 类型如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ElementType &#123;</div><div class="line">    <span class="comment">/** Class, interface (including annotation type), or enum declaration */</span></div><div class="line">    TYPE,</div><div class="line"></div><div class="line">    <span class="comment">/** Field declaration (includes enum constants) */</span></div><div class="line">    FIELD,</div><div class="line"></div><div class="line">    <span class="comment">/** Method declaration */</span></div><div class="line">    METHOD,</div><div class="line"></div><div class="line">    <span class="comment">/** Formal parameter declaration */</span></div><div class="line">    PARAMETER,</div><div class="line"></div><div class="line">    <span class="comment">/** Constructor declaration */</span></div><div class="line">    CONSTRUCTOR,</div><div class="line"></div><div class="line">    <span class="comment">/** Local variable declaration */</span></div><div class="line">    LOCAL_VARIABLE,</div><div class="line"></div><div class="line">    <span class="comment">/** Annotation type declaration */</span></div><div class="line">    ANNOTATION_TYPE,</div><div class="line"></div><div class="line">    <span class="comment">/** Package declaration */</span></div><div class="line">    PACKAGE,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Type parameter declaration</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    TYPE_PARAMETER,</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Use of a type</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    TYPE_USE</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="避免无限循环阻塞下面代码的执行"><a href="#避免无限循环阻塞下面代码的执行" class="headerlink" title="避免无限循环阻塞下面代码的执行"></a>避免无限循环阻塞下面代码的执行</h3><p><img src="2017_09_15_11_38_00.png" alt=""></p>
<p>如图，如果 <code>while(true)</code> 直接写在外面，那么下面的的代码不在执行，必须放在一个新的线程中才能执行。</p>
<h3 id="定时提交任务"><a href="#定时提交任务" class="headerlink" title="定时提交任务"></a>定时提交任务</h3><p><img src="2017_09_15_22_27_30.png" alt=""></p>
<h3 id="URI-各部分字段的值"><a href="#URI-各部分字段的值" class="headerlink" title="URI 各部分字段的值"></a>URI 各部分字段的值</h3><p><img src="URI-construct.png" alt=""></p>
<p><img src="2017_11_14_17_10_45.png" alt=""></p>
<h3 id="Java-8"><a href="#Java-8" class="headerlink" title="Java 8"></a>Java 8</h3><p><code>List</code> 中的所有字符串调用 <code>trim</code> 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; appScrenshot = originList.stream().map(String :: trim).collect(Collectors.toList());</div></pre></td></tr></table></figure>
<p>什么叫做 <code>Function Interface</code>:</p>
<p><img src="2017_11_03_17_50_43.png" alt=""></p>
<p>原来的<strong>匿名类</strong>怎么写:</p>
<p><img src="2017_11_03_17_53_09.png" alt=""></p>
<p>匿名类转为<strong>lambda</strong>写法:</p>
<p><img src="2017_11_03_17_53_39.png" alt=""></p>
<p><code>java.util.function</code> 下面为你定义好了一些能够直接使用的 <code>Function Interface</code>，比如上面的接口就可以使用 <code>Predicate</code> 来代替:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Predicate</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">test</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="2017_11_03_18_02_12.png" alt=""></p>
<hr>
<p>接受一个参数，然后在这个参数上执行某些行为最后返回一个 <code>void</code> ，可以使用 <code>Consumer&lt;T&gt;</code> 接口的 <code>accept(T t)</code> 方法:</p>
<p><img src="2017_11_03_18_06_56.png" alt=""></p>
<p><img src="2017_11_03_18_07_32.png" alt=""></p>
<hr>
<p>返回一个参数，可以使用 <code>Function&lt;T, R&gt;</code> 接口提供的 <code>R apply&lt;T t&gt;</code> 方法:</p>
<p><img src="2017_11_03_18_09_31.png" alt=""></p>
<p><img src="2017_11_03_18_10_06.png" alt=""></p>
<hr>
<p><strong>Aggregate Operations</strong>:</p>
<p><img src="2017_11_03_18_12_26.png" alt=""></p>
<p>函数意义:</p>
<p><img src="2017_11_03_20_14_03.png" alt=""></p>
<ul>
<li><a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html#approach1" target="_blank" rel="external">参考</a></li>
</ul>
<hr>
<p><font color="red"><strong>注意:</strong></font> 在 <code>filter</code> 方法中有异常情况的抛出:</p>
<p><img src="2017_11_20_15_07_48.png" alt=""></p>
<p>如果没有 <code>catch</code> 的话，程序会阻塞在这里。</p>
<h3 id="DataOutputStream-vs-ObjectOutputStream"><a href="#DataOutputStream-vs-ObjectOutputStream" class="headerlink" title="DataOutputStream vs ObjectOutputStream"></a><code>DataOutputStream</code> vs <code>ObjectOutputStream</code></h3><p>处理基本类型的时候，这两个没有任何区别。</p>
<p><code>DataOutputStream</code> and <code>ObjectOutputStream</code>: when handling basic types, there is no difference apart from the header that <code>ObjectOutputStream</code> creates.</p>
<p>With the <code>ObjectOutputStream</code> class, instances of a class that implements <code>Serializable</code> can be written to the output stream, and can be read back with <code>ObjectInputStream</code>.</p>
<h3 id="java-sql-Connection"><a href="#java-sql-Connection" class="headerlink" title="java.sql.Connection"></a><code>java.sql.Connection</code></h3><p>在 <code>auto-commit</code> 模式下，执行 <code>rollback()</code> 会抛出 <code>SQLException</code> 异常:</p>
<p><img src="2017_10_12_20_07_40.png" alt=""></p>
<h3 id="读取用户输入"><a href="#读取用户输入" class="headerlink" title="读取用户输入"></a>读取用户输入</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Scanner;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String...args)</span> </span>&#123;</div><div class="line">        Scanner scanner = Scanner(System.in);</div><div class="line">        <span class="keyword">int</span> n = scanner.nextInt();</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ServiceLoader"><a href="#ServiceLoader" class="headerlink" title="ServiceLoader"></a><code>ServiceLoader</code></h3><p>因为其实现了 <code>Iterable</code> 接口:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoader</span>&lt;<span class="title">S</span>&gt;</span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">S</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以我们可<strong>遍历</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">_loadedInitializers = ServiceLoader.load(ServletContainerInitializer.class);</div><div class="line"><span class="keyword">for</span> (ServletContainerInitializer sci:_loadedInitializers) &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="读取配置文件"><a href="#读取配置文件" class="headerlink" title="读取配置文件"></a>读取配置文件</h3><p>从 <code>jar</code> 的<strong>同级目录</strong>读取:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./ - the root of your program</div><div class="line"> |__ main.jar</div><div class="line"> |__ main.properties</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//the base folder is ./, the root of the main.properties file  </span></div><div class="line">String path = <span class="string">"./main.properties"</span>;</div><div class="line"><span class="comment">//load the file handle for main.properties</span></div><div class="line">file = <span class="keyword">new</span> FileInputStream(path);</div></pre></td></tr></table></figure>
<h3 id="Iterable"><a href="#Iterable" class="headerlink" title="Iterable"></a><code>Iterable</code></h3><p><code>ArrayList</code> 实现了 <code>Iterable</code> 接口:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span> <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Itr();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Itr</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * Index of element to be returned by subsequent call to next.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">int</span> cursor = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> cursor != size();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> E <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">int</span> i = cursor;</div><div class="line">                E next = get(i);</div><div class="line">                cursor = i + <span class="number">1</span>;</div><div class="line">                <span class="keyword">return</span> next;</div><div class="line">            &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以可以这样 <code>for-each-loop</code> 遍历:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (E e:list) &#123;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>A class has to implement the <code>Iterable</code> interface if it wants to have a <code>for-each</code> loop to iterate over its collection. However, the for-each loop can only be used to <strong>cycle through</strong> the collection in the forward direction and <strong>不能修改元素</strong> in this collection. But, if all you want is to <strong>读取</strong> the elements data, then it’s very simple and thanks to Java lambda expression it’s often one liner. For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iterableElements.forEach (x -&gt; System.out.println(x) );</div></pre></td></tr></table></figure>
<hr>
<p><strong><code>Iterator</code></strong>:</p>
<p>This interface enables you to iterate over a collection, <strong>获取和删除</strong> its elements. Each of the collection classes provides a <code>iterator()</code> method that returns an iterator to the start of the collection. The advantage of this interface over iterable is that with this interface you can <strong>add, modify or remove</strong> elements in a collection. But, accessing elements needs a little more code than iterable. For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Iterator i = c.iterator(); i.hasNext(); ) &#123;</div><div class="line">    Element e = i.next();    <span class="comment">//Get the element</span></div><div class="line">    System.out.println(e);    <span class="comment">//access or modify the element</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="组合和聚合"><a href="#组合和聚合" class="headerlink" title="组合和聚合"></a>组合和聚合</h3><p>Composition:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Engine engine;</div><div class="line"></div><div class="line">  Car(EngineSpecs specs) &#123;</div><div class="line">    engine = <span class="keyword">new</span> Engine(specs);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">move</span><span class="params">()</span> </span>&#123;</div><div class="line">    engine.work();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Aggregation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Engine engine;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setEngine</span><span class="params">(Engine engine)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.engine = engine;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">move</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>)</div><div class="line">      engine.work();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Both <strong>Composition and Aggregation</strong> are Associations. Composition -&gt; <strong>Strong Has-A</strong> relationship Aggregation -&gt; <strong>Weak Has-A</strong> relationship.</p>
<h3 id="Invalid-signature-file”-when-attempting-to-run-a-jar"><a href="#Invalid-signature-file”-when-attempting-to-run-a-jar" class="headerlink" title="Invalid signature file” when attempting to run a .jar"></a>Invalid signature file” when attempting to run a <code>.jar</code></h3><p>从 <code>jar</code> 包里面删除这 3 个文件即可:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip -d yourjar.jar <span class="string">'META-INF/*.SF'</span> <span class="string">'META-INF/*.RSA'</span> <span class="string">'META-INF/*SF'</span></div></pre></td></tr></table></figure>
<ul>
<li><a href="https://stackoverflow.com/questions/999489/invalid-signature-file-when-attempting-to-run-a-jar" target="_blank" rel="external">参考</a></li>
</ul>
<h3 id="System-getenv-amp-System-getProperty"><a href="#System-getenv-amp-System-getProperty" class="headerlink" title="System.getenv() &amp; System.getProperty()"></a><code>System.getenv()</code> &amp; <code>System.getProperty()</code></h3><p><code>getenv</code> gets an environment variable. <code>getProperty</code> gets a Java property. Environment variables are specified at the OS level. Java properties are specified by passing the <code>-D</code> option to the JVM (and can be set programmatically).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 返回的是 /home/zk</span></div><div class="line">System.getProperty(<span class="string">"user.home"</span>)</div></pre></td></tr></table></figure>
<h3 id="请求网站"><a href="#请求网站" class="headerlink" title="请求网站"></a>请求网站</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getText</span><span class="params">(String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    URL website = <span class="keyword">new</span> URL(url);</div><div class="line">    URLConnection connection = website.openConnection();</div><div class="line">    BufferedReader in = <span class="keyword">new</span> BufferedReader(</div><div class="line">                                           <span class="keyword">new</span> InputStreamReader(</div><div class="line">                                                                 connection.getInputStream()));</div><div class="line"></div><div class="line">    StringBuilder response = <span class="keyword">new</span> StringBuilder();</div><div class="line">    String inputLine;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> ((inputLine = in.readLine()) != <span class="keyword">null</span>)</div><div class="line">        response.append(inputLine);</div><div class="line"></div><div class="line">    in.close();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> response.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>An <code>InetAddress</code> corresponds to the <strong>Network Layer (网络层)</strong> (Layer 3) and is basically an <strong>IP address (IP 地址)</strong>.</p>
<p>A <code>InetSocketAddress</code> corresponds to the <strong>Transport Layer (传输层)</strong> (Layer 4) and consists of an <strong>IP address and a port number</strong>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[] &#123;(<span class="keyword">byte</span>)<span class="number">192</span>,(<span class="keyword">byte</span>)<span class="number">168</span>,(<span class="keyword">byte</span>)<span class="number">1</span>,(<span class="keyword">byte</span>)<span class="number">1</span>&#125;;</div><div class="line">InetAddress add = InetAddress.getByAddress(b);</div><div class="line">add = InetAddress.getByName(<span class="string">"localhost"</span>);</div><div class="line"></div><div class="line">InetSocketAddress addsock = InetSocketAddress.createUnresolved(<span class="string">"localhost"</span>, <span class="number">90</span>);</div></pre></td></tr></table></figure>
<h3 id="Java-安全模型简介"><a href="#Java-安全模型简介" class="headerlink" title="Java 安全模型简介"></a><a href="https://www.ibm.com/developerworks/cn/java/j-lo-javasecurity/" target="_blank" rel="external"><code>Java</code> 安全模型简介</a></h3><p>当前最新的安全机制实现，则引入了<strong>域 (Domain)</strong> 的概念。虚拟机会把所有代码加载到不同的系统域和应用域，系统域部分专门负责与关键资源进行交互，而各个应用域部分则通过系统域的部分代理来对各种需要的资源进行访问。<strong>虚拟机中不同的受保护域 (Protected Domain)，对应不一样的权限 (Permission)</strong>。存在于不同域中的类文件就具有了当前域的全部权限:</p>
<p><img src="image009.gif" alt="最新安全模型"></p>
<p><code>doPrivileged</code> 方法能够<strong>使一段受信任代码获得更大的权限</strong>，甚至比调用它的应用程序还要多，可做到临时访问更多的资源。有时候这是非常必要的，可以应付一些特殊的应用场景。例如，应用程序可能无法直接访问某些系统资源，但这样的应用程序必须得到这些资源才能够完成功能。针对这种情况，<code>Java SDK</code> 给域提供了 <code>doPrivileged</code> 方法，让程序突破当前域权限限制，临时扩大访问权限。</p>
<p>在 <code>Eclipse</code> 开发环境中建立两个不同工程：<code>projectX</code> 和 <code>projectY</code>。我们会给 <code>projectX</code> 工程中的 <code>bin</code> 目录赋予<strong>写文件</strong>的权限，换句话说就是允许所有存在于此目录中的 <code>class</code> 文件可以自由的在 <code>bin</code> 目录中进行<strong>文件写</strong>操作。然后，我们会在 <code>projectY</code> 工程中调用 <code>projectX</code> 工程中的一个文件操作工具类。这个工具类提供两种类型接口，一种是<strong>特权访问方式</strong>，另外一种是普通访问方式。由于在 <code>projectY</code> 工程中的文件是不具备在 <code>projectX</code> 工程中 <code>bin</code> 目录的任何写权限，所以通过三种不同访问方式的调用结果，我们就可以很清楚地了解到 <code>Java</code> 中安全控制该如何使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUtil</span> </span>&#123; </div><div class="line">    <span class="comment">// 工程 A 执行文件的路径 </span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String FOLDER_PATH = <span class="string">"D:\\workspace\\projectX\\bin"</span>; </div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">makeFile</span><span class="params">(String fileName)</span> </span>&#123; </div><div class="line">        <span class="keyword">try</span> &#123; </div><div class="line">            <span class="comment">// 尝试在工程 A 执行文件的路径中创建一个新文件</span></div><div class="line">            File fs = <span class="keyword">new</span> File(FOLDER_PATH + <span class="string">"\\"</span> + fileName); </div><div class="line">            fs.createNewFile(); </div><div class="line">        &#125; <span class="keyword">catch</span> (AccessControlException e) &#123; </div><div class="line">            e.printStackTrace(); </div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123; </div><div class="line">            e.printStackTrace(); </div><div class="line">        &#125; </div><div class="line">    &#125; </div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doPrivilegedAction</span><span class="params">(<span class="keyword">final</span> String fileName)</span> </span>&#123; </div><div class="line">        <span class="comment">// 用特权访问方式创建文件</span></div><div class="line">        AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;String&gt;() &#123; </div><div class="line">                <span class="meta">@Override</span> </div><div class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">run</span><span class="params">()</span> </span>&#123; </div><div class="line">                    makeFile(fileName); </div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>; </div><div class="line">                &#125; </div><div class="line">            &#125;); </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当如果想往 <code>projectX</code> 工程中创建文件的时候，只有调用 <code>doPrivilegedAction</code> 才可以创建成功，其它方法均会报无权限。注意，可能需要提前打开一个开关:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.setSecurityManager(<span class="keyword">new</span> SecurityManager());</div></pre></td></tr></table></figure>
<hr>
<p>什么时候应该使用 <code>doPriveleged</code>:</p>
<p>There are lot of operations in Java that require the <strong>caller domain (域)</strong> to have <strong>certain permissions (权限)</strong> for successful execution of those operations. <code>System.getProperty</code> is one of those operations. <strong>All file related operations (所有文件操作)</strong> also need special permissions. When you use <code>AccessController.doPrivileged</code> to invoke those operations, the operation is executed with all the rights(permissions) of your protection domain. Hence if your code has enough rights only then it could execute those operations.</p>
<hr>
<p>Essentially, <code>AccessController.doPriviledged()</code> is the equivalent of a <code>set-user-id</code> file. It is saying “I hereby request that this method be done with <strong>my privileges (我的权限)</strong>, <strong>even if I was invoked by a method that does not have them (即使调用我的那个方法并没有这样的权限)</strong>.”</p>
<h3 id="JVM-的编码问题"><a href="#JVM-的编码问题" class="headerlink" title="JVM 的编码问题"></a>JVM 的编码问题</h3><p>There are three “default” encodings:</p>
<ul>
<li><code>file.encoding</code>:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.getProperty(<span class="string">"file.encoding"</span>)</div></pre></td></tr></table></figure>
<p>默认值是 <code>UTF-8</code>，可以在启动 JVM 的时候通过指定参数来改变默认值: <code>java -Dfile.encoding=ASCII com.zk.Main</code></p>
<ul>
<li><code>java.nio.Charset</code>:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Charset.defaultCharset()</div></pre></td></tr></table></figure>
<p>默认实现：</p>
<p><img src="2018_01_02_11_31_13.png" alt="defaultCharset"></p>
<ul>
<li>And the encoding of the <code>InputStreamReader</code>:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">InputStreamReader.getEncoding()</div></pre></td></tr></table></figure>
<p>这个方法的默认编码也是用的 <code>Charset.defaultCharset()</code>:</p>
<p><img src="2018_01_02_11_29_20.png" alt="InputStreamReader.getEncoding"></p>
<hr>
<p>以下是一些实验数据:</p>
<table>
<thead>
<tr>
<th>BASH LANG</th>
<th>Dfile.encoding</th>
<th>file.encoding</th>
<th>defaultCharset()</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td><code>ANSI_X3.4-1968</code></td>
<td><code>US-ASCII</code></td>
</tr>
<tr>
<td><code>C</code></td>
<td></td>
<td><code>ANSI_X3.4-1968</code></td>
<td><code>US-ASCII</code></td>
</tr>
<tr>
<td><code>C.UTF-8</code></td>
<td></td>
<td><code>UTF-8</code></td>
<td><code>UTF-8</code></td>
</tr>
<tr>
<td><code>C</code></td>
<td><code>UTF-8</code></td>
<td><code>UTF-8</code></td>
<td><code>UTF-8</code></td>
</tr>
<tr>
<td><code>en_US.utf8</code></td>
<td><code>UTF-8</code></td>
<td><code>UTF-8</code></td>
<td><code>UTF-8</code></td>
</tr>
</tbody>
</table>
<p>使用命令 <code>locale -a</code> 来查看 <code>BASH LANG</code> 环境变量支持设置的值。</p>
<hr>
<p>综上，在不设置 <code>-Dfile.encoding</code> 的情况下，<code>UNIX</code> 的 <code>LANG</code> 环境变量对于 JVM 的编码有着<strong>直接影响</strong>。</p>
<h3 id="Java-Code-Segments"><a href="#Java-Code-Segments" class="headerlink" title="Java Code Segments"></a>Java Code Segments</h3><ul>
<li><a href="http://git.oschina.net/anxiaoyi/code-segments/blob/master/java/ThreadFactoryImpl.java" target="_blank" rel="external"><code>ThreadFactory</code></a></li>
<li><a href="">使用 <code>HttpClient</code> 发起 <code>POST</code> 请求</a></li>
<li><a href="http://git.oschina.net/anxiaoyi/code-segments/blob/master/java/ClassLoaderWrapper.java" target="_blank" rel="external"><code>getResourceAsURL</code> 或 <code>getResourceAsStream</code></a></li>
<li><a href="http://git.oschina.net/anxiaoyi/code-segments/blob/master/java/Reflector.java" target="_blank" rel="external">反射一个类的所有信息</a></li>
<li><a href="http://git.oschina.net/anxiaoyi/code-segments/blob/master/java/HttpClientExample.java" target="_blank" rel="external"><code>HttpClient</code> 构建 <code>URI</code></a></li>
<li><a href="http://git.oschina.net/anxiaoyi/code-segments/blob/master/java/AlibabaJSON.java" target="_blank" rel="external">阿里巴巴 <code>JSON</code> 使用</a></li>
<li><a href="http://git.oschina.net/anxiaoyi/code-segments/blob/master/java/ByteBufferInputStream.java" target="_blank" rel="external"><code>ByteBufferInputStream</code></a></li>
<li><a href="http://git.oschina.net/anxiaoyi/code-segments/blob/master/java/ByteBufferOutputStream.java" target="_blank" rel="external"><code>ByteBufferOutputStream</code></a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/03/java-basic/" data-id="cjc5qrt1w003s5cemo0qqpvwb" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Spring四" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/30/Spring四/" class="article-date">
  <time datetime="2017-06-30T03:42:14.000Z" itemprop="datePublished">2017-06-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/30/Spring四/">Spring (四) - Bean 的加载</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Spring-四-Bean-的加载"><a href="#Spring-四-Bean-的加载" class="headerlink" title="Spring (四) - Bean 的加载"></a>Spring (四) - Bean 的加载</h2><p><img src="BeanFactory.svg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    <span class="keyword">return</span> doGetBean(name, requiredType, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>doGetBean</code> 的整体框架:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Object[] args,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> typeCheckOnly)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> String beanName = transformedBeanName(name);</div><div class="line">    Object bean;</div><div class="line"></div><div class="line">    <span class="comment">// 如果缓存里面有单例</span></div><div class="line">    Object sharedInstance = getSingleton(beanName);</div><div class="line">    <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</div><div class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Check if bean definition exists in this factory.</span></div><div class="line">        BeanFactory parentBeanFactory = getParentBeanFactory();</div><div class="line">        <span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</div><div class="line">            <span class="comment">// 从父 BeanFactory 中加载</span></div><div class="line">            <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 缓存里面没有，创建一个单例</span></div><div class="line">        <span class="keyword">if</span> (mbd.isSingleton()) &#123;</div><div class="line">            sharedInstance = getSingleton(beanName,</div><div class="line">                                          <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;&#125;);</div><div class="line">            bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</div><div class="line">            bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">            bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Check if required type matches the type of the actual bean instance.</span></div><div class="line">    <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span> &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) &#123;</div><div class="line">        <span class="keyword">return</span> getTypeConverter().convertIfNecessary(bean, requiredType);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (T) bean;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面我们就一步一步地看一下 <code>doGetBean</code> 方法做的事情:</p>
<h3 id="转换-BeanName"><a href="#转换-BeanName" class="headerlink" title="转换 BeanName:"></a>转换 <code>BeanName</code>:</h3><p>去除 <code>FactoryBean</code> 的修饰符，取指定 alias 所表示的最终 beanName。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"><span class="keyword">final</span> String beanName = transformedBeanName(name);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Return the bean name, stripping out the factory dereference prefix if necessary,</span></div><div class="line"><span class="comment"> * and resolving aliases to canonical names.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">transformedBeanName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> canonicalName(BeanFactoryUtils.transformedBeanName(name));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="尝试加载单例"><a href="#尝试加载单例" class="headerlink" title="尝试加载单例:"></a>尝试加载单例:</h3><h4 id="从缓存中查找加载单例"><a href="#从缓存中查找加载单例" class="headerlink" title="从缓存中查找加载单例"></a>从缓存中查找加载单例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="comment">// Eagerly check singleton cache for manually registered singletons.</span></div><div class="line">Object sharedInstance = getSingleton(beanName);</div></pre></td></tr></table></figure>
<p><code>getSingleton</code> 方法的实现位于父类 <code>DefaultSingletonBeanRegistry</code> 中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultSingletonBeanRegistry.java</span></div><div class="line"></div><div class="line"><span class="comment">/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</div><div class="line"></div><div class="line"><span class="comment">/** Cache of early singleton objects: bean name --&gt; bean instance */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</div><div class="line"></div><div class="line"><span class="comment">/** Cache of singleton objects: bean name --&gt; bean instance */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</div><div class="line"></div><div class="line"><span class="comment">// Return the (raw) singleton object registered under the given name.</span></div><div class="line"><span class="comment">// Checks already instantiated singletons and also allows for an early</span></div><div class="line"><span class="comment">// reference to a currently created singleton (resolving a circular reference).</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</div><div class="line">    Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</div><div class="line">    <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</div><div class="line">            singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</div><div class="line">            <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</div><div class="line">                ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</div><div class="line">                <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</div><div class="line">                    singletonObject = singletonFactory.getObject();</div><div class="line">                    <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</div><div class="line">                    <span class="keyword">this</span>.singletonFactories.remove(beanName);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="缓存中没有，从头开始-bean-的加载过程"><a href="#缓存中没有，从头开始-bean-的加载过程" class="headerlink" title="缓存中没有，从头开始 bean 的加载过程"></a>缓存中没有，从头开始 <code>bean</code> 的加载过程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultSingletonBeanRegistry.java</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</div><div class="line">        Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</div><div class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 记录加载状态，，以便对循环依赖进行检测</span></div><div class="line">            beforeSingletonCreation(beanName);</div><div class="line">            singletonObject = singletonFactory.getObject();</div><div class="line">            <span class="comment">// 移除加载状态</span></div><div class="line">            afterSingletonCreation(beanName);</div><div class="line">            addSingleton(beanName, singletonObject);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>AbstractBeanFactory</code> 调用 <code>getSingleton</code> 方法的时候，传递了 <code>ObjectFactory</code> 对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(<span class="keyword">final</span> String name,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> Object[] args,</span></span></div><div class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> typeCheckOnly)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">    sharedInstance = getSingleton(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">                <span class="keyword">return</span> createBean(beanName, mbd, args);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="准备创建-Bean"><a href="#准备创建-Bean" class="headerlink" title="准备创建 Bean"></a>准备创建 Bean</h3><p><code>createBean</code> 实际上是由子类 <code>AbstractAutowireCapableBeanFactory</code> 实现的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> <span class="keyword">throws</span> BeanCreationException</span>;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutowireCapableBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> <span class="keyword">throws</span> BeanCreationException </span>&#123;</div><div class="line"></div><div class="line">    RootBeanDefinition mbdToUse = mbd;</div><div class="line"></div><div class="line">    <span class="comment">// Make sure bean class is actually resolved at this point, and</span></div><div class="line">    <span class="comment">// clone the bean definition in case of a dynamically resolved Class</span></div><div class="line">    <span class="comment">// which cannot be stored in the shared merged bean definition.</span></div><div class="line">    Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</div><div class="line">    <span class="keyword">if</span> (resolvedClass != <span class="keyword">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="keyword">null</span>) &#123;</div><div class="line">        mbdToUse = <span class="keyword">new</span> RootBeanDefinition(mbd);</div><div class="line">        mbdToUse.setBeanClass(resolvedClass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Prepare method overrides.</span></div><div class="line">    mbdToUse.prepareMethodOverrides();</div><div class="line"></div><div class="line">    <span class="comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span></div><div class="line">    Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</div><div class="line">    <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> bean;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Object beanInstance = doCreateBean(beanName, mbdToUse, args);</div><div class="line">    <span class="keyword">return</span> beanInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="从-bean-的实例中获取对象"><a href="#从-bean-的实例中获取对象" class="headerlink" title="从 bean 的实例中获取对象"></a>从 bean 的实例中获取对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line">bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</div><div class="line"></div><div class="line"><span class="comment">// Get the object for the given bean instance, either the bean</span></div><div class="line"><span class="comment">// instance itself or its created object in case of a FactoryBean.</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectForBeanInstance</span><span class="params">(Object beanInstance,</span></span></div><div class="line"><span class="function"><span class="params">                                          String name,</span></span></div><div class="line"><span class="function"><span class="params">                                          String beanName,</span></span></div><div class="line"><span class="function"><span class="params">                                          RootBeanDefinition mbd)</span> </span>&#123;</div><div class="line">    <span class="comment">// 核心代码委托给了 getObjectFromFactoryBean</span></div><div class="line">    Object object = getObjectFromFactoryBean(factory, beanName, !synthetic);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// FactoryBeanRegistrySupport.java</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getObjectFromFactoryBean</span><span class="params">(FactoryBean&lt;?&gt; factory, String beanName, <span class="keyword">boolean</span> shouldPostProcess)</span> </span>&#123;</div><div class="line">    <span class="comment">// 如果是单例 ...</span></div><div class="line">    <span class="keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        object = doGetObjectFromFactoryBean(factory, beanName);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        Object object = doGetObjectFromFactoryBean(factory, beanName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (object != <span class="keyword">null</span> &amp;&amp; shouldPostProcess) &#123;</div><div class="line">        <span class="comment">// 后处理器</span></div><div class="line">        object = postProcessObjectFromFactoryBean(object, beanName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> object;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// FactoryBeanRegistrySupport.java</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">doGetObjectFromFactoryBean</span><span class="params">(<span class="keyword">final</span> FactoryBean&lt;?&gt; factory, <span class="keyword">final</span> String beanName)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeanCreationException </span>&#123;</div><div class="line">    <span class="comment">// 核心代码</span></div><div class="line">    Object object = factory.getObject();</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">return</span> object;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="原型模式的循环依赖检查"><a href="#原型模式的循环依赖检查" class="headerlink" title="原型模式的循环依赖检查"></a>原型模式的循环依赖检查</h3><p>只有在单例情况下才会尝试解决循环依赖。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="comment">/** Names of beans that are currently in creation */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Object&gt; prototypesCurrentlyInCreation =</div><div class="line">    <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Prototype beans currently in creation"</span>);</div><div class="line"></div><div class="line"><span class="comment">// Fail if we're already creating this bean instance:</span></div><div class="line"><span class="comment">// We're assumably within a circular reference.</span></div><div class="line"><span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isPrototypeCurrentlyInCreation</span><span class="params">(String beanName)</span> </span>&#123;</div><div class="line">    Object curVal = <span class="keyword">this</span>.prototypesCurrentlyInCreation.get();</div><div class="line">    <span class="keyword">return</span> (curVal != <span class="keyword">null</span> &amp;&amp;</div><div class="line">            (curVal.equals(beanName) || (curVal <span class="keyword">instanceof</span> Set &amp;&amp; ((Set&lt;?&gt;) curVal).contains(beanName))));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="构造器循环依赖"><a href="#构造器循环依赖" class="headerlink" title="构造器循环依赖"></a>构造器循环依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"A"</span> <span class="attr">class</span>=<span class="string">"com.zk.A"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"B"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"B"</span> <span class="attr">class</span>=<span class="string">"com.zk.B"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"C"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"C"</span> <span class="attr">class</span>=<span class="string">"com.zk.C"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"A"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>无法解决，只能抛出 <code>BeanCurrentlyInCreationException</code> 异常</p>
<h4 id="setter-循环依赖"><a href="#setter-循环依赖" class="headerlink" title="setter 循环依赖"></a><code>setter</code> 循环依赖</h4><p>Spring 容器提前暴露刚刚完成构造器注入，但是还未完成其他步骤 (如 setter 注入) 的 bean 来完成的，而且只能解决单例作用域的 bean 循环依赖:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutowireCapableBeanFactory.java</span></div><div class="line">addSingletonFactory(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">            <span class="keyword">return</span> getEarlyBeanReference(beanName, mbd, bean);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<h4 id="prototype-范围的依赖处理"><a href="#prototype-范围的依赖处理" class="headerlink" title="prototype 范围的依赖处理"></a>prototype 范围的依赖处理</h4><p>Spring 容器无法完成依赖注入，因为 Spring 容器不进行缓存 prototype 作用域的 bean，因此无法提前暴露一个创建中的 <code>bean</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"A"</span> <span class="attr">class</span>=<span class="string">"com.zk.A"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"B"</span> <span class="attr">ref</span>=<span class="string">"B"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"B"</span> <span class="attr">class</span>=<span class="string">"com.zk.B"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"C"</span> <span class="attr">ref</span>=<span class="string">"C"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"C"</span> <span class="attr">class</span>=<span class="string">"com.zk.C"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"A"</span> <span class="attr">ref</span>=<span class="string">"A"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="常规-bean-的创建"><a href="#常规-bean-的创建" class="headerlink" title="常规 bean 的创建"></a>常规 bean 的创建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractAutowireCapableBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> Object[] args)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> BeanCreationException </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 实例化 Bean</span></div><div class="line">    BeanWrapper instanceWrapper = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</div><div class="line">        instanceWrapper = createBeanInstance(beanName, mbd, args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></div><div class="line">    <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></div><div class="line">    <span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</div><div class="line">                                      isSingletonCurrentlyInCreation(beanName));</div><div class="line">    <span class="keyword">if</span> (earlySingletonExposure) &#123;</div><div class="line">        <span class="comment">// 记录创建 Bean 的 ObjectFactory</span></div><div class="line">        addSingletonFactory(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">					<span class="keyword">return</span> getEarlyBeanReference(beanName, mbd, bean);</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize the bean instance.</span></div><div class="line">    Object exposedObject = bean;</div><div class="line">    <span class="comment">// 属性注入</span></div><div class="line">    populateBean(beanName, mbd, instanceWrapper);</div><div class="line">    <span class="keyword">if</span> (exposedObject != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 调用初始化方法</span></div><div class="line">        exposedObject = initializeBean(beanName, exposedObject, mbd);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 用于销毁方法</span></div><div class="line">    registerDisposableBeanIfNecessary(beanName, bean, mbd);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> exposedObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(5) 检测 parentBeanFactory</p>
<p>如果缓存没有数据，即当前 XML 配置文件找不到 <code>beanName</code> 所对应的配置，就直接转到父类工厂方法去尝试加载了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="comment">// Check if bean definition exists in this factory.</span></div><div class="line">BeanFactory parentBeanFactory = getParentBeanFactory();</div><div class="line"><span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</div><div class="line">    <span class="comment">// Not found -&gt; check parent.</span></div><div class="line">    String nameToLookup = originalBeanName(name);</div><div class="line">    <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// Delegation to parent with explicit args.</span></div><div class="line">        <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// No args -&gt; delegate to standard getBean method.</span></div><div class="line">        <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(6) 将存储 XML 配置文件的 <code>GenericBeanDefinition</code> 转换为 <code>RootBeanDefinition</code></p>
<p>所有 <code>Bean</code> 的后续处理都是针对于 <code>RootBeanDefinition</code> 的，所以这里需要做一个转换，转换的同时，如果父类不为空的话，则会一并合并父类的属性:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</div></pre></td></tr></table></figure>
<p>(7) 寻找依赖</p>
<p><code>Bean</code> 的初始化过程可能会用到其他配置的 <code>Bean</code>，那么这个时候就需要先加载依赖的 <code>Bean</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractBeanFactory.java</span></div><div class="line"></div><div class="line"><span class="comment">// Guarantee initialization of beans that the current bean depends on.</span></div><div class="line">String[] dependsOn = mbd.getDependsOn();</div><div class="line"><span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">for</span> (String dep : dependsOn) &#123;</div><div class="line">        <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</div><div class="line">                                            <span class="string">"Circular depends-on relationship between '"</span> + beanName + <span class="string">"' and '"</span> + dep + <span class="string">"'"</span>);</div><div class="line">        &#125;</div><div class="line">        registerDependentBean(dep, beanName);</div><div class="line">        getBean(dep);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(8) 针对不同的 <code>scope</code> ，进行 <code>Bean</code> 的创建:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create bean instance.</span></div><div class="line"><span class="keyword">if</span> (mbd.isSingleton()) &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    String scopeName = mbd.getScope();</div><div class="line">    <span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(9) 类型转换</p>
<p>程序到这里返回 <code>Bean</code> 后就已经基本结束了，通常对该方法调用 <code>requiredType</code> 是空的，当然也有可能存在返回的 <code>Bean</code> 是一个 <code>String</code>，但是 <code>requiredType</code> 却传入 <code>Integer</code> 类型，那么就会尝试进行类型转换，Spring 提供了各种各样的类型转换器，用户也可以扩展类型转换器来满足需求:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Check if required type matches the type of the actual bean instance.</span></div><div class="line"><span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span> &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) &#123;</div><div class="line">    <span class="keyword">return</span> getTypeConverter().convertIfNecessary(bean, requiredType);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.iflym.com/index.php/code/201208280001.html" target="_blank" rel="external">Spring中循环引用的处理-1</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/30/Spring四/" data-id="cjc5qrsy7001n5cemluoesvs5" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Spring三" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/29/Spring三/" class="article-date">
  <time datetime="2017-06-29T07:18:03.000Z" itemprop="datePublished">2017-06-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/29/Spring三/">Spring (三) - 自定义标签的解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Spring-三-自定义标签的解析"><a href="#Spring-三-自定义标签的解析" class="headerlink" title="Spring (三) - 自定义标签的解析"></a>Spring (三) - 自定义标签的解析</h2><p>在 <a href="/2017/06/27/Spring一/" title="Spring (一) - XML 文件解析与 Bean 的注册">Spring (一) - XML 文件解析与 Bean 的注册</a> 中，我们在最后讲到 <code>Spring</code> 中存在默认标签和自定义标签两种标签，在 上一节 <a href="/2017/06/27/Spring一/" title="Spring (一) - XML 文件解析与 Bean 的注册">Spring (一) - XML 文件解析与 Bean 的注册</a> 中，我们分析了 <code>Spring</code> 对默认标签是如何解析的进行了分析，那么在这一节中我们将会着重讲述如何对自定义标签进行解析。</p>
<h3 id="1-自定义标签使用"><a href="#1-自定义标签使用" class="headerlink" title="1. 自定义标签使用"></a>1. 自定义标签使用</h3><p>这里以 <a href="https://github.com/weibocom/motan" target="_blank" rel="external">Motan</a> 为例来讲解。</p>
<h4 id="1-1-定义-XSD-文件"><a href="#1-1-定义-XSD-文件" class="headerlink" title="1.1 定义 XSD 文件"></a>1.1 定义 XSD 文件</h4><p>定义一个 XSD 文件描述组件内容:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- resources/META-INF/motan.xsd --&gt;</span></div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns</span>=<span class="string">"http://api.weibo.com/schema/motan"</span></span></div><div class="line"><span class="tag">	        <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> </span></div><div class="line"><span class="tag">	        <span class="attr">targetNamespace</span>=<span class="string">"http://api.weibo.com/schema/motan"</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"method"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> <span class="attr">use</span>=<span class="string">"required"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">xsd:annotation</span>&gt;</span></div><div class="line">		  <span class="tag">&lt;<span class="name">xsd:documentation</span>&gt;</span>&lt;![CDATA[ The method name (method.toString()). ]]&gt;<span class="tag">&lt;/<span class="name">xsd:documentation</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">xsd:annotation</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">xsd:attribute</span>&gt;</span></div><div class="line"></div><div class="line">      <span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"requestTimeout"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> <span class="attr">use</span>=<span class="string">"optional"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">xsd:annotation</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">xsd:documentation</span>&gt;</span>&lt;![CDATA[ The method invoke timeout. ]]&gt;<span class="tag">&lt;/<span class="name">xsd:documentation</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">xsd:annotation</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">xsd:attribute</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></div><div class="line">  </div><div class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>声明命名空间</strong>:</p>
<p><img src="17-06-29-16_44_58_751_144.png" alt=""></p>
<p><strong>定义复合元素</strong>:</p>
<p><img src="17-06-29-16_56_12_518_162.png" alt=""></p>
<p><strong>定义元素属性</strong>:</p>
<p><img src="17-06-29-17_01_04_1035_167.png" alt=""></p>
<p><strong>CDATA</strong>:</p>
<p>A CDATA section is a section of element content that is <strong>marked for the parser to interpret as only character data</strong>, not markup.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">item</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title of Feed Item<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">link</span>&gt;</span>/mylink/article1<span class="tag">&lt;/<span class="name">link</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">    &lt;![CDATA[</div><div class="line">      &lt;p&gt;</div><div class="line">      &lt;a href="/mylink/article1"&gt;&lt;img style="float: left; margin-right: 5px;" height="80" src="/mylink/image" alt=""/&gt;&lt;/a&gt;</div><div class="line">      Author Names</div><div class="line">      &lt;br/&gt;&lt;em&gt;Date&lt;/em&gt;</div><div class="line">      &lt;br/&gt;Paragraph of text describing the article to be displayed&lt;/p&gt;</div><div class="line">    ]]&gt;</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">item</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="1-2-创建一个类实现-BeanDefinitionParser-接口"><a href="#1-2-创建一个类实现-BeanDefinitionParser-接口" class="headerlink" title="1.2 创建一个类实现 BeanDefinitionParser 接口:"></a>1.2 创建一个类实现 <code>BeanDefinitionParser</code> 接口:</h4><p>类 <code>MotanBeanDefinitionParser</code> 用来解析 XSD 文件中的定义和组件定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MotanBeanDefinitionParser</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionParser</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-3-创建一个类实现-NamespaceHandlerSupport-接口"><a href="#1-3-创建一个类实现-NamespaceHandlerSupport-接口" class="headerlink" title="1.3 创建一个类实现 NamespaceHandlerSupport 接口:"></a>1.3 创建一个类实现 <code>NamespaceHandlerSupport</code> 接口:</h4><p><code>MotanNamespaceHandler</code> 负责将组件注册到 <code>Spring</code> 容器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MotanNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        registerBeanDefinitionParser(<span class="string">"service"</span>, <span class="keyword">new</span> MotanBeanDefinitionParser(ServiceConfigBean.class, <span class="keyword">true</span>));</div><div class="line">        Initializable initialization = InitializationFactory.getInitialization();</div><div class="line">        initialization.init();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-4-编写-spring-handlers-和-spring-schemas-文件"><a href="#1-4-编写-spring-handlers-和-spring-schemas-文件" class="headerlink" title="1.4 编写 spring.handlers 和 spring.schemas 文件:"></a>1.4 编写 <code>spring.handlers</code> 和 <code>spring.schemas</code> 文件:</h4><p>文件 <code>resources/META-INF/spring.handlers</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://api.weibo.com/schema/motan=com.weibo.api.motan.config.springsupport.MotanNamespaceHandler</div></pre></td></tr></table></figure>
<p>文件 <code>resources/META-INF/spring.schemas</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://api.weibo.com/schema/motan.xsd=META-INF/motan.xsd</div></pre></td></tr></table></figure>
<h4 id="1-5-使用自定义标签"><a href="#1-5-使用自定义标签" class="headerlink" title="1.5 使用自定义标签"></a>1.5 使用自定义标签</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></div><div class="line"><span class="tag">	<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></div><div class="line"><span class="tag">	<span class="attr">xmlns:lang</span>=<span class="string">"http://www.springframework.org/schema/lang"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></div><div class="line"><span class="tag">	<span class="attr">xmlns:motan</span>=<span class="string">"http://api.weibo.com/schema/motan"</span> <span class="attr">xmlns:weibo</span>=<span class="string">"http://api.weibo.com/schema/weibo"</span></span></div><div class="line"><span class="tag">	<span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></span></div><div class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></div><div class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd</span></span></div><div class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd</span></span></div><div class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd</span></span></div><div class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang-2.5.xsd</span></span></div><div class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd</span></span></div><div class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.5.xsd </span></span></div><div class="line"><span class="tag"><span class="string">       http://api.weibo.com/schema/weibo http://api.weibo.com/schema/weibo.xsd</span></span></div><div class="line"><span class="tag"><span class="string">       http://api.weibo.com/schema/motan http://api.weibo.com/schema/motan.xsd "</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">motan:referer</span> <span class="attr">id</span>=<span class="string">"clientDirectTest"</span> <span class="attr">registry</span>=<span class="string">"mockRegistry"</span> <span class="attr">directUrl</span>=<span class="string">"127.0.0.1:7888"</span></span></div><div class="line"><span class="tag">		<span class="attr">interface</span>=<span class="string">"com.weibo.api.motan.config.springsupport.ITest"</span> <span class="attr">protocol</span>=<span class="string">"motan"</span></span></div><div class="line"><span class="tag">		<span class="attr">application</span>=<span class="string">"test1"</span> <span class="attr">module</span>=<span class="string">"test1"</span> /&gt;</span></div><div class="line">  </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="2-自定义标签解析"><a href="#2-自定义标签解析" class="headerlink" title="2 自定义标签解析"></a>2 自定义标签解析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BeanDefinitionParserDelegate.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele, BeanDefinition containingBd)</span> </span>&#123;</div><div class="line">    String namespaceUri = getNamespaceURI(ele);</div><div class="line">    NamespaceHandler handler = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</div><div class="line">    <span class="keyword">return</span> handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-1-获取标签的命名空间"><a href="#2-1-获取标签的命名空间" class="headerlink" title="2.1 获取标签的命名空间"></a>2.1 获取标签的命名空间</h4><p><code>org.w3c.dom.Node</code> 提供了方法可以直接获取元素的命名空间:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BeanDefinitionParserDelegate.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getNamespaceURI</span><span class="params">(Node node)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> node.getNamespaceURI();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-提取自定义标签处理器"><a href="#2-2-提取自定义标签处理器" class="headerlink" title="2.2 提取自定义标签处理器"></a>2.2 提取自定义标签处理器</h4><p>默认的 <code>NamespaceHandlerResolver</code> 是在类 <code>XmlBeanDefinitionReader</code> 创建 <code>XmlReaderContext</code> 中初始化的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// XmlBeanDefinitionReader.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> NamespaceHandlerResolver <span class="title">createDefaultNamespaceHandlerResolver</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultNamespaceHandlerResolver(getResourceLoader().getClassLoader());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以 <code>resolve</code> 方法应该是在 <code>DefaultNamespaceHandlerResolver</code> 中实现的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultNamespaceHandlerResolver.java</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> NamespaceHandler <span class="title">resolve</span><span class="params">(String namespaceUri)</span> </span>&#123;</div><div class="line">    Map&lt;String, Object&gt; handlerMappings = getHandlerMappings();</div><div class="line">    Object handlerOrClassName = handlerMappings.get(namespaceUri);</div><div class="line">    <span class="keyword">if</span> (handlerOrClassName == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (handlerOrClassName <span class="keyword">instanceof</span> NamespaceHandler) &#123;</div><div class="line">        <span class="keyword">return</span> (NamespaceHandler) handlerOrClassName;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        String className = (String) handlerOrClassName;</div><div class="line">        Class&lt;?&gt; handlerClass = ClassUtils.forName(className, <span class="keyword">this</span>.classLoader);</div><div class="line">        NamespaceHandler namespaceHandler = (NamespaceHandler) BeanUtils.instantiateClass(handlerClass);</div><div class="line">        namespaceHandler.init();</div><div class="line">        handlerMappings.put(namespaceUri, namespaceHandler);</div><div class="line">        <span class="keyword">return</span> namespaceHandler;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>2.2.1 <code>getHandlerMappings</code> 读取 <code>Spring.handlers</code> 配置文件并将配置文件缓存在 <code>Map</code> 中</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultNamespaceHandlerResolver.java</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_HANDLER_MAPPINGS_LOCATION = <span class="string">"META-INF/spring.handlers"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">getHandlerMappings</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.handlerMappings == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            Properties mappings =</div><div class="line">                PropertiesLoaderUtils.loadAllProperties(<span class="keyword">this</span>.handlerMappingsLocation, <span class="keyword">this</span>.classLoader);</div><div class="line">            Map&lt;String, Object&gt; handlerMappings = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(mappings.size());</div><div class="line">            CollectionUtils.mergePropertiesIntoMap(mappings, handlerMappings);</div><div class="line">            <span class="keyword">this</span>.handlerMappings = handlerMappings;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.handlerMappings;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>2.2.2 根据命名空间寻找对应的信息</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DefaultNamespaceHandlerResolver.java</span></div><div class="line"></div><div class="line">Object handlerOrClassName = handlerMappings.get(namespaceUri);</div><div class="line"><span class="keyword">if</span> (handlerOrClassName == <span class="keyword">null</span>) &#123;</div><div class="line">    NamespaceHandler namespaceHandler = (NamespaceHandler) BeanUtils.instantiateClass(handlerClass);</div><div class="line">    namespaceHandler.init();</div><div class="line">    handlerMappings.put(namespaceUri, namespaceHandler);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">return</span> handlerOrClassName;</div></pre></td></tr></table></figure>
<h4 id="2-3-标签解析"><a href="#2-3-标签解析" class="headerlink" title="2.3 标签解析"></a>2.3 标签解析</h4><p>找到 <code>NamespaceHandler</code> 之后，我们这里实际上已经被初始化为 <code>MotanNamespaceHandler</code> 了，而 <code>MotanNamespaceHandler</code> 也已经被调用了 <code>init()</code> 方法完成了初始化的工作。因此就接着执行这句代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BeanDefinitionParserDelegate.java</span></div><div class="line">handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd))</div></pre></td></tr></table></figure>
<p>我们自己本身并没有定义 <code>parse()</code> 方法，因此应该在父类中定义了:</p>
<p><img src="NamespaceHandlerResolver.svg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NamespaceHandlerSupport.java</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinitionParser&gt; parsers =</div><div class="line">			<span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> findParserForElement(element, parserContext).parse(element, parserContext);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> BeanDefinitionParser <span class="title">findParserForElement</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">    String localName = parserContext.getDelegate().getLocalName(element);</div><div class="line">    BeanDefinitionParser parser = <span class="keyword">this</span>.parsers.get(localName);</div><div class="line">    <span class="keyword">return</span> parser;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简而言之，就是从 <code>parsers</code> 中寻找到 <code>MotanBeanDefinitionParser</code> 实例，并调用其自身的 <code>parse</code> 方法进行进一步解析。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/extensible-xml.html" target="_blank" rel="external">Appendix F. Extensible XML authoring</a></li>
<li><a href="http://www.w3school.com.cn/schema/index.asp" target="_blank" rel="external">Schema 教程</a></li>
<li><a href="https://www.w3schools.com/xml/el_annotation.asp" target="_blank" rel="external">XML Schema annotation Element</a></li>
<li><a href="https://en.wikipedia.org/wiki/CDATA" target="_blank" rel="external">CDATA</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/29/Spring三/" data-id="cjc5qrsxm001h5cemfw18jebn" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-程序员的呐喊" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/28/程序员的呐喊/" class="article-date">
  <time datetime="2017-06-28T08:35:45.000Z" itemprop="datePublished">2017-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/笔记本/">笔记本</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/28/程序员的呐喊/">程序员的呐喊</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="程序员的呐喊"><a href="#程序员的呐喊" class="headerlink" title="程序员的呐喊"></a>程序员的呐喊</h2><p>亚马逊的伟大元老们只用两种语言: C 和 Lisp。显然，他们都是 Emacs 的拥趸。全世界伟大的工程师都用 Emacs，我说的是改变世界的那种工程师。真正的工程师只用 Emacs。Emacs 是不朽的编辑器。</p>
<p>名词在 Java 国拥有举足轻重的地位，是王国里的一等公民。Java 国王授予了架构尊崇的地位，因为架构完全是由名词组成的。类是 Java 里唯一的建模工具。</p>
<p><strong>软件工程有自己的政治轴心，一端是保守派，另一端是自由派</strong></p>
<p>本质上，保守主义就是风险管理，保守派 VS 自由派:</p>
<ul>
<li>软件在发布之前应该尽量修复所有 bug VS 不管多努力，bug 总是无法避免的，而生活还是会继续下去</li>
<li>程序员应该尽量回避错误</li>
<li>程序员学不会新语法</li>
<li>产品代码必须通过编译器的安全检查 VS 简练就是力量</li>
<li>数据必须遵循事先定义好的格式 VS 严格的数据定义只会妨碍灵活性，延缓开发进程</li>
<li>公共接口必须严格建模</li>
<li>生产系统决不允许存在危险或者有风险的后门</li>
<li>假如一个组件的安全性存在任何疑虑，那它就不能发布上线</li>
<li>快比慢好</li>
</ul>
<p>经常有人问我怎么有时间去学习新东西。我在这里统一回答一下：<strong>时间是挤出来的。</strong>这个答案没人会喜欢，但你我都知道这是真理。</p>
<p><strong>一个人的时间怎么分配是由自己决定的</strong>。</p>
<h3 id="编程最大的问题"><a href="#编程最大的问题" class="headerlink" title="编程最大的问题"></a>编程最大的问题</h3><p>希望你没忘记，冯诺依曼曾经是个经济学家。他的身份很多，其中一项就是经济学家，他在设计第一台电脑的时候肯定会受到影响。</p>
<p>不同的计算机有自己擅长的计算类型。另外有些比较好建造，有些速度比较快，有些天生比较健壮，有些则是为并行而生。</p>
<p>你知道自己的电脑其实就是这样一台机器，对吧？就目前而言，它在模式匹配方面比任何电脑都要快 10 万倍，这是因为冯诺依曼是顺序执行的，而你的每个神经元都可以独立工作。</p>
<p>为顺序型电脑而优化的语言在某些性能指标上的表现完全就是垃圾，这样的指标可不止一个。</p>
<p>冯诺依曼在生命的最后 10 年单枪匹马建立起一套基于细胞自动机的计算理论。你现在用来读我博客的计算机只不过是他该死的原型机！他原本是打算抛弃它去造一个更好的！可是后来他死于癌症，就像千千万万原本可以活得更久，做出更多贡献的人一样。我们在攻克癌症上也没什么进展，因为我们的电脑和编程语言都是可悲的垃圾。</p>
<h3 id="软件需要哲学家"><a href="#软件需要哲学家" class="headerlink" title="软件需要哲学家"></a>软件需要哲学家</h3><p>要是把矛头指向 Python 会怎样？这时 Java 程序员会给我发邮件: “我一直都很讨厌 Python，你把我的心里话都说出来了。谢谢！” 而这时 Python 程序员会怒从中起，恨不得在键盘上按一个键就能 “干掉那个混蛋”。</p>
<p><strong>要是没有建设性的观点，最好还是闭上嘴。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/28/程序员的呐喊/" data-id="cjc5qrt3400635cemhv5wj3ha" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/blog/page/14/">&laquo; Prev</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/13/">13</a><a class="page-number" href="/blog/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/blog/page/16/">16</a><a class="page-number" href="/blog/page/17/">17</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/23/">23</a><a class="extend next" rel="next" href="/blog/page/16/">Next&raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    

  
    
  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/01/06/where-the-time-actually-gone/">时间都去哪儿了</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/dev-reflection/">开发反思</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/my-microblog/">我的微博</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/gcc-basic/">gcc-basic</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/java-internal/">Java Internal</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>