<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="赵坤的个人网站">
<meta property="og:type" content="website">
<meta property="og:title" content="代码人生">
<meta property="og:url" content="http://blog.kunzhao.org/page/9/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="赵坤的个人网站">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码人生">
<meta name="twitter:description" content="赵坤的个人网站">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-order-number-generator" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/08/03/order-number-generator/" class="article-date">
  <time datetime="2017-08-03T07:26:01.000Z" itemprop="datePublished">2017-08-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/架构/">架构</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/08/03/order-number-generator/">order-number-generator</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="单号生成方案"><a href="#单号生成方案" class="headerlink" title="单号生成方案"></a>单号生成方案</h2><p><strong>数字和字符组成的序列</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> books <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</div><div class="line"><span class="keyword">USE</span> books;</div><div class="line"></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`book_order_sequence`</span> (</div><div class="line">       <span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">       <span class="string">`generate_time`</span> <span class="keyword">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</div><div class="line">       PRIMARY <span class="keyword">KEY</span>(<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/08/03/order-number-generator/" data-id="cjc5qrt2i004p5cemfqyy71l8" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-write-solid-code" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/08/03/write-solid-code/" class="article-date">
  <time datetime="2017-08-03T03:48:41.000Z" itemprop="datePublished">2017-08-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/08/03/write-solid-code/">Writing Solid Code</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Write-Solid-Code"><a href="#Write-Solid-Code" class="headerlink" title="Write Solid Code"></a>Write Solid Code</h2><h3 id="变量名的力量"><a href="#变量名的力量" class="headerlink" title="变量名的力量"></a>变量名的力量</h3><hr>
<p>最重要的考虑事项是: <strong>该名字要完全、准确地描述出该变量所代表的事物</strong></p>
<hr>
<p><strong>当变量名的平均长度在 10 到 16 个字符的时候</strong>，调试程序所需花费的力气是最小的。</p>
<hr>
<p><strong>常用对仗词</strong>:</p>
<p><img src="17-08-03-11_54_28_274_384.png" alt=""></p>
<hr>
<p><strong>为状态变量取一个比 <code>flag</code> 更好的名字</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (dataReady) &#123;&#125;</div><div class="line"><span class="keyword">if</span> (characterType &amp; PRINTABLE_CHAR) &#123;&#125;</div><div class="line"><span class="keyword">if</span> (reportType == REPORTYPE_ANNUAL) &#123;&#125;</div><div class="line"><span class="keyword">if</span> (recalcNeeded == <span class="keyword">false</span>) &#123;&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>Naming Boolean Variables</strong>:</p>
<ul>
<li><code>done, error, found, success, ok</code></li>
</ul>
<h4 id="1-选择专业的词"><a href="#1-选择专业的词" class="headerlink" title="1. 选择专业的词"></a>1. 选择专业的词</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPage</span><span class="params">(url)</span></span></div></pre></td></tr></table></figure>
<ul>
<li>从本地缓存中得到一个页面?</li>
<li>从数据库中得到一个页面?</li>
<li>或者从互联网中?</li>
</ul>
<p>如果是从互联网中，更加专业的名字应该是:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetchPage</span><span class="params">(url)</span></span></div><div class="line"><span class="function"><span class="title">def</span> <span class="title">downloadPage</span><span class="params">(url)</span></span></div></pre></td></tr></table></figure>
<p>对很多人了来说，<code>get</code> 暗示着 <strong>轻量级的访问器</strong>。</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinaryTree</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 树的高度?</span></div><div class="line">    <span class="comment">// 树的节点数?</span></div><div class="line">    <span class="comment">// 内存中所占的空间?</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">height()</div><div class="line">numNodes()</div><div class="line">memoryBytes()</div></pre></td></tr></table></figure>
<h4 id="2-不会误解的名字"><a href="#2-不会误解的名字" class="headerlink" title="2. 不会误解的名字"></a>2. 不会误解的名字</h4><p>推荐使用<strong><code>begin</code></strong>和<strong><code>end</code></strong>来表示包含的范围</p>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>电影制作者在其中给出自己的见解并且通过讲故事来帮助你理解这部电影是如何制作的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 出乎意料的是，对于这些数据使用二叉树比用哈希表快 40%</span></div><div class="line"><span class="comment">// 哈希运算的代码比左/右比较大得多</span></div></pre></td></tr></table></figure>
<hr>
<p>在我们的经验中，<strong>很多常量可以通过添加注释得以改进</strong>。</p>
<h3 id="测试与可读性"><a href="#测试与可读性" class="headerlink" title="测试与可读性"></a>测试与可读性</h3><blockquote>
<p>测试应当具有可读性，以便其他程序员可以舒服地改变或者增加测试。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Test1</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">vector</span>&lt;ScoredDocument&gt; docs;</div><div class="line">    docs.resize(<span class="number">5</span>);</div><div class="line">    docs[<span class="number">0</span>].url = <span class="string">"http://example.com"</span>;</div><div class="line">    docs[<span class="number">0</span>].score = <span class="number">-5.0</span>;</div><div class="line">    docs[<span class="number">1</span>].url = <span class="string">"http://example.com"</span>;</div><div class="line">    docs[<span class="number">1</span>].score = <span class="number">1</span>;</div><div class="line">    docs[<span class="number">2</span>].url = <span class="string">"http://example.com"</span>;</div><div class="line">    docs[<span class="number">2</span>].score = <span class="number">4</span>;</div><div class="line">    docs[<span class="number">3</span>].url = <span class="string">"http://example.com"</span>;</div><div class="line">    docs[<span class="number">3</span>].score = <span class="number">-99998.7</span>;</div><div class="line">    docs[<span class="number">4</span>].url = <span class="string">"http://example.com"</span>;</div><div class="line">    docs[<span class="number">4</span>].score = <span class="number">3.0</span>;</div><div class="line"></div><div class="line">    SortAndFilterDocs（&amp;docs）；</div><div class="line"></div><div class="line">    assert(docs.size() == <span class="number">3</span>);</div><div class="line">    assert(docs[<span class="number">0</span>].score == <span class="number">4</span>);</div><div class="line">    assert(docs[<span class="number">1</span>].score == <span class="number">3.0</span>);</div><div class="line">    assert(docs[<span class="number">2</span>].score == <span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>测试很长，充满了不重要的细节，你可以用一句话来描述这个测试所做的事情。</li>
<li>增加新测试不会很容易，<strong>你会倾向于拷贝/粘贴/修改</strong>。</li>
<li>测试输入不是很简单。</li>
<li>没有测试分数为 0 时候的情况。</li>
<li>没有测试其他极端的输入，例如<strong>空</strong>的输入向量、<strong>很长</strong>的向量、或者有<strong>重复</strong>分数的情况。</li>
<li>测试的名字 <code>Test1()</code> 没有意义</li>
</ul>
<p>作为一条普遍的测试原则，你应当 <u><strong>“对使用者隐去不重要的细节，以便更重要的细节会更突出。”</strong></u></p>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Test1</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">vector</span>&lt;ScoredDocument&gt; docs;</div><div class="line">    docs.resize(<span class="number">5</span>);</div><div class="line">    MakeScoreDoc(&amp;docs[<span class="number">0</span>], <span class="number">-5.0</span>, <span class="string">"http://example.com"</span>);</div><div class="line">    MakeScoreDoc(&amp;docs[<span class="number">1</span>], <span class="number">1</span>, <span class="string">"http://example.com"</span>);</div><div class="line">    MakeScoreDoc(&amp;docs[<span class="number">2</span>], <span class="number">4</span>, <span class="string">"http://example.com"</span>);</div><div class="line">    MakeScoreDoc(&amp;docs[<span class="number">3</span>], <span class="number">-99998.7</span>, <span class="string">"http://example.com"</span>);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MakeScoreDoc</span><span class="params">(ScoredDocument* sd, <span class="keyword">double</span> score, <span class="built_in">string</span> url)</span> </span>&#123;</div><div class="line">    sd-&gt;score = score;</div><div class="line">    sd-&gt;url = url;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Test1</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">vector</span>&lt;ScoredDocument&gt; docs;</div><div class="line">    docs.resize(<span class="number">5</span>);</div><div class="line">    AddScoredDoc(&amp;docs[<span class="number">0</span>], <span class="number">-5.0</span>);</div><div class="line">    AddScoredDoc(&amp;docs[<span class="number">1</span>], <span class="number">1</span>);</div><div class="line">    AddScoredDoc(&amp;docs[<span class="number">2</span>], <span class="number">4</span>);</div><div class="line">    AddScoredDoc(&amp;docs[<span class="number">3</span>], <span class="number">-99998.7</span>);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddScoredDoc</span><span class="params">(<span class="built_in">vector</span>&lt;ScoredDocument&gt;&amp; docs, <span class="keyword">double</span> score)</span> </span>&#123;</div><div class="line">    ScoredDocument sd;</div><div class="line">    sd.score = score;</div><div class="line">    sd.url = <span class="string">"http://example.com"</span>;</div><div class="line">    docs.push_back(sd);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>用自然语言来秒数我们的测试要做什么</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">我们有一个文档列表，它们的分数为 `[-5,1,4,-99998.7,3]`，在 `SortAndFilterDocs()` 之后，剩下的文档应当有的分数是 `[4,3,1]`，而且顺序也是这样。</div></pre></td></tr></table></figure>
<p>如你所见，我们没有在任何地方提及 <code>vector&lt;ScoredDocument&gt;</code>，这里最重要的是分数数组。在理想情况下，测试代码应该写成:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CheckScoresBeforeAfter(<span class="string">"-5, 1, 4, -99998.7, 3"</span>, <span class="string">"4, 3, 1"</span>);</div></pre></td></tr></table></figure>
<p>大多数的测试的基本内容都能精炼成 <strong>“对于这样的输入/情形，期望有这样的行为/输出”</strong>。</p>
<hr>
<ul>
<li><strong>选择好的测试输入</strong>: 你应当选择一组最简单的输入，它能完整的使用被测代码。</li>
</ul>
<p>首先，你可能注意到这个非常嚣张的 <code>-99998.7</code>，这个值的含义只是 “任何负数”， 它应当使用 <code>-1</code> 来代替。</p>
<h3 id="防御式编程"><a href="#防御式编程" class="headerlink" title="防御式编程"></a>防御式编程</h3><p>在恰当的抽象层次抛出异常:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 此处声明的异常位于不一致的抽象层次</span></div><div class="line">    <span class="function"><span class="keyword">public</span> TaxId <span class="title">getTaxId</span><span class="params">()</span> <span class="keyword">throws</span> EOFException </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>GetTaxId()</code> 将更底层的异常传递给其调用方，暴露了自身的一些实现细节，这就使得子程序的调用方代码不是与 <code>Employee</code> 类的代码耦合，而是与比 <code>Employee</code> 类层次更低的抛出 <code>EOFException</code> 异常的代码耦合起来了，相反，应该像下面这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> TaxId <span class="title">GetTaxId</span><span class="params">()</span> <span class="keyword">throws</span> EmployeeDataNotAvailable </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="关键的构建决策"><a href="#关键的构建决策" class="headerlink" title="关键的构建决策"></a>关键的构建决策</h3><p>高级语言的语句与等效的 <code>C</code> 代码语句行数之比:</p>
<p><img src="17-08-03-14_52_27_829_283.png" alt=""></p>
<hr>
<p>软件的首要技术使命: <strong>管理复杂度</strong></p>
<hr>
<p>类的接口应该尽可能少地暴露其内部工作机制，类很像冰山: 八分之七位于水面以下，而你只能看到水面上的八分之一:</p>
<p><img src="17-08-03-15_01_40_412_390.png" alt=""></p>
<h3 id="API-设计参考"><a href="#API-设计参考" class="headerlink" title="API 设计参考"></a>API 设计参考</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Picasso.with(context).load(<span class="string">"http://i.imgur.com/DvpvklR.png"</span>).into(imageView);</div></pre></td></tr></table></figure>
<h3 id="异常封装的架构模式应用"><a href="#异常封装的架构模式应用" class="headerlink" title="异常封装的架构模式应用"></a>异常封装的架构模式应用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateCommand</span> <span class="keyword">extends</span> <span class="title">CliCommand</span> </span>&#123;&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloseCommand</span> <span class="keyword">extends</span> <span class="title">CliCommand</span> </span>&#123;&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeleteCommand</span> <span class="keyword">extends</span> <span class="title">CliCommand</span> </span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>对于基类 <code>CliCommand</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CliCommand</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> CliCommand <span class="title">parse</span><span class="params">(String cmdArgs[])</span> <span class="keyword">throws</span> CliParseException</span>;</div><div class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exec</span><span class="params">()</span> <span class="keyword">throws</span> CliException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述地方有两个地方值得借鉴：</p>
<ul>
<li><strong>在基类的方法中抛出异常</strong></li>
<li><strong>定义统一的异常基类</strong>:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CliParseException</span> <span class="keyword">extends</span> <span class="title">CliException</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CliParseException</span><span class="params">(ParseException parseException)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(parseException);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MalformedPathException</span> <span class="keyword">extends</span> <span class="title">CliException</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MalformedPathException</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(message);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>子类<strong>封装</strong>自身抛出的异常，以一种统一的方式<strong>重新抛出</strong>异常:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exec</span><span class="params">()</span> <span class="keyword">throws</span> CliException </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        String newPath = zk.create(path, data, acl, flags, <span class="keyword">new</span> Stat(), ttl)</div><div class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException ex) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MalformedPathException(ex.getMessage());</div><div class="line">    &#125; <span class="keyword">catch</span>(KeeperException.EphemeralOnLocalSessionException e) &#123;</div><div class="line">        err.println(<span class="string">"Unable to create ephemeral node on a local session"</span>);</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CliWrapperException(e);</div><div class="line">    &#125; <span class="keyword">catch</span> (KeeperException.InvalidACLException ex) &#123;</div><div class="line">        err.println(ex.getMessage());</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CliWrapperException(ex);</div><div class="line">    &#125; <span class="keyword">catch</span> (KeeperException|InterruptedException ex) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CliWrapperException(ex);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="序列化-反序列化架构"><a href="#序列化-反序列化架构" class="headerlink" title="序列化/反序列化架构"></a>序列化/反序列化架构</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Record</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">serialize</span><span class="params">(OutputArchive archive, String tag)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> IOException</span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deserialize</span><span class="params">(InputArchive archive, String tag)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>OutputArchive.java</code> 如下:</p>
<p><img src="2017_09_25_15_44_13.png" alt=""></p>
<p><code>InputArchive.java</code> 如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InputArchive</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span> <span class="title">readByte</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">readBool</span><span class="params">(String tag)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="封装为-Context-的作用"><a href="#封装为-Context-的作用" class="headerlink" title="封装为 Context 的作用"></a>封装为 <code>Context</code> 的作用</h3><p>将变量和函数封装成各种<strong>上下文 (Context)</strong> 类， 使得 API 具有更好的易用性和扩展性。 首先， 函数参数列表经封装后变短， 使得函数更容易使用 ； 其次， <strong>当需要修改或添加某些变量或函数时， 只需修改封装后的上下文类即可</strong>， 用户代码无须修改， 这样保证了向后兼容性， 具有良好的扩展性。</p>
<p><code>MapReduce</code> 新版 <code>API</code> 的上下文继承树:</p>
<p><img src="2017_10_27_23_53_41.png" alt=""></p>
<h3 id="Configurable-可配置的作用"><a href="#Configurable-可配置的作用" class="headerlink" title="Configurable 可配置的作用"></a><code>Configurable</code> 可配置的作用</h3><p><img src="2017_11_02_22_08_42.png" alt=""></p>
<p>然后提供一个基类:</p>
<p><img src="2017_11_02_22_09_21.png" alt=""></p>
<h3 id="The-Clean-Code-Talks"><a href="#The-Clean-Code-Talks" class="headerlink" title="The Clean Code Talks"></a>The Clean Code Talks</h3><ul>
<li>Ask for Thinks ! Don’t look for Thinks !</li>
</ul>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span> </span>&#123;</div><div class="line"></div><div class="line">	String html;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Document</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">		HtmlClient client = <span class="keyword">new</span> HtmlClient();</div><div class="line">		html = client.get(url);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>更好的写法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span> </span>&#123;</div><div class="line"></div><div class="line">	String html;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Document</span><span class="params">(String html)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.html = html;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DocumentFactory</span> </span>&#123;</div><div class="line"></div><div class="line">	HtmlClient client;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DocumentFactory</span><span class="params">(HtmlClient client)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.client = client;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">Document <span class="title">build</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Document(client.get(url));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>Service Locator</strong>:</p>
<p><img src="2017_11_26_16_10_28.png" alt=""></p>
<p>应该这样做, The <code>House</code> has a clear API shown via the constructor:</p>
<p><img src="2017_11_26_16_12_55.png" alt=""></p>
<p>Service Locator 错在哪里:</p>
<ul>
<li>Mixing Respon    sibilities (Lookup, Factory)</li>
</ul>
<p>起如下这种名字的类都有可能有这种问题:</p>
<ul>
<li><code>Registry</code></li>
<li><code>Locator</code></li>
<li><code>Context</code></li>
<li><code>Manager</code></li>
<li><code>Handler</code></li>
<li><code>Environment</code></li>
<li><code>Principle</code></li>
</ul>
<hr>
<p>违反迪米特法则:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Goods</span> </span>&#123;</div><div class="line"></div><div class="line">	AccountReceivable ar;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">purchase</span><span class="params">(Customer c)</span> </span>&#123;</div><div class="line">		<span class="comment">// c.getWallet().getMoney() 违反 demeter 法则</span></div><div class="line">		Money m = c.getWallet().getMoney();</div><div class="line">		ar.recordSale(<span class="keyword">this</span>, m);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>遵循迪米特法则:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Goods</span> </span>&#123;</div><div class="line"></div><div class="line">	AccountReceivable ar;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">purchase</span><span class="params">(Money m)</span> </span>&#123;</div><div class="line">		ar.recordSale(<span class="keyword">this</span>, m);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>Law of Demeter</strong>:</p>
<ul>
<li>You only ask for objects which you directly need (operate on)</li>
<li><code>a.getX().getY()</code> is a dead givaway</li>
<li><code>serviceLocator.getService()</code> is breaking the Law of Demeter</li>
<li>Dependency Injection of the specific object you need. Hollywood Principle.</li>
</ul>
<p>两个原则:</p>
<ul>
<li>业务逻辑不应该关心 object lookup of the construction, 它只需要说 I need all these things.</li>
<li><code>Factory</code>, <code>Builder</code>, <code>DI</code> 负责将这些东西组装在一起</li>
</ul>
<h3 id="Good-API"><a href="#Good-API" class="headerlink" title="Good API"></a>Good API</h3><ul>
<li>Easy to learn</li>
<li>Easy to use, even without documentation</li>
<li>Hard to misuse</li>
<li>Easy to read and maintain code that uses it</li>
<li>Sufficiently powerful to satisfy requirement</li>
<li>Easy to evolve</li>
</ul>
<hr>
<p>API should do one thing, and do it well.</p>
<p>If it’s hard to name, that’s generally a bad sign.</p>
<hr>
<p>The fundamental rules of API design:</p>
<ul>
<li>When in doubt, leave it out.</li>
<li>Don’t make the client    do anything the module could do.</li>
</ul>
<p>Reduce need for <strong>boilerplate code</strong></p>
<h3 id="Context-Design-Pattern"><a href="#Context-Design-Pattern" class="headerlink" title="Context Design Pattern"></a>Context Design Pattern</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// I would hate the class constructing the</span></div><div class="line"><span class="comment">// FileCopier to know it is interested in</span></div><div class="line"><span class="comment">// all of these!</span></div><div class="line">FileCopier copier = <span class="keyword">new</span> FileCopier(logger, </div><div class="line">                                   copierSettings, generalTimeouts);</div><div class="line"></div><div class="line"><span class="comment">// I end up doing this:</span></div><div class="line">FileCopier copier = <span class="keyword">new</span> FileCopier(configuration);</div><div class="line"><span class="comment">// and inside..</span></div><div class="line">FileCopier(Configuration configuration) &#123;</div><div class="line">    X = configuration.GetSetting(“X”, DefaultValue);</div><div class="line">    <span class="comment">// …</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://stackoverflow.com/questions/771983/what-is-context-object-design-pattern" target="_blank" rel="external">what is context object design pattern?</a></li>
<li><a href="http://misko.hevery.com/2008/10/27/pass-around-ginormous-context-objects/" target="_blank" rel="external">Pass Around Ginormous Context Objects</a></li>
</ul>
<h3 id="设计并改进-“分钟-小时计数器”"><a href="#设计并改进-“分钟-小时计数器”" class="headerlink" title="设计并改进 “分钟/小时计数器”"></a>设计并改进 “分钟/小时计数器”</h3><p><img src="webwxgetmsgimg.jpeg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MinuteHourCounter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// add a count</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">count</span><span class="params">(<span class="keyword">int</span> numBytes)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// return the count over this minute</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">minuteCount</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// return the count over this hour</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">hourCount</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MinuteHourCounter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// add a new data point (count &gt;= 0)</span></div><div class="line">    <span class="comment">// For the next minute, minuteCount() will larger by +count</span></div><div class="line">    <span class="comment">// For the next hour, hourCount() will larger by +count</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> count)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// return the accumulated count over the past 60 seconds</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">minuteCount</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// return the accumulated count over the past 3600 seconds</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">hourCount</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinuteHourCounterImpl</span> <span class="keyword">implements</span> <span class="title">MinuteHourCounter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> count;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> time;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">(<span class="keyword">int</span> count, <span class="keyword">long</span> time)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.count = count;</div><div class="line">            <span class="keyword">this</span>.time = time;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;    </div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Event&gt; events = <span class="keyword">new</span> ArrayList&lt;Event&gt;();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">        events.add(<span class="keyword">new</span> Event(count, System.currentTimeMillis()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minuteCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;events.size(); i++) &#123;</div><div class="line">            Event event = events.get(i);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (event.time &gt; now - <span class="number">60</span>) &#123;</div><div class="line">                count += event.count;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> count;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hourCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;events.size(); i++) &#123;</div><div class="line">            Event event = events.get(i);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (event.time &gt; now - <span class="number">60</span>) &#123;</div><div class="line">                count += event.count;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> count;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong><code>for</code> 循环太大，一口吃不下</strong>。大多数读者在读这段代码的时候会显著慢下来，以确定这段代码没有 <code>bug</code>。</li>
</ul>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinuteHourCounterImpl</span> <span class="keyword">implements</span> <span class="title">MinuteHourCounter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> count;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> time;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">(<span class="keyword">int</span> count, <span class="keyword">long</span> time)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.count = count;</div><div class="line">            <span class="keyword">this</span>.time = time;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Event&gt; events = <span class="keyword">new</span> ArrayList&lt;Event&gt;();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">        events.add(<span class="keyword">new</span> Event(count, System.currentTimeMillis()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minuteCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> countSince(System.currentTimeMillis() - <span class="number">60</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hourCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> countSince(System.currentTimeMillis() - <span class="number">3600</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">countSince</span><span class="params">(<span class="keyword">long</span> cutOff)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=events.size() - <span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">            Event event = events.get(i);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (event.time &lt;= cutOff) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            count += event.count;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> count;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>性能问题</strong>:</p>
<ul>
<li>它一直不停地在变大，对内存的使用没有限制</li>
<li><code>minuteCount</code> 和 <code>hourCount</code> 太慢了</li>
</ul>
<hr>
<p><strong>两阶段传送带设计方案</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinuteHourCounterImpl</span> <span class="keyword">implements</span> <span class="title">MinuteHourCounter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> count;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> time;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">(<span class="keyword">int</span> count, <span class="keyword">long</span> time)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.count = count;</div><div class="line">            <span class="keyword">this</span>.time = time;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Event&gt; minuteEvents = <span class="keyword">new</span> ArrayList&lt;Event&gt;();</div><div class="line">    <span class="comment">// only contains elements not in minuteEvents</span></div><div class="line">    <span class="keyword">private</span> List&lt;Event&gt; hourEvents = <span class="keyword">new</span> ArrayList&lt;Event&gt;();</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> minuteCount;</div><div class="line">    <span class="comment">// counts all events over past hour, including past minute</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> hourCount;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">        shiftOldEvents(now);</div><div class="line"></div><div class="line">        <span class="comment">// Feed into the minuteList (not into the hour list -- that will happen later)</span></div><div class="line">        minuteEvents.add(<span class="keyword">new</span> Event(count, now));</div><div class="line"></div><div class="line">        minuteCount += count;</div><div class="line">        hourCount += count;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minuteCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        shiftOldEvents(System.currentTimeMillis());</div><div class="line">        <span class="keyword">return</span> minuteCount;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hourCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        shiftOldEvents(System.currentTimeMillis());</div><div class="line">        <span class="keyword">return</span> hourCount;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Find and delete old events, and decrease hourCount and minuteCount accordingly.</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">shiftOldEvents</span><span class="params">(<span class="keyword">long</span> time)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> minuteAgo = time - <span class="number">60</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> hourAgo = time - <span class="number">3600</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Move events more that one minute old from 'minuteEvents' into 'hourEvents'</span></div><div class="line">        <span class="comment">// (Events older that one hour will be removed in the second loop.)</span></div><div class="line">        <span class="keyword">while</span> (!minuteEvents.isEmpty() &amp;&amp; minuteEvents.get(<span class="number">0</span>).time &lt;= minuteAgo) &#123;</div><div class="line">            Event event = minuteEvents.get(<span class="number">0</span>);</div><div class="line">            hourEvents.add(event);</div><div class="line">            </div><div class="line">            minuteCount -= event.count;</div><div class="line">            minuteEvents.remove(event);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Remove events more than one hour old from 'hourEvents'</span></div><div class="line">        <span class="keyword">while</span> (!hourEvents.isEmpty() &amp;&amp; hourEvents.get(<span class="number">0</span>).time &lt;= hourAgo) &#123;</div><div class="line">            Event event = hourEvents.get(<span class="number">0</span>);</div><div class="line">            </div><div class="line">            hourCount -= event.count;</div><div class="line">            hourEvents.remove(event);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对很多应用来说，这个解决方案足够好了，但它还是有缺点的:</p>
<ul>
<li>设计不灵活，假设我们希望保留过去 24 小时的计数，需要修改大量的代码</li>
<li>占用的内存很大，假设你有一个高流量的服务，每分钟调用 <code>add()</code> 函数 100 次，因为我们保留了过去一小时内所有的数据，所以这段代码可能会需要用到大约 5MB 的内存</li>
</ul>
<hr>
<p><strong>时间桶设计方案</strong>:</p>
<p>把一个小时间窗口内的事件装到桶里，然后用一个总和累加这些事件。例如，过去 1 分钟里的事件可以插入 60 个离散的桶里，每个有 1 秒钟宽。过去 1 小时里的事件也可以插入 60 个离散的桶里，每个 1 分钟宽。</p>
<p><img src="482603526.jpg" alt=""></p>
<p>如图一样使用这些桶，方法 <code>minuteCount()</code> 和 <code>hourCount()</code> 的精读会是 <code>1/60</code>，这是合理的。如果要更精确，可以使用更多的桶，以使用更多的内存为交换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * A queue with a maximum number of slots, where old data "falls off" the end</span></div><div class="line"><span class="comment"> * 一个最大长度的队列，可以移位并且维护其总和</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConveyorQueue</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Deque&lt;Integer&gt; queue;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxItems;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> totalSum;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConveyorQueue</span><span class="params">(<span class="keyword">int</span> maxItems)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.maxItems = maxItems;</div><div class="line">        <span class="keyword">this</span>.queue = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Increment the value at the back of the queue</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addToBack</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (queue.isEmpty()) &#123;</div><div class="line">            <span class="comment">// make sure queue has at least 1 item</span></div><div class="line">            shift(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> lastItemCount = queue.pollLast();</div><div class="line">        queue.offerLast(lastItemCount + count);</div><div class="line"></div><div class="line">        totalSum += count;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Each value in the queue is shifted forward by 'numShifted'.</span></div><div class="line">    <span class="comment">// New items are initialized to 0.</span></div><div class="line">    <span class="comment">// Oldest items will be removed so there size &lt;= maxItems</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shift</span><span class="params">(<span class="keyword">int</span> numShifted)</span> </span>&#123;</div><div class="line">        <span class="comment">// In case too many items shifted, just clear the queue.</span></div><div class="line">        <span class="keyword">if</span> (numShifted &gt;= maxItems) &#123;</div><div class="line">            <span class="comment">// clear the queue</span></div><div class="line">            queue = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line">            totalSum = <span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Push all the needed zeros</span></div><div class="line">        <span class="keyword">while</span> (numShifted &gt; <span class="number">0</span>) &#123;</div><div class="line">            queue.offer(<span class="number">0</span>);</div><div class="line">            numShifted--;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Let all the excess items fall off</span></div><div class="line">        <span class="keyword">while</span> (queue.size() &gt; maxItems) &#123;</div><div class="line">            totalSum -= queue.poll();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// return the total value of all items currently in the queue</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">totalSum</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> totalSum;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * A class that keeps counts for the past N buckets of time.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrailingBucketCounter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> secsPerBucket;</div><div class="line">    <span class="keyword">private</span> ConveyorQueue buckets;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastUpdateTime; <span class="comment">// the last time update() was called</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrailingBucketCounter</span><span class="params">(<span class="keyword">int</span> numBuckets, <span class="keyword">int</span> secsPerBucket)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.secsPerBucket = secsPerBucket;</div><div class="line">        <span class="keyword">this</span>.buckets = <span class="keyword">new</span> ConveyorQueue(numBuckets);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> currentBucket = now;</div><div class="line">        <span class="keyword">long</span> lastUpdateBucket = lastUpdateTime / secsPerBucket;</div><div class="line"></div><div class="line">        buckets.shift((<span class="keyword">int</span>) (currentBucket - lastUpdateBucket));</div><div class="line">        lastUpdateTime = now;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> count, <span class="keyword">long</span> now)</span> </span>&#123;</div><div class="line">        update(now);</div><div class="line">        buckets.addToBack(count);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">trailingCount</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</div><div class="line">        update(now);</div><div class="line">        <span class="keyword">return</span> buckets.totalSum();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MinuteHourCounter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TrailingBucketCounter minuteCounter;</div><div class="line">    <span class="keyword">private</span> TrailingBucketCounter hourCounter;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MinuteHourCounter</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.minuteCounter = <span class="keyword">new</span> TrailingBucketCounter(<span class="number">60</span>, <span class="number">1</span>);</div><div class="line">        <span class="keyword">this</span>.hourCounter = <span class="keyword">new</span> TrailingBucketCounter(<span class="number">60</span>, <span class="number">60</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis() / <span class="number">1000</span>;</div><div class="line">        minuteCounter.add(count, now);</div><div class="line">        hourCounter.add(count, now);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minuteCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis() / <span class="number">1000</span>;</div><div class="line">        <span class="keyword">return</span> minuteCounter.trailingCount(now);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hourCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis() / <span class="number">1000</span>;</div><div class="line">        <span class="keyword">return</span> hourCounter.trailingCount(now);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>详细解释:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 假设我们维护的是一个 60 桶的双端队列 …</span></div><div class="line"></div><div class="line">Deque&lt;Integer&gt; deque = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line">deque.offer(<span class="number">12</span>);</div><div class="line"></div><div class="line">Thread.sleep(<span class="number">2</span> * <span class="number">1000</span>);</div><div class="line">deque.offer(<span class="number">75</span>);</div><div class="line"></div><div class="line">Thread.sleep(<span class="number">3</span> * <span class="number">1000</span>);</div><div class="line">deque.offer(<span class="number">96</span>);</div><div class="line"></div><div class="line">Thread.sleep(<span class="number">1</span> * <span class="number">1000</span>);</div><div class="line">deque.offer(<span class="number">24</span>);</div><div class="line"></div><div class="line"><span class="comment">// [ 12 | 0 | 0 | 75 | 0 | 0 | 0 | 96 | 0 | 24 | --&gt; ]</span></div><div class="line"></div><div class="line"><span class="comment">// 假设当前队列长度为 65，我们实际上想要维护一个长度为 60 的队列 (我们需要移除开头加进来的 5 个):</span></div><div class="line"></div><div class="line"><span class="comment">// [ x  | x | x | x  | x | 0 | 0 | 96 | 0 | 24 | --&gt; ]</span></div><div class="line"><span class="comment">// ===&gt;</span></div><div class="line"><span class="comment">// [ 0 | 0 | 96 | 0 | 24 | --&gt; ]</span></div></pre></td></tr></table></figure>
<ul>
<li><strong>使用 <code>poll()</code> 移除先添加进来</strong>的超过窗口大小的 (如 <code>60</code>)</li>
<li>使用 <code>0</code> 填补间隔的秒数</li>
<li><strong>使用 <code>offerLast()</code> 从队尾添加元素值</strong>，进行计数</li>
</ul>
<h3 id="Writing-Solid-Code"><a href="#Writing-Solid-Code" class="headerlink" title="Writing Solid Code"></a>Writing Solid Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* memcpy 复制一个不重叠的内存块 */</span></div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">memcpy</span><span class="params">(<span class="keyword">void</span>* pvTo, <span class="keyword">void</span>* pvFrom, <span class="keyword">size_t</span> size)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    byte* pbTo = (byte*)pvTo;</div><div class="line">    byte* pbFrom = (byte*)pvFrom;</div><div class="line">    <span class="keyword">while</span>(size--&gt;<span class="number">0</span>);</div><div class="line">    *pbTo++ = *pbFrom++;</div><div class="line">    <span class="keyword">return</span>(pvTo);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>当确定需要用空语句时，你就用</strong>。但最好用 <code>NULL</code> 使其明显可见:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span>* strcpy(<span class="keyword">char</span>* pchTo, <span class="keyword">char</span>* pchFrom)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span>* pchStart = pchTo;</div><div class="line">    <span class="keyword">while</span>(*pchTo++ = *pchFrom++)</div><div class="line">        NULL;</div><div class="line">    Return(pchStart);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">memcpy</span><span class="params">(<span class="keyword">void</span>* pvTo, <span class="keyword">void</span>* pvFrom, size_t size)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">void</span>* pbTo = (<span class="keyword">byte</span>*)pvTo;</div><div class="line">    <span class="keyword">void</span>* pbFrom = (<span class="keyword">byte</span>*)pvFrom;</div><div class="line">#ifdef DEBUG</div><div class="line">    <span class="keyword">if</span>(pvTo == NULL | | pvFrom == NULL)</div><div class="line">        &#123;</div><div class="line">            fprintf(stderr, “Bad args in memcpy\n”);</div><div class="line">            abort();</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line">    <span class="keyword">while</span>(size--&gt;<span class="number">0</span>)</div><div class="line">        *pbTo++ == *pbFrom++;</div><div class="line">    <span class="keyword">return</span>(pvTo);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种想法是同时维护调试和非调试（即交付）两个版本。在程序的编写过程中，编译其调试版本，利用它提供的测试部分在增加程序功能时自动地查错。在程序编完之后，编译其交付版本，封装之后交给经销商。<strong>利用断言进行补救</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#ifdef DEBUG</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">_Assert</span><span class="params">(<span class="keyword">char</span>* , unsigned)</span></span>; <span class="comment">/* 原型 */</span></div><div class="line">#define ASSERT(f)                               \</div><div class="line">    <span class="keyword">if</span>(f)                                       \</div><div class="line">        NULL;                                   \</div><div class="line">    <span class="keyword">else</span>                                        \</div><div class="line">        _Assert(__FILE__ , __LINE__)</div><div class="line">#else</div><div class="line">#define ASSERT(f) NULL</div><div class="line">#endif</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">memcpy</span><span class="params">(<span class="keyword">void</span>* pvTo, <span class="keyword">void</span>* pvFrom, size_t size)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">void</span>* pbTo = (<span class="keyword">byte</span>*)pvTo;</div><div class="line">    <span class="keyword">void</span>* pbFrom = (<span class="keyword">byte</span>*)pvFrom;</div><div class="line">    <span class="keyword">assert</span>(pvTo != NULL &amp;&amp; pvFrom != NULL);</div><div class="line">    <span class="keyword">while</span>(size--&gt;<span class="number">0</span>)</div><div class="line">        *pbTo++ == *pbFrom++;</div><div class="line">    <span class="keyword">return</span>(pvTo);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很少比跟踪到了一个程序中用到的断言，但却不知道该断言的作用这件事更令人沮丧的了。<strong>你浪费了大量的时间，不是为了排除错误，而只是为了弄清楚这个错误到底是什么</strong>。这还不是事情的全部，更有甚者程序员偶尔还会设计出有错的断言。所以如果搞不清楚相应断言检查的是什么，就很难知道错误是出现在程序中，还是出现在断言中。幸运的是，这个问题很好解决，只要给不够清晰的断言加上注解即可。我知道这是显而易见的事情，但令人惊奇的是很少又程序员这样做。为了使用户避免错误的危险，程序员们经历了各种磨难，但却没有说明危险到底是什么。这就好比一个人在穿过森林时，看到树上钉着一块上书“危险”红字的大牌子。但<strong>危险到底是什么</strong>？树要倒？废矿井？大脚兽？除非告诉人们危险是什么或者危险非常明显，否则这个牌子就起不到帮助人们提高警觉的作用，人们会忽视牌子上的警告。同样，<strong>程序员不理解的断言也会被忽视</strong>。在这种情况下，程序员会认为相应的断言是错误的，并把它们从程序中去掉。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 内存块重叠吗？如果重叠，就使用 memmove */</span></div><div class="line">ASSERT(pbTo&gt;=pbFrom+size || pbFrom&gt;=pbTo+size);</div></pre></td></tr></table></figure>
<hr>
<p>根本就不应该企图将 <code>memset</code> 写成一个可移植的函数。<strong>要接受其不可移植这一事实，不要对其进行改动</strong>。至于对程序中所做的其他假定，可以利用断言和条件编译进行相应的验证。</p>
<p><strong>如果不能使错误不断重现，就无法排除它们</strong>。找出程序中可能引起随机行为的因素，并将它们从程序的调试版本中清除。把目前尚“无定义”的内存单元置成了某个常量值，就可能产生这种错误。在这种情况下，如果程序在该单元被正确地定义为某个值之前引用了它的内容，那么每次执行这部分错误的代码，都会得到同样的错误结果:</p>
<p><img src="2017_12_01_22_07_59.png" alt=""></p>
<p>保存一个日志，以唤起你的注意:</p>
<p><img src="2017_12_01_22_09_12.png" alt=""></p>
<hr>
<p>假如你受雇为核反应堆编写软件，就必须对堆芯过热这一情况进行处理。</p>
<p>某些程序员解决这个问题的方法可以是自动地向堆芯灌水、插入冷却棒或者是能使反应堆冷却下来的一些其他什么方法。而且，只要程序已经控制了势态就不必向有关人员发出警报。</p>
<p>另一些程序员可能会选择另一种方法，即只要堆芯过热就向反应堆工作人员发出警报。虽然相应的处理仍由计算机自动进行，不同的是操作员总是知道这件事。</p>
<p>如果由你来实现这一程序，你会选择哪一种方法？</p>
<p>我想关于这一点，大家基本上不会有太多的异议，即<u><strong>总是应该向操作人员发出警报</strong></u>，这与计算机能够恢复反应堆的正常操作是两回事。<strong>堆芯不会无缘无故地出现过热现象，一定是发生了某种不同寻常的事情，才会引起这一故障</strong>。因此在计算机进行相应处理的同时，最好使操作人员搞清楚发生了什么事情以避免事故的再次发生。</p>
<p><strong>防错性程序设计虽然常常被誉为有较好的编码风格，但它却隐瞒了错误</strong>。要记住，我们正在谈论的错误决不应该再发生，而对这些错误所进行的安全处理又使编写无错代码变得更加困难。<strong>尽管防错性程序设计会隐瞒错误，但它确实有价值</strong>。一个程序所能导致的最坏结果是执行崩溃，并使用户可能花几个消失建立的数据全部丢掉。在非理想的世界中，程序确实会瘫痪，因此为了防止用户数据丢失而参去的任何措施都是值得的。防错性性程序设计要实现的就是这个目标。</p>
<p>实际上，无论把这种程序设计风格用在哪里，在编码之前都要同自己 ：<strong>“在进行防错性程序设计时，程序中隐瞒错误了吗？”</strong>如果答案是肯定的，就要在程序中加上相应的断言，以对这些错误进行报警。</p>
<hr>
<p>子程序是加入断言的绝佳之处，因为它可以使我们用很少的代码就能够进行很彻底的错误检查。这就好象一个足球场，虽然可以有 50000 个球迷来看球，但<strong>如果检票人员站在球场的入口，那么只需要几个检票人员就够了</strong>。程序中也有这样的入口 ，这就是子系统的调用点。</p>
<hr>
<p>Robert Cialdini 博土在其 “Influence：How and Why people Agree to Things” 一书中指出：如果你是个售货员，那么当顾客来到你负责的男装部准备购买毛衣和套装时，你应该总是先给顾客看套装然后再给顾客看毛衣。这样做的理由是可以增加销售额，因为<strong>在顾客买了一件 <code>$500</code> 元的套装之后，相比之下，一件 <code>$80</code> 元的毛衣就显得不那么贵了</strong>。但是如果你先给顾客看毛衣，那么 <code>$80</code> 元一件的价格可能会使其无法接受，最后也许你只能卖出一件 <code>$30</code> 元的毛衣。任何人只要花 30 秒的时间想一想，就会明白这个道理。</p>
<p>以前我也对给程序加上这么多降低效率的调试代码很反感，但不久我就认识到了自己的错误。在程序的交付版本中加上这种调试代码是会断送它的市场前途，付版本中增加任何的测试代码，这些代码只是被用在了它的调试版本中。确实，调试代码会降低调试版本的运行速度。但使你的零售产品瘫在用户那儿，或者为了帮助查错使你的调试版本运行得稍慢，哪一种情况更糟糕呢？我们不应该担心调试版本的效率，因为毕竟顾客不会使用程序的调试版本。</p>
<p>重要的是要在感情上区分程序的调试版本和交付版本。<strong>调试版本是用来发现错误的，而交付版本则是用来取悦顾客的</strong>。因此在编码时，对这两个版本所作的权衡也会相当不同。</p>
<p>记住，只要相应的交付版本能够满足顾客的大小和速度要求，就可以对调试版本做你想做的任何事情。如果为内存管理程序加上日志程序可以帮助你发现各种难于捕捉的错误，那么就会皆大欢喜。顾客可以得到一个充满活力的程序而你不费很多的时间和精力就可以发现错误。</p>
<p><img src="2017_12_01_22_02_18.png" alt=""></p>
<p>在由于速度太慢或者占用的内存太多而抛弃一个确认测试程序之前，要三思而后行。切记，这些代码并不是存在于程序的交付版本中。如果发现自己正在想：“这个测试程序太慢、太大了”，那么要马上停下来问自己：<strong>“怎样才能保留这个测试程序，并使它既快又小？”</strong></p>
<h4 id="4-对程序进行逐条跟踪"><a href="#4-对程序进行逐条跟踪" class="headerlink" title="4. 对程序进行逐条跟踪"></a>4. 对程序进行逐条跟踪</h4><p><img src="2017_12_01_22_12_40.png" alt=""><br><img src="2017_12_01_22_16_21.png" alt=""></p>
<p>我希望我知道一种能够说服程序员对其代码进行逐条跟踪的方法，或者至少能够使他们尝试一个月。但是我发现，<strong>程序员一般说来都克服不了“那太费时间”这一想法</strong>。作为项目负责人的一个好处是对于这种事情你可以霸道一些，直到程序员认识到这样做并不费很多时间，并且觉得很值得这样做，因为出错率显著的下降了。</p>
<p>如果你还没有对你的程序进行逐条的跟踪，你会开始这样做吗？只有你自己才知道这个问题的答案。但我猜想当你拿起这本书并开始阅读的时候，准是因为你正被减少你或你领导的程序员的代码中的错误所困扰。这自然就归结为如下的问题：<strong>你是宁愿花少量的时间，通过对代码进行逐条的跟踪来验证它；还是宁愿让错误溜进原版源代码中，希望测试者能够注意到这些错误以便你日后对其进行修改。选择在你。</strong></p>
<h4 id="5-糖果机界面"><a href="#5-糖果机界面" class="headerlink" title="5. 糖果机界面"></a>5. 糖果机界面</h4><p>我过去常常从要求编写标准的 <code>tolower</code> 函数开始考核候选者。我递给候选者一个 ASCII 表，问候选者“怎样写一个函数把一个大写字母转换成对应的小写字母？” <strong>我有意对如何处理字母以外的其它符号和小写字母说得很含糊</strong>，主要是想看看他们会怎样处理这些情况。这些符号在返回时会保持不变吗？会用断言对这些符号进行检查吗？它们会不会被忽视？半数以上的程序员写出的函数会是下面这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">char</span> <span class="title">tolower</span><span class="params">(<span class="keyword">char</span> ch)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span>( ch + ‘a’-‘A’);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>更常见的是那些未中选的候选者会说：“我没有考虑到这个问题。我可以解决这个问题，当 <code>ch</code> 不是大写字母时，令它返回一个错误代码。”有时他们会使 <code>tolower</code> 返回 <code>NULL</code>，有时会返回空字符。但出于某种原因，无疑 <code>-1</code> 会占上风：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">char</span> <span class="title">tolower</span><span class="params">(<span class="keyword">char</span> ch)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span>( ch &gt;= ‘A’ &amp;&amp; ch &lt;= ‘Z’)</div><div class="line">        <span class="keyword">return</span>( ch + ‘a’-‘A’);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span>(<span class="number">-1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这些解法都违背了我们前面给出的建议，因为<strong>他们把出错值同真正的数据混在了一起</strong>。但真正的问题并不在于候选者没能注意到他们也许从未听说过的建议，而是他们在大可不必的情况下返回了错误代码。</p>
<p>如果发现无法消除错误的情况，那么可以考虑干脆不允许这些有问题的情况出现，即用断言对函数的输入进行验证。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">char</span> <span class="title">tolower</span><span class="params">(<span class="keyword">char</span> ch)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    ASSERT( ch &gt;= ‘A’ &amp;&amp; ch &lt;= ‘Z’);</div><div class="line">    <span class="keyword">return</span>( ch + ‘a’-‘A’);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="2017_12_01_22_25_19.png" alt=""></p>
<blockquote>
<p>想一下 <code>MyBatis</code> 库里面的 <code>RuntimeException</code> 异常直接抛出机制</p>
</blockquote>
<h4 id="6-风险事业"><a href="#6-风险事业" class="headerlink" title="6. 风险事业"></a>6. 风险事业</h4><p>假如将一程序员置于悬崖边，给他绳子和滑翔机，他会怎样从悬崖上下来呢？是沿绳子爬下来呢？还是乘滑翔机呢？还是干脆直接跳下来呢？是沿绳子爬下来还是使用滑翔机我们说不太准，但可以肯定，他不会跳下来，因为那太危险了。可是当程序员有几种可能的实现方案时，他们却经常只考虑空间和速度，而完全忽视了风险性。如果程序员处于这样的悬崖边而又忽视了风险性，只考虑选择到达崖底最有效的途径的话．结果又将如何呢？</p>
<p>程序员忽视风险性，至少有两个原因：</p>
<p>一是因为他们盲目地认为，不管他们怎样实现编码，都不会有错误。<strong>没有任何程序员会说 ：“我准备编写快速排序程序，并打算在程序中有三个错误。”</strong>程序员并没有打算出错，而后来错误出现了，他们也并不特别吃惊。</p>
<p>我认为程序员忽视风险性的第二个原因也是主要原因：<strong>在于从来没有人教他们这样去问问题： “该设计有多大的风险性？该实现有多大的风险性？有没有更安全的方法来写这个表达式？能否测试一下该设计？”</strong> 要想问出这些问题，首先必须从思想上放弃这样的观点：不管作出哪种选择，最后总能得到无错代码。即使该观点是正确的，可是什么时候能得到无错代码呢？是由于使用安全的编码，在几天或几周之后就可以得到无错代码呢？还是由于忽视了风险性，出现很多错误而需要经过数月的调试和修改之后才能得到无错代码呢？</p>
<hr>
<p><strong>数据上溢或下溢</strong></p>
<p>有这样一些代码，表面看起来很正确。但是由于实现上存在着微妙的问题，执行却失败了，这是最严重的错误。<strong>“简单字符”就是这种性质的错误</strong>。下面的代码也具有这样的错误，这段代码用作初始化标准 <code>tolower</code> 宏的查寻表:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> chToLower[ UCHAR_MAX+<span class="number">1</span> ];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">BuildToLowerTable</span><span class="params">( <span class="keyword">void</span> )</span> <span class="comment">/* ASCII 版本*/</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> ch;</div><div class="line">    <span class="comment">/* 首先将每个字符置为它自己 */</span></div><div class="line">    <span class="keyword">for</span> （ch=<span class="number">0</span>; ch &lt;= UCHAR_MAX;ch++）</div><div class="line">        chToLower[ch] = ch;</div><div class="line">    <span class="comment">/* 现将小写字母放进大写字母的槽子里 */</span></div><div class="line">    <span class="keyword">for</span>( ch = ‘A’; ch &lt;= ‘Z’; ch++ )</div><div class="line">        chToLower[ch] = ch +’a’ – ‘A’;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> tolower(ch)（chToLower[(unsigned char)(ch)]）</span></div></pre></td></tr></table></figure>
<p>尽管代码看上去很可靠，实际上 <code>BuildToLowerTable</code> 很可能使系统挂起来。看一下第一个循环，什么时候 <code>ch</code> 大于 <code>UCHAR_MAX</code> 呢？如果你认为“从来也不会”，那就对了。如果你不这样认为，请看下面的解释。</p>
<p>假设 <code>ch</code> 等于 <code>UCHAR_MAX</code>，那么循环语句理应执行最后一次了。但是<strong>就在最后测试之前，<code>ch</code> 增加为 <code>UCHAR_MAX+1</code>，这将引起 <code>ch</code> 上溢为 <code>0</code></strong>。因此，<code>ch</code> 将总是小于等于 <code>UCHAR_MAX</code>，机器将进行无限的循环。</p>
<p>变量也可能下溢，那将会造成同样的困境。下面是实现 <code>memchr</code> 函数的一段代码。它的功能是通过查寻存储块，来找到第一次出现的某个字符。如果在存储块中找到了该字符，则返问指向该字符的指针，否则，返回空指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> * <span class="title">memchr</span><span class="params">( <span class="keyword">void</span> *pv, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch, <span class="keyword">size_t</span> size )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *pch = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *) pv;</div><div class="line">    <span class="keyword">while</span>( -- size &gt;=<span class="number">0</span> )</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span>( *pch == ch )</div><div class="line">                <span class="keyword">return</span> (pch );</div><div class="line">            pch++;</div><div class="line">        &#125;</div><div class="line">    <span class="keyword">return</span>( <span class="literal">NULL</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>循环什么时候终止？只有当 <code>size</code> 小于 <code>0</code> 时，循环才会终止。可是 <code>size</code> 会小于 <code>0</code> 吗？不会，因为 <strong><code>size</code> 是无符号值，当它为 <code>0</code> 时，表达式 <code>--size</code> 将使其下溢而成为类型 <code>size_t</code> 定义的最大无符号位</strong>。</p>
<p><img src="2017_12_01_22_49_27.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">IntToStr</span><span class="params">( <span class="keyword">int</span> i, <span class="keyword">char</span> *str )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">char</span> *strDigits;</div><div class="line">    <span class="keyword">if</span>( i &lt; <span class="number">0</span> )</div><div class="line">        &#123;</div><div class="line">            *str++ = ’-’;</div><div class="line">            i = -i; <span class="comment">/* 把 i 变成正值 */</span></div><div class="line">        &#125;</div><div class="line">    <span class="comment">/* 反序导出每一位数值 */</span></div><div class="line">    strDigits = str;</div><div class="line">    <span class="keyword">do</span></div><div class="line">        *str++ = i%<span class="number">10</span> + ’<span class="number">0</span>’;</div><div class="line">    <span class="keyword">while</span>( (i/=<span class="number">10</span>) &gt; <span class="number">0</span> );</div><div class="line">    *str=’/<span class="number">0</span>’;</div><div class="line">    ReverseStr( strDigits ); <span class="comment">/* 将数字的次序转为正序 */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>若该代码在二进制补码机器上运行，当 <code>i</code> 等于最小的负数（例如，16 位机器的-32768）时就会出现问题。原因在于表达式 <code>i= -i</code> 中的 <code>-i</code> 上；即上溢超出了 <code>int</code> 类型的范围。然而，真正的错误在于程序员实现代码的方式上：程序员没有完全按照他自己的设计来实现代码，而只是近似实现了他的设计。</p>
<p>在设计中要求：“如果 <code>i</code> 是负的，加入一个负号，然后将 <code>i</code> 的无符号数值部分转换成 <code>ASCII</code>。”而上面的代码并没有这么做。它实际执行了：“如果 <code>i</code> 是负的，加入一个负号，然后将 <code>i</code> 的正值也就是带符号的数值部分转换为 <code>ASCII</code>。”就是这个有符号的数字引起了所有的麻烦。如果完全根据算法并使用无符号数，代码会执行得很好。可以将上述代码分为两个函数，这样做十分有用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">IntToStr</span><span class="params">( <span class="keyword">int</span> i, <span class="keyword">char</span> *str )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span>( i &lt; <span class="number">0</span> )</div><div class="line">        &#123;</div><div class="line">            *str++ = ‘-‘;</div><div class="line">            i = -i;</div><div class="line">        &#125;</div><div class="line">    UnsToStr(( <span class="keyword">unsigned</span> )i, str );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnsToStr</span><span class="params">( <span class="keyword">unsigned</span> u, <span class="keyword">char</span> *str )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">char</span> * strStart = str;</div><div class="line">    <span class="keyword">do</span></div><div class="line">        *str++ = (u%<span class="number">10</span>) + ’<span class="number">0</span>’;</div><div class="line">    <span class="keyword">while</span>(( u/=<span class="number">10</span> )&gt;<span class="number">0</span> );</div><div class="line">    *str=’\<span class="number">0</span>’;</div><div class="line">    ReverseStr( strStart );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面的代码中，<code>i</code> 也要取负，这与前面的例子相同，为什么它就可以正常工作呢？这是因为：如果 <code>i</code> 是最小负数 <code>-32768</code>，二进制补码形式表示为 <code>0x8000</code>，然后通过将所有位倒装（即 <code>0</code> 变 <code>1</code>） 再加 <code>1</code> 来取负，从而得到 <code>-i</code> 为 <code>0x8000</code>，若为有符号数，则表示 <code>-32768</code>，若为无符号数，则表示 <code>32768</code>。按定义，由二进制补码表示的任意数，通过将其每一位倒装再加 <code>l</code>，可以得到该数的负值。因此 <code>0x8000</code> 表示的是最小负数 <code>-32768</code> 的负值，即 <code>32768</code>，因此应解释为无符号数。</p>
<p>至此，代码正确了，但并不美观。上面的代码容易让人产生错觉。根据可移植类型。 <code>-32768</code> 并不是有效的可移植整型值，因此通过在 <code>IntToStr</code> 中适当的位置插入断言，就可以排除所有的混乱。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">IntToStr</span><span class="params">( <span class="keyword">int</span> i, <span class="keyword">char</span> *str )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="comment">/* i 是否超出范围？使用 LongToStr … */</span></div><div class="line">    ASSERT( i&gt;=<span class="number">-32768</span> &amp;&amp; i&lt;- <span class="number">32767</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>消除代码的冗余性</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">memchr</span><span class="params">( <span class="keyword">void</span> *pv, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch, <span class="keyword">size_t</span> size )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *pch = (<span class="keyword">unsigned</span> <span class="keyword">char</span> * )pv;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *pchEnd = pch + size;</div><div class="line">    <span class="keyword">while</span>( pch&lt;pchEnd &amp;&amp; *pch != ch )</div><div class="line">        pch ++;</div><div class="line">    <span class="keyword">return</span>( ( pch &lt; pchEnd ) ? pch : <span class="literal">NULL</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第二个版本:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">memchr</span><span class="params">( <span class="keyword">void</span> *pv, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch, <span class="keyword">size_t</span> size )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *pch = ( <span class="keyword">unsigned</span> <span class="keyword">char</span> * )pv;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *pchEnd = pch + size;</div><div class="line">    <span class="keyword">while</span>( pch &lt; pchEnd )</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span>( *pch == ch )</div><div class="line">                <span class="keyword">return</span> ( pch );</div><div class="line">            pch ++ ;</div><div class="line">        &#125;</div><div class="line">    <span class="keyword">return</span>( <span class="literal">NULL</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于第二个版本<strong>只在 <code>while</code> 条件中进行块范围检查</strong>，所以它更容易理解并且准确地实现了函数的功能。第一个版本的唯一长处是当需要将程序打印出来时，可以节省一些纸。</p>
<hr>
<p>上面给出的 <code>memchr</code> 两个版本正确吗？你是否看出这两个版本具有同样一个细小错误？提示一下：当 <code>pv</code> 指向存储区的最后 <code>72</code> 个字节，并且 <code>size</code> 也是 <code>72</code> 时， <code>memchr</code> 将要查找存储区的什么范围呢？如果答案是“存储区的全部范围，反复不断地查找。”那么你的回答就是对的。由于在程序中使用了有风险的惯用语， <code>memchr</code> 陷入了无限的循环之中。</p>
<p>无论什么时候，只要有可能就尽量避免使用这些惯用语。在 <code>memchr</code> 中有风险的惯用语是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pchEnd = pch + size;</div><div class="line"><span class="keyword">while</span>( pch &lt; pchEnd )</div></pre></td></tr></table></figure>
<p>作为改正错误的第一步尝试，将上面的代码改写为如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pchEnd = pch + size – <span class="number">1</span>;</div><div class="line"><span class="keyword">while</span> ( pch &lt;= pchEnd )</div></pre></td></tr></table></figure>
<p>但是，这还不能正确工作。现在 <code>pchEnd</code> 可能指向一个合法的存储位置，但是，由于每一次 <code>pch</code> 增加到 <code>pchEnd + l</code> 时都要上溢，因此循环将不会终止。</p>
<p>当你可用指针也可用计数器时，使用计数器作为控制表达式是覆盖一个范围的安全方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memchr</span><span class="params">( <span class="keyword">void</span> *pv, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch, <span class="keyword">size_t</span> size )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *pch = ( <span class="keyword">unsigned</span> <span class="keyword">char</span> * )pv;</div><div class="line">    <span class="keyword">while</span>( size -- &gt; <span class="number">0</span> )</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span>( *pch == ch )</div><div class="line">                <span class="keyword">return</span>( pch );</div><div class="line">            pch ++;</div><div class="line">        &#125;</div><div class="line">    <span class="keyword">return</span>( <span class="literal">NULL</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面给出另一个惯用语，实际上在前面已经提过了。有些程序员可能会极力主张重写循环表达式，用 <code>--size</code> 代替 <code>size--</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span>（ --size &gt;= <span class="number">0</span> ）</div></pre></td></tr></table></figure>
<ul>
<li>如果 <code>size</code> 是无符号值（象 memchr 中的一样），根据定义，将总是大于或等于 0，循环将永运执行下去，因此表达式不能正常工作。</li>
<li>如果 <code>size</code> 是有符号数，表达式也不能正常工作。如 size 是 int 类型并且以最小的负值 <code>INT_MIN</code> 进入循环，它先被减 1，那么就会产生下溢，使得循环执行大量的次数。</li>
<li>相反，无论怎样声明 <code>size</code> 都能使 <code>“size-- &gt; 0”</code> 正确工作。这是个小小的、但又很重要的差别。</li>
</ul>
<p>程序员使用 <code>“-- size &gt; 0”</code> 的唯一原因是想加快速度。让我们仔细看一下，如果真的存在速度问题，那么进行这种改进就好象用指甲刀剪草坪一样，可以这么做，但没有什么效果。如果不存在速度问题，那为什么又要冒这样的风险呢？这就好象没有必要让草坪的所有草叶都一样长，没有必要让每行代码效率都最优一样，要认识到最重要的是总体效果。<strong>在某些程序员看来，放弃任何可能获得效率的机会似乎近似于犯罪</strong>。但是，当读完本书以后，你会得到这样的思想即使效率可能会稍稍低一点，也要使用安全的设计和实现来系统地减少风险性。用投资方面的一句术语来说就是：<strong>赢利并不能证明冒险是正确的</strong>。</p>
<hr>
<p><strong>不一致性是编写正确代码的障碍</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">word = high &lt;&lt; <span class="number">8</span> + low ;</div></pre></td></tr></table></figure>
<p>该代码原意是用两个 <code>8</code> 位字节组合成一个 <code>16</code> 位的字，但是由于 <code>+</code> 操作符比移位操作符的优先级要高，因此，该代码实际实现的是把 <code>high</code> 移动了 <code>8 + low</code> 位。程序员一般不将移位操作符和算术操作符混合使用。如果只用移位类操作符或只用算术类操作符就可以完成，那么为什么还要将移位操作符和算术操作符混合起来呢？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">word = high &lt;&lt; <span class="number">8</span> | low; <span class="comment">/* 移位解法 */</span></div><div class="line">word = high * <span class="number">256</span> + low; <span class="comment">/* 算术解法 */</span></div></pre></td></tr></table></figure>
<p>这些式子难以理解吗？它们的效率低吗？当然不是。这两种解法差别很大，但这两种解法都是正确的。</p>
<p>若程序员在写表达式时只用一类操作符，那么出现错误代码的概率就要小一些，因为凭直觉，同一类操作符的优先顺序容易掌握。</p>
<p><img src="2017_12_01_23_13_59.png" alt=""></p>
<p>要插入括号的时候，有些程序员总要先查优先级表，再来确定是否有必要插入括号，如果没有必要就不插。对于这样的程序员，要提醒他：“如果必须通过查表才能确定优先顺序的话，那就太复杂了，简单一些嘛。”这就意味着可以在不需要括号的地方插入括号。这样做不仅正确，而且显然可<strong>使任何人不经查表就可判断优先级</strong>了。</p>
<h4 id="7-编码中的假象"><a href="#7-编码中的假象" class="headerlink" title="7. 编码中的假象"></a>7. 编码中的假象</h4><p>应该编写可维护的代码这一观点并不新奇，程序员知道应该编写这样的代码。可是，他们总是没有认识到，他们虽然整天编写可维护的代码，但是如果他们使用只有 C 语言专业人员才能理解的语言，那么这些代码实际上是不可维护的。根据定义，可维护的代码应该是维护人员可以很容易地理解并且在修改时不会引入错误的代码。不管怎样，程序维护人员一般都是该项目的新手而不是专家。</p>
<p><img src="2017_12_02_11_17_07.png" alt=""></p>
<p>一般来说，<strong>有经验的程序员编写出代码，新手维护代码</strong>。我并不是说不应该这样安排，这种安排是实用的而且就是这么作的。但是，只有在有经验的程序员认识到，他们有责任使得他们所编写的代码，能够被程序维护人员和程序设计新手维护，这时这种安排才能行得通。</p>
<p><strong>编写直观的代码才是真正的聪明人</strong>。</p>
<h4 id="8-剩下来的就是态度问题"><a href="#8-剩下来的就是态度问题" class="headerlink" title="8. 剩下来的就是态度问题"></a>8. 剩下来的就是态度问题</h4><p>本书中讨论的方法可以用来检查错误和防止错误，但是这些技术并不能保证肯定可以写出无错代码，就象<strong>一个熟练的球队不可能是常胜军一样</strong>。重要的是养成好的习惯和正确的态度。</p>
<p>如果一个球队成天在嘴上讨论如何训练，这个球队可能有取胜的机会吗？如果这个球队的队员不断地因为工资低而牢骚满腹，或时刻耽心被换下场或裁减掉，那又会怎么样呢？虽然这些问题与球赛没有直接关系，但是却影响了球员水平的发挥。</p>
<p>同样读音可以使用本书的所有建议，但是，如果你持疑虑的态度或者使用错误的编码习惯，那么要写出无错的代码将是很困难的。因此，你要有必胜的信心和良好的习惯，同样，你同级的同事如果没有必胜信心和良好习惯也会遇到同样的问题。</p>
<hr>
<p><strong>错误不出现，我还有一招</strong>:</p>
<p><strong>错误消失有三个原因</strong>：一是错误报告不对；二是错误已被别的程序员改正了；三是这个错误依然存在但没有表现出来。也就是说，作为一个专业程序员 ，其职责之一就是要确定错误的消失究竟属于以上三种情况中的哪一种，从而采取相应的行动，但是决不能因为错误不出现就简单地忽略了它，就万事大吉了。</p>
<p><img src="2017_12_02_11_25_46.png" alt=""></p>
<p><strong>通常错误仍然存在，只是环境有了更改从而掩盖了错误</strong>。无论什么原因，为了采取适宜的步骤来改正错误，必须弄明白为什么错误消失了。</p>
<hr>
<p><strong>憨医救人</strong>:</p>
<p>在安东尼·罗宾斯的小说《唤醒巨人》（Awaken the Giant Within）中讲了一位医生的故事。一天，有个医生走到一条汹涌的河边，她突然听到落水者的呼救声。她环顾了四周，发现没有人去救，于是，她就跳入水中，朝着落水者游去。她将落水者救上岸，做口对口的人工呼吸，这个人刚一恢复呼吸，又从河里传来了另外两个落水者的求救声。她又一次跳入水中，把这两个人救上岸，正当她安顿好这两个人时，医生又听到另外四个落水者的求救声 ，然后她又听到另外八个落水者的求救声 …… 问题是医生只忙于救人，抽不出时间到上游查明是谁把人们扔到水中。</p>
<p>象这个医生一样，<strong>程序员也经常忙于“治愈”错误而没有停下来判断一下是什么原因引起了这些错误</strong>。</p>
<p>还有几次当我追踪到错误的根源时，经常这样认为：“等一下，修改这个函数可能是不对的。如果是这个函数出错的话，函数在另外的地方也应该出问题呀，可是它没有出问题呀 。”我肯定你能猜出为什么函数在另外的地方能够工作，它之所以工作是因为某个程序员已经局部性地修改了这个较为通常的错误。</p>
<p><img src="2017_12_02_11_30_03.png" alt=""></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://item.jd.com/11020839.html" target="_blank" rel="external">《编写可读代码的艺术》</a></li>
<li><a href="https://www.amazon.com/Writing-Solid-Code-Microsoft-Programming/dp/1556155514" target="_blank" rel="external">《Writing Solid Code (Microsoft Programming Series)》</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/08/03/write-solid-code/" data-id="cjc5qrt3a006h5cem17jd5sx5" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-url-filtering" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/08/01/url-filtering/" class="article-date">
  <time datetime="2017-08-01T12:49:36.000Z" itemprop="datePublished">2017-08-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/08/01/url-filtering/">url-filtering</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>爬虫开多的话，IO 写不进去，程序在执行，但是 IO 文件依然为 0</p>
<hr>
<ul>
<li><a href="http://blog.csdn.net/hi_software/article/details/7610674" target="_blank" rel="external">http://blog.csdn.net/hi_software/article/details/7610674</a></li>
<li><a href="http://blog.csdn.net/historyasamirror/article/details/6746217" target="_blank" rel="external">http://blog.csdn.net/historyasamirror/article/details/6746217</a></li>
<li><a href="https://llimllib.github.io/bloomfilter-tutorial/zh_CN/" target="_blank" rel="external">https://llimllib.github.io/bloomfilter-tutorial/zh_CN/</a></li>
</ul>
<p><a href="https://www.zhihu.com/question/28168585" target="_blank" rel="external">https://www.zhihu.com/question/28168585</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/08/01/url-filtering/" data-id="cjc5qrt2w005l5cem6x5mbd4i" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-java-nio" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/08/01/java-nio/" class="article-date">
  <time datetime="2017-08-01T07:37:17.000Z" itemprop="datePublished">2017-08-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/08/01/java-nio/">java-nio</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Java-NIO"><a href="#Java-NIO" class="headerlink" title="Java NIO"></a>Java NIO</h2><h3 id="为什么要使用-NIO"><a href="#为什么要使用-NIO" class="headerlink" title="为什么要使用 NIO"></a>为什么要使用 <code>NIO</code></h3><p>在大多数情况下，Java 应用程序并非真的受着 I/O 的束缚。操作系统并非不能快速传送数据，让 Java 有事可做；相反，是<strong> JVM 自身在 I/O 方面效率欠佳</strong>。操作系统与 Java 基于流的 I/O模型有些不匹配。<strong>操作系统要移动的是大块数据（缓冲区）</strong>，这往往是在硬件直接存储器存取（DMA）的协助下完成的。而 <strong>JVM 的 I/O 类喜欢操作小块数据——单个字节、几行文本</strong>。结果，操作系统送来整缓冲区的数据，<code>java.io</code>的流数据类再花大量时间把它们拆成小块，往往拷贝一个小块就要往返于几层对象。操作系统喜欢整卡车地运来数据，java.io 类则喜欢一铲子一铲子地加工数据。有了 <code>NIO</code>，就可以轻松地把一卡车数据备份到您能直接使用的地方（<code>ByteBuffer</code> 对象）。</p>
<p>这并不是说使用传统的 I/O 模型无法移动大量数据——当然可以（现在依然可以）。具体地说，<code>RandomAccessFile</code> 类在这方面的效率就不低，只要坚持使用基于数组的 <code>read( )</code> 和 <code>write( )</code>方法。这些方法与底层操作系统调用相当接近，尽管必须保留至少一份缓冲区拷贝。</p>
<h3 id="内存页面调度"><a href="#内存页面调度" class="headerlink" title="内存页面调度"></a>内存页面调度</h3><p>为了支持虚拟内存的第二个特性（<strong>寻址空间大于物理内存</strong>），就必须进行虚拟内存分页（经常称为<strong>交换</strong>，虽然真正的交换是在进程层面完成，而非页层面）。依照该方案，虚拟内存空间的页面能够继续存在于外部磁盘存储，这样就为物理内存中的其他虚拟页面腾出了空间。从本质上说，物理内存充当了分页区的高速缓存；而所谓分页区，即从物理内存置换出来，转而存储于磁盘上的内存页面。</p>
<h3 id="Buffer-线程安全吗？"><a href="#Buffer-线程安全吗？" class="headerlink" title="Buffer 线程安全吗？"></a><code>Buffer</code> 线程安全吗？</h3><p><strong>缓冲区并不是多线程安全的</strong>。如果您想以多线程同时存取特定的缓冲区，您需要在存取缓冲区之前进行同步（例如对缓冲区对象进行跟踪） 。</p>
<h3 id="ByteBuffer-的重要属性"><a href="#ByteBuffer-的重要属性" class="headerlink" title="ByteBuffer 的重要属性"></a><code>ByteBuffer</code> 的重要属性</h3><ul>
<li><strong><code>ByteBuffer.position()</code></strong>: <strong>下一个要被读或写</strong>的元素的索引。位置会自动由相应的 <code>get()</code> 和 <code>put()</code> 函数更新。</li>
<li><strong><code>ByteBuffer.limit()</code></strong>: 缓冲区的<strong>第一个不能被读或写</strong>的元素。 或者说,缓冲区中现存元素的计数。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> length = byteBuffer.limit();</div></pre></td></tr></table></figure>
<ul>
<li><strong><code>ByteBuffer.hasRemaining()</code></strong>: Tells whether there are any elements <strong>between the current position and the limit</strong>.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">transferTo</span><span class="params">(WritableByteChannel target, <span class="keyword">long</span> position)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.byteBufferHeader.hasRemaining()) &#123;</div><div class="line">        transferred += target.write(<span class="keyword">this</span>.byteBufferHeader);</div><div class="line">        <span class="keyword">return</span> transferred;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><strong>读取与写入</strong>:</p>
<p><strong>① 准备写</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">ByteBuffer result = ByteBuffer.allocate(size);</div><div class="line">result.put(...);</div><div class="line">result.put(...);</div><div class="line">result.put(...);</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// flip it !</span></div><div class="line">result.flip();</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">while</span> (result.hasRemaining()) &#123;</div><div class="line">    <span class="keyword">int</span> length = socketChannel.write(result);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>② 准备读</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">ByteBuffer byteBufferBody = ByteBuffer.allocate(size);</div><div class="line"><span class="keyword">while</span> (byteBufferBody.hasRemaining()) &#123;</div><div class="line">    <span class="keyword">int</span> length = socketChannel.read(byteBufferBody);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// flip it !</span></div><div class="line">byteBufferBody.flip();</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">byte</span>[] headerData = <span class="keyword">new</span> <span class="keyword">byte</span>[headerLength];</div><div class="line">byteBuffer.get(headerData);</div><div class="line"></div><div class="line"><span class="keyword">byte</span>[] headerData2 = <span class="keyword">new</span> <span class="keyword">byte</span>[headerLength];</div><div class="line">byteBuffer.get(headerData2);</div><div class="line"></div><div class="line"><span class="keyword">byte</span>[] headerData3 = <span class="keyword">new</span> <span class="keyword">byte</span>[headerLength];</div><div class="line">byteBuffer.get(headerData3);</div></pre></td></tr></table></figure>
<hr>
<p><strong>复制缓冲区</strong>:</p>
<ul>
<li><code>duplicate()</code>: 创建了一个与原始缓冲区相似的新缓冲区。两个缓冲区<strong>共享</strong>数据元素，拥有同样的容量，但每个缓冲区<strong>拥有各自的位置，上界和标记属性</strong>。对一个缓冲区内的数据<strong>元素所做的改变</strong>会反映在另外一个缓冲区上。这一副本缓冲区具有与原始缓冲区同样的数据视图。如果原始的缓冲区为只读，或者为直接缓冲区，新的缓冲区将继承这些属性。</li>
<li><code>asReadOnlyBuffer()</code>:生成一个只读的缓冲区视图。这与 <code>duplicate()</code> 相同，除了这个新的缓冲区<strong>不允许使用 <code>put()</code></strong>，并且其 <code>isReadOnly()</code> 函数将会返回 <code>true</code>。</li>
<li><code>slice()</code>: 创建一个从原始缓冲区的<strong>当前位置开始的新缓冲区</strong>，并且其容量是原始缓冲区的剩余元素数量（<code>limit - position</code>）。这个新缓冲区与原始缓冲区<strong>共享</strong>一段数据元素子序列。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CharBuffer buffer = CharBuffer.allocate(<span class="number">8</span>);</div><div class="line">buffer.position(<span class="number">3</span>).limit (<span class="number">5</span>);</div><div class="line">CharBuffer sliceBuffer = buffer.slice();</div></pre></td></tr></table></figure>
<p>假设原来的数据集是这样的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">|A|B|C|D|E|F|G|H| |</div></pre></td></tr></table></figure>
<ul>
<li><code>8</code> 位置不存储字符，<code>capacity</code> 为 8</li>
<li><code>position</code> 当前指向 3，即 <code>D</code> 字符</li>
<li><code>limit</code> 当前指向 5，即 <code>F</code> 字符</li>
</ul>
<p>那么，当调用 <code>slice</code> 之后，新创建的 <code>CharBuffer</code> 的数据集是这样的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">|D|E| |</div></pre></td></tr></table></figure>
<ul>
<li><code>2</code> 位置不存储字符，<code>capacity</code> 为 2</li>
<li><code>position</code> 当前指向 0，即 <code>D</code> 字符</li>
<li><code>limit</code> 当前指向 2，即结束字符</li>
</ul>
<p><code>ZooKeeper</code> 中的直接应用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</div><div class="line">    LOG.trace(<span class="string">"after readBytes message readable "</span></div><div class="line">              + message.readableBytes()</div><div class="line">              + <span class="string">" bb len "</span> + bb.remaining() + <span class="string">" "</span> + bb);</div><div class="line">    ByteBuffer dat = bb.duplicate();</div><div class="line">    dat.flip();</div><div class="line">    LOG.trace(<span class="string">"after readbytes "</span></div><div class="line">              + Long.toHexString(sessionId)</div><div class="line">              + <span class="string">" bb 0x"</span></div><div class="line">              + ChannelBuffers.hexDump(ChannelBuffers.copiedBuffer(dat)));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<ul>
<li><code>clear()</code> :将缓冲区重置为<strong>空状态</strong>。 它并不改变缓冲区中的任何数据元素，而是<strong>仅仅将上界设为容量的值</strong>，并把<strong>位置设回 <code>0</code></strong>。</li>
</ul>
<h3 id="创建缓冲区"><a href="#创建缓冲区" class="headerlink" title="创建缓冲区"></a>创建缓冲区</h3><p>新的缓冲区是由分配或包装操作创建的。<strong><code>allocate</code></strong> 操作创建一个缓冲区对象并分配一个<strong>私有的空间</strong>来储存容量大小的数据元素。<code>wrap</code> 操作创建一个缓冲区对象但是<strong>不分配任何空间</strong>来储存数据元素。它<strong>使用您所提供的数组</strong>作为存储空间来储存缓冲区中的数据元素。</p>
<p>要分配一个容量为 100 个 <code>char</code> 变量的 <code>Charbuffer</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CharBuffer charBuffer = CharBuffer.allocate (<span class="number">100</span>);</div></pre></td></tr></table></figure>
<p>这段代码隐含地从<strong>堆空间</strong>中分配了一个 <code>char</code> 型数组作为备份存储器来储存 100 个 <code>char</code> 变量。</p>
<p>如果您想提供您<strong>自己的数组</strong>用做缓冲区的备份存储器，请调用 <code>wrap()</code> 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> [] myArray = <span class="keyword">new</span> <span class="keyword">char</span> [<span class="number">100</span>];</div><div class="line">CharBuffer charbuffer = CharBuffer.wrap (myArray);</div></pre></td></tr></table></figure>
<p>这段代码构造了一个新的缓冲区对象，但数据元素会存在于数组中。这意味着通过调用 <code>put()</code> 函数造成的对缓冲区的改动会<strong>直接影响这个数组</strong>，而且对这个数组的任何改动也会对这个缓冲区对象可见。</p>
<hr>
<p>在 <code>ZooKeeper</code> 中的应用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">baos.close();</div><div class="line"><span class="keyword">this</span>.bb = ByteBuffer.wrap(baos.toByteArray());</div></pre></td></tr></table></figure>
<h3 id="翻转"><a href="#翻转" class="headerlink" title="翻转"></a>翻转</h3><p>我们已经写满了缓冲区，现在我们必须准备将其清空。我们想把这个缓冲区传递给一个通道，以使内容能被全部写出。但如果通道现在在缓冲区上执行 <code>get()</code>，那么它将从我们刚刚插入的有用数据之外取出未定义数据。如果我们<strong>将位置值重新设为 0</strong>，通道就会从正确位置开始获取，但是它是怎样知道<strong>何时到达</strong>我们所插入数据末端的呢？这就是<strong>上界属性</strong>被引入的目的。上界属性指明了缓冲区有效内容的末端。我们需要将上界属性设置为当前位置，然后将位置重置为 0。我们可以人工用下面的代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">buffer.limit(buffer.position()).position(<span class="number">0</span>);</div></pre></td></tr></table></figure>
<p>但这种从填充到释放状态的缓冲区翻转是 API 设计者预先设计好的，他们为我们提供了一个非常便利的函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Buffer.flip();</div></pre></td></tr></table></figure>
<p><code>flip()</code> 函数将一个能够<strong>继续添加</strong>数据元素的填充状态的缓冲区<strong>翻转成一个准备读出元素的释放状态</strong>。</p>
<p><code>rewind()</code> 函数与 <code>flip()</code> 相似，但<strong>不影响上界属性</strong>。它只是将位置值设回 0。您可以使用 <code>rewind()</code> 后退，<font color="red"><strong>重读</strong></font>已经被翻转的缓冲区中的数据。</p>
<p>如果将缓冲区翻转两次会怎样呢？它实际上会大小变为 0。把上界设为位置的值，并把位置设为 0。上界和位置都变成 0。尝试对缓冲区上<br>位置和上界都为 0 的 <code>get()</code> 操作会导致 <code>BufferUnderflowException</code> 异常。而 <code>put()</code> 则会导致 <code>BufferOverflowException</code> 异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">remaining</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> limit - position;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">flip</span><span class="params">()</span> </span>&#123;</div><div class="line">    limit = position; <span class="comment">// 比 rewind() 多了这一行</span></div><div class="line">    position = <span class="number">0</span>;</div><div class="line">    mark = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">rewind</span><span class="params">()</span> </span>&#123;</div><div class="line">    position = <span class="number">0</span>;</div><div class="line">    mark = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a><code>Selector</code></h3><p>仅用单个线程来处理多个 <code>Channels</code> 的好处是，只需要更少的线程来处理通道。<strong>事实上，可以只用一个线程处理所有的通道</strong>。对于操作系统来说，线程之间上下文切换的开销很大，而且每个线程都要占用系统的一些资源（如内存）。因此，使用的线程越少越好。</p>
<p>下面是单线程使用一个 <code>Selector</code> 处理 3 个 <code>channel</code> 的示例图：</p>
<p><img src="overview-selectors.png" alt=""></p>
<p>Java NIO 根据操作系统不同， 针对 <code>nio</code> 中的 <code>Selector</code> 有不同的实现：</p>
<p><img src="2017_09_11_21_33_02.png" alt=""></p>
<hr>
<p>参考:</p>
<ul>
<li><a href="http://ifeve.com/selectors/" target="_blank" rel="external">Java NIO系列教程（六） Selector</a></li>
</ul>
<h3 id="MappedFileAppending"><a href="#MappedFileAppending" class="headerlink" title="MappedFileAppending"></a><code>MappedFileAppending</code></h3><p>使用 <code>MappedByteBuffer</code> 来向一个文件里面追加数据:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 分配 1M 内存</span></div><div class="line"><span class="keyword">int</span> count = <span class="number">1024</span> * <span class="number">1000</span>;</div><div class="line">String bigFile = <span class="string">"D:\\android\\nio\\FileUtils.java"</span>;</div><div class="line">String date = <span class="string">"abclasdjfladslfjaldsfj"</span>;</div><div class="line"></div><div class="line"><span class="comment">// 打开一个文件</span></div><div class="line">RandomAccessFile memoryMappedFile = <span class="keyword">new</span> RandomAccessFile(bigFile, <span class="string">"rw"</span>);</div><div class="line"><span class="keyword">int</span> fileSize = (<span class="keyword">int</span>) memoryMappedFile.length();</div><div class="line">FileChannel fileChannel = memoryMappedFile.getChannel();</div><div class="line"></div><div class="line"><span class="comment">// 将文件映射到内存</span></div><div class="line">MappedByteBuffer mBuff = fileChannel.map(FileChannel.MapMode.READ_WRITE, <span class="number">0</span>, count);</div><div class="line"></div><div class="line"><span class="comment">//指针移动到文件最后</span></div><div class="line">mBuff.position(fileSize);</div><div class="line"></div><div class="line"><span class="comment">// 往 memory mapped file 中添加数据</span></div><div class="line">mBuff.put(data.getBytes());</div><div class="line"><span class="keyword">int</span> newFileSize = mBuff.position();</div><div class="line"></div><div class="line"><span class="comment">// We have to unmap the memory file first</span></div><div class="line">Class&lt;?&gt; fcClass = fileChannel.getClass();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    java.lang.reflect.Method unmapMethod = </div><div class="line">        fcClass.getDeclaredMethod(<span class="string">"unmap"</span>, <span class="keyword">new</span> Class[]&#123; java.nio.MappedByteBuffer.class &#125;);</div><div class="line">    unmapMethod.setAccessible(<span class="keyword">true</span>);</div><div class="line">    unmapMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123; mBuff &#125;);</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 我们分配了 1MB， but we just use newFileSize bytes</span></div><div class="line"><span class="keyword">if</span> (newFileSize &lt; count) &#123;</div><div class="line">    fileChannel.truncate(newFileSize);</div><div class="line">&#125;</div><div class="line">memoryMappedFile.close();</div><div class="line">fileChannel.close();</div></pre></td></tr></table></figure>
<h3 id="ByteOrder"><a href="#ByteOrder" class="headerlink" title="ByteOrder"></a><code>ByteOrder</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">bbuf.order(ByteOrder.BIG_ENDIAN);</div><div class="line"><span class="comment">// ==&gt; [7,9,0,0,0,0,0,0,0,0]</span></div><div class="line">bbuf.asShortBuffer().put(<span class="number">0</span>, (<span class="keyword">short</span>) <span class="number">0x0709</span>);</div><div class="line"><span class="comment">// ==&gt; [0,0,7,9,0,0,0,0,0,0]</span></div><div class="line"><span class="comment">// bbuf.asShortBuffer().put(1, (short) 0x0709);</span></div><div class="line"><span class="comment">// ==&gt; [0,0,0,0,7,9,0,0,0,0]</span></div><div class="line"><span class="comment">// bbuf.asShortBuffer().put(2, (short) 0x0709);</span></div><div class="line">System.out.println(Arrays.toString(bbuf.array()));</div><div class="line"></div><div class="line">bbuf.order(ByteOrder.LITTLE_ENDIAN);</div><div class="line"><span class="comment">// ==&gt; [9,7,0,0,0,0,0,0,0,0]</span></div><div class="line">bbuf.asShortBuffer().put(<span class="number">0</span>, (<span class="keyword">short</span>) <span class="number">0x0709</span>);</div><div class="line"><span class="comment">// ==&gt; [0,0,9,7,0,0,0,0,0,0]</span></div><div class="line"><span class="comment">// bbuf.asShortBuffer().put(1, (short) 0x0709);</span></div><div class="line"><span class="comment">// ==&gt; [0,0,0,0,9,7,0,0,0,0]</span></div><div class="line"><span class="comment">// bbuf.asShortBuffer().put(1, (short) 0x0709);</span></div><div class="line">System.out.println(Arrays.toString(bbuf.array()));</div><div class="line"></div><div class="line"><span class="comment">// Endian byte ordering affects integer and floating point data, does not affect character strings as they maintain the string order as viewed and intended by the programmer</span></div><div class="line"><span class="comment">// 没有影响</span></div><div class="line">bbuf.order(ByteOrder.LITTLE_ENDIAN);</div><div class="line">bbuf.put(<span class="string">"ABC"</span>.getBytes());</div></pre></td></tr></table></figure>
<h3 id="使用-FileChannel-来拷贝文件"><a href="#使用-FileChannel-来拷贝文件" class="headerlink" title="使用 FileChannel 来拷贝文件"></a>使用 <code>FileChannel</code> 来拷贝文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">File srcFile = <span class="keyword">new</span> File(srcFileName);</div><div class="line">File dstFile = <span class="keyword">new</span> File(dstFileName);</div><div class="line"><span class="keyword">if</span> (!dstFile.exists()) &#123;</div><div class="line">    dstFile.createNewFile();</div><div class="line">&#125;</div><div class="line"></div><div class="line">FileInputStream in = <span class="keyword">new</span> FileInputStream(srcFile);</div><div class="line">FileOutputStream out = <span class="keyword">new</span> FileOutputStream(dstFile);</div><div class="line">FileChannel inc = in.getChannel();</div><div class="line">FileChannel outc = out.getChannel();</div><div class="line"></div><div class="line"><span class="keyword">long</span> count = <span class="number">0</span>;</div><div class="line"><span class="keyword">long</span> size = inc.size();</div><div class="line"><span class="keyword">while</span> (count &lt; size) &#123;</div><div class="line">    count += outc.transferFrom(inc, <span class="number">0</span>, size - count);</div><div class="line">&#125;</div><div class="line"></div><div class="line">in.close();</div><div class="line">out.close();</div><div class="line">inc.close();</div><div class="line">outc.close();</div></pre></td></tr></table></figure>
<h3 id="使用-AsynchronousFileChannel-来读取大文件"><a href="#使用-AsynchronousFileChannel-来读取大文件" class="headerlink" title="使用 AsynchronousFileChannel 来读取大文件"></a>使用 <code>AsynchronousFileChannel</code> 来读取大文件</h3><h3 id="ByteBuffer-转为字符串"><a href="#ByteBuffer-转为字符串" class="headerlink" title="ByteBuffer 转为字符串"></a><code>ByteBuffer</code> 转为字符串</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">String content = <span class="string">"0123456789"</span>;</div><div class="line"><span class="comment">// 分配 ByteBuffer</span></div><div class="line">ByteBuffer buffer = ByteBuffer.wrap(content.getBytes());</div><div class="line"></div><div class="line"><span class="comment">// ByteBuffer buffer = ByteBuffer.allocateDirect(100);</span></div><div class="line"><span class="comment">// buffer.put(content.getBytes());</span></div><div class="line"><span class="comment">// buffer.position(0);</span></div><div class="line"></div><div class="line">String s;</div><div class="line"></div><div class="line"><span class="comment">// way 1</span></div><div class="line"><span class="comment">// Remember to check hasArray() before using this method</span></div><div class="line"><span class="comment">// hasArray() return false if we allocate the buffer using allocateDirect() method</span></div><div class="line"><span class="keyword">if</span> (buffer.hasArray()) &#123;</div><div class="line">    s = <span class="keyword">new</span> String(buffer.array(), Charset.forName(<span class="string">"US-ASCII"</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// way 2</span></div><div class="line">CharBuffer cb = Charset.forName(<span class="string">"US-ASCII"</span>).decode(buffer);</div><div class="line">s = sb.toString();</div><div class="line"></div><div class="line"><span class="comment">// way 3</span></div><div class="line">buffer.position(<span class="number">0</span>);</div><div class="line"><span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[buffer.remaining()];</div><div class="line">buffer.get(bytes);</div><div class="line">v = <span class="keyword">new</span> String(bytes, Charset.forName(<span class="string">"US-ASCII"</span>));</div></pre></td></tr></table></figure>
<h3 id="从字符串创建-ByteBuffer"><a href="#从字符串创建-ByteBuffer" class="headerlink" title="从字符串创建 ByteBuffer"></a>从字符串创建 <code>ByteBuffer</code></h3><p><img src="2017_11_26_00_49_32.png" alt=""><br><img src="2017_11_26_00_51_50.png" alt=""></p>
<h3 id="Working-with-Buffer"><a href="#Working-with-Buffer" class="headerlink" title="Working with Buffer"></a>Working with Buffer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. Filling the buffer</span></div><div class="line"><span class="keyword">char</span>[] mbuff = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">20</span>];</div><div class="line"></div><div class="line"><span class="comment">// [x,x,x,1,2,3,4,5,6,7,8,9,x,x,x,x,x,x,x,x]</span></div><div class="line"><span class="comment">// we want to put char from position=3, and max length that allows is 9</span></div><div class="line"><span class="comment">// CharBuffer cbuf = CharBuffer.wrap(mbuff, 3, 9);</span></div><div class="line"><span class="comment">// capacity: 20, limit: 12, position: 12</span></div><div class="line"><span class="comment">// cbuf.put("1234456789");</span></div><div class="line"></div><div class="line"><span class="comment">// BufferOverflowException</span></div><div class="line"><span class="comment">// cbuf.put("1234567890");</span></div><div class="line"></div><div class="line">CharBuffer cbuf = CharBuffer.wrap(mbuff);</div><div class="line">cbuf.put(<span class="string">"1234456789"</span>);</div><div class="line"></div><div class="line"><span class="comment">// [1,2,3,4,5,6,7,8,9,x,x,x,x,x,x,x,x,x,x,x]</span></div><div class="line"><span class="comment">// Arrays.toString(cbuf.array());</span></div><div class="line"></div><div class="line"><span class="comment">// 20</span></div><div class="line"><span class="comment">// cbuf.capacity();</span></div><div class="line"></div><div class="line"><span class="comment">// 20</span></div><div class="line"><span class="comment">// cbuf.limit();</span></div><div class="line"></div><div class="line"><span class="comment">// 9</span></div><div class="line"><span class="keyword">int</span> currentPos = cbuf.position();</div><div class="line"></div><div class="line"><span class="comment">// ====================================================</span></div><div class="line"></div><div class="line">cbuf.position(<span class="number">0</span>);</div><div class="line"><span class="comment">// 加上这句话，输出 123456789；否则：123456789xxxxxxxxxxx</span></div><div class="line">cbuf.limit(currentPos);</div><div class="line"></div><div class="line"><span class="comment">// we can replace position() and limit() by flip()</span></div><div class="line"><span class="comment">// cbuf.flip();</span></div><div class="line"></div><div class="line"><span class="keyword">while</span> (cbuf.hasRemaining()) &#123;</div><div class="line">	System.out.println(cbuf.get());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ================================</span></div><div class="line"></div><div class="line"><span class="comment">// Once you done reading data out of the buffer</span></div><div class="line"><span class="comment">// you have to make the buffer ready for write again	</span></div><div class="line"><span class="comment">// You can do so either by calling clear() or by calling compact()</span></div><div class="line"></div><div class="line"><span class="comment">// 123456789</span></div><div class="line">cbuf.rewind();</div><div class="line"></div><div class="line"><span class="comment">// 123456789xxxxxxxxxxx</span></div><div class="line"><span class="comment">// cbuf.compact();</span></div><div class="line"></div><div class="line"><span class="comment">// 123456789xxxxxxxxxxx</span></div><div class="line"><span class="comment">// cbuf.clear();</span></div><div class="line"><span class="keyword">while</span> (cbuf.hasRemaining()) &#123;</div><div class="line">	System.out.println(cbuf.get());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ===================================</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> k = <span class="number">0</span>;</div><div class="line"><span class="keyword">while</span> (cbuf.hasRemaining()) &#123;</div><div class="line">	<span class="keyword">if</span> (k == <span class="number">5</span>)</div><div class="line">		cbuf.mark();</div><div class="line">	System.out.println(cbuf.get());</div><div class="line">	k++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 6789, 不加这句话，还是 123456789</span></div><div class="line"><span class="comment">// The reset() method sets the position to current mark</span></div><div class="line"><span class="comment">// If the mark is undefined, calling reset() throw InvalidMarkException</span></div><div class="line">cbuf.reset();</div><div class="line"><span class="keyword">while</span> (cbuf.hasRemaining()) &#123;</div><div class="line">	System.out.println(cbuf.get());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用-FileChannel-读取文件的几种方式"><a href="#使用-FileChannel-读取文件的几种方式" class="headerlink" title="使用 FileChannel 读取文件的几种方式"></a>使用 <code>FileChannel</code> 读取文件的几种方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ====Read file using ByteBuffer of a size========</span></div><div class="line">Path path = Paths.get(fileName);</div><div class="line">FileChannel fileChannel = FileChannel.open(path);</div><div class="line"><span class="keyword">long</span> fileSize = fileChannel.size();</div><div class="line">ByteBuffer buf = ByteBuffer.allocate((<span class="keyword">int</span>) fileSize);</div><div class="line">fileChannel.read(buf);</div><div class="line"><span class="comment">// set limit = current position, set position = 0</span></div><div class="line"><span class="comment">// 如果不加这句话，那么会报异常:</span></div><div class="line"><span class="comment">// BufferUnderflowException</span></div><div class="line">buf.flip(); </div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;fileSize; i++) &#123;</div><div class="line">	System.out.print((<span class="keyword">char</span>) buf.get());</div><div class="line">&#125;</div><div class="line">fileChannel.close();</div><div class="line"></div><div class="line"><span class="comment">// ====Read a file with fixed size ByteBuffer====</span></div><div class="line"><span class="keyword">int</span> BUFFER = <span class="number">1024</span>;</div><div class="line"></div><div class="line">Path path = Paths.get(fileName);</div><div class="line">FileChannel fileChannel = FileChannel.open(path);</div><div class="line"><span class="keyword">long</span> fileSize = fileChannel.size();</div><div class="line">ByteBuffer buf = ByteBuffer.allocate(BUFFER);</div><div class="line"></div><div class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> bread = <span class="number">0</span>;</div><div class="line"><span class="keyword">while</span> ((bread = fileChannel.read(buf)) != -<span class="number">1</span>) &#123;</div><div class="line">	count += bread;</div><div class="line">	buf.flip();	</div><div class="line">	<span class="keyword">while</span> (buf.hasRemaining()) &#123;</div><div class="line">		System.out.print((<span class="keyword">char</span>) buf.get());</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 如果不加这句话，屏幕上一直重复输出读取的这个文件的内容…</span></div><div class="line">	buf.clear();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;fileSize; i++) &#123;</div><div class="line">	System.out.print((<span class="keyword">char</span>) buf.get());</div><div class="line">&#125;</div><div class="line">fileChannel.close();</div><div class="line"></div><div class="line"><span class="comment">//=======Read Small Text File=======</span></div><div class="line">Path path = Paths.get(fileName);</div><div class="line">List&lt;String&gt; list = Files.readAllLines(path, Charset.forName(<span class="string">"US-ASCII"</span>));</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;list.size(); i++) &#123;</div><div class="line">	System.out.print(list.get(i));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//=======Read Large Text File=======</span></div><div class="line">Path path = Paths.get(fileName);</div><div class="line">Scanner scanner = <span class="keyword">new</span> Scanner(path, Charset.forName(<span class="string">"US-ASCII"</span>).name());</div><div class="line"><span class="keyword">while</span> (scanner.hasNextLine()) &#123;</div><div class="line">	System.out.println(scanner.nextLine());</div><div class="line">&#125;</div><div class="line">scanner.close();</div><div class="line"></div><div class="line"><span class="comment">//======Read Large Text File Way 2======</span></div><div class="line">Path path = Paths.get(fileName);</div><div class="line">BufferedReader reader = Files.newBufferedReader(path, Charset.forName(<span class="string">"US-ASCII"</span>));</div><div class="line">String line;</div><div class="line"><span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">	System.out.println(line);</div><div class="line">&#125;</div><div class="line">reader.close();</div><div class="line"></div><div class="line"><span class="comment">//======Read File with MappedByteBuffer======</span></div><div class="line">Path path = Paths.get(fileName);</div><div class="line">FileChannel fileChannel = FileChannel.open(path);</div><div class="line">MappedByteBuffer buffer = fileChannel.map(FileChannel.MapMode.READ_ONLY,<span class="number">0</span>,fileChannel.size());</div><div class="line">buffer.load();</div><div class="line"><span class="keyword">int</span> count = buffer.limit();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">	System.out.print((<span class="keyword">char</span>) buffer.get());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用-FileChannel-写文件的几种方式"><a href="#使用-FileChannel-写文件的几种方式" class="headerlink" title="使用 FileChannel 写文件的几种方式"></a>使用 <code>FileChannel</code> 写文件的几种方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">String input = <span class="string">""</span>;</div><div class="line">String fileName = <span class="string">"D:\\output.txt"</span>;</div><div class="line"></div><div class="line"><span class="comment">//=========Write String to File============</span></div><div class="line">ByteBuffer buf = ByteBuffer.wrap(input.getBytes());</div><div class="line">FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(fileName);</div><div class="line">FileChannel fileChannel = fos.getChannel();</div><div class="line">fileChannel.write(buf);</div><div class="line">fileChannel.close();</div><div class="line">fos.close();</div><div class="line"></div><div class="line"><span class="comment">//=========Write String to File Way 2============</span></div><div class="line">ByteBuffer buf = ByteBuffer.wrap(input.getBytes());</div><div class="line">FileChannel fileChannel = openFile();</div><div class="line"><span class="comment">// NonWritableChannelException</span></div><div class="line"><span class="comment">// 将 openFile 改为 createFile 即可</span></div><div class="line">fileChannel.write(buf);</div><div class="line">fileChannel.close();</div><div class="line"></div><div class="line"><span class="comment">//=========Write Small Text to File============</span></div><div class="line">List&lt;String&gt; list = Collections.unmodifiableList(Arrays.asList(<span class="string">"hello"</span>, <span class="string">"world"</span>));</div><div class="line">Path path = Paths.get(fileName);</div><div class="line">Files.write(file, list, charset);</div><div class="line"></div><div class="line"><span class="comment">//=========Write Large Text to File============</span></div><div class="line">Path path = Paths.get(fileName);</div><div class="line"><span class="keyword">try</span> (BufferedWriter writer = Files.newBufferedWriter(path, charset)) &#123;</div><div class="line">	<span class="keyword">for</span> (String line: list) &#123;</div><div class="line">		writer.write(line);</div><div class="line">		writer.newLine();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//========Write Ints to File===============</span></div><div class="line"><span class="keyword">int</span>[] ints = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123; <span class="number">23</span>,<span class="number">456</span>,<span class="number">67</span>,<span class="number">45</span> &#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeIntsToFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	FileChannel fileChannel = createFile();</div><div class="line">	<span class="comment">// 4 可以替换为 Integer.SIZE / 8</span></div><div class="line">	ByteBuffer buf = ByteBuffer.allocate(ints.length * <span class="number">4</span>);</div><div class="line">	IntBuffer ib = buf.asIntBuffer();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;ints.length; i++) &#123;</div><div class="line">		ib.put(ints[i]);</div><div class="line">	&#125;</div><div class="line">	fileChannel.write(buf);</div><div class="line">	fileChannel.close();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">readIntsFromFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	FileChannel fileChannel = openFile();</div><div class="line">	ByteBuffer buf = ByteBuffer.allocate((<span class="keyword">int</span>) fileChannel.size());</div><div class="line">	IntBuffer = buf.asIntBuffer();</div><div class="line">	fileChannel.read(buf);</div><div class="line">	<span class="keyword">while</span> (ib.hasRemaining()) &#123;</div><div class="line">		System.out.println(ib.get());</div><div class="line">	&#125;</div><div class="line">	fileChannel.close();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">FileChannel <span class="title">openFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	Path path = Paths.get(fileName);</div><div class="line">	FileChannel fileChannel = FileChannel.open(path);</div><div class="line">	<span class="keyword">return</span> fileChannel();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">FileChannel <span class="title">createFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	Path path = Paths.get(filename);</div><div class="line">	FileChannel fileChannel = FileChannel.open(path, </div><div class="line">		EnumSet.of(StandardOpenOption.CREATE, </div><div class="line">				StandardOpenOption.TRUNCATE_EXISTING,</div><div class="line">				StandardOpenOption.WRITE));</div><div class="line">	<span class="keyword">return</span> fileChannel;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用-SocketChannel-来传输一个-Object"><a href="#使用-SocketChannel-来传输一个-Object" class="headerlink" title="使用 SocketChannel 来传输一个 Object"></a>使用 <code>SocketChannel</code> 来传输一个 <code>Object</code></h3><p>使用 <code>SocketChannel</code> 来接受对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Transfer a object over SocketChannel in non blocking mode</span></div><div class="line">Selector selector = Selector.open();</div><div class="line">ServerSocketChannel server = ServerSocketChannel.open();</div><div class="line">server.configureBlocking(<span class="keyword">false</span>);</div><div class="line">server.socket().bind(<span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">9000</span>));</div><div class="line">server.register(selector, SelectionKey.OP_ACCEPT);</div><div class="line"></div><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">	selector.select();</div><div class="line">	Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</div><div class="line">	<span class="keyword">while</span> (iterator.hasNext()) &#123;</div><div class="line">		SelectionKey key = iterator.next();</div><div class="line">		iterator.remove();</div><div class="line">		<span class="keyword">if</span> (key.isAcceptable()) &#123;</div><div class="line">			SocketChannel client = server.accept();</div><div class="line">			client.configureBlocking(<span class="keyword">false</span>);</div><div class="line">			client.register(selector, SelectionKey.OP_READ);</div><div class="line">			<span class="keyword">continue</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (key.isReadable()) &#123;</div><div class="line">			SocketChannel channel = key.channel();</div><div class="line">			getSocketObject(channel);</div><div class="line">			channel.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">getSocketObject</span><span class="params">(SocketChannel channel)</span> </span>&#123;</div><div class="line">	ByteBuffer data = ByteBuffer.allocate(<span class="number">100</span>);</div><div class="line">	channel.read(data);</div><div class="line">	ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(data.array());</div><div class="line">	ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(byteArrayInputStream);</div><div class="line">	Student student = (Student) objectInputStream.readObject();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 <code>SocketChannel</code> 来发送一个对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">Selector selector = Selector.open();</div><div class="line">SocketChannel clientSocket = SocketChannel.open();</div><div class="line">clientSocket.configureBlocking(<span class="keyword">false</span>);</div><div class="line">clientSocket.connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">9000</span>));</div><div class="line">clientSocket.register(selector, SelectionKey.OP_CONNECT);</div><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">	selector.select();</div><div class="line">	Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</div><div class="line">	iterator.remove();</div><div class="line">	SocketChannel client = (SocketChannel) key.channel();</div><div class="line">	<span class="comment">// Check a connection was established with a remote server</span></div><div class="line">	<span class="keyword">if</span> (key.isConnectable()) &#123;</div><div class="line">		<span class="keyword">if</span> (client.isConnectionPending()) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				client.finishConnect();</div><div class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">				</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		client.register(selector, SelectionKey.OP_WRITE);</div><div class="line">		<span class="keyword">continue</span>;	</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (key.isWritable()) &#123;</div><div class="line">		sendSocketObject(client);</div><div class="line">		client.close();</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendSocketObject</span><span class="params">(SocketChannel client)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	Student student = <span class="keyword">new</span> Student();</div><div class="line">	ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutptuStream();</div><div class="line"></div><div class="line">	ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</div><div class="line">	objectOutputStream.writeObject(student);</div><div class="line">	objectOutputStream.flush();</div><div class="line"></div><div class="line">	client.write(ByteBuffer.wrap(byteArrayOutputStream.toByteArray()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Transfer-Large-file-through-SocketChannel"><a href="#Transfer-Large-file-through-SocketChannel" class="headerlink" title="Transfer Large file through SocketChannel"></a>Transfer Large file through <code>SocketChannel</code></h3><p>从 <code>SocketChannel</code> 读取大文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">readFileFromSocketChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	Path path = Paths.get(<span class="string">"d:\\a.pdf"</span>);</div><div class="line">	FileChannel fileChannel = FileChannel.open(path, </div><div class="line">		EnumSet.of(StandardOpenOperation.CREATE, </div><div class="line">				StandardOpenOperation.TRUNCATE_EXISTING,</div><div class="line">				StandradOpenOperation.WRITE));</div><div class="line">	<span class="comment">// Allocate a ByteBuffer</span></div><div class="line">	ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</div><div class="line">	<span class="keyword">while</span> (socketChannel.read(buffer) &gt; <span class="number">0</span>) &#123;</div><div class="line">		buffer.flip();</div><div class="line">		fileChannel.write(buffer);</div><div class="line">		buffer.clear();</div><div class="line">	&#125;</div><div class="line">	fileChannel.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 <code>SocketChannel</code> 发送大文件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendFile</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	Path path = Paths.get(<span class="string">"d:\\src.pdf"</span>);</div><div class="line">	FileChannel inChannel = FileChannel.open(path);</div><div class="line">	</div><div class="line">	ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</div><div class="line">	<span class="keyword">while</span> (inChannel.read(buffer) &gt; <span class="number">0</span>) &#123;</div><div class="line">		buffer.flip();</div><div class="line">		socketChannel.write(buffer);</div><div class="line">		buffer.clear();</div><div class="line">	&#125;</div><div class="line">	socketChannel.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用-AsynchrousFileChannel-和-Future-来读取大文件"><a href="#使用-AsynchrousFileChannel-和-Future-来读取大文件" class="headerlink" title="使用 AsynchrousFileChannel 和 Future 来读取大文件"></a>使用 <code>AsynchrousFileChannel</code> 和 <code>Future</code> 来读取大文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">20</span>);</div><div class="line">Path path = Paths.get(FILENAME);</div><div class="line"></div><div class="line">AsynchronousFileChannel asyncChannel = AsynchronousFileChannel.open(path);</div><div class="line"><span class="keyword">int</span> pos = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">	<span class="comment">// read many times until done</span></div><div class="line">	Future&lt;Integer&gt; fileResult = asyncChannel.read(buffer, pos);</div><div class="line">	</div><div class="line">	<span class="comment">// wait if neccessary for the computation to complete, and then retrieves its result</span></div><div class="line">	Integer blockread = fileResult.get();</div><div class="line">	<span class="keyword">if</span> (blockread &lt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// read a next block with the current position</span></div><div class="line">	pos += blockread;</div><div class="line"></div><div class="line">	buffer.flip();</div><div class="line">	System.out.println(Charset.defaultCharset().decode(buffer));</div><div class="line">	buffer.clear();</div><div class="line">&#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</div></pre></td></tr></table></figure>
<h3 id="使用-AsynchonousFileChannel-和-CompletionHandler-来读取大文件"><a href="#使用-AsynchonousFileChannel-和-CompletionHandler-来读取大文件" class="headerlink" title="使用 AsynchonousFileChannel 和 CompletionHandler 来读取大文件"></a>使用 <code>AsynchonousFileChannel</code> 和 <code>CompletionHandler</code> 来读取大文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> capacity = <span class="number">4</span> * <span class="number">1024</span>;</div><div class="line">ByteBuffer buffer = ByteBuffer.allocate(capacity);</div><div class="line">String inFileName = <span class="string">"src.pdf"</span>;</div><div class="line">String outFileName = <span class="string">"dst.pdf"</span>;</div><div class="line"></div><div class="line">FileChannel fileChannel = FileChannel.open(Paths.get(inFileName));</div><div class="line">AsynchronousFileChannel outAsynchChannel = AsynchronousFileChannel.open(Paths.get(outFileName), </div><div class="line">	StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING, StandardOpenOption.WRITE);</div><div class="line"></div><div class="line">BlockingQueue&lt;Boolean&gt; done = <span class="keyword">new</span> ArrayBlockingQueue&lt;Boolean&gt;(<span class="number">1</span>);</div><div class="line"><span class="keyword">long</span> position = <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> receiveBytes;</div><div class="line"></div><div class="line"><span class="keyword">while</span> ((receiveBytes = inChannel.read(buffer)) &gt;= <span class="number">0</span>) &#123;</div><div class="line">	buffer.flip();</div><div class="line">	outAsynchChannel.write(buffer, position, done, <span class="keyword">new</span> CompletionHandler&lt;Integer, BlockingQueue&lt;Boolean&gt;&gt;() &#123;</div><div class="line">	</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, BlockingQueue&lt;Boolean&gt; attachment)</span> </span>&#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				attachment.put(<span class="keyword">true</span>);</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			&#125;</div><div class="line">		&#125;	</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, BlockingQueue&lt;Boolean&gt; attachment)</span> </span>&#123;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;);</div><div class="line"></div><div class="line">	done.take();</div><div class="line">	position += receiveBytes;</div><div class="line">	buffer.clear();</div><div class="line">&#125;</div><div class="line"></div><div class="line">inChannel.close();</div><div class="line">outAsynchChannel.close();</div></pre></td></tr></table></figure>
<h3 id="Transfer-data-using-DatagramChannel"><a href="#Transfer-data-using-DatagramChannel" class="headerlink" title="Transfer data using DatagramChannel"></a>Transfer data using <code>DatagramChannel</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ========Datagram Server==================</span></div><div class="line"></div><div class="line">DatagramChannel server = DatagramChannel.open();</div><div class="line">server.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">9100</span>));</div><div class="line"></div><div class="line"><span class="comment">// receive buffer from client</span></div><div class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</div><div class="line">SocketAddress remoteAddr = server.receive(buffer);</div><div class="line"></div><div class="line">String s = <span class="string">". I am server"</span>;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;s.length(); i++) &#123;</div><div class="line">	buffer.put((<span class="keyword">byte</span>) s.charAt(i));</div><div class="line">&#125;</div><div class="line"></div><div class="line">buffer.flip();</div><div class="line"></div><div class="line"><span class="comment">// Send a response string to client</span></div><div class="line">server.send(buffer, remoteAddr);</div><div class="line">server.close();</div><div class="line"></div><div class="line"><span class="comment">// =============Datagram Client================</span></div><div class="line">DatagramChannel client = DatagramChannel.open();</div><div class="line">client.bind(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">String msg = <span class="string">"hello"</span>;</div><div class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">100</span>);</div><div class="line">buffer.put(msg.getBytes());</div><div class="line">buffer.flip();</div><div class="line"></div><div class="line"><span class="comment">// send buffer to server</span></div><div class="line">InetSocketAddress serverAddr = <span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">9100</span>);</div><div class="line">client.send(buffer, serfverAddr);</div><div class="line"></div><div class="line"><span class="comment">// receive buffer from server</span></div><div class="line">buffer.clear();</div><div class="line">client.receive(buffer);</div><div class="line">buffer.flip();</div><div class="line"></div><div class="line"><span class="comment">// Convert ByteBuffer to string</span></div><div class="line"><span class="keyword">int</span> limit = buffer.limit();</div><div class="line"><span class="keyword">byte</span> bytes[] = <span class="keyword">new</span> <span class="keyword">byte</span>[limit];</div><div class="line">buffer.get(bytes, <span class="number">0</span>, limit);</div><div class="line">String s = <span class="keyword">new</span> String(bytes);</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/08/01/java-nio/" data-id="cjc5qrt2700435cem2uiwer8f" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-idea-eclipse" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/31/idea-eclipse/" class="article-date">
  <time datetime="2017-07-31T12:35:44.000Z" itemprop="datePublished">2017-07-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/31/idea-eclipse/">IDEA - Eclipse</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="IDEA"><a href="#IDEA" class="headerlink" title="IDEA"></a>IDEA</h2><h3 id="Intellij-Idea"><a href="#Intellij-Idea" class="headerlink" title="Intellij Idea"></a>Intellij Idea</h3><table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ctrl + X</code></td>
<td>剪切一行</td>
</tr>
<tr>
<td><code>Ctrl + Y</code></td>
<td>删除一行</td>
</tr>
<tr>
<td><code>Ctrl + D</code></td>
<td>复制一行</td>
</tr>
<tr>
<td><code>Ctrl + Alt + O</code></td>
<td>优化包的导入</td>
</tr>
<tr>
<td><code>Double shift</code></td>
<td>查找某个文件 (有时候会无法自动获得焦点)</td>
</tr>
<tr>
<td><code>Ctrl + N</code></td>
<td>查找类</td>
</tr>
<tr>
<td><code>Ctrl + Shift + N</code></td>
<td>查找文件</td>
</tr>
<tr>
<td><code>Alt + ←/→</code></td>
<td>在 Tab 间切换</td>
</tr>
<tr>
<td><code>Ctrl + F4</code></td>
<td>关闭 Tab</td>
</tr>
<tr>
<td><code>Shift + F6</code></td>
<td>重命名</td>
</tr>
<tr>
<td><code>Ctrl + Shift + A</code></td>
<td>搜索某个命令</td>
</tr>
<tr>
<td><code>Alt + Insert</code></td>
<td>生成各种方法</td>
</tr>
<tr>
<td><code>Ctrl + F2</code></td>
<td>停止</td>
</tr>
<tr>
<td><code>Ctrl + F12</code></td>
<td>显示所有方法</td>
</tr>
<tr>
<td><code>Ctrl + Q</code></td>
<td>显示快捷帮助文档</td>
</tr>
</tbody>
</table>
<h3 id="设置-SDK"><a href="#设置-SDK" class="headerlink" title="设置 SDK"></a>设置 SDK</h3><p><img src="2017_08_30_15_16_35.png" alt=""></p>
<h3 id="设置背景颜色"><a href="#设置背景颜色" class="headerlink" title="设置背景颜色"></a>设置背景颜色</h3><p><img src="2017_08_30_15_23_33.png" alt=""></p>
<h3 id="设置字体大小"><a href="#设置字体大小" class="headerlink" title="设置字体大小"></a>设置字体大小</h3><p><img src="2017_08_30_15_25_57.png" alt=""></p>
<h3 id="传递-System-getProperty-参数"><a href="#传递-System-getProperty-参数" class="headerlink" title="传递 System.getProperty 参数"></a>传递 <code>System.getProperty</code> 参数</h3><p><img src="2017_09_01_13_01_10.png" alt=""></p>
<p>使用这个接受参数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String wsDomainName = System.getProperty(<span class="string">"rocketmq.namesrv.domain"</span>, DEFAULT_NAMESRV_ADDR_LOOKUP);</div></pre></td></tr></table></figure>
<h3 id="搜索问题"><a href="#搜索问题" class="headerlink" title="搜索问题"></a>搜索问题</h3><p>默认按下 <code>Ctrl + F</code> 是含有正则表达式的，所以如果想要搜索 <code>send(Message msg)</code> 这样的字眼，那就得需要将括号进行转义处理:</p>
<p><img src="2017_09_03_22_10_26.png" alt=""></p>
<h3 id="自动添加序列化-ID"><a href="#自动添加序列化-ID" class="headerlink" title="自动添加序列化 ID"></a>自动添加序列化 ID</h3><p><img src="2017_09_18_09_34_06.png" alt=""></p>
<p>设置上这个之后，<code>IDEA</code> 还是不会自动添加序列化 ID，但是当你在类上按下 <strong><code>Ctrl + Enter</code></strong> 的时候，它可以提示你添加序列化 ID 了。</p>
<h3 id="调节文件结束符"><a href="#调节文件结束符" class="headerlink" title="调节文件结束符"></a>调节文件结束符</h3><p><img src="idea-line-separator.png" alt=""></p>
<h3 id="创建文件的时候自动在类上面添加文件头"><a href="#创建文件的时候自动在类上面添加文件头" class="headerlink" title="创建文件的时候自动在类上面添加文件头"></a>创建文件的时候自动在类上面添加文件头</h3><p><img src="2017_09_28_10_57_38.png" alt=""></p>
<h3 id="format-code-快捷键冲突"><a href="#format-code-快捷键冲突" class="headerlink" title="format code 快捷键冲突"></a>format code 快捷键冲突</h3><p><img src="2017_10_10_09_39_36.png" alt=""></p>
<h3 id="后退-前进冲突"><a href="#后退-前进冲突" class="headerlink" title="后退/前进冲突"></a>后退/前进冲突</h3><p><img src="2017_10_10_09_40_14.png" alt=""></p>
<h3 id="找到代码块的起始-结束花括号"><a href="#找到代码块的起始-结束花括号" class="headerlink" title="找到代码块的起始/结束花括号"></a>找到代码块的起始/结束花括号</h3><ul>
<li>You can use <strong><code>Ctrl + [</code></strong> and <strong><code>Ctrl + ]</code></strong> to navigate to a code block’s start and end.</li>
<li>You can also use <strong><code>Ctrl + Shift + M</code></strong> to navigate between the start and end of a code block.</li>
</ul>
<h3 id="不用鼠标，跳转到-Function-所在的实现"><a href="#不用鼠标，跳转到-Function-所在的实现" class="headerlink" title="不用鼠标，跳转到 Function 所在的实现"></a>不用鼠标，跳转到 <code>Function</code> 所在的实现</h3><p><code>Ctrl + B</code></p>
<h3 id="不显示项目文件目录结构了"><a href="#不显示项目文件目录结构了" class="headerlink" title="不显示项目文件目录结构了"></a>不显示项目文件目录结构了</h3><p>删除 <code>.idea</code> 目录结构,然后重新打开这个项目</p>
<h3 id="移动行"><a href="#移动行" class="headerlink" title="移动行"></a>移动行</h3><ul>
<li><code>ALT + SHIFT + ↑</code></li>
<li><code>ALT + SHIFT + ↓</code></li>
</ul>
<h3 id="PlantUML"><a href="#PlantUML" class="headerlink" title="PlantUML"></a>PlantUML</h3><p>通过安装 <a href="http://plantuml.com/" target="_blank" rel="external">PlantUML</a> 来让 <code>idea</code> 支持绘制时序图， <code>Ubuntu</code> 系统需要安装:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install graphviz</div></pre></td></tr></table></figure>
<p>才能正确显示</p>
<h3 id="如何安装插件"><a href="#如何安装插件" class="headerlink" title="如何安装插件"></a>如何安装插件</h3><p><img src="2017_11_06_20_48_04.png" alt=""></p>
<h3 id="查找注解类的-Find-Usage"><a href="#查找注解类的-Find-Usage" class="headerlink" title="查找注解类的 Find Usage"></a>查找注解类的 <code>Find Usage</code></h3><p>注解类的 <code>Find Usage</code> 是无法找到的，在 <code>idea</code> 中直接 <code>Find Usage</code> 这个 <code>@Select</code> 注解是无法找到相关使用的:</p>
<p><img src="2018_01_06_13_25_15.png" alt="find_usage_annotation"></p>
<p>目前想到的一个暂时解决方案就是使用 <code>grep</code> 来搜索:</p>
<p><img src="2018_01_06_13_26_08.png" alt="grep"></p>
<h2 id="Eclipse"><a href="#Eclipse" class="headerlink" title="Eclipse"></a>Eclipse</h2><h3 id="打开资源"><a href="#打开资源" class="headerlink" title="打开资源"></a>打开资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 打开代码类</span></div><div class="line">Ctrl + Shift + T</div><div class="line"><span class="comment"># 打开文件</span></div><div class="line">Ctrl + Shift + R</div></pre></td></tr></table></figure>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p><code>Eclipse</code> 是<strong>双击打断点</strong></p>
<p><img src="2017_12_28_22_29_30.png" alt="断点说明"></p>
<p>这三个按钮的意思是:</p>
<ul>
<li><strong>Step Into</strong></li>
<li><strong>Step Over</strong></li>
<li><strong>Step Return</strong></li>
</ul>
<h3 id="进入方法的定义"><a href="#进入方法的定义" class="headerlink" title="进入方法的定义"></a>进入方法的定义</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">F3</div></pre></td></tr></table></figure>
<p><a href="http://www.cnblogs.com/yanyansha/archive/2011/08/30/2159265.html" target="_blank" rel="external">快捷键</a>的网站</p>
<h3 id="查看接口的实现"><a href="#查看接口的实现" class="headerlink" title="查看接口的实现"></a>查看接口的实现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 快捷窗口查看</span></div><div class="line">Ctrl + T</div></pre></td></tr></table></figure>
<p>另外一种方法是按下 <code>F4</code> 按钮:</p>
<p><img src="2017_12_29_21_13_36.png" alt="继承树"></p>
<h3 id="回退和前进"><a href="#回退和前进" class="headerlink" title="回退和前进"></a>回退和前进</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Alt + ←</div><div class="line">Alt + →</div></pre></td></tr></table></figure>
<h3 id="查找方法哪里被使用了"><a href="#查找方法哪里被使用了" class="headerlink" title="查找方法哪里被使用了"></a>查找方法哪里被使用了</h3><p>选中右击 -&gt; <strong>“Open Call Hierarchy”</strong></p>
<h3 id="Eclipse-Console-输出重定向到文件"><a href="#Eclipse-Console-输出重定向到文件" class="headerlink" title="Eclipse Console 输出重定向到文件"></a>Eclipse Console 输出重定向到文件</h3><p><img src="2017_12_29_23_28_23.png" alt="eclipse_console_redirect"></p>
<h3 id="查看方法的父类定义"><a href="#查看方法的父类定义" class="headerlink" title="查看方法的父类定义"></a>查看方法的父类定义</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Alt + N, S</div></pre></td></tr></table></figure>
<p><strong>或者</strong>，按住 <code>Ctrl</code> 键，鼠标指向方法名，<strong>“Open super implementation”</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/31/idea-eclipse/" data-id="cjc5qrt1r003m5cemc0laes2u" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/blog/page/8/">&laquo; Prev</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/7/">7</a><a class="page-number" href="/blog/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/blog/page/10/">10</a><a class="page-number" href="/blog/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/23/">23</a><a class="extend next" rel="next" href="/blog/page/10/">Next&raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    

  
    
  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/01/06/where-the-time-actually-gone/">时间都去哪儿了</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/dev-reflection/">开发反思</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/my-microblog/">我的微博</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/gcc-basic/">gcc-basic</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/java-internal/">Java Internal</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>