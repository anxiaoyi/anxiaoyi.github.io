<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="赵坤的个人网站">
<meta property="og:type" content="website">
<meta property="og:title" content="代码人生">
<meta property="og:url" content="http://blog.kunzhao.org/page/17/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="赵坤的个人网站">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码人生">
<meta name="twitter:description" content="赵坤的个人网站">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-http" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/26/http/" class="article-date">
  <time datetime="2017-06-26T14:50:27.000Z" itemprop="datePublished">2017-06-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/26/http/">HTTP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><h3 id="HTTP-1-1"><a href="#HTTP-1-1" class="headerlink" title="HTTP 1.1"></a>HTTP 1.1</h3><p>新特性:</p>
<ul>
<li><strong>持久连接</strong>: 客户端发送 <code>connection: keep-alive</code> 与服务器建立持久连接</li>
<li><strong>块编码</strong>: <code>transfer-encoding</code> 指明字节流将会分块发送，没一个块的长度以十六进制表示，其后会有一个回车换行符，然后是具体数据:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">I&apos;m as helpless as a kitten up a tree</div></pre></td></tr></table></figure>
<p>实际发送为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1D\r\n</div><div class="line">I&apos;m as helpless as a kitten u</div><div class="line">9\r\n</div><div class="line">p a tree</div><div class="line">T0\r\n</div></pre></td></tr></table></figure>
<ul>
<li><strong>状态码 100</strong>: 当客户单准备发送一个较长的请求体，而不确定服务端是否会接受，就可能发送一个 <code>Expect: 100-continue</code> 信息，如果接受，则会响应 <code>HTTP/1.1 100 Continue</code>:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Expect: 100-continue</div><div class="line">HTTP/1.1 100 Continue\r\n</div></pre></td></tr></table></figure>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>服务器用 HTTP/1.0+ 的 <code>Expires</code> 首部或 HTTP/1.1 的 <code>Cache-Control: max-age</code> 响应首部来<strong>指定过期日期</strong>，同时还会带有响应主体。<code>Expires</code> 首部和<code>Cache-Control: max-age</code> 首部本质上做的事情是一样的，但是由于 <strong><code>Cache-Control: max-age</code> 首部使用的是相对时间(秒)而不是绝对日期</strong>，因此我们更倾向于使用比较新的 <code>Cache-Control: max-age</code> 首部。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Expires: Fri, 05 Jul 2017, 05:00:00 GMT</div><div class="line">Cache-Control: max-age=60</div></pre></td></tr></table></figure>
<h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><p>可以笼统地将 Cookie 分为两类: <strong>会话 Cookie 和持久 Cookie</strong>，它们之间<strong>唯一的区别就是它们的过期时间</strong>。服务器通过 <code>Set-Cookie</code> 或 <code>Set-Cookie2</code> HTTP 响应首部将其贴到用户身上去:</p>
<p><img src="17-07-09-16_23_26_730_544.png" alt=""></p>
<p>产生 Cookie 的服务器可以向 <code>Set-Cookie</code> 响应首部添加一个 <code>Domain</code> 属性来控制哪些站点可以看到那个 Cookie，像下面这样写可以实现所以以 <code>baidu.com</code> 结尾的网站都能看到这个 Cookie:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Set-Cookie: user=&quot;mary17&quot;; domain=&quot;baidu.com&quot;</div></pre></td></tr></table></figure>
<h3 id="HTTPS-具体数据传输流程"><a href="#HTTPS-具体数据传输流程" class="headerlink" title="HTTPS 具体数据传输流程"></a>HTTPS 具体数据传输流程</h3><h3 id="HTTP-状态码"><a href="#HTTP-状态码" class="headerlink" title="HTTP 状态码"></a>HTTP 状态码</h3><ul>
<li><strong>301</strong>: 永久移动</li>
<li><strong>302</strong>: 临时移动</li>
</ul>
<p><img src="2017_09_11_09_49_57.png" alt=""></p>
<ul>
<li><strong>429: TOO MANY REQUESTS</strong></li>
<li><strong>502: BAD GATEWAY</strong></li>
</ul>
<hr>
<p>参考:</p>
<ul>
<li><a href="https://httpstatuses.com/" target="_blank" rel="external">HTTP Status Codes</a></li>
</ul>
<h3 id="Http-Proxy-代理"><a href="#Http-Proxy-代理" class="headerlink" title="Http Proxy 代理"></a>Http Proxy 代理</h3><p>Web proxies <strong>转发</strong> HTTP requests. The request from the client is the same as a regular HTTP request except the <strong>full URL is passed</strong>, instead of just the path.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">GET http://en.wikipedia.org/wiki/Proxy_server HTTP/1.1</div><div class="line">Proxy-Authorization: Basic encoded-credentials</div><div class="line">Accept: text/html</div></pre></td></tr></table></figure>
<p>This request is sent to the proxy server, the proxy makes the request specified and returns the response.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Type: text/html; charset UTF-8</div></pre></td></tr></table></figure>
<p>Some web proxies allow the <code>HTTP CONNECT</code> method to set up forwarding of arbitrary data through the connection; a common policy is to only forward port 443 to allow HTTPS traffic.</p>
<h4 id="Reverse-proxies-反向代理"><a href="#Reverse-proxies-反向代理" class="headerlink" title="Reverse proxies 反向代理"></a>Reverse proxies 反向代理</h4><p>A reverse proxy taking requests from the Internet and forwarding them to servers in an <strong>internal network</strong>. Those making requests connect to the proxy and may not be aware of the internal network.</p>
<p><img src="560px-Reverse_proxy_h2g2bob.svg.png" alt="反向代理"></p>
<h4 id="Open-proxies-开放代理"><a href="#Open-proxies-开放代理" class="headerlink" title="Open proxies 开放代理"></a>Open proxies 开放代理</h4><p>An open proxy forwarding requests from and to anywhere on the Internet.</p>
<p><img src="560px-Open_proxy_h2g2bob.svg.png" alt="开放代理"></p>
<h3 id="Firewall-防火墙"><a href="#Firewall-防火墙" class="headerlink" title="Firewall 防火墙"></a>Firewall 防火墙</h3><p>In computing, a firewall is a <strong>network security</strong> system that monitors and controls <strong>incoming and outgoing (进来和出去的流量)</strong> network traffic based on predetermined <strong>security rules (安全规则)</strong>. A firewall typically establishes a barrier between a trusted internal network and untrusted outside network, such as the Internet.</p>
<p><img src="440px-Firewall.png" alt="防火墙的位置"></p>
<h4 id="Network-layer-or-packet-filters-包过滤"><a href="#Network-layer-or-packet-filters-包过滤" class="headerlink" title="Network layer or packet filters 包过滤"></a>Network layer or packet filters 包过滤</h4><p>Newer firewalls can filter traffic based on many <strong>packet attributes</strong> like source IP address, source port, destination IP address or port, destination service like HTTP or FTP. They can filter based on <strong>protocols (协议)</strong>, <strong>TTL values (TTL 值)</strong>, network block of the originator, of the source, and many other attributes.</p>
<h4 id="Network-address-translation"><a href="#Network-address-translation" class="headerlink" title="Network address translation"></a>Network address translation</h4><p>Firewalls often have <strong>network address translation (NAT) functionality</strong>, and the hosts protected behind a firewall commonly have addresses in the “private address range”</p>
<h3 id="HTTP-Method"><a href="#HTTP-Method" class="headerlink" title="HTTP Method"></a>HTTP Method</h3><p>The HTTP/1.0 specification defined the <strong>GET, POST and HEAD</strong> methods and the HTTP/1.1 specification added 5 new methods: <strong>OPTIONS, PUT, DELETE, TRACE and CONNECT</strong>.</p>
<h4 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a>HEAD</h4><p>The <code>HEAD</code> method asks for a response identical to that of a <code>GET</code> request, but <strong>without the response body (不要 body 部分)</strong>. This is useful for retrieving meta-information written in response headers, without having to transport the entire content.</p>
<h4 id="OPTIONS"><a href="#OPTIONS" class="headerlink" title="OPTIONS"></a>OPTIONS</h4><p>The <code>OPTIONS</code> method returns the <strong>HTTP methods</strong> that the server supports for the specified URL. This can be used to check the functionality of a web server by requesting ‘*’ instead of a specific resource.</p>
<h4 id="CONNECT"><a href="#CONNECT" class="headerlink" title="CONNECT"></a>CONNECT</h4><p>The <code>CONNECT</code> method converts the request connection to a transparent TCP/IP tunnel, usually to facilitate SSL-encrypted communication (HTTPS) through an unencrypted HTTP proxy.</p>
<h3 id="HTTP-代理认证"><a href="#HTTP-代理认证" class="headerlink" title="HTTP 代理认证"></a>HTTP 代理认证</h3><p>当使用 <code>HttpClient</code> 设置<strong>代理认证</strong>的时候:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">BasicCredentialsProvider credentialsProvider = <span class="keyword">new</span> BasicCredentialsProvider();</div><div class="line">credentialsProvider</div><div class="line">    .setCredentials(<span class="keyword">new</span> AuthScope(<span class="string">"127.0.0.1"</span>, <span class="number">8002</span>),</div><div class="line">                    <span class="keyword">new</span> UsernamePasswordCredentials(<span class="string">"usernamezhaokun"</span>, <span class="string">"password123456"</span>));</div><div class="line">clientBuilder.setDefaultCredentialsProvider(credentialsProvider);</div></pre></td></tr></table></figure>
<p>实际上，这个代理认证的用户名和密码将会被添加进 <strong><code>header</code></strong> 里面:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String creds = USERNAME + <span class="string">":"</span> + PASSWORD;</div><div class="line">String authValue = org.apache.commons.codec.binary.Base64.encodeBase64String(creds.getBytes());</div><div class="line">String finalValue = <span class="string">"Basic "</span> + authValue;</div><div class="line">request.headers().add(<span class="string">"Proxy-Authorization"</span>, finalValue);</div></pre></td></tr></table></figure>
<p>实际的抓包也验证了我们的想法:</p>
<p><img src="2018_01_06_00_47_45.png" alt="authorization"></p>
<p><strong><code>Realm</code> 问题</strong>:</p>
<p><a href="http://tools.ietf.org/html/rfc1945#section-11" target="_blank" rel="external">From RFC 1945 (HTTP/1.0)</a> and <a href="http://tools.ietf.org/html/rfc2617#page-3" target="_blank" rel="external">RFC 2617 (HTTP Authentication referenced by HTTP/1.1)</a></p>
<p>The <code>realm</code> attribute (<strong>大小写不敏感</strong>) is required for all authentication schemes which issue a challenge. The <code>realm</code> value (<strong>大小写敏感</strong>), in combination with the canonical <strong>root URL (根 URL)</strong> of the server being accessed, defines the <strong>protection space (保护空间)</strong>. These realms allow the protected resources on a server to be <strong>partitioned (划分为几部分)</strong> into a set of protection spaces, each with its own authentication scheme and/or authorization database. The realm value is a string, generally assigned by the origin server, which may have additional semantics specific to the authentication scheme.</p>
<p>In short, pages in the same realm should share credentials. If your credentials work for a page with the realm “My Realm”, it should be assumed that the same username and password combination should work for another page with the same realm.</p>
<p><strong>Basic access authentication</strong>:</p>
<p>In the context of an <strong>HTTP transaction (HTTP 事务)</strong>, basic access authentication is a <strong>method</strong> for an HTTP user agent to provide a <strong>user name (用户名)</strong> and <strong>password (密码)</strong> when making a request.</p>
<p><strong>HTTP Basic authentication (BA)</strong> implementation is the <strong>simplest (最简单的)</strong> technique for enforcing access controls to web resources because it does not require cookies, session identifiers, or login pages; rather, HTTP Basic authentication uses standard fields in the <strong>HTTP header (HTTP 头)</strong>, removing the need for handshakes.</p>
<p>Server Side: When the server wants the user agent to authenticate itself towards the server, the server must respond appropriately to unauthenticated requests. To unauthenticated requests, the server should <strong>return a response (返回一个响应)</strong> whose header contains a HTTP <code>401</code> Unauthorized status and a <code>WWW-Authenticate</code> field. The <code>WWW-Authenticate</code> field for basic authentication (used most often) is constructed as following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">WWW-Authenticate: Basic realm=&quot;User Visible Realm&quot;</div></pre></td></tr></table></figure>
<p>Client Side: 需要发送：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Authorization: Basic QWxhZGRpbjpPcGVuU2VzYW1l</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://stackoverflow.com/questions/12701085/what-is-the-realm-in-basic-authentication" target="_blank" rel="external">What is the “realm” in basic authentication</a></li>
<li><a href="https://en.wikipedia.org/wiki/Basic_access_authentication" target="_blank" rel="external">Basic access authentication</a></li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://item.jd.com/10913619.html" target="_blank" rel="external">《深入剖析 Tomcat》</a></li>
<li><a href="https://item.jd.com/11056556.html" target="_blank" rel="external">《HTTP 权威指南》</a></li>
<li><a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching" target="_blank" rel="external">HTTP 缓存</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/26/http/" data-id="cjc5qrt1t003o5cemcqa09na0" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Emacs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/23/Emacs/" class="article-date">
  <time datetime="2017-06-23T01:39:28.000Z" itemprop="datePublished">2017-06-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/23/Emacs/">Emacs</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Emacs"><a href="#Emacs" class="headerlink" title="Emacs"></a>Emacs</h2><h3 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h3><p><a href="https://www.gnu.org/software/emacs/" target="_blank" rel="external">GNU Emacs</a></p>
<h3 id="初始文件"><a href="#初始文件" class="headerlink" title="初始文件"></a>初始文件</h3><ul>
<li><code>~/.emacs</code></li>
<li><code>~/.emacs.el</code></li>
<li><code>~/.emacs.d/init.el</code></li>
</ul>
<p><a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Init-File.html" target="_blank" rel="external">The Emacs Initialization File</a></p>
<h3 id="修改主题"><a href="#修改主题" class="headerlink" title="修改主题"></a>修改主题</h3><p><a href="https://github.com/emacs-jp/replace-colorthemes" target="_blank" rel="external">color-theme-modern</a>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">M-x package-install [RET] color-theme-modern [RET]</div></pre></td></tr></table></figure>
<p>手动配置加载主题:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">add-to-list</span> 'custom-theme-load-path <span class="string">"~/.emacs.d/elpa/color-theme-modern-20161219.344"</span>)</div><div class="line">(<span class="name">load-theme</span> 'tango-dark <span class="literal">t</span>)</div></pre></td></tr></table></figure>
<p><code>Alt+x customize-themes</code></p>
<h3 id="安装-Emacs-25-2"><a href="#安装-Emacs-25-2" class="headerlink" title="安装 Emacs 25.2"></a>安装 Emacs 25.2</h3><ul>
<li>可以修复无法下载安装插件的问题，<a href="http://ubuntuhandbook.org/index.php/2016/09/install-gnu-emacs-25-1-in-ubuntu-16-04/" target="_blank" rel="external">安装教程</a></li>
<li>可能遇见的缺少 X 界面库的问题: <a href="https://askubuntu.com/questions/213873/what-library-i-need-to-install-if-i-want-to-compile-emacs" target="_blank" rel="external">解决方案</a></li>
<li>可能会提示系统缺少 <code>autoconf</code>: <code>sudo apt install autoconf</code></li>
<li>下载 <code>Emacs</code> 源码的时候，不要直接命名文件夹为 <code>emacs</code>，否则最后编译脚本最后 <code>ln -s</code> 创建一个名为 <code>emacs</code> 的别名的时候，会提示文件已经存在</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install build-essential texinfo libx11-dev libxpm-dev libjpeg-dev libpng-dev libgif-dev libtiff-dev libgtk2.0-dev libncurses-dev </div><div class="line"><span class="comment"># for gtk3 build replace libgtk2.0-dev with libgtk-3-dev</span></div><div class="line"></div><div class="line">git <span class="built_in">clone</span> --depth=1 git://git.savannah.gnu.org/emacs.git</div><div class="line">sudo apt-get install autoconf <span class="comment"># not needed if it exist</span></div><div class="line"><span class="built_in">cd</span> emacs</div><div class="line">./autogen.sh <span class="comment"># not needed when installing from tarball</span></div><div class="line">./configure --with-gnutls=no</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<blockquote>
<p>The compile time is very long.</p>
</blockquote>
<h3 id="Emacs-包"><a href="#Emacs-包" class="headerlink" title="Emacs 包"></a>Emacs 包</h3><ul>
<li><a href="https://melpa.org/#/getting-started" target="_blank" rel="external">melpa</a></li>
<li><a href="https://github.com/emacs-china/elpa" target="_blank" rel="external">中国镜像</a></li>
</ul>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(<span class="name">require</span> 'package) <span class="comment">;; You might already have this line</span></div><div class="line">(<span class="name">add-to-list</span> 'package-archives</div><div class="line">             '(<span class="string">"melpa"</span> . <span class="string">"https://melpa.org/packages/"</span>))</div><div class="line">(<span class="name">when</span> (<span class="name">&lt;</span> emacs-major-version <span class="number">24</span>)</div><div class="line">  <span class="comment">;; For important compatibility libraries like cl-lib</span></div><div class="line">  (<span class="name">add-to-list</span> 'package-archives '(<span class="string">"gnu"</span> . <span class="string">"http://elpa.gnu.org/packages/"</span>)))</div><div class="line">(<span class="name">package-initialize</span>) <span class="comment">;; You might already have this line</span></div></pre></td></tr></table></figure>
<p>也可以尝试一下这样写 (<strong>Working</strong>):</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="name">require</span> 'package)</div><div class="line">(<span class="name">setq</span> package-archives '((<span class="string">"gnu"</span>   . <span class="string">"http://elpa.emacs-china.org/gnu/"</span>)</div><div class="line">                         (<span class="string">"melpa"</span> . <span class="string">"http://elpa.emacs-china.org/melpa/"</span>)))</div><div class="line">(<span class="name">package-initialize</span>)</div></pre></td></tr></table></figure>
<h3 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="name">setq</span> url-proxy-services</div><div class="line">   '((<span class="string">"no_proxy"</span> . <span class="string">"^\\(localhost\\|10.*\\)"</span>)</div><div class="line">     (<span class="string">"http"</span> . <span class="string">"address:8001"</span>)</div><div class="line">     (<span class="string">"https"</span> . <span class="string">"address:8002"</span>)))</div></pre></td></tr></table></figure>
<h3 id="设置窗口大小"><a href="#设置窗口大小" class="headerlink" title="设置窗口大小"></a>设置窗口大小</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">setq</span> initial-frame-alist</div><div class="line">      '(</div><div class="line">        (width . <span class="number">112</span>) ; character</div><div class="line">        (height . <span class="number">14</span>) ; lines</div><div class="line">        ))</div></pre></td></tr></table></figure>
<h3 id="隐藏欢迎信息"><a href="#隐藏欢迎信息" class="headerlink" title="隐藏欢迎信息"></a>隐藏欢迎信息</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;; no startup msg</span></div><div class="line">(<span class="name">setq</span> inhibit-startup-message <span class="literal">t</span>)        <span class="comment">; Disable startup message</span></div></pre></td></tr></table></figure>
<h3 id="查找和匹配"><a href="#查找和匹配" class="headerlink" title="查找和匹配"></a>查找和匹配</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 替换</div><div class="line">y</div><div class="line"># 回到上一个出现的位置</div><div class="line">^</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/23/Emacs/" data-id="cjc5qrsub00025cemvg33vrkd" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Redis八" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/20/Redis八/" class="article-date">
  <time datetime="2017-06-20T08:36:56.000Z" itemprop="datePublished">2017-06-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/20/Redis八/">Redis 八 - 数据库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Redis-八-数据库"><a href="#Redis-八-数据库" class="headerlink" title="Redis 八 - 数据库"></a>Redis 八 - 数据库</h2><p>涉及文件 <code>redis.h</code></p>
<h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// redis.h</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_DEFAULT_DBNUM     16</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">    <span class="comment">/* array */</span></div><div class="line">    redisDb *db;</div><div class="line">    <span class="keyword">int</span> dbnum;                      <span class="comment">/* Total number of configured DBs */</span></div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="切换数据库"><a href="#切换数据库" class="headerlink" title="切换数据库"></a>切换数据库</h3><p>当前正在使用的数据库:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// redis.h</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisClient</span> &#123;</span></div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">    redisDb *db;</div><div class="line">    <span class="comment">/* ... */</span></div><div class="line">&#125; redisClient;</div></pre></td></tr></table></figure>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Redis database representation. There are multiple databases identified</span></div><div class="line"><span class="comment"> * by integers from 0 (the default database) up to the max configured</span></div><div class="line"><span class="comment"> * database. The database number is the 'id' field in the structure. */</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></div><div class="line">    dict *dict;                 <span class="comment">/* The keyspace for this DB */</span></div><div class="line">    dict *expires;              <span class="comment">/* Timeout of keys with a timeout set */</span></div><div class="line">    dict *blocking_keys;        <span class="comment">/* Keys with clients waiting for data (BLPOP) */</span></div><div class="line">    dict *ready_keys;           <span class="comment">/* Blocked keys that received a PUSH */</span></div><div class="line">    dict *watched_keys;         <span class="comment">/* WATCHED keys for MULTI/EXEC CAS */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evictionPoolEntry</span> *<span class="title">eviction_pool</span>;</span>    <span class="comment">/* Eviction pool of keys */</span></div><div class="line">    <span class="keyword">int</span> id;                     <span class="comment">/* Database ID */</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> avg_ttl;          <span class="comment">/* Average TTL, just for stats */</span></div><div class="line">&#125; redisDb;</div></pre></td></tr></table></figure>
<p><code>dict</code> 字典保存了数据库中的所有键值对。<code>SET, DEL, GET</code> 等都是对这个 <code>dict</code> 进行的添加、更新或者操作，<code>FLUSHDB</code> 删除所有键值对，<code>RANDOMKEY</code> 随机返回一个键，还有 <code>DBSIZE, EXISTS, RENAME, KEYS</code> 等操作。</p>
<h3 id="过期时间"><a href="#过期时间" class="headerlink" title="过期时间"></a>过期时间</h3><p><code>redisDb</code> 结构体的 <code>expires</code> 数组保存了所有带有键的过期时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redisDb.expires[key] = expire_time_in_ms</div></pre></td></tr></table></figure>
<h3 id="过期键删除策略"><a href="#过期键删除策略" class="headerlink" title="过期键删除策略"></a>过期键删除策略</h3><p>Redis 服务器实际使用的是<strong>惰性删除和定期删除</strong>两种策略</p>
<p>位于 <code>db.c</code> 文件中的 <code>expireIfNeeded</code> 函数实现惰性删除策略:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">expireIfNeeded</span><span class="params">(redisDb *db, robj *key)</span> </span>&#123;</div><div class="line">    <span class="keyword">mstime_t</span> when = getExpire(db,key);</div><div class="line">    <span class="keyword">mstime_t</span> now;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (when &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* No expire for this key */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Don't expire anything while loading. It will be done later. */</span></div><div class="line">    <span class="keyword">if</span> (server.loading) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">    now = server.lua_caller ? server.lua_time_start : mstime();</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (server.masterhost != <span class="literal">NULL</span>) <span class="keyword">return</span> now &gt; when;</div><div class="line"></div><div class="line">    <span class="comment">/* Return when this key has not expired */</span></div><div class="line">    <span class="keyword">if</span> (now &lt;= when) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Delete the key */</span></div><div class="line">    server.stat_expiredkeys++;</div><div class="line">    propagateExpire(db,key);</div><div class="line">    notifyKeyspaceEvent(REDIS_NOTIFY_EXPIRED,</div><div class="line">                        <span class="string">"expired"</span>,key,db-&gt;id);</div><div class="line">    <span class="keyword">return</span> dbDelete(db,key);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>惰性删除对 CPU 是友好的，程序只会在取出键时才会对键进行过期检查，这可以保证删除过期键的操作只会在非做不可的情况下进行，但其缺点也很明显，它对内存不友好。那么就需要定时删除策略进行一个整合和折中:</p>
<h3 id="数据库通知"><a href="#数据库通知" class="headerlink" title="数据库通知"></a>数据库通知</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// notify.c</span></div><div class="line">notifyKeyspaceEvent(<span class="keyword">int</span> type, <span class="keyword">char</span> *event, robj *key, <span class="keyword">int</span> dbid)</div></pre></td></tr></table></figure>
<h3 id="RDB-持久化"><a href="#RDB-持久化" class="headerlink" title="RDB 持久化"></a>RDB 持久化</h3><p>(1) <strong>RDB 持久化功能生成的是一个经过压缩的二进制文件</strong>，通过该文件可以还原生成 RDB 文件时的数据库状态:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// 同步保存</div><div class="line">127.0.0.1:6379[1]&gt; SAVE</div><div class="line">OK</div><div class="line">// 异步保存</div><div class="line">127.0.0.1:6379[1]&gt; BGSAVE</div><div class="line">Background saving started</div></pre></td></tr></table></figure>
<p>执行 <code>SAVE</code> 和 <code>BGSAVE</code> 命令的源代码为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// rdb.c</div><div class="line">int rdbSave(char *filename)</div></pre></td></tr></table></figure>
<p>在我本机上保存在了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/var/lib/redis/dump.rdb</div></pre></td></tr></table></figure>
<p>(2) 只要 Redis 服务器在启动时检测到有 RDB 文件，它就会自动加载 RDB 文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ redis-server</div><div class="line">...</div><div class="line">10648:M 03 Jul 10:48:39.006 * DB loaded from disk: 0.000 seconds</div><div class="line">...</div></pre></td></tr></table></figure>
<p>载入 <code>RDB</code> 文件的实现位于:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// rdb.c</div><div class="line">int rdbLoad(char *filename)</div></pre></td></tr></table></figure>
<p>(3) 校验 <code>dump.rdb</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">zk@zk-pc:/var/lib/redis$ redis-check-dump dump.rdb </div><div class="line">==== Processed 3 valid opcodes (in 18 bytes) ===================================</div><div class="line">CRC64 checksum is OK</div></pre></td></tr></table></figure>
<p>(4) 其他资源</p>
<p><a href="https://github.com/sripathikrishnan/redis-rdb-tools" target="_blank" rel="external">redis-rdb-tools</a> 可以将 <code>dump.rdb</code> 文件转为 <code>JSON</code> 文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pip install rdbtools</div><div class="line">rdb --<span class="built_in">command</span> json dump.rdb</div></pre></td></tr></table></figure>
<p><a href="https://www.oschina.net/question/253614_88456" target="_blank" rel="external">解密Redis持久化</a> 解释了 Redis 持久化功能与其他常见数据库的持久化功能之间的异同</p>
<h3 id="AOF-持久化"><a href="#AOF-持久化" class="headerlink" title="AOF 持久化"></a>AOF 持久化</h3><h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p>(1) 事件的调度和执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// redis.c</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    aeMain(server.el);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ae.c</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">aeMain</span><span class="params">(aeEventLoop *eventLoop)</span> </span>&#123;</div><div class="line">    eventLoop-&gt;stop = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (!eventLoop-&gt;stop) &#123;</div><div class="line">        <span class="keyword">if</span> (eventLoop-&gt;beforesleep != <span class="literal">NULL</span>)</div><div class="line">            eventLoop-&gt;beforesleep(eventLoop);</div><div class="line">        aeProcessEvents(eventLoop, AE_ALL_EVENTS);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 处理所有的 pending 事件，然后处理所有的文件事件</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">aeProcessEvents</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">int</span> flags)</span></span></div></pre></td></tr></table></figure>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>(1) 列出所有客户端</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; CLIENT <span class="built_in">list</span></div><div class="line">id=<span class="number">3</span> addr=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">40084</span> fd=<span class="number">5</span> name= age=<span class="number">6</span> idle=<span class="number">0</span> flags=N db=<span class="number">0</span> sub=<span class="number">0</span> psub=<span class="number">0</span> multi=<span class="number">-1</span> qbuf=<span class="number">0</span> qbuf-<span class="built_in">free</span>=<span class="number">32768</span> obl=<span class="number">0</span> oll=<span class="number">0</span> omem=<span class="number">0</span> events=r cmd=client</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// redis.h</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></div><div class="line">    <span class="built_in">list</span> *clients;              <span class="comment">/* List of active clients */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisClient</span> &#123;</span></div><div class="line">    <span class="comment">// 客户端的文件描述符</span></div><div class="line">    <span class="keyword">int</span> fd;</div><div class="line">    <span class="comment">// 输入缓冲区: 保存客户端发送的请求命令</span></div><div class="line">    sds querybuf;</div><div class="line">    <span class="comment">// 记录客户端的角色</span></div><div class="line">    <span class="keyword">int</span> flags;              <span class="comment">/* REDIS_SLAVE | REDIS_MONITOR | REDIS_MULTI ... */</span></div><div class="line">    <span class="comment">// 存储命令长度: 3</span></div><div class="line">    <span class="keyword">int</span> argc;</div><div class="line">    <span class="comment">// 是一个字典</span></div><div class="line">    <span class="comment">// argv[0] = "SET"</span></div><div class="line">    <span class="comment">// argv[1] = "message"</span></div><div class="line">    <span class="comment">// argv[2] = "hello world"</span></div><div class="line">    robj **argv;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="服务器-1"><a href="#服务器-1" class="headerlink" title="服务器"></a>服务器</h3><p>(1) 调用命令:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// redis.c</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> <span class="title">redisCommandTable</span>[] = &#123;</span></div><div class="line">    &#123;<span class="string">"get"</span>,getCommand,<span class="number">2</span>,<span class="string">"rF"</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</div><div class="line">    &#123;<span class="string">"set"</span>,setCommand,<span class="number">-3</span>,<span class="string">"wm"</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</div><div class="line">    &#123;<span class="string">"setnx"</span>,setnxCommand,<span class="number">3</span>,<span class="string">"wmF"</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// redis.c</span></div><div class="line"><span class="comment">/* Call() is the core of Redis execution of a command */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">call</span><span class="params">(redisClient *c, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">    c-&gt;cmd-&gt;proc(c);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(2) <code>serverCron</code> 函数</p>
<p>服务器每秒钟调用 <code>server.hz</code> 次 <code>serverCron</code> 函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// redis.c</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">serverCron</span><span class="params">(struct aeEventLoop *eventLoop, <span class="keyword">long</span> <span class="keyword">long</span> id, <span class="keyword">void</span> *clientData)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">1000</span>/server.hz;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServerConfig</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    server.hz = REDIS_DEFAULT_HZ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// redis.h</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_DEFAULT_HZ        10      <span class="comment">/* Time interrupt calls/sec. */</span></span></div></pre></td></tr></table></figure>
<h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h3><p>慢查询日志: 系统在命令执行前后计算每条命令的执行时间，当超过预设阈值，就将这条命令的相关信息记录到慢查询日志中。</p>
<ul>
<li><code>slowlog-log-slower-than</code>: 默认值是 10000 微秒 (10 毫秒) (1秒 = 1000000 微秒)，高 OPS 场景下的 Redis 建议设置为 1 毫秒</li>
<li><code>slowlog-max-len</code>: 最多存放多少条慢查询，当慢查询日志列表已处于其最大长度时，最早插入的一个命令将从列表中移出，默认 128，<strong>线上可以设置为 1000 以上</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// 临时修改</div><div class="line">127.0.0.1:6379&gt; CONFIG GET slowlog-log-slower-than</div><div class="line">1) <span class="string">"slowlog-log-slower-than"</span></div><div class="line">2) <span class="string">"20000"</span></div><div class="line">127.0.0.1:6379&gt; CONFIG SET slowlog-log-slower-than 20000</div><div class="line">OK</div></pre></td></tr></table></figure>
<p>虽然慢查询日志存放在 Redis 内存列表中，但是 Redis 并没有暴露这个列表的键，而是通过一组命令来实现对慢查询日志的访问和管理:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; SLOWLOG GET</div><div class="line">1) 1) (<span class="built_in">integer</span>) 1 // 日志的唯一标识符</div><div class="line">   2) (<span class="built_in">integer</span>) 1499139268 // 命令执行时的 UNIX 时间戳</div><div class="line">   3) (<span class="built_in">integer</span>) 2458 // 命令执行 2458 微秒</div><div class="line">   4) 1) <span class="string">"set"</span> // 命令以及命令参数</div><div class="line">      2) <span class="string">"message"</span></div><div class="line">      3) <span class="string">"hello"</span></div></pre></td></tr></table></figure>
<p>获取慢查询日志当前长度:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; SLOWLOG LEN</div><div class="line">(<span class="built_in">integer</span>) 4</div></pre></td></tr></table></figure>
<p>清理慢查询日志列表:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; SLOWLOG RESET</div><div class="line">OK</div></pre></td></tr></table></figure>
<p>慢查询只记录命令的执行时间，并不包括命令排队和网络传输时间，因此客户端执行命令的时间会大于命令的实际执行时间。由于慢查询是一个先进先出的队列，也就是说如果慢查询比较多的情况下，可能会丢失部分慢查询命令，为了防止这种情况发生，可以定期执行 <code>SLOWLOG GET</code> 命令将慢查询日志持久化到其他存储 (MySQL, ElasticSearch) 中，然后通过可视化工具进行查询。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/20/Redis八/" data-id="cjc5qrt1e00305cemyroyo65x" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Redis七" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/20/Redis七/" class="article-date">
  <time datetime="2017-06-20T08:24:38.000Z" itemprop="datePublished">2017-06-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/20/Redis七/">Redis 七 - 对象系统</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Redis-七-对象系统"><a href="#Redis-七-对象系统" class="headerlink" title="Redis 七 - 对象系统"></a>Redis 七 - 对象系统</h2><p>Redis 并没有直接使用这些数据结构来实现键值对数据库，而是基于这些数据结构创建了一个对象系统，这个系统包含字符串对象、列表对象、哈希对象、集合对象和有序集合对象这五种类型的对象</p>
<p>主要涉及文件 <code>redis.h</code></p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></div><div class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</div><div class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</div><div class="line">    <span class="keyword">unsigned</span> lru:REDIS_LRU_BITS; <span class="comment">/* lru time (relative to server.lruclock) */</span></div><div class="line">    <span class="keyword">int</span> refcount;</div><div class="line">    <span class="comment">/* point to the implementation data structure */</span></div><div class="line">    <span class="keyword">void</span> *ptr;</div><div class="line">&#125; robj;</div></pre></td></tr></table></figure>
<p>我们使用 <code>TYPE</code> 命令返回的是数据库键对应的值对象的类型:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; SET msg &quot;hello world&quot;</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; TYPE msg</div><div class="line">string</div></pre></td></tr></table></figure>
<p>总共定义了五种类型:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Object types */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_STRING 0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_LIST 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_SET 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ZSET 3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_HASH 4</span></div></pre></td></tr></table></figure>
<h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><p><code>encoding</code> 记录了这个对象所使用的编码，记录了这个对象到底使用了什么数据结构作为对象的底层实现:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Objects encoding. Some kind of objects like Strings and Hashes can be</span></div><div class="line"><span class="comment"> * internally represented in multiple ways. The 'encoding' field of the object</span></div><div class="line"><span class="comment"> * is set to one of this fields for this object. */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_RAW 0     <span class="comment">/* Raw representation */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_INT 1     <span class="comment">/* Encoded as integer */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_HT 2      <span class="comment">/* Encoded as hash table */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_ZIPMAP 3  <span class="comment">/* Encoded as zipmap */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_LINKEDLIST 4 <span class="comment">/* Encoded as regular linked list */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_ZIPLIST 5 <span class="comment">/* Encoded as ziplist */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_INTSET 6  <span class="comment">/* Encoded as intset */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_SKIPLIST 7  <span class="comment">/* Encoded as skiplist */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_EMBSTR 8  <span class="comment">/* Embedded sds string encoding */</span></span></div></pre></td></tr></table></figure>
<p>使用 <code>OBJECT ENCODING</code> 可以查看一个数据库键的值对象的编码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; SET msg &quot;hello world&quot;</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; OBJECT ENCODING msg</div><div class="line">&quot;embstr&quot;</div></pre></td></tr></table></figure>
<h3 id="字符串对象"><a href="#字符串对象" class="headerlink" title="字符串对象"></a>字符串对象</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/20/Redis七/" data-id="cjc5qrswd000z5cemdfayzj4m" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Redis六" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/06/20/Redis六/" class="article-date">
  <time datetime="2017-06-20T08:19:44.000Z" itemprop="datePublished">2017-06-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/源代码阅读/">源代码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/06/20/Redis六/">Redis 六 - 压缩列表 (ziplist)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Redis-六-压缩列表-ziplist"><a href="#Redis-六-压缩列表-ziplist" class="headerlink" title="Redis 六 - 压缩列表 (ziplist)"></a>Redis 六 - 压缩列表 (ziplist)</h2><h3 id="用于"><a href="#用于" class="headerlink" title="用于"></a>用于</h3><p>当一个列表键只包含少量列表项，并且每个列表项要么就是小整数值，要么就是长度比较短的字符串，那么 Redis 就会使用压缩列表来做列表键的底层实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; RPUSH lst 1 3 5 &quot;hello&quot;</div><div class="line">(integer) 4</div><div class="line">127.0.0.1:6379&gt; OBJECT ENCODING lst</div><div class="line">&quot;ziplist&quot;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/06/20/Redis六/" data-id="cjc5qrswy00195cemkaro9e8q" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/blog/page/16/">&laquo; 上一页</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/15/">15</a><a class="page-number" href="/blog/page/16/">16</a><span class="page-number current">17</span><a class="page-number" href="/blog/page/18/">18</a><a class="page-number" href="/blog/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/23/">23</a><a class="extend next" rel="next" href="/blog/page/18/">下一页&raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    

  
    
  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/01/06/where-the-time-actually-gone/">时间都去哪儿了</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/dev-reflection/">开发反思</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/my-microblog/">我的微博</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/gcc-basic/">gcc-basic</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/java-internal/">Java Internal</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>