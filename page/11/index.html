<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>代码人生</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="赵坤的个人网站">
<meta property="og:type" content="website">
<meta property="og:title" content="代码人生">
<meta property="og:url" content="http://blog.kunzhao.org/page/11/index.html">
<meta property="og:site_name" content="代码人生">
<meta property="og:description" content="赵坤的个人网站">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代码人生">
<meta name="twitter:description" content="赵坤的个人网站">
  
    <link rel="alternate" href="/atom.xml" title="代码人生" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.kunzhao.org"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首页</a>
        
          <a class="main-nav-link" href="/blog/archives">归档</a>
        
          <a class="main-nav-link" href="/blog/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">代码人生</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-mysql" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/28/mysql/" class="article-date">
  <time datetime="2017-07-28T06:37:38.000Z" itemprop="datePublished">2017-07-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/28/mysql/">MySQL</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt install mysql-server</div></pre></td></tr></table></figure>
<p>安装过程中会提示你输入 <code>root</code> 用户的密码</p>
<hr>
<p><strong>安装 <code>MySQL Workbench</code></strong>:</p>
<ul>
<li>访问 <a href="https://dev.mysql.com/downloads/workbench/" target="_blank" rel="external">https://dev.mysql.com/downloads/workbench/</a> 安装</li>
</ul>
<h3 id="查看版本号"><a href="#查看版本号" class="headerlink" title="查看版本号"></a>查看版本号</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select version();</div><div class="line">+------------------------------------------+</div><div class="line">| VERSION()                                |</div><div class="line">+------------------------------------------+</div><div class="line">| 5.5.8-mycat-1.5.1-RELEASE-20161110104159 |</div><div class="line">+------------------------------------------+</div></pre></td></tr></table></figure>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 重启</span></div><div class="line">sudo service mysql restart</div></pre></td></tr></table></figure>
<hr>
<p><strong>默认配置文件</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/mysql/mysql.conf.d/mysqld.cnf</div></pre></td></tr></table></figure>
<p>以下话摘自 <code>mysql --help | more</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Default options are read from the following files in the given order:</div><div class="line">/etc/my.cnf /etc/mysql/my.cnf ~/.my.cnf</div></pre></td></tr></table></figure>
<hr>
<p>遇到的问题:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; use mysql;</div><div class="line">ERROR 1044 (42000): Access denied for user &apos;root&apos;@&apos;%&apos; to database &apos;mysql&apos;</div></pre></td></tr></table></figure>
<p>运行如下语句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SELECT USER(),CURRENT_USER();</div></pre></td></tr></table></figure>
<ul>
<li><code>USER()</code> reports how you <strong>尝试认证</strong> in MySQL</li>
<li><code>CURRENT_USER()</code> reports how you <strong>被允许认证</strong> in MySQL</li>
</ul>
<p>你登录的时候有什么特权:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SHOW GRANTS;</div></pre></td></tr></table></figure>
<hr>
<p><strong>创建用户并授权</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> slave_user;</div><div class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> slave_user <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'123456'</span>;</div></pre></td></tr></table></figure>
<ul>
<li><code>REPLICATION SLAVE</code> 权限并没有什么特别之处，<strong>只是这个用户能够从 <code>Master</code> 上取得二进制日志的转储数据</strong>。</li>
</ul>
<p>When mysqld starts, it reads all grant table contents into memory. The in-memory tables become effective for access control at that point.</p>
<p>If you modify the grant tables <strong>非直接地</strong> using account-management statements such as <code>GRANT</code>, <code>REVOKE</code>, <code>SET PASSWORD</code>, or <code>RENAME USER</code>, the server notices these changes and loads the grant tables into memory again <strong>立即</strong>.</p>
<p>If you modify the grant tables <strong>直接地</strong> using statements such as <code>INSERT</code>, <code>UPDATE</code>, or <code>DELETE</code>, your changes have no effect on privilege checking until you either <strong>重启服务器</strong> or tell it to reload the tables. If you change the grant tables directly but forget to reload them, your changes have no effect until you restart the server. This may leave you wondering why your changes seem to make no difference!</p>
<p>To tell the server to reload the grant tables, perform a flush-privileges operation. This can be done by issuing a <strong><code>FLUSH PRIVILEGES</code></strong> statement.</p>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/grant.html" target="_blank" rel="external">所有权限</a></li>
</ul>
<p><strong>1) Global Privileges</strong>:</p>
<p><img src="17-08-25-09_36_42_977_137.png" alt=""></p>
<p><strong>2) Database Privileges</strong>:</p>
<p><img src="17-08-25-09_37_18_988_140.png" alt=""></p>
<p><strong>3) Table Privileges</strong>:</p>
<p><img src="17-08-25-09_37_54_976_139.png" alt=""></p>
<p><strong>账户和密码</strong>:</p>
<p>A user value in a <code>GRANT</code> statement indicates a MySQL account to which the statement applies. To accommodate granting rights to users from arbitrary hosts, MySQL supports specifying the user value in the form <strong>‘user_name’@’host_name’</strong>.</p>
<p>You can specify <strong>通配符</strong> in the host name. For example, <code>&#39;user_name&#39;@&#39;%.example.com&#39;</code> applies to user_name for <strong>任何</strong> host in the example.com domain, and <code>&#39;user_name&#39;@&#39;192.168.1.%&#39;</code> applies to user_name for any host in the 192.168.1 class C subnet.</p>
<p>The simple form <strong>‘user_name’</strong> is a synonym <strong>同义词</strong> for <strong>‘user_name’@’%’</strong>.</p>
<hr>
<p><strong>删除用户</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] <span class="keyword">user</span> [, <span class="keyword">user</span>] ...</div></pre></td></tr></table></figure>
<hr>
<p><strong>查看已有用户</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">USE</span> mysql</div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">User</span>, Host <span class="keyword">FROM</span> <span class="string">`user`</span>;</div></pre></td></tr></table></figure>
<hr>
<p><strong>地址绑定</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--<span class="built_in">bind</span>-address=addr</div></pre></td></tr></table></figure>
<p>The server treats different types of addresses as follows:</p>
<ul>
<li>If the address is <code>0.0.0.0</code>, the server accepts TCP/IP connections on <strong>所有</strong> server host <strong>IPv4</strong> interfaces.</li>
<li>If the address is <code>::</code>, the server accepts TCP/IP connections on all <strong>所有</strong> host <strong>IPv4 and IPv6</strong> interfaces. Use this address to permit both IPv4 and IPv6 connections on all server interfaces.</li>
<li>If the address is an IPv4-mapped address, the server accepts TCP/IP connections for that address, in either IPv4 or IPv6 format. For example, if the server is bound to <code>::ffff:127.0.0.1</code>, clients can connect using –host=127.0.0.1 or –host=<code>::ffff:127.0.0.1</code>.</li>
<li>If the address is a “regular” IPv4 or IPv6 address (such as 127.0.0.1 or ::1), the server accepts TCP/IP connections only for that IPv4 or IPv6 address.</li>
</ul>
<p><strong>数据库远程连接不上</strong>，多半是 <code>bind-address</code> 和 <code>root</code> 问题搞得鬼:</p>
<p><img src="2017_10_20_20_06_26.png" alt=""></p>
<p>这个时候，需要执行语句给 <code>ROOT</code> 赋上权限即可:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; update mysql.user set host = '%' where user = 'root';</div><div class="line">mysql&gt; flush privileges;</div></pre></td></tr></table></figure>
<hr>
<h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p><strong>1) 从库从主库克隆已有数据</strong>:</p>
<p>主库 (锁表 -&gt; 查询从库复制开始位置 -&gt; 备份 -&gt; 解锁):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FLUSH</span> <span class="keyword">TABLES</span> <span class="keyword">WITH</span> <span class="keyword">READ</span> <span class="keyword">LOCK</span>;</div><div class="line"><span class="keyword">SHOW</span> <span class="keyword">MASTER</span> <span class="keyword">STATUS</span>;</div><div class="line">mysqldump -uroot -p <span class="comment">--all-databases &gt; all.sql</span></div><div class="line"><span class="keyword">UNLOCK</span> <span class="keyword">TABLES</span>;</div></pre></td></tr></table></figure>
<p>从主库机器上拷贝 <code>all.sql</code> 到从库:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rsync all.sql zk@10.108.113.85:~/Desktop/</div></pre></td></tr></table></figure>
<p>从库恢复数据:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; source /home/zk/Desktop/all.sql</div></pre></td></tr></table></figure>
<p><strong>2) 执行同步</strong>:</p>
<p>主库查看一下从库复制的起始位置:</p>
<p><img src="17-08-24-16_29_14_1134_186.png" alt=""></p>
<p>从库执行如下命令 (下面语句必须在 <strong>SLAVE</strong> 机器上的拥有 <strong>SUPER</strong> 权限的用户来执行):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">STOP</span> <span class="keyword">SLAVE</span> IO_THREAD <span class="keyword">FOR</span> CHANNEL <span class="string">''</span>;</div><div class="line"><span class="keyword">RESET</span> <span class="keyword">SLAVE</span>;</div><div class="line"><span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST = <span class="string">'10.108.123.112'</span>, MASTER_PORT = <span class="number">3306</span>, MASTER_USER = <span class="string">'slave_user'</span>, MASTER_PASSWORD = <span class="string">'123456'</span>, MASTER_LOG_FILE = <span class="string">'master-bin.000123'</span>, MASTER_LOG_POS = <span class="number">2559</span>;</div><div class="line"><span class="keyword">START</span> <span class="keyword">SLAVE</span>;</div><div class="line"><span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span>;</div></pre></td></tr></table></figure>
<p>遇见的问题:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; change master to master_host = &apos;10.108.123.112&apos;, master_password = &apos;123456&apos;, master_user = &apos;slave_user&apos;, master_log_file = &apos;master-bin.000123&apos;, master_log_pos = 1995;</div><div class="line">ERROR 3021 (HY000): This operation cannot be performed with a running slave io thread; run STOP SLAVE IO_THREAD FOR CHANNEL &apos;&apos; first.</div></pre></td></tr></table></figure>
<p>可以参考: <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-master-slave-replication-in-mysql" target="_blank" rel="external">How To Set Up Master Slave Replication in MySQL</a></p>
<hr>
<p>显示 <code>MASTER</code> 和 <code>SLAVE</code> 的状态可以使用如下命令，但是查询显示的结果可读性不好: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">MASTER</span> <span class="keyword">STATUS</span>;</div><div class="line"><span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span>;</div></pre></td></tr></table></figure>
<p>如果想要更好的<strong>可读性</strong>，可以在后面加上 <strong><font color="red"><code>\G</code></font></strong> 这两个字符，其实<strong>查询语句</strong>也可以通过加上这两个字符来获得更好的阅读效果:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW MASTER STATUS\G</div><div class="line">mysql&gt; SHOW SLAVE STATUS\G</div></pre></td></tr></table></figure>
<p><img src="17-08-25-09_18_03_821_203.png" alt=""></p>
<hr>
<p>查看复制线程有没有问题:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW PROCESS LIST\G</div></pre></td></tr></table></figure>
<h3 id="二进制日志"><a href="#二进制日志" class="headerlink" title="二进制日志"></a>二进制日志</h3><p>二进制仅包含<strong>可能改变数据库</strong>的语句，它包含若干个文件:</p>
<p><img src="msha_0401.png" alt=""></p>
<p>由于二进制日志是公共资源，所有线程都向它写入语句，所以避免两个线程同时更新二进制日志很重要。为此，在事件写二进制日志之前，二进制日志需要获得一个<strong>互斥锁 <code>LOCK_log</code></strong>，然后在事件写完成够释放。</p>
<p>从 <code>my.cnf</code> 配置文件中可以找到 <code>MySQL</code> 数据存放的位置:</p>
<p><img src="17-08-25-11_10_00_556_246.png" alt=""></p>
<p>或者也可以像下面这样执行命令找到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW VARIABLES LIKE &apos;datadir&apos;;</div><div class="line"> +---------------+-----------------------+</div><div class="line"> | Variable_name | Value                 |</div><div class="line"> +---------------+-----------------------+</div><div class="line"> | datadir       | /usr/local/mysql/var/ |</div><div class="line"> +---------------+-----------------------+</div><div class="line"> 1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>我们是没有权限进入这个数据文件夹的，即使使用 <code>sudo</code> 也不行:</p>
<p><img src="17-08-25-11_11_15_542_78.png" alt=""></p>
<p>但是我们可以使用 <code>mysqlbinlog</code> 这个工具来装载 <code>binlog</code> 文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqlbinlog /var/lib/mysql/master-bin.000125</div></pre></td></tr></table></figure>
<ul>
<li><code>--short-form</code>: 忽略关于二进制日志中的事件的注释信息</li>
<li><code>--read-from-remote-server</code>: 远程读取</li>
<li><code>--host=master.example.com</code>: 远程主机</li>
<li><code>--user=repl_user</code>: 账户</li>
<li><code>--password</code>: 密码</li>
</ul>
<h3 id="MySQL-Workbeanch"><a href="#MySQL-Workbeanch" class="headerlink" title="MySQL Workbeanch"></a>MySQL Workbeanch</h3><p>双击修改某一个表的某一个字段之后，一定要记住<strong>点击右下角的 <code>Apply</code></strong>:</p>
<p><img src="17-07-28-14_38_15_565_255.png" alt=""></p>
<h3 id="MySQL-指定配置文件"><a href="#MySQL-指定配置文件" class="headerlink" title="MySQL 指定配置文件"></a>MySQL 指定配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql --defaults-file=/home/user/.my.cnf database</div></pre></td></tr></table></figure>
<h3 id="一台机器上运行多个-MySQL-Instances"><a href="#一台机器上运行多个-MySQL-Instances" class="headerlink" title="一台机器上运行多个 MySQL Instances"></a>一台机器上运行多个 MySQL Instances</h3><ul>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/multiple-servers.html" target="_blank" rel="external">参考</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysqld --port=3307\</div><div class="line">    --socket=3307.socket\</div><div class="line">    --pid-file=3307.pid\</div><div class="line">    --<span class="built_in">log</span>-error=3307-error.log\</div><div class="line">    --general_log_file=3307-log.log\</div><div class="line">    --datadir=./3307-data-dir</div></pre></td></tr></table></figure>
<h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><ul>
<li><code>mysqld</code>: <code>MySQL</code> 服务器</li>
<li><code>mysql</code>: <code>MySQL</code> 客户端命令行程序</li>
</ul>
<h3 id="正则匹配"><a href="#正则匹配" class="headerlink" title="正则匹配"></a>正则匹配</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> table1 <span class="keyword">where</span> <span class="keyword">name</span> regexp <span class="built_in">binary</span> <span class="string">'^CU[0-9]'</span></div></pre></td></tr></table></figure>
<p>The documentation for <code>regexp</code> is <a href="https://dev.mysql.com/doc/refman/5.5/en/regexp.html" target="_blank" rel="external">here</a>. <code>binary</code> is required to <strong>确保大小写匹配</strong></p>
<hr>
<p>百分号 <code>%</code> 字符来表示<strong>任意字符</strong></p>
<h3 id="创建表和数据库示例"><a href="#创建表和数据库示例" class="headerlink" title="创建表和数据库示例"></a>创建表和数据库示例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># 设置为 utf8 解决各种字符错误问题</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> my_db <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</div><div class="line"># 创建表和外键示例</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`my_db`</span>.<span class="string">`my_table`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'my id'</span>,</div><div class="line">  <span class="string">`user_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'user_name'</span>,</div><div class="line">  <span class="string">`user_password`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'user_password'</span>,</div><div class="line">  <span class="string">`publish_time`</span> <span class="keyword">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'article publish time'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  FOREIGN <span class="keyword">KEY</span> (<span class="string">`user_name`</span>) <span class="keyword">REFERENCES</span> <span class="string">`ref_table`</span>(<span class="string">`user_name`</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></div><div class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span>;</div></pre></td></tr></table></figure>
<h3 id="数据库设置允许远程访问"><a href="#数据库设置允许远程访问" class="headerlink" title="数据库设置允许远程访问"></a>数据库设置允许远程访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf</div><div class="line"># 将 `mysqld.conf` 文件里面的下面这个 `bind-address` 给注释掉即可</div><div class="line"># MySQL 默认只允许本机访问</div><div class="line"></div><div class="line"># Instead of skip-networking the default is now to listen only on</div><div class="line"># localhost which is more compatible and is not less secure.</div><div class="line">bind-address        = 127.0.0.1</div></pre></td></tr></table></figure>
<h3 id="启动、停止、查看状态"><a href="#启动、停止、查看状态" class="headerlink" title="启动、停止、查看状态"></a>启动、停止、查看状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo /etc/init.d/mysql start</div><div class="line">sudo /etc/init.d/mysql stop</div><div class="line">sudo /etc/init.d/mysql status</div><div class="line">sudo /etc/init.d/mysql <span class="built_in">help</span></div></pre></td></tr></table></figure>
<h3 id="无法连接-MySQL-数据库"><a href="#无法连接-MySQL-数据库" class="headerlink" title="无法连接 MySQL 数据库"></a>无法连接 MySQL 数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ERROR 2002 (HY000): Can&apos;t connect to local MySQL server through socket         &apos;/var/run/mysqld/mysqld.sock&apos; (2)</div></pre></td></tr></table></figure>
<p>查看 <code>MySQL</code> 错误日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">2017-11-21T12:08:01.649118Z 31311 [Note] Aborted connection 31311 to db: &apos;sogo&apos; user: &apos;sogo&apos; host: &apos;localhost&apos; (Got an error reading communication packets)</div><div class="line">2017-11-21T12:08:01.760904Z 31312 [Note] Aborted connection 31312 to db: &apos;sogo&apos; user: &apos;sogo&apos; host: &apos;localhost&apos; (Got an error reading communication packets)</div><div class="line">2017-11-21T12:08:14.021729Z 0 [Note] Giving 7 client threads a chance to die gracefully</div><div class="line">2017-11-21T12:08:14.021782Z 0 [Note] Shutting down slave threads</div><div class="line">2017-11-21T12:08:16.021864Z 0 [Note] Forcefully disconnecting 4 remaining clients</div><div class="line">2017-11-21T12:08:16.021908Z 0 [Warning] /usr/sbin/mysqld: Forcing close of thread 31298  user: &apos;iredapd&apos;</div><div class="line"></div><div class="line">2017-11-21T12:08:16.021952Z 0 [Warning] /usr/sbin/mysqld: Forcing close of thread 18101  user: &apos;root&apos;</div><div class="line"></div><div class="line">2017-11-21T12:08:16.021977Z 0 [Warning] /usr/sbin/mysqld: Forcing close of thread 18109  user: &apos;root&apos;</div><div class="line"></div><div class="line">2017-11-21T12:08:16.021997Z 0 [Warning] /usr/sbin/mysqld: Forcing close of thread 19628  user: &apos;root&apos;</div><div class="line"></div><div class="line">2017-11-21T12:08:16.022024Z 0 [Note] Event Scheduler: Purging the queue. 0 events</div><div class="line">2017-11-21T12:08:16.022253Z 0 [Note] Binlog end</div><div class="line">2017-11-21T12:08:16.202954Z 0 [Note] Shutting down plugin &apos;ngram&apos;</div><div class="line">2017-11-21T12:08:16.202980Z 0 [Note] Shutting down plugin &apos;partition&apos;</div><div class="line">2017-11-21T12:08:16.202984Z 0 [Note] Shutting down plugin &apos;BLACKHOLE&apos;</div><div class="line">2017-11-21T12:08:16.202988Z 0 [Note] Shutting down plugin &apos;ARCHIVE&apos;</div><div class="line">2017-11-21T12:08:16.202991Z 0 [Note] Shutting down plugin &apos;PERFORMANCE_SCHEMA&apos;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>暂时不知道为什么会死去…</p>
<hr>
<p>Try this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -h 127.0.0.1 -P 3306 -u root -p &lt;database&gt;</div></pre></td></tr></table></figure>
<p>Also (to see if it’s running):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">telnet 127.0.0.1 3306</div></pre></td></tr></table></figure>
<h3 id="修改列的定义"><a href="#修改列的定义" class="headerlink" title="修改列的定义"></a>修改列的定义</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`my_db`</span> <span class="keyword">CHANGE</span> <span class="keyword">COLUMN</span> <span class="string">`column_a`</span> <span class="string">`column_a`</span> <span class="built_in">VARCHAR</span>(<span class="number">225</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'enlarge column capacity'</span> ;</div></pre></td></tr></table></figure>
<h3 id="修复时间戳插入错误的问题"><a href="#修复时间戳插入错误的问题" class="headerlink" title="修复时间戳插入错误的问题"></a>修复时间戳插入错误的问题</h3><p>从 <code>MySQL Workbench</code> 客户端中查看的值是 <code>0000-00-00 00:00:00</code>，说明 <code>create_time</code> 为 <code>TIMESTAMP</code> 时间戳类型中已经插入了错误的值，需要采用如下方式来恢复一下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">update</span> <span class="string">`my_db`</span> <span class="keyword">set</span> <span class="string">`create_time`</span> = <span class="literal">NULL</span> <span class="keyword">where</span> <span class="string">`create_time`</span> = <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>不能采用:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">update</span> <span class="string">`my_db`</span> <span class="keyword">set</span> <span class="string">`create_time`</span> = <span class="literal">NULL</span> <span class="keyword">where</span> <span class="string">`create_time`</span> = <span class="string">'0000-00-00 00:00:00'</span>;</div></pre></td></tr></table></figure>
<p>来更新，不管用。</p>
<h3 id="You-are-using-safe-update-mode-…"><a href="#You-are-using-safe-update-mode-…" class="headerlink" title="You are using safe update mode …"></a>You are using safe update mode …</h3><p><strong>MySQL Workbench</strong>: You are using safe update mode and you tried to update a table without a WHERE that uses a KEY column To disable safe mode, toggle the option ….</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> SQL_SAFE_UPDATES = <span class="number">0</span>;</div></pre></td></tr></table></figure>
<h3 id="MySQL-导入-SQL-文件"><a href="#MySQL-导入-SQL-文件" class="headerlink" title="MySQL 导入 SQL 文件"></a>MySQL 导入 SQL 文件</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; using databasename;</div><div class="line">mysql&gt; source /path/to/backup.sql</div></pre></td></tr></table></figure>
<h3 id="MySQL-Dump"><a href="#MySQL-Dump" class="headerlink" title="MySQL Dump"></a>MySQL Dump</h3><ul>
<li><strong>dump</strong> 整个表:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -h [remoteip] --port = 3306 -u [username] -p [password] --databases [db_name] --tables [tablename] &gt; tablename.sql;</div></pre></td></tr></table></figure>
<p>更多示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysqldump --all-databases &gt; dump.sql</div><div class="line">mysqldump -uroot --databases db1, db2 &gt; dump.sql</div><div class="line">mysqldump -uroot my_db t1</div></pre></td></tr></table></figure>
<ul>
<li><strong>query dump</strong> 部分结果，使用 MySQL Workbench:</li>
</ul>
<p><img src="17-08-17-15_33_35_1286_244.png" alt=""></p>
<p>在保存的格式中选择 <code>SQL INSERT statements</code>:</p>
<p><img src="17-08-17-15_35_08_861_209.png" alt=""></p>
<ul>
<li><strong>SELECT … INTO OUTFILE</strong> 备份:</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * INTO OUTFILE 'aaa.sql';</div><div class="line">ERROR 1096 (HY000): No tables used</div><div class="line">mysql&gt; select * INTO OUTFILE 'aaa.sql' FROM iapp_app_info;</div><div class="line">ERROR 1290 (HY000): The MySQL server is running with the <span class="comment">--secure-file-priv option so it cannot execute this statement</span></div></pre></td></tr></table></figure>
<p>最后发现需要这样执行才算可以:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -proot iapp_db -e <span class="string">'select * FROM iapp_app_info'</span> &gt; aaa.txt</div></pre></td></tr></table></figure>
<p>默认导出的数据文件是以 <code>TAB</code> 进行列分割的，如果想要使用其他分隔符，可以像下面这样:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">```</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">关于 `mysqldump` 的一些参数信息:</div><div class="line"></div><div class="line">- **`--add-drop-database`**: 多一行这个:</div><div class="line"></div><div class="line">```sql</div><div class="line">/*!40000 DROP DATABASE IF EXISTS `iapp_db`*/;</div></pre></td></tr></table></figure>
<h3 id="SQL-优化工具"><a href="#SQL-优化工具" class="headerlink" title="SQL 优化工具"></a>SQL 优化工具</h3><ul>
<li><a href="https://tech.meituan.com/sqladvisor_pr.html" target="_blank" rel="external">美团点评SQL优化工具SQLAdvisor开源</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt install cmake</div><div class="line">sudo apt install libaio-dev</div></pre></td></tr></table></figure>
<h3 id="查看当前连接信息"><a href="#查看当前连接信息" class="headerlink" title="查看当前连接信息"></a>查看当前连接信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; status</div></pre></td></tr></table></figure>
<h3 id="服务器性能剖析"><a href="#服务器性能剖析" class="headerlink" title="服务器性能剖析"></a>服务器性能剖析</h3><ul>
<li>如何确认服务器达到了最佳状态</li>
<li>找出某条语句为什么执行不够快</li>
<li>诊断用户描述成 “停顿”、“堆积”、“卡死” 的某些间歇性疑难故障</li>
</ul>
<p><strong>性能剖析</strong> 是测量和分析时间花费在哪里的主要方法。一般包含两个步骤: <strong>测量</strong>任务所花费的时间；然后对结果进行<strong>统计和排序</strong>，将重要的任务排到前面。</p>
<p><img src="17-08-15-21_01_43_501_132.png" alt=""></p>
<p>第一，一些只占总响应时间比重很小的查询是不值得优化的。根据阿姆达尔定律，<strong>对一个占总响应时间不超过 5% 的查询进行优化，无论如何努力，收益也不会超过 5%。</strong>第二，如果花费了 1000 美元去优化一个任务，但业务的收入没有任何增加，那么可以说反而导致业务被逆优化了 1000 美元。<strong>如果优化的成本大于收益，就应当停止优化</strong>。</p>
<hr>
<p>强烈建议大家从现在起就利用慢查询日志捕获服务器上的<strong>所有</strong>查询，并且进行分析。<strong>可以在一些典型的时间窗口如业务高峰期的一个小时内记录查询</strong>。如果业务趋势比较均衡，那么一分钟甚至更短的时间内捕获需要优化的低效查询也是可行的。</p>
<blockquote>
<p><strong>不要直接打开整个慢查询日志进行分析，这样做只会浪费时间和金钱。</strong></p>
</blockquote>
<hr>
<p>我们建议诊断问题时先使用前两种方法: <strong><code>SHOW STATUS</code> 和 <code>SHOW PROCESSLIST</code></strong>。这两种方法的开销很低，而且可以通过简单的 <code>Shell</code> 脚本或者反复执行的查询来交互式地收集数据。</p>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><h4 id="1-B-Tree-索引"><a href="#1-B-Tree-索引" class="headerlink" title="(1) B-Tree 索引"></a>(1) B-Tree 索引</h4><p>对<strong>索引列是按照顺序组织 (因此你可以使用 <code>ORDER BY</code> 和 <code>GROUP BY</code>) </strong>存储的，所以很适合查找范围数据。<strong>索引中存储了实际的列值</strong>，所以某些查询只使用索引就能够完成全部查询。</p>
<h4 id="2-Hash-Index-哈希索引"><a href="#2-Hash-Index-哈希索引" class="headerlink" title="(2) Hash Index 哈希索引"></a>(2) Hash Index 哈希索引</h4><p>对每一行的<strong>所有的索引列计算一个哈希码</strong></p>
<h4 id="3-R-Tree-空间数据索引"><a href="#3-R-Tree-空间数据索引" class="headerlink" title="(3) R-Tree 空间数据索引"></a>(3) R-Tree 空间数据索引</h4><p><strong>多维度索引数据</strong>，一般用作<strong>地理数据存储</strong></p>
<h4 id="4-全文索引"><a href="#4-全文索引" class="headerlink" title="(4) 全文索引"></a>(4) 全文索引</h4><p>更类似于<strong>搜索引擎</strong>干的事情</p>
<h3 id="索引选择"><a href="#索引选择" class="headerlink" title="索引选择"></a>索引选择</h3><h4 id="1-前缀索引"><a href="#1-前缀索引" class="headerlink" title="(1) 前缀索引"></a>(1) 前缀索引</h4><p><strong>索引很长的字符列</strong>，这会让索引变得大且慢，通常可以索引开始的部分字符，这样可以大大<strong>节约索引空间</strong>，从而提高索引效率。</p>
<p><img src="17-07-28-21_17_28_808_435.png" alt=""></p>
<p><img src="17-07-28-21_17_59_775_428.png" alt=""></p>
<p><img src="17-07-28-21_18_31_783_425.png" alt=""></p>
<p>计算合适的前缀长度的另外一个办法就是计算完整列的选择性，并<strong>使前缀的选择性接近于完整列的索引</strong>:</p>
<p><img src="17-07-28-21_21_34_747_188.png" alt=""></p>
<p><img src="17-07-28-21_22_55_734_327.png" alt=""></p>
<p>如何创建前缀索引:</p>
<p><img src="17-07-28-21_24_05_878_73.png" alt=""></p>
<p>MySQL 无法使用前缀索引做 <code>ORDER BY</code> 和 <code>GROUP BY</code></p>
<h4 id="2-多列索引"><a href="#2-多列索引" class="headerlink" title="(2) 多列索引"></a>(2) 多列索引</h4><p><img src="17-07-28-21_31_16_755_196.png" alt=""></p>
<h4 id="3-选择合适的索引列顺序"><a href="#3-选择合适的索引列顺序" class="headerlink" title="(3) 选择合适的索引列顺序"></a>(3) 选择合适的索引列顺序</h4><p><img src="17-07-28-21_40_06_738_80.png" alt=""></p>
<p><img src="17-07-28-21_42_25_868_353.png" alt=""></p>
<h3 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h3><p>通常情况下<strong>最好指定列为 <code>NOT NULL</code></strong>，除非真的需要存储 <code>NULL</code> 值</p>
<p><code>DATETIME</code> 和 <code>TIMESTAMP</code> 列都可以存储相同类型的数据: 时间和日期，<strong>精确到秒</strong>，然而 <code>TIMESTAMP</code> 只使用 <code>DATETIME</code> 一半的存储空间，并且会根据时区变化，具有特殊的自动更新能力。</p>
<p>如果存储整数，可以使用这几种整数类型: <code>TINYINT</code>, <code>SMALLINT</code>, <code>MEDIUMINT</code>, <code>INT</code>, <code>BIGINT</code>，分别使用 8, 16, 24, 32, 64 位存储空间。MySQL 可以为整数类型指定宽度，例如 <code>INT(11)</code>，对大多数应用这是没有意义的: 它不会限制值的合法范围，<strong>只是规定了 <code>MySQL</code> 的一些交互工具用来显示字符的个数</strong>。对于存储和计算来说，<code>INT(1)</code> 和 <code>INT(20)</code> 是相同的。</p>
<hr>
<p><strong><code>CHAR</code> 适合存储很短的字符串，或者所有值都接近同一个长度</strong>。例如，<code>CHAR</code> 非常适合存储密码的 MD5 值，因为这是一个定长的值。对于经常变更的数据，<code>CHAR</code> 也比 <code>VARCHAR</code> 更好，因为定长的 <code>CHAR</code> 类型不容易产生碎片。对于非常短的列，<code>CHAR</code> 比 <code>VARCHAR</code> 在存储空间上也更有效率。例如用 <code>CHAR(1)</code> 来存储只有 <code>Y</code> 和 <code>N</code> 的值。</p>
<hr>
<p>为标识符 (identifier column) 选择合适的数据类型非常重要。<strong>如果可能，应该避免使用字符串类型作为标识符</strong>，因为它们很消耗空间，并且通常比数字类型慢。对于完全“随机”的字符串也需要多加注意，例如 <code>MD5()</code>，<code>SHA1()</code>，<code>UUID()</code> 产生的字符串。这些函数生成的新值会<strong>任意分布在很大的空间内，这回导致 <code>INSERT</code> 以及一些 <code>SELECT</code> 语句变得很慢</strong>:</p>
<ul>
<li>因为插入值会随机地写到索引的不同位置，所以使得 <code>INSERT</code> 语句更慢。</li>
<li><code>SELECT</code> 语句会变得更慢，因为逻辑上相邻的行会分布在磁盘和内存的不同地方。</li>
<li>随机值导致缓存对所有类型的查询语句效果都很差，因为会使得缓存赖以工作的访问局部性原理失效。如果整个数据集都一样的“热”，那么缓存任何一部分g特定数据到内存都没有好处；如果工作集比内存大，缓存将会有更多刷新和不命中。</li>
</ul>
<p>如果存储 <code>UUID</code> 值，则应该移除“-”符号；或者更好的做法是，用 <code>UNHEX()</code> 函数转换 <code>UUID</code> 值为 16 字节的数字，并且存储在一个 <code>BINARY(16)</code> 的列中。检索时可以通过 <code>HEX()</code> 函数来格式化为十六进制格式。</p>
<p><code>UUID()</code> 生成的值与加密散列函数例如 <code>SHA1()</code> 生成的值有不同的特征: <strong><code>UUID</code> 值虽然分布也不均匀，但还是有一定顺序的</strong>。尽管如此，但还是不如递增的整数好用。</p>
<hr>
<ul>
<li><a href="http://mysqlserverteam.com/storing-uuid-values-in-mysql-tables/" target="_blank" rel="external">MySQL Server Blog - Storing UUID Values in MySQL Table</a></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">users</span>(id_bin <span class="built_in">binary</span>(<span class="number">16</span>), <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">200</span>));</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">users</span> <span class="keyword">values</span>(<span class="keyword">unhex</span>(<span class="keyword">replace</span>(<span class="keyword">uuid</span>(),<span class="string">'-'</span>,<span class="string">''</span>)), <span class="string">'Andromeda'</span>);</div></pre></td></tr></table></figure>
<hr>
<p>人们经常使用 <code>VARCHAR(15)</code> 列来存储 IP 地址，然而，它们实际上是 32 位无符号整数，不是字符串。用小数点将地址分成四段的表示方法只是为了让人们阅读容易。所以应该用无符号整数存储 IP 地址。<code>MySQL</code> 提供了 <code>INET_ATON()</code> 和 <code>INET_NTOA()</code> 函数在这两种表示方法之间转换。</p>
<h3 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h3><p><font color="#007020"><strong><code>SHOW</code> 和 <code>SET</code></strong></font> 是仅有的两个可以用于监控 <code>MySQL</code> 服务器的工具</p>
<h3 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h3><p><strong>1) 冷备份</strong>:</p>
<p>对于 InnoDB 的存储引擎的冷备份非常简单，只需要备份:</p>
<ul>
<li><code>frm</code> 文件</li>
<li>共享表空间文件</li>
<li>独立表空间文件 (*.ibd)</li>
<li>重做日志文件</li>
<li><code>my.cnf</code></li>
</ul>
<h3 id="有两个不同的事务同时操作数据库中同一表的同一行，不会引起冲突的是"><a href="#有两个不同的事务同时操作数据库中同一表的同一行，不会引起冲突的是" class="headerlink" title="有两个不同的事务同时操作数据库中同一表的同一行，不会引起冲突的是"></a>有两个不同的事务同时操作数据库中同一表的同一行，不会引起冲突的是</h3><p>两个都是 <code>DELETE</code></p>
<h3 id="MySQL-Driver-Class-Name"><a href="#MySQL-Driver-Class-Name" class="headerlink" title="MySQL Driver Class Name"></a>MySQL Driver Class Name</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">com.mysql.jdbc.Driver</div></pre></td></tr></table></figure>
<hr>
<p><img src="2017_10_13_14_25_30.png" alt=""></p>
<hr>
<p><img src="2017_10_13_14_58_34.png" alt=""><br><img src="2017_10_13_14_59_38.png" alt=""></p>
<hr>
<p><code>AUTO_INCREMENT</code> 一直自增，即使把数据库表清空，再次插入数据，依然是从上次清空前的 <code>id</code> 开始的。</p>
<hr>
<p>插入数据库乱码问题:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">con = DriverManager.getConnection(<span class="string">"jdbc:mysql:///dbname"</span>, <span class="string">"user"</span>, <span class="string">"pass"</span>);</div></pre></td></tr></table></figure>
<p>改为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">con = DriverManager.getConnection(<span class="string">"jdbc:mysql:///dbname?useUnicode=true&amp;characterEncoding=utf-8"</span>, <span class="string">"user"</span>, <span class="string">"pass"</span>);</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> VID, thumb</div><div class="line">    <span class="keyword">FROM</span> video</div><div class="line">    <span class="keyword">WHERE</span> VID <span class="keyword">IN</span> (</div><div class="line">        <span class="keyword">SELECT</span> VID</div><div class="line">        <span class="keyword">FROM</span> video</div><div class="line">        <span class="keyword">WHERE</span> title <span class="keyword">LIKE</span> <span class="string">"%'.$Channel['name'].'%"</span></div><div class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> viewtime <span class="keyword">DESC</span></div><div class="line">        <span class="keyword">LIMIT</span> <span class="number">5</span>)</div><div class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">RAND</span>()</div><div class="line">    <span class="keyword">LIMIT</span> <span class="number">1</span></div></pre></td></tr></table></figure>
<p>会抛出异常:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> Message:   Error during SQL execution: SELECT VID, thumb FROM video WHERE VID IN ( SELECT VID FROM video WHERE title LIKE &quot;%funny%&quot; ORDER BY viewtime DESC LIMIT 5) ORDER BY RAND() LIMIT 1&lt;br /&gt;</div><div class="line"> MySQL Error:   This version of MySQL doesn&apos;t yet support &apos;LIMIT &amp; IN/ALL/ANY/SOME subquery&apos;&lt;br /&gt;</div><div class="line">MySQL Errno:    1235</div></pre></td></tr></table></figure>
<p>可以替换为 (Instead of using <strong><code>IN</code></strong>, you can use <strong><code>JOIN</code></strong>):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> v.VID, v.thumb</div><div class="line"><span class="keyword">FROM</span> video <span class="keyword">AS</span> v</div><div class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span></div><div class="line">     (<span class="keyword">SELECT</span> VID</div><div class="line">     <span class="keyword">FROM</span> video</div><div class="line">     <span class="keyword">WHERE</span> title <span class="keyword">LIKE</span> <span class="string">"%'.$Channel['name'].'%"</span></div><div class="line">     <span class="keyword">ORDER</span> <span class="keyword">BY</span> viewtime <span class="keyword">DESC</span></div><div class="line">     <span class="keyword">LIMIT</span> <span class="number">5</span>) <span class="keyword">as</span> v2</div><div class="line">  <span class="keyword">ON</span> v.VID = v2.VID</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">RAND</span>()</div><div class="line"><span class="keyword">LIMIT</span> <span class="number">1</span></div></pre></td></tr></table></figure>
<h3 id="MySQL-unresolved-host"><a href="#MySQL-unresolved-host" class="headerlink" title="MySQL unresolved host"></a>MySQL unresolved host</h3><p>Two things to check (assuming your machine is called <code>my-machine</code>, you can change this as appropriate):</p>
<p>That the <strong><code>/etc/hostname</code></strong> file contains just the name of the machine.<br>That <strong><code>/etc/hosts</code></strong> has an entry for localhost. It should have something like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">127.0.0.1    localhost.localdomain localhost</div><div class="line">127.0.1.1    my-machine</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://stackoverflow.com/questions/17892762/mysql-this-version-of-mysql-doesnt-yet-support-limit-in-all-any-some-subqu" target="_blank" rel="external">参考</a></li>
</ul>
<h3 id="SQL-聚合"><a href="#SQL-聚合" class="headerlink" title="SQL 聚合"></a><code>SQL</code> 聚合</h3><p><strong>(1) RIGHT JOIN</strong>:</p>
<p><img src="https://www.w3schools.com/sql/img_rightjoin.gif" alt=""></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> column_name(s)</div><div class="line"><span class="keyword">FROM</span> table1</div><div class="line"><span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> table2 <span class="keyword">ON</span> table1.column_name = table2.column_name;</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select webpage_channel.channel_id, count(*) from webpage right join webpage_channel on webpage.channel_id = webpage_channel.channel_id group by webpage_channel.channel_id;</div></pre></td></tr></table></figure>
<p><strong>(2) <code>LIKE</code></strong>:</p>
<ul>
<li><code>%</code>: The percent sign represents zero, one, or multiple characters</li>
<li><code>_</code>: The underscore represents a single character</li>
</ul>
<p><strong>(3) <code>GROUP BY</code></strong>:</p>
<p>The <code>GROUP BY</code> statement is often used with <strong>聚合函数</strong> (COUNT, MAX, MIN, SUM, AVG) to group the result-set by one or more columns.</p>
<p><strong>(4) <code>HAVING</code></strong>:</p>
<p>The <code>HAVING</code> clause was added to SQL because the <code>WHERE</code> keyword could not be used with <strong>聚合函数</strong>.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(CustomerID), Country</div><div class="line"><span class="keyword">FROM</span> Customers</div><div class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> Country</div><div class="line"><span class="keyword">HAVING</span> <span class="keyword">COUNT</span>(CustomerID) &gt; <span class="number">5</span>;</div></pre></td></tr></table></figure>
<h3 id="openSession-阻塞"><a href="#openSession-阻塞" class="headerlink" title="openSession 阻塞"></a><code>openSession</code> 阻塞</h3><p>将 <code>DB</code> 的用户名和密码配置错误了</p>
<h3 id="INNER-JOIN-示例"><a href="#INNER-JOIN-示例" class="headerlink" title="INNER JOIN 示例"></a><code>INNER JOIN</code> 示例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 查询字段</span></div><div class="line"><span class="keyword">select</span> A.channel_id, total_count, <span class="keyword">IFNULL</span>(error_apk_count, <span class="number">0</span>) <span class="keyword">as</span> error_apk_count <span class="keyword">from</span></div><div class="line"></div><div class="line"><span class="comment">-- 表 A</span></div><div class="line">(<span class="keyword">select</span> channel_id, <span class="keyword">count</span>(*) <span class="keyword">as</span> total_count <span class="keyword">from</span> webpage_apk <span class="keyword">where</span> <span class="number">1</span>= <span class="number">1</span> <span class="keyword">group</span> <span class="keyword">by</span> channel_id) <span class="keyword">as</span> A</div><div class="line"></div><div class="line"><span class="comment">-- 表 A 数据全部显示</span></div><div class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></div><div class="line"></div><div class="line"><span class="comment">-- 表 B</span></div><div class="line">(<span class="keyword">select</span> channel_id, <span class="keyword">count</span>(*) <span class="keyword">as</span> error_apk_count <span class="keyword">from</span> webpage_apk <span class="keyword">where</span> apk_is_error = <span class="number">1</span> <span class="keyword">group</span> <span class="keyword">by</span> channel_id) <span class="keyword">as</span> B</div><div class="line"></div><div class="line"><span class="comment">-- 两个表哪个字段进行连接</span></div><div class="line"><span class="keyword">on</span> A.channel_id = B.channel_id</div><div class="line"></div><div class="line"><span class="comment">-- 对最后结果进行排序</span></div><div class="line"><span class="keyword">order</span> <span class="keyword">by</span> total_count <span class="keyword">desc</span></div><div class="line"></div><div class="line"><span class="comment">-- 限制输出</span></div><div class="line"><span class="keyword">limit</span> #&#123;limitNum, jdbcType=<span class="built_in">INTEGER</span>&#125;;</div></pre></td></tr></table></figure>
<h3 id="MySQL-时区问题"><a href="#MySQL-时区问题" class="headerlink" title="MySQL 时区问题"></a><code>MySQL</code> 时区问题</h3><p>系统时间是准确的，但是在 <code>MySQL</code> 内查询的时间比系统时间慢 8 个小时:</p>
<p><img src="2017_12_13_22_12_23.png" alt=""></p>
<p><code>MySQL</code> 使用的也是系统时间:</p>
<p><img src="2017_12_13_22_12_39.png" alt=""></p>
<hr>
<p>默认插入的时间戳也是不正确的，慢了 8 个小时。</p>
<hr>
<p>最终定位，<code>MySQL</code> 是装在 <code>Docker</code> 里面的，可能 <code>Docker</code> 的时区设置有问题。</p>
<h3 id="Varchar-必须指明长度"><a href="#Varchar-必须指明长度" class="headerlink" title="Varchar 必须指明长度"></a><code>Varchar</code> 必须指明长度</h3><p><img src="2018_01_11_10_18_58.png" alt="varchar"></p>
<h3 id="MyCat-分布式数据库分片路由问题"><a href="#MyCat-分布式数据库分片路由问题" class="headerlink" title="MyCat 分布式数据库分片路由问题"></a><code>MyCat</code> 分布式数据库分片路由问题</h3><p>单表数据库存储这张表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from A;</div><div class="line">+<span class="comment">------+------+</span></div><div class="line">| name | age  |</div><div class="line">+<span class="comment">------+------+</span></div><div class="line">| Tom  |   23 |</div><div class="line">| Tom  |   24 |</div><div class="line">| ZK   |   23 |</div><div class="line">| ZK   |   24 |</div><div class="line">| ZK   |   25 |</div><div class="line">+<span class="comment">------+------+</span></div><div class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>
<p>进行如下查询，返回一行，两列，没问题!</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select A_1.ageCount, A_2.nameCount from</div><div class="line">    -&gt; (select count(*) AS ageCount from A where age &gt;= 24) AS A_1,</div><div class="line">    -&gt; (select count(*) AS nameCount from A where name = 'Tom') AS A_2;</div><div class="line">    </div><div class="line">+<span class="comment">----------+-----------+</span></div><div class="line">| ageCount | nameCount |</div><div class="line">+<span class="comment">----------+-----------+</span></div><div class="line">|        3 |         2 |</div><div class="line">+<span class="comment">----------+-----------+</span></div><div class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>
<p>但是这样的查询可能在分布式数据库 <code>MyCat</code> 中出现问题。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.ibm.com/developerworks/cn/data/library/techarticles/dm-1009qinw/" target="_blank" rel="external">编写高效 SQL 语句的最佳实践</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/28/mysql/" data-id="cjcdlsfyj005ediem625wsxwc" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-python" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/28/python/" class="article-date">
  <time datetime="2017-07-28T02:53:39.000Z" itemprop="datePublished">2017-07-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/28/python/">python</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><h3 id="文件的头部"><a href="#文件的头部" class="headerlink" title="文件的头部"></a>文件的头部</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div></pre></td></tr></table></figure>
<h3 id="字符串、列表翻转"><a href="#字符串、列表翻转" class="headerlink" title="字符串、列表翻转"></a>字符串、列表翻转</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</div><div class="line">c = <span class="string">'abcdef'</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> a[::<span class="number">-1</span>]</div><div class="line"><span class="keyword">print</span> c[::<span class="number">-1</span>]</div><div class="line"></div><div class="line"><span class="comment"># 这种写法其实要相对更好一些</span></div><div class="line"><span class="keyword">print</span> list(reversed(a))</div><div class="line"><span class="keyword">print</span> list(reversed(c))</div></pre></td></tr></table></figure>
<h3 id="字符串占位符"><a href="#字符串占位符" class="headerlink" title="字符串占位符"></a>字符串占位符</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这种写法优于 %</span></div><div class="line"><span class="keyword">print</span> <span class="string">'&#123;greet&#125; from &#123;language&#125;.'</span>.format(greet = <span class="string">'Hello World'</span>, language = <span class="string">'Python'</span>)</div></pre></td></tr></table></figure>
<h3 id="代码质量比较高的-Pythonic-风格的代码库"><a href="#代码质量比较高的-Pythonic-风格的代码库" class="headerlink" title="代码质量比较高的 Pythonic 风格的代码库"></a>代码质量比较高的 <code>Pythonic</code> 风格的代码库</h3><ul>
<li><code>Flask</code></li>
<li><code>gevent</code></li>
<li><code>requests</code></li>
</ul>
<h3 id="Python-的三元形式"><a href="#Python-的三元形式" class="headerlink" title="Python 的三元形式"></a><code>Python</code> 的三元形式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">X <span class="keyword">if</span> C <span class="keyword">else</span> Y</div></pre></td></tr></table></figure>
<h3 id="Python-的-switch"><a href="#Python-的-switch" class="headerlink" title="Python 的 switch"></a><code>Python</code> 的 <code>switch</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> n == <span class="number">0</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"0"</span></div><div class="line"><span class="keyword">elif</span> n == <span class="number">1</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"1"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"default"</span></div></pre></td></tr></table></figure>
<h3 id="Python-的-Lazy-evaluation"><a href="#Python-的-Lazy-evaluation" class="headerlink" title="Python 的 Lazy evaluation"></a><code>Python</code> 的 <code>Lazy evaluation</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">()</span>:</span></div><div class="line">    a, b = <span class="number">0</span>, <span class="number">1</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">yield</span> a</div><div class="line">        a, b = b, a+b</div><div class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> islice</div><div class="line"><span class="keyword">print</span> list(islice(fib(), <span class="number">5</span>))</div></pre></td></tr></table></figure>
<h3 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">enum</span><span class="params">(*posarg, **keysarg)</span>:</span></div><div class="line">    <span class="keyword">return</span> type(<span class="string">"Enum"</span>, (object,), dict(zip(posarg, xrange(len(posarg))), **keysarg))</div><div class="line"></div><div class="line">Seasons = enum(<span class="string">"Spring"</span>, <span class="string">"Summer"</span>, <span class="string">"Autumn"</span>, <span class="string">"Winter"</span>)</div><div class="line"></div><div class="line"><span class="comment"># 0</span></div><div class="line"><span class="keyword">print</span> Seasons.Spring</div></pre></td></tr></table></figure>
<h3 id="type"><a href="#type" class="headerlink" title="type"></a><code>type</code></h3><p>按照 <code>Python</code> 理念，为了<strong>充分利用其动态性的特征</strong>是不推荐进行类型检查的。 不刻意进行类型检查，而是<strong>在出错的情况下通过抛出异常</strong>来进行处理，这是较为常见的方式。实际应用中如果为了提高应用程序的<strong>健壮性</strong>，会使用 <code>type()</code> 来检查类型。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> type(a) <span class="keyword">is</span> types.ListType:</div></pre></td></tr></table></figure>
<h3 id="序列迭代"><a href="#序列迭代" class="headerlink" title="序列迭代"></a>序列迭代</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">li = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>]</div><div class="line"><span class="keyword">for</span> i,e <span class="keyword">in</span> enumerate(li):</div><div class="line">    <span class="keyword">print</span> <span class="string">"index:"</span>, i, <span class="string">"element:"</span>, e</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># enumerate 返回的是一个迭代器</span></div><div class="line">e = enumerate(li)</div><div class="line">e.next()</div><div class="line">e.next()</div></pre></td></tr></table></figure>
<hr>
<p>自己实现反序 <code>enumerate</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">myenumerate</span><span class="params">(sequence)</span>:</span></div><div class="line">    n = <span class="number">-1</span></div><div class="line">    <span class="keyword">for</span> elem <span class="keyword">in</span> reversed(sequence):</div><div class="line">        <span class="keyword">yield</span> len(sequence) + n, elem</div><div class="line">        n = n - <span class="number">1</span></div><div class="line">       </div><div class="line">li = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>]</div><div class="line"><span class="keyword">for</span> i,e <span class="keyword">in</span> myenumerate(li):</div><div class="line">    <span class="keyword">print</span> <span class="string">"index:"</span>, i, <span class="string">"element:"</span>, e</div></pre></td></tr></table></figure>
<h3 id="迭代字典"><a href="#迭代字典" class="headerlink" title="迭代字典"></a>迭代字典</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">personinfo = &#123;</div><div class="line">    <span class="string">'name'</span>: <span class="string">'Jon'</span>,</div><div class="line">    <span class="string">'age'</span>: <span class="number">20</span>,</div><div class="line">    <span class="string">'hobby'</span>: <span class="string">'football'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> personinfo.iteritems():</div><div class="line">    <span class="keyword">print</span> k,<span class="string">":"</span>,v</div></pre></td></tr></table></figure>
<h3 id="is-和"><a href="#is-和" class="headerlink" title="is 和 =="></a><code>is</code> 和 <code>==</code></h3><ul>
<li><code>is</code> 用来比较两个对象在内存中<strong>是否拥有同一块内存地址</strong>,相当于 <code>id(x) == id(y)</code> 操作</li>
<li><code>==</code> 表示 <code>equal</code>，是用来<strong>检查两个对象的值是否相等</strong>，实际上调用 <code>a.__eq__(b)</code></li>
</ul>
<h3 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a><code>Unicode</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">strUnicode = <span class="string">u"unicode 字符串"</span></div><div class="line"><span class="comment"># unicode</span></div><div class="line">type(strUnicode)</div></pre></td></tr></table></figure>
<hr>
<p><code>Unicode</code> 编码分为<strong>编码方式</strong>和<strong>实现方式</strong>两个层次。编码方式分为 <code>UCS-2</code> (两个字节编码) 和 <code>UCS-4</code> (四个字节编码)，目前使用的是 <code>UCS-2</code>，占用 16 位的编码空间。Unicode 的实现方式称为 Unicode 转换格式 (Unicode Transformation Format)，简称为 <strong>UTF</strong>，较为常见的是 <strong>UTF-8</strong>，其特点是<strong>对不同范围的字符使用不同长度的编码</strong>。</p>
<ul>
<li><strong><code>decode()</code> 将其他编码对应的字符<font color="red">解码为 <code>Unicode</code></font></strong></li>
<li><strong><code>encode()</code> 将 <font color="red"><code>Unicode</code> 编码转换为另一种编码</font>, <code>Unicode</code> 作为转换过程中的中间编码</strong></li>
</ul>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">fileHandle = open(<span class="string">"test.txt"</span>, r)</div><div class="line"><span class="keyword">print</span> filehandle.read()</div><div class="line">filehandle.close()</div></pre></td></tr></table></figure>
<hr>
<p><img src="2017_11_24_23_25_47.png" alt=""></p>
<p>左边是中文字符串，类型为 <strong><code>str</code></strong>，右边为 <strong>Unicode</strong> 字符串。当两种类型的字符串连接的时候，<code>Python</code> <strong>将左边的中文字符转为 <code>Unicode</code></strong> 再与右边的 <code>Unicode</code> 字符串做连接。而将 <code>str</code> 转为 <code>Unicode</code> 使用系统默认的 <code>ASCII</code> 编码对字符串进行解码，<strong>中</strong> 字的编码 <code>\xd6</code> 对应的值为 216，超出了 <code>ASCII</code> 的编码范围 <code>0 ~ 127</code>， 因此会抛出 <code>UnicodeDecodeError</code> 异常。</p>
<p>使用如下<strong>两种方式将编码统一</strong>就可以解决问题:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">80</span>]: s = <span class="string">"中文测试"</span>.decode(<span class="string">'utf-8'</span>) + <span class="string">u"Chinese Test"</span></div><div class="line">In [<span class="number">81</span>]: s = <span class="string">'中文测试'</span> + <span class="string">u"Chinese Test"</span>.encode(<span class="string">'utf-8'</span>)</div></pre></td></tr></table></figure>
<hr>
<p>默认编码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">68</span>]: <span class="keyword">import</span> sys</div><div class="line">In [<span class="number">69</span>]: sys.getdefaultencoding()</div><div class="line">Out[<span class="number">69</span>]: <span class="string">'ascii'</span></div></pre></td></tr></table></figure>
<h3 id="Python-无自增"><a href="#Python-无自增" class="headerlink" title="Python 无自增"></a><code>Python</code> 无自增</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 会被解释为 +(+i), + 被解释为正号</span></div><div class="line">++i</div></pre></td></tr></table></figure>
<h3 id="Zen-of-Python"><a href="#Zen-of-Python" class="headerlink" title="Zen of Python"></a>Zen of Python</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># some behaviour that I want to implement -&gt; write some __function__</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Python -i xxx.py</span></div><div class="line"><span class="comment"># &gt;&gt;&gt; p1</span></div><div class="line"><span class="comment"># &lt;__main__.Polynomial instance at 0x7fdca8101e18&gt;</span></div><div class="line"><span class="comment"># &gt;&gt;&gt; repr(p1)</span></div><div class="line"><span class="comment"># '&lt;__main__.Polynomial instance at 0x7fdca8101e18&gt;'</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># ====after add method __repr__====</span></div><div class="line"><span class="comment"># &gt;&gt;&gt; p1</span></div><div class="line"><span class="comment"># Polynomial(*(1, 2, 3))</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># ====after add method __add__===</span></div><div class="line"><span class="comment"># &gt;&gt;&gt; p1 + p2</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Polynomial</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *coeffs)</span>:</span></div><div class="line">        self.coeffs = coeffs</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">'''</span></div><div class="line"><span class="string">        give me the principal representation of this class</span></div><div class="line"><span class="string">        '''</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'Polynomial(*&#123;!r&#125;)'</span>.format(self.coeffs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span></div><div class="line">        <span class="keyword">return</span> Polynomial(*(x + y <span class="keyword">for</span> x, y <span class="keyword">in</span> zip(self.coeffs, other.coeffs)))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> len(self.coeffs)</div><div class="line"></div><div class="line">p1 = Polynomial(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment"># x^2 + 2x + 3</span></div><div class="line">p2 = Polynomial(<span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>) <span class="comment"># 3x^2 + 4x + 3</span></div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/28/python/" data-id="cjcdlsfyo005ndiemdnt833eb" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-Servlet" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/27/Servlet/" class="article-date">
  <time datetime="2017-07-27T07:53:44.000Z" itemprop="datePublished">2017-07-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/27/Servlet/">Servlet</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h3 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h3><p>A servlet is a Java™ technology-based <strong>Web component</strong>, managed by a container, that <strong>generates dynamic content</strong>.</p>
<p>The two classes in the <strong>Java Servlet API that implement the <code>Servlet</code> interface are <code>GenericServlet</code> and <code>HttpServlet</code></strong>.</p>
<hr>
<p>The basic <strong><code>Servlet</code></strong> interface defines a <strong><code>service</code></strong> method for handling client requests. This method is called for each request that the servlet container routes to an instance of a servlet.</p>
<p>The <strong><code>HttpServlet</code></strong> abstract subclass <strong>adds additional methods</strong> beyond the basic <code>Servlet</code> interface that are automatically called by the service method in the <code>HttpServlet</code> class to aid in processing HTTP-based requests. These methods are:</p>
<ul>
<li><code>doGet</code> for handling HTTP GET requests</li>
<li><code>doPost</code> for handling HTTP POST requests</li>
<li><code>doPut</code> for handling HTTP PUT</li>
<li><code>doDelete</code> for handling HTTP DELETE requests</li>
<li><code>doHead</code> for handling HTTP HEAD requests</li>
<li><code>doOptions</code> for handling HTTP OPTIONS requests</li>
<li><code>doTrace</code> for handling HTTP TRACE requests</li>
</ul>
<hr>
<p><strong>A servlet is managed through a well defined life cycle</strong> that defines how it is loaded and instantiated, is initialized, handles requests from clients, and is taken out of service. This life cycle is expressed in the API by the <code>init</code>, <code>service</code>, and <code>destroy</code> methods of the <code>javax.servlet.Servlet</code> interface that <strong>all servlets must implement directly or indirectly through the <code>GenericServlet</code> or <code>HttpServlet</code> abstract classes</strong>.</p>
<p><strong>The servlet container is responsible for loading and instantiating servlets</strong>. The loading and instantiation can occur when the container is started, or delayed until the container determines the servlet is needed to service a request. </p>
<p><strong>The servlet container loads the servlet class using normal Java class loading facilities.</strong> The loading may be from a local file system, a remote file system, or other network services.</p>
<p>The container initializes the servlet instance by calling the <code>init</code> method of the <code>Servlet</code> interface with a unique (per servlet declaration) object implementing the <code>ServletConfig</code> interface. <strong>This configuration object allows the servlet to access name-value initialization parameters from the Web application’s configuration information. The configuration object also gives the servlet access to an object (implementing the <code>ServletContext</code> interface) that describes the servlet’s runtime environment</strong>. </p>
<p>After a servlet is properly initialized, the servlet container may use it to handle client requests. Requests are represented by request objects of type <code>ServletRequest</code>. The servlet fills out response to requests by calling methods of a provided object of type <code>ServletResponse</code>. These objects are passed as parameters to the service method of the <code>Servlet</code> interface.</p>
<p>In the case of an HTTP request, the objects provided by the container are of types <code>HttpServletRequest</code> and <code>HttpServletResponse</code>.</p>
<hr>
<p>If the servlet container provides <strong><code>multipart/form-data</code></strong> processing, the data is made available through the following methods in <code>HttpServletRequest</code>:</p>
<ul>
<li><code>public Collection&lt;Part&gt; getParts()</code></li>
<li><code>public Part getPart(String name)</code></li>
</ul>
<p>If the servlet container does not provide the <code>multi-part/form-data</code> processing, the data will be available through the <code>HttpServletReuqest.getInputStream</code>.</p>
<hr>
<h4 id="Request-data-encoding"><a href="#Request-data-encoding" class="headerlink" title="Request data encoding"></a>Request data encoding</h4><p>The default encoding of a request the container uses to create the request reader and parse POST data must be <code>“ISO-8859-1”</code> if none has been specified by the client request. However, in order to indicate to the developer, in this case, the failure of the client to send a character encoding, the container returns <code>null</code> from the <code>getCharacterEncoding</code> method.</p>
<p>If the client hasn’t set character encoding and the request data is encoded with a different encoding than the default as described above, breakage can occur. To remedy this situation, a new method <code>setCharacterEncoding(String enc)</code> has been added to the <code>ServletRequest</code> interface. Developers can override the character encoding supplied by the container by calling this method. It must be called prior to parsing any post data or reading any input from the request.</p>
<h3 id="Servlet-Container"><a href="#Servlet-Container" class="headerlink" title="Servlet Container"></a>Servlet Container</h3><p>The servlet container is a part of a Web server or application server that <strong>provides the network services</strong> over which requests and responses are sent, <strong>decodes MIME-based requests</strong>, and <strong>formats MIME-based responses</strong>. A servlet container also <strong>contains and manages servlets through their lifecycle.</strong></p>
<h3 id="javax-servlet-ServletContext"><a href="#javax-servlet-ServletContext" class="headerlink" title="javax.servlet.ServletContext"></a><code>javax.servlet.ServletContext</code></h3><p><code>javax.servlet.ServletContext</code> 是用来充当<strong><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html?is-external=true" target="_blank" rel="external">媒人角色</a></strong>，用来实现的:</p>
<p><img src="Servlet_Context_Config.jpg" alt=""></p>
<p>The Container Provider is responsible for providing an implementation of the <code>ServletContext</code> interface in the servlet container. Using the <code>ServletContext</code> object, a servlet can <strong>log events, obtain URL references to resources, and set and store attributes that other servlets in the context can access</strong>. </p>
<h4 id="Initialization-Parameters"><a href="#Initialization-Parameters" class="headerlink" title="Initialization Parameters"></a>Initialization Parameters</h4><p>The following methods of the <code>ServletContext</code> interface allow the servlet <strong>access to context initialization parameters</strong> associated with a Web application as specified by the Application Developer in the deployment descriptor:</p>
<ul>
<li><code>getInitParameter</code></li>
<li><code>getInitParameterNames</code></li>
</ul>
<h4 id="Configuration-methods"><a href="#Configuration-methods" class="headerlink" title="Configuration methods"></a>Configuration methods</h4><p>The following methods are added to <code>ServletContext</code> since Servlet 3.0 to <strong>enable programmatic definition of servlets, filters and the url pattern that they map to</strong>. </p>
<p><strong>Programmatically adding and configuring Servlets:</strong></p>
<p>The return value of this method is a <code>ServletRegistration</code> or a <code>ServletRegistration.Dynamic</code> object which further allows you to setup the other parameters of the servlet like <code>init-params</code>, <code>url-mappings</code> etc.</p>
<ul>
<li><code>addServlet(String servletName, String className)</code></li>
</ul>
<p><strong>Programmatically adding and configuring Filters:</strong></p>
<ul>
<li><code>addFilter(String filterName, String className)</code></li>
</ul>
<p><strong>Programmatically adding and configuring Listeners:</strong></p>
<ul>
<li><code>void addListener(String className)</code></li>
</ul>
<hr>
<h4 id="Context-Attributes"><a href="#Context-Attributes" class="headerlink" title="Context Attributes"></a>Context Attributes</h4><p>A servlet can bind an object attribute into the context by name. <strong>Any attribute bound into a context is available to any other servlet that is part of the same Web application</strong>. The following methods of ServletContext interface allow access to this functionality:</p>
<ul>
<li><code>setAttribute</code></li>
<li><code>getAttribute</code></li>
</ul>
<p>Context attributes are local to the JVM in which they were created. This prevents <code>ServletContext</code> attributes from being a shared memory store in a distributed container. When information needs to be shared between servlets running in a distributed environment, <strong>the information should be placed into a session, stored in a database, or set in an Enterprise JavaBeans™ component</strong>.</p>
<h4 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h4><p>The <code>ServletContext</code> interface provides direct access only to the hierarchy of static content documents that are part of the Web application, including HTML, GIF, and JPEG files, via the following methods of the <code>ServletContext</code> interface:</p>
<ul>
<li><code>getResource</code></li>
<li><code>getResourceAsStream</code></li>
</ul>
<p>The <code>getResource</code> and <code>getResourceAsStream</code> methods take a String with a leading “/” as an argument that gives the path of the resource relative to the <strong>root of the context</strong> or relative to the <code>META-INF/resources</code> directory of a <strong>JAR file</strong> inside the web application’s <code>WEB-INF/lib</code> directory</p>
<h3 id="Filtering"><a href="#Filtering" class="headerlink" title="Filtering"></a>Filtering</h3><p>A filter is a reusable piece of code that can transform the content of HTTP requests, responses, and header information. Filters do not generally create a response or respond to a request as servlets do, rather they <strong>modify or adapt the requests for a resource, and modify or adapt responses from a resource</strong>.</p>
<p>The application developer creates a filter by implementing the <strong><code>javax.servlet.Filter</code> interface</strong> and providing <strong>a public constructor taking no arguments</strong>. The class is packaged in the Web Archive along with the static content and servlets that make up the Web application.</p>
<h3 id="Sessions"><a href="#Sessions" class="headerlink" title="Sessions"></a>Sessions</h3><p>This specification defines a simple <code>HttpSession</code> interface that allows a servlet container to use any of several approaches to track a user’s session without involving the Application Developer in the nuances of any one approach.</p>
<h4 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h4><p>Session tracking through HTTP cookies is the most used session tracking mechanism and is required to be supported by all servlet containers.</p>
<p>The container sends a cookie to the client. The client will then return the cookie on each subsequent request to the server, unambiguously associating the request with a session. The standard name of the session tracking cookie must be <strong><code>JSESSIONID</code></strong>. Containers may allow the name of the session tracking cookie to be customized through container specific configuration.</p>
<p>All servlet containers MUST provide an ability to configure whether or not the container marks the session tracking cookie as <code>HttpOnly</code>. The established configuration must apply to all contexts for which a context specific configuration has not been established (see <code>SessionCookieConfig</code> javadoc for more details).</p>
<hr>
<p>Associated with each session, there is a string containing a unique identifier, which is referred to as the session id. The value of the session id can be obtained by calling <code>javax.servlet.http.HttpSession.getId()</code> and can be changed after creation by invoking <code>javax.servlet.http.HttpServletRequest.changeSessionId()</code>.</p>
<h4 id="Session-Timeouts"><a href="#Session-Timeouts" class="headerlink" title="Session Timeouts"></a>Session Timeouts</h4><p>In the HTTP protocol, there is no explicit termination signal when a client is no longer active. This means that the <strong>only mechanism</strong> that can be used to indicate when a client is no longer active is <strong>a time out period</strong>.</p>
<p>The default time out period for sessions is defined by the servlet container and can be obtained via the <code>getMaxInactiveInterval</code> method of the <code>HttpSession</code> interface. This time out can be changed by the Developer using the <code>setMaxInactiveInterval</code> method of the <code>HttpSession</code> interface. The time out periods used by these methods are defined in seconds. By definition, if the time out period for a session is set to 0 or lesser value, the session will never expire. The session invalidation will not take effect until all servlets using that session have exited the service method. Once the session invalidation is initiated, a new request must not be able to see that session.</p>
<p>The distributed servlet container must support the mechanism necessary for migrating objects that implement <strong><code>Serializable</code></strong>.</p>
<h3 id="War-Web-Archive"><a href="#War-Web-Archive" class="headerlink" title="War - Web Archive"></a>War - Web Archive</h3><p><img src="lecture-3-servlets-session-management-7-638.jpg" alt=""></p>
<p><img src="Context+Adheres+to+Java+Servlet+Specifications.jpg" alt=""></p>
<h3 id="Ear-File"><a href="#Ear-File" class="headerlink" title="Ear File"></a>Ear File</h3><p><img src="ear.png" alt=""></p>
<h3 id="How-do-servlets-work-Instantiation-sessions-shared-variables-and-multithreading"><a href="#How-do-servlets-work-Instantiation-sessions-shared-variables-and-multithreading" class="headerlink" title="How do servlets work? Instantiation, sessions, shared variables and multithreading"></a>How do servlets work? Instantiation, sessions, shared variables and multithreading</h3><h4 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h4><p>When the servlet container (like Apache Tomcat) starts up, it will deploy and load all its web applications. When a web application is loaded, the servlet container <strong>创建 the <code>ServletContext</code> 一次</strong> and keeps it in the server’s memory. The web app’s <code>web.xml</code> file is parsed, and each <code>&lt;servlet&gt;</code>, <code>&lt;filter&gt;</code> and <code>&lt;listener&gt;</code> found (or each class annotated with <code>@WebServlet</code>, <code>@WebFilter</code> and <code>@WebListener</code> respectively) is instantiated <strong>一次</strong> and kept in the server’s memory as well. For each instantiated filter, its <strong><code>init()</code></strong> method is invoked with a new <code>FilterConfig</code>.</p>
<p>When the servlet container shuts down, it unloads all web applications, invokes the <strong><code>destroy()</code></strong> method of all its initialized servlets and filters, and all <code>ServletContext</code>, <code>Servlet</code>, <code>Filter</code> and <code>Listener</code> instances are trashed.</p>
<p>When a <code>Servlet</code> has a <code>&lt;servlet&gt;&lt;load-on-startup&gt;</code> or <code>@WebServlet</code>(loadOnStartup) value greater than 0, its <strong><code>init()</code></strong> method is also invoked <strong>启动的时候</strong> with a new <strong><code>ServletConfig</code></strong>. Those servlets are initialized in the same order specified by that value (1 -&gt; 1st, 2 -&gt; 2nd, etc). If the same value is specified for more than one servlet, then each of those servlets is loaded in the order they appear in the <code>web.xml</code>, or <code>@WebServlet</code> classloading. In the event the “load-on-startup” value is <strong>没有</strong>, the <code>init()</code> method will be invoked whenever the <strong>HTTP 请求</strong> hits that servlet for <strong>第一次</strong>.</p>
<ul>
<li><a href="https://stackoverflow.com/questions/3106452/how-do-servlets-work-instantiation-sessions-shared-variables-and-multithreadi" target="_blank" rel="external">参考</a></li>
</ul>
<h4 id="HttpServletRequest-and-HttpServletResponse"><a href="#HttpServletRequest-and-HttpServletResponse" class="headerlink" title="HttpServletRequest and HttpServletResponse"></a><code>HttpServletRequest</code> and <code>HttpServletResponse</code></h4><p>The servlet container is attached to a web server that listens for HTTP requests on a certain port number (port 8080 is usually used during development and port 80 in production). When a client (user with a web browser) sends an HTTP request, the servlet container creates new <code>HttpServletRequest</code> and <code>HttpServletResponse</code> objects and 经过一系列的 <strong><code>Filter</code> 过滤链</strong> and, eventually, the <code>Servlet</code> instance.</p>
<p>In the case of filters, the <code>doFilter()</code> method is invoked. When its code calls <code>chain.doFilter(request, response)</code>, the request and response continue on to the next filter, or hit the servlet if there are no remaining filters.</p>
<p>In the case of servlets, the <code>service()</code> method is invoked. By default, this method determines which one of the doXxx() methods to invoke based off of  request.getMethod(). If the determined method is absent from the servlet, then an HTTP 405 error is returned in the response.</p>
<p>The request object provides access to all of the information about the HTTP request, such as its headers and body. The response object provides the ability to control and send the HTTP response the way you want by, for instance, allowing you to set the headers and the body (usually with generated HTML content from a JSP file). When the HTTP response is committed and finished, both the request and response objects are recycled and made for reuse.</p>
<h4 id="HttpSession"><a href="#HttpSession" class="headerlink" title="HttpSession"></a><code>HttpSession</code></h4><p>When a client visits the webapp <strong>第一次</strong> and/or the <code>HttpSession</code> is obtained for the first time via <code>request.getSession()</code>, the servlet container creates a new <code>HttpSession</code> object, generates a long and unique ID (which you can get by <code>session.getId()</code>), and store it in the server’s <strong>内存</strong>. The servlet container also sets a <code>Cookie</code> in the Set-Cookie header of the HTTP response with <code>JSESSIONID</code> as its name and the unique session ID as its value.</p>
<p><img src="ABDSX.png" alt=""><br><img src="IWAF3.png" alt=""></p>
<p>As per the HTTP cookie specification (a contract a decent web browser and web server have to adhere to), the client (the web browser) is required to send this cookie back in subsequent requests in the Cookie header for as long as the cookie is valid (i.e. the unique ID must refer to an unexpired session and the domain and path are correct). Using your browser’s built-in HTTP traffic monitor, you can verify that the cookie is valid (press F12 in Chrome / Firefox 23+ / IE9+, and check the Net/Network tab). The servlet container will check the Cookie header of every incoming HTTP request for the presence of the cookie with the name JSESSIONID and use its value (the session ID) to <strong>从内存中取得关联的 <code>HttpSession</code></strong>.</p>
<p>The HttpSession stays alive until it has not been used for more than the timeout value specified in <code>&lt;session-timeout&gt;</code>, a setting in <code>web.xml</code>. The timeout value defaults to <strong>30 分钟</strong>. So, when the client doesn’t visit the web app for longer than the time specified, the servlet container trashes the session. Every subsequent request, even with the cookie specified, will not have access to the same session anymore; the servlet container will create a new session.</p>
<p>On the client side, the session cookie stays alive for as long as the browser instance is running. So, if the client closes the browser instance (all tabs/windows), then the session is trashed on the client’s side. In a new browser instance, the cookie associated with the session wouldn’t exist, so it would no longer be sent. This causes an entirely new <code>HTTPSession</code> to be created, with an entirely new session cookie begin used.</p>
<hr>
<p><strong>为什么我们需要 <code>Session</code></strong>:</p>
<p><img src="2017_11_20_23_11_04.png" alt=""></p>
<p><strong>管理 <code>Session</code> 的几种方式</strong>:</p>
<p><img src="2017_11_20_23_12_10.png" alt=""></p>
<h4 id="In-a-nutshell"><a href="#In-a-nutshell" class="headerlink" title="In a nutshell"></a>In a nutshell</h4><ul>
<li>The <code>ServletContext</code> lives for as long as the web app lives. It is <strong>所有请求所有会话共享</strong></li>
<li>The <code>HttpSession</code> lives for as long as the client is interacting with the web app with the <strong>相同浏览器实例</strong>, and the session hasn’t <strong>超时</strong> at the server side. It is shared among <strong>所有请求</strong> in the <strong>相同会话</strong>.</li>
<li>The <code>HttpServletRequest</code> and <code>HttpServletResponse</code> live from the time the servlet receives an HTTP request from the client, until the complete response (the web page) has arrived. It is <strong>不会共享</strong> elsewhere.</li>
<li>All Servlet, <code>Filter</code> and <code>Listener</code> instances live as long as the web app lives. They are <strong>所有请求所有会话共享</strong></li>
<li>Any <strong>属性</strong> that is defined in <code>ServletContext</code>, <code>HttpServletRequest</code> and <code>HttpSession</code> will live as long as the object in question lives. The object itself represents the “scope” in bean management frameworks such as <code>JSF</code>, <code>CDI</code>, <strong><code>Spring</code></strong>, etc. Those frameworks store their scoped beans as an attribute of its closest matching scope.</li>
</ul>
<h4 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h4><p>That said, your major concern is possibly thread safety. You should now know that servlets and filters are shared among all requests. That’s the nice thing of Java, it’s <strong>多线程</strong> and different threads (read: HTTP requests) <strong>使用相同实例</strong>. It would otherwise be too expensive to recreate, <code>init()</code> and <code>destroy()</code> them for every single request.</p>
<p>You should also realize that you should never assign any request or session scoped data as <strong>实例上的某个变量</strong> of a servlet or filter. It will be shared among all other requests in other sessions. That’s <strong>非线程安全</strong>! The below example illustrates this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Object thisIsNOTThreadSafe;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">        Object thisIsThreadSafe;</div><div class="line"></div><div class="line">        thisIsNOTThreadSafe = request.getParameter(<span class="string">"foo"</span>); <span class="comment">// BAD!! Shared among all requests!</span></div><div class="line">        thisIsThreadSafe = request.getParameter(<span class="string">"foo"</span>); <span class="comment">// OK, this is thread safe.</span></div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Jetty"><a href="#Jetty" class="headerlink" title="Jetty"></a><a href="https://www.youtube.com/watch?v=8QCC4HaSy58" target="_blank" rel="external"><code>Jetty</code></a></h3><ul>
<li><code>Jetty 7</code> –&gt; <code>Servlet 2.5</code></li>
<li><code>Jetty 8,9</code> –&gt; <code>Servlet 3.0</code></li>
<li><code>Jetty 9.1</code> –&gt; <code>Servlet 3.1</code></li>
</ul>
<p>Rethink locking for “mechanical sympathy”:</p>
<ul>
<li>Jetty 9 core rewrite taking that in account</li>
<li>Keep thread context switching at minimum</li>
<li>Reduce/Eliminate false sharing</li>
<li>Use concurrent data structures</li>
<li>Avoid <code>synchronized</code> in favor of atomic state machines</li>
</ul>
<p>Jetty 9.1 is 30% faster than Jetty 8</p>
<ul>
<li>Easy to push it to 70k or more requests/s    </li>
<li>Easy to get it to 250k connections</li>
</ul>
<p>HTTP Limits (HTTP is an old protocol):</p>
<ul>
<li>Not bidirectional</li>
<li>No mutiplexing</li>
<li>No resource correlation</li>
</ul>
<p>Servlet Container need to become polyglot:</p>
<ul>
<li><code>WebSocket</code>: to support bidirectional communication</li>
<li><code>SPDY</code>: to transport more efficiently today’s web</li>
</ul>
<h3 id="HttpServletResponse-isCommitted"><a href="#HttpServletResponse-isCommitted" class="headerlink" title="HttpServletResponse.isCommitted"></a><code>HttpServletResponse.isCommitted</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (someCondition) &#123;</div><div class="line">        sendRedirect();</div><div class="line">    &#125;</div><div class="line">    forward(); <span class="comment">// This is STILL invoked when someCondition is true!</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你将会得到如下异常:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalStateException: Cannot forward after response has been committed</div></pre></td></tr></table></figure>
<p>If the if statement calls a <code>forward()</code> and you’re afterwards calling <code>sendRedirect()</code> or <code>sendError()</code>, then below exception will be thrown:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalStateException: Cannot call sendRedirect() after the response has been committed</div></pre></td></tr></table></figure>
<p>你可以通过添加一个 <code>return</code> 语句来修复这个问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (someCondition) &#123;</div><div class="line">        sendRedirect();</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    forward();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>另外一种原因:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">()</span> </span>&#123;</div><div class="line">    out.write(<span class="string">"some string"</span>);</div><div class="line">    <span class="comment">// ... </span></div><div class="line">    forward(); <span class="comment">// Fail!</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>响应缓冲池的大小大多为 <code>2KB~10KB</code>，so if you write more than 2KB to it, then it will be committed and <code>forward()</code> will fail the same way:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalStateException: Cannot forward after response has been committed</div></pre></td></tr></table></figure>
<h3 id="304-状态码-否则读取资源"><a href="#304-状态码-否则读取资源" class="headerlink" title="304 状态码, 否则读取资源"></a><code>304</code> 状态码, 否则读取资源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> lastModified = getLastModified(uri);</div><div class="line"><span class="keyword">long</span> since = request.getDateHeader(<span class="string">"If-Modified-Since"</span>);</div><div class="line"><span class="keyword">if</span> (since &gt;= lastModified) &#123;</div><div class="line">    <span class="comment">// Status code (304) indicating that a conditional GET operation found that the resource was available and not modified.</span></div><div class="line">    response.sendError(HttpServletResponse.SC_NOT_MODIFIED);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>否则读取资源:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">InputStream input = getInputStream(uri);</div><div class="line"></div><div class="line">ByteArrayOutputStream output = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">byte</span>[] data = output.toByteArray();</div><div class="line"></div><div class="line">response.setDateHeader(<span class="string">"Last-Modified"</span>, lastModified);</div><div class="line">OutputStream output = response.getOutputStream();</div><div class="line">output.write(data);</div><div class="line">output.flush();</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/27/Servlet/" data-id="cjcdlsfw70025dieme565l4my" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-mybatis" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/23/mybatis/" class="article-date">
  <time datetime="2017-07-23T13:40:38.000Z" itemprop="datePublished">2017-07-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/23/mybatis/">MyBatis</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h2><p><img src="mybatis-logo.png" alt=""></p>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><img src="mybatis_architecture.jpg" alt=""></p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.mybatis/mybatis --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SqlSession session = sqlSessionFactory.openSession();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  BlogMapper mapper = session.getMapper(BlogMapper.class);</div><div class="line">  Blog blog = mapper.selectBlog(<span class="number">101</span>);</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">  session.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>确保整个应用程序只有<strong>一个 <code>SqlSessionFactory</code> 实例</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InputStream inputStream = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</div><div class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</div></pre></td></tr></table></figure>
<p>编写 <strong><code>MyBatis</code> 数据库配置文件</strong> <code>mybatis-config.xml</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE configuration</span></div><div class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></div><div class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">"com.zk.User"</span> <span class="attr">alias</span>=<span class="string">"user"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/crawl"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"UserMapper.xml"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<p>编写 <strong><code>MyBatis</code> - SQL 操作映射文件</strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper</span></div><div class="line"><span class="meta">PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></div><div class="line"><span class="meta">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.zk.UserMapper"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></div><div class="line">    select id, name, password from users where id = #&#123;id&#125;</div><div class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertUser"</span> <span class="attr">parameterType</span>=<span class="string">"user"</span>&gt;</span></div><div class="line">    insert into users(name, password) values (#&#123;name&#125;, #&#123;password&#125;)</div><div class="line">  <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteUser"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></div><div class="line">    delete from users where id = #&#123;id&#125;;</div><div class="line">  <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure>
<p>执行插入操作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">InputStream inputStream = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</div><div class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</div><div class="line"></div><div class="line">SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">UserMapper userMapper = sqlSession.getMapper(UserMapper.class);</div><div class="line"></div><div class="line">User user = <span class="keyword">new</span> User();</div><div class="line">user.setName(<span class="string">"Jack"</span>);</div><div class="line">user.setPassword(<span class="string">"123456"</span>);</div><div class="line"></div><div class="line">userMapper.insertUser(user);</div><div class="line"></div><div class="line">sqlSession.commit();</div><div class="line">sqlSession.close();</div></pre></td></tr></table></figure>
<blockquote>
<p>注: 默认必须调用 <strong><code>sqlSession.commit()</code></strong> 之后才会提交操作</p>
</blockquote>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a><a href="http://www.mybatis.org/mybatis-3/logging.html" target="_blank" rel="external">日志</a></h3><p>MyBatis provides logging information through the use of an internal log factory. The internal log factory will delegate logging information to one of the following log implementations:</p>
<ul>
<li>SLF4J</li>
<li>Apache Commons Logging</li>
<li>Log4j 2</li>
<li>Log4j</li>
<li>JDK logging</li>
</ul>
<p><strong>The logging solution chosen is based on runtime introspection by the internal MyBatis log factory.</strong></p>
<hr>
<p>添加依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>放置 <code>log4j.properties</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># Global logging configuration</div><div class="line">log4j.rootLogger=DEBUG,stdout</div><div class="line"># MyBatis logging configuration</div><div class="line">log4j.logger.org.mybatis=DEBUG</div><div class="line"># Console output...</div><div class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.stdout.layout.ConversionPattern=%5p %d %C: %m%n</div></pre></td></tr></table></figure>
<hr>
<p>下面的方法也可以:</p>
<p>(1) 查看全部日志:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">log4j.rootLogger = DEBUG, stdout</div></pre></td></tr></table></figure>
<p>(2) 查看某个 <code>Mapper</code> 方法里面的日志:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># root 调整为 INFO</div><div class="line">log4j.rootLogger = INFO, stdout</div><div class="line"></div><div class="line"># 这个 Logger 调整为 DEBUG</div><div class="line">log4j.logger.com.buptnsrc.appcrawl.mapper.WebpageApkMapper.selectRankingValidApkCount = DEBUG, S</div><div class="line">log4j.additivity.com.buptnsrc.appcrawl.mapper.WebpageApkMapper.selectRankingValidApkCount = false</div></pre></td></tr></table></figure>
<hr>
<p>显示指明 <code>configuration</code> 打印日志所依赖的 <code>Jar</code> 包:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">settings</span>&gt;</span></div><div class="line">    ...</div><div class="line">    <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"LOG4J"</span>/&gt;</span></div><div class="line">    ...</div><div class="line">  <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="传递多个参数-Map"><a href="#传递多个参数-Map" class="headerlink" title="传递多个参数 - Map"></a>传递多个参数 - <code>Map</code></h3><p>将 <code>parameterType</code> 的值设置为 <strong><code>map</code></strong> 即可接受多个参数:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUseWithMapParam"</span> <span class="attr">parameterType</span>=<span class="string">"map"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></div><div class="line">  select id, name, password from users where name = #&#123;name&#125; and password = #&#123;password&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</div><div class="line">    <span class="function">User <span class="title">getUseWithMapParam</span><span class="params">(Map&lt;String, String&gt; params)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">params.put(<span class="string">"name"</span>, <span class="string">"Zhaokun"</span>);</div><div class="line">params.put(<span class="string">"password"</span>, <span class="string">"123456"</span>);</div><div class="line">User user = userMapper.getUseWithMapParam(params);</div></pre></td></tr></table></figure>
<h3 id="传递多个参数-Param"><a href="#传递多个参数-Param" class="headerlink" title="传递多个参数 - @Param"></a>传递多个参数 - <code>@Param</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</div><div class="line">    <span class="function">User <span class="title">getUseWithMapParam</span><span class="params">(@Param(<span class="string">"name"</span>)</span> String name, @<span class="title">Param</span><span class="params">(<span class="string">"password"</span>)</span> String password)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUseWithMapParam"</span> <span class="attr">parameterType</span>=<span class="string">"map"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></div><div class="line">  select id, name, password from users where name = #&#123;name&#125; and password = #&#123;password&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="插入的时候自动回填主键"><a href="#插入的时候自动回填主键" class="headerlink" title="插入的时候自动回填主键"></a>插入的时候自动回填主键</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertUserWithAutoGenerateId"</span> <span class="attr">parameterType</span>=<span class="string">"user"</span></span></div><div class="line"><span class="tag">        <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></div><div class="line">  insert into users(name, password) values (#&#123;name&#125;, #&#123;password&#125;)</div><div class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertUserWithAutoGenerateId</span><span class="params">(User user)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">User user = createUser();</div><div class="line">userMapper.insertUserWithAutoGenerateId(user);</div><div class="line">System.out.println(user.getId());</div></pre></td></tr></table></figure>
<h3 id="传递多个参数-Param-1"><a href="#传递多个参数-Param-1" class="headerlink" title="传递多个参数 - @Param"></a>传递多个参数 - <code>@Param</code></h3><p><strong>不用声明 <code>parameterType</code></strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUseWithAnnotationParam"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></div><div class="line">  select id, name, password from users where name = #&#123;name&#125; and password = #&#123;password&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</div><div class="line">    <span class="function">User <span class="title">getUseWithAnnotationParam</span><span class="params">(@Param(<span class="string">"name"</span>)</span> String name, @<span class="title">Param</span><span class="params">(<span class="string">"password"</span>)</span> String password)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参数设置精度"><a href="#参数设置精度" class="headerlink" title="参数设置精度"></a>参数设置精度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#&#123;price, javaType=double, jdbcType=NUMERIC, numericScale=2&#125;</div></pre></td></tr></table></figure>
<h3 id="association-一对一级联"><a href="#association-一对一级联" class="headerlink" title="association 一对一级联"></a>association 一对一级联</h3><p><strong>学生拥有学生卡</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> StudentCard studentCard;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentCard</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> cardId;</div><div class="line">    <span class="keyword">private</span> String cardName;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"studentAndCardMap"</span> <span class="attr">type</span>=<span class="string">"com.zk.Student"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"student.id"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"user_name"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"studentCard"</span> <span class="attr">javaType</span>=<span class="string">"com.zk.StudentCard"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"cardId"</span> <span class="attr">column</span>=<span class="string">"card_id"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"cardName"</span> <span class="attr">column</span>=<span class="string">"card_name"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">association</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getStudent"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultMap</span>=<span class="string">"studentAndCardMap"</span>&gt;</span></div><div class="line">  select student.id as user_id,</div><div class="line">  student.name as user_name,</div><div class="line">  student_card.id as card_id,</div><div class="line">  student_card.name as card_name</div><div class="line">  FROM student left outer join student_card</div><div class="line">  ON student.id = student_card.user_id</div><div class="line">  WHERE student.id = #&#123;id&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="collection-一对多级联"><a href="#collection-一对多级联" class="headerlink" title="collection 一对多级联"></a>collection 一对多级联</h3><p><strong>学生拥有多门课程</strong>:</p>
<h3 id="If-元素"><a href="#If-元素" class="headerlink" title="If 元素"></a>If 元素</h3><p><strong>某个元素不为 <code>null</code> 且不为空字符串就查询</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;select id=<span class="string">"selectByPrimaryKey"</span> resultMap=<span class="string">"BaseResultMap"</span> parameterType=<span class="string">"java.lang.String"</span> &gt;</div><div class="line">  select user_name, user_password</div><div class="line">  from asec_phishingapp_review_task</div><div class="line">  where <span class="number">1</span> = <span class="number">1</span></div><div class="line">  &lt;<span class="keyword">if</span> test=<span class="string">"userId != null and userId != ''"</span>&gt;</div><div class="line">    <span class="function">and user_id like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, #&#123;userId&#125;, <span class="string">'%'</span>)</span></span></div><div class="line"><span class="function">  &lt;/<span class="keyword">if</span>&gt;</span></div><div class="line"><span class="function">&lt;/select&gt;</span></div></pre></td></tr></table></figure>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><h4 id="1-分清-和-的区别"><a href="#1-分清-和-的区别" class="headerlink" title="(1) 分清 # 和 $ 的区别"></a>(1) <a href="https://segmentfault.com/a/1190000004617028" target="_blank" rel="external">分清 <code>#</code> 和 <code>$</code> 的区别</a></h4><p><strong>不要误把 <code>#</code> 写成了 <code>$</code></strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;select id=&quot;selectBy&quot; resultMap=&quot;BaseResultMap&quot;&gt;</div><div class="line">  select &lt;include refid=&quot;Base_Column_List&quot; /&gt;</div><div class="line">  from asec_phishingapp_review_task</div><div class="line">  where package_name = $&#123;packageName&#125; AND cer_hash = $&#123;cerHash&#125;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
<p>对于同样的一句 SQL 语句，如:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">name</span> = #&#123;<span class="keyword">name</span>&#125;;</div></pre></td></tr></table></figure>
<ul>
<li><code>#{name}</code> 解析为一个 JDBC 预编译语句（prepared statement）的<strong>参数标记符 <code>?</code></strong>:</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">name</span> = ?;</div></pre></td></tr></table></figure>
<ul>
<li><code>${name}</code> 仅仅为一个<strong>纯碎的 string 替换</strong>，在动态 SQL 解析阶段将会进行变量替换:</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">"Tom"</span>;</div></pre></td></tr></table></figure>
<h4 id="2-分清-resultMap-和-resultType"><a href="#2-分清-resultMap-和-resultType" class="headerlink" title="(2) 分清 resultMap 和 resultType:"></a>(2) 分清 <code>resultMap</code> 和 <code>resultType</code>:</h4><p>这两个不能同时存在</p>
<ul>
<li><strong><code>resultMap</code> 自定义映射关系</strong>来将表的列名转换为类的字段:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;resultMap id=&quot;BaseResultMap&quot; type=&quot;com.zk.User&quot; &gt;</div><div class="line">  &lt;result column=&quot;user_name&quot; property=&quot;userName&quot; jdbcType=&quot;VARCHAR&quot; /&gt;</div><div class="line">  &lt;result column=&quot;user_password&quot; property=&quot;userPassword&quot; jdbcType=&quot;VARCHAR&quot; /&gt;</div><div class="line">&lt;/resultMap&gt;</div><div class="line"></div><div class="line">&lt;sql id=&quot;Base_Column_List&quot; &gt;</div><div class="line">  user_name, user_password</div><div class="line">&lt;/sql&gt;</div><div class="line"></div><div class="line">&lt;select id=&quot;selectBy&quot; resultMap=&quot;BaseResultMap&quot;&gt;</div><div class="line">  select &lt;include refid=&quot;Base_Column_List&quot; /&gt;</div><div class="line">  from users</div><div class="line">  where user_name = #&#123;userName&#125; AND user_password = #&#123;userPassword&#125;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
<ul>
<li><strong><code>resultType</code> 需要通过 AS 来将表的列名映射为类的字段</strong>:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;sql id=&quot;Base_Column_List&quot; &gt;</div><div class="line">  user_name AS userName, user_password AS userPassword</div><div class="line">&lt;/sql&gt;</div><div class="line"></div><div class="line">&lt;select id=&quot;selectBy&quot; resultType=&quot;com.zk.User&quot;&gt;</div><div class="line">  select &lt;include refid=&quot;Base_Column_List&quot; /&gt;</div><div class="line">  from users</div><div class="line">  where userName = #&#123;userName&#125; AND userPassword = #&#123;userPassword&#125;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
<p>如果<strong>不加 <code>AS</code> 的话，那么就会直接将表的列名映射为类的字段</strong>。</p>
<h3 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h3><p>在数据库中使用批量更新有助于提高性能:</p>
<p><strong>1) 配置批量更新</strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">settings</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultExecutorType"</span> <span class="attr">value</span>=<span class="string">"BATCH"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>2) <code>Java</code> 代码开启</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sqlSessionFactory.openSession(ExecutorType.BATCH);</div></pre></td></tr></table></figure>
<h3 id="MyBatis-Generator"><a href="#MyBatis-Generator" class="headerlink" title="MyBatis Generator"></a>MyBatis Generator</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn mybatis-generator:generate</div></pre></td></tr></table></figure>
<p><a href="http://www.mybatis.org/generator/running/runningWithMaven.html" target="_blank" rel="external">一篇教程足以</a></p>
<h4 id="1-如何防止覆盖已经生成的文件"><a href="#1-如何防止覆盖已经生成的文件" class="headerlink" title="(1) 如何防止覆盖已经生成的文件:"></a>(1) 如何防止覆盖已经生成的文件:</h4><p>注意这个是要<strong>放到 <code>pom.xml</code> 文件</strong>中的，不是 <code>generatorConfig.xml</code> 文件中:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">mybatis.generator.overwrite</span>&gt;</span>false<span class="tag">&lt;/<span class="name">mybatis.generator.overwrite</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="2-在源码编译之前生成-Java-接口和-XML-文件"><a href="#2-在源码编译之前生成-Java-接口和-XML-文件" class="headerlink" title="(2) 在源码编译之前生成 Java 接口和 XML 文件:"></a>(2) 在源码编译之前生成 <code>Java</code> 接口和 <code>XML</code> 文件:</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>Generate MyBatis Artifacts<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>generate<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="3-添加mysql-connector-依赖"><a href="#3-添加mysql-connector-依赖" class="headerlink" title="(3) 添加mysql-connector 依赖:"></a>(3) 添加<code>mysql-connector</code> 依赖:</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>Generate MyBatis Artifacts<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>generate<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.43<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="4-指定配置文件参数"><a href="#4-指定配置文件参数" class="headerlink" title="(4) 指定配置文件参数:"></a>(4) 指定配置文件参数:</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">  # 这个就是默认路径</div><div class="line">  <span class="tag">&lt;<span class="name">mybatis.generator.configurationFile</span>&gt;</span>$&#123;basedir&#125;/src/main/resources/generatorConfig.xml<span class="tag">&lt;/<span class="name">mybatis.generator.configurationFile</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>只需要在 <code>properties</code> 里加上这句话</strong>就可以了，插件运行的时候，能够自动找到这句话，进行相应的配置。</p>
<h4 id="5-配置文件参数详解"><a href="#5-配置文件参数详解" class="headerlink" title="(5) 配置文件参数详解:"></a>(5) 配置文件参数详解:</h4><p><a href="http://www.mybatis.org/generator/configreference/xmlconfig.html" target="_blank" rel="external">MyBatis GeneratorXML Configuration File Reference</a></p>
<hr>
<p><strong>5.1 怎样连接数据库</strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"database.properties"</span>&gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"Mysql"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3Simple"</span> <span class="attr">defaultModelType</span>=<span class="string">"flat"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">"$&#123;driver&#125;"</span></span></div><div class="line"><span class="tag">      <span class="attr">connectionURL</span>=<span class="string">"$&#123;url&#125;"</span></span></div><div class="line"><span class="tag">      <span class="attr">userId</span>=<span class="string">"$&#123;username&#125;"</span></span></div><div class="line"><span class="tag">      <span class="attr">password</span>=<span class="string">"$&#123;password&#125;"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">context</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></div></pre></td></tr></table></figure>
<p>下面是 <strong><code>database.properties</code></strong> 的一个示例 (对应的是 <code>mysql-connector-5.x</code> 版本):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">driver=com.mysql.jdbc.Driver</div><div class="line">url=jdbc:mysql://localhost:3306/test_db</div><div class="line">username=root</div><div class="line">password=root</div></pre></td></tr></table></figure>
<ul>
<li><strong>id</strong>: 这个 <code>Context</code> 的唯一的标识符</li>
</ul>
<p>关于 <code>Context</code> 的<a href="http://www.mybatis.org/generator/configreference/context.html" target="_blank" rel="external">进一步解释</a></p>
<hr>
<p><strong>5.2 javaTypeResolver</strong></p>
<p><strong><code>javaTypeResolver</code></strong> 用来计算从<strong>数据库列如何转变为 <code>Java</code> 类型</strong>，<code>forceBigDecimals</code> 的默认值就是 <code>false</code>，即<strong>默认情况下数据库的 <code>DECIMAL</code> 和 <code>NUMERIC</code> 这两种数据库类型会转变为 <code>Java</code> 的 <code>Long</code>, <code>Integer</code>, <code>Short</code>, 等相应类型</strong>。如果这不是你想要的效果，那么请改为 <code>true</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"Mysql"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3Simple"</span> <span class="attr">defaultModelType</span>=<span class="string">"flat"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">javaTypeResolver</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"forceBigDecimals"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">javaTypeResolver</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">context</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></div></pre></td></tr></table></figure>
<hr>
<p><strong>5.3 javaModelGenerator</strong>:</p>
<p>用来<strong>定义 <code>Java</code> 模型生成器的属性，即生成一些 <code>JavaBean</code> 类</strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"com.buptnsrc.appcrawl.entity"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"trimStrings"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">javaModelGenerator</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li><code>targetPackage</code>: 生成的<strong> <code>JavaBean</code> 类放在哪个包下面，<code>MyBatis</code> 会自动创建包</strong></li>
<li><code>targetProject</code>: 指定<strong>从项目根路径到包顶级的路径，<code>MyBatis</code> 不会自动创建文件夹</strong></li>
<li><code>enableSubPackages</code>: 如果 <code>true</code>，<code>MBG</code> 会根据 <code>catalog</code> 和 <code>schema</code> 来生成子包。如果 <code>false</code> 就会直接用 <code>targetPackage</code> 属性。默认为 <code>false</code></li>
<li><code>trimStrings</code>: 是否对数据库查询结果进行 <code>trim</code> 操作，如果设置为 <code>true</code> 就会生成类似这样:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.username = username == <span class="keyword">null</span> ? <span class="keyword">null</span> : username.trim();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>的 <code>setter</code> 方法。默认值为 <code>false</code></p>
<hr>
<p><strong>5.4 sqlMapGenerator</strong></p>
<p>生成 <code>Mapper.xml</code> 文件:</p>
<p><img src="2017_08_30_22_58_05.png" alt=""></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"com.zk.mapper"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/resources"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">sqlMapGenerator</span>&gt;</span></div></pre></td></tr></table></figure>
<hr>
<p><strong>5.5 javaClientGenerator</strong></p>
<p>生成 <code>Mapper.java</code> 文件:</p>
<p><img src="2017_08_30_22_59_56.png" alt=""></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"com.zk.mapper"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span></span></div><div class="line"><span class="tag">                     <span class="attr">type</span>=<span class="string">"XMLMAPPER"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">javaClientGenerator</span>&gt;</span></div></pre></td></tr></table></figure>
<hr>
<p><strong>5.6 table</strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"model_monitor"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useActualColumnNames"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li><code>useActualColumnNames</code>: If <strong>true</strong>, then MBG will use <strong>列名</strong> as returned from the database metadata as the properties of the generated domain objects. If <code>false</code> (<strong>默认 <code>false</code></strong>), MBG will attempt to <strong>驼峰</strong> the returned names. In either event, the name can be specified <strong>明确地</strong> by the <code>&lt;columnOverride&gt;</code> element in which case this property will be ignored for the specified column. For example, suppose a table contains a <strong>列 <code>START_DATE</code></strong> . If the value of this property is “true”, then MBG will generate the property name as <code>START_DATE</code> - meaning that the getters and setters for the value will be <code>getSTART_DATE()</code> and <code>setSTART_DATE()</code>. If the value of this property is <strong>false</strong>, then MBG will generate the <strong>属性名</strong> as <strong><code>startDate</code></strong> - meaning that the getters and setters for the value will be <code>getStartDate()</code> and <code>setStartDate()</code>.</li>
</ul>
<h4 id="6-元素定义顺序问题"><a href="#6-元素定义顺序问题" class="headerlink" title="(6) 元素定义顺序问题"></a>(6) 元素定义顺序问题</h4><p><code>generatorConfig.xml</code> 中 <code>&lt;context&gt;</code> 下面的子元素的顺序可不是任意的，这点很让人疑惑，它必须遵从一定的顺序，而不是像常见的那样任意顺序均可:</p>
<p><img src="2017_08_30_22_46_36.png" alt=""></p>
<p>如果顺序有误，会提示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[ERROR] Failed to execute goal org.mybatis.generator:mybatis-generator</div><div class="line">-maven-plugin:1.3.5:generate (default-cli) on project mybatis: XML Parser</div><div class="line">Error on line 35: The content of element type &quot;context&quot; must match </div><div class="line">&quot;(property*,plugin*,commentGenerator?,(connectionFactory|jdbcConnection),</div><div class="line">javaTypeResolver?,javaModelGenerator,sqlMapGenerator?,javaClientGenerator?,</div><div class="line">table+)&quot;. -&gt; [Help 1]</div></pre></td></tr></table></figure>
<ul>
<li>参考: <a href="https://stackoverflow.com/questions/37019672/mybatis-generators-bug-configuration-items-should-be-ordered" target="_blank" rel="external">Mybatis Generator’s bug: configuration items should be ordered?</a></li>
</ul>
<p>网友的回答中最后也指出: Maybe you want to know how to make the element out of order, question <a href="https://stackoverflow.com/questions/5643738/how-to-define-dtd-without-strict-element-order" target="_blank" rel="external">How to define DTD without strict element order</a> could be useful.</p>
<h4 id="7-Cannot-obtain-primary-key-information-from-the-database-generated-objects-may-be-incomplete"><a href="#7-Cannot-obtain-primary-key-information-from-the-database-generated-objects-may-be-incomplete" class="headerlink" title="(7) Cannot obtain primary key information from the database, generated objects may be incomplete"></a>(7) Cannot obtain primary key information from the database, generated objects may be incomplete</h4><p>使用 <code>mysql-connector-6.0.6</code> 和 <code>mybatis-generator-core-1.3.5</code> 这两个相结合，在编译完成之后所生成的 <code>Mapper</code> 中，只有两个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StudentMapper</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insert</span><span class="params">(Student record)</span></span>;</div><div class="line">    <span class="function">List&lt;Student&gt; <span class="title">selectAll</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为什么只有两个方法，为什么缺失了其它一些常见的方法，用过 <code>MyBatis Generator</code> 的同学，肯定知道它不止自动生成这两个方法。再查看 <code>mvn compile</code> 的 <code>Console</code> 信息来看，发现有一条 <code>Warning</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[WARNING] Cannot obtain primary key information from the database, generated objects may be incomplete</div></pre></td></tr></table></figure>
<p>带着这句话来 <code>Google</code> 搜索，相关网站聊聊无几，但是却找到了这句话的源文件:</p>
<p><img src="2017_08_31_16_30_39.png" alt=""></p>
<p>于是将 <a href="https://github.com/mybatis/generator" target="_blank" rel="external"><code>mybatis-generator</code></a> 整个项目 <code>clone</code> 到本地，想调试一下看究竟哪里出现了问题。</p>
<p>如下图所示，原来在调用 <code>databaseMetaData.getPrimaryKeys</code> 的时候，<a href="https://github.com/mybatis/generator/blob/mybatis-generator-1.3.5/core/mybatis-generator-core/src/main/java/org/mybatis/generator/internal/db/DatabaseIntrospector.java#L113,L122" target="_blank" rel="external">源代码</a>只是简单的给出了警告信息 <code>warnings.add(getString(&quot;Warning.15&quot;))</code> ，但是异常信息我们却没有任何方式知道，因此修改源代码添加了 <strong><code>warnings.add(e.toString())</code></strong> 这句代码以便打印出异常信息:</p>
<p><img src="2017_08_31_16_35_39.png" alt=""></p>
<p>接着使用 <strong><code>mvn package</code></strong> 重新打包生成 <code>mybatis-generator-core-1.3.6-SNAPSHOT.jar</code>。因为生成 <code>Mapper</code> 的过程需要用到 <code>mysql-connector.jar</code> ，因此也需要拷贝 <code>mysql-connector-java-6.0.6.jar</code> 过来，才能在命令行运行程序:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -cp mybatis-generator-core-<span class="number">1.3</span>.6-SNAPSHOT.jar:mysql-connector-java-<span class="number">6.0</span>.6.jar org.mybatis.generator.api.ShellRunner -configfile generatorConfig.xml -overwrite</div></pre></td></tr></table></figure>
<p>随后我们在刚才的 <code>Warning</code> 下面看到了这个异常信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.sql.SQLSyntaxErrorException: Unknown table &apos;student&apos; in information_schema</div></pre></td></tr></table></figure>
<p>结合源代码，我们知道原来是在调用方法 <code>databaseMetaData.getPrimaryKeys</code> 这句话的时候引发了 <code>SQL</code> 语句错误，导致出现异常并给出了如下警告信息。但为什么会出现语句错误问题呢？</p>
<p><code>java.sql.DatabaseMetaData</code> 只是一个接口，这句话的实现类是由各个数据库厂商实现的，那么此时我们应该在 <code>mysql-connector</code> 中寻找究竟是哪个类实现了这个接口，使用如下命令重新尝试运行程序:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -verbose:class -cp mybatis-generator-core-1.3.6-SNAPSHOT.jar:mysql-connector-java-6.0.6.jar org.mybatis.generator.api.ShellRunner -configfile generatorConfig.xml -overwrite | grep MetaData</div></pre></td></tr></table></figure>
<p>上述命令帮助我们找到了真正的 <code>DatabaseMetaData</code> 的实现类 <code>com.mysql.cj.jdbc.DatabaseMetaData</code>:</p>
<p><img src="2017_08_31_16_55_24.png" alt=""></p>
<p>接下来我们需要调试 <code>mysql-connector</code> 的实现了，具体需要:</p>
<ul>
<li>克隆 <a href="https://github.com/mysql/mysql-connector-j/tree/6.0.6" target="_blank" rel="external">mysql-connector 6.6 版本</a> 的源代码到本地</li>
<li>克隆到本地后，<a href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-installing-source.html" target="_blank" rel="external">参考官网指示</a>，在代码根目录创建一个文件 <code>build.properties</code>,告诉 <code>mysql</code> 的 <code>JVM</code> 的路径所在:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">com.mysql.cj.build.jdk=/usr/lib/jvm/oracle_jdk8/jdk1.8.0_144</div></pre></td></tr></table></figure>
<ul>
<li>修改 <code>build.xml</code> 文件中的 <code>javassist</code> 库的版本信息，提升一下版本 (需要下载 <a href="https://mvnrepository.com/artifact/org.javassist/javassist/3.18.2-GA" target="_blank" rel="external"><code>javassist.jar</code></a> 并将其放到 <code>lib</code> 文件夹下面):</li>
</ul>
<p><img src="2017_08_31_17_03_11.png" alt=""></p>
<p>如果不修改直接使用版本 <code>3.15.0</code> 编译的话，会报如下错误:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[java] Exception in thread <span class="string">"main"</span> java.lang.RuntimeException: java.io.IOException: invalid constant type: <span class="number">18</span></div><div class="line">[java] 	at javassist.CtClassType.getClassFile2(CtClassType.java:<span class="number">204</span>)</div><div class="line">[java] 	at javassist.CtClassType.makeFieldCache(CtClassType.java:<span class="number">835</span>)</div><div class="line">[java] 	at javassist.CtClassType.getMembers(CtClassType.java:<span class="number">826</span>)</div><div class="line">[java] 	at javassist.CtClassType.getDeclaredMethod(CtClassType.java:<span class="number">1205</span>)</div><div class="line">[java] 	at instrumentation.CommonChecks.main(CommonChecks.java:<span class="number">68</span>)</div><div class="line">[java] Caused by: java.io.IOException: invalid constant type: <span class="number">18</span></div><div class="line">[java] 	at javassist.bytecode.ConstPool.readOne(ConstPool.java:<span class="number">1113</span>)</div><div class="line">[java] 	at javassist.bytecode.ConstPool.read(ConstPool.java:<span class="number">1056</span>)</div><div class="line">[java] 	at javassist.bytecode.ConstPool.&lt;init&gt;(ConstPool.java:<span class="number">150</span>)</div><div class="line">[java] 	at javassist.bytecode.ClassFile.read(ClassFile.java:<span class="number">765</span>)</div><div class="line">[java] 	at javassist.bytecode.ClassFile.&lt;init&gt;(ClassFile.java:<span class="number">109</span>)</div><div class="line">[java] 	at javassist.CtClassType.getClassFile2(CtClassType.java:<span class="number">191</span>)</div><div class="line">[java] 	... <span class="number">4</span> more</div></pre></td></tr></table></figure>
<p>参考网友的<a href="https://stackoverflow.com/questions/30313255/reflections-java-8-invalid-constant-type" target="_blank" rel="external">回答</a>，这说明这个库中的 <code>Java Parser</code> 还识别不了 <code>Java 8</code> 中的 <code>constant type</code>，所以推荐换用版本更高的 <code>javassist</code>。</p>
<ul>
<li>修改源代码中的 <a href="https://github.com/mysql/mysql-connector-j/blob/6.0.6/src/main/java/com/mysql/cj/jdbc/DatabaseMetaData.java#L3177,L3182" target="_blank" rel="external"><code>DatabaseMetaData.java</code></a> 文件，找到方法 <code>getPrimaryKeys</code> 的实现，添加一行打印信息:</li>
</ul>
<p><img src="2017_08_31_17_17_06.png" alt=""></p>
<ul>
<li>使用 <strong><code>ant dist</code></strong> 进行编译</li>
</ul>
<p>重新运行命令，尝试生成 <code>Mapper</code>，于是我们会得到如下所示的一条 <code>SQL</code> 语句:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">KEYS</span> <span class="keyword">FROM</span> <span class="string">`student`</span> <span class="keyword">FROM</span> <span class="string">`information_schema`</span></div></pre></td></tr></table></figure>
<p>就是在执行这条 <code>SQL</code> 语句的时候，发生了语法错误。通过从 <code>mysql-connector-6.0.6</code> 降到 <code>5.x</code> 版本能够解决这个问题，相应地打印出的 <code>SQL</code> 语句就变成了:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SHOW</span> <span class="keyword">KEYS</span> <span class="keyword">FROM</span> <span class="string">`student`</span> <span class="keyword">FROM</span> <span class="string">`test_db`</span></div></pre></td></tr></table></figure>
<h4 id="8-系统缓存问题"><a href="#8-系统缓存问题" class="headerlink" title="(8) 系统缓存问题"></a>(8) 系统缓存问题</h4><p>没有配置的<strong>默认情况下，<code>MyBatis</code> 只开启一级缓存</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">SqlSession session = sqlSessionFactory.openSession();</div><div class="line">StudentMapper studentMapper = session.getMapper(StudentMapper.class);</div><div class="line">studentMapper.getStudent(<span class="number">1</span>);</div><div class="line">studentMapper.getStudent(<span class="number">1</span>);</div></pre></td></tr></table></figure>
<p>我们在同一个 <code>session</code> 上调用了两次查询，而<strong>第二次查询是从缓存中查出</strong>的。</p>
<h4 id="9-原理简介"><a href="#9-原理简介" class="headerlink" title="(9) 原理简介"></a>(9) 原理简介</h4><p><code>StudentMapper</code> 接口运行时究竟是什么类型:</p>
<p><img src="2017_08_31_21_56_55.png" alt=""></p>
<p>而且，它就是在运行时采用的 <strong><code>JDK</code> 的动态代理</strong>技术实现的:</p>
<p><img src="2017_08_31_22_03_30.png" alt=""></p>
<h4 id="10-完整版-generatorConfig-xml-和-mybatis-config-xml-示例"><a href="#10-完整版-generatorConfig-xml-和-mybatis-config-xml-示例" class="headerlink" title="(10) 完整版 generatorConfig.xml 和 mybatis-config.xml 示例"></a>(10) 完整版 <code>generatorConfig.xml</code> 和 <code>mybatis-config.xml</code> 示例</h4><p><strong>1) <code>generatorConfig.xml</code> 文件</strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE generatorConfiguration</span></div><div class="line"><span class="meta">PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"</span></div><div class="line"><span class="meta">"http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"database.properties"</span> &gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"Mysql"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3Simple"</span> <span class="attr">defaultModelType</span>=<span class="string">"flat"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">"$&#123;driver&#125;"</span></span></div><div class="line"><span class="tag">                    <span class="attr">connectionURL</span>=<span class="string">"$&#123;url&#125;"</span></span></div><div class="line"><span class="tag">                    <span class="attr">userId</span>=<span class="string">"$&#123;username&#125;"</span></span></div><div class="line"><span class="tag">                    <span class="attr">password</span>=<span class="string">"$&#123;password&#125;"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"com.zk"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"trimStrings"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">javaModelGenerator</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"com.zk.mapper"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/resources"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">sqlMapGenerator</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"com.zk.mapper"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span></span></div><div class="line"><span class="tag">                         <span class="attr">type</span>=<span class="string">"XMLMAPPER"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">javaClientGenerator</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"student"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useActualColumnNames"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"tasks"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useActualColumnNames"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">context</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>2 <code>mybatis-config.xml</code> 文件</strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE configuration</span></div><div class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></div><div class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"database.properties"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">"com.zk.Student"</span> <span class="attr">alias</span>=<span class="string">"student"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"$&#123;driver&#125;"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;url&#125;"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;username&#125;"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;password&#125;"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/zk/mapper/StudentMapper.xml"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="一个类包含其他类、List-对象"><a href="#一个类包含其他类、List-对象" class="headerlink" title="一个类包含其他类、List 对象"></a>一个类包含其他类、<code>List</code> 对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blog</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">    <span class="keyword">private</span> String title;</div><div class="line">    <span class="keyword">private</span> Author author; <span class="comment">// Author 对象</span></div><div class="line">    <span class="keyword">private</span> List&lt;Post&gt; posts; <span class="comment">// List 对象</span></div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>mybatis-config.xml</code></strong> 配置文件的结构:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 配置别名信息 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">"com.zk.Blog"</span> <span class="attr">alias</span>=<span class="string">"Blog"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong><code>BlogMapper.xml</code></strong> 配置文件的结构:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mapper</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectBlogDetails"</span> <span class="attr">resultMap</span>=<span class="string">"detailedBlogResultMap"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 连接 Blog, Author, Post 这三个表 --&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">&lt;!-- Blog 映射规则 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"detailedBlogResultMap"</span> <span class="attr">type</span>=<span class="string">"Blog"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 构造函数映射 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">idArg</span> <span class="attr">column</span>=<span class="string">"blog_id"</span> <span class="attr">javaType</span>=<span class="string">"int"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Blog 类的 title 字段，查询语句的 blog_title 列 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"title"</span> <span class="attr">column</span>=<span class="string">"blog_title"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Blog 类的 author 对象字段 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"author"</span> <span class="attr">resultMap</span>=<span class="string">"authorResult"</span> /&gt;</span></div><div class="line">    </div><div class="line">    <span class="comment">&lt;!-- Blog 类的 List&lt;Post&gt; 集合映射 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"posts"</span> <span class="attr">ofType</span>=<span class="string">"Post"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"post_id"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"content"</span> <span class="attr">column</span>=<span class="string">"post_content"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></div><div class="line">    </div><div class="line">  <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">&lt;!-- Author 映射规则 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"authorResult"</span> <span class="attr">type</span>=<span class="string">"Author"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"author_id"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"username"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"password"</span> <span class="attr">column</span>=<span class="string">"password"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"email"</span> <span class="attr">column</span>=<span class="string">"email"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div><div class="line">  </div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;SELECT * FROM $&#123;tableName:users&#125; ORDER BY $&#123;orderColumn:id&#125;&quot;</div></pre></td></tr></table></figure>
<p>解析为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SELECT * FROM members ORDER BY member_id</div></pre></td></tr></table></figure>
<hr>
<p><code>GenericTokenParser</code> 负责扫描文本，当遇到需要解析的指定字符串后，会调用 <code>TokenHandler</code> 接口进行处理:</p>
<p><img src="2017_11_18_16_37_25.png" alt=""><br><img src="2017_11_18_16_39_19.png" alt=""><br><img src="2017_11_18_16_35_49.png" alt=""></p>
<hr>
<p>异常都是没有抛出的，继承的是 <code>RuntimeException</code>:</p>
<p><img src="2017_11_18_16_49_44.png" alt=""></p>
<p><strong>运行时异常</strong> represent problems that are the result of a <strong>编程问题</strong>, and as such, the API client code <strong>没有义务</strong> be expected to <strong>恢复</strong> from them or to handle them in any way. Such problems include arithmetic exceptions, such as dividing by zero; pointer exceptions, such as trying to access an object through a null reference; and indexing exceptions, such as attempting to access an array element through an index that is too large or too small.</p>
<p>Runtime exceptions can occur anywhere in a program, and in a typical one they can be very numerous. Having to add runtime exceptions in every method declaration would reduce a program’s clarity. Thus, the compiler does not require that you catch or specify runtime exceptions (although you can).</p>
<h3 id="lt-include-gt"><a href="#lt-include-gt" class="headerlink" title="&lt;include&gt;"></a><code>&lt;include&gt;</code></h3><p>This element can be used to define a <strong>可重用</strong> fragment of SQL code that can be included in other statements. It can be statically (during load phase) parametrized. Different property values can vary in include instances. For example:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"userColumns"</span>&gt;</span> $&#123;alias&#125;.id,$&#123;alias&#125;.username,$&#123;alias&#125;.password <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUsers"</span> <span class="attr">resultType</span>=<span class="string">"map"</span>&gt;</span></div><div class="line">  select</div><div class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"userColumns"</span>&gt;</span><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"alias"</span> <span class="attr">value</span>=<span class="string">"t1"</span>/&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span>,</div><div class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"userColumns"</span>&gt;</span><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"alias"</span> <span class="attr">value</span>=<span class="string">"t2"</span>/&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></div><div class="line">  from some_table t1</div><div class="line">    cross join some_table t2</div><div class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="反射工具箱"><a href="#反射工具箱" class="headerlink" title="反射工具箱"></a>反射工具箱</h3><p><img src="invoker_reflector.png" alt=""></p>
<p><code>getter</code>、<code>setter</code>、<code>Method</code> 方法用 <code>Invoker</code> 统一封装。</p>
<h3 id="DataSource"><a href="#DataSource" class="headerlink" title="DataSource"></a><code>DataSource</code></h3><h4 id="1-PooledConnection-代理-close-方法，进行假关闭"><a href="#1-PooledConnection-代理-close-方法，进行假关闭" class="headerlink" title="1. PooledConnection 代理 close 方法，进行假关闭"></a>1. <code>PooledConnection</code> 代理 <code>close</code> 方法，进行假关闭</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (method.getName().equals(<span class="string">"close"</span>)) &#123;</div><div class="line">    <span class="comment">// 当调用 close 方法的时候，归还 `Connection`</span></div><div class="line">    dataSource.pushConnection(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">return</span> method.invoke(realConnection, args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-PooledDataSource-的-pushConnection-归还-Connection-方法"><a href="#2-PooledDataSource-的-pushConnection-归还-Connection-方法" class="headerlink" title="2. PooledDataSource 的 pushConnection 归还 Connection 方法"></a>2. <code>PooledDataSource</code> 的 <code>pushConnection</code> 归还 <code>Connection</code> 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">synchronized</span> (state) &#123;</div><div class="line">    <span class="comment">// 从活跃连接中移除这个 Connection</span></div><div class="line">    state.activeConnections.remove(conn);</div><div class="line">    <span class="keyword">if</span> (conn.isValid()) &#123;</div><div class="line">        <span class="comment">// 空闲连接还没有达到最大</span></div><div class="line">        <span class="keyword">if</span> (state.idleConnections.size() &lt; poolMaximumIdleConnections) &#123;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">            <span class="comment">// 复用原来的 realConnection，创建一个新的 PooledConnection</span></div><div class="line">            PooledConnection newConn = <span class="keyword">new</span> PooledConnection(conn.getRealConnection(), <span class="keyword">this</span>);</div><div class="line">            <span class="comment">// 将新创建的 newConn 放到空闲连接池中</span></div><div class="line">            state.idleConnections.add(newConn);</div><div class="line">            <span class="comment">// 唤醒阻塞在 state 上的线程</span></div><div class="line">            state.notifyAll();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">            <span class="comment">// 直接关闭这个连接</span></div><div class="line">            conn.getRealConnection().close();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 坏连接数量++</span></div><div class="line">        state.badConnectionCount++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-PooledDataSource-的-popConnection-获取-Connection-方法"><a href="#3-PooledDataSource-的-popConnection-获取-Connection-方法" class="headerlink" title="3. PooledDataSource 的 popConnection 获取 Connection 方法"></a>3. <code>PooledDataSource</code> 的 <code>popConnection</code> 获取 <code>Connection</code> 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (conn == <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (state) &#123;</div><div class="line">        <span class="keyword">if</span> (!state.idleConnections.isEmpty()) &#123;</div><div class="line">            <span class="comment">// 有空闲连接</span></div><div class="line">            conn = state.idleConnections.remove(<span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 可以创建新的连接</span></div><div class="line">            <span class="keyword">if</span> (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123;</div><div class="line">                conn = <span class="keyword">new</span> PooledConnection(dataSource.getConnection(), <span class="keyword">this</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 最旧的那个连接</span></div><div class="line">                PooledConnection oldestActiveConnection = state.activeConnections.get(<span class="number">0</span>);</div><div class="line">                <span class="keyword">long</span> longestCheckoutTime = oldestActiveConnection.getCheckoutTime();</div><div class="line">                <span class="comment">// 连接已经超时</span></div><div class="line">                <span class="keyword">if</span> (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123;</div><div class="line">                    <span class="comment">// 移除这个连接</span></div><div class="line">                    state.activeConnections.remove(oldestActiveConnection);</div><div class="line">                    <span class="comment">// 创建新的连接</span></div><div class="line">                    conn = <span class="keyword">new</span> PooledConnection(oldestActiveConnection.getRealConnection(), <span class="keyword">this</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// 等待一段时间</span></div><div class="line">                    state.wait(poolTimeToWait);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// ==============</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 连接有效</span></div><div class="line">            <span class="keyword">if</span> (conn.isValid()) &#123;</div><div class="line">                conn.setCheckoutTimestamp(System.currentTimeMillis());</div><div class="line">                conn.setLastUsedTimestamp(System.currentTimeMillis());</div><div class="line">                <span class="comment">// 添加到活跃连接中</span></div><div class="line">                state.activeConnections.add(conn);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-如何统计超时"><a href="#4-如何统计超时" class="headerlink" title="4. 如何统计超时"></a>4. 如何统计超时</h4><p><strong>没有设置什么定时任务</strong>，隔一段时间扫描一次，而是当获取新的 <code>Connection</code> 的时候，才会尝试移除超时的 <code>Connection</code>。</p>
<h4 id="5-统计什么"><a href="#5-统计什么" class="headerlink" title="5. 统计什么"></a>5. 统计什么</h4><ul>
<li>坏连接数量</li>
<li>请求 <code>getConnection</code> 的数量</li>
<li>平均请求 <code>getConnection</code> 时长</li>
<li>平均超时时间</li>
<li>等待次数</li>
<li>平均等待时间</li>
</ul>
<h4 id="6-如何判断连接是否有效"><a href="#6-如何判断连接是否有效" class="headerlink" title="6. 如何判断连接是否有效"></a>6. 如何判断连接是否有效</h4><ul>
<li><code>valid</code> 值 + <code>ping</code> 测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">boolean</span> result = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    result = !conn.getRealConnection().isClosed();</div><div class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">    result = <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (result) &#123;</div><div class="line">    <span class="comment">// 如果超过 poolPingConnectionsNotUsedFor 未使用</span></div><div class="line">    <span class="keyword">if</span> (conn.getTimeElapsedSinceLastUse() &gt; poolPingConnectionsNotUsedFor) &#123;</div><div class="line">        <span class="comment">// 发送测试 SQL 语句</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Connection realConn = conn.getRealConnection();</div><div class="line">            Statement statement = realConn.createStatement();</div><div class="line">            ResultSet rs = statement.executeQuery(poolPingQuery);</div><div class="line">            rs.close();</div><div class="line">            statement.close();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            result = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="7-finalize-方法"><a href="#7-finalize-方法" class="headerlink" title="7. finalize() 方法"></a>7. <code>finalize()</code> 方法</h4><p>当这个类 <code>GC</code> 的时候，就关闭所有连接:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    forceCloseAll();</div><div class="line">    <span class="keyword">super</span>.finalize();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="binding"><a href="#binding" class="headerlink" title="binding"></a>binding</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BlogMapper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 此方法是如何映射到 Mapper.xml 文件里面的 id="selectBlog" 的 SQL 语句的 ?</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Blog <span class="title">selectBlog</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-MapperRegistry"><a href="#1-MapperRegistry" class="headerlink" title="1. MapperRegistry"></a>1. <code>MapperRegistry</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Mapper 接口与对应的 MapperProxyFactory 之间的关系</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers =</div><div class="line">        <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</div><div class="line">        <span class="comment">// 接口类型</span></div><div class="line">        <span class="keyword">if</span> (type.isInterface()) &#123;</div><div class="line">            <span class="comment">// 确保不存在这个类型，否则抛出异常</span></div><div class="line">            <span class="keyword">if</span> (hasMapper(type)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is already known to the MapperRegistry."</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">boolean</span> loadCompleted = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 添加进去</span></div><div class="line">                knownMappers.put(type, <span class="keyword">new</span> MapperProxyFactory&lt;T&gt;(type));</div><div class="line">                loadCompleted = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="keyword">if</span> (!loadCompleted) &#123;</div><div class="line">                    knownMappers.remove(type);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-当我们调用-sqlSession-getMapper-BlogMapper-class-的时候"><a href="#2-当我们调用-sqlSession-getMapper-BlogMapper-class-的时候" class="headerlink" title="2. 当我们调用 sqlSession.getMapper(BlogMapper.class) 的时候"></a>2. 当我们调用 <code>sqlSession.getMapper(BlogMapper.class)</code> 的时候</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</div><div class="line">        <span class="keyword">if</span> (mapperProxyFactory == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is not known to the MapperRegistry."</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 创建一个代理对象</span></div><div class="line">            <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Error getting mapper instance. Cause: "</span> + e, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><code>MapperProxyFactory</code> 负责<strong>创建代理对象</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxyFactory</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache = <span class="keyword">new</span> ConcurrentHashMap&lt;Method, MapperMethod&gt;();</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 创建一个 MapperProxy InvokeHandler</span></div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache);</div><div class="line">        <span class="keyword">return</span> newInstance(mapperProxy);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><code>MapperProxy</code> 的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Object 对象上的方法</span></div><div class="line">            <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</div><div class="line">                <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDefaultMethod(method)) &#123;</div><div class="line">                <span class="comment">// java 7 以上版本对动态语言的支持, default 关键字</span></div><div class="line">                <span class="keyword">return</span> invokeDefaultMethod(proxy, method, args);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 从缓存中取出或者创建新的 Method 对象</span></div><div class="line">        <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method);</div><div class="line">        <span class="comment">// 执行</span></div><div class="line">        <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Backport of java.lang.reflect.Method#isDefault()</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDefaultMethod</span><span class="params">(Method method)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (method.getModifiers()</div><div class="line">                &amp; (Modifier.ABSTRACT | Modifier.PUBLIC | Modifier.STATIC)) == Modifier.PUBLIC</div><div class="line">            &amp;&amp; method.getDeclaringClass().isInterface();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><code>MapperMethod</code> 是连接 <code>Mapper</code> 和 映射配置文件中定义的 SQL 语句的<strong>桥梁</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperMethod</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlCommand command;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodSignature method;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</div><div class="line">        Object result;</div><div class="line">        <span class="keyword">switch</span> (command.getType()) &#123;</div><div class="line">        <span class="keyword">case</span> INSERT: &#123;</div><div class="line">            Object param = method.convertArgsToSqlCommandParam(args);</div><div class="line">            result = rowCountResult(sqlSession.insert(command.getName(), param));</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">case</span> UPDATE: &#123;</div><div class="line">            Object param = method.convertArgsToSqlCommandParam(args);</div><div class="line">            result = rowCountResult(sqlSession.update(command.getName(), param));</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 缓存总开关 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>启用二级缓存</strong>:</p>
<p><img src="2018_01_04_18_13_04.png" alt="二级缓存"></p>
<p><code>&lt;select&gt;</code> 节点中的 <code>useCache</code> 属性，将其设置为 <code>true</code> 将会使结果<strong>缓存到二级缓存</strong>中:</p>
<p><img src="2018_01_04_18_11_16.png" alt="useCache"></p>
<p><strong>查询二级缓存的算法流程</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CachingExecutor.java</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 获取查询语句所在命名空间对应的二级缓存</span></div><div class="line">    Cache cache = ms.getCache();</div><div class="line"></div><div class="line">    <span class="comment">// 是否开启了二级缓存</span></div><div class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// 根据 &lt;select&gt; 配置是否需要清空二级缓存</span></div><div class="line">        flushCacheIfRequired(ms);</div><div class="line"></div><div class="line">        <span class="comment">// useCache 是否为 true</span></div><div class="line">        <span class="keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="keyword">null</span>) &#123;</div><div class="line">            ensureNoOutParams(ms, boundSql);</div><div class="line"></div><div class="line">            <span class="comment">// 查询二级缓存</span></div><div class="line">            List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</div><div class="line">            <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">                <span class="comment">// 调用封装的 Executor ，其会先查询一级缓存</span></div><div class="line">                list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</div><div class="line"></div><div class="line">                <span class="comment">// 将查询结果保存到 TransactionalCache.entiresToAddOnCommit 集合中</span></div><div class="line">                tcm.putObject(cache, key, list); <span class="comment">// issue #578 and #116</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> list;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 调用封装的 Executor ，其会先查询一级缓存</span></div><div class="line">    <span class="keyword">return</span> delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>commit</code> 的时候，才会将 <code>TransactionalCache.entriesToAddOnCommit</code> 集合中缓存的数据写入到二级缓存，其目的是为了避免出现<strong>脏读</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * CachingExecutor.java</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="keyword">boolean</span> required)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    delegate.commit(required);</div><div class="line">    <span class="comment">// 这个时候才会写入</span></div><div class="line">    tcm.commit();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="dirty_read_transaction.jpeg" alt="dirty_read_transaction"></p>
<p><code>MyBatis</code> 缓存总览:</p>
<p><img src="mybatis_caching.jpg" alt="mybatis_caching"></p>
<p>一级缓存的生命周期与 <code>SqlSession</code> 相同，二级缓存的生命周期与应用程序的生命周期相同。</p>
<p><strong>查询一级缓存的算法流程</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * BaseExecutor.java</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    BoundSql boundSql = ms.getBoundSql(parameter);</div><div class="line">    </div><div class="line">    <span class="comment">// 创建 CacheKey</span></div><div class="line">    CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql);</div><div class="line"></div><div class="line">    <span class="comment">// 执行下面版本的查询</span></div><div class="line">    <span class="keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="comment">// 开启 flushCache 清空缓存</span></div><div class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;</div><div class="line">        clearLocalCache();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    List&lt;E&gt; list;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        queryStack++;</div><div class="line"></div><div class="line">        <span class="comment">// 查询一级缓存</span></div><div class="line">        list = resultHandler == <span class="keyword">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</div><div class="line">            handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        queryStack--;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> list;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Mapper-方法重载问题"><a href="#Mapper-方法重载问题" class="headerlink" title="Mapper 方法重载问题"></a><code>Mapper</code> 方法重载问题</h3><p><strong>第一种情况</strong>:</p>
<p>在 <code>Mapper.xml</code> 中<strong>定义且只定义一个</strong> <code>&lt;select&gt;</code> 节点:</p>
<p><img src="2018_01_06_11_21_24.png" alt="select"></p>
<p>在 <code>Mapper.java</code> 这边<strong>定义多个方法</strong>:</p>
<p><img src="2018_01_06_11_24_54.png" alt="select_in_mapper"></p>
<p>这种是不会报错的，这样也是 OK 的!</p>
<p><strong>第二种情况</strong>:</p>
<p>在 <code>Mapper.xml</code> 中定义多个 <code>id</code> 相同的 <code>&lt;select&gt;</code> 节点，想通过不同的 <code>parameterType</code> 来表征这两个 <code>select</code> 节点的不同:</p>
<p><img src="2018_01_06_11_28_51.png" alt="multiple_select_id_in_mapper_xml"></p>
<p>在 <code>Mapper.java</code> 这边对应的定义两个方法:</p>
<p><img src="2018_01_06_11_31_30.png" alt="multiple_methods_in_mapper_java"></p>
<p>这种是<strong>一定会报错</strong>的 (以下是<strong>部分异常</strong>):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Caused by: java.lang.IllegalArgumentException: Mapped Statements collection already contains value for com.buptnsrc.appcrawl.mapper.AsecAppMetaMapper.selectRecentlyRecords</div><div class="line">	at org.apache.ibatis.session.Configuration$StrictMap.put(Configuration.java:859)</div><div class="line">	at org.apache.ibatis.session.Configuration$StrictMap.put(Configuration.java:831)</div><div class="line">	at org.apache.ibatis.session.Configuration.addMappedStatement(Configuration.java:655)</div><div class="line">	at org.apache.ibatis.builder.MapperBuilderAssistant.addMappedStatement(MapperBuilderAssistant.java:302)</div><div class="line">	at org.apache.ibatis.builder.xml.XMLStatementBuilder.parseStatementNode(XMLStatementBuilder.java:109)</div><div class="line">	at org.apache.ibatis.builder.xml.XMLMapperBuilder.buildStatementFromContext(XMLMapperBuilder.java:135)</div><div class="line">	at org.apache.ibatis.builder.xml.XMLMapperBuilder.buildStatementFromContext(XMLMapperBuilder.java:128)</div><div class="line">	at org.apache.ibatis.builder.xml.XMLMapperBuilder.configurationElement(XMLMapperBuilder.java:118)</div><div class="line">	... 14 more</div></pre></td></tr></table></figure>
<p>以下是关键的几段代码，我们可以看出 <code>MyBatis</code> <strong>通过使用 <code>namespace.id</code> 来唯一定位一个 <code>MappedStatement</code></strong>，而不是通过 <code>namespace.id.parameterType</code> 来定位一个 <code>MappedStatement</code>，因此会抛出异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * XMLStatementBuilder.java</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseStatementNode</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// id 就是 selectRecentlyRecords</span></div><div class="line">    String id = context.getStringAttribute(<span class="string">"id"</span>);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    builderAssistant.addMappedStatement(id <span class="comment">/**, 省略若干参数 **/</span> );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * MapperBuilderAssistant.java</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> MappedStatement <span class="title">addMappedStatement</span><span class="params">(String id <span class="comment">/**, 省略若干参数 **/</span> )</span> </span>&#123;</div><div class="line">    id = applyCurrentNamespace(id, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    MappedStatement.Builder statementBuilder = <span class="keyword">new</span> MappedStatement.Builder(configuration, id, <span class="comment">/**, 省略若干参数 **/</span>);</div><div class="line"></div><div class="line">    MappedStatement statement = statementBuilder.build();</div><div class="line">    configuration.addMappedStatement(statement);</div><div class="line">    <span class="keyword">return</span> statement;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * MapperBuilderAssistant.java</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">applyCurrentNamespace</span><span class="params">(String base, <span class="keyword">boolean</span> isReference)</span> </span>&#123;</div><div class="line">    <span class="comment">// currentNamespace: com.buptnsrc.appcrawl.mapper.AsecAppMetaMapper</span></div><div class="line">    <span class="comment">// base: selectRecentlyRecords</span></div><div class="line">    <span class="keyword">return</span> currentNamespace + <span class="string">"."</span> + base;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Configuration.java</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, MappedStatement&gt; mappedStatements</div><div class="line">    = <span class="keyword">new</span> StrictMap&lt;MappedStatement&gt;(<span class="string">"Mapped Statements collection"</span>);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Configuration.java</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMappedStatement</span><span class="params">(MappedStatement ms)</span> </span>&#123;</div><div class="line">    <span class="comment">// id: 不能重复</span></div><div class="line">    mappedStatements.put(ms.getId(), ms);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Configuration.StrictMap</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StrictMap</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMap</span>&lt;<span class="title">String</span>, <span class="title">V</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(String key, V value)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (containsKey(key)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(name + <span class="string">" already contains value for "</span> + key);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>第三种情况</strong>:</p>
<p>在 <code>Mapper.xml</code> 中<strong>不定义</strong> <code>&lt;select&gt;</code> 节点，转而在 <code>Mapper.java</code> 中的方法中通过 <code>Select</code> 注解来声明 SQL 语句:</p>
<p><img src="2018_01_06_13_13_50.png" alt="mapper_select_annotation"></p>
<p>这种也是<strong>不行</strong>的，报如下<strong>异常</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Caused by: java.lang.IllegalArgumentException: Mapped Statements collection already contains value <span class="keyword">for</span> com.buptnsrc.appcrawl.mapper.AsecAppMetaMapper.selectRecentlyRecords</div><div class="line">	at org.apache.ibatis.session.Configuration$StrictMap.put(Configuration.java:<span class="number">859</span>)</div><div class="line">	at org.apache.ibatis.session.Configuration$StrictMap.put(Configuration.java:<span class="number">831</span>)</div><div class="line">	at org.apache.ibatis.session.Configuration.addMappedStatement(Configuration.java:<span class="number">655</span>)</div><div class="line">	at org.apache.ibatis.builder.MapperBuilderAssistant.addMappedStatement(MapperBuilderAssistant.java:<span class="number">302</span>)</div><div class="line">	at org.apache.ibatis.builder.annotation.MapperAnnotationBuilder.parseStatement(MapperAnnotationBuilder.java:<span class="number">351</span>)</div><div class="line">	at org.apache.ibatis.builder.annotation.MapperAnnotationBuilder.parse(MapperAnnotationBuilder.java:<span class="number">134</span>)</div><div class="line">	at org.apache.ibatis.binding.MapperRegistry.addMapper(MapperRegistry.java:<span class="number">72</span>)</div><div class="line">	at org.apache.ibatis.binding.MapperRegistry.addMappers(MapperRegistry.java:<span class="number">97</span>)</div><div class="line">	at org.apache.ibatis.binding.MapperRegistry.addMappers(MapperRegistry.java:<span class="number">105</span>)</div><div class="line">	at org.apache.ibatis.session.Configuration.addMappers(Configuration.java:<span class="number">724</span>)</div><div class="line">	at org.apache.ibatis.builder.xml.XMLConfigBuilder.mapperElement(XMLConfigBuilder.java:<span class="number">360</span>)</div><div class="line">	at org.apache.ibatis.builder.xml.XMLConfigBuilder.parseConfiguration(XMLConfigBuilder.java:<span class="number">118</span>)</div></pre></td></tr></table></figure>
<p>其原因看如下实现代码即可知:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * MapperAnnotationBuilder.java</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">parseStatement</span><span class="params">(Method method)</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    SqlSource sqlSource = getSqlSourceFromAnnotations(method, parameterTypeClass, languageDriver);</div><div class="line">    <span class="keyword">if</span> (sqlSource != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 类的全限定名 + '.' + 方法名 来唯一确定一个 MappedStatement</span></div><div class="line">        <span class="keyword">final</span> String mappedStatementId = type.getName() + <span class="string">"."</span> + method.getName();</div><div class="line">        <span class="comment">// 添加到 Map 中</span></div><div class="line">        assistant.addMappedStatement(mappedStatementId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其使用 <code>MapperAnnotationBuilder</code> 进行注解解析的时候，确定 ID 的时候用的是:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">type.getName() + <span class="string">"."</span> + method.getName()</div></pre></td></tr></table></figure>
<h3 id="LIKE-语句写法"><a href="#LIKE-语句写法" class="headerlink" title="LIKE 语句写法"></a><code>LIKE</code> 语句写法</h3><p>The <code>bind</code> element lets you create a <strong>variable (变量)</strong> out of an OGNL expression and bind it to the context.</p>
<p><img src="2018_01_10_23_16_20.png" alt="LIKE_example"></p>
<p><strong>字符串连接</strong>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"xxx"</span> <span class="attr">...</span>&gt;</span></div><div class="line">  select id,name,... from country</div><div class="line">  <span class="tag">&lt;<span class="name">where</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name != null and name != ''"</span>&gt;</span></div><div class="line">      name like concat('%', #&#123;name&#125;, '%')</div><div class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">where</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/23/mybatis/" data-id="cjcdlsfyi005cdiem6civafqi" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-file" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/07/22/file/" class="article-date">
  <time datetime="2017-07-22T13:45:30.000Z" itemprop="datePublished">2017-07-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/开发者手册/">开发者手册</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/07/22/file/">File</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="File"><a href="#File" class="headerlink" title="File"></a>File</h2><h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="InputStream-转为字符串"><a href="#InputStream-转为字符串" class="headerlink" title="InputStream 转为字符串"></a><code>InputStream</code> 转为字符串</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">File file = <span class="keyword">new</span> File(<span class="string">"a.txt"</span>);</div><div class="line">IOUtils.toString(file.getInputStream(), Charset.forName(<span class="string">"UTF-8"</span>));</div></pre></td></tr></table></figure>
<h3 id="InputStream-转为文件"><a href="#InputStream-转为文件" class="headerlink" title="InputStream 转为文件"></a><code>InputStream</code> 转为文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">File file = <span class="keyword">new</span> File(<span class="string">"a.txt"</span>);</div><div class="line">FileUtils.copyInputStreamToFile(response.getInputStream(), file);</div></pre></td></tr></table></figure>
<h3 id="Bytes-转为文件"><a href="#Bytes-转为文件" class="headerlink" title="Bytes 转为文件"></a><code>Bytes</code> 转为文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">File file = <span class="keyword">new</span> File(<span class="string">"targetFile"</span>);</div><div class="line">FileUtils.writeByteArrayToFile(file, <span class="string">"ABC"</span>.getBytes());</div></pre></td></tr></table></figure>
<h3 id="拷贝文件"><a href="#拷贝文件" class="headerlink" title="拷贝文件"></a>拷贝文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFileUsingJava7Files</span><span class="params">( File from, File to )</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Files.copy( from.toPath(), to.toPath() );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>使用 <code>Channel</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFileUsingChannel</span><span class="params">(File source, File dest)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    FileChannel sourceChannel = <span class="keyword">null</span>;</div><div class="line">    FileChannel destChannel = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        sourceChannel = <span class="keyword">new</span> FileInputStream(source).getChannel();</div><div class="line">        destChannel = <span class="keyword">new</span> FileOutputStream(dest).getChannel();</div><div class="line">        destChannel.transferFrom(sourceChannel, <span class="number">0</span>, sourceChannel.size());</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        sourceChannel.close();</div><div class="line">        destChannel.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>使用 <code>Stream</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFileUsingStream</span><span class="params">(File source, File dest)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    InputStream is = <span class="keyword">null</span>;</div><div class="line">    OutputStream os = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        is = <span class="keyword">new</span> FileInputStream(source);</div><div class="line">        os = <span class="keyword">new</span> FileOutputStream(dest);</div><div class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</div><div class="line">        <span class="keyword">int</span> length;</div><div class="line">        <span class="keyword">while</span> ((length = is.read(buffer)) &gt; <span class="number">0</span>) &#123;</div><div class="line">            os.write(buffer, <span class="number">0</span>, length);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        is.close();</div><div class="line">        os.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Paths"><a href="#Paths" class="headerlink" title="Paths"></a>Paths</h3><p>注意这两个的区别:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(srcPath).toPath()</div></pre></td></tr></table></figure>
<p>第二种:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Paths.get(srcPath)</div></pre></td></tr></table></figure>
<p>这完全是两码事，在 <code>Windows</code> 平台上使用第二种会抛出异常:</p>
<p><img src="TIM截图20170811081320.png" alt=""></p>
<h3 id="Java-路径"><a href="#Java-路径" class="headerlink" title="Java 路径"></a><code>Java</code> 路径</h3><p>不要天真的认为分隔符总是 <code>/</code>，在 <code>Windows</code> 操作系统上问题变得异常突出，应该使用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">File.separator</div></pre></td></tr></table></figure>
<h3 id="Java-删除目录"><a href="#Java-删除目录" class="headerlink" title="Java 删除目录"></a><code>Java</code> 删除目录</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteDir</span><span class="params">(File file)</span> </span>&#123;</div><div class="line">    File[] contents = file.listFiles();</div><div class="line">    <span class="keyword">if</span> (contents != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (File f : contents) &#123;</div><div class="line">            deleteDir(f);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    file.delete();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="文件锁"><a href="#文件锁" class="headerlink" title="文件锁"></a>文件锁</h3><p>在 <code>RocketMQ</code> 中，用来防止启动多个 <code>MessageStore</code> 服务:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">File file = <span class="keyword">new</span> File(rootDir + File.separator + <span class="string">"lock"</span>);</div><div class="line">RandomAccessFile lockFile = <span class="keyword">new</span> RandomAccessFile(file, <span class="string">"rw"</span>);</div><div class="line">lock = lockFile.getChannel().tryLock(<span class="number">0</span>, <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line"><span class="keyword">if</span> (lock == <span class="keyword">null</span> || lock.isShared() || !lock.isValid()) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Lock failed,MQ already started"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RandomAccessFile"><a href="#RandomAccessFile" class="headerlink" title="RandomAccessFile"></a><code>RandomAccessFile</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomAccessFile</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">writeUTF</span><span class="params">(String str)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        DataOutputStream.writeUTF(str, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataOutputStream</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">writeUTF</span><span class="params">(String str, DataOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (utflen &gt; <span class="number">65535</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UTFDataFormatException(</div><div class="line">                <span class="string">"encoded string too long: "</span> + utflen + <span class="string">" bytes"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以 <strong><code>writeUTF</code></strong> 方法写入的<strong>字符串长度不能太长</strong>。推荐办法是使用 <code>RandomAccessFile</code> 的 <strong><code>write(byte b[])</code></strong> 方法来写入:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span> b[])</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    writeBytes(b, <span class="number">0</span>, b.length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.kunzhao.org/2017/07/22/file/" data-id="cjcdlsfxk003udiemk7aox384" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/blog/page/10/">&laquo; Prev</a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/9/">9</a><a class="page-number" href="/blog/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/blog/page/12/">12</a><a class="page-number" href="/blog/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/23/">23</a><a class="extend next" rel="next" href="/blog/page/12/">Next&raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    

  
    
  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2018/01/06/where-the-time-actually-gone/">时间都去哪儿了</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/dev-reflection/">开发反思</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/05/my-microblog/">我的微博</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/gcc-basic/">gcc-basic</a>
          </li>
        
          <li>
            <a href="/blog/2018/01/04/java-internal/">Java Internal</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 赵坤&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      Contact&nbsp;|&nbsp;igozhaokun@163.com
    </div>
  </div>
</footer>
 <script src="/blog/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首页</a>
  
    <a href="/blog/archives" class="mobile-nav-link">归档</a>
  
    <a href="/blog/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/blog/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>

      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js"></script>
  


 <script src="/blog/js/is.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/elevator.js"></script>
  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>