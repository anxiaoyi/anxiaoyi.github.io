<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="JVM æ€§èƒ½è°ƒä¼˜"><meta property="og:title" content="JVM æ€§èƒ½è°ƒä¼˜" />
<meta property="og:description" content="JVM å¦‚ä½•è¿›è¡Œæ€§èƒ½è°ƒä¼˜ï¼Ÿ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/posts/jvm-optimization/" />
<meta property="article:published_time" content="2017-05-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-05-02T00:00:00+00:00" />
<title>JVM æ€§èƒ½è°ƒä¼˜ | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.7ebac727e739c3b4aee6328926e3b77ac1ddd5e9035221b7ec206fda1a413a4d.css" integrity="sha256-frrHJ&#43;c5w7Su5jKJJuO3esHd1ekDUiG37CBv2hpBOk0=">


<script defer src="/en.search.min.04a53f033623e53a68db459286b910a62c5fa8dde58d8d74933c43cc61995fe2.js" integrity="sha256-BKU/AzYj5Tpo20WShrkQpixfqN3ljY10kzxDzGGZX&#43;I="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>JVM æ€§èƒ½è°ƒä¼˜</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#java-è™šæ‹Ÿæœºå†…å­˜æ¨¡å‹">Java è™šæ‹Ÿæœºå†…å­˜æ¨¡å‹</a>
      <ul>
        <li><a href="#stack">stack</a></li>
        <li><a href="#heap">HEAP</a></li>
        <li><a href="#method-area">method area</a></li>
      </ul>
    </li>
    <li><a href="#åŒºåŸŸæ¯”ä¾‹">åŒºåŸŸæ¯”ä¾‹</a></li>
    <li><a href="#åƒåœ¾å›æ”¶ç®—æ³•">åƒåœ¾å›æ”¶ç®—æ³•</a></li>
    <li><a href="#å®ç”¨-jvm-å‚æ•°">å®ç”¨ JVM å‚æ•°</a></li>
    <li><a href="#minor-gcmajor-gc-å’Œ-full-gc">Minor GCã€Major GC å’Œ Full GC</a></li>
    <li><a href="#jvm-çš„å·¥ä½œæ¨¡å¼">JVM çš„å·¥ä½œæ¨¡å¼</a></li>
    <li><a href="#heap-memory-æœ€ä½³å®è·µ">Heap Memory æœ€ä½³å®è·µ</a></li>
    <li><a href="#java-monitoring-å¸¸ç”¨å·¥å…·">Java Monitoring å¸¸ç”¨å·¥å…·</a>
      <ul>
        <li><a href="#jstack">jstack</a></li>
        <li><a href="#jinfo">jinfo</a></li>
        <li><a href="#jstat">jstat</a></li>
        <li><a href="#jmap-memory-map">jmap (Memory Map)</a></li>
      </ul>
    </li>
    <li><a href="#å †å†…å­˜ä½¿ç”¨æœ€ä½³å®è·µ">å †å†…å­˜ä½¿ç”¨æœ€ä½³å®è·µ</a>
      <ul>
        <li><a href="#å †åˆ†æ">å †åˆ†æ</a></li>
        <li><a href="#ä½¿ç”¨æ›´å°‘çš„å†…å­˜">ä½¿ç”¨æ›´å°‘çš„å†…å­˜</a></li>
        <li><a href="#å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†">å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†</a></li>
      </ul>
    </li>
    <li><a href="#jit">JIT</a>
      <ul>
        <li><a href="#1-ç¼–è¯‘è¿˜æ˜¯è§£é‡Š">(1) ç¼–è¯‘è¿˜æ˜¯è§£é‡Š</a></li>
        <li><a href="#2-hotspot-åå­—çš„å«ä¹‰">(2) HotSpot åå­—çš„å«ä¹‰</a></li>
        <li><a href="#3-å¯„å­˜å™¨å’Œå†…å­˜">(3) å¯„å­˜å™¨å’Œå†…å­˜</a></li>
        <li><a href="#4-é€‰æ‹©-java-ç¼–è¯‘å™¨">(4) é€‰æ‹© Java ç¼–è¯‘å™¨</a></li>
        <li><a href="#5-æ›´å¤šè€ƒè™‘å› ç´ ">(5) æ›´å¤šè€ƒè™‘å› ç´ </a></li>
        <li><a href="#6-deoptimization">(6) Deoptimization</a></li>
      </ul>
    </li>
    <li><a href="#è¿œç¨‹-jvisualvm">è¿œç¨‹ <code>JVisualVM</code></a></li>
    <li><a href="#dump-ä»€ä¹ˆ">DUMP ä»€ä¹ˆ</a></li>
    <li><a href="#å®é™…è¿ç”¨ä¸­å¦‚ä½•æ¸…æ™°æ˜äº†åœ°è§‚å¯Ÿ-jvm-çš„è¿è¡Œè¿‡ç¨‹">å®é™…è¿ç”¨ä¸­å¦‚ä½•æ¸…æ™°æ˜äº†åœ°è§‚å¯Ÿ JVM çš„è¿è¡Œè¿‡ç¨‹?</a></li>
    <li><a href="#jvm-å¦‚ä½•è¿›é˜¶">JVM å¦‚ä½•è¿›é˜¶</a></li>
    <li><a href="#jvm-åˆ†æ">JVM åˆ†æ</a>
      <ul>
        <li><a href="#cpu-é«˜">CPU é«˜</a></li>
        <li><a href="#cpu-å ç”¨">CPU å ç”¨</a></li>
        <li><a href="#oom">OOM</a></li>
      </ul>
    </li>
    <li><a href="#mat">MAT</a></li>
    <li><a href="#jvm-è¯Šæ–­ç¤ºä¾‹httpsplumbreublogmemory-leaksmemory-leaks-fallacies-and-misconceptions">JVM è¯Šæ–­<a href="https://plumbr.eu/blog/memory-leaks/memory-leaks-fallacies-and-misconceptions">ç¤ºä¾‹</a></a></li>
    <li><a href="#jvisualvm">JVisualVM</a></li>
    <li><a href="#å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨-btrace-è¿›è¡Œè°ƒè¯•httpwwwimportnewcom23614html"><a href="http://www.importnew.com/23614.html">å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Btrace è¿›è¡Œè°ƒè¯•</a></a>
      <ul>
        <li><a href="#btrace-å¯ä»¥åšä»€ä¹ˆ">Btrace å¯ä»¥åšä»€ä¹ˆï¼Ÿ</a></li>
        <li><a href="#å‚æ•°è¯´æ˜">å‚æ•°è¯´æ˜</a></li>
        <li><a href="#å¦‚ä½•ä½¿ç”¨-btrace-å®šä½é—®é¢˜">å¦‚ä½•ä½¿ç”¨ Btrace å®šä½é—®é¢˜</a></li>
        <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  <h1>
    <a href="/posts/jvm-optimization/">JVM æ€§èƒ½è°ƒä¼˜</a>
  </h1>
  

<div>

  <h5>May 2, 2017</h5>



  
  <div>
    
  </div>
  

  
  <div>
    
        <a href="/tags/java/">Java</a>
  </div>
  


</div>


  <p><p>JVM å¦‚ä½•è¿›è¡Œæ€§èƒ½è°ƒä¼˜ï¼Ÿ</p>
<h2 id="java-è™šæ‹Ÿæœºå†…å­˜æ¨¡å‹">Java è™šæ‹Ÿæœºå†…å­˜æ¨¡å‹</h2>
<h3 id="stack">stack</h3>
<p><img src="/images/posts/jvm-optimization/3558cf63-bac7-42b3-9f3b-bcdebffa40a6.png" alt=""></p>
<h3 id="heap">HEAP</h3>
<p><img src="/images/posts/jvm-optimization/Java-Memory-Model.png" alt=""></p>
<ul>
<li><code>-Xmx</code>: è®¾ç½®<!-- raw HTML omitted --><strong>å †çš„æœ€å¤§å€¼</strong><!-- raw HTML omitted --></li>
<li><code>-Xms</code>: è®¾ç½®å †çš„æœ€å°å€¼ï¼Œå³ JVM å¯åŠ¨æ—¶ï¼Œæ‰€å æ®çš„æ“ä½œç³»ç»Ÿå†…å­˜å¤§å°ã€‚JVM ä¼šè¯•å›¾å°†ç³»ç»Ÿå†…å­˜å°½å¯èƒ½åœ°é™åˆ¶åœ¨ <code>-Xms</code> ä¸­ï¼Œå› æ­¤å½“å†…å­˜ä½¿ç”¨é‡è§¦åŠ <code>-Xms</code> æŒ‡å®šçš„å¤§å°æ—¶ï¼Œä¼šè§¦å‘ <strong>Full GC</strong>ã€‚å› æ­¤<strong>æŠŠ <code>-Xms</code> å€¼è®¾ç½®ä¸º <code>-Xmx</code> æ—¶</strong>ï¼Œå¯ä»¥åœ¨ç³»ç»Ÿè¿è¡ŒåˆæœŸå‡å°‘ <strong>GC</strong> çš„æ¬¡æ•°å’Œè€—æ—¶ã€‚</li>
<li><code>Xmn</code>: è®¾ç½®æ–°ç”Ÿä»£å¤§å°ã€‚ç­‰äºæŠŠ <code>-XX:NewSize</code> å’Œ <code>-XX:MaxNewSize</code> è®¾ç½®æˆäº†ç›¸åŒçš„å¤§å°ã€‚è¿™ä¸¤ä¸ªå¦‚æœè®¾ç½®æˆä¸åŒçš„å€¼ï¼Œä¼šå¯¼è‡´å†…å­˜éœ‡è¡ï¼Œäº§ç”Ÿä¸å¿…è¦çš„å¼€é”€ã€‚
<ul>
<li><code>-XX:NewSize</code>: è®¾ç½®æ–°ç”Ÿä»£çš„åˆå§‹å¤§å°</li>
<li><code>-XX:MaxNewSize</code>: è®¾ç½®æ–°ç”Ÿä»£çš„æœ€å¤§å€¼</li>
</ul>
</li>
</ul>
<p>é”™è¯¯çš„æŠŠ <code>Xmx</code> å‚æ•°è®¾ç½®ä¸ºäº† <code>Xmn</code> å‚æ•°ä»¥å:</p>
<p><img src="/images/posts/jvm-optimization/TIM%E5%9B%BE%E7%89%8720170814035500.png" alt=""></p>
<p>è·å–å½“å‰å†…å­˜/æœ€å¤§å¯ç”¨å†…å­˜/æœ€å¤§å¯ç”¨å †:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">freeMemory</span><span style="color:#f92672">()</span> <span style="color:#f92672">/</span> 1024 <span style="color:#f92672">/</span> 1024
Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">totalMemory</span><span style="color:#f92672">()</span> <span style="color:#f92672">/</span> 1024 <span style="color:#f92672">/</span> 1024
Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">maxMemory</span><span style="color:#f92672">()</span> <span style="color:#f92672">/</span> 1000 <span style="color:#f92672">/</span> 1000
</code></pre></div><h4 id="é€ƒé€¸åˆ†æ">é€ƒé€¸åˆ†æ</h4>
<p>Java 7 å¼€å§‹æ”¯æŒ<strong>å¯¹è±¡çš„æ ˆåˆ†é…å’Œé€ƒé€¸åˆ†ææœºåˆ¶</strong>ï¼Œè¿™æ ·çš„æœºåˆ¶èƒ½å¤Ÿå°†<strong>å †åˆ†é…å¯¹è±¡å˜æˆæ ˆåˆ†é…å¯¹è±¡</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">myMethod</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    V v <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> V<span style="color:#f92672">();</span>
    <span style="color:#75715e">// use v
</span><span style="color:#75715e"></span>    v <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li><strong><code>-server</code></strong>: <code>server</code> æ¨¡å¼ä¸‹ï¼Œæ‰å¯ä»¥å¯ç”¨é€ƒé€¸åˆ†æ</li>
<li><strong><code>-XX:DoEscapeAnalysis</code></strong>: å¯ç”¨é€ƒé€¸åˆ†æ</li>
</ul>
<h3 id="method-area">method area</h3>
<p>æ–¹æ³•åŒºä¸»è¦ä¿å­˜çš„æ˜¯<strong>ç±»çš„å…ƒæ•°æ®</strong>ï¼šç±»å‹ã€å¸¸é‡æ± ã€å­—æ®µã€æ–¹æ³•ã€‚åœ¨ Hot Spot è™šæ‹Ÿæœºä¸­ï¼Œ<strong>æ–¹æ³•åŒºä¹Ÿç§°ä¸ºæ°¸ä¹…åŒº</strong>ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥è¢« GC å›æ”¶ã€‚<strong>æŒä¹…ä»£çš„å¤§å°ç›´æ¥å†³å®šäº†ç³»ç»Ÿå¯ä»¥æ”¯æŒå¤šå°‘ä¸ªç±»å®šä¹‰å’Œå¤šå°‘å¸¸é‡</strong>ã€‚å¯¹äºä½¿ç”¨ CGLIB æˆ–è€… Javassist ç­‰åŠ¨æ€å­—èŠ‚ç ç”Ÿæˆå·¥å…·çš„åº”ç”¨ç¨‹åºè€Œè¨€ï¼Œè®¾ç½®åˆç†çš„æŒä¹…ä»£æœ‰åˆ©äºç»´æŒç³»ç»Ÿç¨³å®šã€‚</p>
<p><strong>æ–¹æ³•åŒºçš„å¤§å°ç›´æ¥å†³å®šäº†ç³»ç»Ÿå¯ä»¥ä¿å­˜å¤šå°‘ä¸ªç±»</strong>ï¼Œå¦‚æœç³»ç»Ÿä½¿ç”¨äº†ä¸€äº›åŠ¨æ€ä»£ç†ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä¼šåœ¨è¿è¡Œæ—¶ç”Ÿæˆå¤§é‡çš„ç±»ï¼Œå¦‚æœè¿™æ ·ï¼Œå°±éœ€è¦è®¾ç½®ä¸€ä¸ªåˆç†çš„æ°¸ä¹…åŒºå¤§å°ï¼Œç¡®ä¿ä¸å‘ç”Ÿæ°¸ä¹…åŒºå†…å­˜æº¢å‡ºã€‚</p>
<ul>
<li><code>-XX:MaxPermSize=4M</code>: è®¾ç½®æŒä¹…ä»£çš„æœ€å¤§å€¼</li>
<li><code>-XX:PermSize=4M</code>: è®¾ç½®æŒä¹…ä»£çš„åˆå§‹å¤§å°</li>
</ul>
<p>åœ¨ JDK 1.8 ä¸­ï¼Œæ°¸ä¹…åŒºå·²ç»è¢«å½»åº•ç§»é™¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯<strong>å…ƒæ•°æ®åŒº (Metaspace)ï¼Œå…ƒæ•°æ®åŒºæ˜¯ä¸€å—å †å¤–çš„ç›´æ¥å†…å­˜</strong>ï¼Œå¦‚æœä¸æŒ‡å®šå…ƒæ•°æ®åŒºå¤§å°çš„è¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰çš„å¯ç”¨ç³»ç»Ÿå†…å­˜ã€‚</p>
<ul>
<li><code>-XX:MaxMetaspaceSize</code>: æŒ‡å®šå…ƒæ•°æ®åŒºå¤§å°</li>
</ul>
<p><img src="/images/posts/jvm-optimization/9906824978c891c86524f9394102de6c.png" alt=""></p>
<blockquote>
<p>Interned Strings æ”¾åœ¨å“ªé‡Œ ?</p>
</blockquote>
<p><code>String</code> ç±»å‹çš„å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šã€‚ä¸»è¦ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§:</p>
<ul>
<li>ç›´æ¥ä½¿ç”¨åŒå¼•å·å£°æ˜å‡ºæ¥çš„ <code>String</code> å¯¹è±¡ä¼šç›´æ¥å­˜å‚¨åœ¨<strong>å¸¸é‡æ± </strong>ä¸­ã€‚</li>
<li>å¦‚æœä¸æ˜¯åŒå¼•å·å£°æ˜çš„ <code>String</code> å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨ <code>String</code> æä¾›çš„ <code>intern</code> æ–¹æ³•ã€‚<code>intern</code> ä¼šå…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨å¸¸é‡æ± ä¸­ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šå°†å½“å‰å­—ç¬¦ä¸²æ”¾å…¥å¸¸é‡æ± ä¸­ã€‚</li>
</ul>
<p>JDK 6 çš„å¸¸é‡æ± æ”¾åœ¨ <strong><code>Perm</code></strong> åŒºä¸­ï¼Œé»˜è®¤å¤§å°åªæœ‰ 4 MBã€‚JDK 7å¼€å§‹ï¼Œæ”¾åœ¨<strong>å †</strong>ä¸­ã€‚</p>
<h2 id="åŒºåŸŸæ¯”ä¾‹">åŒºåŸŸæ¯”ä¾‹</h2>
<p><img src="/images/posts/jvm-optimization/gc_s.png" alt=""></p>
<ul>
<li><code>-XX:SurvivorRatio=8</code>: è®¾ç½®æ–°ç”Ÿä»£ä¸­ <strong>eden ç©ºé—´</strong> å’Œ <strong>S0 ç©ºé—´</strong> çš„æ¯”ä¾‹å…³ç³»</li>
<li><code>-XX:NewRatio=2</code>: è®¾ç½®è€ç”Ÿä»£å’Œæ–°ç”Ÿä»£çš„æ¯”ä¾‹</li>
</ul>
<h2 id="åƒåœ¾å›æ”¶ç®—æ³•">åƒåœ¾å›æ”¶ç®—æ³•</h2>
<ul>
<li><strong>å¼•ç”¨è®¡æ•°æ³•</strong>: æ— æ³•è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜</li>
<li>æ ‡è®°-æ¸…é™¤ç®—æ³• (Mark-Sweep):
<ol>
<li>æ ‡è®°ä»æ ¹èŠ‚ç‚¹å¼€å§‹çš„å¯è¾¾å¯¹è±¡</li>
<li>æ¸…é™¤æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡</li>
<li><strong>æœ€å¤§ç¼ºç‚¹: å›æ”¶åçš„ç©ºé—´æ˜¯ä¸è¿ç»­çš„</strong></li>
</ol>
</li>
<li>å¤åˆ¶ç®—æ³• (<strong>æ–°ç”Ÿä»£</strong>):
<ol>
<li>å†…å­˜ç©ºé—´åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªç”¨ä¸€å—</li>
<li><strong>å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªä½¿ç”¨çš„å†…å­˜å—ä¸­</strong></li>
<li>æ¸…é™¤æ­£åœ¨ä½¿ç”¨çš„å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡</li>
<li>äº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰²</li>
<li><strong>é€‚åˆäºæ–°ç”Ÿä»£: åƒåœ¾å¯¹è±¡é€šå¸¸å¤šäºå­˜æ´»å¯¹è±¡</strong></li>
</ol>
</li>
<li>æ ‡è®°-å‹ç¼©ç®—æ³•:
<ol>
<li>æ ‡è®°ä»æ ¹èŠ‚ç‚¹å¼€å§‹çš„å¯è¾¾å¯¹è±¡</li>
<li>å°†æ‰€æœ‰å­˜æ´»å¯¹è±¡ (æœªæ ‡è®°çš„å¯¹è±¡) å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯</li>
<li>æ¸…ç†è¾¹ç•Œå¤– (æ ‡è®°å’Œæœªæ ‡è®°å¯¹è±¡çš„è¾¹ç•Œ) çš„å¯¹è±¡</li>
</ol>
</li>
</ul>
<p><img src="/images/posts/jvm-optimization/gc-algorithms-37-638.jpg" alt=""></p>
<ul>
<li>åˆ†ä»£ (Generational Collecting):
<ol>
<li>æ ¹æ®æ¯å—å†…å­˜ç©ºé—´ç‰¹ç‚¹çš„ä¸åŒï¼Œä½¿ç”¨ä¸åŒçš„å›æ”¶ç®—æ³•ã€‚å¦‚æ–°ç”Ÿä»£ (å­˜æ´»å¯¹è±¡å°‘ï¼Œåƒåœ¾å¯¹è±¡å¤š) ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£ (å¤§éƒ¨åˆ†å¯¹è±¡æ˜¯å­˜æ´»å¯¹è±¡) ä½¿ç”¨æ ‡è®°-å‹ç¼©ç®—æ³•</li>
</ol>
</li>
</ul>
<p>ä¸ºäº†æ”¯æŒé«˜é¢‘ç‡çš„æ–°ç”Ÿä»£å›æ”¶ï¼Œè™šæ‹Ÿæœºå¯èƒ½ä½¿ç”¨ä¸€ç§å«åš<strong>å¡è¡¨ (Card Table)</strong> çš„æ•°æ®ç»“æ„ã€‚å¡è¡¨ä¸ºä¸€ä¸ªæ¯”ç‰¹ä½é›†åˆï¼Œæ¯ä¸€ä¸ªæ¯”ç‰¹ä½å¯ä»¥ç”¨æ¥è¡¨ç¤ºè€å¹´ä»£çš„æŸä¸€åŒºåŸŸä¸­çš„æ‰€æœ‰å¯¹è±¡æ˜¯å¦æŒæœ‰æ–°ç”Ÿä»£å¯¹è±¡çš„å¼•ç”¨ã€‚è¿™æ ·åœ¨æ–°ç”Ÿä»£ GC æ—¶ï¼Œåªéœ€å…ˆæ‰«æå¡è¡¨ï¼Œå°±èƒ½å¿«é€ŸçŸ¥é“ç”¨ä¸ç”¨æ‰«æç‰¹å®šçš„è€å¹´ä»£å¯¹è±¡ï¼Œè€Œå¡è¡¨ä¸º 0 çš„æ‰€åœ¨åŒºåŸŸä¸€å®šä¸å«æœ‰æ–°ç”Ÿä»£å¯¹è±¡çš„å¼•ç”¨ã€‚</p>
<h2 id="å®ç”¨-jvm-å‚æ•°">å®ç”¨ JVM å‚æ•°</h2>
<ul>
<li>è·å–å †å¿«ç…§ã€‚</li>
</ul>
<p>å‘ç”Ÿ <code>OutOfMemoryError</code> æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=C:\m.hprof</code> æ¥ä¿å­˜å½“å‰çš„å †å¿«ç…§åˆ°æ–‡ä»¶ä¸­ã€‚ä¹Ÿå¯ä»¥åŠ ä¸Šå‚æ•° <code>-XX:OnOutOfMemoryError=c:\reset.bat</code> æ¥è¿è¡Œä¸€æ®µè„šæœ¬ã€‚</p>
<p>å½“å‘ç”Ÿ <code>OutOfMemoryError</code> (åœ¨ä¸€ä¸ª <code>Windows 32</code> ç³»ç»Ÿä¸Šå°±å‘ç”Ÿè¿‡) çš„æ—¶å€™ï¼Œ<strong>åº”è¯¥å°è¯•ä½¿ç”¨å¢å¤§å¯ç”¨å †</strong>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">java <span style="color:#f92672">-</span>Xmn1024M <span style="color:#f92672">-</span>jar xxx<span style="color:#f92672">.</span><span style="color:#a6e22e">jar</span>
</code></pre></div><p><strong>TODO: æ€è€ƒ: å¦‚æœçŸ¥æ™“ç¨‹åºç©¶ç«Ÿéœ€è¦å¤šå¤§å†…å­˜ï¼Ÿ</strong></p>
<ul>
<li>è·å– GC ä¿¡æ¯</li>
</ul>
<p>ä½¿ç”¨å‚æ•° <code>-verbose:gc</code> æˆ–è€… <code>-XX:+PrintGC</code> æ¥è·å–ç®€è¦çš„ GC ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>-XX:+PrintGCDetails</code> æ¥è·å–æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ã€‚å¦‚æœéœ€è¦åœ¨ GC å‘ç”Ÿçš„æ—¶åˆ»æ‰“å° GC å‘ç”Ÿçš„æ—¶é—´ï¼Œåˆ™å¯ä»¥è¿½åŠ  <code>-XX:+PrintGCTimeStamps</code> é€‰é¡¹ä»¥æŸ¥çœ‹<strong>ç›¸å¯¹æ—¶é—´</strong>æˆ–è€… <code>-XX:+PrintGCDateStamps</code> ä»¥æŸ¥çœ‹<strong>ç»å¯¹æ—¶é—´</strong>ã€‚å¦‚æœè®¸é›…æŸ¥çœ‹æ–°ç”Ÿå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å®é™…é˜ˆå€¼ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•° <code>-XX:+PrintTenuringDistribution -XX:MaxTenuringThreshold=18</code> æ¥è¿è¡Œç¨‹åºã€‚å¦‚æœéœ€è¦åœ¨ GC æ—¶ï¼Œæ‰“å°è¯¦ç»†çš„å †ä¿¡æ¯ï¼Œåˆ™å¯ä»¥æ‰“å¼€ <code>-XX:+PrintHeapAtGC</code> å¼€å…³ã€‚</p>
<ul>
<li>æ§åˆ¶ GC</li>
</ul>
<p><code>-XX:+PrintExplicitGC</code> é€‰é¡¹ç”¨äºç¦æ­¢æ˜¾å¼çš„ GC æ“ä½œï¼Œå³ç¦æ­¢åœ¨ç¨‹åºä¸­ä½¿ç”¨ <code>System.gc()</code> è§¦å‘çš„ <code>Full GC</code>ã€‚å¦ä¸€ä¸ªæœ‰ç”¨çš„ GC æ§åˆ¶å‚æ•°æ˜¯ <code>-Xincgc</code>ï¼Œä¸€æ—¦å¯ç”¨è¿™ä¸ªå‚æ•°ï¼Œç³»ç»Ÿä¾¿ä¼šè¿›è¡Œå¢é‡å¼çš„ GCã€‚</p>
<p><strong>JVM è°ƒä¼˜çš„ä¸»è¦è¿‡ç¨‹æœ‰</strong>: ç¡®å®šå †å†…å­˜å¤§å° (<code>-Xmxã€-Xms</code>)ã€åˆç†åˆ†é…æ–°ç”Ÿä»£å’Œè€å¹´ä»£ (<code>-XX:NewRatioã€-Xmnã€-XX:SurvivorRatio</code>)ã€ç¡®å®šæ°¸ä¹…åŒºå¤§å° (<code>-XX:Permsizeã€-XX:MaxPermSize</code>)ã€é€‰æ‹©åƒåœ¾æ”¶é›†å™¨ã€å¯¹åƒåœ¾æ”¶é›†å™¨è¿›è¡Œåˆç†çš„è®¾ç½®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç¦ç”¨æ˜¾å¼ GC (<code>-XX:+DisableExplicitGC</code>)ã€ç¦ç”¨ç±»å…ƒæ•°æ®å›æ”¶ (<code>+Xnoclassgc</code>)ã€ç¦ç”¨ç±»éªŒè¯ (<code>-Xverify:none</code>) ç­‰è®¾ç½®ï¼Œå¯¹æå‡ç³»ç»Ÿæ€§èƒ½ä¹Ÿæœ‰ä¸€å®šçš„å¸®åŠ©ã€‚</p>
<ul>
<li>GC æ—¥å¿—ç¤ºä¾‹</li>
</ul>
<p>ä½¿ç”¨ <code>-XX:+PrintGC</code> è·å–çš„ GC æ—¥å¿—:</p>
<pre><code>[GC (Allocation Failure)  GCå‰å †ä½¿ç”¨é‡20M-&gt;GCåå †ä½¿ç”¨é‡(å½“å‰å¯ç”¨å †å¤§å°90M), æœ¬æ¬¡GCèŠ±è´¹ 0.0028389 ç§’]
[GC (Allocation Failure)  20409K-&gt;432K(92672K), 0.0028389 secs]
</code></pre><p>åŒæ ·çš„ä»£ç ä½¿ç”¨ <code>-X:+PrintGCDetails</code> è·å–çš„ GC æ—¥å¿—:</p>
<pre><code>[GC (Allocation Failure) [æ–°ç”Ÿä»£: ä»20M-&gt;é™ä¸º0.4M(å¯ç”¨28M)] æ•´ä¸ªå †ä»20M-&gt;å°†ä¸º0.4M(å¯ç”¨90M), 0.0151333 secs] [Times: ç”¨æˆ·æ€æ—¶é—´è€—æ—¶ï¼Œç³»ç»Ÿæ€æ—¶é—´è€—æ—¶ï¼ŒGC å®é™…ç»å†çš„æ—¶é—´]
    æ–°ç”Ÿä»£ æ€»å¤§å° 28M, å·²ç”¨ 13M [ä¸‹ç•Œï¼Œå½“å‰ä¸Šç•Œï¼Œä¸Šç•Œ]
[GC (Allocation Failure) [PSYoungGen: 20409K-&gt;448K(28160K)] 20409K-&gt;456K(92672K), 0.0151333 secs] [Times: user=0.00 sys=0.00, real=0.02 secs] 
Heap
 PSYoungGen      total 28160K, used 13461K [0x00000000e1380000, 0x00000000e4a80000, 0x0000000100000000)
  eden space 24576K, 52% used [0x00000000e1380000,0x00000000e20356d0,0x00000000e2b80000)
  from space 3584K, 12% used [0x00000000e2b80000,0x00000000e2bf0020,0x00000000e2f00000)
  to   space 3584K, 0% used [0x00000000e4700000,0x00000000e4700000,0x00000000e4a80000)
 ParOldGen       total 64512K, used 8K [0x00000000a3a00000, 0x00000000a7900000, 0x00000000e1380000)
  object space 64512K, 0% used [0x00000000a3a00000,0x00000000a3a02000,0x00000000a7900000)
 Metaspace       used 3264K, capacity 4494K, committed 4864K, reserved 1056768K
  class space    used 363K, capacity 386K, committed 512K, reserved 1048576K
</code></pre><p>å¦‚æœéœ€è¦æ›´ä¸ºå…¨é¢çš„å †ä¿¡æ¯ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å‚æ•° <code>-XX:+PrintHeapAtGC</code>ï¼Œå®ƒä¼šåœ¨æ¯æ¬¡ GC å‰ååˆ†åˆ«æ‰“å°å †çš„ä¿¡æ¯</p>
<pre><code>{Heap before GC invocations=1 (full 0):
    ...
Heap after GC invocations=1 (full 0):
    ...
}
</code></pre><p>å¦‚æœéœ€è¦åˆ†æ GC å‘ç”Ÿçš„æ—¶é—´ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code>-XX:+PrintGCTimeStamps</code> å‚æ•°ï¼Œè¯¥è¾“å‡ºæ—¶é—´ä¸ºè™šæ‹Ÿæœºå¯åŠ¨åçš„æ—¶é—´åç§»é‡:</p>
<pre><code>0.174: [GC (Allocation Failure)  20409K-&gt;504K(92672K), 0.0016586 secs]
0.179: [GC (Allocation Failure)  19415K-&gt;464K(92672K), 0.0031200 secs]
0.186: [GC (Allocation Failure)  19812K-&gt;432K(92672K), 0.0009531 secs]
</code></pre><p>ç”±äº GC è¿˜ä¼šå¼•èµ·åº”ç”¨ç¨‹åºåœé¡¿ï¼Œä½¿ç”¨å‚æ•° <code>-XX:+PrintGCApplicationConcurrentTime</code> å¯ä»¥æ‰“å°åº”ç”¨ç¨‹åºçš„æ‰§è¡Œæ—¶é—´ï¼Œä½¿ç”¨å‚æ•° <code>-XX:+PrintGCApplicationStoppedTime</code> å¯ä»¥æ‰“å°åº”ç”¨ç¨‹åºç”±äº GC è€Œäº§ç”Ÿçš„åœé¡¿æ—¶é—´:</p>
<pre><code>Application time: 0.0084849 seconds
[GC (Allocation Failure)  20409K-&gt;520K(92672K), 0.0044274 secs]
Total time for which application threads were stopped: 0.0045452 seconds, Stopping threads took: 0.0000210 seconds
Application time: 0.0033066 seconds
[GC (Allocation Failure)  19431K-&gt;440K(117248K), 0.0020202 secs]
Total time for which application threads were stopped: 0.0021438 seconds, Stopping threads took: 0.0000258 seconds
Application time: 0.0082455 seconds
</code></pre><p>å¦‚æœæƒ³è·Ÿè¸ªç³»ç»Ÿå†…çš„è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨å’Œ <code>Finalize</code> é˜Ÿåˆ—ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ‰“å¼€ <code>-XX:+PrintReferenceGC</code> å¼€å…³. ä½¿ç”¨å‚æ•° <code>-Xloggc:log/gc.log</code> å¯åŠ¨è™šæ‹Ÿæœºï¼Œå°† GC æ—¥å¿—è¾“å‡ºåˆ° <code>gc.log</code> æ–‡ä»¶ä¸­</p>
<pre><code>Java HotSpot(TM) 64-Bit Server VM (25.111-b14) for linux-amd64 JRE (1.8.0_111-b14), built on Sep 22 2016 16:14:03 by &quot;java_re&quot; with gcc 4.3.0 20080428 (Red Hat 4.3.0-8)
Memory: 4k page, physical 6052560k(316636k free), swap 6233084k(4248464k free)
CommandLine flags: -XX:InitialHeapSize=96840960 -XX:MaxHeapSize=1549455360 -XX:+PrintGC -XX:+PrintGCApplicationConcurrentTime -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC 
0.183: Application time: 0.0107645 seconds
0.183: [GC (Allocation Failure)  20409K-&gt;432K(92672K), 0.0033748 secs]
0.187: Total time for which application threads were stopped: 0.0035825 seconds, Stopping threads took: 0.0000191 seconds
0.192: Application time: 0.0054269 seconds
0.193: [GC (Allocation Failure)  19343K-&gt;496K(117248K), 0.0108382 secs]
0.204: Total time for which application threads were stopped: 0.0116746 seconds, Stopping threads took: 0.0000766 seconds
0.212: Application time: 0.0084699 seconds
</code></pre><p><img src="/images/posts/jvm-optimization/17-06-13-17-16-55_1236_518.png" alt=""></p>
<p><!-- raw HTML omitted --><strong>ç³»ç»Ÿå‚æ•°æŸ¥çœ‹</strong><!-- raw HTML omitted -->:</p>
<ul>
<li><strong>-XX:+PrintVMOptions</strong>: æ‰“å°è™šæ‹Ÿæœºæ¥å—çš„å‘½ä»¤è¡Œ<strong>æ˜¾ç¤º</strong>å‚æ•°</li>
<li><strong>-XX:+PrintCommandLineFlags</strong>: æ‰“å°è™šæ‹Ÿæœºçš„<strong>æ˜¾ç¤ºå’Œéšå¼</strong>å‚æ•°</li>
<li><strong>-XX:+PrintFlagsFinal</strong>: æ‰“å°æ‰€æœ‰çš„ç³»ç»Ÿå‚æ•°çš„å€¼</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># æ‰“å°å‡ºç³»ç»Ÿçš„å †å¤§å°</span>
java -XX:+PrintFlagsFinal -version | grep -iE <span style="color:#e6db74">&#39;HeapSize|PermSize|ThreadStackSize&#39;</span>
</code></pre></div><h2 id="minor-gcmajor-gc-å’Œ-full-gc">Minor GCã€Major GC å’Œ Full GC</h2>
<p><img src="/images/posts/jvm-optimization/minor-gc-major-gc-full-gc.jpg" alt=""></p>
<ul>
<li><strong>Minor GC</strong>: ä»å¹´è½»ä»£å›æ”¶åƒåœ¾ï¼Œå½“ <strong>JVM</strong> æ— æ³•åˆ†é…æ–°å¯¹è±¡çš„æ—¶å€™ä¼šè§¦å‘ <strong>Minor GC</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ <strong>Eden</strong> åŒºåŸŸå·²ç»æ»¡äº†</li>
<li><strong>Major GC</strong>: æ¸…é™¤ <strong>Tenured</strong> åŒºåŸŸ</li>
<li><strong>Full GC</strong>: æ¸…é™¤æ•´ä¸ªå †ï¼ŒåŒ…æ‹¬ <strong>Yound å’Œ Tenured</strong> åŒºåŸŸ</li>
</ul>
<h2 id="jvm-çš„å·¥ä½œæ¨¡å¼">JVM çš„å·¥ä½œæ¨¡å¼</h2>
<ul>
<li><strong><code>java -version</code></strong>: æŸ¥çœ‹ <code>Server VM</code></li>
<li><strong><code>java -client -version</code></strong>: æŸ¥çœ‹ <code>Client VM</code></li>
</ul>
<p><code>Client</code> å’Œ <code>Server</code> æ¨¡å¼ä¸‹çš„å„ç§å‚æ•°å¯èƒ½ä¼šæœ‰å¾ˆå¤§ä¸åŒ</p>
<h2 id="heap-memory-æœ€ä½³å®è·µ">Heap Memory æœ€ä½³å®è·µ</h2>
<ul>
<li>æ˜¯å¦åˆ†é…äº†è¿‡å¤šå®ä¾‹: ä½¿ç”¨ <code>jcmd 8998 GC.class_histogram</code> æ¥æŸ¥çœ‹å„å®ä¾‹æœ‰å¤šå°‘ä¸ªï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>jmap -histo 8998</code> æ¥è·å¾—ç›¸åŒçš„ç»“æœ</li>
<li>åˆ†æå †å¿«ç…§: ä½¿ç”¨ <strong>jhatã€jvisualvmã€mat</strong> ç­‰å·¥å…·æ¥åˆ†æ <strong>hprof</strong> æ–‡ä»¶
<ul>
<li><code>jcmd 8998 GC.heap_dump /path/to/heap_dump.hprof</code></li>
<li><code>jmap -dump:live,file=/path/to/heap_dump.hprof 8998</code>: å¼•å…¥ <code>live</code> å¼ºåˆ¶ <strong>full GC</strong></li>
</ul>
</li>
</ul>
<h2 id="java-monitoring-å¸¸ç”¨å·¥å…·">Java Monitoring å¸¸ç”¨å·¥å…·</h2>
<h3 id="jstack">jstack</h3>
<p>Jstack: Dumps the stacks of a Java è¿›ç¨‹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jstack $PID &gt; $DATE_DIR/jstack-$PID.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
</code></pre></div><h3 id="jinfo">jinfo</h3>
<p>Jinfo: Provides visibility into the system properties of the JVM, and allows some system properties to be set dynamically.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zk-pc:~# jinfo <span style="color:#ae81ff">18772</span>
Attaching to process ID 18772, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.144-b01
Java System Properties:

com.sun.management.jmxremote.authenticate <span style="color:#f92672">=</span> false
java.runtime.name <span style="color:#f92672">=</span> Java<span style="color:#f92672">(</span>TM<span style="color:#f92672">)</span> SE Runtime Environment
java.vm.version <span style="color:#f92672">=</span> 25.144-b01
...<span style="color:#f92672">(</span>çœç•¥å¥½å¤š<span style="color:#f92672">)</span>

VM Flags:
Non-default VM flags: -XX:CICompilerCount<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> -XX:InitialHeapSize<span style="color:#f92672">=</span><span style="color:#ae81ff">98566144</span> -XX:+ManagementServer -XX:MaxHeapSize<span style="color:#f92672">=</span><span style="color:#ae81ff">1549795328</span> -XX:MaxNewSize<span style="color:#f92672">=</span><span style="color:#ae81ff">516423680</span> -XX:MinHeapDeltaBytes<span style="color:#f92672">=</span><span style="color:#ae81ff">524288</span> -XX:NewSize<span style="color:#f92672">=</span><span style="color:#ae81ff">32505856</span> -XX:OldSize<span style="color:#f92672">=</span><span style="color:#ae81ff">66060288</span> -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseFastUnorderedTimeStamps -XX:+UseParallelGC 
Command line:  -Dcom.sun.management.jmxremote.port<span style="color:#f92672">=</span><span style="color:#ae81ff">5780</span> -Dcom.sun.management.jmxremote.authenticate<span style="color:#f92672">=</span>false -Dcom.sun.management.jmxremote.ssl<span style="color:#f92672">=</span>false -javaagent:/usr/lib/intellij_idea/idea-IC-172.3968.16/lib/idea_rt.jar<span style="color:#f92672">=</span>35487:/usr/lib/intellij_idea/idea-IC-172.3968.16/bin -Dfile.encoding<span style="color:#f92672">=</span>UTF-8
</code></pre></div><h3 id="jstat">jstat</h3>
<p>jstat: æä¾›æœ‰å…³ GC å’Œç±»åŠ è½½æ´»åŠ¨çš„ç›¸å…³ä¿¡æ¯</p>
<p>æ˜¾ç¤ºå¯ç”¨çš„ä¹ä¸ª options:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jstat -options
</code></pre></div><p>One useful option is <code>-gcutil</code>, which displays the <strong>time spent in GC</strong> as well as the <strong>percentage of each GC area that is currently filled</strong>. Other options to <code>jstat</code> will display the <strong>GC sizes in terms of KB</strong>.</p>
<p>Remember that <code>jstat</code> takes an optional argumentâ€”<strong>the number of milliseconds to repeat the command</strong>â€”so it can monitor over time the effect of GC in an application.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jstat -gcutil process_id <span style="color:#ae81ff">1000</span>
</code></pre></div><p>æ‰“å°å‡ºçš„æ˜¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zk-pc:~# jstat -gcutil <span style="color:#ae81ff">18772</span>
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   
  0.00  71.53  97.93  34.02  96.70  93.37     <span style="color:#ae81ff">29</span>    0.133     <span style="color:#ae81ff">1</span>    0.040    0.172
</code></pre></div><hr>
<p><code>gccapacity</code> å¯ä»¥æ˜¾ç¤º VM å†…å­˜ä¸­ä¸‰ä»£ï¼ˆyoung,old,permï¼‰å¯¹è±¡çš„ä½¿ç”¨å’Œå ç”¨å¤§å°</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jstat -gccapacity process_id
</code></pre></div><p>æ‰“å°å‡ºçš„æ˜¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zk-pc:~# jstat -gccapacity <span style="color:#ae81ff">18772</span>
 NGCMN    NGCMX     NGC     S0C   S1C       EC      OGCMN      OGCMX       OGC         OC       MCMN     MCMX      MC     CCSMN    CCSMX     CCSC    YGC    FGC 
 31744.0 504320.0  30720.0 4608.0 4608.0  21504.0    64512.0  1009152.0    44032.0    44032.0      0.0 1069056.0  22272.0      0.0 1048576.0   2560.0     <span style="color:#ae81ff">32</span>     <span style="color:#ae81ff">1</span>
</code></pre></div><h3 id="jmap-memory-map">jmap (Memory Map)</h3>
<p>jmap: Provides heap dumps and other information about JVM memory usage.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jmap $PID
</code></pre></div><p>æ‰“å°çš„æ˜¯ä¸€å †è¿™ç§ä¸œè¥¿:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zk-pc:~# jmap <span style="color:#ae81ff">18772</span>
Attaching to process ID 18772, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.144-b01
0x0000000000400000	7K	/usr/lib/jvm/oracle_jdk8/jdk1.8.0_144/bin/java
0x00007f7072978000	98K	/lib/x86_64-linux-gnu/libresolv-2.23.so
0x00007f7072b93000	26K	/lib/x86_64-linux-gnu/libnss_dns-2.23.so
0x00007f7072d9a000	10K	/lib/x86_64-linux-gnu/libnss_mdns4_minimal.so.2
0x00007f70737a1000	87K	/lib/x86_64-linux-gnu/libgcc_s.so.1
0x00007f70739b7000	251K	/usr/lib/jvm/oracle_jdk8/jdk1.8.0_144/jre/lib/amd64/libsunec.so
...<span style="color:#f92672">(</span>çœç•¥å¥½å¤š<span style="color:#f92672">)</span>
</code></pre></div><hr>
<p><strong>Print histogram(ç›´æ–¹å›¾ï¼›æŸ±çŠ¶å›¾) of java object heap</strong>; if the &ldquo;live&rdquo; suboption is specified, only count live objects:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jmap -histo $PID
jmap -histo:live $PID
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zk-pc:~# jmap -F -histo <span style="color:#ae81ff">18772</span>
Object Histogram:

num 	  <span style="color:#75715e">#instances	#bytes	Class description</span>
--------------------------------------------------------------------------
1:		65711	10183976	char<span style="color:#f92672">[]</span>
2:		13523	8919400	byte<span style="color:#f92672">[]</span>
3:		54732	2159368	java.lang.Object<span style="color:#f92672">[]</span>
4:		7341	1451792	int<span style="color:#f92672">[]</span>
5:		56423	1354152	java.lang.String
6:		15476	619040	java.util.TreeMap$Entry
7:		16562	529984	java.io.ObjectStreamClass$WeakClassKey
8:		11915	476600	java.util.LinkedHashMap$Entry
9:		9716	466368	java.util.HashMap
10:		3993	453312	java.lang.Class
11:		11568	370176	java.util.concurrent.ConcurrentHashMap$Node
12:		6160	306952	java.util.HashMap$Node<span style="color:#f92672">[]</span>
13:		4210	279856	java.util.Hashtable$Entry<span style="color:#f92672">[]</span>
14:		8320	266240	java.util.Vector
15:		8070	258240	java.util.HashMap$Node
16:		10495	251880	org.jsoup.nodes.Attribute
17:		4181	200688	java.util.Hashtable
...<span style="color:#f92672">(</span>çœç•¥å¥½å¤š<span style="color:#f92672">)</span>
</code></pre></div><hr>
<p><strong>Print java heap summary</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jmap -heap $PID
</code></pre></div><p>æ‰“å°å‡ºçš„æ˜¯ä¸€å †è¿™ç§ä¸œè¥¿:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@zk-pc:~# jmap -heap <span style="color:#ae81ff">18772</span>
Attaching to process ID 18772, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.144-b01

using thread-local object allocation.
Parallel GC with <span style="color:#ae81ff">4</span> thread<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>

Heap Configuration:
   MinHeapFreeRatio         <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
   MaxHeapFreeRatio         <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
   MaxHeapSize              <span style="color:#f92672">=</span> <span style="color:#ae81ff">1549795328</span> <span style="color:#f92672">(</span>1478.0MB<span style="color:#f92672">)</span>
   NewSize                  <span style="color:#f92672">=</span> <span style="color:#ae81ff">32505856</span> <span style="color:#f92672">(</span>31.0MB<span style="color:#f92672">)</span>
   MaxNewSize               <span style="color:#f92672">=</span> <span style="color:#ae81ff">516423680</span> <span style="color:#f92672">(</span>492.5MB<span style="color:#f92672">)</span>
   OldSize                  <span style="color:#f92672">=</span> <span style="color:#ae81ff">66060288</span> <span style="color:#f92672">(</span>63.0MB<span style="color:#f92672">)</span>
   NewRatio                 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
   SurvivorRatio            <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
   MetaspaceSize            <span style="color:#f92672">=</span> <span style="color:#ae81ff">21807104</span> <span style="color:#f92672">(</span>20.796875MB<span style="color:#f92672">)</span>
   CompressedClassSpaceSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">1073741824</span> <span style="color:#f92672">(</span>1024.0MB<span style="color:#f92672">)</span>
   MaxMetaspaceSize         <span style="color:#f92672">=</span> <span style="color:#ae81ff">17592186044415</span> MB
   G1HeapRegionSize         <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>0.0MB<span style="color:#f92672">)</span>

Heap Usage:
PS Young Generation
Eden Space:
   capacity <span style="color:#f92672">=</span> <span style="color:#ae81ff">23068672</span> <span style="color:#f92672">(</span>22.0MB<span style="color:#f92672">)</span>
   used     <span style="color:#f92672">=</span> <span style="color:#ae81ff">11772712</span> <span style="color:#f92672">(</span>11.227333068847656MB<span style="color:#f92672">)</span>
   free     <span style="color:#f92672">=</span> <span style="color:#ae81ff">11295960</span> <span style="color:#f92672">(</span>10.772666931152344MB<span style="color:#f92672">)</span>
   51.03333213112571% used
From Space:
   capacity <span style="color:#f92672">=</span> <span style="color:#ae81ff">11010048</span> <span style="color:#f92672">(</span>10.5MB<span style="color:#f92672">)</span>
   used     <span style="color:#f92672">=</span> <span style="color:#ae81ff">2035424</span> <span style="color:#f92672">(</span>1.941131591796875MB<span style="color:#f92672">)</span>
   free     <span style="color:#f92672">=</span> <span style="color:#ae81ff">8974624</span> <span style="color:#f92672">(</span>8.558868408203125MB<span style="color:#f92672">)</span>
   18.48696754092262% used
To Space:
   capacity <span style="color:#f92672">=</span> <span style="color:#ae81ff">11534336</span> <span style="color:#f92672">(</span>11.0MB<span style="color:#f92672">)</span>
   used     <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>0.0MB<span style="color:#f92672">)</span>
   free     <span style="color:#f92672">=</span> <span style="color:#ae81ff">11534336</span> <span style="color:#f92672">(</span>11.0MB<span style="color:#f92672">)</span>
   0.0% used
PS Old Generation
   capacity <span style="color:#f92672">=</span> <span style="color:#ae81ff">45088768</span> <span style="color:#f92672">(</span>43.0MB<span style="color:#f92672">)</span>
   used     <span style="color:#f92672">=</span> <span style="color:#ae81ff">13718432</span> <span style="color:#f92672">(</span>13.082916259765625MB<span style="color:#f92672">)</span>
   free     <span style="color:#f92672">=</span> <span style="color:#ae81ff">31370336</span> <span style="color:#f92672">(</span>29.917083740234375MB<span style="color:#f92672">)</span>
   30.42538665061773% used

<span style="color:#ae81ff">8999</span> interned Strings occupying <span style="color:#ae81ff">836656</span> bytes.
</code></pre></div><h2 id="å †å†…å­˜ä½¿ç”¨æœ€ä½³å®è·µ">å †å†…å­˜ä½¿ç”¨æœ€ä½³å®è·µ</h2>
<h3 id="å †åˆ†æ">å †åˆ†æ</h3>
<p>(1) æŸ¥çœ‹ç›´æ–¹å›¾</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">// jcmd å‘½ä»¤é»˜è®¤å°±ä¼šè¿›è¡Œ full GC
jcmd <span style="color:#ae81ff">6808</span> GC.class_histogram
jmap -histo <span style="color:#ae81ff">6808</span>
// å¦‚æœæŒ‡æ˜ live: é€‰é¡¹ï¼Œå°†ä¼šå¼ºåˆ¶è¿›è¡Œä¸€ä¸ª full GC
jmap -histo:live <span style="color:#ae81ff">6808</span>
</code></pre></div><pre><code> num     #instances         #bytes  class name
----------------------------------------------
   1:         12227        1303424  [C
   2:          1003         627856  [B
   3:          1917         461864  [I
   4:          3828         421768  java.lang.Class
   5:         11665         279960  java.lang.String
   6:          6065         194080  java.util.concurrent.ConcurrentHashMap$Node
   7:          2794         173144  [Ljava.lang.Object;
   8:          3072         122880  org.apache.lucene.index.FreqProxTermsWriter$PostingList
   9:          2760         110400  java.util.LinkedHashMap$Entry
  10:          1097         101144  [Ljava.util.HashMap$Node;
  11:          5440          87040  java.lang.Object
  12:          2680          85760  java.util.HashMap$Node
  13:           520          45760  java.lang.reflect.Method
  14:            44          44064  [Ljava.util.concurrent.ConcurrentHashMap$Node;
  15:           781          43736  java.util.LinkedHashMap
  16:            96          41088  [Lorg.apache.lucene.index.RawPostingList;
...
</code></pre><p>(2) Dump å †</p>
<pre><code>// æŒ‡æ˜ liveï¼Œå¼ºåˆ¶è¿›è¡Œ full GC
jmap -dump:live,file=/tmp/heap_dump.hprof 6808
// æˆ–è€…
jmap -F -dump:format=b,file=filename.hprof 20961
// æˆ–è€…ç®€å•ç‚¹
jmap -F -dump:file=filename.hprof 20961
</code></pre><blockquote>
<p>æ³¨æ„: è·¯å¾„ä¸€å®šè¦æ˜¾ç¤ºæŒ‡æ˜ï¼Œå¦åˆ™ä¸çŸ¥é“é»˜è®¤ä¿å­˜åˆ°å“ªé‡Œå»äº†</p>
</blockquote>
<p>é€šå¸¸æœ‰ä¸‰ç§å·¥å…·èƒ½å¤Ÿåˆ†æ <code>.hprof</code> æ–‡ä»¶ï¼š</p>
<ul>
<li><code>jhat</code></li>
<li><code>jvisualvm</code></li>
<li><code>mat</code></li>
</ul>
<p>(3) å†…å­˜æº¢å‡º</p>
<p>å†…å­˜æº¢å‡ºé€šå¸¸å‘ç”Ÿåœ¨:</p>
<ul>
<li>Native å†…å­˜ç”¨å…‰äº†</li>
<li>permgen(Java 7) æˆ–è€… metaspace(Java 8) å†…å­˜ç”¨å…‰äº†</li>
<li>Java å †å†…å­˜ç”¨å…‰äº†</li>
<li>JVM è¿›è¡Œ GC çš„æ—¶é—´å¤ªé•¿äº†</li>
</ul>
<h3 id="ä½¿ç”¨æ›´å°‘çš„å†…å­˜">ä½¿ç”¨æ›´å°‘çš„å†…å­˜</h3>
<p>(1) å‡å°‘å¯¹è±¡å¤§å°</p>
<p><img src="/images/posts/jvm-optimization/17-07-04-11-00-08_851_488.png" alt=""></p>
<p>(2) å»¶è¿Ÿåˆå§‹åŒ–
(3) ä¸å¯å˜å¯¹è±¡
(4) String Interning</p>
<h3 id="å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†">å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†</h3>
<h2 id="jit">JIT</h2>
<h3 id="1-ç¼–è¯‘è¿˜æ˜¯è§£é‡Š">(1) ç¼–è¯‘è¿˜æ˜¯è§£é‡Š</h3>
<p>Languages like C++ and Fortran are called <strong>compiled languages</strong> because their programs are delivered as binary (compiled) code: the program is written, and then a static compiler produces a binary. The assembly code in that binary is targeted to a particular CPU. Complementary CPUs can execute the same binary: for example, AMD and Intel CPUs share a basic, common set of assembly language instructions, and later versions of CPUs almost always can execute the same set of instructions as previous versions of that CPU.</p>
<p>Languages like PHP and Perl, on the other hand, <strong>are interpreted</strong>. The same program source code can be run on any CPU as long as the machine has the correct interpreter (that is, the program called <code>php</code> or <code>perl</code>). <strong>The interpreter translates each line of the program into binary code as that line is executed</strong>.</p>
<p>Java attempts to find a middle ground here. Java applications are compiledâ€”but instead of being compiled into a specific binary for a specific CPU, <strong>they are compiled into an idealized assembly language</strong>. This assembly language (know as Java bytecodes) is then run by the <code>java</code> binary (in the same way <strong>that an interpreted</strong> PHP script is run by the php binary). This gives Java the platform independence of an interpreted language. Because it is executing an idealized binary code, <strong>the java program is able to compile the code into the platform binary as the code executes</strong>. This compilation occurs as the program is executed: it happens â€œjust in time.</p>
<h3 id="2-hotspot-åå­—çš„å«ä¹‰">(2) HotSpot åå­—çš„å«ä¹‰</h3>
<p>In a typical program, <strong>only a small subset of code is executed frequently, and the performance of an application depends primarily on how fast those sections of code are executed</strong>. These critical sections are known as the hot spots of the application; <strong>the more the section of code is executed, the hotter that section is said to be</strong>.</p>
<p>Hence, when the JVM executes code, <strong>it does not begin compiling the code immediately</strong>. There are two basic reasons for this. First, if the code is going to be executed only once, then compiling it is essentially a wasted effort; it will be faster to interpret the Java bytecodes than to compile them and execute (only once) the compiled code.</p>
<p>the more times that the JVM executes a particular method or loop, the more information it has about that code. This allows the JVM to make a number of optimizations when it compiles the code.</p>
<h3 id="3-å¯„å­˜å™¨å’Œå†…å­˜">(3) å¯„å­˜å™¨å’Œå†…å­˜</h3>
<p><img src="/images/posts/jvm-optimization/17-08-01-11-07-53_611_306.png" alt=""></p>
<p>If the value of sum were to be retrieved from (and stored back to) main memory on every iteration of this loop, performance would be dismal. Instead, the compiler will <strong>load a register with the initial value of sum</strong>, perform the loop using that value in the register, and then (at an indeterminate point in time) store the final result from the register back to main memory.</p>
<p><strong>Register usage</strong> is a general optimization of the compiler, and when <strong>escape analysis</strong> is enabled (see the end of this chapter), register use is quite aggressive.</p>
<h3 id="4-é€‰æ‹©-java-ç¼–è¯‘å™¨">(4) é€‰æ‹© Java ç¼–è¯‘å™¨</h3>
<ul>
<li>A 32-bit client version (<code>-client</code>)</li>
<li>A 32-bit server version (<code>-server</code>)</li>
<li>A 64-bit server version (<code>-d64</code>)</li>
</ul>
<p>For the sake of compatibility, the argument specifying which compiler to use is not rigorously followed. If you have a 64-bit JVM and specify <code>-client</code>, the application will use the 64-bit server compiler anyway. If you have a 32 bit JVM and you specify <code>-d64</code>, you will get an error that the given instance does not support a 64-bit JVM.</p>
<p><strong>The client compiler begins compiling sooner than the server compiler does. code produced by the server compiler will be faster than that produced by the client compiler.</strong> couldnâ€™t the JVM start with the client compiler, and then use the server compiler as code gets hotter? That technique is known as <strong>tiered compilation</strong>. With tiered compilation, code is first compiled by the client compiler; as it becomes hot, it is recompiled by the server compiler.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Java 7 éœ€è¦æ‰“å¼€, Java 8 é»˜è®¤å¼€å¯</span>
-server -XX:+TieredCompilation
</code></pre></div><ul>
<li>For <strong>GUI programs</strong>, uses the client compiler by default. Performance is often all about perception: <strong>if the initial startup seems faster, and everything else seems fine, users will tend to view the program that has started faster as being faster overall</strong>.</li>
<li>For <strong>long-running applications</strong>, always choose the server compiler, preferably in conjunction with tiered compilation.</li>
</ul>
<p>æŸ¥çœ‹é»˜è®¤ç¼–è¯‘å™¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">java -version
</code></pre></div><h3 id="5-æ›´å¤šè€ƒè™‘å› ç´ ">(5) æ›´å¤šè€ƒè™‘å› ç´ </h3>
<p><strong>Code Cache</strong>: When the JVM compiles code, it holds the set of assembly-language instructions in the code cache. <strong>Code Cache æœ‰å›ºå®šå¤§å°</strong>, and once it has filled up, the JVM is not able to compile any additional code.</p>
<p><img src="/images/posts/jvm-optimization/17-08-01-11-39-30_662_364.png" alt=""></p>
<hr>
<p><strong>ç¼–è¯‘é˜ˆå€¼</strong>: The major factor involved here is <strong>å¤šé¢‘ç¹</strong> the code is executed; once it is executed a certain number of times, its compilation threshold is reached, and the compiler deems that it has enough information to compile the code.</p>
<p>Compilation is based on two counters in the JVM: <strong>æ–¹æ³•è°ƒç”¨æ¬¡æ•°</strong>, and <strong>æ–¹æ³•å†…å¾ªç¯çš„å®é™…æ¬¡æ•°</strong>. When the JVM executes a Java method, it checks the sum of those two counters and decides whether or not the method is eligible for compilation.  This kind of compilation has no official name but is often called <strong>standard compilation (æ ‡å‡†ç¼–è¯‘)</strong>.</p>
<p>But what if the method has a really long loopâ€”or one that never exits and provides all the logic of the program? In that case, the JVM needs to compile the loop without waiting for a method invocation. So every time the loop completes an execution, the branching counter is incremented and inspected. If the branching counter has exceeded its individual threshold, then the loop (and not the entire method) becomes eligible for compilation.</p>
<p>This kind of compilation is called <strong>on-stack replacement (OSR)</strong>, because even if the loop is compiled, that isnâ€™t sufficient: the JVM has to have the ability to start executing the compiled version of the loop while the loop is still running. When the code for the has finished compiling, the JVM replaces the code (on-stack), and the next iteration of the loop will execute the much-faster compiled version of the code (<strong>ä¸‹ä¸€æ¬¡å¾ªç¯å°±æ˜¯ç¼–è¯‘ç‰ˆæœ¬äº†</strong>).</p>
<p>Standard compilation is triggered by the value of the <code>-XX:CompileThreshold=N</code> flag. The default value of N for the client compiler is <code>1,500</code>; for the server compiler it is <code>10,000</code>.</p>
<hr>
<p><strong>æŸ¥çœ‹ç¼–è¯‘è¿‡ç¨‹</strong>: <code>-XX:+PrintCompilation</code>.</p>
<p><code>jstat</code> has two options to provide information about the compiler. The <code>-compiler</code> option supplies summary information about <strong>å¤šå°‘æ–¹æ³•è¢«ç¼–è¯‘äº†</strong> (here 5003 is the process ID of the program to be inspected):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jstat -compiler <span style="color:#ae81ff">5003</span>
</code></pre></div><p>lternately, you can use the <code>-printcompilation</code> option to get information about the <strong>æœ€åä¸€ä¸ªæ–¹æ³•</strong> that is compiled. In this example, <code>jstat</code> repeats the information for process ID 5003 every second (1,000 ms):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jstat -printcompilation <span style="color:#ae81ff">5003</span> <span style="color:#ae81ff">1000</span>
</code></pre></div><hr>
<p><strong>ç¼–è¯‘çº¿ç¨‹ä¸ªæ•°</strong>:</p>
<p><img src="/images/posts/jvm-optimization/17-08-01-14-38-57_660_434.png" alt=""></p>
<hr>
<p><strong>å†…è”</strong>:</p>
<p>One of the most important optimizations the compiler makes is to <strong>inline methods</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Point</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> x<span style="color:#f92672">,</span> y<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getX</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> x<span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setX</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> x <span style="color:#f92672">=</span> i<span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“ä½ å†™è¿™æ ·ä»£ç çš„æ—¶å€™:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Point p <span style="color:#f92672">=</span> getPoint<span style="color:#f92672">();</span>
p<span style="color:#f92672">.</span><span style="color:#a6e22e">setX</span><span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">getX</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> 2<span style="color:#f92672">);</span>
</code></pre></div><p>ç¼–è¯‘åçš„ä»£ç æ‰§è¡Œçš„å°†ä¼šæ˜¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Point p <span style="color:#f92672">=</span> getPoint<span style="color:#f92672">();</span>
p<span style="color:#f92672">.</span><span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span><span style="color:#a6e22e">x</span> <span style="color:#f92672">*</span> 2<span style="color:#f92672">;</span>
</code></pre></div><p>The basic decision about whether to inline a method depends on <strong>å¤šé¢‘ç¹</strong> and <strong>å¤§å°</strong>. The JVM determines if a method is hot (i.e., called frequently) based on an internal calculation; it is not directly subject to any tunable parameters. If a method is eligible for inlining because it is called frequently, then it will be inlined only if its <strong>å­—èŠ‚ç å¤§å°å°äº 325 å­—èŠ‚</strong> (or whatever is specified as the <code>-XX:MaxFreqInlineSize=N</code> flag). Otherwise, it is eligible for inlining only if it is small: <strong>å°äº 35 å­—èŠ‚</strong> (or whatever is specified as the <code>-XX:MaxInlineSize=N</code> flag)</p>
<hr>
<p><strong>é€ƒé€¸åˆ†æ</strong>:</p>
<p>The server compiler performs some very <strong>aggressive optimizations</strong> if escape analysis is enabled (<code>-XX:+DoEscapeAnalysis</code>, <strong>é»˜è®¤å¼€å¯</strong>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Factorial</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> BigInteger factorial<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> n<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Factorial</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> n<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> n<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> BigInteger <span style="color:#a6e22e">getFactorial</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>factorial <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            factorial <span style="color:#f92672">=</span> <span style="color:#f92672">...;</span>
        <span style="color:#66d9ef">return</span> factorial<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/posts/jvm-optimization/17-08-01-14-51-48_789_196.png" alt=""></p>
<p>The <code>factorial</code> object is referenced only inside that loop; no other code can ever access that object. Hence, the JVM is free to perform a number of optimizations on that object:</p>
<ul>
<li>It neednâ€™t get a synchronization lock when calling the <code>getFactorial()</code> method.</li>
<li>It neednâ€™t store the field <code>n</code> in memory; it can keep that value in a <code>register</code>. Similarly it can store the <code>factorial</code> object reference in a register.</li>
<li>In fact, it neednâ€™t allocate an actual <code>factorial</code> object at all; it can just keep track of the individual fields of the object.</li>
</ul>
<h3 id="6-deoptimization">(6) Deoptimization</h3>
<p>Deoptimization means that the compiler <strong>ä¸å¾—ä¸æ’¤é”€ä¸€äº›ä¼˜åŒ–</strong>; the effect is that the performance of the application will be reducedâ€”at least until the compiler can recompile the code in question. There are two cases of deoptimization: when code is <strong>â€œmade not entrant,â€</strong> and when code is <strong>â€œmade zombieâ€</strong>.</p>
<hr>
<p><strong>Not Entrant Code</strong>:</p>
<p>There are two things that cause code to be made not entrant. One is due to <strong>the way classes and interfaces work</strong>, and one is <strong>an implementation detail of tiered compilation</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">StockPriceHistory sph<span style="color:#f92672">;</span>
String log <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;log&#34;</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>log <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> log<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    sph <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StockPriceHistoryLogger<span style="color:#f92672">(...);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    sph <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StockPriceHistoryImpl<span style="color:#f92672">(...);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// Then the JSP makes calls to:
</span><span style="color:#75715e"></span>sph<span style="color:#f92672">.</span><span style="color:#a6e22e">getHighPrice</span><span style="color:#f92672">();</span>
sph<span style="color:#f92672">.</span><span style="color:#a6e22e">getStdDev</span><span style="color:#f92672">();</span>
<span style="color:#75715e">// and so on
</span></code></pre></div><p>If a bunch of calls are made to <code>http://localhost:8080/StockServlet</code> (that is, without the log parameter), the compiler will see that the actual type of the sph object is <code>StockPriceHistoryImpl</code>. It will then inline code and perform other optimizations based on that knowledge. Later, say a call is made to <code>http://localhost:8080/StockServlet?log=true</code>. Now the assumption the compiler made regarding the type of the sph object is false; the previous optimizations are no longer valid. This generates a deoptimization trap, and the previous optimizations are discarded. If a lot of additional calls are made with logging enabled, the JVM will quickly end up compiling that code and making new optimizations.</p>
<p>In tiered compilation, code is compiled by the client compiler, and then later compiled by the server compiler (and actually itâ€™s a little more complicated than that, as discussed in the next section). When the code compiled by the server compiler is ready, the JVM must replace the code compiled by the client compiler. It does this by <strong>å°†æ—§ä»£ç æ ‡è®°ä¸º Not Entrant</strong> and using the same mechanism to substitute the newly compiled (and more efficient) code.</p>
<hr>
<p><strong>Deoptimizing Zombie Code</strong>:</p>
<p>Recall that the compiled code is held in a fixedsize code cache; when zombie methods are identified, it means that the code in question can be removed from the code cache, making room for other classes to be compiled (or limiting the amount of memory the JVM will need to allocate later).</p>
<p>The possible downside here is that if the code for the class is made zombie and then later reloaded and heavily used again, the JVM will need to recompile and reoptimize the code.</p>
<h2 id="è¿œç¨‹-jvisualvm">è¿œç¨‹ <code>JVisualVM</code></h2>
<p>è¿œç¨‹æœºå™¨ä¸Šè¾“å…¥ <code>jstatd</code>:</p>
<pre><code>Could not create remote object
access denied (&quot;java.util.PropertyPermission&quot; &quot;java.rmi.server.ignoreSubClasses&quot; &quot;write&quot;)
java.security.AccessControlException: access denied (&quot;java.util.PropertyPermission&quot; &quot;java.rmi.server.ignoreSubClasses&quot; &quot;write&quot;)
	at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)
	at java.security.AccessController.checkPermission(AccessController.java:884)
	at java.lang.SecurityManager.checkPermission(SecurityManager.java:549)
	at java.lang.System.setProperty(System.java:792)
	at sun.tools.jstatd.Jstatd.main(Jstatd.java:139)
</code></pre><p>ä½ éœ€è¦åˆ›å»ºä¸€ä¸ªå®‰å…¨ç­–ç•¥æ–‡ä»¶: <code>jstatd.all.policy</code>ï¼Œé‡Œé¢å†™ä¸Šè¿™å¥è¯:</p>
<pre><code>grant codebase &quot;file:/opt/java/jdk1.7.0_21/lib/tools.jar&quot; { permission java.security.AllPermission; };
</code></pre><p>ç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡æ–°å¯åŠ¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jstatd -J -Djava.security.policy<span style="color:#f92672">=</span>/home/user/jstatd.all.policy
</code></pre></div><p>åœ¨æœ¬æœºæµ‹è¯•ï¼Œæ˜¯å¦èƒ½å¤Ÿ <code>telnet</code> åˆ° <code>jstatd</code> æœåŠ¡:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">telnet 10.108.112.218 <span style="color:#ae81ff">1099</span>
</code></pre></div><p>æœ‰äº›æ—¶å€™ï¼Œ<code>jstatd</code> å¯èƒ½ç»‘å®šçš„å¹¶ä¸æ˜¯æ­£ç¡®çš„ç½‘å¡:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-J-Djava.rmi.server.hostname<span style="color:#f92672">=</span>10.1.1.123
</code></pre></div><p>å¼ºåˆ¶ä½¿ç”¨ <code>IPV4</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-J-Djava.net.preferIPv4Stack<span style="color:#f92672">=</span>true
</code></pre></div><p>æŸ¥çœ‹ä¸€äº›æ—¥å¿—è¾“å‡º:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-J-Djava.rmi.server.logCalls<span style="color:#f92672">=</span>true
</code></pre></div><p>æœ€åçš„å‘½ä»¤:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jstatd -J-Djava.security.policy<span style="color:#f92672">=</span>./jstatd.all.policy -J-Djava.rmi.server.hostname<span style="color:#f92672">=</span>10.108.112.218 -J-Djava.rmi.server.logCalls<span style="color:#f92672">=</span>true
</code></pre></div><h2 id="dump-ä»€ä¹ˆ">DUMP ä»€ä¹ˆ</h2>
<p>ä»¥ä¸‹æ˜¯ <a href="https://github.com/alibaba/dubbo/blob/master/dubbo-container/dubbo-container-api/src/main/resources/META-INF/assembly/bin/dump.sh">dubbo - dump.sh</a> å¤‡ä»½çš„å†…å®¹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">DUMP_DATE<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>date +%Y%m%d%H%M%S<span style="color:#e6db74">`</span>
DATE_DIR<span style="color:#f92672">=</span>$DUMP_DIR/$DUMP_DATE

echo -e <span style="color:#e6db74">&#34;Dumping the </span>$SERVER_NAME<span style="color:#e6db74"> ...\c&#34;</span>
<span style="color:#66d9ef">for</span> PID in $PIDS ; <span style="color:#66d9ef">do</span>
	jstack $PID &gt; $DATE_DIR/jstack-$PID.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
	echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
	jinfo $PID &gt; $DATE_DIR/jinfo-$PID.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
	echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
	jstat -gcutil $PID &gt; $DATE_DIR/jstat-gcutil-$PID.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
	echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
	jstat -gccapacity $PID &gt; $DATE_DIR/jstat-gccapacity-$PID.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
	echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
	jmap $PID &gt; $DATE_DIR/jmap-$PID.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
	echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
	jmap -heap $PID &gt; $DATE_DIR/jmap-heap-$PID.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
	echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
	jmap -histo $PID &gt; $DATE_DIR/jmap-histo-$PID.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
	echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r /usr/sbin/lsof <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
	/usr/sbin/lsof -p $PID &gt; $DATE_DIR/lsof-$PID.dump
	echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
	<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">done</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r /bin/netstat <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
/bin/netstat -an &gt; $DATE_DIR/netstat.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r /usr/bin/iostat <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
/usr/bin/iostat &gt; $DATE_DIR/iostat.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r /usr/bin/mpstat <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
/usr/bin/mpstat &gt; $DATE_DIR/mpstat.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r /usr/bin/vmstat <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
/usr/bin/vmstat &gt; $DATE_DIR/vmstat.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r /usr/bin/free <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
/usr/bin/free -t &gt; $DATE_DIR/free.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r /usr/bin/sar <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
/usr/bin/sar &gt; $DATE_DIR/sar.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r /usr/bin/uptime <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
/usr/bin/uptime &gt; $DATE_DIR/uptime.dump 2&gt;&amp;<span style="color:#ae81ff">1</span>
echo -e <span style="color:#e6db74">&#34;.\c&#34;</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><p>ä»ä¸Šå¯çŸ¥ä¸€èˆ¬<strong>ç»Ÿè®¡</strong>çš„éƒ½æœ‰å¦‚ä¸‹å‡ é¡¹:</p>
<ul>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstack.html"><strong><code>jstack</code></strong></a>: çº¿ç¨‹ä¿¡æ¯</li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jinfo.html"><strong><code>jinfo</code></strong></a>: é…ç½®ä¿¡æ¯. The configuration information includes <strong>Java system properties</strong> and <strong>Java Virtual Machine (JVM) command-line flags</strong>.</li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html"><strong><code>jstat -gcutil</code></strong></a>: åƒåœ¾æ”¶é›†ç»Ÿè®¡</li>
<li><strong><code>jstat -gccapacity</code></strong>: Displays statistics about the <strong>capacities</strong> of the generations and their corresponding spaces.</li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jmap.html"><strong><code>jmap</code></strong></a>: Prints <strong>å…±äº«å¯¹è±¡å†…å­˜</strong> maps or <strong>å †å†…å­˜</strong> details for a process, core file, or remote debug server.</li>
<li><code>jmap -heap</code>: Prints a heap summary of the garbage collection used, the head configuration, and generation-wise heap usage. In addition, the number and size of interned Strings are printed.</li>
<li><code>jmap -histo</code>: Prints a <strong>histogram</strong> of the heap</li>
<li><code>lsof -p</code></li>
<li><code>netstat -an</code></li>
<li><code>iostat</code>: Report Central Processing Unit (CPU) statistics and input/output statistics for devices, partitions and network filesystems (NFS).</li>
<li><code>mpstat</code>: Report <strong>å¤„ç†å™¨</strong> related statistics.</li>
<li><code>vmstat</code>: vmstat (virtual memory statistics) is a computer system monitoring tool that collects and displays summary information about operating system memory, processes, interrupts, paging and block I/O.</li>
<li><code>free -t</code>: Display amount of <strong>å¯ç”¨/å·²ç”¨å†…å­˜</strong> in the system. <code>-t</code>: Display a line showing the column totals.</li>
<li><code>sar</code>: In computing, sar (<strong>System Activity Report</strong>) is a Unix System V-derived system monitor command used to report on various system loads, including <strong>CPU æ´»åŠ¨</strong>, memory/paging, <strong>è®¾å¤‡è´Ÿè½½</strong>, <strong>ç½‘ç»œ</strong>. Linux distributions provide <code>sar</code> through the <code>sysstat</code> package.</li>
<li><code>uptime</code>: uptime gives a one line display of the following information. The <strong>å½“å‰æ—¶é—´</strong>, <strong>å¤šé•¿æ—¶é—´</strong> the system has been running, <strong>å¤šå°‘ç”¨æˆ·</strong> are currently logged on, and the <strong>ç³»ç»Ÿå¹³å‡è´Ÿè½½</strong> averages for the past 1, 5, and 15 minutes.</li>
</ul>
<h2 id="å®é™…è¿ç”¨ä¸­å¦‚ä½•æ¸…æ™°æ˜äº†åœ°è§‚å¯Ÿ-jvm-çš„è¿è¡Œè¿‡ç¨‹">å®é™…è¿ç”¨ä¸­å¦‚ä½•æ¸…æ™°æ˜äº†åœ°è§‚å¯Ÿ JVM çš„è¿è¡Œè¿‡ç¨‹?</h2>
<ul>
<li>å›¾å½¢å·¥å…·: <code>JProfiler</code>, <code>JConsole</code>, <code>Java VisualVM</code></li>
<li>å‘½ä»¤: <code>jps</code>, <code>jstack</code>, <code>jmap</code>, <code>jhat</code>, <code>jstat</code></li>
</ul>
<h2 id="jvm-å¦‚ä½•è¿›é˜¶">JVM å¦‚ä½•è¿›é˜¶</h2>
<p>é—®:<code>JVM</code>å¦‚ä½•è¿›é˜¶ï¼Œç›®å‰å‘¨å¿—æ˜çš„ã€Šæ·±å…¥ç†è§£JVMã€‹ç¬¬2ç‰ˆçœ‹äº†ä¸¤éï¼Œèƒ½å¤Ÿæ ¹æ®ç›®å½•å£è¿°ä¹¦ä¸­å¤§éƒ¨åˆ†å†…å®¹ï¼Œè¿˜éœ€è¦äº†è§£å“ªäº›çŸ¥è¯†ï¼Ÿ</p>
<p>ç­”ï¼šå‘¨å¿—æ˜çš„ä¹¦åªèƒ½ç®—æ˜¯ <code>JVM</code> çš„å…¥é—¨ä¹¦ç±ã€‚æ¥ä¸‹æ¥ä½ åº”è¯¥å»è¯»ä¸€è¯»**ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹**ï¼Œå‘¨å¿—æ˜çš„ä¹¦å¾ˆå¤šå†…å®¹æ˜¯ä»é‡Œé¢æ¥çš„ï¼Œä½†æ˜¯è§„èŒƒæœ¬èº«æ¯”è¾ƒè¯¦ç»†ï¼Œæ³¨æ„è¯»è‹±æ–‡åŸç‰ˆã€‚å…¶æ¬¡å»è¯»ä¸€ä¸‹Oralceçš„æ–‡æ¡£ï¼š**ã€ŠHotspot Memory Management white paperã€‹, ã€ŠJava Platform, Standard Edition HotSpot Virtual Machine Garbage Collection Tuning Guideã€‹**ã€‚ç°åœ¨ä½ éœ€è¦è¿›ä¸€æ­¥ä¿®ç‚¼å…³äº**å†…å­˜ç®¡ç†**çš„éƒ¨åˆ†ï¼Œé˜…è¯»æ¯”å¦‚**ã€Šåƒåœ¾å›æ”¶ç®—æ³•ä¸å®ç°ã€‹**ï¼Œå¦‚æœè¿™æœ¬è¯»å®Œè¿˜ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆé˜…è¯»**ã€Šè‡ªåŠ¨å†…å­˜ç®¡ç†è‰ºæœ¯â€”â€”åƒåœ¾å›æ”¶ç®—æ³•æ‰‹å†Œã€‹**ã€‚åˆ°äº†è¿™ä¸€æ­¥ï¼Œç†è®ºä½ å·²ç»æŒæ¡å¾—å¾ˆå¥½äº†ï¼Œæ˜¯æ—¶å€™æŠŠ <code>Hotspot</code> æºç  download ä¸‹æ¥ç¼–è¯‘å¥½ä¹‹åæ–­ç‚¹è°ƒè¯•ç©ç©äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘è¦æ¨èä½ ä»Šå¹´é˜¿é‡Œäººåˆšå‡ºçš„**ã€Šæ­ç§˜Javaè™šæ‹Ÿæœºã€‹**ï¼Œä¸è¿‡é˜…è¯»è¿™æœ¬ä¹¦ä¹‹å‰ä½ è¦æ˜¯æ„¿æ„å…ˆè¯»å®Œ**ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹**æ•ˆæœæ›´å¥½ã€‚åˆ°äº†è¿™ä¸€æ­¥ï¼Œå‰©ä¸‹çš„ï¼Œè‡ªå·±æ¢ç´¢äº†ï¼Œæˆ‘ä¹Ÿåœ¨æ¢ç´¢ã€‚</p>
<hr>
<h2 id="jvm-åˆ†æ">JVM åˆ†æ</h2>
<h3 id="cpu-é«˜">CPU é«˜</h3>
<p>é—®: çº¿ä¸ŠCPUå¾ˆé«˜ã€å†…å­˜å ç”¨å¾ˆå°‘ï¼Œæœ‰èƒ½å¿«é€ŸæŸ¥æ‰¾åˆ°åŸå› çš„æ–¹æ³•å—ï¼Ÿ</p>
<p>ç­”: ç»™ä¸€ä¸ªä»£ç ï¼Œåœ¨ <code>Linux</code> ä¸‹ä¿å­˜æˆ <code>.sh</code> æ–‡ä»¶ç›´æ¥æ‰§è¡Œå³å¯ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>ts<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%s&#34;</span><span style="color:#66d9ef">)</span>
jvmPid<span style="color:#f92672">=</span>$1
defaultLines<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>
defaultTop<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>

threadStackLines<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>2<span style="color:#66d9ef">:-</span>$defaultLines<span style="color:#e6db74">}</span>
topThreads<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>3<span style="color:#66d9ef">:-</span>$defaultTop<span style="color:#e6db74">}</span>

jvmCapture<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>top -b -n1 | grep java <span style="color:#66d9ef">)</span>
threadsTopCapture<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>top -b -n1 -H | grep java <span style="color:#66d9ef">)</span>
jstackOutput<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>jstack $jvmPid <span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">)</span>
topOutput<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$threadsTopCapture<span style="color:#e6db74">&#34;</span> | head -n $topThreads | perl -pe <span style="color:#e6db74">&#39;s/\e\[?.*?[\@-~] ?//g&#39;</span> | awk <span style="color:#e6db74">&#39;{gsub(/^ +/,&#34;&#34;);print}&#39;</span> | awk <span style="color:#e6db74">&#39;{gsub(/ +|[+-]/,&#34; &#34;);print}&#39;</span> | cut -d <span style="color:#e6db74">&#34; &#34;</span> -f 1,9 <span style="color:#66d9ef">)</span><span style="color:#e6db74">\n &#34;</span><span style="color:#66d9ef">)</span>

echo <span style="color:#e6db74">&#34;*************************************************************************************************************&#34;</span>

uptime

echo <span style="color:#e6db74">&#34;Analyzing top </span>$topThreads<span style="color:#e6db74"> threads&#34;</span>

echo <span style="color:#e6db74">&#34;*************************************************************************************************************&#34;</span>

printf %s <span style="color:#e6db74">&#34;</span>$topOutput<span style="color:#e6db74">&#34;</span> | <span style="color:#66d9ef">while</span> IFS<span style="color:#f92672">=</span> read  line

<span style="color:#66d9ef">do</span>
   pid<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $line | cut -d <span style="color:#e6db74">&#34; &#34;</span> -f 1<span style="color:#66d9ef">)</span>
   hexapid<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#34;%x&#34;</span> $pid<span style="color:#66d9ef">)</span>
   cpu<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $line | cut -d <span style="color:#e6db74">&#34; &#34;</span> -f 2<span style="color:#66d9ef">)</span>
   echo -n $cpu<span style="color:#e6db74">&#34;% [</span>$pid<span style="color:#e6db74">] &#34;</span> 
   echo <span style="color:#e6db74">&#34;</span>$jstackOutput<span style="color:#e6db74">&#34;</span> | grep <span style="color:#e6db74">&#34;tid.*0x</span>$hexapid<span style="color:#e6db74"> &#34;</span> -A $threadStackLines | sed -n -e <span style="color:#e6db74">&#39;/0x&#39;</span>$hexapid<span style="color:#e6db74">&#39;/,/tid/ p&#39;</span> | head -n -1
   echo <span style="color:#e6db74">&#34;\n&#34;</span>
<span style="color:#66d9ef">done</span>

echo <span style="color:#e6db74">&#34;\n&#34;</span> 
</code></pre></div><p>ä»£ç çš„æ„æ€ï¼Œæ‰“å°å‡º <code>JVM</code> çš„æ‰€æœ‰çº¿ç¨‹ä»¥åŠæŒ‰ç…§ <code>CPU</code> å æ¯”æ’åºã€‚</p>
<hr>
<p>é—®: æ‚¨å¥½ï¼Œæƒ³é—®ä¸€ä¸ª JVM æ¯”è¾ƒåŸºç¡€çš„çŸ¥è¯†ï¼Œç°åœ¨çš„åƒåœ¾æ”¶é›†éƒ½æ˜¯åˆ†ä»£å›æ”¶ï¼Œé‚£ä¹ˆåœ¨å›æ”¶æ–°ç”Ÿä»£çš„æ—¶å€™æ˜¯è¦åŒæ—¶æ‰«æè€å¹´ä»£å—ï¼Ÿæ˜¯å…¨è¡¨è¿˜æ˜¯æœ‰ä¸€ç§ç­–ç•¥ï¼Œæ¯”å¦‚ G1 çš„ Remembered setï¼Œè¿™ä¸ª set åªæ˜¯è®°å½•äº†ä¸€ç§å¼•ç”¨å…³ç³»ï¼›é‚£å…¶å®ƒçš„åˆ†ä»£å›æ”¶ï¼Œæ¯”å¦‚ CMS å’Œ ParNew ç»„åˆæ—¶åªèƒ½æ˜¯å›æ”¶æ–°ç”Ÿä»£çš„æ—¶å€™æ‰«æè€å¹´ä»£å—ï¼Ÿé‚£è¿™æ ·æ•ˆç‡ä¸å°±æ˜¯é™ä½äº†ä¸å°‘å—ï¼Ÿ</p>
<p>ç­”ï¼šå¯¹äºè€å¹´ä»£æŒ‡å‘æ–°ç”Ÿä»£çš„å¼•ç”¨ï¼ŒJVMæä¾›äº†ä¸€ç§å« <code>card table</code> çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥æ¯æ¬¡<strong>å¹¶ä¸éœ€è¦å…¨é‡éå†è€å¹´ä»£</strong>ï¼Œåªéœ€è¦éå† <code>card table</code> å°±è¡Œäº†ã€‚</p>
<h3 id="cpu-å ç”¨">CPU å ç”¨</h3>
<p>ä½¿ç”¨å‘½ä»¤ <code>top -Hp pid</code> è¿™ä¸ªæ—¶å€™ <code>top</code> å‘½ä»¤æ˜¾ç¤ºçš„æœ€å·¦ä¾§çš„å°±æ˜¯è¿™ä¸ª java åº”ç”¨å†…éƒ¨çš„çº¿ç¨‹ idï¼Œä¸è¿‡æ˜¯ 10 è¿›åˆ¶çš„ï¼Œä½¿ç”¨ <code>printf &quot;%X\n&quot; pid</code> è½¬ä¸º 16 è¿›åˆ¶</p>
<h3 id="oom">OOM</h3>
<p>é—®: çº¿ä¸Šå®šä½å†…å­˜ JVM å†…å­˜æº¢å‡ºï¼Œé™¤äº†æ‰“å°å †æ ˆæ‹¿å‡ºæ¥åˆ†æï¼Œè¿˜æœ‰æ²¡æœ‰å…¶å®ƒçš„æ–¹å¼ï¼Ÿ</p>
<p>ç­”ï¼š<strong>å¯¼å‡º <code>JVM dump</code> æ–‡ä»¶</strong>ï¼Œåœ¨æœ¬åœ°ä½¿ç”¨ <code>Eclipse</code> æ’ä»¶ <strong><code>MAT</code></strong> åˆ†æï¼Œå¯è§†åŒ–çš„åˆ†ææœ€æ–¹ä¾¿ã€ç›´è§‚ã€æœ‰æ•ˆã€‚</p>
<h2 id="mat">MAT</h2>
<p><strong>1) The Dominator Tree</strong>:</p>
<p>The key to understanding your retained heap, is looking at the dominator tree. The dominator tree is a tree produced by the <strong>complex object graph</strong> in your system. The dominator tree allows you to identify the largest memory graphs. An Object X is said to dominate an Object Y if every path from the Root to Y must pass through X.</p>
<p><a href="https://javaeesupportpatterns.blogspot.jp/2013/03/openjpa-memory-leak-case-study.html">https://javaeesupportpatterns.blogspot.jp/2013/03/openjpa-memory-leak-case-study.html</a></p>
<h2 id="jvm-è¯Šæ–­ç¤ºä¾‹httpsplumbreublogmemory-leaksmemory-leaks-fallacies-and-misconceptions">JVM è¯Šæ–­<a href="https://plumbr.eu/blog/memory-leaks/memory-leaks-fallacies-and-misconceptions">ç¤ºä¾‹</a></h2>
<p><strong>1) å¥åº·çš„ <code>JVM</code></strong>:</p>
<p><img src="/images/posts/jvm-optimization/java-memory-usage-example.png" alt=""></p>
<p><strong>2) å¯åŠ¨å†…å­˜æš´æ¶¨</strong>:</p>
<p><img src="/images/posts/jvm-optimization/java-memory-usage-quick-growth-at-startup.png" alt=""></p>
<p><strong>3) æ¿€å¢</strong>:</p>
<p><img src="/images/posts/jvm-optimization/java-memory-usage-spike.png" alt=""></p>
<p><strong>4) å†…å­˜æ³„éœ²</strong></p>
<p><img src="/images/posts/jvm-optimization/java-memory-leak.png" alt=""></p>
<h2 id="jvisualvm">JVisualVM</h2>
<p>éœ€è¦å®‰è£…ä¸€ä¸ª <code>Visual GC</code> æ’ä»¶:</p>
<p><img src="/images/posts/jvm-optimization/2017_09_18_14_38_51.png" alt=""></p>
<p>æ‰èƒ½æ˜¾ç¤ºå…·ä½“çš„ <code>GC</code> è¿‡ç¨‹:</p>
<p><img src="/images/posts/jvm-optimization/2017_09_18_14_40_26.png" alt=""></p>
<h2 id="å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨-btrace-è¿›è¡Œè°ƒè¯•httpwwwimportnewcom23614html"><a href="http://www.importnew.com/23614.html">å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Btrace è¿›è¡Œè°ƒè¯•</a></h2>
<p>å¤§å¤šæ•°é—®é¢˜çš„è§£å†³æ–¹å¼éƒ½æ˜¯åœ¨<strong>æœ¬åœ°æ‰“æ–­ç‚¹</strong>è¿›è¡Œè°ƒè¯•ï¼Œæˆ–è€…åœ¨æµ‹è¯•ç¯å¢ƒåˆ©ç”¨<strong>è¾“å‡ºæ—¥å¿—</strong>è¿›è¡Œè°ƒè¯•ï¼Œè¿™ç§æ–¹å¼ç®€å•ç²—æš´ï¼Œä½†è¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œéœ€è¦å„ç§é‡æ–°å‘å¸ƒï¼Œé‡å¯åº”ç”¨ï¼Œè¿˜ä¸èƒ½ä¿è¯ä¸€æ¬¡å°±æ‰¾åˆ°é—®é¢˜çš„æ ¹æºã€‚</p>
<p><a href="https://github.com/btraceio/btrace"><code>BTrace</code></a> æ˜¯ sun å…¬å¸æ¨å‡ºçš„ä¸€æ¬¾ <code>Java</code> <strong>åŠ¨æ€ã€å®‰å…¨è¿½è¸ªï¼ˆç›‘æ§ï¼‰å·¥å…·</strong>ï¼Œå¯ä»¥åœ¨ä¸ç”¨é‡å¯çš„æƒ…å†µä¸‹ç›‘æ§ç³»ç»Ÿè¿è¡Œæƒ…å†µï¼Œæ–¹ä¾¿çš„è·å–ç¨‹åºè¿è¡Œæ—¶çš„æ•°æ®ä¿¡æ¯ï¼Œå¦‚<strong>æ–¹æ³•å‚æ•°ã€è¿”å›å€¼ã€å…¨å±€å˜é‡å’Œå †æ ˆä¿¡æ¯</strong>ç­‰ï¼Œå¹¶ä¸”åšåˆ°æœ€å°‘çš„ä¾µå…¥ï¼Œå ç”¨æœ€å°‘çš„ç³»ç»Ÿèµ„æºã€‚</p>
<p>ç”±äº Btrace ä¼šæŠŠ<strong>è„šæœ¬é€»è¾‘</strong>ç›´æ¥ä¾µå…¥åˆ°è¿è¡Œçš„ä»£ç ä¸­ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ä¸Šåšå¾ˆå¤šé™åˆ¶ï¼š</p>
<ol>
<li>ä¸èƒ½åˆ›å»ºå¯¹è±¡</li>
<li>ä¸èƒ½ä½¿ç”¨æ•°ç»„</li>
<li>ä¸èƒ½æŠ›å‡ºæˆ–æ•è·å¼‚å¸¸</li>
<li>ä¸èƒ½ä½¿ç”¨å¾ªç¯</li>
<li>ä¸èƒ½ä½¿ç”¨ <code>synchronized</code> å…³é”®å­—</li>
<li>å±æ€§å’Œæ–¹æ³•å¿…é¡»ä½¿ç”¨ <code>static</code> ä¿®é¥°</li>
</ol>
<p>æ ¹æ®å®˜æ–¹å£°æ˜ï¼Œä¸æ°å½“çš„ä½¿ç”¨ BTrace å¯èƒ½å¯¼è‡´ JVM å´©æºƒï¼Œå¦‚åœ¨ BTrace è„šæœ¬ä½¿ç”¨é”™è¯¯çš„ class æ–‡ä»¶ï¼Œæ‰€ä»¥åœ¨ä¸Šç”Ÿäº§ç¯å¢ƒä¹‹å‰ï¼Œ<strong>åŠ¡å¿…åœ¨æœ¬åœ°å……åˆ†çš„éªŒè¯è„šæœ¬çš„æ­£ç¡®æ€§</strong>ã€‚</p>
<h3 id="btrace-å¯ä»¥åšä»€ä¹ˆ">Btrace å¯ä»¥åšä»€ä¹ˆï¼Ÿ</h3>
<ul>
<li>æ¥å£æ€§èƒ½å˜æ…¢ï¼Œåˆ†ææ¯ä¸ªæ–¹æ³•çš„<strong>è€—æ—¶</strong>æƒ…å†µï¼›</li>
<li>å½“åœ¨ Map ä¸­æ’å…¥å¤§é‡æ•°æ®ï¼Œåˆ†æå…¶æ‰©å®¹æƒ…å†µï¼›</li>
<li>åˆ†æå“ªä¸ªæ–¹æ³•è°ƒç”¨äº† <code>System.gc()</code></li>
<li>æ‰§è¡ŒæŸä¸ªæ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œåˆ†æ<strong>è¿è¡Œæ—¶å‚æ•°</strong>ï¼›</li>
<li>&hellip;</li>
</ul>
<p>å‡è®¾æœåŠ¡å™¨ç«¯è¿è¡Œçš„æ˜¯å¦‚ä¸‹ä»£ç :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BtraceCase</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Random random <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> size<span style="color:#f92672">;</span>
 
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">new</span> BtraceCase<span style="color:#f92672">().</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
 
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            add<span style="color:#f92672">(</span>random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>10<span style="color:#f92672">),</span> random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>10<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
 
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> a<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> b<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>10<span style="color:#f92672">)</span> <span style="color:#f92672">*</span> 100<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>æˆ‘ä»¬æƒ³è¦å¯¹ <code>add</code> æ–¹æ³•çš„<strong>ä¼ å…¥å‚æ•°ã€è¿”å›å€¼å’Œæ‰§è¡Œè€—æ—¶</strong>è¿›è¡Œåˆ†æ:</p>
<p><img src="/images/posts/jvm-optimization/2184951-03afa420cfaa077d.png" alt=""></p>
<p>é€šè¿‡ <code>jps</code> è·å–æœåŠ¡å™¨ç«¯çš„è¿›ç¨‹ID: 8454ï¼Œæ‰§è¡Œå‘½ä»¤</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">btrace <span style="color:#ae81ff">8454</span> Debug.java
</code></pre></div><p>å®ç°å¯¹è¿è¡Œä»£ç çš„ç›‘æ§:</p>
<p><img src="/images/posts/jvm-optimization/2184951-9264da5116fd16eb.png" alt=""></p>
<p>å¯ä»¥å‘ç°ï¼Œ<code>Btrace</code> å¯ä»¥è·å–æ¯æ¬¡æ‰§è¡Œ <code>add</code> æ–¹æ³•æ—¶çš„æ•°æ®ï¼Œå½“ç„¶ <code>Btrace</code> èƒ½åšçš„è¿œè¿œä¸æ­¢è¿™äº›ï¼Œæ¯”å¦‚è·å–å½“å‰ <code>jvm</code> å †ä½¿ç”¨æƒ…å†µã€å½“å‰çº¿ç¨‹çš„æ‰§è¡Œæ ˆç­‰ç­‰ã€‚</p>
<h3 id="å‚æ•°è¯´æ˜">å‚æ•°è¯´æ˜</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// clazz: éœ€è¦ç›‘æ§çš„ç±»
</span><span style="color:#75715e">// method: éœ€è¦ç›‘æ§çš„æ–¹æ³•
</span><span style="color:#75715e">//       clazz å’Œ method å¯ä»¥ä½¿ç”¨æ­£åˆ™ã€æ¥å£ã€æ³¨è§£ç­‰æ¥æŒ‡å®š
</span><span style="color:#75715e">// location: æ‹¦æˆªä½ç½®
</span><span style="color:#75715e">//     Kind.ENTRY: è¿›å…¥æ–¹æ³•çš„æ—¶å€™ï¼Œè°ƒç”¨è„šæœ¬
</span><span style="color:#75715e">//     Kind.RETURN: æ‰§è¡Œå®Œçš„æ—¶å€™ï¼Œè°ƒç”¨è„šæœ¬
</span><span style="color:#75715e">//     åªæœ‰å®šä¹‰ä¸º RETURNï¼Œæ‰èƒ½è·å–æ–¹æ³•çš„è¿”å›ç»“æœ @Return å’Œ @Duration
</span><span style="color:#75715e"></span><span style="color:#a6e22e">@OnMethod</span><span style="color:#f92672">(</span>clazz<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;com.metty.rpc.common.BtraceCase&#34;</span><span style="color:#f92672">,</span>
          method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;add&#34;</span><span style="color:#f92672">,</span>
          location<span style="color:#f92672">=</span><span style="color:#a6e22e">@Location</span><span style="color:#f92672">(</span>Kind<span style="color:#f92672">.</span><span style="color:#a6e22e">RETURN</span><span style="color:#f92672">))</span>
</code></pre></div><h3 id="å¦‚ä½•ä½¿ç”¨-btrace-å®šä½é—®é¢˜">å¦‚ä½•ä½¿ç”¨ Btrace å®šä½é—®é¢˜</h3>
<ul>
<li><strong>æ‰¾å‡ºæ‰€æœ‰è€—æ—¶è¶…è¿‡ 1ms</strong> çš„è¿‡æ»¤å™¨ <code>Filter</code></li>
</ul>
<p><img src="/images/posts/jvm-optimization/2184951-5a84b16be8670045.png" alt=""></p>
<p>ç”±äº <code>@Dutation</code> è¿”å›çš„æ—¶é—´æ˜¯<strong>çº³ç§’</strong>çº§åˆ«ï¼Œéœ€è¦è¿›è¡Œè½¬æ¢ã€‚</p>
<ul>
<li>å“ªä¸ªæ–¹æ³•è°ƒç”¨äº† <strong><code>System.gc()</code></strong>ï¼Œè°ƒç”¨æ ˆå¦‚ä½•ï¼Ÿ</li>
</ul>
<p><img src="/images/posts/jvm-optimization/2184951-2ed3e5769fcd41a4.png" alt=""></p>
<ul>
<li><strong>ç»Ÿè®¡æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°</strong>ï¼Œä¸”æ¯éš” 1 åˆ†é’Ÿ<strong>æ‰“å°è°ƒç”¨æ¬¡æ•°</strong></li>
</ul>
<p><img src="/images/posts/jvm-optimization/2184951-0545a415522401b1.png" alt=""></p>
<p>Btrace çš„ <code>@OnTimer</code> æ³¨è§£å¯ä»¥å®ç°<strong>å®šæ—¶æ‰§è¡Œ</strong>è„šæœ¬ä¸­çš„ä¸€ä¸ªæ–¹æ³•</p>
<ul>
<li>æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œ<strong>æŸ¥çœ‹å¯¹è±¡çš„å®ä¾‹å±æ€§å€¼</strong></li>
</ul>
<p><img src="/images/posts/jvm-optimization/2184951-c246051ab7985760.png" alt=""></p>
<p>é€šè¿‡åå°„æœºåˆ¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¾—åˆ°å½“å‰å®ä¾‹çš„å±æ€§å€¼ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p><code>Btrace</code> èƒ½åšçš„äº‹æƒ…å¤ªå¤šï¼Œä½†ä½¿ç”¨ä¹‹å‰åˆ‡è®°æ£€æŸ¥è„šæœ¬çš„å¯è¡Œæ€§ï¼Œä¸€æ—¦ <code>Btrace</code> è„šæœ¬ä¾µå…¥åˆ°ç³»ç»Ÿä¸­ï¼Œ<strong>åªæœ‰é€šè¿‡é‡å¯æ‰èƒ½æ¢å¤</strong>ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://item.jd.com/11099999.html">ã€ŠJava ç¨‹åºæ€§èƒ½ä¼˜åŒ–ã€‹</a></li>
<li><a href="http://www.journaldev.com/2856/java-jvm-memory-model-memory-management-in-java">Java (JVM) Memory Model â€“ Memory Management in Java</a></li>
<li><a href="http://stackoverflow.com/questions/5024959/find-which-type-of-garbage-collector-is-running">find which type of garbage collector is running</a></li>
<li><a href="http://stackoverflow.com/questions/33206313/default-garbage-collector-for-java-8">Default garbage collector for Java 8</a></li>
<li><a href="http://www.oracle.com/technetwork/tutorials/tutorials-1876574.html">Getting Started with the G1 Garbage Collector</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html">cms</a></li>
<li><a href="https://plumbr.eu/blog/garbage-collection/minor-gc-vs-major-gc-vs-full-gc">Minor GC vs Major GC vs Full GC</a></li>
<li><a href="https://www.amazon.com/Java-Performance-Definitive-Guide-Getting/dp/1449358454/">ã€ŠJava Performance: The Definitive Guideã€‹</a></li>
<li><a href="https://item.jd.com/11908449.html">ã€Šå¤§è¯ Java æ€§èƒ½è°ƒä¼˜ã€‹</a></li>
<li><a href="https://item.jd.com/12087807.html">ã€Šæ·±å…¥ç†è§£ JVM &amp; G1 GCã€‹</a></li>
</ul></p>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#java-è™šæ‹Ÿæœºå†…å­˜æ¨¡å‹">Java è™šæ‹Ÿæœºå†…å­˜æ¨¡å‹</a>
      <ul>
        <li><a href="#stack">stack</a></li>
        <li><a href="#heap">HEAP</a></li>
        <li><a href="#method-area">method area</a></li>
      </ul>
    </li>
    <li><a href="#åŒºåŸŸæ¯”ä¾‹">åŒºåŸŸæ¯”ä¾‹</a></li>
    <li><a href="#åƒåœ¾å›æ”¶ç®—æ³•">åƒåœ¾å›æ”¶ç®—æ³•</a></li>
    <li><a href="#å®ç”¨-jvm-å‚æ•°">å®ç”¨ JVM å‚æ•°</a></li>
    <li><a href="#minor-gcmajor-gc-å’Œ-full-gc">Minor GCã€Major GC å’Œ Full GC</a></li>
    <li><a href="#jvm-çš„å·¥ä½œæ¨¡å¼">JVM çš„å·¥ä½œæ¨¡å¼</a></li>
    <li><a href="#heap-memory-æœ€ä½³å®è·µ">Heap Memory æœ€ä½³å®è·µ</a></li>
    <li><a href="#java-monitoring-å¸¸ç”¨å·¥å…·">Java Monitoring å¸¸ç”¨å·¥å…·</a>
      <ul>
        <li><a href="#jstack">jstack</a></li>
        <li><a href="#jinfo">jinfo</a></li>
        <li><a href="#jstat">jstat</a></li>
        <li><a href="#jmap-memory-map">jmap (Memory Map)</a></li>
      </ul>
    </li>
    <li><a href="#å †å†…å­˜ä½¿ç”¨æœ€ä½³å®è·µ">å †å†…å­˜ä½¿ç”¨æœ€ä½³å®è·µ</a>
      <ul>
        <li><a href="#å †åˆ†æ">å †åˆ†æ</a></li>
        <li><a href="#ä½¿ç”¨æ›´å°‘çš„å†…å­˜">ä½¿ç”¨æ›´å°‘çš„å†…å­˜</a></li>
        <li><a href="#å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†">å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†</a></li>
      </ul>
    </li>
    <li><a href="#jit">JIT</a>
      <ul>
        <li><a href="#1-ç¼–è¯‘è¿˜æ˜¯è§£é‡Š">(1) ç¼–è¯‘è¿˜æ˜¯è§£é‡Š</a></li>
        <li><a href="#2-hotspot-åå­—çš„å«ä¹‰">(2) HotSpot åå­—çš„å«ä¹‰</a></li>
        <li><a href="#3-å¯„å­˜å™¨å’Œå†…å­˜">(3) å¯„å­˜å™¨å’Œå†…å­˜</a></li>
        <li><a href="#4-é€‰æ‹©-java-ç¼–è¯‘å™¨">(4) é€‰æ‹© Java ç¼–è¯‘å™¨</a></li>
        <li><a href="#5-æ›´å¤šè€ƒè™‘å› ç´ ">(5) æ›´å¤šè€ƒè™‘å› ç´ </a></li>
        <li><a href="#6-deoptimization">(6) Deoptimization</a></li>
      </ul>
    </li>
    <li><a href="#è¿œç¨‹-jvisualvm">è¿œç¨‹ <code>JVisualVM</code></a></li>
    <li><a href="#dump-ä»€ä¹ˆ">DUMP ä»€ä¹ˆ</a></li>
    <li><a href="#å®é™…è¿ç”¨ä¸­å¦‚ä½•æ¸…æ™°æ˜äº†åœ°è§‚å¯Ÿ-jvm-çš„è¿è¡Œè¿‡ç¨‹">å®é™…è¿ç”¨ä¸­å¦‚ä½•æ¸…æ™°æ˜äº†åœ°è§‚å¯Ÿ JVM çš„è¿è¡Œè¿‡ç¨‹?</a></li>
    <li><a href="#jvm-å¦‚ä½•è¿›é˜¶">JVM å¦‚ä½•è¿›é˜¶</a></li>
    <li><a href="#jvm-åˆ†æ">JVM åˆ†æ</a>
      <ul>
        <li><a href="#cpu-é«˜">CPU é«˜</a></li>
        <li><a href="#cpu-å ç”¨">CPU å ç”¨</a></li>
        <li><a href="#oom">OOM</a></li>
      </ul>
    </li>
    <li><a href="#mat">MAT</a></li>
    <li><a href="#jvm-è¯Šæ–­ç¤ºä¾‹httpsplumbreublogmemory-leaksmemory-leaks-fallacies-and-misconceptions">JVM è¯Šæ–­<a href="https://plumbr.eu/blog/memory-leaks/memory-leaks-fallacies-and-misconceptions">ç¤ºä¾‹</a></a></li>
    <li><a href="#jvisualvm">JVisualVM</a></li>
    <li><a href="#å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨-btrace-è¿›è¡Œè°ƒè¯•httpwwwimportnewcom23614html"><a href="http://www.importnew.com/23614.html">å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Btrace è¿›è¡Œè°ƒè¯•</a></a>
      <ul>
        <li><a href="#btrace-å¯ä»¥åšä»€ä¹ˆ">Btrace å¯ä»¥åšä»€ä¹ˆï¼Ÿ</a></li>
        <li><a href="#å‚æ•°è¯´æ˜">å‚æ•°è¯´æ˜</a></li>
        <li><a href="#å¦‚ä½•ä½¿ç”¨-btrace-å®šä½é—®é¢˜">å¦‚ä½•ä½¿ç”¨ Btrace å®šä½é—®é¢˜</a></li>
        <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>



</html>












