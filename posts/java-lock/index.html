<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Java 并发 - 锁"><meta property="og:title" content="Java 并发 - 锁" />
<meta property="og:description" content="Java 世界中都有哪些锁？锁的分类？如何减少锁的竞争等问题。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/posts/java-lock/" />
<meta property="article:published_time" content="2017-05-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-05-13T00:00:00+00:00" />
<title>Java 并发 - 锁 | 赵坤的个人网站</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.edc993575be58655f3e49634e3ca6db09cc38ac9aa03ecdbe81d941636e35273.css" integrity="sha256-7cmTV1vlhlXz5JY048ptsJzDismqA&#43;zb6B2UFjbjUnM=">


<script defer src="/en.search.min.5942a9a6b190068591af0016584ff4d8e6a4c6c4921bba6d2acd8cba3e37ea3f.js" integrity="sha256-WUKpprGQBoWRrwAWWE/02OakxsSSG7ptKs2Muj436j8="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>赵坤的个人网站</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>









  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ 源码分析
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript 专栏
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      书籍
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      程序员面试题
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      云&#43;社区技术沙龙
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      实用工具
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        博客
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Java 并发 - 锁</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#线程安全的三种实现方式">线程安全的三种实现方式</a></li>
    <li><a href="#java-主内存与工作内存交互">Java 主内存与工作内存交互</a></li>
    <li><a href="#内置锁-synchronized">内置锁 Synchronized</a></li>
    <li><a href="#死锁">死锁</a></li>
    <li><a href="#减少锁的竞争">减少锁的竞争</a></li>
    <li><a href="#重入锁-reentrantlock">重入锁 ReentrantLock</a></li>
    <li><a href="#读写锁-readwritelock">读写锁 ReadWriteLock</a></li>
    <li><a href="#记录锁-record-locking">记录锁 Record Locking</a></li>
    <li><a href="#锁优化">锁优化</a>
      <ul>
        <li><a href="#自旋锁-spinlock">自旋锁 SpinLock</a></li>
        <li><a href="#锁消除-lock-elimination">锁消除 Lock Elimination</a></li>
        <li><a href="#锁粗化-lock-coarsening">锁粗化 Lock Coarsening</a></li>
        <li><a href="#轻量级锁-lightweight-locking">轻量级锁 Lightweight Locking</a></li>
        <li><a href="#偏向锁-biased-locking">偏向锁 Biased Locking</a></li>
        <li><a href="#锁升级-lock-escalation">锁升级 Lock Escalation</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  <h1>
    <a href="/posts/java-lock/">Java 并发 - 锁</a>
  </h1>
  

<div>

  <h5>May 13, 2017</h5>



  
  <div>
    
  </div>
  

  
  <div>
    
        <a href="/tags/java/">Java</a>
  </div>
  


</div>


  <p><p>Java 世界中都有哪些锁？锁的分类？如何减少锁的竞争等问题。</p>
<h2 id="线程安全的三种实现方式">线程安全的三种实现方式</h2>
<p>互斥同步 (Blocking Synchronization)，属于<strong>悲观并发策略</strong>:</p>
<p><img src="/images/posts/java-lock/synchronized_jvm.png" alt=""></p>
<p>非阻塞同步 (Non-Blocking Synchronization)，属于<strong>乐观并发策略</strong>:</p>
<p><img src="/images/posts/java-lock/cas_intel.png" alt=""></p>
<p>无同步 - 线程本地存储 (Thread Local Storage):</p>
<p><img src="/images/posts/java-lock/threadlocalmap-entry.png" alt=""></p>
<h2 id="java-主内存与工作内存交互">Java 主内存与工作内存交互</h2>
<p><img src="/images/posts/java-lock/main_memory_and_working_memory.png" alt=""></p>
<p>从主内存读取变量到工作内存:</p>
<p><img src="/images/posts/java-lock/read_from_main_memory.png" alt=""></p>
<p>将工作内存的变量写入到主内存:</p>
<p><img src="/images/posts/java-lock/write_to_main_memory.png" alt=""></p>
<h2 id="内置锁-synchronized">内置锁 Synchronized</h2>
<p>Java 提供了一种<strong>内置锁 (Intrinsic Lock)<strong>机制来支持原子性: <strong>同步代码块 (Synchronized Block)</strong>。每个 Java 对象都可以用做一个实现同步的锁，这些锁被称为</strong>内置锁 (Instrinsic Lock)</strong> 或<strong>监视器锁 (Monitor Lock)</strong>。Java 的内置锁相当于一种互斥体(或<strong>互斥锁</strong>)，这意味着最多只有一个线程能持有这种锁。但是，加锁的含义不仅仅局限于<strong>互斥行为</strong>，还包括<strong>内存可见性</strong>，为了确保所有线程都能看到共享变量的最新值，所有执行读操作或者写操作的线程都必须在同一个锁上同步。</p>
<p><strong><code>Java synchronized</code> 语句</strong> 是基于 <strong>monitorenter/monitorexit</strong> 机制来实现的。当你写下面这段代码的时候:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Sort</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> <span style="color:#f92672">[</span><span style="color:#f92672">]</span> array<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// synchronize this operation so that some other thread can&#39;t
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// manipulate the array while we are sorting it. This assumes that other
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// threads also synchronize their accesses to the array.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">synchronized</span><span style="color:#f92672">(</span>array<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// now sort elements in array
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>实际上 <strong>JVM</strong> 可能会生成下面的代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">.method <span style="color:#66d9ef">static</span> Sort([I)V
    aload_0
    monitorenter    ; lock object in local variable <span style="color:#ae81ff">0</span> 

    ; now sort elements in array

    aload_0
    monitorexit      ; finished with object in local variable <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">return</span>
.end method
</code></pre></div><p><code>monitorenter</code> 在对象的引用上获取了一个 <strong>exclusive lock (独占锁)</strong></p>
<hr>
<p><strong>内置锁 <code>synchronized</code> 是可重入</strong>的，某个线程试图获取一个已经由它自己持有的锁，那么这个请求就会成功。</p>
<h2 id="死锁">死锁</h2>
<p>在<strong>数据库系统的设计中考虑了监测死锁以及从死锁中恢复</strong>。在执行一个事务 (Transaction) 时可能需要获取多个锁，并一直持有这些锁直到事务提交。当数据库服务器监测到一组事务发生了死锁时 (<strong>通过在表示等待关系的有向图中搜索循环</strong>)，将 选择一个牺牲者并放弃这个事务。作为牺牲者的事务会释放它所持有的资源，从而让其它事务继续进行。应用程序可以重新执行被强行中止的事务，而这个事务现在也可以成功完成。</p>
<p>死锁的四大必要条件 (必须全部满足):</p>
<ol>
<li>互斥</li>
<li>持有并等待资源</li>
<li>不可抢占</li>
<li>循环等待</li>
</ol>
<p>如果所有的线程以固定的顺序来获得锁，那么在程序中就不会出现锁顺序死锁问题:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 不要这么做
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LeftRightDeadlock</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object left <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object right <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">leftRight</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>left<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>right<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                doSomething<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rightLeft</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>right<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>left<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                doSomethingElse<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>有时候，你并不能清除地知道是否在锁顺序上有足够的控制权来避免死锁的发生:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 动态的锁顺序
</span><span style="color:#75715e"></span><span style="color:#75715e">// Warning: deadlock-prone!
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transferMoney</span><span style="color:#f92672">(</span>Account fromAccount<span style="color:#f92672">,</span>
                          Account toAccount<span style="color:#f92672">,</span>
                          DollarAmount amount<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">throws</span> InsufficientFundsException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>fromAccount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>toAccount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fromAccount<span style="color:#f92672">.</span><span style="color:#a6e22e">getBalance</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InsufficientFundsException<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                fromAccount<span style="color:#f92672">.</span><span style="color:#a6e22e">debit</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                toAccount<span style="color:#f92672">.</span><span style="color:#a6e22e">credit</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在这里锁的顺序取决于参数顺序，而这些参数顺序又取决于外部输入，考虑下面代码就有可能发生死锁:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">A: transferMoney<span style="color:#f92672">(</span>myAccount<span style="color:#f92672">,</span> yourAccount<span style="color:#f92672">,</span> 10<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
B: transferMoney<span style="color:#f92672">(</span>yourAccount<span style="color:#f92672">,</span> myAccount<span style="color:#f92672">,</span> 20<span style="color:#f92672">)</span><span style="color:#f92672">;</span> 
</code></pre></div><p>使用 <code>System.identityHashCode</code> 来定义锁的顺序:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Object tieLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transferMoney</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Account fromAcct<span style="color:#f92672">,</span>
                          <span style="color:#66d9ef">final</span> Account toAcct<span style="color:#f92672">,</span>
                          <span style="color:#66d9ef">final</span> DollarAmount amount<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">throws</span> InsufficientFundsException <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Helper</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transfer</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InsufficientFundsException <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">.</span><span style="color:#a6e22e">getBalance</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InsufficientFundsException<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                fromAcct<span style="color:#f92672">.</span><span style="color:#a6e22e">debit</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                toAcct<span style="color:#f92672">.</span><span style="color:#a6e22e">credit</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// 如果 Account 中包含一个唯一的、不可变的，并且具备可比性的键值，例如
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 账号，那么制定锁的顺序就更加容易了。
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> fromHash <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">identityHashCode</span><span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">int</span> toHash <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">identityHashCode</span><span style="color:#f92672">(</span>toAcct<span style="color:#f92672">)</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fromHash <span style="color:#f92672">&lt;</span> toHash<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>toAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">new</span> Helper<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">transfer</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fromHash <span style="color:#f92672">&gt;</span> toHash<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>toAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">new</span> Helper<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">transfer</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 在极少数情况下，两个对象可能拥有相同的散列值，
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 此时可以通过某种任意的方法来决定锁的顺序，
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 而这有可能重新引入死锁。为了避免这种情况，可以使用
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// “加时赛”锁
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>tieLock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>toAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">new</span> Helper<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">transfer</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>某些获取多个锁的操作并不像 <code>LeftRightDeadLock</code> 或 <code>transferMoney</code> 中那么明显，这两个锁并不一定必须在同一个方法中被获取:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Taxi</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> Point location<span style="color:#f92672">,</span> destination<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Dispatcher dispatcher<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Taxi</span><span style="color:#f92672">(</span>Dispatcher dispatcher<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatcher</span> <span style="color:#f92672">=</span> dispatcher<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> Point <span style="color:#a6e22e">getLocation</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> location<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#75715e">// 先获取 Taxi 锁
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 再获取 Dispatcher 锁
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setLocation</span><span style="color:#f92672">(</span>Point location<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> location<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>location<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>destination<span style="color:#f92672">)</span><span style="color:#f92672">)</span>
            dispatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">notifyAvailable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dispatcher</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> taxis<span style="color:#f92672">;</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> availableTaxis<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Dispatcher</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        taxis <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        availableTaxis <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">notifyAvailable</span><span style="color:#f92672">(</span>Taxi taxi<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        availableTaxis<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>taxi<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#75715e">// 先获取 Dispatcher 锁
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 再获取每一个 Taxi 锁
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> Image <span style="color:#a6e22e">getImage</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Image image <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Image<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Taxi t <span style="color:#f92672">:</span> taxis<span style="color:#f92672">)</span>
            image<span style="color:#f92672">.</span><span style="color:#a6e22e">drawMarker</span><span style="color:#f92672">(</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocation</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> image<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>通过将上述代码修改为<strong>开放调用 (调用某个方法时不需要使用锁)</strong>，从而消除发生死锁的风险:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@ThreadSafe</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Taxi</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> Point location<span style="color:#f92672">,</span> destination<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Dispatcher dispatcher<span style="color:#f92672">;</span>
    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> Point <span style="color:#a6e22e">getLocation</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> location<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setLocation</span><span style="color:#f92672">(</span>Point location<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">boolean</span> reachedDestination<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> location<span style="color:#f92672">;</span>
            reachedDestination <span style="color:#f92672">=</span> location<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>destination<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>reachedDestination<span style="color:#f92672">)</span>
            dispatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">notifyAvailable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#a6e22e">@ThreadSafe</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dispatcher</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> taxis<span style="color:#f92672">;</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> availableTaxis<span style="color:#f92672">;</span>
    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">notifyAvailable</span><span style="color:#f92672">(</span>Taxi taxi<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            availableTaxis<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>taxi<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> Image <span style="color:#a6e22e">getImage</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> copy<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            copy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span>taxis<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        Image image <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Image<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Taxi t <span style="color:#f92672">:</span> copy<span style="color:#f92672">)</span>
            image<span style="color:#f92672">.</span><span style="color:#a6e22e">drawMarker</span><span style="color:#f92672">(</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocation</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> image<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在程序中应该尽量使用开放调用。与那些在持有锁时调用外部方法的程序相比，更易于对依赖于开放调用的程序进行死锁分析。通过使用<strong>定时锁</strong>能够有效地应对死锁问题，通过 <strong>Thread Dump</strong> 能够帮助你识别死锁的发生。</p>
<h2 id="减少锁的竞争">减少锁的竞争</h2>
<p>有三种方式可以降低锁的竞争程度:</p>
<ul>
<li>减少锁的持有时间</li>
<li>降低锁的请求频率</li>
<li>使用带有协调机制的独占锁，这些机制允许更高的并发性</li>
</ul>
<h2 id="重入锁-reentrantlock">重入锁 ReentrantLock</h2>
<p><code>ReentrantLock</code> 的 <code>tryLock</code> 方法为你提供了<strong>轮询锁与定时锁</strong>的锁获取模式，与无条件的锁获取模式相比，它具有更完善的错误恢复机制。方法 <code>lockInterruptibly</code> 方法能够在获得锁的同时<strong>保持对中断的响应</strong>。<code>ReentrantLock</code> 的构造函数中提供了两种<strong>公平性</strong>选择: 创建一个非公平的锁 (默认) 或者一个公平的锁。在公平的锁上，线程将按照它们发出请求的顺序来获得锁，但在非公平的锁上，则允许“插队”。在大多数情况下，非公平锁的性能要高于公平锁的性能。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReentrantLock</span> <span style="color:#66d9ef">implements</span> Lock<span style="color:#f92672">,</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Serializable</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/** Synchronizer providing all implementation mechanics */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Sync sync<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sync</span> <span style="color:#66d9ef">extends</span> AbstractQueuedSynchronizer <span style="color:#f92672">{</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReentrantLock</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> fair<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sync <span style="color:#f92672">=</span> fair <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> FairSync<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> NonfairSync<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryLock</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> sync<span style="color:#f92672">.</span><span style="color:#a6e22e">nonfairTryAcquire</span><span style="color:#f92672">(</span>1<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sync<span style="color:#f92672">.</span><span style="color:#a6e22e">release</span><span style="color:#f92672">(</span>1<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="读写锁-readwritelock">读写锁 ReadWriteLock</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReentrantReadWriteLock</span>
        <span style="color:#66d9ef">implements</span> ReadWriteLock<span style="color:#f92672">,</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Serializable</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReentrantReadWriteLock</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> fair<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sync <span style="color:#f92672">=</span> fair <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> FairSync<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> NonfairSync<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        readerLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ReadLock<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        writerLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WriteLock<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="记录锁-record-locking">记录锁 Record Locking</h2>
<p><strong>Record Locking</strong> 更好的叫法应该被称为: <strong>byte-range locking</strong>，目的是为了防止两个进程同时修改一个文件的某块区域。函数原型如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// 出错返回 -1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fcntl</span>(<span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> cmd, ... <span style="color:#75715e">/* struct flock *flockptr */</span> );
</code></pre></div><p>其中 <code>flock</code> 结构体定义如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> flock {
    <span style="color:#66d9ef">short</span> l_type; <span style="color:#75715e">/* F_RDLCK, F_WRLCK, or F_UNLCK */</span>
    <span style="color:#66d9ef">short</span> l_whence; <span style="color:#75715e">/*SEEK_SET, SEEK_CUR, or SEEK_END */</span>
    off_t l_start; <span style="color:#75715e">/*offset in bytes, relative to l_whence */</span>
    off_t l_len; <span style="color:#75715e">/*length, in bytes; 0 means lock to EOF */</span>
    pid_t l_pid; <span style="color:#75715e">/*returned with F_GETLK */</span>
};
</code></pre></div><ul>
<li><code>F_RDLCK</code>: 共享读锁</li>
<li><code>F_WRLCK</code>: 排斥写锁</li>
<li><code>F_UNLCK</code>: 取消某个区域的锁</li>
</ul>
<h2 id="锁优化">锁优化</h2>
<h3 id="自旋锁-spinlock">自旋锁 SpinLock</h3>
<p><strong>互斥同步对性能最大的影响就是阻塞的实现，挂起线程和恢复线程的操作都需要转入内核态中完成</strong>，这些操作给系统的并发性能带来了很大的压力。同时，虚拟机的开发团队也注意到在许多应用上，<strong>共享数据的锁定状态只会持续很短的一段时间</strong>，为了这段时间去挂起和恢复线程并不值得。为了能让线程稍微等一会，我们只需让线程执行一个忙循环 (自旋)，这项技术就是所谓的自旋锁。</p>
<p>现在我们假设<strong>硬件</strong>上有一种能够保证原子性的 <code>TestAndSet</code> 指令实现函数:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">TestAndSet</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>x){
    <span style="color:#66d9ef">register</span> <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>x;
    <span style="color:#f92672">*</span>x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">return</span> temp;
}
</code></pre></div><p><code>TestAndSet</code> 是一种常用的用于支持并发的原子操作指令。另外一种经常使用的指令是原子 <code>Exchange</code> 操作:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Exchange</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>a, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>b) {
    <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>a;
    <span style="color:#f92672">*</span>a <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>b;
    <span style="color:#f92672">*</span>b <span style="color:#f92672">=</span> temp;
}
</code></pre></div><p>这些所有的原子性操作中最重要的是 <code>CompareAndSwap (CAS)</code> 操作，它经常被用于 <a href="http://en.wikipedia.org/wiki/Lock-free_and_wait-free_algorithms">lock-free and wait-free algorithms</a> 算法中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">boolean <span style="color:#a6e22e">CAS</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>a, <span style="color:#66d9ef">int</span> old, <span style="color:#66d9ef">int</span> new) {
    <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>a;
    <span style="color:#66d9ef">if</span> (temp <span style="color:#f92672">=</span><span style="color:#f92672">=</span> old) {
        <span style="color:#f92672">*</span>a <span style="color:#f92672">=</span> new;
        <span style="color:#66d9ef">return</span> true;
    } <span style="color:#66d9ef">else</span> 
        <span style="color:#66d9ef">return</span> false;
}
</code></pre></div><p>使用 <code>CAS</code> 来实现 <code>temp++</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> x;
<span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>CAS(<span style="color:#f92672">&amp;</span>x, temp, temp<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) {
    temp <span style="color:#f92672">=</span> x;
}
</code></pre></div><p>使用 <code>CAS</code> 来实现更链表头插法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
    Node <span style="color:#f92672">*</span>q <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>head;
    p<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>next <span style="color:#f92672">=</span> q;
    <span style="color:#66d9ef">if</span> (CAS(head, q, p))
        <span style="color:#66d9ef">break</span>;
}
</code></pre></div><p>一般而言，<code>SpinLock</code> 是一种抽象的数据类型，其通常提供三种操作:</p>
<ul>
<li><code>InitLock</code></li>
<li><code>Lock</code></li>
<li><code>UnLock</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">Lock(mutex);
Si;
UnLock(mutex);
</code></pre></div><p>实现 <code>SpinLock</code> 的伪代码如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">int</span> SpinLock;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitLock</span>(SpinLock <span style="color:#f92672">*</span>L) {
    <span style="color:#f92672">*</span>L <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Lock</span>(SpinLock <span style="color:#f92672">*</span>L) {
    <span style="color:#66d9ef">while</span> (TestAndSet(L)) 
		;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">UnLock</span>(SpinLock <span style="color:#f92672">*</span>L) {
    <span style="color:#f92672">*</span>L <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>一种使用 <code>Exchange</code> 操作的可能实现:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">int</span> SpinLock;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitLock</span>(SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Lock</span> (SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#66d9ef">int</span> L <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">do</span> {
        Exchange(<span style="color:#f92672">&amp;</span>L, s);
    } <span style="color:#66d9ef">while</span> (L <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>);
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">UnLock</span> (SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>另外一种使用 <code>CompareAndSwap</code> 指令的实现:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">int</span> SpinLock;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitLock</span>(SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Lock</span> (SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#66d9ef">do</span> {
    } until (CompareAndSwap(s, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>));
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">UnLock</span> (SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>自旋锁最大的问题就是可能会占用比较高的 <strong>memory bus</strong> 带宽，另外它也不保证公平性，即无法保证先后进入临界区的两个进程 P 和 Q 按照 FIFO 顺序来服务。</p>
<h3 id="锁消除-lock-elimination">锁消除 Lock Elimination</h3>
<p>虚拟机 JIT 在运行时，对一些代码要求同步，但是被检测到不可能存在共享数据竞争的锁进行消除。主要判定依据来自于<strong>逃逸分析</strong>的数据支持。</p>
<h3 id="锁粗化-lock-coarsening">锁粗化 Lock Coarsening</h3>
<h3 id="轻量级锁-lightweight-locking">轻量级锁 Lightweight Locking</h3>
<h3 id="偏向锁-biased-locking">偏向锁 Biased Locking</h3>
<p>偏向锁的&quot;偏&rdquo;，是偏心的&quot;偏&rdquo;，它的意思就是<strong>这个锁会偏向于第一个获得它的线程</strong>，如果在接下来的执行过程中，该锁没有被其他的线程获取，则持有偏向锁的线程将永远不需要再进行同步。当有另外一个线程去尝试获取这个锁时，偏向模式就宣告结束。</p>
<p>JDK 1.6 默认开启 <code>-XX:+UseBiasedLocking</code>，使用 <code>-XX:-UseBiasedLocking</code> 来关闭。</p>
<p><strong>偏向锁转为轻量级锁</strong>的流程图:</p>
<p><img src="/images/posts/java-lock/217664272.jpg" alt=""></p>
<h3 id="锁升级-lock-escalation">锁升级 Lock Escalation</h3>
<p>所谓的锁升级（lock escalation），是数据库的一种作用机制，该机制普遍见于各大数据库产品。 为了节约内存的开销，其会<strong>将为数众多并占用大量资源的细粒度的锁转化为数量较少的且占用相对较少资源的粗粒度的锁</strong>，多数情况下主要指<strong>将为数众多的行锁升级为一个表锁</strong>。当然，DB2 支持很多粒度的锁，如**表空间（table space），表（table），行（row）以及索引（index）**等。MySQL 的 InnoDB 存储引擎支持事务，<strong>默认是行锁</strong>。得益于这些特性，数据库支持高并发。</p>
<p>锁升级与两种事情有关:</p>
<ul>
<li>事务的隔离级别</li>
<li>索引</li>
</ul>
<p>常用的索引有三类：<strong>主键、唯一索引、普通索引</strong>。主键 不由分说，自带最高效的索引属性；唯一索引 指的是该属性值重复率为0，一般可作为业务主键，例如学号；普通索引 与前者不同的是，属性值的重复率大于0，不能作为唯一指定条件，例如学生姓名。<strong>当“值重复率”低时，甚至接近主键或者唯一索引的效果，“普通索引”依然是行锁；当“值重复率”高时，MySQL 不会把这个“普通索引”当做索引，即造成了一个没有索引的 SQL，此时引发表锁</strong>。索引不是越多越好，索引存在一个和这个表相关的文件里，占用硬盘空间，宁缺勿滥，每个表都有主键（id），操作能使用主键尽量使用主键。同 JVM 自动优化 java 代码一样，MySQL 也具有自动优化 SQL 的功能。<strong>低效的索引将被忽略</strong>，这也就倒逼开发者使用正确且高效的索引。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://item.jd.com/10922250.html">《Java 并发编程实战》</a></li>
<li><a href="https://en.wikipedia.org/wiki/Deadlock">Deadlock</a></li>
<li><a href="https://www.amazon.com/Advanced-Programming-UNIX-Environment-3rd/dp/0321637739/">《Advanced Programming in the UNIX》</a></li>
<li><a href="https://item.jd.com/11252778.html">《深入理解 Java 虚拟机》</a></li>
<li><a href="https://cis.temple.edu/~giorgio/cis307/readings/spinsem.html">CIS 4307: Spinlocks and Semaphores</a></li>
<li><a href="https://cs.au.dk/~mis/dOvs/jvmspec/ref--44.html">enter synchronized region of code</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/data/library/techarticle/dm-1312db2lockescalation/">关于 DB2 锁升级 (lock escalation) 相关问题的探讨</a></li>
<li><a href="http://zhoupq.com/MySQL-%E9%81%BF%E5%85%8D%E8%A1%8C%E9%94%81%E5%8D%87%E7%BA%A7%E4%B8%BA%E8%A1%A8%E9%94%81%E2%80%94%E2%80%94%E4%BD%BF%E7%94%A8%E9%AB%98%E6%95%88%E7%9A%84%E7%B4%A2%E5%BC%95/">MySQL 避免行锁升级为表锁——使用高效的索引</a></li>
<li><a href="http://tech.meituan.com/innodb-lock.html">Innodb中的事务隔离级别和锁的关系</a></li>
<li><a href="http://www.imooc.com/article/17291?block_id=tuijian_wz">MySQL数据库事务各隔离级别加锁情况&ndash;read uncommitted篇</a></li>
<li><a href="http://www.artima.com/insidejvm/ed2/threadsynchP.html">Thread Synchronization</a></li>
</ul></p>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">

</div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#线程安全的三种实现方式">线程安全的三种实现方式</a></li>
    <li><a href="#java-主内存与工作内存交互">Java 主内存与工作内存交互</a></li>
    <li><a href="#内置锁-synchronized">内置锁 Synchronized</a></li>
    <li><a href="#死锁">死锁</a></li>
    <li><a href="#减少锁的竞争">减少锁的竞争</a></li>
    <li><a href="#重入锁-reentrantlock">重入锁 ReentrantLock</a></li>
    <li><a href="#读写锁-readwritelock">读写锁 ReadWriteLock</a></li>
    <li><a href="#记录锁-record-locking">记录锁 Record Locking</a></li>
    <li><a href="#锁优化">锁优化</a>
      <ul>
        <li><a href="#自旋锁-spinlock">自旋锁 SpinLock</a></li>
        <li><a href="#锁消除-lock-elimination">锁消除 Lock Elimination</a></li>
        <li><a href="#锁粗化-lock-coarsening">锁粗化 Lock Coarsening</a></li>
        <li><a href="#轻量级锁-lightweight-locking">轻量级锁 Lightweight Locking</a></li>
        <li><a href="#偏向锁-biased-locking">偏向锁 Biased Locking</a></li>
        <li><a href="#锁升级-lock-escalation">锁升级 Lock Escalation</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>



</html>












