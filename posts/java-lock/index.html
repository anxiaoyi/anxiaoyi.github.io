<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Java å¹¶å‘ - é”"><meta property="og:title" content="Java å¹¶å‘ - é”" />
<meta property="og:description" content="Java ä¸–ç•Œä¸­éƒ½æœ‰å“ªäº›é”ï¼Ÿé”çš„åˆ†ç±»ï¼Ÿå¦‚ä½•å‡å°‘é”çš„ç«äº‰ç­‰é—®é¢˜ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/posts/java-lock/" />
<meta property="article:published_time" content="2017-05-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-05-13T00:00:00+00:00" />
<title>Java å¹¶å‘ - é” | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.7ebac727e739c3b4aee6328926e3b77ac1ddd5e9035221b7ec206fda1a413a4d.css" integrity="sha256-frrHJ&#43;c5w7Su5jKJJuO3esHd1ekDUiG37CBv2hpBOk0=">


<script defer src="/en.search.min.04a53f033623e53a68db459286b910a62c5fa8dde58d8d74933c43cc61995fe2.js" integrity="sha256-BKU/AzYj5Tpo20WShrkQpixfqN3ljY10kzxDzGGZX&#43;I="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Java å¹¶å‘ - é”</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#çº¿ç¨‹å®‰å…¨çš„ä¸‰ç§å®ç°æ–¹å¼">çº¿ç¨‹å®‰å…¨çš„ä¸‰ç§å®ç°æ–¹å¼</a>
      <ul>
        <li><a href="#äº’æ–¥åŒæ­¥">äº’æ–¥åŒæ­¥</a></li>
        <li><a href="#éé˜»å¡åŒæ­¥">éé˜»å¡åŒæ­¥</a></li>
        <li><a href="#æ— åŒæ­¥">æ— åŒæ­¥</a></li>
      </ul>
    </li>
    <li><a href="#java-ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜äº¤äº’">Java ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜äº¤äº’</a></li>
    <li><a href="#å†…ç½®é”-synchronized">å†…ç½®é” Synchronized</a></li>
    <li><a href="#æ­»é”">æ­»é”</a></li>
    <li><a href="#å‡å°‘é”çš„ç«äº‰">å‡å°‘é”çš„ç«äº‰</a></li>
    <li><a href="#é‡å…¥é”-reentrantlock">é‡å…¥é” ReentrantLock</a></li>
    <li><a href="#è¯»å†™é”-readwritelock">è¯»å†™é” ReadWriteLock</a></li>
    <li><a href="#è®°å½•é”-record-locking">è®°å½•é” Record Locking</a></li>
    <li><a href="#é”ä¼˜åŒ–">é”ä¼˜åŒ–</a>
      <ul>
        <li><a href="#è‡ªæ—‹é”-spinlock">è‡ªæ—‹é” SpinLock</a></li>
        <li><a href="#é”æ¶ˆé™¤-lock-elimination">é”æ¶ˆé™¤ Lock Elimination</a></li>
        <li><a href="#é”ç²—åŒ–-lock-coarsening">é”ç²—åŒ– Lock Coarsening</a></li>
        <li><a href="#è½»é‡çº§é”-lightweight-locking">è½»é‡çº§é” Lightweight Locking</a></li>
        <li><a href="#åå‘é”-biased-locking">åå‘é” Biased Locking</a></li>
        <li><a href="#é”å‡çº§-lock-escalation">é”å‡çº§ Lock Escalation</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  <h1>
    <a href="/posts/java-lock/">Java å¹¶å‘ - é”</a>
  </h1>
  

<div>

  <h5>May 13, 2017</h5>



  
  <div>
    
  </div>
  

  
  <div>
    
        <a href="/tags/java/">Java</a>
  </div>
  


</div>


  <p><p>Java ä¸–ç•Œä¸­éƒ½æœ‰å“ªäº›é”ï¼Ÿé”çš„åˆ†ç±»ï¼Ÿå¦‚ä½•å‡å°‘é”çš„ç«äº‰ç­‰é—®é¢˜ã€‚</p>
<h2 id="çº¿ç¨‹å®‰å…¨çš„ä¸‰ç§å®ç°æ–¹å¼">çº¿ç¨‹å®‰å…¨çš„ä¸‰ç§å®ç°æ–¹å¼</h2>
<h3 id="äº’æ–¥åŒæ­¥">äº’æ–¥åŒæ­¥</h3>
<p>äº’æ–¥åŒæ­¥ (Blocking Synchronization)ï¼Œå±äº<strong>æ‚²è§‚å¹¶å‘ç­–ç•¥</strong>:</p>
<p><img src="/images/posts/java-lock/synchronized_jvm.png" alt=""></p>
<h3 id="éé˜»å¡åŒæ­¥">éé˜»å¡åŒæ­¥</h3>
<p>éé˜»å¡åŒæ­¥ (Non-Blocking Synchronization)ï¼Œå±äº<strong>ä¹è§‚å¹¶å‘ç­–ç•¥</strong>:</p>
<p><img src="/images/posts/java-lock/cas_intel.png" alt=""></p>
<h3 id="æ— åŒæ­¥">æ— åŒæ­¥</h3>
<p>æ— åŒæ­¥ - çº¿ç¨‹æœ¬åœ°å­˜å‚¨ (Thread Local Storage):</p>
<p><img src="/images/posts/java-lock/threadlocalmap-entry.png" alt=""></p>
<h2 id="java-ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜äº¤äº’">Java ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜äº¤äº’</h2>
<p><img src="/images/posts/java-lock/main_memory_and_working_memory.png" alt=""></p>
<p>ä»ä¸»å†…å­˜è¯»å–å˜é‡åˆ°å·¥ä½œå†…å­˜:</p>
<p><img src="/images/posts/java-lock/read_from_main_memory.png" alt=""></p>
<p>å°†å·¥ä½œå†…å­˜çš„å˜é‡å†™å…¥åˆ°ä¸»å†…å­˜:</p>
<p><img src="/images/posts/java-lock/write_to_main_memory.png" alt=""></p>
<h2 id="å†…ç½®é”-synchronized">å†…ç½®é” Synchronized</h2>
<p>Java æä¾›äº†ä¸€ç§<strong>å†…ç½®é” (Intrinsic Lock)<strong>æœºåˆ¶æ¥æ”¯æŒåŸå­æ€§: <strong>åŒæ­¥ä»£ç å— (Synchronized Block)</strong>ã€‚æ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥ç”¨åšä¸€ä¸ªå®ç°åŒæ­¥çš„é”ï¼Œè¿™äº›é”è¢«ç§°ä¸º</strong>å†…ç½®é” (Instrinsic Lock)</strong> æˆ–<strong>ç›‘è§†å™¨é” (Monitor Lock)</strong>ã€‚Java çš„å†…ç½®é”ç›¸å½“äºä¸€ç§äº’æ–¥ä½“(æˆ–<strong>äº’æ–¥é”</strong>)ï¼Œè¿™æ„å‘³ç€æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰è¿™ç§é”ã€‚ä½†æ˜¯ï¼ŒåŠ é”çš„å«ä¹‰ä¸ä»…ä»…å±€é™äº<strong>äº’æ–¥è¡Œä¸º</strong>ï¼Œè¿˜åŒ…æ‹¬<strong>å†…å­˜å¯è§æ€§</strong>ï¼Œä¸ºäº†ç¡®ä¿æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½çœ‹åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼ï¼Œæ‰€æœ‰æ‰§è¡Œè¯»æ“ä½œæˆ–è€…å†™æ“ä½œçš„çº¿ç¨‹éƒ½å¿…é¡»åœ¨åŒä¸€ä¸ªé”ä¸ŠåŒæ­¥ã€‚</p>
<p><strong><code>Java synchronized</code> è¯­å¥</strong> æ˜¯åŸºäº <strong>monitorenter/monitorexit</strong> æœºåˆ¶æ¥å®ç°çš„ã€‚å½“ä½ å†™ä¸‹é¢è¿™æ®µä»£ç çš„æ—¶å€™:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Sort</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> <span style="color:#f92672">[]</span> array<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// synchronize this operation so that some other thread can&#39;t
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// manipulate the array while we are sorting it. This assumes that other
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// threads also synchronize their accesses to the array.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">synchronized</span><span style="color:#f92672">(</span>array<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// now sort elements in array
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å®é™…ä¸Š <strong>JVM</strong> å¯èƒ½ä¼šç”Ÿæˆä¸‹é¢çš„ä»£ç :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">.method <span style="color:#66d9ef">static</span> Sort([I)V
    aload_0
    monitorenter    ; lock object in local variable <span style="color:#ae81ff">0</span> 

    ; now sort elements in array

    aload_0
    monitorexit      ; finished with object in local variable <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">return</span>
.end method
</code></pre></div><p><code>monitorenter</code> åœ¨å¯¹è±¡çš„å¼•ç”¨ä¸Šè·å–äº†ä¸€ä¸ª <strong>exclusive lock (ç‹¬å é”)</strong></p>
<hr>
<p><strong>å†…ç½®é” <code>synchronized</code> æ˜¯å¯é‡å…¥</strong>çš„ï¼ŒæŸä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå·²ç»ç”±å®ƒè‡ªå·±æŒæœ‰çš„é”ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯·æ±‚å°±ä¼šæˆåŠŸã€‚</p>
<h2 id="æ­»é”">æ­»é”</h2>
<p>åœ¨<strong>æ•°æ®åº“ç³»ç»Ÿçš„è®¾è®¡ä¸­è€ƒè™‘äº†ç›‘æµ‹æ­»é”ä»¥åŠä»æ­»é”ä¸­æ¢å¤</strong>ã€‚åœ¨æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ (Transaction) æ—¶å¯èƒ½éœ€è¦è·å–å¤šä¸ªé”ï¼Œå¹¶ä¸€ç›´æŒæœ‰è¿™äº›é”ç›´åˆ°äº‹åŠ¡æäº¤ã€‚å½“æ•°æ®åº“æœåŠ¡å™¨ç›‘æµ‹åˆ°ä¸€ç»„äº‹åŠ¡å‘ç”Ÿäº†æ­»é”æ—¶ (<strong>é€šè¿‡åœ¨è¡¨ç¤ºç­‰å¾…å…³ç³»çš„æœ‰å‘å›¾ä¸­æœç´¢å¾ªç¯</strong>)ï¼Œå°† é€‰æ‹©ä¸€ä¸ªç‰ºç‰²è€…å¹¶æ”¾å¼ƒè¿™ä¸ªäº‹åŠ¡ã€‚ä½œä¸ºç‰ºç‰²è€…çš„äº‹åŠ¡ä¼šé‡Šæ”¾å®ƒæ‰€æŒæœ‰çš„èµ„æºï¼Œä»è€Œè®©å…¶å®ƒäº‹åŠ¡ç»§ç»­è¿›è¡Œã€‚åº”ç”¨ç¨‹åºå¯ä»¥é‡æ–°æ‰§è¡Œè¢«å¼ºè¡Œä¸­æ­¢çš„äº‹åŠ¡ï¼Œè€Œè¿™ä¸ªäº‹åŠ¡ç°åœ¨ä¹Ÿå¯ä»¥æˆåŠŸå®Œæˆã€‚</p>
<p>æ­»é”çš„å››å¤§å¿…è¦æ¡ä»¶ (å¿…é¡»å…¨éƒ¨æ»¡è¶³):</p>
<ol>
<li>äº’æ–¥</li>
<li>æŒæœ‰å¹¶ç­‰å¾…èµ„æº</li>
<li>ä¸å¯æŠ¢å </li>
<li>å¾ªç¯ç­‰å¾…</li>
</ol>
<p>å¦‚æœæ‰€æœ‰çš„çº¿ç¨‹ä»¥å›ºå®šçš„é¡ºåºæ¥è·å¾—é”ï¼Œé‚£ä¹ˆåœ¨ç¨‹åºä¸­å°±ä¸ä¼šå‡ºç°é”é¡ºåºæ­»é”é—®é¢˜:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// ä¸è¦è¿™ä¹ˆåš
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LeftRightDeadlock</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object left <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object right <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">();</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">leftRight</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>left<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>right<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                doSomething<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rightLeft</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>right<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>left<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                doSomethingElse<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>æœ‰æ—¶å€™ï¼Œä½ å¹¶ä¸èƒ½æ¸…é™¤åœ°çŸ¥é“æ˜¯å¦åœ¨é”é¡ºåºä¸Šæœ‰è¶³å¤Ÿçš„æ§åˆ¶æƒæ¥é¿å…æ­»é”çš„å‘ç”Ÿ:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// åŠ¨æ€çš„é”é¡ºåº
</span><span style="color:#75715e">// Warning: deadlock-prone!
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transferMoney</span><span style="color:#f92672">(</span>Account fromAccount<span style="color:#f92672">,</span>
                          Account toAccount<span style="color:#f92672">,</span>
                          DollarAmount amount<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">throws</span> InsufficientFundsException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>fromAccount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>toAccount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fromAccount<span style="color:#f92672">.</span><span style="color:#a6e22e">getBalance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InsufficientFundsException<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                fromAccount<span style="color:#f92672">.</span><span style="color:#a6e22e">debit</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">);</span>
                toAccount<span style="color:#f92672">.</span><span style="color:#a6e22e">credit</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨è¿™é‡Œé”çš„é¡ºåºå–å†³äºå‚æ•°é¡ºåºï¼Œè€Œè¿™äº›å‚æ•°é¡ºåºåˆå–å†³äºå¤–éƒ¨è¾“å…¥ï¼Œè€ƒè™‘ä¸‹é¢ä»£ç å°±æœ‰å¯èƒ½å‘ç”Ÿæ­»é”:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">A: transferMoney<span style="color:#f92672">(</span>myAccount<span style="color:#f92672">,</span> yourAccount<span style="color:#f92672">,</span> 10<span style="color:#f92672">);</span>
B: transferMoney<span style="color:#f92672">(</span>yourAccount<span style="color:#f92672">,</span> myAccount<span style="color:#f92672">,</span> 20<span style="color:#f92672">);</span> 
</code></pre></div><p>ä½¿ç”¨ <code>System.identityHashCode</code> æ¥å®šä¹‰é”çš„é¡ºåº:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Object tieLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">();</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transferMoney</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Account fromAcct<span style="color:#f92672">,</span>
                          <span style="color:#66d9ef">final</span> Account toAcct<span style="color:#f92672">,</span>
                          <span style="color:#66d9ef">final</span> DollarAmount amount<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">throws</span> InsufficientFundsException <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Helper</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transfer</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InsufficientFundsException <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">.</span><span style="color:#a6e22e">getBalance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InsufficientFundsException<span style="color:#f92672">();</span>
            <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                fromAcct<span style="color:#f92672">.</span><span style="color:#a6e22e">debit</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">);</span>
                toAcct<span style="color:#f92672">.</span><span style="color:#a6e22e">credit</span><span style="color:#f92672">(</span>amount<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// å¦‚æœ Account ä¸­åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„ã€ä¸å¯å˜çš„ï¼Œå¹¶ä¸”å…·å¤‡å¯æ¯”æ€§çš„é”®å€¼ï¼Œä¾‹å¦‚
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è´¦å·ï¼Œé‚£ä¹ˆåˆ¶å®šé”çš„é¡ºåºå°±æ›´åŠ å®¹æ˜“äº†ã€‚
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> fromHash <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">identityHashCode</span><span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">int</span> toHash <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">identityHashCode</span><span style="color:#f92672">(</span>toAcct<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fromHash <span style="color:#f92672">&lt;</span> toHash<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>toAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">new</span> Helper<span style="color:#f92672">().</span><span style="color:#a6e22e">transfer</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fromHash <span style="color:#f92672">&gt;</span> toHash<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>toAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">new</span> Helper<span style="color:#f92672">().</span><span style="color:#a6e22e">transfer</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªå¯¹è±¡å¯èƒ½æ‹¥æœ‰ç›¸åŒçš„æ•£åˆ—å€¼ï¼Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ­¤æ—¶å¯ä»¥é€šè¿‡æŸç§ä»»æ„çš„æ–¹æ³•æ¥å†³å®šé”çš„é¡ºåºï¼Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è€Œè¿™æœ‰å¯èƒ½é‡æ–°å¼•å…¥æ­»é”ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// â€œåŠ æ—¶èµ›â€é”
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>tieLock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>fromAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>toAcct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">new</span> Helper<span style="color:#f92672">().</span><span style="color:#a6e22e">transfer</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>æŸäº›è·å–å¤šä¸ªé”çš„æ“ä½œå¹¶ä¸åƒ <code>LeftRightDeadLock</code> æˆ– <code>transferMoney</code> ä¸­é‚£ä¹ˆæ˜æ˜¾ï¼Œè¿™ä¸¤ä¸ªé”å¹¶ä¸ä¸€å®šå¿…é¡»åœ¨åŒä¸€ä¸ªæ–¹æ³•ä¸­è¢«è·å–:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Taxi</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> Point location<span style="color:#f92672">,</span> destination<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Dispatcher dispatcher<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Taxi</span><span style="color:#f92672">(</span>Dispatcher dispatcher<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatcher</span> <span style="color:#f92672">=</span> dispatcher<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> Point <span style="color:#a6e22e">getLocation</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> location<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#75715e">// å…ˆè·å– Taxi é”
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å†è·å– Dispatcher é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setLocation</span><span style="color:#f92672">(</span>Point location<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> location<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>location<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>destination<span style="color:#f92672">))</span>
            dispatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">notifyAvailable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dispatcher</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> taxis<span style="color:#f92672">;</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> availableTaxis<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Dispatcher</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        taxis <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;();</span>
        availableTaxis <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">notifyAvailable</span><span style="color:#f92672">(</span>Taxi taxi<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        availableTaxis<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>taxi<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#75715e">// å…ˆè·å– Dispatcher é”
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å†è·å–æ¯ä¸€ä¸ª Taxi é”
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> Image <span style="color:#a6e22e">getImage</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        Image image <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Image<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Taxi t <span style="color:#f92672">:</span> taxis<span style="color:#f92672">)</span>
            image<span style="color:#f92672">.</span><span style="color:#a6e22e">drawMarker</span><span style="color:#f92672">(</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocation</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> image<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>é€šè¿‡å°†ä¸Šè¿°ä»£ç ä¿®æ”¹ä¸º<strong>å¼€æ”¾è°ƒç”¨ (è°ƒç”¨æŸä¸ªæ–¹æ³•æ—¶ä¸éœ€è¦ä½¿ç”¨é”)</strong>ï¼Œä»è€Œæ¶ˆé™¤å‘ç”Ÿæ­»é”çš„é£é™©:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@ThreadSafe</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Taxi</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> Point location<span style="color:#f92672">,</span> destination<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Dispatcher dispatcher<span style="color:#f92672">;</span>
    <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> Point <span style="color:#a6e22e">getLocation</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> location<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setLocation</span><span style="color:#f92672">(</span>Point location<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">boolean</span> reachedDestination<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> location<span style="color:#f92672">;</span>
            reachedDestination <span style="color:#f92672">=</span> location<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>destination<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>reachedDestination<span style="color:#f92672">)</span>
            dispatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">notifyAvailable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#a6e22e">@ThreadSafe</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dispatcher</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> taxis<span style="color:#f92672">;</span>
    <span style="color:#a6e22e">@GuardedBy</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;this&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> availableTaxis<span style="color:#f92672">;</span>
    <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">notifyAvailable</span><span style="color:#f92672">(</span>Taxi taxi<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            availableTaxis<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>taxi<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">public</span> Image <span style="color:#a6e22e">getImage</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        Set<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;</span> copy<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            copy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>Taxi<span style="color:#f92672">&gt;(</span>taxis<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        Image image <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Image<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Taxi t <span style="color:#f92672">:</span> copy<span style="color:#f92672">)</span>
            image<span style="color:#f92672">.</span><span style="color:#a6e22e">drawMarker</span><span style="color:#f92672">(</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocation</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> image<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨ç¨‹åºä¸­åº”è¯¥å°½é‡ä½¿ç”¨å¼€æ”¾è°ƒç”¨ã€‚ä¸é‚£äº›åœ¨æŒæœ‰é”æ—¶è°ƒç”¨å¤–éƒ¨æ–¹æ³•çš„ç¨‹åºç›¸æ¯”ï¼Œæ›´æ˜“äºå¯¹ä¾èµ–äºå¼€æ”¾è°ƒç”¨çš„ç¨‹åºè¿›è¡Œæ­»é”åˆ†æã€‚é€šè¿‡ä½¿ç”¨<strong>å®šæ—¶é”</strong>èƒ½å¤Ÿæœ‰æ•ˆåœ°åº”å¯¹æ­»é”é—®é¢˜ï¼Œé€šè¿‡ <strong>Thread Dump</strong> èƒ½å¤Ÿå¸®åŠ©ä½ è¯†åˆ«æ­»é”çš„å‘ç”Ÿã€‚</p>
<h2 id="å‡å°‘é”çš„ç«äº‰">å‡å°‘é”çš„ç«äº‰</h2>
<p>æœ‰ä¸‰ç§æ–¹å¼å¯ä»¥é™ä½é”çš„ç«äº‰ç¨‹åº¦:</p>
<ul>
<li>å‡å°‘é”çš„æŒæœ‰æ—¶é—´</li>
<li>é™ä½é”çš„è¯·æ±‚é¢‘ç‡</li>
<li>ä½¿ç”¨å¸¦æœ‰åè°ƒæœºåˆ¶çš„ç‹¬å é”ï¼Œè¿™äº›æœºåˆ¶å…è®¸æ›´é«˜çš„å¹¶å‘æ€§</li>
</ul>
<h2 id="é‡å…¥é”-reentrantlock">é‡å…¥é” ReentrantLock</h2>
<p><code>ReentrantLock</code> çš„ <code>tryLock</code> æ–¹æ³•ä¸ºä½ æä¾›äº†<strong>è½®è¯¢é”ä¸å®šæ—¶é”</strong>çš„é”è·å–æ¨¡å¼ï¼Œä¸æ— æ¡ä»¶çš„é”è·å–æ¨¡å¼ç›¸æ¯”ï¼Œå®ƒå…·æœ‰æ›´å®Œå–„çš„é”™è¯¯æ¢å¤æœºåˆ¶ã€‚æ–¹æ³• <code>lockInterruptibly</code> æ–¹æ³•èƒ½å¤Ÿåœ¨è·å¾—é”çš„åŒæ—¶<strong>ä¿æŒå¯¹ä¸­æ–­çš„å“åº”</strong>ã€‚<code>ReentrantLock</code> çš„æ„é€ å‡½æ•°ä¸­æä¾›äº†ä¸¤ç§<strong>å…¬å¹³æ€§</strong>é€‰æ‹©: åˆ›å»ºä¸€ä¸ªéå…¬å¹³çš„é” (é»˜è®¤) æˆ–è€…ä¸€ä¸ªå…¬å¹³çš„é”ã€‚åœ¨å…¬å¹³çš„é”ä¸Šï¼Œçº¿ç¨‹å°†æŒ‰ç…§å®ƒä»¬å‘å‡ºè¯·æ±‚çš„é¡ºåºæ¥è·å¾—é”ï¼Œä½†åœ¨éå…¬å¹³çš„é”ä¸Šï¼Œåˆ™å…è®¸â€œæ’é˜Ÿâ€ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œéå…¬å¹³é”çš„æ€§èƒ½è¦é«˜äºå…¬å¹³é”çš„æ€§èƒ½ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReentrantLock</span> <span style="color:#66d9ef">implements</span> Lock<span style="color:#f92672">,</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Serializable</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/** Synchronizer providing all implementation mechanics */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Sync sync<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sync</span> <span style="color:#66d9ef">extends</span> AbstractQueuedSynchronizer <span style="color:#f92672">{</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReentrantLock</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> fair<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sync <span style="color:#f92672">=</span> fair <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> FairSync<span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> NonfairSync<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryLock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> sync<span style="color:#f92672">.</span><span style="color:#a6e22e">nonfairTryAcquire</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        sync<span style="color:#f92672">.</span><span style="color:#a6e22e">release</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="è¯»å†™é”-readwritelock">è¯»å†™é” ReadWriteLock</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReentrantReadWriteLock</span>
        <span style="color:#66d9ef">implements</span> ReadWriteLock<span style="color:#f92672">,</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Serializable</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReentrantReadWriteLock</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> fair<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sync <span style="color:#f92672">=</span> fair <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> FairSync<span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> NonfairSync<span style="color:#f92672">();</span>
        readerLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ReadLock<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        writerLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WriteLock<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="è®°å½•é”-record-locking">è®°å½•é” Record Locking</h2>
<p><strong>Record Locking</strong> æ›´å¥½çš„å«æ³•åº”è¯¥è¢«ç§°ä¸º: <strong>byte-range locking</strong>ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶çš„æŸå—åŒºåŸŸã€‚å‡½æ•°åŸå‹å¦‚ä¸‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// å‡ºé”™è¿”å› -1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fcntl</span>(<span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> cmd, ... <span style="color:#75715e">/* struct flock *flockptr */</span> );
</code></pre></div><p>å…¶ä¸­ <code>flock</code> ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> flock {
    <span style="color:#66d9ef">short</span> l_type; <span style="color:#75715e">/* F_RDLCK, F_WRLCK, or F_UNLCK */</span>
    <span style="color:#66d9ef">short</span> l_whence; <span style="color:#75715e">/*SEEK_SET, SEEK_CUR, or SEEK_END */</span>
    off_t l_start; <span style="color:#75715e">/*offset in bytes, relative to l_whence */</span>
    off_t l_len; <span style="color:#75715e">/*length, in bytes; 0 means lock to EOF */</span>
    pid_t l_pid; <span style="color:#75715e">/*returned with F_GETLK */</span>
};
</code></pre></div><ul>
<li><code>F_RDLCK</code>: å…±äº«è¯»é”</li>
<li><code>F_WRLCK</code>: æ’æ–¥å†™é”</li>
<li><code>F_UNLCK</code>: å–æ¶ˆæŸä¸ªåŒºåŸŸçš„é”</li>
</ul>
<h2 id="é”ä¼˜åŒ–">é”ä¼˜åŒ–</h2>
<h3 id="è‡ªæ—‹é”-spinlock">è‡ªæ—‹é” SpinLock</h3>
<p><strong>äº’æ–¥åŒæ­¥å¯¹æ€§èƒ½æœ€å¤§çš„å½±å“å°±æ˜¯é˜»å¡çš„å®ç°ï¼ŒæŒ‚èµ·çº¿ç¨‹å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œéƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€ä¸­å®Œæˆ</strong>ï¼Œè¿™äº›æ“ä½œç»™ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å¸¦æ¥äº†å¾ˆå¤§çš„å‹åŠ›ã€‚åŒæ—¶ï¼Œè™šæ‹Ÿæœºçš„å¼€å‘å›¢é˜Ÿä¹Ÿæ³¨æ„åˆ°åœ¨è®¸å¤šåº”ç”¨ä¸Šï¼Œ<strong>å…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´</strong>ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´å»æŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚ä¸ºäº†èƒ½è®©çº¿ç¨‹ç¨å¾®ç­‰ä¸€ä¼šï¼Œæˆ‘ä»¬åªéœ€è®©çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå¿™å¾ªç¯ (è‡ªæ—‹)ï¼Œè¿™é¡¹æŠ€æœ¯å°±æ˜¯æ‰€è°“çš„è‡ªæ—‹é”ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å‡è®¾<strong>ç¡¬ä»¶</strong>ä¸Šæœ‰ä¸€ç§èƒ½å¤Ÿä¿è¯åŸå­æ€§çš„ <code>TestAndSet</code> æŒ‡ä»¤å®ç°å‡½æ•°:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">TestAndSet</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>x){
    <span style="color:#66d9ef">register</span> <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>x;
    <span style="color:#f92672">*</span>x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">return</span> temp;
}
</code></pre></div><p><code>TestAndSet</code> æ˜¯ä¸€ç§å¸¸ç”¨çš„ç”¨äºæ”¯æŒå¹¶å‘çš„åŸå­æ“ä½œæŒ‡ä»¤ã€‚å¦å¤–ä¸€ç§ç»å¸¸ä½¿ç”¨çš„æŒ‡ä»¤æ˜¯åŸå­ <code>Exchange</code> æ“ä½œ:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Exchange</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>a, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>b) {
    <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>a;
    <span style="color:#f92672">*</span>a <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>b;
    <span style="color:#f92672">*</span>b <span style="color:#f92672">=</span> temp;
}
</code></pre></div><p>è¿™äº›æ‰€æœ‰çš„åŸå­æ€§æ“ä½œä¸­æœ€é‡è¦çš„æ˜¯ <code>CompareAndSwap (CAS)</code> æ“ä½œï¼Œå®ƒç»å¸¸è¢«ç”¨äº <a href="http://en.wikipedia.org/wiki/Lock-free_and_wait-free_algorithms">lock-free and wait-free algorithms</a> ç®—æ³•ä¸­ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">boolean <span style="color:#a6e22e">CAS</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>a, <span style="color:#66d9ef">int</span> old, <span style="color:#66d9ef">int</span> new) {
    <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>a;
    <span style="color:#66d9ef">if</span> (temp <span style="color:#f92672">==</span> old) {
        <span style="color:#f92672">*</span>a <span style="color:#f92672">=</span> new;
        <span style="color:#66d9ef">return</span> true;
    } <span style="color:#66d9ef">else</span> 
        <span style="color:#66d9ef">return</span> false;
}
</code></pre></div><p>ä½¿ç”¨ <code>CAS</code> æ¥å®ç° <code>temp++</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> x;
<span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>CAS(<span style="color:#f92672">&amp;</span>x, temp, temp<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) {
    temp <span style="color:#f92672">=</span> x;
}
</code></pre></div><p>ä½¿ç”¨ <code>CAS</code> æ¥å®ç°æ›´é“¾è¡¨å¤´æ’æ³•:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
    Node <span style="color:#f92672">*</span>q <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>head;
    p<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> q;
    <span style="color:#66d9ef">if</span> (CAS(head, q, p))
        <span style="color:#66d9ef">break</span>;
}
</code></pre></div><p>ä¸€èˆ¬è€Œè¨€ï¼Œ<code>SpinLock</code> æ˜¯ä¸€ç§æŠ½è±¡çš„æ•°æ®ç±»å‹ï¼Œå…¶é€šå¸¸æä¾›ä¸‰ç§æ“ä½œ:</p>
<ul>
<li><code>InitLock</code></li>
<li><code>Lock</code></li>
<li><code>UnLock</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">Lock(mutex);
Si;
UnLock(mutex);
</code></pre></div><p>å®ç° <code>SpinLock</code> çš„ä¼ªä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">int</span> SpinLock;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitLock</span>(SpinLock <span style="color:#f92672">*</span>L) {
    <span style="color:#f92672">*</span>L <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Lock</span>(SpinLock <span style="color:#f92672">*</span>L) {
    <span style="color:#66d9ef">while</span> (TestAndSet(L)) 
		;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">UnLock</span>(SpinLock <span style="color:#f92672">*</span>L) {
    <span style="color:#f92672">*</span>L <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>ä¸€ç§ä½¿ç”¨ <code>Exchange</code> æ“ä½œçš„å¯èƒ½å®ç°:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">int</span> SpinLock;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitLock</span>(SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Lock</span> (SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#66d9ef">int</span> L <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">do</span> {
        Exchange(<span style="color:#f92672">&amp;</span>L, s);
    } <span style="color:#66d9ef">while</span> (L <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>);
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">UnLock</span> (SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>å¦å¤–ä¸€ç§ä½¿ç”¨ <code>CompareAndSwap</code> æŒ‡ä»¤çš„å®ç°:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">int</span> SpinLock;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitLock</span>(SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Lock</span> (SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#66d9ef">do</span> {
    } until (CompareAndSwap(s, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>));
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">UnLock</span> (SpinLock <span style="color:#f92672">*</span>s) {
    <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>è‡ªæ—‹é”æœ€å¤§çš„é—®é¢˜å°±æ˜¯å¯èƒ½ä¼šå ç”¨æ¯”è¾ƒé«˜çš„ <strong>memory bus</strong> å¸¦å®½ï¼Œå¦å¤–å®ƒä¹Ÿä¸ä¿è¯å…¬å¹³æ€§ï¼Œå³æ— æ³•ä¿è¯å…ˆåè¿›å…¥ä¸´ç•ŒåŒºçš„ä¸¤ä¸ªè¿›ç¨‹ P å’Œ Q æŒ‰ç…§ FIFO é¡ºåºæ¥æœåŠ¡ã€‚</p>
<h3 id="é”æ¶ˆé™¤-lock-elimination">é”æ¶ˆé™¤ Lock Elimination</h3>
<p>è™šæ‹Ÿæœº JIT åœ¨è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›ä»£ç è¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚ä¸»è¦åˆ¤å®šä¾æ®æ¥è‡ªäº<strong>é€ƒé€¸åˆ†æ</strong>çš„æ•°æ®æ”¯æŒã€‚</p>
<h3 id="é”ç²—åŒ–-lock-coarsening">é”ç²—åŒ– Lock Coarsening</h3>
<h3 id="è½»é‡çº§é”-lightweight-locking">è½»é‡çº§é” Lightweight Locking</h3>
<h3 id="åå‘é”-biased-locking">åå‘é” Biased Locking</h3>
<p>åå‘é”çš„&quot;å&quot;ï¼Œæ˜¯åå¿ƒçš„&quot;å&quot;ï¼Œå®ƒçš„æ„æ€å°±æ˜¯<strong>è¿™ä¸ªé”ä¼šåå‘äºç¬¬ä¸€ä¸ªè·å¾—å®ƒçš„çº¿ç¨‹</strong>ï¼Œå¦‚æœåœ¨æ¥ä¸‹æ¥çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¯¥é”æ²¡æœ‰è¢«å…¶ä»–çš„çº¿ç¨‹è·å–ï¼Œåˆ™æŒæœ‰åå‘é”çš„çº¿ç¨‹å°†æ°¸è¿œä¸éœ€è¦å†è¿›è¡ŒåŒæ­¥ã€‚å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹å»å°è¯•è·å–è¿™ä¸ªé”æ—¶ï¼Œåå‘æ¨¡å¼å°±å®£å‘Šç»“æŸã€‚</p>
<p>JDK 1.6 é»˜è®¤å¼€å¯ <code>-XX:+UseBiasedLocking</code>ï¼Œä½¿ç”¨ <code>-XX:-UseBiasedLocking</code> æ¥å…³é—­ã€‚</p>
<p><strong>åå‘é”è½¬ä¸ºè½»é‡çº§é”</strong>çš„æµç¨‹å›¾:</p>
<p><img src="/images/posts/java-lock/217664272.jpg" alt=""></p>
<h3 id="é”å‡çº§-lock-escalation">é”å‡çº§ Lock Escalation</h3>
<p>æ‰€è°“çš„é”å‡çº§ï¼ˆlock escalationï¼‰ï¼Œæ˜¯æ•°æ®åº“çš„ä¸€ç§ä½œç”¨æœºåˆ¶ï¼Œè¯¥æœºåˆ¶æ™®éè§äºå„å¤§æ•°æ®åº“äº§å“ã€‚ ä¸ºäº†èŠ‚çº¦å†…å­˜çš„å¼€é”€ï¼Œå…¶ä¼š<strong>å°†ä¸ºæ•°ä¼—å¤šå¹¶å ç”¨å¤§é‡èµ„æºçš„ç»†ç²’åº¦çš„é”è½¬åŒ–ä¸ºæ•°é‡è¾ƒå°‘çš„ä¸”å ç”¨ç›¸å¯¹è¾ƒå°‘èµ„æºçš„ç²—ç²’åº¦çš„é”</strong>ï¼Œå¤šæ•°æƒ…å†µä¸‹ä¸»è¦æŒ‡<strong>å°†ä¸ºæ•°ä¼—å¤šçš„è¡Œé”å‡çº§ä¸ºä¸€ä¸ªè¡¨é”</strong>ã€‚å½“ç„¶ï¼ŒDB2 æ”¯æŒå¾ˆå¤šç²’åº¦çš„é”ï¼Œå¦‚**è¡¨ç©ºé—´ï¼ˆtable spaceï¼‰ï¼Œè¡¨ï¼ˆtableï¼‰ï¼Œè¡Œï¼ˆrowï¼‰ä»¥åŠç´¢å¼•ï¼ˆindexï¼‰**ç­‰ã€‚MySQL çš„ InnoDB å­˜å‚¨å¼•æ“æ”¯æŒäº‹åŠ¡ï¼Œ<strong>é»˜è®¤æ˜¯è¡Œé”</strong>ã€‚å¾—ç›Šäºè¿™äº›ç‰¹æ€§ï¼Œæ•°æ®åº“æ”¯æŒé«˜å¹¶å‘ã€‚</p>
<p>é”å‡çº§ä¸ä¸¤ç§äº‹æƒ…æœ‰å…³:</p>
<ul>
<li>äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</li>
<li>ç´¢å¼•</li>
</ul>
<p>å¸¸ç”¨çš„ç´¢å¼•æœ‰ä¸‰ç±»ï¼š<strong>ä¸»é”®ã€å”¯ä¸€ç´¢å¼•ã€æ™®é€šç´¢å¼•</strong>ã€‚ä¸»é”® ä¸ç”±åˆ†è¯´ï¼Œè‡ªå¸¦æœ€é«˜æ•ˆçš„ç´¢å¼•å±æ€§ï¼›å”¯ä¸€ç´¢å¼• æŒ‡çš„æ˜¯è¯¥å±æ€§å€¼é‡å¤ç‡ä¸º0ï¼Œä¸€èˆ¬å¯ä½œä¸ºä¸šåŠ¡ä¸»é”®ï¼Œä¾‹å¦‚å­¦å·ï¼›æ™®é€šç´¢å¼• ä¸å‰è€…ä¸åŒçš„æ˜¯ï¼Œå±æ€§å€¼çš„é‡å¤ç‡å¤§äº0ï¼Œä¸èƒ½ä½œä¸ºå”¯ä¸€æŒ‡å®šæ¡ä»¶ï¼Œä¾‹å¦‚å­¦ç”Ÿå§“åã€‚<strong>å½“â€œå€¼é‡å¤ç‡â€ä½æ—¶ï¼Œç”šè‡³æ¥è¿‘ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•çš„æ•ˆæœï¼Œâ€œæ™®é€šç´¢å¼•â€ä¾ç„¶æ˜¯è¡Œé”ï¼›å½“â€œå€¼é‡å¤ç‡â€é«˜æ—¶ï¼ŒMySQL ä¸ä¼šæŠŠè¿™ä¸ªâ€œæ™®é€šç´¢å¼•â€å½“åšç´¢å¼•ï¼Œå³é€ æˆäº†ä¸€ä¸ªæ²¡æœ‰ç´¢å¼•çš„ SQLï¼Œæ­¤æ—¶å¼•å‘è¡¨é”</strong>ã€‚ç´¢å¼•ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œç´¢å¼•å­˜åœ¨ä¸€ä¸ªå’Œè¿™ä¸ªè¡¨ç›¸å…³çš„æ–‡ä»¶é‡Œï¼Œå ç”¨ç¡¬ç›˜ç©ºé—´ï¼Œå®ç¼ºå‹¿æ»¥ï¼Œæ¯ä¸ªè¡¨éƒ½æœ‰ä¸»é”®ï¼ˆidï¼‰ï¼Œæ“ä½œèƒ½ä½¿ç”¨ä¸»é”®å°½é‡ä½¿ç”¨ä¸»é”®ã€‚åŒ JVM è‡ªåŠ¨ä¼˜åŒ– java ä»£ç ä¸€æ ·ï¼ŒMySQL ä¹Ÿå…·æœ‰è‡ªåŠ¨ä¼˜åŒ– SQL çš„åŠŸèƒ½ã€‚<strong>ä½æ•ˆçš„ç´¢å¼•å°†è¢«å¿½ç•¥</strong>ï¼Œè¿™ä¹Ÿå°±å€’é€¼å¼€å‘è€…ä½¿ç”¨æ­£ç¡®ä¸”é«˜æ•ˆçš„ç´¢å¼•ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://item.jd.com/10922250.html">ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹</a></li>
<li><a href="https://en.wikipedia.org/wiki/Deadlock">Deadlock</a></li>
<li><a href="https://www.amazon.com/Advanced-Programming-UNIX-Environment-3rd/dp/0321637739/">ã€ŠAdvanced Programming in the UNIXã€‹</a></li>
<li><a href="https://item.jd.com/11252778.html">ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹</a></li>
<li><a href="https://cis.temple.edu/~giorgio/cis307/readings/spinsem.html">CIS 4307: Spinlocks and Semaphores</a></li>
<li><a href="https://cs.au.dk/~mis/dOvs/jvmspec/ref--44.html">enter synchronized region of code</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/data/library/techarticle/dm-1312db2lockescalation/">å…³äº DB2 é”å‡çº§ (lock escalation) ç›¸å…³é—®é¢˜çš„æ¢è®¨</a></li>
<li><a href="http://zhoupq.com/MySQL-%E9%81%BF%E5%85%8D%E8%A1%8C%E9%94%81%E5%8D%87%E7%BA%A7%E4%B8%BA%E8%A1%A8%E9%94%81%E2%80%94%E2%80%94%E4%BD%BF%E7%94%A8%E9%AB%98%E6%95%88%E7%9A%84%E7%B4%A2%E5%BC%95/">MySQL é¿å…è¡Œé”å‡çº§ä¸ºè¡¨é”â€”â€”ä½¿ç”¨é«˜æ•ˆçš„ç´¢å¼•</a></li>
<li><a href="http://tech.meituan.com/innodb-lock.html">Innodbä¸­çš„äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œé”çš„å…³ç³»</a></li>
<li><a href="http://www.imooc.com/article/17291?block_id=tuijian_wz">MySQLæ•°æ®åº“äº‹åŠ¡å„éš”ç¦»çº§åˆ«åŠ é”æƒ…å†µ&ndash;read uncommittedç¯‡</a></li>
<li><a href="http://www.artima.com/insidejvm/ed2/threadsynchP.html">Thread Synchronization</a></li>
</ul></p>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#çº¿ç¨‹å®‰å…¨çš„ä¸‰ç§å®ç°æ–¹å¼">çº¿ç¨‹å®‰å…¨çš„ä¸‰ç§å®ç°æ–¹å¼</a>
      <ul>
        <li><a href="#äº’æ–¥åŒæ­¥">äº’æ–¥åŒæ­¥</a></li>
        <li><a href="#éé˜»å¡åŒæ­¥">éé˜»å¡åŒæ­¥</a></li>
        <li><a href="#æ— åŒæ­¥">æ— åŒæ­¥</a></li>
      </ul>
    </li>
    <li><a href="#java-ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜äº¤äº’">Java ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜äº¤äº’</a></li>
    <li><a href="#å†…ç½®é”-synchronized">å†…ç½®é” Synchronized</a></li>
    <li><a href="#æ­»é”">æ­»é”</a></li>
    <li><a href="#å‡å°‘é”çš„ç«äº‰">å‡å°‘é”çš„ç«äº‰</a></li>
    <li><a href="#é‡å…¥é”-reentrantlock">é‡å…¥é” ReentrantLock</a></li>
    <li><a href="#è¯»å†™é”-readwritelock">è¯»å†™é” ReadWriteLock</a></li>
    <li><a href="#è®°å½•é”-record-locking">è®°å½•é” Record Locking</a></li>
    <li><a href="#é”ä¼˜åŒ–">é”ä¼˜åŒ–</a>
      <ul>
        <li><a href="#è‡ªæ—‹é”-spinlock">è‡ªæ—‹é” SpinLock</a></li>
        <li><a href="#é”æ¶ˆé™¤-lock-elimination">é”æ¶ˆé™¤ Lock Elimination</a></li>
        <li><a href="#é”ç²—åŒ–-lock-coarsening">é”ç²—åŒ– Lock Coarsening</a></li>
        <li><a href="#è½»é‡çº§é”-lightweight-locking">è½»é‡çº§é” Lightweight Locking</a></li>
        <li><a href="#åå‘é”-biased-locking">åå‘é” Biased Locking</a></li>
        <li><a href="#é”å‡çº§-lock-escalation">é”å‡çº§ Lock Escalation</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>



</html>












