<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Spring AOP"><meta property="og:title" content="Spring AOP" />
<meta property="og:description" content="Spring AOP AspectJ5 Pointcut 表达式 语法    表达式 说明     call(Signature) 匹配 Signature 的任何的对于方法或者构造器的调用   execution(Signature) 匹配 Signature 的任何方法或者构造器的执行   get(Signature) 匹配 Signature 的任何的对于字段的引用   set(Signature) 匹配 Signature 的任何的对于字段的赋值   within(TypePattern) every join point from code defined in a type in TypePattern   target(Type or Id) every join point when the target executing object is an instance of Type or Id&rsquo;s type   args(Type or Id, ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/tutorial/spring/spring-aop/" /><meta property="article:section" content="docs" />



<title>Spring AOP | 赵坤的个人网站</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.827556f4a4b428e6ff4e68c72777003c28afbb68322bd35664dd0889a941daa0.css" integrity="sha256-gnVW9KS0KOb/TmjHJ3cAPCivu2gyK9NWZN0IialB2qA=">


<script defer src="/en.search.min.f05ac1428d580160cfd0c14763e6a9bf8f5cbc50610a1610f826f0033c6856ef.js" integrity="sha256-8FrBQo1YAWDP0MFHY&#43;apv49cvFBhChYQ&#43;CbwAzxoVu8="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>赵坤的个人网站</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      💡 教程
  </a>


    

    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/front-end-optimization-guide/" >
      前端优化指南
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/algorithm/" >
      算法
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/raft/" >
      raft
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-command/" >
      UNIX 常用命令大全
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-optimize/" >
      UNIX 性能优化
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/vue3/" >
      Vue.js 教程
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/git/" >
      Git 教程
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/network/" >
      网络协议
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/awk/" >
      AWK 教程
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/devops/" >
      DevOps
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/sentinel/" >
      阿里巴巴 Sentinel
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/zipkin/" >
      Zipkin 源码分析
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/eureka/" >
      Netflix Eureka 源码分析
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed-storage/" >
      分布式存储
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/maven/" >
      Maven 教程
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/java/" >
      Java 教程
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/spring/" >
      Spring 教程
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/tutorial/spring/annotations/" >
      Spring 常用注解
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/resttemplate/" >
      RestTemplate
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/ots-parsing-error/" >
      ots parsing error
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/deploy-to-tomcat/" >
      SpringBoot 打包成 WAR 部署到 Tomcat
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/transactional/" >
      Transactional
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/spring-plugin/" >
      Spring 插件扩展
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/spring-read-properties/" >
      Spring 读取 Properties 实现原理
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/spring-cloud-alibaba/" >
      《Spring Cloud Alibaba 微服务原理与实战》读书笔记
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/spring-uncover-secrets/" >
      《Spring 揭秘》读书笔记
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/spring-ioc/" >
      Spring IOC
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/spring-aop/"  class="active">
      Spring AOP
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/spring-basic/" >
      Spring 基础
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/spring-webmvc/" >
      Spring WebMVC
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/springboot-autoconfig/" >
      SpringBoot 自动配置原理
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/spring/springboot-startup/" >
      SpringBoot 启动过程
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed/" >
      分布式系统与架构设计
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/softskill/" >
      箴言箴句
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/database/" >
      数据库
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/redis/" >
      Redis
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/bigdata/" >
      大数据场景
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/technique/" >
      技术
  </a>


    

    






  </li>


      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      👍 程序员面试题
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ 源码分析
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      书籍
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript 专栏
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT 圈
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      招聘
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      云&#43;社区技术沙龙
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      实用工具
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        博客
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var a=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Spring AOP</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#aspectj5-pointcut-表达式">AspectJ5 Pointcut 表达式</a>
      <ul>
        <li><a href="#语法">语法</a></li>
        <li><a href="#示例">示例</a></li>
      </ul>
    </li>
    <li><a href="#java-原理">Java 原理</a></li>
    <li><a href="#enableaspectjautoproxy">EnableAspectJAutoProxy</a></li>
    <li><a href="#aop-执行顺序">AOP 执行顺序</a></li>
    <li><a href="#this-调用失效问题">this 调用失效问题</a></li>
    <li><a href="#收集切面">收集切面</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script><h1 id="spring-aop">Spring AOP</h1>
<h2 id="aspectj5-pointcut-表达式">AspectJ5 Pointcut 表达式</h2>
<h3 id="语法">语法</h3>
<table>
<thead>
<tr>
<th>表达式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>call(Signature)</code></td>
<td>匹配 Signature 的任何的对于方法或者构造器的<strong>调用</strong></td>
</tr>
<tr>
<td><code>execution(Signature)</code></td>
<td>匹配 Signature 的任何方法或者构造器的<strong>执行</strong></td>
</tr>
<tr>
<td><code>get(Signature)</code></td>
<td>匹配 Signature 的任何的对于字段的<strong>引用</strong></td>
</tr>
<tr>
<td><code>set(Signature)</code></td>
<td>匹配 Signature 的任何的对于字段的<strong>赋值</strong></td>
</tr>
<tr>
<td><code>within(TypePattern)</code></td>
<td>every join point from code defined in a type in <code>TypePattern</code></td>
</tr>
<tr>
<td><code>target(Type or Id)</code></td>
<td>every join point when the target executing object is an instance of Type or Id&rsquo;s type</td>
</tr>
<tr>
<td><code>args(Type or Id, ...)</code></td>
<td>every join point when the 参数 are instances of Types or the types of the Ids</td>
</tr>
<tr>
<td><code>! Pointcut</code></td>
<td>不匹配 Pointcut 的</td>
</tr>
<tr>
<td><code>Pointcut0 &amp;&amp; Pointcut1</code></td>
<td>同时符合 Pointcut0 和 Pointcut1</td>
</tr>
<tr>
<td>`Pointcut0</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><code>*</code> 匹配的是任意的字符串序列，但是不会匹配到包的路径里面的 <code>.</code> 这个字符。</li>
<li><code>..</code> 匹配的是包里面以 <code>.</code> 开始或者结束的任意字符串序列。</li>
</ul>
<h3 id="示例">示例</h3>
<ul>
<li><code>execution(void Point.setX(int))</code>：Point 类的 <code>setX</code> 方法执行</li>
<li><code>execution(* *(..))</code>：不管方法名是什么、返回类型是什么、参数是什么的任意方法</li>
<li><code>execution(!static * *(..))</code>：不是 static 的任意方法的执行</li>
<li><code>call(void Point.setX(int))</code>：调用了 Point 类的 <code>setX</code> 方法</li>
<li><code>call(* set(..))</code>：不管返回类型是什么、参数是什么的任意 <code>set</code> 方法的任何调用</li>
<li><code>call(*.new(int, int))</code>：对任意构造器的调用，这个构造器接受两个参数</li>
<li><code>call(public * *(..))</code>：<code>public</code> 方法的任意调用</li>
<li><code>handler(ArrayOutOfBoundsException)</code>：异常执行</li>
<li><code>this(SomeType)</code>：当当前正在执行的比如 <code>this</code> 的类型是 <code>SomeType</code></li>
<li><code>target(SomeType</code>：当目标是 <code>SomeType</code> 类型</li>
<li><code>within(MyClass)</code>：当执行的代码属于 <code>MyClass</code></li>
<li><code>target(Point) &amp;&amp; call(int *())</code>：调用 Point 实例的任何一个返回类型是 int 的无参数方法</li>
<li><code>call(* *(..)) &amp;&amp; (within(Line) || within(Point))</code>：来自于 Line 或者 Point 的任何方法调用</li>
<li><code>within(*) &amp;&amp; execution(*.new(int))</code>：任何拥有一个 int 参数类型的构造器的执行</li>
<li><code>!this(Point) &amp;&amp; call(int *(..))</code>：类型不是 Point 的调用返回类型为 int 的方法</li>
<li><code>call(* MyInterface.*(..))</code>：调用 MyInterface 接口里面的任意一个方法</li>
</ul>
<h2 id="java-原理">Java 原理</h2>
<p>Java 中实现切面，通过<strong>JDK 动态代理</strong>或者<strong>动态字节码技术如 CGLIB</strong>实现 <code>AOP</code>。JDK 动态代理通过<strong>反射</strong>来接收被代理的类，并且要求被代理的类<strong>必须实现一个接口</strong>。JDK 动态代理的核心是 <code>InvocationHandler</code> 接口和 <code>Proxy</code> 类。如果目标类没有实现接口，那么 Spring AOP 会选择使用 CGLIB 来动态代理目标类。CGLIB（Code Generation Library），是一个代码生成的类库，可以在运行时动态的生成某个类的子类，注意，CGLIB 是通过<strong>继承</strong>的方式做的动态代理，因此如果某个类被标记为 <code>final</code>，那么它是无法使用CGLIB 做动态代理的。</p>
<h2 id="enableaspectjautoproxy">EnableAspectJAutoProxy</h2>
<p>使用 <code>@EnableAspectJAutoProxy</code> 来开启 AOP。</p>
<h2 id="aop-执行顺序">AOP 执行顺序</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#a6e22e">@Order</span><span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>
<span style="color:#a6e22e">@Aspect</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StudentAspectA</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Pointcut</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;execution(void Student.setAge(int))&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">doAround</span><span style="color:#f92672">(</span>JointPoint jp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;A pre setAge&#34;</span><span style="color:#f92672">);</span>
        Object obj <span style="color:#f92672">=</span> jp<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;A after setAge&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> obj<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>

<span style="color:#a6e22e">@Order</span><span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>
<span style="color:#a6e22e">@Aspect</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StudentAspectB</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Pointcut</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;execution(void Student.setAge(int))&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">doAround</span><span style="color:#f92672">(</span>JointPoint jp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;B pre setAge&#34;</span><span style="color:#f92672">);</span>
        Object obj <span style="color:#f92672">=</span> jp<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;B after setAge&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> obj<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>因为 <code>StudentAspectA</code> 的 <code>Order</code> 比 <code>StudentAspectB</code> 的 <code>Order</code> 小，因此 <code>StudentAspectA</code> 的优先级更高，因此先执行 <code>A</code>，最终顺序如下：</p>
<pre><code>A pre setAge
    B pre setAge
        setAge
    B after setAge
A after setAge
</code></pre><h2 id="this-调用失效问题">this 调用失效问题</h2>
<blockquote>
<p>本节参考自 <a href="https://my.oschina.net/guangshan/blog/1807721">透过现象看原理：详解Spring中Bean的this调用导致AOP失效的原因</a></p>
</blockquote>
<p>AOP 动态代理的方法真实调用，会使用真实被代理对象实例进行方法调用，故在实例方法中通过<code>this</code>获取的都是被代理的<strong>真实对象</strong>的实例，而不是代理对象自身。</p>
<p>如何解决：</p>
<ul>
<li>自己注入自己，应该是可以生效的，不过没有实际验证，这种方法参考自<a href="https://www.cnblogs.com/yjmyzz/p/why-spring-aop-does-not-work.html">spring中aop不生效的几种解决办法</a>。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#a6e22e">@Component</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AsyncService</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Autowired</span>
    <span style="color:#66d9ef">private</span> AsyncService asyncService<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">async1</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1:&#34;</span> <span style="color:#f92672">+</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
        asyncService<span style="color:#f92672">.</span><span style="color:#a6e22e">async2</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Async</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">async2</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2:&#34;</span> <span style="color:#f92672">+</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><pre><code>
- 通过 `ApplicationContext` 来获得动态代理对象

``` Java
@Component
public class AsyncService implements ApplicationContextAware {

    private ApplicationContext applicationContext;

    public void async1() {
        System.out.println(&quot;1:&quot; + Thread.currentThread().getName());
        // 使用AppicationContext来获得动态代理的bean
        this.applicationContext.getBean(AsyncService.class).async2();
    }

    @Async
    public void async2() {
        System.out.println(&quot;2:&quot; + Thread.currentThread().getName());
    }

    // 注入ApplicationContext
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.applicationContext = applicationContext;
    }
}
</code></pre><ul>
<li>通过 <code>AopContext</code> 获取动态代理对象。注解必须加上 <code>@EnableAspectJAutoProxy(exposeProxy = true)</code>。如果是 <code>@Transactional</code> 事务注解可以生效，<code>@Async</code> 不生效。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#f92672">((</span>AsyncService<span style="color:#f92672">)</span> AopContext<span style="color:#f92672">.</span><span style="color:#a6e22e">currentProxy</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">async2</span><span style="color:#f92672">();</span>
</code></pre></div><h2 id="收集切面">收集切面</h2>
<p>首先需要 Spring 能先从所有 Bean 中识别出我们的<strong>切面类</strong>，<code>AnnotationAwareAspectJAutoProxyCreator</code> 类重写的<code>postProcessBeforeInstantiation</code> 方法就是专门处理这个问题的，此操作的要求是<strong>必须在其它普通 Bean 对象创建完放入容器前解析</strong>。</p>
<p>它的父类 <code>AbstractAutoProxyCreator</code> 实现了 <code>BeanPostProcessor</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// AbstractAutoProxyCreator.java
</span><span style="color:#75715e"></span>Override
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">postProcessAfterInitialization</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Nullable</span> Object bean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bean <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Object cacheKey <span style="color:#f92672">=</span> getCacheKey<span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">earlyProxyReferences</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> bean<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> wrapIfNecessary<span style="color:#f92672">(</span>bean<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> cacheKey<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">protected</span> Object <span style="color:#a6e22e">wrapIfNecessary</span><span style="color:#f92672">(</span>Object bean<span style="color:#f92672">,</span> String beanName<span style="color:#f92672">,</span> Object cacheKey<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 如果已经处理过
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">hasLength</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetSourcedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#75715e">// 无需增强
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advisedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// 如果存在增强方法，那么创建代理
</span><span style="color:#75715e"></span>    Object<span style="color:#f92672">[]</span> specificInterceptors <span style="color:#f92672">=</span> getAdvicesAndAdvisorsForBean<span style="color:#f92672">(</span>bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>specificInterceptors <span style="color:#f92672">!=</span> DO_NOT_PROXY<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advisedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">TRUE</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// 创建代理
</span><span style="color:#75715e"></span>        Object proxy <span style="color:#f92672">=</span> createProxy<span style="color:#f92672">(</span>
                bean<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">,</span> specificInterceptors<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> SingletonTargetSource<span style="color:#f92672">(</span>bean<span style="color:#f92672">));</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">proxyTypes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> proxy<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> proxy<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">advisedBeans</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cacheKey<span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> bean<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>getAdvicesAndAdvisorsForBean</code> 主要做的事情如下：</p>
<ul>
<li>(1) 获取所有 <code>beanName</code></li>
<li>(2) 遍历所有 <code>beanName</code>，找出声明了 <code>AspectJ</code> 注解的类</li>
<li>(3) 对标记为 <code>AspectJ</code> 注解的类进行增强器的提取</li>
<li>(4) 将提取结果加入缓存</li>
</ul>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://blog.csdn.net/binghuazheng/article/details/112853892">源码分析-Spring AOP是如何实现的？（二）</a></li>
<li><a href="https://www.eclipse.org/aspectj/doc/released/progguide/quick.html">Appendix A. AspectJ Quick Reference</a></li>
<li><a href="https://www.eclipse.org/aspectj/doc/released/progguide/language-joinPoints.html">Chapter 2. The AspectJ Language</a></li>
</ul>

<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#aspectj5-pointcut-表达式">AspectJ5 Pointcut 表达式</a>
      <ul>
        <li><a href="#语法">语法</a></li>
        <li><a href="#示例">示例</a></li>
      </ul>
    </li>
    <li><a href="#java-原理">Java 原理</a></li>
    <li><a href="#enableaspectjautoproxy">EnableAspectJAutoProxy</a></li>
    <li><a href="#aop-执行顺序">AOP 执行顺序</a></li>
    <li><a href="#this-调用失效问题">this 调用失效问题</a></li>
    <li><a href="#收集切面">收集切面</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>



</html>












