<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="æ·±å…¥ç†è§£ Tomcat JDBC Pool"><meta property="og:title" content="æ·±å…¥ç†è§£ Tomcat JDBC Pool" />
<meta property="og:description" content="æ·±å…¥ç†è§£ Tomcat JDBC Pool  æœ¬æ–‡åˆ†æçš„æºç ç‰ˆæœ¬åŸºäº 11.0.0-M3 ã€‚
 åˆ›å»ºè¿æ¥æ±  Tomcat JDBC Pool è¿æ¥æ± å¯ä»¥é…ç½®å¤šç§å¤šæ ·çš„å±æ€§ï¼Œç›¸å…³ç‰¹æ€§ä»¥æ¥å£çš„æ–¹å¼å°è£…åœ¨äº† PoolConfiguration ä¸­ã€‚
// åˆ›å»ºè¿æ¥æ± çš„ä»£ç  // DataSourceProxy.java private synchronized ConnectionPool pCreatePool() throws SQLException { pool = new ConnectionPool(poolProperties); } åˆ›å»ºè¿æ¥æ± çš„ç›¸å…³ä»£ç å°±ä½äº ConnectionPool ä¸­ï¼Œå…¶åœ¨æ„é€ å™¨ä¸­åšäº†å¦‚ä¸‹äº‹æƒ…ï¼š
 æ£€æŸ¥ç›¸å…³é…ç½®ã€‚é€šå¸¸å¯¹ä¸€äº› maxActive ã€minIdle ä¹‹é—´çš„å¤§å°é€»è¾‘è¿›è¡Œæ ¡éªŒç­‰ï¼š  public void checkPoolConfiguration(PoolConfiguration properties) { //make sure the pool is properly configured  if (properties.getMaxActive()&lt;1) { properties.setMaxActive(PoolProperties.DEFAULT_MAX_ACTIVE); } if (properties.getMaxActive()&lt;properties.getInitialSize()) { properties.setInitialSize(properties.getMaxActive()); } if (properties.getMinIdle()&gt;properties.getMaxActive()) { properties.setMinIdle(properties.getMaxActive()); } if (properties." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/tutorial/database/tomcat-jdbc/" />

<title>æ·±å…¥ç†è§£ Tomcat JDBC Pool | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.7ebac727e739c3b4aee6328926e3b77ac1ddd5e9035221b7ec206fda1a413a4d.css" integrity="sha256-frrHJ&#43;c5w7Su5jKJJuO3esHd1ekDUiG37CBv2hpBOk0=">


<script defer src="/en.search.min.63beb53ab1ff8a905e997048a421d8d5d74cf83c5554d55a0a3c21f21fa26b3a.js" integrity="sha256-Y761OrH/ipBemXBIpCHY1ddM&#43;DxVVNVaCjwh8h&#43;iazo="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/front-end-optimization-guide/" >
      å‰ç«¯ä¼˜åŒ–æŒ‡å—
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/algorithm/" >
      ç®—æ³•
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/raft/" >
      raft
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-command/" >
      UNIX å¸¸ç”¨å‘½ä»¤å¤§å…¨
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-optimize/" >
      UNIX æ€§èƒ½ä¼˜åŒ–
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/vue3/" >
      Vue.js æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/git/" >
      Git æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/network/" >
      ç½‘ç»œåè®®
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/awk/" >
      AWK æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/devops/" >
      DevOps
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/sentinel/" >
      é˜¿é‡Œå·´å·´ Sentinel
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/zipkin/" >
      Zipkin æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/eureka/" >
      Netflix Eureka æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed-storage/" >
      åˆ†å¸ƒå¼å­˜å‚¨
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/maven/" >
      Maven æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/java/" >
      Java æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/spring/" >
      Spring æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed/" >
      åˆ†å¸ƒå¼ç³»ç»Ÿä¸æ¶æ„è®¾è®¡
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/softskill/" >
      ç®´è¨€ç®´å¥
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/database/" >
      æ•°æ®åº“
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/tutorial/database/mysql-query/" >
      MySQL æŸ¥è¯¢
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/transaction-internal/" >
      MySQL äº‹åŠ¡å®ç°åŸç†
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/mysql-crash-safe/" >
      MySQL Crash Safe
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/mysql-index/" >
      MySQL ç´¢å¼•
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/auto-increment-id/" >
      MySQL è‡ªå¢é”®
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/mysql-high-availablity/" >
      MySQL é«˜å¯ç”¨
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/mysql-ops/" >
      MySQL ä¼˜åŒ–ä¸è¿ç»´
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/mvcc/" >
      MVCC
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/mybatis/" >
      MyBatis
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/tomcat-jdbc/"  class="active">
      æ·±å…¥ç†è§£ Tomcat JDBC Pool
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/druid/" >
      Druid è®¾è®¡
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/oracle/" >
      Oracle
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/database/sharding-sphere/" >
      ShardingSphere
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/redis/" >
      Redis
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/bigdata/" >
      å¤§æ•°æ®åœºæ™¯
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/technique/" >
      æŠ€æœ¯
  </a>


    

    






  </li>


      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>æ·±å…¥ç†è§£ Tomcat JDBC Pool</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#åˆ›å»ºè¿æ¥æ± ">åˆ›å»ºè¿æ¥æ± </a>
      <ul>
        <li><a href="#è¿æ¥æ± é»˜è®¤å±æ€§">è¿æ¥æ± é»˜è®¤å±æ€§</a></li>
      </ul>
    </li>
    <li><a href="#è·å–è¿æ¥">è·å–è¿æ¥</a>
      <ul>
        <li><a href="#validate-é€»è¾‘"><code>validate</code> é€»è¾‘</a></li>
        <li><a href="#ismaxageexpired-é€»è¾‘"><code>isMaxAgeExpired</code> é€»è¾‘</a></li>
        <li><a href="#reconnect-é€»è¾‘"><code>reconnect</code> é€»è¾‘</a></li>
        <li><a href="#ç­‰å¾…å¯ç”¨è¿æ¥">ç­‰å¾…å¯ç”¨è¿æ¥</a></li>
      </ul>
    </li>
    <li><a href="#å½’è¿˜è¿æ¥">å½’è¿˜è¿æ¥</a>
      <ul>
        <li><a href="#é‡Šæ”¾è¿æ¥">é‡Šæ”¾è¿æ¥</a></li>
      </ul>
    </li>
    <li><a href="#è¿æ¥æ± æ¸…ç†å™¨">è¿æ¥æ± æ¸…ç†å™¨</a>
      <ul>
        <li><a href="#checkabandoned-é€»è¾‘"><code>checkAbandoned</code> é€»è¾‘</a></li>
        <li><a href="#checkidle-é€»è¾‘"><code>checkIdle</code> é€»è¾‘</a></li>
        <li><a href="#testallidle-é€»è¾‘"><code>testAllIdle</code> é€»è¾‘</a></li>
      </ul>
    </li>
    <li><a href="#æ‹¦æˆªå™¨">æ‹¦æˆªå™¨</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script><h1 id="æ·±å…¥ç†è§£-tomcat-jdbc-pool">æ·±å…¥ç†è§£ Tomcat JDBC Pool</h1>
<blockquote>
<p>æœ¬æ–‡åˆ†æçš„æºç ç‰ˆæœ¬åŸºäº <code>11.0.0-M3</code> ã€‚</p>
</blockquote>
<h2 id="åˆ›å»ºè¿æ¥æ± ">åˆ›å»ºè¿æ¥æ± </h2>
<p>Tomcat JDBC Pool è¿æ¥æ± å¯ä»¥é…ç½®å¤šç§å¤šæ ·çš„å±æ€§ï¼Œç›¸å…³ç‰¹æ€§ä»¥æ¥å£çš„æ–¹å¼å°è£…åœ¨äº† <code>PoolConfiguration</code> ä¸­ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// åˆ›å»ºè¿æ¥æ± çš„ä»£ç 
</span><span style="color:#75715e">// DataSourceProxy.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">synchronized</span> ConnectionPool <span style="color:#a6e22e">pCreatePool</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> SQLException <span style="color:#f92672">{</span>
    pool <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConnectionPool<span style="color:#f92672">(</span>poolProperties<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>åˆ›å»ºè¿æ¥æ± çš„ç›¸å…³ä»£ç å°±ä½äº <code>ConnectionPool</code> ä¸­ï¼Œå…¶åœ¨æ„é€ å™¨ä¸­åšäº†å¦‚ä¸‹äº‹æƒ…ï¼š</p>
<ul>
<li><strong>æ£€æŸ¥ç›¸å…³é…ç½®</strong>ã€‚é€šå¸¸å¯¹ä¸€äº› <code>maxActive</code> ã€<code>minIdle</code> ä¹‹é—´çš„å¤§å°é€»è¾‘è¿›è¡Œæ ¡éªŒç­‰ï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkPoolConfiguration</span><span style="color:#f92672">(</span>PoolConfiguration properties<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//make sure the pool is properly configured
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">()&lt;</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        properties<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxActive</span><span style="color:#f92672">(</span>PoolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_MAX_ACTIVE</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">()&lt;</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getInitialSize</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        properties<span style="color:#f92672">.</span><span style="color:#a6e22e">setInitialSize</span><span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinIdle</span><span style="color:#f92672">()&gt;</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        properties<span style="color:#f92672">.</span><span style="color:#a6e22e">setMinIdle</span><span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxIdle</span><span style="color:#f92672">()&gt;</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        properties<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxIdle</span><span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxIdle</span><span style="color:#f92672">()&lt;</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinIdle</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        properties<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxIdle</span><span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinIdle</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxAge</span><span style="color:#f92672">()&gt;</span>0 <span style="color:#f92672">&amp;&amp;</span> properties<span style="color:#f92672">.</span><span style="color:#a6e22e">isPoolSweeperEnabled</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span>
            properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getTimeBetweenEvictionRunsMillis</span><span style="color:#f92672">()&gt;</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxAge</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        properties<span style="color:#f92672">.</span><span style="color:#a6e22e">setTimeBetweenEvictionRunsMillis</span><span style="color:#f92672">((</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxAge</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li><strong>åˆ›å»ºèµ„æºæ± </strong>ã€‚èµ„æºæ± è´Ÿè´£ç®¡ç†æ­£åœ¨ä½¿ç”¨çš„è¿æ¥ã€ç©ºé—²çš„è¿æ¥ç­‰ï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">//make space for 10 extra in case we flow over a bit
</span><span style="color:#75715e"></span>busy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;&gt;();</span>
<span style="color:#75715e">//busy = new FairBlockingQueue&lt;PooledConnection&gt;();
</span><span style="color:#75715e">//make space for 10 extra in case we flow over a bit
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">isFairQueue</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    idle <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FairBlockingQueue<span style="color:#f92672">&lt;&gt;();</span>
    <span style="color:#75715e">//idle = new MultiLockFairBlockingQueue&lt;PooledConnection&gt;();
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//idle = new LinkedTransferQueue&lt;PooledConnection&gt;();
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//idle = new ArrayBlockingQueue&lt;PooledConnection&gt;(properties.getMaxActive(),false);
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    idle <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;&gt;();</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li><strong>åˆ›å»ºèµ„æºæ± æ¸…ç†å™¨</strong>ã€‚èµ„æºæ± æ¸…ç†å™¨ä¼šå¯åŠ¨åå°çº¿ç¨‹ï¼Œæ¥æ£€æµ‹è¿æ¥çš„æœ‰æ•ˆæ€§ï¼Œå¹¶å³æ—¶åœ°é‡Šæ”¾ä¸å†ä½¿ç”¨çš„è¿æ¥ç­‰ï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">//if the evictor thread is supposed to run, start it now
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>properties<span style="color:#f92672">.</span><span style="color:#a6e22e">isPoolSweeperEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    poolCleaner <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PoolCleaner<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> properties<span style="color:#f92672">.</span><span style="color:#a6e22e">getTimeBetweenEvictionRunsMillis</span><span style="color:#f92672">());</span>
    poolCleaner<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li><strong>äº‹ä»¶æ‹¦æˆªå™¨</strong>ã€‚Tomcat JDBC è¿æ¥æ± å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Œä»¥ä¾¿æ¥å—è¿æ¥æ± å‘ç”Ÿçš„ä¸€ç³»åˆ—çš„äº‹ä»¶ç­‰é€šçŸ¥ã€‚</li>
<li><strong>åˆå§‹åŒ–è¿æ¥</strong>ã€‚è¿æ¥æ± åˆ›å»ºçš„æ—¶å€™ï¼Œä¼šæ ¹æ®ç”¨æˆ·é…ç½®çš„å±æ€§æ¥é»˜è®¤åˆ›å»º <code>initialSize = 10</code> ä¸ªè¿æ¥æ”¾åˆ°æ± ä¸­ï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">PooledConnection<span style="color:#f92672">[]</span> initialPool <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PooledConnection<span style="color:#f92672">[</span>poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getInitialSize</span><span style="color:#f92672">()];</span>

<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> initialPool<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
    initialPool<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">borrowConnection</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span> <span style="color:#75715e">//don&#39;t wait, should be no contention
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#75715e">//return the members as idle to the pool
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> initialPool<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>initialPool<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnConnection</span><span style="color:#f92672">(</span>initialPool<span style="color:#f92672">[</span>i<span style="color:#f92672">]);}</span><span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception x<span style="color:#f92672">){</span><span style="color:#75715e">/*NOOP*/</span><span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#75715e">//end if
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><h3 id="è¿æ¥æ± é»˜è®¤å±æ€§">è¿æ¥æ± é»˜è®¤å±æ€§</h3>
<p><code>PoolProperties</code> å®šä¹‰äº†è¿æ¥æ± çš„é»˜è®¤å±æ€§ï¼Œç›¸å…³å±æ€§çš„é»˜è®¤å€¼å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>å«ä¹‰</th>
<th>é»˜è®¤å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>initialSize</code></td>
<td>åˆå§‹è¿æ¥æ•°</td>
<td><code>10</code></td>
</tr>
<tr>
<td><code>maxActive</code></td>
<td>æœ€å¤§æ´»è·ƒè¿æ¥æ•°</td>
<td><code>100</code></td>
</tr>
<tr>
<td><code>maxIdle</code></td>
<td>æœ€å¤§ç©ºé—²è¿æ¥æ•°ï¼ˆç©ºé—²è¿æ¥æ± æœ€å¤šå…è®¸ä¿ç•™å¤šå°‘ä¸ªèµ„æºï¼‰</td>
<td><code>100</code></td>
</tr>
<tr>
<td><code>minIdle</code></td>
<td>æœ€å°ç©ºé—²è¿æ¥æ•°ï¼ˆç©ºé—²è¿æ¥æ± æœ€å°‘ä¿ç•™å¤šå°‘ä¸ªèµ„æºï¼‰</td>
<td><code>10</code></td>
</tr>
<tr>
<td><code>maxWait</code></td>
<td>å½“æ²¡æœ‰å¯ç”¨è¿æ¥ä»¥åŠè¾¾åˆ° <code>maxActive</code> æ—¶ï¼Œåº”è¯¥ç­‰å¾…å¤šå°‘æ¯«ç§’ä¹‹åæ‰æŠ›å‡ºå¼‚å¸¸</td>
<td><code>30000</code></td>
</tr>
<tr>
<td><code>validationQueryTimeout</code></td>
<td>æ ¡éªŒè¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡å¤šå°‘ç§’æ‰è®¤ä¸ºè¿™æ¡è¿æ¥ä¸å¯ç”¨äº†ï¼ˆ<code>-1</code> æ„å‘³ç€ä¸è¿›è¡Œè¿™ä¸ªæ ¡éªŒï¼‰</td>
<td><code>-1</code></td>
</tr>
<tr>
<td><code>validationInterval</code></td>
<td>å¤šå°‘æ¯«ç§’æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥</td>
<td><code>3000</code></td>
</tr>
<tr>
<td><code>testOnConnect</code></td>
<td>å»ºç«‹è¿æ¥çš„æ—¶å€™æ˜¯å¦æ‰§è¡Œä¸€æ¬¡æ ¡éªŒ</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>testOnBorrow</code></td>
<td>ä»æ± ä¸­è·å–è¿æ¥çš„æ—¶å€™æ˜¯å¦æ‰§è¡Œä¸€æ¬¡æ ¡éªŒ</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>testOnReturn</code></td>
<td>è¿æ¥è¿˜ç»™è¿æ¥æ± åæ˜¯å¦æ‰§è¡Œä¸€æ¬¡æ ¡éªŒ</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>testWhileIdle</code></td>
<td>è¿æ¥æœªè¢«ä½¿ç”¨çš„æ—¶å€™æ˜¯å¦æ‰§è¡Œæ ¡éªŒ</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>timeBetweenEvictionRunsMillis</code></td>
<td>å¤šå°‘æ¯«ç§’è¿è¡Œä¸€æ¬¡ç©ºé—²è¿æ¥æ£€æŸ¥</td>
<td><code>5000</code></td>
</tr>
<tr>
<td><code>minEvictableIdleTimeMillis</code></td>
<td>ä¸€æ¡è¿æ¥å¤šå°‘æ¯«ç§’æ²¡æœ‰ä½¿ç”¨åæ‰è¢«è®¤ä¸ºæ˜¯ç©ºé—²è¿æ¥</td>
<td><code>60000</code></td>
</tr>
<tr>
<td><code>removeAbandonedTimeout</code></td>
<td>ä¸€æ¡è¿æ¥å¤šå°‘æ¯«ç§’æ‰è¢«äººä¸ºæ˜¯éœ€è¦ abandoned</td>
<td><code>60</code></td>
</tr>
<tr>
<td><code>removeAbandoned</code></td>
<td>è¿æ¥æ ‡è®°ä¸º <code>abandoned</code> ä¹‹åæ˜¯å¦åº”è¯¥ç§»é™¤</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>logAbandoned</code></td>
<td>æ˜¯å¦æ‰“å° <code>abandoned</code> è¿æ¥çš„å¼‚å¸¸æ ˆ</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>fairQueue</code></td>
<td><code>getConnection</code> è¿™ä¸ªè°ƒç”¨æ˜¯å¦åº”è¯¥ä»¥ <code>FIFO</code> çš„é¡ºåºè¿›è¡Œå“åº”</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>abandonWhenPercentageFull</code></td>
<td>ä½¿ç”¨ç‡è¾¾åˆ°å¤šé«˜æ‰è€ƒè™‘ç§»é™¤ <code>abandoned</code> è¿æ¥</td>
<td><code>0</code></td>
</tr>
<tr>
<td><code>maxAge</code></td>
<td>è¿æ¥ç©ºé—²ä¹‹åï¼Œè¶…è¿‡å¤šå°‘æ¯«ç§’æ‰è‡ªåŠ¨è¿æ¥ä¸€æ¬¡</td>
<td><code>0</code></td>
</tr>
<tr>
<td><code>commitOnReturn</code></td>
<td>è¿æ¥è¿˜åˆ°è¿æ¥æ± åï¼Œæ˜¯å¦åº”è¯¥è‡ªåŠ¨ <code>commit</code> ä¸€æ¬¡</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>rollbackOnReturn</code></td>
<td>è¿æ¥è¿˜åˆ°è¿æ¥æ± åï¼Œæ˜¯å¦åº”è¯¥è‡ªåŠ¨ <code>rollback</code> ä¸€æ¬¡</td>
<td><code>false</code></td>
</tr>
</tbody>
</table>
<h2 id="è·å–è¿æ¥">è·å–è¿æ¥</h2>
<p>å…ˆå°è¯•ä»ç©ºé—²é˜Ÿåˆ—è·å–ä¸€ä¸ªè¿æ¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">PooledConnection con <span style="color:#f92672">=</span> idle<span style="color:#f92672">.</span><span style="color:#a6e22e">poll</span><span style="color:#f92672">();</span>

<span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>con<span style="color:#f92672">!=</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//configure the connection and return it
</span><span style="color:#75715e"></span>        PooledConnection result <span style="color:#f92672">=</span> borrowConnection<span style="color:#f92672">(</span>now<span style="color:#f92672">,</span> con<span style="color:#f92672">,</span> username<span style="color:#f92672">,</span> password<span style="color:#f92672">);</span>
        borrowedCount<span style="color:#f92672">.</span><span style="color:#a6e22e">incrementAndGet</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result<span style="color:#f92672">!=</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// ç›´æ¥åˆ›å»ºè¿æ¥
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>size<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//atomic duplicate check
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>size<span style="color:#f92672">.</span><span style="color:#a6e22e">addAndGet</span><span style="color:#f92672">(</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//if we got here, two threads passed through the first if
</span><span style="color:#75715e"></span>            size<span style="color:#f92672">.</span><span style="color:#a6e22e">decrementAndGet</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//create a connection, we&#39;re below the limit
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> createConnection<span style="color:#f92672">(</span>now<span style="color:#f92672">,</span> con<span style="color:#f92672">,</span> username<span style="color:#f92672">,</span> password<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// ç­‰å¾…å¯ç”¨è¿æ¥
</span><span style="color:#75715e"></span>
<span style="color:#f92672">}</span>
</code></pre></div><p>è·å–åˆ°çš„è¿™ä¸ªç©ºé—²è¿æ¥å…¶å®å·²ç»æœ‰å¯èƒ½å¤„äºä¸å¯ç”¨çš„çŠ¶æ€äº†ï¼Œæ‰€ä»¥è¿˜å¾—æ ¹æ®é…ç½®å¯¹å…¶è¿›è¡Œä¸€äº›<strong>æœ‰æ•ˆæ€§æ£€æŸ¥</strong>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">con<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>con<span style="color:#f92672">.</span><span style="color:#a6e22e">isReleased</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">boolean</span> forceReconnect <span style="color:#f92672">=</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">shouldForceReconnect</span><span style="color:#f92672">(</span>username<span style="color:#f92672">,</span> password<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">isMaxAgeExpired</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>con<span style="color:#f92672">.</span><span style="color:#a6e22e">isDiscarded</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>con<span style="color:#f92672">.</span><span style="color:#a6e22e">isInitialized</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//here it states that the connection not discarded, but the connection is null
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//don&#39;t attempt a connect here. It will be done during the reconnect.
</span><span style="color:#75715e"></span>    forceReconnect <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>forceReconnect<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((!</span>con<span style="color:#f92672">.</span><span style="color:#a6e22e">isDiscarded</span><span style="color:#f92672">())</span> <span style="color:#f92672">&amp;&amp;</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span>PooledConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">VALIDATE_BORROW</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//set the timestamp
</span><span style="color:#75715e"></span>        con<span style="color:#f92672">.</span><span style="color:#a6e22e">setTimestamp</span><span style="color:#f92672">(</span>now<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">isLogAbandoned</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//set the stack trace for this pool
</span><span style="color:#75715e"></span>            con<span style="color:#f92672">.</span><span style="color:#a6e22e">setStackTrace</span><span style="color:#f92672">(</span>getThreadDump<span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>busy<span style="color:#f92672">.</span><span style="color:#a6e22e">offer</span><span style="color:#f92672">(</span>con<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            log<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Connection doesn&#39;t fit into busy array, connection will not be traceable.&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> con<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// é€»è¾‘èµ°åˆ°è¿™é‡Œï¼Œé‚£ä¹ˆå†é‡æ–°è¿›è¡Œä¸€æ¬¡è¿æ¥
</span><span style="color:#75715e"></span>
con<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
</code></pre></div><p>ç”±ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œä» <code>idle</code> é˜Ÿåˆ—ä¸­å–å‡ºçš„è¿æ¥ï¼Œåªè¦æ»¡è¶³å¦‚ä¸‹å››ä¸ªæ¡ä»¶å°±è¯¥è¿æ¥æ˜¯æœ‰æ•ˆçš„ï¼Œå¯ä»¥è¿”å›ç»™å®¢æˆ·ç«¯ä½¿ç”¨ï¼š</p>
<ul>
<li>è¿æ¥æ²¡æœ‰è¢«é‡Šæ”¾</li>
<li>è¿æ¥æ²¡æœ‰è¢«ä¸¢å¼ƒ</li>
<li>è¿æ¥ <code>validate</code> å¯ä»¥é€šè¿‡</li>
<li>è¿æ¥å¯ä»¥æ”¾å…¥åˆ° <code>busy</code> é˜Ÿåˆ—é‡Œ</li>
</ul>
<p>å¦‚æœå‘ç°è¿æ¥å·²ç»è¾¾åˆ°äº†æœ€å¤§çš„æœ‰æ•ˆæœŸæˆ–è€…å‘ç°è¿˜ä»æœªçœŸæ­£è¿æ¥è¿‡ï¼Œé‚£ä¹ˆå°±éœ€è¦é‡æ–°è¿æ¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">con<span style="color:#f92672">.</span><span style="color:#a6e22e">reconnect</span><span style="color:#f92672">();</span>
con<span style="color:#f92672">.</span><span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span>validationMode<span style="color:#f92672">);</span>
busy<span style="color:#f92672">.</span><span style="color:#a6e22e">offer</span><span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
</code></pre></div><h3 id="validate-é€»è¾‘"><code>validate</code> é€»è¾‘</h3>
<p>å½“ä» <code>idle</code> å–è¿æ¥çš„æ—¶å€™ï¼Œåªæœ‰ <code>testOnBorrow</code> å±æ€§è®¾ç½®ä¸º <code>true</code> æ‰ä¼šæ‰§è¡Œæ ¡éªŒï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œã€‚æ ¡éªŒé€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸Šæ¬¡æ ¡éªŒå‘¨æœŸå†…ä¸è¿›è¡Œæ ¡éªŒï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">long</span> now <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>validateAction<span style="color:#f92672">!=</span>VALIDATE_INIT <span style="color:#f92672">&amp;&amp;</span>
    poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getValidationInterval</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">&amp;&amp;</span>
    <span style="color:#f92672">(</span>now <span style="color:#f92672">-</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lastValidated</span><span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span>
    poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getValidationInterval</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>å‘é€ç›¸å…³ç”¨äºæ ¡éªŒçš„ SQL æŸ¥è¯¢è¯­å¥ï¼Œèƒ½æ­£å¸¸æŸ¥è¯¢è¿”å›ï¼Œæ²¡æœ‰æŠ¥ <code>SQLException</code> å°±è®¤ä¸ºæ ¡éªŒé€šè¿‡ï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">query <span style="color:#f92672">=</span> poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getValidationQuery</span><span style="color:#f92672">();</span>
stmt <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span><span style="color:#a6e22e">createStatement</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">int</span> validationQueryTimeout <span style="color:#f92672">=</span> poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getValidationQueryTimeout</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>validationQueryTimeout <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    stmt<span style="color:#f92672">.</span><span style="color:#a6e22e">setQueryTimeout</span><span style="color:#f92672">(</span>validationQueryTimeout<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

stmt<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>query<span style="color:#f92672">);</span>
stmt<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lastValidated</span> <span style="color:#f92672">=</span> now<span style="color:#f92672">;</span>
<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</code></pre></div><h3 id="ismaxageexpired-é€»è¾‘"><code>isMaxAgeExpired</code> é€»è¾‘</h3>
<p>è¿æ¥æ˜¯å¦å·²ç»è¿‡æœŸçš„åˆ¤æ–­é€»è¾‘ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isMaxAgeExpired</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">getMaxAge</span><span style="color:#f92672">()&gt;</span>0 <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> getLastConnected<span style="color:#f92672">())</span> <span style="color:#f92672">&gt;</span> getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">getMaxAge</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="reconnect-é€»è¾‘"><code>reconnect</code> é€»è¾‘</h3>
<p>é‡æ–°è¿æ¥é€»è¾‘é¦–å…ˆå°†è¿æ¥ä¸¢å¼ƒæ‰ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">reconnect</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> SQLException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">disconnect</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">connect</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">disconnect</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> finalize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    setDiscarded<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>connection <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        connection<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    lastConnected <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ç„¶åå†é€šè¿‡æ•°æ®åº“é©±åŠ¨æ‰§è¡Œä¸€æ¬¡çœŸæ­£çš„åº•å±‚è¿æ¥ <code>connect</code> ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">driver <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">sql</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Driver</span><span style="color:#f92672">)</span>
    ClassLoaderUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">loadClass</span><span style="color:#f92672">(</span>
        poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getDriverClassName</span><span style="color:#f92672">(),</span>
        PooledConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">(),</span>
        Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getContextClassLoader</span><span style="color:#f92672">()</span>
    <span style="color:#f92672">).</span><span style="color:#a6e22e">getConstructor</span><span style="color:#f92672">().</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">();</span>
connection <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span><span style="color:#a6e22e">connect</span><span style="color:#f92672">(</span>driverURL<span style="color:#f92672">,</span> properties<span style="color:#f92672">);</span>
<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">discarded</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lastConnected</span> <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</code></pre></div><h3 id="ç­‰å¾…å¯ç”¨è¿æ¥">ç­‰å¾…å¯ç”¨è¿æ¥</h3>
<p>å°è¯•ç­‰å¾… <code>maxWait</code> æ¯«ç§’çš„æ—¶é—´ï¼Œå¦‚æœç­‰å¾…ä¸åˆ°ï¼Œé‚£ä¹ˆæŠ›å‡º <code>PoolExhaustedException</code> å¼‚å¸¸ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">//calculate wait time for this iteration
</span><span style="color:#75715e"></span><span style="color:#66d9ef">long</span> maxWait <span style="color:#f92672">=</span> wait<span style="color:#f92672">;</span>
<span style="color:#75715e">//if the passed in wait time is -1, means we should use the pool property value
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>wait<span style="color:#f92672">==-</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    maxWait <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">getMaxWait</span><span style="color:#f92672">()&lt;=</span>0<span style="color:#f92672">)?</span>Long<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">:</span>getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">getMaxWait</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">long</span> timetowait <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> maxWait <span style="color:#f92672">-</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> now<span style="color:#f92672">));</span>
con <span style="color:#f92672">=</span> idle<span style="color:#f92672">.</span><span style="color:#a6e22e">poll</span><span style="color:#f92672">(</span>timetowait<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>

<span style="color:#75715e">//we didn&#39;t get a connection, lets see if we timed out
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>con <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> now<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;=</span> maxWait<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> PoolExhaustedException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[&#34;</span> <span style="color:#f92672">+</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34;] &#34;</span> <span style="color:#f92672">+</span>
            <span style="color:#e6db74">&#34;Timeout: Pool empty. Unable to fetch a connection in &#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>maxWait <span style="color:#f92672">/</span> 1000<span style="color:#f92672">)</span> <span style="color:#f92672">+</span>
            <span style="color:#e6db74">&#34; seconds, none available[size:&#34;</span><span style="color:#f92672">+</span>size<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;; busy:&#34;</span><span style="color:#f92672">+</span>busy<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34;; idle:&#34;</span><span style="color:#f92672">+</span>idle<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34;; lastwait:&#34;</span><span style="color:#f92672">+</span>timetowait<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;].&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//no timeout, lets try again
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="å½’è¿˜è¿æ¥">å½’è¿˜è¿æ¥</h2>
<p>å½’è¿˜è¿æ¥å…¶å®å°±æ˜¯ä» <code>busy</code> é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå½“ä¸éœ€è¦å…³é—­è¿æ¥çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¼šé‡æ–°æ”¾å…¥åˆ° <code>idle</code> ç©ºé—²é˜Ÿåˆ—ä¸­ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>busy<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>con<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>shouldClose<span style="color:#f92672">(</span>con<span style="color:#f92672">,</span>PooledConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">VALIDATE_RETURN</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> reconnectIfExpired<span style="color:#f92672">(</span>con<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        con<span style="color:#f92672">.</span><span style="color:#a6e22e">setTimestamp</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(((</span>idle<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()&gt;=</span>poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxIdle</span><span style="color:#f92672">())</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">isPoolSweeperEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(!</span>idle<span style="color:#f92672">.</span><span style="color:#a6e22e">offer</span><span style="color:#f92672">(</span>con<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
            release<span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        release<span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#75715e">//end if
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    release<span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>åˆ¤æ–­è¿æ¥å½’è¿˜çš„æ—¶å€™éœ€è¦éœ€è¦å…³é—­ï¼Œå…¶ä¸»è¦çœ‹çš„è¿˜æ˜¯ <code>validate</code> å‡½æ•°ï¼Œå½“ <code>testOnReturn</code> å±æ€§æ‰“å¼€çš„æ—¶å€™æ‰ä¼šåœ¨å½’è¿˜çš„æ—¶å€™æ‰§è¡Œæ ¡éªŒï¼Œæ ¡éªŒä¸é€šè¿‡çš„æ—¶å€™ï¼Œä¼šç›´æ¥é‡Šæ”¾æ‰è¿æ¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>action <span style="color:#f92672">==</span> PooledConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">VALIDATE_RETURN</span> <span style="color:#f92672">&amp;&amp;</span>
    poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">isTestOnReturn</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// validate è¿”å›æˆåŠŸ
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>å¦å¤–ä¸€ä¸ªçœ‹çš„ç‚¹æ˜¯åœ¨å½’è¿˜è¿æ¥åˆ° <code>idle</code> é˜Ÿåˆ—ä¹‹å‰ï¼Œæ˜¯å¦èƒ½å¤Ÿæ­£å¸¸ç»“æŸå½“å‰äº‹åŠ¡ï¼Œè¿˜ä¹‹å‰æ˜¯å¦åº”è¯¥ä¸»åŠ¨è°ƒç”¨ <code>rollback</code> æˆ–è€… <code>commit</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">terminateTransaction</span><span style="color:#f92672">(</span>PooledConnection con<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>con<span style="color:#f92672">.</span><span style="color:#a6e22e">getPoolProperties</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDefaultAutoCommit</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPoolProperties</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getRollbackOnReturn</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">boolean</span> autocommit <span style="color:#f92672">=</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">getConnection</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAutoCommit</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>autocommit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    con<span style="color:#f92672">.</span><span style="color:#a6e22e">getConnection</span><span style="color:#f92672">().</span><span style="color:#a6e22e">rollback</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPoolProperties</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getCommitOnReturn</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">boolean</span> autocommit <span style="color:#f92672">=</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">getConnection</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAutoCommit</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>autocommit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    con<span style="color:#f92672">.</span><span style="color:#a6e22e">getConnection</span><span style="color:#f92672">().</span><span style="color:#a6e22e">commit</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>SQLException x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unable to terminate transaction, connection will be closed.&#34;</span><span style="color:#f92672">,</span>x<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="é‡Šæ”¾è¿æ¥">é‡Šæ”¾è¿æ¥</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">release</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    disconnect<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="è¿æ¥æ± æ¸…ç†å™¨">è¿æ¥æ± æ¸…ç†å™¨</h2>
<p>åå°è¿è¡Œçš„è¿æ¥æ± æ¸…ç†å™¨ä¸»è¦æ˜¯å¹²äº†å¦‚ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>æ·˜æ±° <code>abandoned</code> è¿æ¥</li>
<li>ç¼©å®¹ <code>idle</code> è¿æ¥æ± </li>
<li>æ¢æ´» <code>idle</code> è¿æ¥</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PoolCleaner</span> <span style="color:#66d9ef">extends</span> TimerTask <span style="color:#f92672">{</span>

    <span style="color:#75715e">// é»˜è®¤ 30 ç§’
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">long</span> sleepTime<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pool<span style="color:#f92672">.</span><span style="color:#a6e22e">getPoolProperties</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isRemoveAbandoned</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">||</span> pool<span style="color:#f92672">.</span><span style="color:#a6e22e">getPoolProperties</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getSuspectTimeout</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                pool<span style="color:#f92672">.</span><span style="color:#a6e22e">checkAbandoned</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pool<span style="color:#f92672">.</span><span style="color:#a6e22e">getPoolProperties</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getMinIdle</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> pool<span style="color:#f92672">.</span><span style="color:#a6e22e">idle</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                pool<span style="color:#f92672">.</span><span style="color:#a6e22e">checkIdle</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pool<span style="color:#f92672">.</span><span style="color:#a6e22e">getPoolProperties</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isTestWhileIdle</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                pool<span style="color:#f92672">.</span><span style="color:#a6e22e">testAllIdle</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pool<span style="color:#f92672">.</span><span style="color:#a6e22e">getPoolProperties</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getMaxAge</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                pool<span style="color:#f92672">.</span><span style="color:#a6e22e">testAllIdle</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> x<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><h3 id="checkabandoned-é€»è¾‘"><code>checkAbandoned</code> é€»è¾‘</h3>
<p>ä¸»åŠ¨ä¸¢å¼ƒ <code>busy</code> é˜Ÿåˆ—ä¸­è¿è¡Œæ—¶é—´å¤§äº <code>abandonTimeout</code> æ—¶é—´çš„è¿æ¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">Iterator<span style="color:#f92672">&lt;</span>PooledConnection<span style="color:#f92672">&gt;</span> locked <span style="color:#f92672">=</span> busy<span style="color:#f92672">.</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">int</span> sto <span style="color:#f92672">=</span> getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">getSuspectTimeout</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>locked<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    PooledConnection con <span style="color:#f92672">=</span> locked<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">//the con has been returned to the pool or released
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//ignore it
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>idle<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>con<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">isReleased</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">long</span> time <span style="color:#f92672">=</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">getTimestamp</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">long</span> now <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldAbandon<span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>now <span style="color:#f92672">-</span> time<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">getAbandonTimeout</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        busy<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
        abandon<span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
        setToNull <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sto <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>now <span style="color:#f92672">-</span> time<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> <span style="color:#f92672">(</span>sto <span style="color:#f92672">*</span> 1000L<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        suspect<span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å…¶ä¸­ <code>shouldAbandon()</code> å‡½æ•°å¦‚ä¸‹ï¼Œå…¶æ„åœ¨é˜æ˜å½“å½“å‰æ­£åœ¨ä½¿ç”¨çš„è¿æ¥è¾¾åˆ°è¾ƒé«˜æ•°é‡çš„æ—¶å€™ï¼Œåº”è¯¥å°†å…¶ä¸»åŠ¨ä¸¢å¼ƒã€‚è¾ƒé«˜æ•°é‡æ˜¯æŒ‡ <code>used / max &gt;= abandonWhenPercentageFull</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldAbandon</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">isRemoveAbandoned</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getAbandonWhenPercentageFull</span><span style="color:#f92672">()==</span>0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">float</span> used <span style="color:#f92672">=</span> busy<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">float</span> max  <span style="color:#f92672">=</span> poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">float</span> perc <span style="color:#f92672">=</span> poolProperties<span style="color:#f92672">.</span><span style="color:#a6e22e">getAbandonWhenPercentageFull</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>used<span style="color:#f92672">/</span>max<span style="color:#f92672">*</span>100f<span style="color:#f92672">)&gt;=</span>perc<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>è€Œ <code>abandon</code> è¿æ¥å…¶å®æ˜¯æ‰“å°è¯¥è¿æ¥çš„å¼‚å¸¸ä¿¡æ¯æ ˆï¼Œå¹¶ <code>release</code> è¿æ¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">String trace <span style="color:#f92672">=</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">getStackTrace</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">isLogAbandoned</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Connection has been abandoned &#34;</span> <span style="color:#f92672">+</span> con <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> trace<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

release<span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
</code></pre></div><h3 id="checkidle-é€»è¾‘"><code>checkIdle</code> é€»è¾‘</h3>
<p>åªè¦å½“å‰ <code>idle</code> è¿æ¥æ± æ¯”æœ€å° <code>idle</code> æ•°é‡å¤§ï¼Œé‚£ä¹ˆå°±é€ä¸ªé‡Šæ”¾/æ·˜æ±°è¿æ¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">long</span> now <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
Iterator<span style="color:#f92672">&lt;</span>PooledConnection<span style="color:#f92672">&gt;</span> unlocked <span style="color:#f92672">=</span> idle<span style="color:#f92672">.</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span> <span style="color:#f92672">(</span>ignoreMinSize <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>idle<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()&gt;=</span>getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">getMinIdle</span><span style="color:#f92672">()))</span> <span style="color:#f92672">&amp;&amp;</span> unlocked<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    PooledConnection con <span style="color:#f92672">=</span> unlocked<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
    con<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">//the con been taken out, we can&#39;t clean it up
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>busy<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>con<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">long</span> time <span style="color:#f92672">=</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">getTimestamp</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldReleaseIdle<span style="color:#f92672">(</span>now<span style="color:#f92672">,</span> con<span style="color:#f92672">,</span> time<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        release<span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
        idle<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//do nothing
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#75715e">//end if
</span><span style="color:#75715e"></span>
    con<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span> <span style="color:#75715e">//while
</span></code></pre></div><p>å…¶ä¸­ <code>releaseTime</code> æ­£æ˜¯é…ç½®çš„ <code>minEvictableIdleTimeMillis</code> å±æ€§ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldReleaseIdle</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> now<span style="color:#f92672">,</span> PooledConnection con<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> time<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>con<span style="color:#f92672">.</span><span style="color:#a6e22e">getConnectionVersion</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> getPoolVersion<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>con<span style="color:#f92672">.</span><span style="color:#a6e22e">getReleaseTime</span><span style="color:#f92672">()&gt;</span>0<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">((</span>now <span style="color:#f92672">-</span> time<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> con<span style="color:#f92672">.</span><span style="color:#a6e22e">getReleaseTime</span><span style="color:#f92672">())</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>getSize<span style="color:#f92672">()&gt;</span>getPoolProperties<span style="color:#f92672">().</span><span style="color:#a6e22e">getMinIdle</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getReleaseTime</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">poolProperties</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMinEvictableIdleTimeMillis</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="testallidle-é€»è¾‘"><code>testAllIdle</code> é€»è¾‘</h3>
<p><code>testAllIdle</code> è´Ÿè´£å¯¹ <code>idle</code> çº¿ç¨‹æ± æ£€æŸ¥æ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸæˆ–è€… <code>validate</code> å¤±è´¥åˆ™ä» <code>idle</code> è¿æ¥æ± ä¸­ç§»é™¤æ‰è¯¥è¿æ¥ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">Iterator<span style="color:#f92672">&lt;</span>PooledConnection<span style="color:#f92672">&gt;</span> unlocked <span style="color:#f92672">=</span> idle<span style="color:#f92672">.</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>unlocked<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    PooledConnection con <span style="color:#f92672">=</span> unlocked<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
    con<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    
    <span style="color:#75715e">//the con been taken out, we can&#39;t clean it up
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>busy<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>con<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">boolean</span> release<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>checkMaxAgeOnly<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        release <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>reconnectIfExpired<span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        release <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>reconnectIfExpired<span style="color:#f92672">(</span>con<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>con<span style="color:#f92672">.</span><span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span>PooledConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">VALIDATE_IDLE</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>release<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        idle<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
        release<span style="color:#f92672">(</span>con<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    con<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="æ‹¦æˆªå™¨">æ‹¦æˆªå™¨</h2>
<p>å¦å¤– Tomcat JDBC Pool å†…ç½®äº†<strong>æ…¢æŸ¥è¯¢æ‹¦æˆªå™¨</strong>ï¼Œå¼€å¯åå…¶ä¼šåœ¨å†…å­˜ä¸­ä¸»åŠ¨è·Ÿè¸ª 1000 æ¡è€—æ—¶å¤§äº 1 ç§’ä»¥ä¸Šçš„æ…¢æŸ¥è¯¢ SQL è¯­å¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SlowQueryReport</span> <span style="color:#66d9ef">extends</span> AbstractQueryReport  <span style="color:#f92672">{</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Maximum number of queries we will be storing
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">int</span>  maxQueries<span style="color:#f92672">=</span> 1000<span style="color:#f92672">;</span> <span style="color:#75715e">//don&#39;t store more than this amount of queries
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Flag to enable disable logging of slow queries
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> logSlow <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Flag to enable disable logging of failed queries
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> logFailed <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * the queries that are used for this interceptor.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">volatile</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span>QueryStats<span style="color:#f92672">&gt;</span> queries <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>æ…¢æŸ¥è¯¢è¯­å¥çš„ç»Ÿè®¡æ˜¯é€šè¿‡åŠ¨æ€ä»£ç† <code>Statement</code> å®ç°çš„ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractQueryReport</span> <span style="color:#66d9ef">extends</span> AbstractCreateStatementInterceptor <span style="color:#f92672">{</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * The threshold in milliseconds. If the query is faster than this, we don&#39;t measure it
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">long</span> threshold <span style="color:#f92672">=</span> 1000<span style="color:#f92672">;</span> <span style="color:#75715e">//don&#39;t report queries less than this
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">createStatement</span><span style="color:#f92672">(</span>Object proxy<span style="color:#f92672">,</span> Method method<span style="color:#f92672">,</span> Object<span style="color:#f92672">[]</span> args<span style="color:#f92672">,</span> Object statement<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> time<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        result <span style="color:#f92672">=</span> constructor<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">new</span> StatementProxy<span style="color:#f92672">(</span>statement<span style="color:#f92672">,</span>sql<span style="color:#f92672">)</span> <span style="color:#f92672">});</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StatementProxy</span> <span style="color:#66d9ef">implements</span> InvocationHandler <span style="color:#f92672">{</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>Object proxy<span style="color:#f92672">,</span> Method method<span style="color:#f92672">,</span> Object<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Throwable <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">long</span> start <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>process<span style="color:#f92672">)?</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">():</span>0<span style="color:#f92672">;</span>
            
            <span style="color:#75715e">//execute the query
</span><span style="color:#75715e"></span>            result <span style="color:#f92672">=</span>  method<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>delegate<span style="color:#f92672">,</span>args<span style="color:#f92672">);</span>

            <span style="color:#75715e">//measure the time
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">long</span> delta <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>process<span style="color:#f92672">)?(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()-</span>start<span style="color:#f92672">):</span>Long<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span><span style="color:#f92672">;</span>

            <span style="color:#75715e">//measure the time
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">long</span> delta <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>process<span style="color:#f92672">)?(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()-</span>start<span style="color:#f92672">):</span>Long<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span><span style="color:#f92672">;</span>
            
            <span style="color:#75715e">//see if we meet the requirements to measure
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delta<span style="color:#f92672">&gt;</span>threshold<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">//report the slow query
</span><span style="color:#75715e"></span>                    reportSlowQuery<span style="color:#f92672">(</span>query<span style="color:#f92672">,</span> args<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> start<span style="color:#f92672">,</span> delta<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>log<span style="color:#f92672">.</span><span style="color:#a6e22e">isWarnEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                      log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unable to process slow query&#34;</span><span style="color:#f92672">,</span>t<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div>
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#åˆ›å»ºè¿æ¥æ± ">åˆ›å»ºè¿æ¥æ± </a>
      <ul>
        <li><a href="#è¿æ¥æ± é»˜è®¤å±æ€§">è¿æ¥æ± é»˜è®¤å±æ€§</a></li>
      </ul>
    </li>
    <li><a href="#è·å–è¿æ¥">è·å–è¿æ¥</a>
      <ul>
        <li><a href="#validate-é€»è¾‘"><code>validate</code> é€»è¾‘</a></li>
        <li><a href="#ismaxageexpired-é€»è¾‘"><code>isMaxAgeExpired</code> é€»è¾‘</a></li>
        <li><a href="#reconnect-é€»è¾‘"><code>reconnect</code> é€»è¾‘</a></li>
        <li><a href="#ç­‰å¾…å¯ç”¨è¿æ¥">ç­‰å¾…å¯ç”¨è¿æ¥</a></li>
      </ul>
    </li>
    <li><a href="#å½’è¿˜è¿æ¥">å½’è¿˜è¿æ¥</a>
      <ul>
        <li><a href="#é‡Šæ”¾è¿æ¥">é‡Šæ”¾è¿æ¥</a></li>
      </ul>
    </li>
    <li><a href="#è¿æ¥æ± æ¸…ç†å™¨">è¿æ¥æ± æ¸…ç†å™¨</a>
      <ul>
        <li><a href="#checkabandoned-é€»è¾‘"><code>checkAbandoned</code> é€»è¾‘</a></li>
        <li><a href="#checkidle-é€»è¾‘"><code>checkIdle</code> é€»è¾‘</a></li>
        <li><a href="#testallidle-é€»è¾‘"><code>testAllIdle</code> é€»è¾‘</a></li>
      </ul>
    </li>
    <li><a href="#æ‹¦æˆªå™¨">æ‹¦æˆªå™¨</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>



</html>












