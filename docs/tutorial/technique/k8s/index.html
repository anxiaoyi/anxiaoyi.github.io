<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Kubernetes"><meta property="og:title" content="Kubernetes" />
<meta property="og:description" content="Kubernetes Kubernetes å‘éŸ³ /Koo-ber-nay-tace/ æˆ–è€… /Koo-ber-netties/ ã€‚
è§£å†³çš„é—®é¢˜ å¾®æœåŠ¡éƒ¨ç½²å’Œé…ç½®å›°éš¾ã€‚
 ç®€åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€‚å¼€å‘è€…æ— é¡»çŸ¥é“èƒŒåæœ‰å¤šå°‘å°æœºå™¨éœ€è¦éƒ¨ç½²ï¼Œä¹Ÿæ— éœ€çŸ¥é“è‡ªå·±çš„ APP è¿è¡Œåœ¨å“ªå‡ å°æœºå™¨ä¸Šã€‚ å¯¹äºèµ„æºçš„æ›´ä¸ºé«˜æ•ˆçš„åˆ©ç”¨ã€‚K8S å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»å°† APP è¿ç§»åˆ°å…¶ä»– worker èŠ‚ç‚¹ä¸Šï¼Œä»¥ä¾¿æ›´å¥½çš„åˆ©ç”¨èµ„æºã€‚ å¥åº·æ£€æŸ¥ã€‚node æŒ‚æ‰åï¼Œè‡ªåŠ¨å°† APP è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚ è‡ªåŠ¨ä¼¸ç¼©ã€‚K8S å¯ä»¥è‡ªå·±å…³æ³¨èµ„æºçš„åˆ©ç”¨ç‡ï¼ŒåŠ¨æ€è°ƒæ•´ APP çš„å®ä¾‹æ•°é‡ã€‚  æ¦‚å¿µè§£é‡Š VM å’Œå®¹å™¨ APP è¿è¡Œåœ¨ VM ä¸­ APP è¿è¡Œåœ¨å®¹å™¨ä¸­ Pod ä¸€ä¸ª Pod æ˜¯ä¸€ç»„äº’ç›¸åä½œçš„å®¹å™¨æ„æˆçš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Pod ä»…åŒ…å«ä¸€ä¸ªå®¹å™¨ï¼š
å®¹å™¨è®¾è®¡åˆè¡·å°±æ˜¯ä¸ºäº†ä¸€ä¸ªå®¹å™¨ä»…è¿è¡Œä¸€ä¸ªè¿›ç¨‹çš„ç†å¿µå»è¿è¡Œç¨‹åºï¼Œå¦‚æœè¿è¡Œå¤šä¸ªï¼Œé‚£ä¹ˆå®ƒä»¬çš„çŠ¶æ€ã€ç”Ÿå‘½å‘¨æœŸã€æ—¥å¿—ç­‰éƒ½éš¾ä»¥ç®¡ç†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ç«™åœ¨æ›´é«˜å±‚çº§æ¥å»ç®¡ç†ã€ç»„ç»‡ã€å•å…ƒåŒ–åˆ†å¸ƒåœ¨å¤šä¸ªå®¹å™¨ä¸­çš„å¤šä¸ªè¿›ç¨‹ï¼Œè¿™å°±æ˜¯å¼•å…¥ Pod çš„æ„ä¹‰ã€‚Pod æ¥å»ç»™ä¸€ç»„å®¹å™¨ä¸­çš„å„ä¸ªè¿›ç¨‹æä¾›ä¸€ç§å‡è±¡ï¼Œè®©è¿™äº›è¿›ç¨‹è®¤ä¸ºå„è‡ªéƒ½è¿è¡Œåœ¨ä¸€ä¸ªå®¹å™¨é‡Œä¼¼çš„ï¼ŒåŒæ—¶åœ¨éœ€è¦éš”ç¦»çš„æ—¶å€™ï¼Œä¹Ÿèƒ½æä¾›éš”ç¦»çš„èƒ½åŠ›ã€‚
è¿è¡Œåœ¨ç›¸åŒ Pod ä¸­çš„å„ä¸ªå®¹å™¨ï¼Œå®ƒä»¬çš„ IP å’Œç«¯å£èµ„æºæ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥ä¸è¦è®©å®ƒä»¬å¼•èµ·ç«¯å£å†²çªã€‚Pod æ˜¯è½»é‡çº§çš„ï¼Œåº”è¯¥å°†ä¸€ä¸ªåº”ç”¨ç¨‹åºåˆ†ä¸ºå¤šä¸ª Podï¼Œè€Œä¸æ˜¯åœ¨ä¸€ä¸ª Pod ä¸­å¡å…¥æ‰€æœ‰ä¸œè¥¿ã€‚ä»…å½“è¿™äº›è¿›ç¨‹æ˜¯äº’ç›¸åä½œã€å¿…é¡»åŒæ—¶è¿è¡Œã€å¿…é¡»åŒæ—¶æ‰©å±•ã€å¯¹å¤–æ˜¯ä¸€ä¸ªæ•´ä½“æœåŠ¡ç­‰è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘å°†å¤šä¸ªå®¹å™¨æ”¾åœ¨ä¸€ä¸ª Pod ä¸­è¿›è¡Œç®¡ç†ã€‚
ä½¿ç”¨ cubectl create æ¥åˆ›å»ºä¸€ä¸ª Podï¼š
$ kubectl create -f kubia-manual." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/tutorial/technique/k8s/" />

<title>Kubernetes | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.7ebac727e739c3b4aee6328926e3b77ac1ddd5e9035221b7ec206fda1a413a4d.css" integrity="sha256-frrHJ&#43;c5w7Su5jKJJuO3esHd1ekDUiG37CBv2hpBOk0=">


<script defer src="/en.search.min.b64381d91cbe281d9eb128bd4081af0e0b892adf420fce7a87f2b53a48a3a5b1.js" integrity="sha256-tkOB2Ry&#43;KB2esSi9QIGvDguJKt9CD856h/K1OkijpbE="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/front-end-optimization-guide/" >
      å‰ç«¯ä¼˜åŒ–æŒ‡å—
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/algorithm/" >
      ç®—æ³•
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/raft/" >
      raft
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-command/" >
      UNIX å¸¸ç”¨å‘½ä»¤å¤§å…¨
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-optimize/" >
      UNIX æ€§èƒ½ä¼˜åŒ–
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/vue3/" >
      Vue.js æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/git/" >
      Git æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/network/" >
      ç½‘ç»œåè®®
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/awk/" >
      AWK æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/devops/" >
      DevOps
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/sentinel/" >
      é˜¿é‡Œå·´å·´ Sentinel
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/zipkin/" >
      Zipkin æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/eureka/" >
      Netflix Eureka æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed-storage/" >
      åˆ†å¸ƒå¼å­˜å‚¨
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/maven/" >
      Maven æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/java/" >
      Java æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/spring/" >
      Spring æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed/" >
      åˆ†å¸ƒå¼ç³»ç»Ÿä¸æ¶æ„è®¾è®¡
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/softskill/" >
      ç®´è¨€ç®´å¥
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/database/" >
      æ•°æ®åº“
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/redis/" >
      Redis
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/bigdata/" >
      å¤§æ•°æ®åœºæ™¯
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/technique/" >
      æŠ€æœ¯
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/tutorial/technique/k8s/"  class="active">
      Kubernetes
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/technique/k8s-patterns/" >
      Kubernetes Patterns
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/technique/istio/" >
      Istio
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Kubernetes</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#è§£å†³çš„é—®é¢˜">è§£å†³çš„é—®é¢˜</a></li>
    <li><a href="#æ¦‚å¿µè§£é‡Š">æ¦‚å¿µè§£é‡Š</a>
      <ul>
        <li><a href="#vm-å’Œå®¹å™¨">VM å’Œå®¹å™¨</a></li>
        <li><a href="#pod">Pod</a></li>
        <li><a href="#docker-è¿è¡Œ-k8s">Docker è¿è¡Œ K8S</a></li>
        <li><a href="#k8s-é›†ç¾¤">K8S é›†ç¾¤</a></li>
        <li><a href="#k8s-è¿è¡Œ-app">K8S è¿è¡Œ APP</a></li>
        <li><a href="#æ§åˆ¶å™¨">æ§åˆ¶å™¨</a></li>
        <li><a href="#serviceä¸-pod-æ²Ÿé€š">Serviceï¼šä¸ Pod æ²Ÿé€š</a></li>
        <li><a href="#configmaps-å’Œç§˜é’¥">ConfigMaps å’Œç§˜é’¥</a></li>
        <li><a href="#volume">Volume</a></li>
        <li><a href="#æ›´æ–°">æ›´æ–°</a></li>
      </ul>
    </li>
    <li><a href="#k8s-æœºåˆ¶">K8S æœºåˆ¶</a>
      <ul>
        <li><a href="#k8s-æ¶æ„">K8S æ¶æ„</a></li>
        <li><a href="#k8s-ç½‘ç»œ">K8S ç½‘ç»œ</a></li>
        <li><a href="#k8s-è°ƒåº¦å™¨">K8S è°ƒåº¦å™¨</a></li>
        <li><a href="#k8s-æ°´å¹³ä¼¸ç¼©">K8S æ°´å¹³ä¼¸ç¼©</a></li>
        <li><a href="#k8s-é«˜å¯ç”¨">K8S é«˜å¯ç”¨</a></li>
        <li><a href="#k8s-èµ„æºæ§åˆ¶">K8S èµ„æºæ§åˆ¶</a></li>
        <li><a href="#æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script><h1 id="kubernetes">Kubernetes</h1>
<p>Kubernetes å‘éŸ³ <code>/Koo-ber-nay-tace/</code> æˆ–è€… <code>/Koo-ber-netties/</code> ã€‚</p>
<h2 id="è§£å†³çš„é—®é¢˜">è§£å†³çš„é—®é¢˜</h2>
<p>å¾®æœåŠ¡éƒ¨ç½²å’Œé…ç½®å›°éš¾ã€‚</p>
<ul>
<li><strong>ç®€åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²</strong>ã€‚å¼€å‘è€…æ— é¡»çŸ¥é“èƒŒåæœ‰å¤šå°‘å°æœºå™¨éœ€è¦éƒ¨ç½²ï¼Œä¹Ÿæ— éœ€çŸ¥é“è‡ªå·±çš„ APP è¿è¡Œåœ¨å“ªå‡ å°æœºå™¨ä¸Šã€‚</li>
<li><strong>å¯¹äºèµ„æºçš„æ›´ä¸ºé«˜æ•ˆçš„åˆ©ç”¨</strong>ã€‚K8S å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»å°† APP è¿ç§»åˆ°å…¶ä»– worker èŠ‚ç‚¹ä¸Šï¼Œä»¥ä¾¿æ›´å¥½çš„åˆ©ç”¨èµ„æºã€‚</li>
<li><strong>å¥åº·æ£€æŸ¥</strong>ã€‚node æŒ‚æ‰åï¼Œè‡ªåŠ¨å°† APP è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚</li>
<li><strong>è‡ªåŠ¨ä¼¸ç¼©</strong>ã€‚K8S å¯ä»¥è‡ªå·±å…³æ³¨èµ„æºçš„åˆ©ç”¨ç‡ï¼ŒåŠ¨æ€è°ƒæ•´ APP çš„å®ä¾‹æ•°é‡ã€‚</li>
</ul>
<h2 id="æ¦‚å¿µè§£é‡Š">æ¦‚å¿µè§£é‡Š</h2>
<h3 id="vm-å’Œå®¹å™¨">VM å’Œå®¹å™¨</h3>
<div class="book-columns flex flex-wrap">
  
  <div class="flex-even markdown-inner">
    <h3 id="app-è¿è¡Œåœ¨-vm-ä¸­">APP è¿è¡Œåœ¨ VM ä¸­</h3>
<p><img src="/images/docs/tutorial/technique/k8s/app-running-in-vm.png" alt="">
  </div>
  
  <div class="flex-even markdown-inner">
    <h3 id="app-è¿è¡Œåœ¨å®¹å™¨ä¸­">APP è¿è¡Œåœ¨å®¹å™¨ä¸­</h3>
<p><img src="/images/docs/tutorial/technique/k8s/app-running-in-container.png" alt="">
  </div>
  
</div>

<h3 id="pod">Pod</h3>
<p>ä¸€ä¸ª Pod æ˜¯<strong>ä¸€ç»„äº’ç›¸åä½œçš„å®¹å™¨</strong>æ„æˆçš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Pod ä»…åŒ…å«ä¸€ä¸ªå®¹å™¨ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-12_22-01.png" alt=""></p>
<p>å®¹å™¨è®¾è®¡åˆè¡·å°±æ˜¯ä¸ºäº†<strong>ä¸€ä¸ªå®¹å™¨ä»…è¿è¡Œä¸€ä¸ªè¿›ç¨‹</strong>çš„ç†å¿µå»è¿è¡Œç¨‹åºï¼Œå¦‚æœè¿è¡Œå¤šä¸ªï¼Œé‚£ä¹ˆå®ƒä»¬çš„çŠ¶æ€ã€ç”Ÿå‘½å‘¨æœŸã€æ—¥å¿—ç­‰éƒ½éš¾ä»¥ç®¡ç†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ç«™åœ¨æ›´é«˜å±‚çº§æ¥å»<strong>ç®¡ç†ã€ç»„ç»‡ã€å•å…ƒåŒ–</strong>åˆ†å¸ƒåœ¨å¤šä¸ªå®¹å™¨ä¸­çš„å¤šä¸ªè¿›ç¨‹ï¼Œè¿™å°±æ˜¯å¼•å…¥ Pod çš„æ„ä¹‰ã€‚Pod æ¥å»ç»™ä¸€ç»„å®¹å™¨ä¸­çš„å„ä¸ªè¿›ç¨‹æä¾›ä¸€ç§å‡è±¡ï¼Œè®©è¿™äº›è¿›ç¨‹è®¤ä¸ºå„è‡ªéƒ½è¿è¡Œåœ¨ä¸€ä¸ªå®¹å™¨é‡Œä¼¼çš„ï¼ŒåŒæ—¶åœ¨éœ€è¦éš”ç¦»çš„æ—¶å€™ï¼Œä¹Ÿèƒ½æä¾›éš”ç¦»çš„èƒ½åŠ›ã€‚</p>
<p>è¿è¡Œåœ¨ç›¸åŒ Pod ä¸­çš„å„ä¸ªå®¹å™¨ï¼Œå®ƒä»¬çš„ IP å’Œç«¯å£èµ„æºæ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥ä¸è¦è®©å®ƒä»¬å¼•èµ·ç«¯å£å†²çªã€‚Pod æ˜¯è½»é‡çº§çš„ï¼Œåº”è¯¥å°†ä¸€ä¸ªåº”ç”¨ç¨‹åºåˆ†ä¸ºå¤šä¸ª Podï¼Œè€Œä¸æ˜¯åœ¨ä¸€ä¸ª Pod ä¸­å¡å…¥æ‰€æœ‰ä¸œè¥¿ã€‚ä»…å½“è¿™äº›è¿›ç¨‹æ˜¯<strong>äº’ç›¸åä½œã€å¿…é¡»åŒæ—¶è¿è¡Œã€å¿…é¡»åŒæ—¶æ‰©å±•ã€å¯¹å¤–æ˜¯ä¸€ä¸ªæ•´ä½“æœåŠ¡</strong>ç­‰è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘å°†å¤šä¸ªå®¹å™¨æ”¾åœ¨ä¸€ä¸ª Pod ä¸­è¿›è¡Œç®¡ç†ã€‚</p>
<p>ä½¿ç”¨ <code>cubectl create</code> æ¥åˆ›å»ºä¸€ä¸ª Podï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl create -f kubia-manual.yaml
</code></pre></div><p>åˆ›å»ºå¥½ä¹‹åï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ <code>kubectl get po kubia-manual -o yaml</code> æ¥æŸ¥çœ‹æ­¤ Pod çš„å®Œæ•´ Yaml é…ç½®ã€‚å¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>kebectl get pods</code> å¯ä»¥æŸ¥çœ‹å½“å‰çš„ Pod åˆ—è¡¨ï¼Œä»¥åŠå®ƒä»¬çš„çŠ¶æ€ã€‚</p>
<p>é€šè¿‡ Docker æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker logs &lt;å®¹å™¨ ID&gt;
</code></pre></div><p>é€šè¿‡ K8S æŸ¥çœ‹ Pod æ—¥å¿—ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl logs kubia-manual
$ kubectl logs kubia-manual -c &lt;å…·ä½“çš„å®¹å™¨å&gt;
</code></pre></div><p>å¦‚æœä¸æƒ³é€šè¿‡ Service çš„æ–¹å¼è®¿é—® Podï¼Œè€Œæ˜¯è¦ç®€å•è°ƒè¯•ã€æˆ–å…¶ä»–åŸå› æƒ³è®¿é—® Podï¼Œé‚£ä¹ˆ K8S æä¾›äº†ç«¯å£è½¬å‘åŠŸèƒ½ï¼Œå¦‚ä¸‹æµé‡å°†æœ¬åœ°çš„ 8888 ç«¯å£æµé‡è½¬åˆ° Pod çš„ 8080 ç«¯å£ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl port-forward kubia-manual 8888:8080
</code></pre></div><p><img src="/images/docs/tutorial/technique/k8s/2022-02-12_22-41.png" alt=""></p>
<p>ä¸ºäº†æ›´æ–¹ä¾¿çš„<strong>ç®¡ç†ã€ç»„ç»‡</strong> Podï¼Œè¿˜å¯ä»¥ç»™ Pod æ‰“æ ‡ç­¾ã€‚å¯ä»¥åœ¨åˆ›å»º Pod çš„æ—¶å€™æ‰“æ ‡ç­¾ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#ae81ff">key1=value1</span>
    <span style="color:#ae81ff">key2=value2</span>
</code></pre></div><p>è¿™æ ·å¯ä»¥ç»™ <code>kubectl get</code> å‘½ä»¤ä½¿ç”¨ <code>--show-labels</code> æ¥æ˜¾ç¤ºæ‰€æœ‰ Pod çš„æ ‡ç­¾ã€‚</p>
<hr>
<p>å¯ä»¥ç»™ Pod æ ‡æ³¨å…ƒä¿¡æ¯ï¼Œæ”¾ç½®æ›´å¤šçš„æè¿°ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">kubernetes.io/created-by</span>:
      {<span style="color:#e6db74">&#34;kind&#34;</span>:<span style="color:#e6db74">&#34;SerializedReference&#34;</span>, <span style="color:#e6db74">&#34;apiVersion&#34;</span>:<span style="color:#e6db74">&#34;v1&#34;</span>,<span style="color:#e6db74">&#34;reference&#34;</span>:{<span style="color:#e6db74">&#34;kind&#34;</span>:<span style="color:#e6db74">&#34;ReplicationController&#34;</span>, <span style="color:#e6db74">&#34;namespace&#34;</span>:<span style="color:#e6db74">&#34;default&#34;</span>, <span style="color:#ae81ff">...</span>
</code></pre></div><hr>
<p>ä¸€ä¸ª Pod å¯ä»¥æ‹¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œæ‰€ä»¥é€‰ä¸­æ­¤æ ‡ç­¾å’Œå…¶ä»–æ ‡ç­¾çš„æ—¶å€™ï¼Œé‡Œé¢é€‰ä¸­çš„èµ„æºå¯èƒ½æœ‰é‡å ã€‚è€Œ K8S ä¹Ÿå¯ä»¥é€šè¿‡<strong>å‘½åç©ºé—´</strong>çš„æ–¹å¼æ¥ç»„ç»‡ Podï¼Œæ¥æä¾›ä¸€ç§ç®¡ç†ä¸åŒ Pod çš„ä½œç”¨åŸŸï¼Œå¯ä»¥å°†è¿™äº› Pod åˆ’åˆ†ä¸º<strong>ä¸é‡å çš„ã€ç‹¬ç«‹çš„ç»„</strong>ï¼Œä¾‹å¦‚<strong>ç”Ÿäº§ã€å¼€å‘ã€QAç¯å¢ƒ</strong>ç»„ç­‰ã€‚</p>
<p>é€šè¿‡å‘½ä»¤ <code>kubectl get ns</code> æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´ï¼Œ<code>kubectl</code> å‘½ä»¤é»˜è®¤æƒ…å†µä¸‹å±•ç¤ºçš„éƒ½æ˜¯ <code>default</code> å‘½åç©ºé—´çš„èµ„æºï¼Œé€šè¿‡å¦‚ä¸‹å‘½ä»¤å±•ç¤ºå…¶ä»–å‘½åç©ºé—´çš„èµ„æºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get po --namespace kube-system
</code></pre></div><p>åˆ›å»º Pod çš„æ—¶å€™æŒ‡å®š<strong>å‘½åç©ºé—´</strong>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</code></pre></div><p>åˆ é™¤ Pod çš„å‘½ä»¤ <code>kubectl delete po kubia-gpu</code> ä¼šå‘é€ <code>SIGTERM</code> ä¿¡å·ç»™æ‰€æœ‰çš„è¿›ç¨‹ï¼Œç„¶åç­‰å¾…æœ€å¤š 30 ç§’ï¼Œå¦åˆ™ç›´æ¥å‘é€ <code>SIGKILL</code> ä¿¡å·ã€‚</p>
<h3 id="docker-è¿è¡Œ-k8s">Docker è¿è¡Œ K8S</h3>
<p>éœ€è¦å°†å®ƒä»¬æ‰“åŒ…åˆ¶ä½œæˆé•œåƒæ‰å¯ä»¥è¿è¡Œåœ¨ K8S ä¸­çš„åº”ç”¨ã€‚<code>&lt;tag&gt;</code> æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸æä¾›ï¼Œé»˜è®¤åº”è¯¥æ˜¯ <code>latest</code>ï¼Œå…¶è¡¨ç¤ºçš„å«ä¹‰æ˜¯<strong>ç‰ˆæœ¬å·</strong>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run &lt;image&gt;:&lt;tag&gt;
</code></pre></div><h3 id="k8s-é›†ç¾¤">K8S é›†ç¾¤</h3>
<p>ä¸‹é¢æ˜¯ K8S é›†ç¾¤çš„æ¦‚è§ˆå›¾ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-19_10-54.png" alt=""></p>
<h3 id="k8s-è¿è¡Œ-app">K8S è¿è¡Œ APP</h3>
<p>å¼€å‘è€…å‘Šè¯‰ K8S çš„ master èŠ‚ç‚¹ï¼Œå“ªäº› APP å¿…é¡»éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œæ¯ä¸€ä¸ª APP éœ€è¦éƒ¨ç½²å‡ ä¸ªå®ä¾‹ï¼ŒK8S å°±ä¼šè‡ªåŠ¨æŒ‰ç…§è¦æ±‚å°†è¿™äº› APP éƒ¨ç½²åˆ° worker èŠ‚ç‚¹ä¸Šã€‚</p>
<p><img src="/images/docs/tutorial/technique/k8s/k8s-does.png" alt=""></p>
<p>K8S ç”± master å’Œ worker èŠ‚ç‚¹æ„æˆï¼Œå…¶ä¸­ K8S ç®¡ç†æ§åˆ¶å°ä½äº master èŠ‚ç‚¹ä¸Šï¼Œå¯ä»¥é€šè¿‡æ­¤å¹³å°ç®¡ç†æ•´ä¸ª K8S ç³»ç»Ÿï¼›è€Œ worker èŠ‚ç‚¹ç”¨äºå®é™…è¿è¡Œ APPã€‚</p>
<p><strong>master èŠ‚ç‚¹åŒ…å«</strong>ï¼š</p>
<ul>
<li>K8S API Server</li>
<li>Scheduler: è°ƒåº¦ APPï¼Œåˆ†é… worker èŠ‚ç‚¹ç­‰</li>
<li>Control Manager: è·Ÿè¸ª worker èŠ‚ç‚¹çŠ¶æ€ï¼Œå¤„ç†èŠ‚ç‚¹å¤±è´¥ç­‰</li>
<li>etcd: å­˜å‚¨é›†ç¾¤çš„é…ç½®ä¿¡æ¯</li>
</ul>
<p><strong>worker èŠ‚ç‚¹åŒ…å«</strong>ï¼š</p>
<ul>
<li>Docker: æˆ–è€…å…¶ä»–å®¹å™¨</li>
<li>Kubelet: è°ƒç”¨ API Serverï¼Œæ§åˆ¶ Container</li>
<li>K8S Service Proxy: æµé‡çš„è´Ÿè½½å‡è¡¡</li>
</ul>
<p><img src="/images/docs/tutorial/technique/k8s/k8s-components.png" alt=""></p>
<p>åœ¨ K8S ä¸­è¿è¡Œç¨‹åºï¼Œå¿…é¡»é¦–å…ˆå°†å…¶åˆ¶ä½œæˆå®¹å™¨çš„é•œåƒï¼Œç„¶åæ¨é€åˆ°é•œåƒä»“åº“ï¼Œç„¶åå‘Šè¯‰ K8S æ­¤ APP çš„æè¿°æ–‡ä»¶ã€‚</p>
<p><img src="/images/docs/tutorial/technique/k8s/k8s-architecture-and-how-app-running.png" alt=""></p>
<h3 id="æ§åˆ¶å™¨">æ§åˆ¶å™¨</h3>
<p>HTTP æ¢é’ˆï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/kubia-unhealthy</span>
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
    <span style="color:#f92672">livenessProbe</span>:
      <span style="color:#f92672">httpGet</span>: <span style="color:#75715e"># HTTP GET æ¢é’ˆ</span>
        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">15</span> <span style="color:#75715e"># 15 ç§’ä¹‹åå‘é€ç¬¬ä¸€ä¸ªæ¢é’ˆ</span>
</code></pre></div><hr>
<p>ReplicationController ä¿è¯ Pod æ€»æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœæŸä¸ª Pod å› ä¸ºæŸäº›åŸå› å®•æ‰äº†ï¼Œé‚£ä¹ˆ ReplicationController å°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Pod ä»¥æ›¿ä»£æ—§çš„ Podã€‚</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-14_23-10.png" alt=""></p>
<p>ä½¿ç”¨å‘½ä»¤ <code>kubectl create -f kubia-rc.yaml</code> åˆ›å»ºä¸€ä¸ª ReplicationController :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicationController</span> <span style="color:#75715e"># æŒ‡å®šç±»å‹</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># æŒ‡å®šéœ€è¦ 3 ä¸ª Pod</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># Pod Selector</span>
<span style="color:#f92672">template</span>: <span style="color:#75715e"># template ä¸‹é¢çš„è¿™äº›æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ Pod æ‰€éœ€è¦çš„æ¨¡æ¿</span>
  <span style="color:#f92672">metadata</span>:
    <span style="color:#f92672">labels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
  <span style="color:#f92672">spec</span>:
    <span style="color:#f92672">containers</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/kubia</span>
      <span style="color:#f92672">ports</span>:
      - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</code></pre></div><p>ReplicationController å¯ä»¥éšæ—¶é€šè¿‡å‘½ä»¤ <code>kubectl edit rc kubia</code> ä¿®æ”¹ Pod æ¨¡æ¿ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-15_21-24.png" alt=""></p>
<hr>
<p>ReplicaSet æ˜¯ç”¨æ¥æ›¿ä»£ ReplicationController çš„ï¼Œå®ƒæœ‰æ›´å¤šçš„ Pod Selectorã€‚åˆ›å»ºä¸€ä¸ª ReplicaSet ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1beta2</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/kubia</span>
</code></pre></div><p>å®ƒæœ‰æ›´ä¸ºä¸°å¯Œçš„ label é€‰æ‹©å™¨ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">selector</span>:
  <span style="color:#f92672">matchExpressions</span>:
    - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span> <span style="color:#75715e"># Pod å¿…é¡»æœ‰ä¸€ä¸ª key æ˜¯ app çš„ label</span>
      <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
      <span style="color:#f92672">values</span>:
        - <span style="color:#ae81ff">kubia</span> <span style="color:#75715e"># label çš„ value å¿…é¡»ä½äº kubia é‡Œé¢</span>
</code></pre></div><hr>
<p>DaemonSets ç¡®ä¿ä¸€ä¸ª Worker Node åªè¿è¡Œä¸€ä¸ª Pod å‰¯æœ¬ï¼Œå‡è®¾ä½ è¿è¡Œçš„æ˜¯ä¸€ä¸ª<strong>æ—¥å¿—é‡‡é›†å™¨ç¨‹åº</strong>ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šä½¿ç”¨ <code>DaemonSets</code>ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-18_23-21.png" alt=""></p>
<h3 id="serviceä¸-pod-æ²Ÿé€š">Serviceï¼šä¸ Pod æ²Ÿé€š</h3>
<p>K8S Service æä¾›äº†å¯¹äºä¸€ç»„æä¾›ç›¸åŒæœåŠ¡çš„ Pod çš„ä¸€ä¸ªå›ºå®šå…¥å£ã€‚</p>
<p><img src="/images/docs/tutorial/technique/k8s/connect-pod-via-services.png" alt=""></p>
<p>é€šè¿‡ <code>kubia-svc.yaml</code> æ–‡ä»¶åˆ›å»º Serviceï¼Œ<code>port: 80</code> è¡¨ç¤º Service ç›‘å¬åœ¨ 80 ç«¯å£ï¼Œ<code>targetPort: 8080</code> è¡¨ç¤º Service å°†è¦ç”¨<strong>æŸç§è·¯ç”±ç®—æ³•</strong>è½¬å‘åˆ°å¤šä¸ª Pod çš„ 8080 ç«¯å£ï¼Œ<code>app: kubia</code> è¡¨ç¤ºæ‰€æœ‰å…·æœ‰ <code>app = kubia</code> æ ‡ç­¾çš„ Pod éƒ½å±äºè¿™ä¸ª Serviceï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</code></pre></div><p>é€šè¿‡ <code>kubectl get svc</code> å‘½ä»¤æŸ¥çœ‹é»˜è®¤å‘½åç©ºé—´çš„æ‰€æœ‰çš„ Service åˆ—è¡¨ï¼Œ<code>EXTERNAL-IP</code> è¡¨ç¤ºå¤–ç½‘ IPï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">NAME       CLUSTER-IP   EXTERNAL-IP    PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
kubernetes 10.3.240.1   &lt;none&gt;         443/TCP        35m
kubia-http 10.3.246.185 104.155.74.57  8080:31348/TCP 1m
</code></pre></div><p><img src="/images/docs/tutorial/technique/k8s/2022-02-18_23-09.png" alt=""></p>
<p>ä¼šè¯ Session é™„ç€ï¼ŒæŸä¸€ä¸ª Client çš„è¯·æ±‚æ€»æ˜¯è½¬å‘åˆ°æŸä¸€ä¸ª Podï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">ClientIP</span>
</code></pre></div><p>å¯ä»¥é€šè¿‡ <code>ENV</code> ç¯å¢ƒå˜é‡ï¼ŒæŸ¥çœ‹ Service çš„åœ°å€ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec kubia-3inly env
KUBIA_SERVICE_HOST<span style="color:#f92672">=</span>10.111.249.153
KUBIA_SERVICE_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>
</code></pre></div><p>ä¹Ÿå¯ä»¥é€šè¿‡ <strong>FQDN</strong> æŸ¥çœ‹ Service åœ°å€ï¼Œå…¶ä¸­ <code>backend-database</code> è¡¨ç¤º Service åç§°ï¼Œ<code>default</code> è¡¨ç¤ºå‘½åç©ºé—´ï¼Œ<code>svc.cluster.local</code> æ˜¯ä¸€ä¸ªå¯é…ç½®çš„é›†ç¾¤ Domain çš„å‰ç¼€ï¼š</p>
<pre><code>backend-database.default.svc.cluster.local
</code></pre><p>éªŒè¯æ˜¯å¦å¯ä»¥è”é€šï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">$ kubectl exec -it kubia-3inly bash

root@kubia-3inly:/# curl http://kubia.default.svc.cluster.local
Youâ€™ve hit kubia-5asi2

root@kubia-3inly:/# curl http://kubia.default
Youâ€™ve hit kubia-3inly

root@kubia-3inly:/# curl http://kubia
Youâ€™ve hit kubia-8awf3
</code></pre></div><p>æŸ¥çœ‹ä¸€ä¸ª Service èƒŒåå¯ä»¥è®¿é—®å“ªäº› Pod ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl describe svc kubia
Selector: app<span style="color:#f92672">=</span>kubia
Endpoints: 10.108.1.4:8080,10.108.2.5:8080,10.108.2.6:8080
</code></pre></div><hr>
<p>åˆšæ‰è®¨è®ºçš„åªæ˜¯èƒ½è®© <strong>K8S Cluster</strong> å†…çš„å„ä¸ª Pod è®¿é—® Service ï¼Œæœ‰ä¸‰ç§æ–¹å¼å¯ä»¥è®©<strong>å¤–éƒ¨çš„ Client (å¤–ç½‘)</strong> è®¿é—® Serviceï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-14_20-57.png" alt=""></p>
<ol>
<li>æŒ‡å®š Service çš„ç±»å‹ä¸º <code>NodePort</code>ï¼š</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30123</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</code></pre></div><p><img src="/images/docs/tutorial/technique/k8s/2022-02-13_19-01.png" alt=""></p>
<ol start="2">
<li>æŒ‡å®š Service çš„ç±»å‹ä¸º <code>LoadBalancer</code>ï¼Œè¿™æ˜¯ <code>NodePort</code> çš„æ‰©å±•ç±»å‹</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia-loadbalancer</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">kubia</span>
</code></pre></div><p>è·å– LoadBalancer çš„ IPï¼š</p>
<pre><code>$ kubectl get svc kubia-loadbalancer
NAME               CLUSTER-IP     EXTERNAL-IP    PORT(S)      AGE
kubia-loadbalancer 10.111.241.153 130.211.53.173 80:32143/TCP 1m
</code></pre><p><img src="/images/docs/tutorial/technique/k8s/2022-02-13_19-08.png" alt=""></p>
<ol start="3">
<li>åˆ›å»º Ingress èµ„æº</li>
</ol>
<p>ä¸€ä¸ª Ingressï¼Œå°±å¯ä»¥ç®¡æ§å¤šä¸ª Serviceã€‚å¦‚æœä½¿ç”¨ LoadBalancer çš„è¯ï¼Œé‚£ä¹ˆæ¯ä¸ª Service å¿…é¡»é…å¤‡ä¸€ä¸ª IP ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-13_19-11.png" alt=""></p>
<p>åˆ›å»º Ingress ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubia</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">kubia.example.com</span>
    <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
        <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">kubia-nodeport</span>
          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><p>è·å– Ingress IPï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get ingresses
</code></pre></div><p>é…ç½® DNSï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vi /etc/hosts
192.168.99.100 kubia.example.com
</code></pre></div><p>ä½¿ç”¨ Ingress è®¿é—® Podï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-13_19-15.png" alt=""></p>
<h3 id="configmaps-å’Œç§˜é’¥">ConfigMaps å’Œç§˜é’¥</h3>
<blockquote>
<p><strong>ConfigMap</strong>: ä¼ é€’å‚æ•°ç»™ K8S çš„ Pod</p>
</blockquote>
<p>åœ¨ Yaml ä¸­é€šè¿‡ <code>env</code> å‚æ•°å®šä¹‰<strong>ç¯å¢ƒå˜é‡</strong>ï¼Œè¿™ä¸ªç¯å¢ƒå˜é‡æ˜¯å®šä¹‰åœ¨ Container çº§åˆ«ï¼Œè€Œé Pod çº§åˆ«ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/fortune:env</span>
    <span style="color:#f92672">env</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">INTERVAL</span>
      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;30&#34;</span>
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">html-generator</span>
</code></pre></div><p>ä½¿ç”¨ ConfigMap é¿å…ç¡¬ç¼–ç ç¯å¢ƒå˜é‡ã€‚</p>
<p>ä»å‘½ä»¤è¡Œåˆ›å»º <code>ConfigMap</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl create configmap myconfigmap --from-literal<span style="color:#f92672">=</span>foo<span style="color:#f92672">=</span>bar --from-literal<span style="color:#f92672">=</span>bar<span style="color:#f92672">=</span>baz --from-literal<span style="color:#f92672">=</span>one<span style="color:#f92672">=</span>two
$ kubectl get configmap myconfigmap -o yaml
</code></pre></div><p>ä»<strong>æ–‡ä»¶</strong>æˆ–è€…<strong>ç›®å½•</strong>åˆ›å»º <code>ConfigMap</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># key å°±æ˜¯æ–‡ä»¶åï¼Œvalue å°±æ˜¯æ–‡ä»¶å†…å®¹</span>
$ kubectl create configmap my-config --from-file<span style="color:#f92672">=</span>config-file.conf
<span style="color:#75715e"># ç›®å½•ä¸­çš„æ¯ä¸ªæ–‡ä»¶åéƒ½ä½œä¸º key</span>
$ kubectl create configmap my-config --from-file<span style="color:#f92672">=</span>/path/to/dir
</code></pre></div><p>ä½¿ç”¨å‘½ä»¤ <code>kubectl get configmap fortune-config -o yaml</code> æŸ¥çœ‹ ConfigMap å®šä¹‰ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">data</span>:
  <span style="color:#f92672">sleep-interval</span>: <span style="color:#e6db74">&#34;25&#34;</span> <span style="color:#75715e"># åªæœ‰ä¸€ä¸ªé…ç½®é¡¹</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">creationTimestamp</span>: <span style="color:#e6db74">2016-08-11T20:31:08Z</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span> <span style="color:#75715e"># ConfigMap çš„åå­—ï¼Œé€šè¿‡è¿™ä¸ªåå­—æ¥å¼•ç”¨è¿™ä¸ª Config</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
  <span style="color:#f92672">resourceVersion</span>: <span style="color:#e6db74">&#34;910025&#34;</span>
  <span style="color:#f92672">selfLink</span>: <span style="color:#ae81ff">/api/v1/namespaces/default/configmaps/fortune-config</span>
  <span style="color:#f92672">uid</span>: <span style="color:#ae81ff">88c4167e-6002-11e6-a50d-42010af00237</span>
</code></pre></div><p>Pod é€šè¿‡<strong>ç¯å¢ƒå˜é‡</strong>æˆ–è€… <strong>configMap volume</strong> æ¥ä½¿ç”¨ ConfigMap ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-17_21-52.png" alt=""></p>
<p>ConfigMap ä¼ é€’ç»™<strong>å®¹å™¨</strong>ï¼Œä½œä¸º<strong>ç¯å¢ƒå˜é‡</strong>å­˜åœ¨ï¼Œå¦‚æœ Pod å¼•ç”¨äº†ä¸å­˜åœ¨çš„ ConfigMap é‚£ä¹ˆ Pod å°†<strong>æ‹’ç»å¯åŠ¨</strong>ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å°† <code>ConfigMap</code> ä½œä¸ºå¯é€‰çš„ <code>configMapKeyRef.optional: true</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-env-from-configmap</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/fortune:env</span>
    <span style="color:#f92672">env</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">INTERVAL</span> <span style="color:#75715e"># ç»™å®¹å™¨å®šä¹‰äº†ä¸€ä¸ªç¯å¢ƒå˜é‡</span>
      <span style="color:#f92672">valueFrom</span>: <span style="color:#75715e"># ä» ConfigMap å¼•ç”¨è¿™ä¸ªå€¼</span>
        <span style="color:#f92672">configMapKeyRef</span>:
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span> <span style="color:#75715e"># ConfigMap çš„åå­—</span>
          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">sleep-interval</span> <span style="color:#75715e"># ConfigMap å¼•ç”¨çš„ key </span>
</code></pre></div><p>ConfigMap ä½œä¸º<strong>å‘½ä»¤è¡Œå‚æ•°</strong>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-args-from-configmap</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">luksa/fortune:args</span>
    <span style="color:#f92672">env</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">INTERVAL</span>
      <span style="color:#f92672">valueFrom</span>:
        <span style="color:#f92672">configMapKeyRef</span>:
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span>
          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">sleep-interval</span>
    <span style="color:#f92672">args</span>: [<span style="color:#e6db74">&#34;$(INTERVAL)&#34;</span>] <span style="color:#75715e"># å‘½ä»¤è¡Œå‚æ•°å¼•ç”¨ç¯å¢ƒå˜é‡å‚æ•°</span>
</code></pre></div><p>ä½¿ç”¨ configMap volume æ¥å°† ConfigMap ä½œä¸ºæ–‡ä»¶ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-configmap-volume</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:alpine</span>
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">web-server</span>
    <span style="color:#f92672">volumeMounts</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/nginx/conf.d</span> <span style="color:#75715e"># å°† volume ConfigMap æŒ‚è½½åˆ°è¿™ä¸ªä½ç½®</span>
      <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#f92672">volumes</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span> <span style="color:#75715e"># volume å¼•ç”¨ ConfigMap</span>
    <span style="color:#f92672">configMap</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fortune-config</span>
</code></pre></div><p><img src="/images/docs/tutorial/technique/k8s/2022-02-17_22-56.png" alt=""></p>
<p>æŸ¥çœ‹æŒ‚è½½çš„ç›®å½•ä¸‹æ˜¯å¦æœ‰æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl exec fortune-configmap-volume -c web-server ls /etc/nginx/conf.d
</code></pre></div><hr>
<p>æ¯ä¸€ä¸ª Pod éƒ½æœ‰ä¸€ä¸ªè‡ªåŠ¨é™„å¸¦çš„ secret volumeï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get secrets
$ kubectl describe secrets
ca.crt: <span style="color:#ae81ff">1139</span> bytes
namespace: <span style="color:#ae81ff">7</span> bytes
token: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
</code></pre></div><p><img src="/images/docs/tutorial/technique/k8s/2022-02-17_21-40.png" alt=""></p>
<p>åˆ›å»º Secretï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ openssl genrsa -out https.key <span style="color:#ae81ff">2048</span>
$ openssl req -new -x509 -key https.key -out https.cert -days <span style="color:#ae81ff">3650</span> -subj/CN<span style="color:#f92672">=</span>www.kubia-example.com
$ echo bar &gt; foo
$ kubectl create secret generic fortune-https --from-file<span style="color:#f92672">=</span>https.key --from-file<span style="color:#f92672">=</span>https.cert --from-file<span style="color:#f92672">=</span>foo
</code></pre></div><p>Secret çš„æ¯ä¸€é¡¹ä»¥ Base64 å±•ç¤ºï¼ŒConfigMap éƒ½æ˜¯æ˜æ–‡å±•ç¤ºã€‚å¦‚ä¸‹æ˜¯ Secret çš„ Yaml æ–‡ä»¶å±•ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#ae81ff">$ kubectl get secret fortune-https -o yaml</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">data</span>:
  <span style="color:#f92672">foo</span>: <span style="color:#ae81ff">YmFyCg==</span>
  <span style="color:#f92672">https.cert</span>: <span style="color:#ae81ff">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCekNDQ...</span>
  <span style="color:#f92672">https.key</span>: <span style="color:#ae81ff">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcE...</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</code></pre></div><h3 id="volume">Volume</h3>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-14_21-42.png" alt=""></p>
<h3 id="æ›´æ–°">æ›´æ–°</h3>
<p>æ»šåŠ¨æ›´æ–°ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-14_21-17.png" alt=""></p>
<p>æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">strategy</span>:
    <span style="color:#f92672">rollingUpdate</span>:
      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># é»˜è®¤å€¼æ˜¯ 25%</span>
      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span> <span style="color:#75715e"># é»˜è®¤å€¼ä¹Ÿæ˜¯ 25%</span>
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</code></pre></div><p>å½“å‰çº¿ä¸Šå­˜æ´» Pod æ˜¯ 3 ä¸ªï¼Œ<code>maxSurge = 1</code> è¡¨ç¤ºéƒ¨ç½²çš„æ—¶å€™ï¼Œæœ€å¤šå­˜åœ¨çš„ Pod ä¸ªæ•°æ˜¯ <code>3 + 1 = 4</code> ä¸ªï¼Œ<code>maxUnavailable = 0</code> è¡¨ç¤ºéƒ¨ç½²çš„æ—¶å€™ï¼Œè‡³å°‘ <code>3 - 0 = 3</code> ä¸ª Pod å¿…é¡»å¤„äºå­˜æ´»çŠ¶æ€ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-14_21-30.png" alt=""></p>
<p>å½“ <code>maxUnavailable = 1</code> çš„æ—¶å€™ï¼Œé‚£ä¹ˆè‡³å°‘ <code>3 - 1 = 2</code> ä¸ª Pod å¿…é¡»å¤„äºå­˜æ´»çŠ¶æ€ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-14_21-39.png" alt=""></p>
<p>æ§åˆ¶æ›´æ–°ï¼Œç”¨ä¸€å°éƒ¨åˆ†æµé‡éªŒè¯æ–°çš„ç‰ˆæœ¬ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl set image deployment kubia nodejs<span style="color:#f92672">=</span>luksa/kubia:v4
<span style="color:#75715e"># æš‚åœæ›´æ–°</span>
$ kubectl rollout pause deployment kubia
<span style="color:#75715e"># æ¢å¤æ›´æ–°</span>
$ kubectl rollout resume deployment kubia
</code></pre></div><p><code>minReadySeconds</code> ä¸€ä¸ªæ–°çš„ Pod èµ·æ¥ä¹‹åï¼Œå¤šä¹…æ‰å¯ä»¥å¯¹å¤–å®£ä¼ è‡ªå·±å‡†å¤‡å¥½æ¥å—è¯·æ±‚äº†ï¼Œæ—¶é—´ä¸åˆ°ï¼Œæ›´æ–°ä¸ä¼šç»§ç»­ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">10</span>
  <span style="color:#f92672">strategy</span>:
    <span style="color:#f92672">rollingUpdate</span>:
      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">1</span>
      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">0</span>
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</code></pre></div><p>readiness probe å¦‚æœå¤±è´¥çš„è¯ï¼Œé‚£ä¹ˆæµé‡ä¸ä¼šè½¬å‘åˆ°è¿™å° Pod ä¸Šï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-15_21-41.png" alt=""></p>
<h2 id="k8s-æœºåˆ¶">K8S æœºåˆ¶</h2>
<h3 id="k8s-æ¶æ„">K8S æ¶æ„</h3>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-19_10-45.png" alt=""></p>
<p>ï¼ˆ1ï¼‰<strong>ä½¿ç”¨ etcd å­˜å‚¨èµ„æº</strong></p>
<p>Podã€ReplicationControllersã€Servicesã€Secrets ç­‰çš„ manifests éƒ½å­˜å‚¨åœ¨ etcd ä¸­ï¼Œå”¯ä¸€ä¸ etcd æœ‰å…³è”çš„æ˜¯ API Serverï¼Œå…¶ä»–æ‰€æœ‰ç»„ä»¶çš„è¯»æˆ–è€…å†™éƒ½å¾—é€šè¿‡ API Server æ‰èƒ½è®¿é—® etcdï¼Œåœ¨ Kubernetes ä¸­ï¼Œå®ƒæ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨ <code>/registry</code> è·¯å¾„ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ etcdctl ls /registry
</code></pre></div><p>ï¼ˆ2ï¼‰<strong>API Server</strong></p>
<p>API Server <strong>æ”¶åˆ°è¯·æ±‚</strong>åæ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-14_22-54.png" alt=""></p>
<p>API Server å¦‚ä½•é€šçŸ¥ Client èµ„æºå‘ç”Ÿäº†å˜åŠ¨ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-14_22-57.png" alt=""></p>
<p>ï¼ˆ3ï¼‰<strong>kubelet</strong></p>
<ul>
<li>é€šè¿‡ API Server åˆ›å»º Node èµ„æº</li>
<li>é€šè¿‡ API Server ç›‘æ§å“ªäº› Pods è°ƒåº¦ç»™äº† Nodeï¼Œç„¶åå‘Šè¯‰ Docker ä»é•œåƒå¯åŠ¨ Container</li>
<li>æŒç»­ä¸æ–­æ±‡æŠ¥çŠ¶æ€ã€äº‹ä»¶ã€èµ„æºæ¶ˆè€—ç»™ API Server</li>
</ul>
<p>ï¼ˆ4ï¼‰<strong>kube-proxy</strong></p>
<blockquote>
<p>æœ¬èŠ‚éƒ¨åˆ†å†…å®¹æ¥è‡ªé˜¿é‡Œäº‘ç¤¾åŒºã€Šæ·±å…¥æµ…å‡ºK8Sã€‹</p>
</blockquote>
<p>åœ¨ K8S é›†ç¾¤ä¸­ï¼ŒæœåŠ¡çš„å®ç°ï¼Œå®é™…ä¸Šæ˜¯ä¸ºæ¯ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œéƒ¨ç½²äº†ä¸€ä¸ª<strong>åå‘ä»£ç† Sidecar</strong>ã€‚è€Œæ‰€æœ‰å¯¹é›†ç¾¤æœåŠ¡çš„è®¿é—®ï¼Œéƒ½ä¼šè¢«èŠ‚ç‚¹ä¸Šçš„åå‘ä»£ç†è½¬æ¢æˆå¯¹æœåŠ¡åç«¯å®¹å™¨ç»„çš„è®¿é—®ã€‚</p>
<p>K8S é›†ç¾¤çš„æœåŠ¡ï¼Œæœ¬è´¨ä¸Šæ˜¯<strong>è´Ÿè½½å‡è¡¡</strong>ï¼Œå³åå‘ä»£ç†ï¼›åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™ä¸ªåå‘ä»£ç†ï¼Œå¹¶ä¸æ˜¯éƒ¨ç½²åœ¨é›†ç¾¤æŸä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œæ˜¯ä½œä¸ºé›†ç¾¤èŠ‚ç‚¹çš„è¾¹è½¦ï¼Œéƒ¨ç½²åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ã€‚</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-19_10-26.png" alt=""></p>
<p>K8S é›†ç¾¤èŠ‚ç‚¹å®ç°æœåŠ¡åå‘ä»£ç†çš„æ–¹æ³•ï¼Œç›®å‰ä¸»è¦æœ‰ä¸‰ç§ï¼Œå³ userspaceã€iptables ä»¥åŠ ipvsã€‚</p>
<p>userspace æ¨¡å¼ï¼šä½œä¸ºæ—©æœŸå®ç°ï¼Œproxy è¿è¡Œäº†ä¸€ä¸ª<strong>è¿›ç¨‹</strong>ï¼Œè´Ÿè´£é…ç½® iptables è·¯ç”±è§„åˆ™ï¼Œä»¥ä¾¿å°†è¿æ¥é‡å®šå‘åˆ° proxy serverï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-19_10-34.png" alt=""></p>
<p>ç°åœ¨æ›´å¥½çš„å®ç°æ¨¡å¼æ˜¯ iptables æ¨¡å¼ï¼šç›´æ¥å°† packets é‡å®šå‘åˆ°éšæœºé€‰æ‹©çš„åç«¯çš„ Pod ä¸Šï¼Œè€Œæ— é¡»é¢å¤–çš„å°†å®ƒä»¬å†è½¬å‘åˆ° proxy server ä¸Šã€‚userspace æ¨¡å¼ï¼Œpackets å¿…é¡»ç»è¿‡ proxy serverï¼Œä¹Ÿå°±æ˜¯å¿…é¡»åˆ° user spaceï¼Œè€Œ iptables æ¨¡å¼åˆ™ç›´æ¥åœ¨ kernel space åŒºã€‚ä¸¤è€…æœ‰æ¯”è¾ƒæ˜¾è‘—çš„<strong>æ€§èƒ½å·®å¼‚</strong>ã€‚</p>
<p>å¦å¤–ä¸€ç‚¹ï¼Œuserspace æ¨¡å¼æ‰§è¡Œçš„æ˜¯ <strong>round-robin</strong> çš„æ–¹å¼é€‰æ‹© Podï¼Œè€Œ iptables æ¨¡å¼æ˜¯<strong>éšæœºé€‰æ‹© Pod</strong>ã€‚</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-19_10-33.png" alt=""></p>
<h3 id="k8s-ç½‘ç»œ">K8S ç½‘ç»œ</h3>
<p>K8S Inter-pod ç½‘ç»œé€šè¿‡ Container Network Interface ï¼ˆCNIï¼‰æ’ä»¶å»ºç«‹ã€‚</p>
<p>Pod A ä¸ Pod B ä¹‹é—´çš„ IP æ²¡æœ‰ç»è¿‡ <strong>NAT</strong> è½¬æ¢ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-18_22-29.png" alt=""></p>
<p>ä¸€ä¸ª Node é‡Œè¾¹çš„ Pod A ä¸ Pod B è¿æ¥åœ¨<strong>åŒä¸€ä¸ªç½‘æ¡¥</strong>ä¸Šï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-18_22-34.png" alt=""></p>
<p>ä¸åŒ Node é‡Œè¾¹çš„ Pod A ä¸ Pod B éœ€è¦ä»¥æŸç§æ–¹å¼æ‰èƒ½é€šä¿¡ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-18_22-37.png" alt=""></p>
<h3 id="k8s-è°ƒåº¦å™¨">K8S è°ƒåº¦å™¨</h3>
<p>é»˜è®¤è°ƒåº¦ç®—æ³•ï¼š</p>
<ul>
<li>è¿‡æ»¤å‡ºç¬¦åˆè¦æ±‚çš„èƒ½å¤Ÿè¢«è°ƒåº¦çš„èŠ‚ç‚¹ã€‚</li>
<li>å¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œé€‰æ‹©æœ€ä½³çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœå¤šä¸ªèŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„åˆ†æ•°ï¼Œé‚£ä¹ˆä¼šé‡‡ç”¨ round-robin ç®—æ³•æ¥é€‰å–ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
</ul>
<p><img src="/images/docs/tutorial/technique/k8s/scheduler-select-nodes.png" alt=""></p>
<h3 id="k8s-æ°´å¹³ä¼¸ç¼©">K8S æ°´å¹³ä¼¸ç¼©</h3>
<p>æ¯ä¸€ä¸ª node ä¸Šçš„ 	Kubelet é‡Œé¢éƒ½æœ‰ä¸€ä¸ª cAdvisor ï¼Œè´Ÿè´£æ”¶é›†å„ç§æŒ‡æ ‡ï¼Œç„¶åé€šè¿‡ä½äºé›†ç¾¤çº§åˆ«çš„ Heapster è¿›è¡ŒæŒ‡æ ‡èšåˆã€‚</p>
<p><img src="/images/docs/tutorial/technique/k8s/collect-metrics.png" alt=""></p>
<p>æ ¹æ®ä¸€ä¸ªæˆ–è€…å¤šä¸ªæŒ‡æ ‡è®¡ç®— APP æ‰€éœ€è¦çš„ Pods æ•°é‡ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/calculate-number-of-replicas.png" alt=""></p>
<p>æœ€å Autoscaler Controller æ›´æ–°å‰¯æœ¬æ•°é‡ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/updating-replica-count.png" alt=""></p>
<h3 id="k8s-é«˜å¯ç”¨">K8S é«˜å¯ç”¨</h3>
<p>é«˜å¯ç”¨éœ€è¦è¿è¡Œå¤šä¸ª master èŠ‚ç‚¹ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/highly-available.png" alt=""></p>
<h3 id="k8s-èµ„æºæ§åˆ¶">K8S èµ„æºæ§åˆ¶</h3>
<p>Hard çº¦æŸçš„ Pod ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">requests-pod</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;dd&#34;</span>, <span style="color:#e6db74">&#34;if=/dev/zero&#34;</span>, <span style="color:#e6db74">&#34;of=/dev/null&#34;</span>]
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
    <span style="color:#f92672">resources</span>:
      <span style="color:#f92672">requests</span>:
        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">200m</span> <span style="color:#75715e"># CPU 200 millicoresï¼Œ1/5 å•æ ¸ CPU çš„æ—¶é—´</span>
        <span style="color:#f92672">memory: 10Mi # ç”³è¯·çš„å†…å­˜å¤§å°</span>: <span style="color:#ae81ff">10MB</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">limited-pod</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">containers</span>:
  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;dd&#34;</span>, <span style="color:#e6db74">&#34;if=/dev/zero&#34;</span>, <span style="color:#e6db74">&#34;of=/dev/null&#34;</span>]
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
    <span style="color:#f92672">resources</span>:
      <span style="color:#f92672">limits</span>:
        <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># æœ€å¤šå…è®¸å®¹å™¨ä½¿ç”¨ 1 ä¸ª CPU</span>
        <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">20Mi</span> <span style="color:#75715e"># æœ€å¤šå…è®¸ä½¿ç”¨ 20 MB</span>
</code></pre></div><hr>
<p>Kublet åŒ…å«äº†ä¸€ä¸ª Agent ç§°ä½œ cAdvisorï¼Œæ¥æ”¶é›† Node ä¸Šçš„å¤šä¸ª Container çš„èµ„æºæ¶ˆè€—æƒ…å†µã€‚å°†æ•´ä¸ªé›†ç¾¤çš„æ•´ä¸ªé™æ€æ•°æ®æ”¶é›†èµ·æ¥éœ€è¦è¿è¡Œä¸€ä¸ªé¢å¤–çš„ç»„ä»¶ï¼šHeapsterã€‚Heapster ä½œä¸ºä¸€ä¸ªæ­£å¸¸çš„ Pod è€Œå­˜åœ¨ã€‚</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-19_10-07.png" alt=""></p>
<h3 id="æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</h3>
<p>ï¼ˆ1ï¼‰å¦¥å–„å¤„ç†æ‰€æœ‰å®¢æˆ·è¯·æ±‚ï¼š</p>
<p>åº”ç”¨ç¨‹åº<strong>æ­£åœ¨å¯åŠ¨</strong>çš„æ—¶å€™ï¼Œç¡®ä¿æ²¡æœ‰è¯·æ±‚è¿›æ¥ï¼š</p>
<ul>
<li>æŒ‡å®š readiness probeã€‚å¦‚æœä¸æŒ‡å®šçš„è¯ï¼ŒPod å°±ä¼šè¢«è®¤ä¸ºå·²ç»å‡†å¤‡å¥½æ¥å—è¯·æ±‚äº†ã€‚</li>
</ul>
<p>åº”ç”¨ç¨‹åº<strong>æ­£åœ¨å…³é—­</strong>çš„æ—¶å€™ï¼Œå¦¥å–„å¤„ç†å½“å‰ç°å­˜çš„å®¢æˆ·è¯·æ±‚ï¼š</p>
<p><img src="/images/docs/tutorial/technique/k8s/2022-02-15_22-06.png" alt=""></p>
<p>pre-stop hook é˜²æ­¢ broken é“¾æ¥:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Yaml" data-lang="Yaml"><span style="color:#f92672">lifecycle</span>:
  <span style="color:#f92672">preStop</span>:
    <span style="color:#f92672">exec</span>:
      <span style="color:#f92672">command</span>:
      - <span style="color:#ae81ff">sh</span>
      - -<span style="color:#ae81ff">c</span>
      - <span style="color:#e6db74">&#34;sleep 5&#34;</span>
</code></pre></div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://book.douban.com/subject/26997846/">Kubernetes in Action</a></li>
</ul>

<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#è§£å†³çš„é—®é¢˜">è§£å†³çš„é—®é¢˜</a></li>
    <li><a href="#æ¦‚å¿µè§£é‡Š">æ¦‚å¿µè§£é‡Š</a>
      <ul>
        <li><a href="#vm-å’Œå®¹å™¨">VM å’Œå®¹å™¨</a></li>
        <li><a href="#pod">Pod</a></li>
        <li><a href="#docker-è¿è¡Œ-k8s">Docker è¿è¡Œ K8S</a></li>
        <li><a href="#k8s-é›†ç¾¤">K8S é›†ç¾¤</a></li>
        <li><a href="#k8s-è¿è¡Œ-app">K8S è¿è¡Œ APP</a></li>
        <li><a href="#æ§åˆ¶å™¨">æ§åˆ¶å™¨</a></li>
        <li><a href="#serviceä¸-pod-æ²Ÿé€š">Serviceï¼šä¸ Pod æ²Ÿé€š</a></li>
        <li><a href="#configmaps-å’Œç§˜é’¥">ConfigMaps å’Œç§˜é’¥</a></li>
        <li><a href="#volume">Volume</a></li>
        <li><a href="#æ›´æ–°">æ›´æ–°</a></li>
      </ul>
    </li>
    <li><a href="#k8s-æœºåˆ¶">K8S æœºåˆ¶</a>
      <ul>
        <li><a href="#k8s-æ¶æ„">K8S æ¶æ„</a></li>
        <li><a href="#k8s-ç½‘ç»œ">K8S ç½‘ç»œ</a></li>
        <li><a href="#k8s-è°ƒåº¦å™¨">K8S è°ƒåº¦å™¨</a></li>
        <li><a href="#k8s-æ°´å¹³ä¼¸ç¼©">K8S æ°´å¹³ä¼¸ç¼©</a></li>
        <li><a href="#k8s-é«˜å¯ç”¨">K8S é«˜å¯ç”¨</a></li>
        <li><a href="#k8s-èµ„æºæ§åˆ¶">K8S èµ„æºæ§åˆ¶</a></li>
        <li><a href="#æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>



</html>












