<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Linux tail å‘½ä»¤æºç è§£æ"><meta property="og:title" content="Linux tail å‘½ä»¤æºç è§£æ" />
<meta property="og:description" content="Linux tail å‘½ä»¤æºç è§£æ åŸºç¡€ç”¨æ³• tail å‘½ä»¤æ˜¯åœ¨ Linux ç³»ç»Ÿä¸Šç»å¸¸ä½¿ç”¨çš„ä¸€ä¸ªå‘½ä»¤ï¼Œå…¶èƒ½å¿«é€ŸæŸ¥çœ‹æ–‡ä»¶å°¾éƒ¨çš„å†…å®¹ã€‚å®ƒçš„åŸºæœ¬ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚
(1) -n æŸ¥çœ‹æœ«å°¾æŒ‡å®šè¡Œæ•°çš„å†…å®¹ï¼Œn ä»£è¡¨çš„æ˜¯ number çš„æ„æ€ï¼š
$ tail -n 15 word-list.txt (2) -c æŸ¥çœ‹æœ«å°¾æŒ‡å®šå­—èŠ‚æ•°çš„å†…å®¹ï¼š
$ tail -c 93 list-2.txt (3) -f å®æ—¶æ‰“å°æ—¥å¿—ã€‚æŸä¸ªæ–‡ä»¶çš„æœ«å°¾æœ‰æ–°çš„è¿½åŠ è¡Œçš„æ—¶å€™ï¼Œç«‹å³åœ¨æ§åˆ¶å°ä¸Šæ˜¾ç¤ºå‡ºæ¥ï¼Œç»å¸¸ç”¨è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹æŸä¸ªæ–‡ä»¶çš„å®æ—¶è¾“å‡ºçš„æ—¥å¿—ï¼Œæ–¹ä¾¿è·Ÿè¸ªé—®é¢˜ï¼š
tail -f nginx.log tail è¿˜æœ‰ä¸€äº›å…¶ä»–ç”¨æ³•ï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œ man tail æ¥æŸ¥çœ‹ã€‚
è¯»å–å€’æ•° n è¡Œæºç  tail å‘½ä»¤ä»æ–‡ä»¶å°¾éƒ¨æ¥æ˜¾ç¤ºæ–‡ä»¶å†…å®¹ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•åšåˆ°ä»å°¾éƒ¨åŠ¨æ€æˆ–è€…é™æ€çš„å»æ˜¾ç¤ºæ–‡ä»¶å‘¢ï¼Œå®ƒä½¿ç”¨ä¸­æœ‰å“ªäº›éœ€è¦æ³¨æ„çš„åœ°æ–¹å‘¢ï¼Ÿæ¥ä¸‹æ¥å°±å¸¦å¤§å®¶åˆ†æä¸€ä¸‹ tail å‘½ä»¤çš„æºç ã€‚
åœ¨ tail æºç é¡¶éƒ¨ï¼Œå³å®šä¹‰äº†ä¸€ä¸ªå¸¸é‡ï¼Œè¡¨ç¤ºå¦‚æœæ²¡æœ‰æŒ‡å®šæŸ¥çœ‹çš„é•¿åº¦ (tail abc.txt)ï¼Œé‚£ä¹ˆå°±é»˜è®¤æ˜¾ç¤ºè¿™ä¸ªæ–‡ä»¶å 10 è¡Œçš„å†…å®¹ï¼š
/* Number of items to tail. */ #define DEFAULT_N_LINES 10 é¦–å…ˆæ˜¯æ‰“å¼€æ–‡ä»¶ï¼š
fd = open (f-&gt;name, O_RDONLY | O_BINARY); ç„¶åè°ƒç”¨ tail å‡½æ•°ï¼Œtail å‡½æ•°å†…éƒ¨ä¼šæ ¹æ®å‚æ•°çš„ä¸åŒï¼Œé€‰æ‹© tail_lines è¿˜æ˜¯ tail_bytes æ¥è°ƒç”¨ã€‚å†æ¬¡æˆ‘ä»¬é€‰æ‹© tail_lines å‡½æ•°æ¥è§£é‡Šã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/tutorial/unix-optimize/tail/" />

<title>Linux tail å‘½ä»¤æºç è§£æ | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.7ebac727e739c3b4aee6328926e3b77ac1ddd5e9035221b7ec206fda1a413a4d.css" integrity="sha256-frrHJ&#43;c5w7Su5jKJJuO3esHd1ekDUiG37CBv2hpBOk0=">


<script defer src="/en.search.min.1c804c493a1e03da8fadc30892edeb11825959553a93144b8b8ce5b2c9465a11.js" integrity="sha256-HIBMSToeA9qPrcMIku3rEYJZWVU6kxRLi4zlsslGWhE="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/front-end-optimization-guide/" >
      å‰ç«¯ä¼˜åŒ–æŒ‡å—
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/algorithm/" >
      ç®—æ³•
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/raft/" >
      raft
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-command/" >
      UNIX å¸¸ç”¨å‘½ä»¤å¤§å…¨
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-optimize/" >
      UNIX æ€§èƒ½ä¼˜åŒ–
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/avg-load/" >
      å¹³å‡è´Ÿè½½
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/context-switch/" >
      CPU ä¸Šä¸‹æ–‡åˆ‡æ¢
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/high-cpu-and-load/" >
      CPU é£™å‡æˆ– load é£™å‡
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/memory/" >
      å†…å­˜ç®¡ç†
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/tail/"  class="active">
      Linux tail å‘½ä»¤æºç è§£æ
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/io/" >
      ç£ç›˜ I/O
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/zero-copy/" >
      Linux é›¶æ‹·è´
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/async_block/" >
      åŒæ­¥/å¼‚æ­¥ä¸é˜»å¡/éé˜»å¡
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/tools/" >
      æ€§èƒ½ä¼˜åŒ–å‘½ä»¤
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/thread_process/" >
      çº¿ç¨‹å’Œè¿›ç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/cpu/" >
      CPU
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/unix-optimize/analyze/" >
      Linux æ€§èƒ½åˆ†æ
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/vue3/" >
      Vue.js æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/git/" >
      Git æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/network/" >
      ç½‘ç»œåè®®
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/awk/" >
      AWK æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/devops/" >
      DevOps
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/sentinel/" >
      é˜¿é‡Œå·´å·´ Sentinel
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/zipkin/" >
      Zipkin æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/eureka/" >
      Netflix Eureka æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed-storage/" >
      åˆ†å¸ƒå¼å­˜å‚¨
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/maven/" >
      Maven æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/java/" >
      Java æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/spring/" >
      Spring æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed/" >
      åˆ†å¸ƒå¼ç³»ç»Ÿä¸æ¶æ„è®¾è®¡
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/softskill/" >
      ç®´è¨€ç®´å¥
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/database/" >
      æ•°æ®åº“
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/redis/" >
      Redis
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/bigdata/" >
      å¤§æ•°æ®åœºæ™¯
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/technique/" >
      æŠ€æœ¯
  </a>


    

    






  </li>


      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Linux tail å‘½ä»¤æºç è§£æ</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#åŸºç¡€ç”¨æ³•">åŸºç¡€ç”¨æ³•</a></li>
    <li><a href="#è¯»å–å€’æ•°-n-è¡Œæºç ">è¯»å–å€’æ•° n è¡Œæºç </a></li>
    <li><a href="#æ— é™è¯»å–æ–‡ä»¶">æ— é™è¯»å–æ–‡ä»¶</a></li>
    <li><a href="#é“¾æ¥">é“¾æ¥</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script><h1 id="linux-tail-å‘½ä»¤æºç è§£æ">Linux tail å‘½ä»¤æºç è§£æ</h1>
<h2 id="åŸºç¡€ç”¨æ³•">åŸºç¡€ç”¨æ³•</h2>
<p><code>tail</code> å‘½ä»¤æ˜¯åœ¨ Linux ç³»ç»Ÿä¸Šç»å¸¸ä½¿ç”¨çš„ä¸€ä¸ªå‘½ä»¤ï¼Œå…¶èƒ½å¿«é€ŸæŸ¥çœ‹<strong>æ–‡ä»¶å°¾éƒ¨</strong>çš„å†…å®¹ã€‚å®ƒçš„åŸºæœ¬ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p>(1) <code>-n</code> æŸ¥çœ‹æœ«å°¾æŒ‡å®šè¡Œæ•°çš„å†…å®¹ï¼Œ<code>n</code> ä»£è¡¨çš„æ˜¯ <code>number</code> çš„æ„æ€ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">$ tail -n <span style="color:#ae81ff">15</span> word-list.txt
</code></pre></div><p>(2) <code>-c</code> æŸ¥çœ‹æœ«å°¾æŒ‡å®šå­—èŠ‚æ•°çš„å†…å®¹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">$ tail -c <span style="color:#ae81ff">93</span> list-2.txt
</code></pre></div><p>(3) <code>-f</code> å®æ—¶æ‰“å°æ—¥å¿—ã€‚æŸä¸ªæ–‡ä»¶çš„æœ«å°¾æœ‰æ–°çš„è¿½åŠ è¡Œçš„æ—¶å€™ï¼Œç«‹å³åœ¨æ§åˆ¶å°ä¸Šæ˜¾ç¤ºå‡ºæ¥ï¼Œç»å¸¸ç”¨è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹æŸä¸ªæ–‡ä»¶çš„å®æ—¶è¾“å‡ºçš„æ—¥å¿—ï¼Œæ–¹ä¾¿è·Ÿè¸ªé—®é¢˜ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">tail -f nginx.log
</code></pre></div><p><code>tail</code> è¿˜æœ‰ä¸€äº›å…¶ä»–ç”¨æ³•ï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œ <code>man tail</code> æ¥æŸ¥çœ‹ã€‚</p>
<h2 id="è¯»å–å€’æ•°-n-è¡Œæºç ">è¯»å–å€’æ•° n è¡Œæºç </h2>
<p><code>tail</code> å‘½ä»¤ä»æ–‡ä»¶å°¾éƒ¨æ¥æ˜¾ç¤ºæ–‡ä»¶å†…å®¹ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•åšåˆ°ä»å°¾éƒ¨åŠ¨æ€æˆ–è€…é™æ€çš„å»æ˜¾ç¤ºæ–‡ä»¶å‘¢ï¼Œå®ƒä½¿ç”¨ä¸­æœ‰å“ªäº›éœ€è¦æ³¨æ„çš„åœ°æ–¹å‘¢ï¼Ÿæ¥ä¸‹æ¥å°±å¸¦å¤§å®¶åˆ†æä¸€ä¸‹ <code>tail</code> å‘½ä»¤çš„æºç ã€‚</p>
<p>åœ¨ <code>tail</code> æºç é¡¶éƒ¨ï¼Œå³å®šä¹‰äº†ä¸€ä¸ªå¸¸é‡ï¼Œè¡¨ç¤ºå¦‚æœæ²¡æœ‰æŒ‡å®šæŸ¥çœ‹çš„é•¿åº¦ (<code>tail abc.txt</code>)ï¼Œé‚£ä¹ˆå°±é»˜è®¤æ˜¾ç¤ºè¿™ä¸ªæ–‡ä»¶å 10 è¡Œçš„å†…å®¹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">/* Number of items to tail.  */</span>
<span style="color:#75715e">#define DEFAULT_N_LINES 10
</span></code></pre></div><p>é¦–å…ˆæ˜¯æ‰“å¼€æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">fd <span style="color:#f92672">=</span> open (f<span style="color:#f92672">-&gt;</span>name, O_RDONLY <span style="color:#f92672">|</span> O_BINARY);
</code></pre></div><p>ç„¶åè°ƒç”¨ <code>tail</code> å‡½æ•°ï¼Œ<code>tail</code> å‡½æ•°å†…éƒ¨ä¼šæ ¹æ®å‚æ•°çš„ä¸åŒï¼Œé€‰æ‹© <code>tail_lines</code> è¿˜æ˜¯ <code>tail_bytes</code> æ¥è°ƒç”¨ã€‚å†æ¬¡æˆ‘ä»¬é€‰æ‹© <code>tail_lines</code> å‡½æ•°æ¥è§£é‡Šã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span>
<span style="color:#a6e22e">tail</span> (<span style="color:#66d9ef">char</span> <span style="color:#66d9ef">const</span> <span style="color:#f92672">*</span>filename, <span style="color:#66d9ef">int</span> fd, uintmax_t n_units,
      uintmax_t <span style="color:#f92672">*</span>read_pos)
{
  <span style="color:#f92672">*</span>read_pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">if</span> (count_lines)
    <span style="color:#66d9ef">return</span> tail_lines (filename, fd, n_units, read_pos);
  <span style="color:#66d9ef">else</span>
    <span style="color:#66d9ef">return</span> tail_bytes (filename, fd, n_units, read_pos);
}
</code></pre></div><p><code>tail_lines</code> å†…éƒ¨ï¼Œå…¶æ£€æŸ¥è¿™ä¸ªæ–‡ä»¶æ˜¯å¦æ˜¯ä¸€ä¸ª <strong>regular</strong> æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">S_ISREG (stats.st_mode)
</code></pre></div><p>Linux ä¸­ä¸€åˆ‡çš†æ–‡ä»¶ã€‚å¹³æ—¥æ¥è§¦åˆ°çš„æ–‡ä»¶ï¼Œä¾‹å¦‚å¯æ‰§è¡Œæ–‡ä»¶ã€æ–‡æœ¬æ–‡ä»¶ã€å›¾ç‰‡ç­‰è¿™äº›éƒ½æ˜¯ <strong>regular</strong> æ–‡ä»¶ï¼Œè¯»æˆ–è€…å†™è¿™äº›æ–‡ä»¶ï¼Œå…¶æ“ä½œé€šå¸¸éƒ½ä¸ç£ç›˜æ‰“äº¤é“ã€‚ç„¶åæ¥ä¸‹æ¥ä½¿ç”¨ <code>(start_pos = lseek (fd, 0, SEEK_CUR)) != -1</code> è¿™å¥è¯ç”¨æ¥æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯ä»¥ <code>seek</code>ï¼Œå¦‚æœå¯ä»¥ï¼Œé‚£ä¹ˆ <code>lseek (fd, 0, SEEK_END)</code> å°†æ–‡ä»¶ <code>seek</code> åˆ°å°¾éƒ¨ï¼Œå¹¶å°†æ–‡ä»¶åç§»é‡èµ‹å€¼ç»™ <code>end_pos</code>ï¼Œå¹¶è°ƒç”¨ä¸‹ä¸€ä¸ªå‡½æ•° <code>file_lines</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span> presume_input_pipe
    <span style="color:#f92672">&amp;&amp;</span> S_ISREG (stats.st_mode)
    <span style="color:#f92672">&amp;&amp;</span> (start_pos <span style="color:#f92672">=</span> lseek (fd, <span style="color:#ae81ff">0</span>, SEEK_CUR)) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
    <span style="color:#f92672">&amp;&amp;</span> start_pos <span style="color:#f92672">&lt;</span> (end_pos <span style="color:#f92672">=</span> lseek (fd, <span style="color:#ae81ff">0</span>, SEEK_END)))
{
    <span style="color:#f92672">*</span>read_pos <span style="color:#f92672">=</span> end_pos;
    <span style="color:#66d9ef">if</span> (end_pos <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> file_lines (pretty_filename, fd, n_lines,
                        start_pos, end_pos, read_pos))
    <span style="color:#66d9ef">return</span> false;
}
</code></pre></div><p><code>file_lines</code> æ˜¯ <code>tail</code> å‡½æ•°çš„æ ¸å¿ƒã€‚å…¶é¦–å…ˆå®šä¹‰äº†æ¯æ¬¡è¯»å–çš„ç¼“å†²åŒºé—´ <code>char buffer[BUFSIZ]</code>ï¼Œè¿™ä¸ª <code>BUFSIZ</code> å¤§å°åœ¨æˆ‘è‡ªå·±ç”µè„‘ä¸Šçš„å€¼æ˜¯ <code>8192</code>ã€‚ç„¶åä»å°¾éƒ¨å¼€å§‹å…ˆè¯»å– <code>((pos - start_pos) % BUFSIZ)</code> å­—èŠ‚åˆ° <code>buffer</code> ä¸­ï¼Œå³æŠŠä¸æ˜¯ <code>BUFSIZ</code> æ•´æ•°å€çš„è¿™éƒ¨åˆ†å­—èŠ‚å…ˆè¯»å–æ‰ï¼Œç„¶åå†å€’ç€æ¯æ¬¡è¯»å– <code>BUFSIZ</code> ä¸ªï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºä»å°¾éƒ¨å€’ç€è¯»å–ï¼š</p>
<pre><code>    __________
 ^ |   ...    | ...
 | |__________|
 | |          | BUFSIZ
 | |__________|
 | |          | BUFSIZ
 | |__________|
 | |__________| ((pos - start_pos) % BUFSIZ)
</code></pre><p>æ¯æ¬¡è¯»å–çš„ä½ç½®éƒ½æ˜¯é€šè¿‡ <code>xlseek</code> å‡½æ•°æ¥å®šä½çš„ï¼Œ<code>pos</code> å€¼ä¹Ÿç›¸åº”çš„æ¯æ¬¡å‡å» <code>BUFSIZ</code> ä¸ªå•ä½ <code>pos -= BUFSIZ</code>ï¼Œè¯»å–çš„æ•°æ®ä¹Ÿæ˜¯å­˜æ”¾åˆ°äº† <code>buffer</code> ä¸­ ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">pos <span style="color:#f92672">-=</span> BUFSIZ;
xlseek (fd, pos, SEEK_SET, pretty_filename);
bytes_read <span style="color:#f92672">=</span> safe_read (fd, buffer, BUFSIZ);
</code></pre></div><p>åœ¨æ¯æ¬¡è¯»å–æ•°æ®ä¹‹åï¼Œéƒ½ä¼šä»è¿™æ•°æ®ä¸­å»å¯»æ‰¾æœ‰æ²¡æœ‰æ¢è¡Œç¬¦ï¼Œä»¥ä¾¿ç»Ÿè®¡å½“å‰å·²ç»è¯»å–äº†å¤šå°‘è¡Œã€‚<code>memrchr</code> å‡½æ•°ç”¨äºåœ¨å‰ <code>n</code> ä¸ªå­—èŠ‚ä¸­ï¼Œä»åå¾€å‰æŸ¥æ‰¾æŒ‡å®šå­—ç¬¦å‡ºç°çš„ä½ç½®ï¼Œæ¯æ‰¾åˆ°ä¸€ä¸ªæ¢è¡Œç¬¦ï¼Œ<code>n_lines</code> å°±é€’å‡ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">size_t n <span style="color:#f92672">=</span> bytes_read;
<span style="color:#66d9ef">while</span> (n)
{
    <span style="color:#66d9ef">char</span> <span style="color:#66d9ef">const</span> <span style="color:#f92672">*</span>nl;
    nl <span style="color:#f92672">=</span> memrchr (buffer, line_end, n);
    <span style="color:#66d9ef">if</span> (nl <span style="color:#f92672">==</span> NULL)
        <span style="color:#66d9ef">break</span>;
    n <span style="color:#f92672">=</span> nl <span style="color:#f92672">-</span> buffer;
    <span style="color:#66d9ef">if</span> (n_lines<span style="color:#f92672">--</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) 
    {
        <span style="color:#75715e">// æ‰“å°æ•°æ®
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> true;
    }
}
</code></pre></div><p>å½“æœ€å <code>n_lines</code> å‡å°‘ä¸º 0 çš„æ—¶å€™ï¼Œè¯´æ˜å·²ç»è¯»å–åˆ°äº†å€’æ•°ç¬¬ <code>n</code> è¡Œçš„ä½ç½®ï¼Œé‚£ä¹ˆæ­¤æ—¶å¼€å§‹å¾€å±å¹•ä¸Šæ‰“å°å°¾éƒ¨ <code>n</code> è¡Œçš„æ•°æ®ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">xwrite_stdout (nl <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, bytes_read <span style="color:#f92672">-</span> (n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>));
<span style="color:#f92672">*</span>read_pos <span style="color:#f92672">+=</span> dump_remainder (false, pretty_filename, fd,
                            end_pos <span style="color:#f92672">-</span> (pos <span style="color:#f92672">+</span> bytes_read));
</code></pre></div><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶é¦–å…ˆæ‰“å°ä» <code>nl + 1</code> å­—ç¬¦å¼€å§‹çš„ <code>bytes - (n + 1)</code> ä¸ªå­—ç¬¦ï¼š</p>
<pre><code>buffer                   bytes_read
   [     \n         \n      ]
         nl----------------&gt;
</code></pre><p>æœ€åä¸€æ¬¡ä»å½“å‰ <code>pos</code> ä½ç½®è¯»å–æ•°æ®åˆ° <code>BUFFER</code> çš„æ—¶å€™ï¼Œæ–‡ä»¶çš„ä½ç½®ä¹Ÿç§»åŠ¨åˆ°äº† <code>pos + bytes</code> çš„ä½ç½® (<code>safe_read</code> æœ¬èº«ä¼šæ”¹å˜ <code>fd</code> å…³è”çš„ä½ç½®)ï¼Œç„¶åè°ƒç”¨ <code>dump_remainder</code> å‡½æ•°ï¼Œå†ä» <code>fd</code> çš„å½“å‰ä½ç½®æ¯éš” <code>BUFSIZ</code> è¯»å–å¹¶æ‰“å°ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">while</span> (true)
{
    <span style="color:#66d9ef">char</span> buffer[BUFSIZ];
    size_t n <span style="color:#f92672">=</span> MIN (n_remaining, BUFSIZ);
    size_t bytes_read <span style="color:#f92672">=</span> safe_read (fd, buffer, n);
    <span style="color:#66d9ef">if</span> (bytes_read <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
        <span style="color:#66d9ef">break</span>;

    xwrite_stdout (buffer, bytes_read);
}
</code></pre></div><h2 id="æ— é™è¯»å–æ–‡ä»¶">æ— é™è¯»å–æ–‡ä»¶</h2>
<p>å½“ <code>tail</code> å‡½æ•°å¢åŠ  <code>-f</code> é€‰é¡¹çš„æ—¶å€™ï¼Œé‚£ä¹ˆåœ¨æ‰“å°å‡ºå€’æ•°è‹¥å¹²è¡Œä¹‹åï¼Œæ¥ä¸‹æ¥åªè¦è¿™ä¸ªæ–‡ä»¶æœ‰å˜åŠ¨ï¼Œä¾¿ä¼šç«‹å³æ‰“å°å‡ºæ¥å°¾éƒ¨è¿½åŠ å˜åŠ¨çš„æ•°æ®åˆ°æ§åˆ¶å°ä¸Šã€‚</p>
<p>åœ¨é»˜è®¤é…ç½®ä¸‹ï¼Œ<code>tail</code> ä½¿ç”¨ <code>xnanosleep</code> å‡½æ•°æ¯éš” 1 ç§’æ£€æµ‹ä¸€æ¬¡æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">// æ¯éš” 1 ç§’æ£€æŸ¥ä¸€æ¬¡
</span><span style="color:#75715e"></span><span style="color:#66d9ef">double</span> sleep_interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>;
tail_forever (F, n_files, sleep_interval);
</code></pre></div><p>åœ¨ <code>tail_forever</code> å‡½æ•°å†…éƒ¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶æ ¹æ®<strong>æ–‡ä»¶å¤§å°</strong>ä»¥åŠ<strong>æ–‡ä»¶çš„ä¿®æ”¹æ—¥æœŸ</strong>ï¼Œæ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">if</span> (f[i].mode <span style="color:#f92672">==</span> stats.st_mode
    <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">!</span> S_ISREG (stats.st_mode) <span style="color:#f92672">||</span> f[i].size <span style="color:#f92672">==</span> stats.st_size)
    <span style="color:#f92672">&amp;&amp;</span> timespec_cmp (f[i].mtime, get_stat_mtime (<span style="color:#f92672">&amp;</span>stats)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
{
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">continue</span>;
}
</code></pre></div><p>å¦‚æœå‘ç”Ÿäº†å˜åŒ–ï¼Œå…¶è°ƒç”¨ <code>dump_remainder</code> å‡½æ•°å°†å½“å‰ä½ç½®åˆ°æœ«å°¾çš„æ•°æ®æ‰“å°åˆ°æ§åˆ¶å°ä¸Šã€‚</p>
<h2 id="é“¾æ¥">é“¾æ¥</h2>
<ul>
<li><a href="http://git.savannah.gnu.org/cgit/coreutils.git/tree/src/tail.c">coreutils.git: tail</a></li>
</ul>

<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#åŸºç¡€ç”¨æ³•">åŸºç¡€ç”¨æ³•</a></li>
    <li><a href="#è¯»å–å€’æ•°-n-è¡Œæºç ">è¯»å–å€’æ•° n è¡Œæºç </a></li>
    <li><a href="#æ— é™è¯»å–æ–‡ä»¶">æ— é™è¯»å–æ–‡ä»¶</a></li>
    <li><a href="#é“¾æ¥">é“¾æ¥</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>



</html>












