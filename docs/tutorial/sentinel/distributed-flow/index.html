<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="åˆ†å¸ƒå¼é™æµå®ç°åŸç†"><meta property="og:title" content="åˆ†å¸ƒå¼é™æµå®ç°åŸç†" />
<meta property="og:description" content="åˆ†å¸ƒå¼é™æµå®ç°åŸç†  æœ¬æ–‡è®²è¿° Sentinel çš„åˆ†å¸ƒå¼é™æµåŸç†ã€‚
 æ¨¡å—æ„æˆ Sentinel çš„åˆ†å¸ƒå¼é™æµæ¨¡å—åŒ…å«ï¼š
 sentinel-cluster-common-default: é›†ç¾¤é€šä¿¡çš„ä¸€äº›é€šç”¨çš„ç±»ã€å¸¸é‡ç­‰å®ç° sentinel-cluster-client-default: é»˜è®¤çš„ä½¿ç”¨ Netty ä½œä¸ºåº•å±‚é€šè®¯çš„é›†ç¾¤ Client ç«¯ sentinel-cluster-server-default: é»˜è®¤çš„é›†ç¾¤ Server ç«¯  common-default æ¨¡å—å¹¶æ²¡æœ‰å®é™…çš„é€»è¾‘ï¼Œåªæ˜¯ä¸€äº›å…±ç”¨çš„ç±»ä¹‹ç±»çš„å®ç°ï¼Œä¸å†èµ˜è¿°ã€‚
Client ç«¯ åˆå§‹åŒ– Bootstrap Client ç«¯åˆå§‹åŒ– Bootstrap å¹¶å°è¯•è¿æ¥ Server ç«¯ï¼š
// NettyTransportClient.java private Bootstrap initClientBootstrap() { Bootstrap b = new Bootstrap(); eventLoopGroup = new NioEventLoopGroup(); b.group(eventLoopGroup) .channel(NioSocketChannel.class) .option(ChannelOption.TCP_NODELAY, true) .option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT) .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, ClusterClientConfigManager.getConnectTimeout()) .handler(new ChannelInitializer&lt;SocketChannel&gt;() { @Override public void initChannel(SocketChannel ch) throws Exception { clientHandler = new TokenClientHandler(currentState, disconnectCallback); ChannelPipeline pipeline = ch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/tutorial/sentinel/distributed-flow/" />

<title>åˆ†å¸ƒå¼é™æµå®ç°åŸç† | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.7ebac727e739c3b4aee6328926e3b77ac1ddd5e9035221b7ec206fda1a413a4d.css" integrity="sha256-frrHJ&#43;c5w7Su5jKJJuO3esHd1ekDUiG37CBv2hpBOk0=">


<script defer src="/en.search.min.6d6edddfbc8503541175d2f33fea9f8f170282b3138cc2d85813dc845293f964.js" integrity="sha256-bW7d37yFA1QRddLzP&#43;qfjxcCgrMTjMLYWBPchFKT&#43;WQ="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/front-end-optimization-guide/" >
      å‰ç«¯ä¼˜åŒ–æŒ‡å—
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/algorithm/" >
      ç®—æ³•
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/raft/" >
      raft
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-command/" >
      UNIX å¸¸ç”¨å‘½ä»¤å¤§å…¨
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-optimize/" >
      UNIX æ€§èƒ½ä¼˜åŒ–
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/vue3/" >
      Vue.js æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/git/" >
      Git æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/network/" >
      ç½‘ç»œåè®®
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/awk/" >
      AWK æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/devops/" >
      DevOps
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/sentinel/" >
      é˜¿é‡Œå·´å·´ Sentinel
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/tutorial/sentinel/architecture/" >
      æ¶æ„
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/sentinel/leaparray/" >
      åŸºäº LeapArray çš„ç»Ÿè®¡
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/sentinel/flow/" >
      é™æµå®ç°åŸç†
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/sentinel/distributed-flow/"  class="active">
      åˆ†å¸ƒå¼é™æµå®ç°åŸç†
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/sentinel/webmvc-flow/" >
      WebMVC é™æµå®ç°åŸç†
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/sentinel/spi/" >
      å¯æ‰©å±•æ€§
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/zipkin/" >
      Zipkin æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/eureka/" >
      Netflix Eureka æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed-storage/" >
      åˆ†å¸ƒå¼å­˜å‚¨
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/maven/" >
      Maven æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/java/" >
      Java æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/spring/" >
      Spring æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed/" >
      åˆ†å¸ƒå¼ç³»ç»Ÿä¸æ¶æ„è®¾è®¡
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/softskill/" >
      ç®´è¨€ç®´å¥
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/database/" >
      æ•°æ®åº“
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/redis/" >
      Redis
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/bigdata/" >
      å¤§æ•°æ®åœºæ™¯
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/technique/" >
      æŠ€æœ¯
  </a>


    

    






  </li>


      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>åˆ†å¸ƒå¼é™æµå®ç°åŸç†</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#æ¨¡å—æ„æˆ">æ¨¡å—æ„æˆ</a></li>
    <li><a href="#client-ç«¯">Client ç«¯</a>
      <ul>
        <li><a href="#åˆå§‹åŒ–-bootstrap">åˆå§‹åŒ– Bootstrap</a></li>
        <li><a href="#æ¶ˆæ¯ç±»å‹">æ¶ˆæ¯ç±»å‹</a></li>
        <li><a href="#é™æµçš„æ¶ˆæ¯æ ¼å¼">é™æµçš„æ¶ˆæ¯æ ¼å¼</a></li>
        <li><a href="#è¯·æ±‚é™æµ-token">è¯·æ±‚é™æµ Token</a></li>
      </ul>
    </li>
    <li><a href="#server-ç«¯">Server ç«¯</a>
      <ul>
        <li><a href="#åˆå§‹åŒ–-netty">åˆå§‹åŒ– Netty</a></li>
        <li><a href="#tokenservice">TokenService</a></li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script><h1 id="åˆ†å¸ƒå¼é™æµå®ç°åŸç†">åˆ†å¸ƒå¼é™æµå®ç°åŸç†</h1>
<blockquote>
<p>æœ¬æ–‡è®²è¿° Sentinel çš„åˆ†å¸ƒå¼é™æµåŸç†ã€‚</p>
</blockquote>
<h2 id="æ¨¡å—æ„æˆ">æ¨¡å—æ„æˆ</h2>
<p>Sentinel çš„åˆ†å¸ƒå¼é™æµæ¨¡å—åŒ…å«ï¼š</p>
<ul>
<li><code>sentinel-cluster-common-default</code>: é›†ç¾¤é€šä¿¡çš„ä¸€äº›é€šç”¨çš„ç±»ã€å¸¸é‡ç­‰å®ç°</li>
<li><code>sentinel-cluster-client-default</code>: é»˜è®¤çš„ä½¿ç”¨ Netty ä½œä¸ºåº•å±‚é€šè®¯çš„é›†ç¾¤ Client ç«¯</li>
<li><code>sentinel-cluster-server-default</code>: é»˜è®¤çš„é›†ç¾¤ Server ç«¯</li>
</ul>
<p><code>common-default</code> æ¨¡å—å¹¶æ²¡æœ‰å®é™…çš„é€»è¾‘ï¼Œåªæ˜¯ä¸€äº›å…±ç”¨çš„ç±»ä¹‹ç±»çš„å®ç°ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="client-ç«¯">Client ç«¯</h2>
<h3 id="åˆå§‹åŒ–-bootstrap">åˆå§‹åŒ– Bootstrap</h3>
<p>Client ç«¯åˆå§‹åŒ– <code>Bootstrap</code> å¹¶å°è¯•è¿æ¥ Server ç«¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// NettyTransportClient.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> Bootstrap <span style="color:#a6e22e">initClientBootstrap</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Bootstrap b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Bootstrap<span style="color:#f92672">();</span>
    eventLoopGroup <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NioEventLoopGroup<span style="color:#f92672">();</span>
    b<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">(</span>eventLoopGroup<span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">(</span>NioSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">option</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">TCP_NODELAY</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">option</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">ALLOCATOR</span><span style="color:#f92672">,</span> PooledByteBufAllocator<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">option</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">CONNECT_TIMEOUT_MILLIS</span><span style="color:#f92672">,</span> ClusterClientConfigManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getConnectTimeout</span><span style="color:#f92672">())</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">handler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ChannelInitializer<span style="color:#f92672">&lt;</span>SocketChannel<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initChannel</span><span style="color:#f92672">(</span>SocketChannel ch<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
                clientHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TokenClientHandler<span style="color:#f92672">(</span>currentState<span style="color:#f92672">,</span> disconnectCallback<span style="color:#f92672">);</span>

                ChannelPipeline pipeline <span style="color:#f92672">=</span> ch<span style="color:#f92672">.</span><span style="color:#a6e22e">pipeline</span><span style="color:#f92672">();</span>
                pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LengthFieldBasedFrameDecoder<span style="color:#f92672">(</span>1024<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 2<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 2<span style="color:#f92672">));</span>
                pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> NettyResponseDecoder<span style="color:#f92672">());</span>
                pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LengthFieldPrepender<span style="color:#f92672">(</span>2<span style="color:#f92672">));</span>
                pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> NettyRequestEncoder<span style="color:#f92672">());</span>
                pipeline<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span>clientHandler<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">});</span>

    <span style="color:#66d9ef">return</span> b<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

b<span style="color:#f92672">.</span><span style="color:#a6e22e">connect</span><span style="color:#f92672">(</span>host<span style="color:#f92672">,</span> port<span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">addListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> GenericFutureListener<span style="color:#f92672">&lt;</span>ChannelFuture<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">operationComplete</span><span style="color:#f92672">(</span>ChannelFuture future<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ‰“å°è¿æ¥æ˜¯å¦å¼‚å¸¸çš„æ—¥å¿—
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>future<span style="color:#f92672">.</span><span style="color:#a6e22e">cause</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">});</span>
</code></pre></div><p>å®¢æˆ·ç«¯å¯¹äº Socket è¿æ¥çš„å»ºç«‹å’Œå¯ç”¨æ€§æä¾›äº†<strong>ä¸€å®šçš„ä¿éšœ</strong>ï¼š</p>
<ul>
<li>åŸå­æ“ä½œåŠ  <code>PENDING</code> çŠ¶æ€ï¼Œé¿å…åœ¨æ­£åœ¨å¯åŠ¨æˆ–è€…æ­£åœ¨å…³é—­çš„æ—¶å€™ï¼Œè¿ç»­ä¸¤æ¬¡è°ƒç”¨ <code>start</code> æˆ–è€… <code>stop</code> æ“ä½œã€‚</li>
</ul>
<pre><code>OFF -&gt; PENDING -&gt; STARTED
STARTED -&gt; PENDING -&gt; OFF
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AtomicInteger currentState <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicInteger<span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">CLIENT_STATUS_OFF</span><span style="color:#f92672">);</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">connect</span><span style="color:#f92672">(</span>Bootstrap b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentState<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">CLIENT_STATUS_OFF</span><span style="color:#f92672">,</span> ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">CLIENT_STATUS_PENDING</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å»ºç«‹è¿æ¥
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">stop</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>currentState<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">CLIENT_STATUS_PENDING</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>200<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Ignore.
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// åœæ­¢è¿æ¥
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p><code>TokenClientHandler</code> ç›‘å¬ Channel çŠ¶æ€ï¼Œåˆ‡æ¢ä¸º <code>STARTED</code> æˆ–è€… <code>OFF</code> çŠ¶æ€ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenClientHandler</span> <span style="color:#66d9ef">extends</span> ChannelInboundHandlerAdapter <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">channelActive</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        currentState<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">CLIENT_STATUS_STARTED</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">channelUnregistered</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        currentState<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">CLIENT_STATUS_OFF</span><span style="color:#f92672">);</span>

        disconnectCallback<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>æ–­å¼€è¿æ¥çš„æ—¶å€™è‡ªåŠ¨å®šæ—¶é‡è¿ï¼Œè¿æ¥çš„æ“ä½œæ˜¯æ”¾åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ± ä¸­å•ç‹¬æ‰§è¡Œçš„ã€‚åŒæ—¶ç»“åˆ <code>shouldRetry</code> çš„çŠ¶æ€ä½ï¼Œå½“æ‰‹åŠ¨ç¡®å®æ˜¯è¦ stop çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±æ— éœ€é‡è¯•å°è¯•è¿æ¥äº†ï¼Œç¡®ä¿åªåœ¨è¿æ¥çªç„¶æ–­æ‰çš„çŠ¶æ€ä¸‹ï¼Œæ‰å°è¯•è¿æ¥ã€‚</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AtomicBoolean shouldRetry <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicBoolean<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ScheduledExecutorService SCHEDULER <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newScheduledThreadPool</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">new</span> NamedThreadFactory<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;sentinel-cluster-transport-client-scheduler&#34;</span><span style="color:#f92672">));</span>

SCHEDULER<span style="color:#f92672">.</span><span style="color:#a6e22e">schedule</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>shouldRetry<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                startInternal<span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                RecordLog<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[NettyTransportClient] Failed to reconnect to server&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">},</span> RECONNECT_DELAY_MS <span style="color:#f92672">*</span> <span style="color:#f92672">(</span>failConnectedTime<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> 1<span style="color:#f92672">),</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>        
</code></pre></div><h3 id="æ¶ˆæ¯ç±»å‹">æ¶ˆæ¯ç±»å‹</h3>
<p>Client ç«¯ä¼šå‘é€ä¸‰ç§ç±»å‹çš„æ¶ˆæ¯ï¼š<code>PING</code>ã€<code>PONG</code> å’Œ <code>PARAM_FLOW</code>ã€‚æ¯ç§ç±»å‹çš„æ¶ˆæ¯ï¼Œéƒ½ç›¸åº”çš„æ³¨å†Œäº† <code>RequestDataWriter</code> å’Œ <code>ResponseDataDecoder</code>ã€‚</p>
<ul>
<li><code>Writer</code>ï¼šæ¶ˆæ¯å†™å…¥åˆ°æµï¼Œå†™å…¥çš„é¡ºåºï¼Œå†™å…¥çš„æ–¹å¼ç­‰ã€‚</li>
<li><code>Decoder</code>ï¼šä»æµä¸­è¯»å–è¯¥æ¶ˆæ¯çš„å“åº”ï¼Œå¹¶è§£ææˆåˆé€‚çš„å“åº”ä½“ç»“æœã€‚</li>
</ul>
<p>åœ¨ Client å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå°†è¿™äº›æ¶ˆæ¯çš„ Writer å’Œ Decoder æ³¨å†Œåˆ° <code>RequestDataWriterRegistry</code> å’Œ <code>ResponseDataDecodeRegistry</code> ä¸­å¿ƒã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#a6e22e">@InitOrder</span><span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultClusterClientInitFunc</span> <span style="color:#66d9ef">implements</span> InitFunc <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        initDefaultEntityWriters<span style="color:#f92672">();</span>
        initDefaultEntityDecoders<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initDefaultEntityWriters</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        RequestDataWriterRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">addWriter</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_PING</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> PingRequestDataWriter<span style="color:#f92672">());</span>
        RequestDataWriterRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">addWriter</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_FLOW</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> FlowRequestDataWriter<span style="color:#f92672">());</span>
        Integer maxParamByteSize <span style="color:#f92672">=</span> ClusterClientStartUpConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxParamByteSize</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>maxParamByteSize <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            RequestDataWriterRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">addWriter</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_PARAM_FLOW</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ParamFlowRequestDataWriter<span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            RequestDataWriterRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">addWriter</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_PARAM_FLOW</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ParamFlowRequestDataWriter<span style="color:#f92672">(</span>maxParamByteSize<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initDefaultEntityDecoders</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        ResponseDataDecodeRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">addDecoder</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_PING</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> PingResponseDataDecoder<span style="color:#f92672">());</span>
        ResponseDataDecodeRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">addDecoder</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_FLOW</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> FlowResponseDataDecoder<span style="color:#f92672">());</span>
        ResponseDataDecodeRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">addDecoder</span><span style="color:#f92672">(</span>ClientConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">TYPE_PARAM_FLOW</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> FlowResponseDataDecoder<span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨ <code>NettyResponseDecoder</code> ä¸­ï¼Œå…¶æ ¹æ® <code>ClientEntityCodecProvider</code> æŸ¥æ‰¾åˆ°äº†é»˜è®¤çš„ <code>Decoder</code> å®ç°ç±» (<code>DefaultResponseEntityDecoder</code>)ï¼Œç„¶ååœ¨å…¶å†…éƒ¨ï¼Œæ ¹æ®ä¸åŒçš„æ¶ˆæ¯ç±»å‹ï¼Œä»ä¸Šè¿°çš„ <code>ResponseDataDecodeRegistry</code> æ³¨å†Œä¸­å¿ƒä¸­æŸ¥æ‰¾å¯¹åº”çš„ <code>EntityDecoder</code> è¿›è¡Œ <code>decode</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NettyResponseDecoder</span> <span style="color:#66d9ef">extends</span> ByteToMessageDecoder <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">,</span> ByteBuf in<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> out<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        ResponseEntityDecoder<span style="color:#f92672">&lt;</span>ByteBuf<span style="color:#f92672">,</span> Response<span style="color:#f92672">&gt;</span> responseDecoder <span style="color:#f92672">=</span> ClientEntityCodecProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponseEntityDecoder</span><span style="color:#f92672">();</span>
        Response response <span style="color:#f92672">=</span> responseDecoder<span style="color:#f92672">.</span><span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span>in<span style="color:#f92672">);</span>
        out<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>response<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>é»˜è®¤çš„ <code>Decoder</code> çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<pre><code>+--------+---------+-----------+---------+
| xid(4) | type(1) | status(1) | data... |
+--------+---------+-----------+---------+
</code></pre><p>å½“è§£æå®Œä¹‹åï¼Œå°†æ•°æ®ç­‰å“åº”ä¿¡æ¯å°è£…ä¸º <code>ClusterResponse</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultResponseEntityDecoder</span> <span style="color:#66d9ef">implements</span> ResponseEntityDecoder<span style="color:#f92672">&lt;</span>ByteBuf<span style="color:#f92672">,</span> ClusterResponse<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> ClusterResponse <span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span>ByteBuf source<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>source<span style="color:#f92672">.</span><span style="color:#a6e22e">readableBytes</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> 6<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> xid <span style="color:#f92672">=</span> source<span style="color:#f92672">.</span><span style="color:#a6e22e">readInt</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">int</span> type <span style="color:#f92672">=</span> source<span style="color:#f92672">.</span><span style="color:#a6e22e">readByte</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">int</span> status <span style="color:#f92672">=</span> source<span style="color:#f92672">.</span><span style="color:#a6e22e">readByte</span><span style="color:#f92672">();</span>

            EntityDecoder<span style="color:#f92672">&lt;</span>ByteBuf<span style="color:#f92672">,</span> <span style="color:#f92672">?&gt;</span> decoder <span style="color:#f92672">=</span> ResponseDataDecodeRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">getDecoder</span><span style="color:#f92672">(</span>type<span style="color:#f92672">);</span>

            Object data<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>source<span style="color:#f92672">.</span><span style="color:#a6e22e">readableBytes</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                data <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                data <span style="color:#f92672">=</span> decoder<span style="color:#f92672">.</span><span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ClusterResponse<span style="color:#f92672">&lt;&gt;(</span>xid<span style="color:#f92672">,</span> type<span style="color:#f92672">,</span> status<span style="color:#f92672">,</span> data<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>åŒç†ï¼Œå¯¹äº <code>Writer</code> çš„å®ç°ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„å¥—è·¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultRequestEntityWriter</span> <span style="color:#66d9ef">implements</span> RequestEntityWriter<span style="color:#f92672">&lt;</span>ClusterRequest<span style="color:#f92672">,</span> ByteBuf<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">writeTo</span><span style="color:#f92672">(</span>ClusterRequest request<span style="color:#f92672">,</span> ByteBuf target<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> type <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">();</span>
        EntityWriter<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">,</span> ByteBuf<span style="color:#f92672">&gt;</span> requestDataWriter <span style="color:#f92672">=</span> RequestDataWriterRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">(</span>type<span style="color:#f92672">);</span>

        <span style="color:#75715e">// Write head part of request.
</span><span style="color:#75715e"></span>        writeHead<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> target<span style="color:#f92672">);</span>
        <span style="color:#75715e">// Write data part.
</span><span style="color:#75715e"></span>        requestDataWriter<span style="color:#f92672">.</span><span style="color:#a6e22e">writeTo</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getData</span><span style="color:#f92672">(),</span> target<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">writeHead</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">,</span> ByteBuf out<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        out<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">());</span>
        out<span style="color:#f92672">.</span><span style="color:#a6e22e">writeByte</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="é™æµçš„æ¶ˆæ¯æ ¼å¼">é™æµçš„æ¶ˆæ¯æ ¼å¼</h3>
<pre><code>+-------------------+--------------+----------------+---------------+------------------+
| RequestID(8 byte) | Type(1 byte) | FlowID(8 byte) | Count(4 byte) | PriorityFlag (1) |
+-------------------+--------------+----------------+---------------+------------------+
</code></pre><h3 id="è¯·æ±‚é™æµ-token">è¯·æ±‚é™æµ Token</h3>
<p>Sentinel å®¢æˆ·ç«¯åœ¨æ‰§è¡Œé™æµç®—å‘å•Šçš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­æ˜¯å¦æ˜¯åˆ†å¸ƒå¼é™æµè¿˜æ˜¯æœ¬åœ°æœºå™¨é™æµã€‚å¦‚æœæŸä¸ªé™æµè§„åˆ™æ˜¯éœ€è¦<strong>åˆ†å¸ƒå¼é™æµ</strong>ï¼Œé‚£ä¹ˆé¦–å…ˆè·å–ä¸€ä¸ª <code>TokenService</code>ï¼Œä»è¿™ä¸ª Service ä¸Šå»è¯·æ±‚ <code>TokenResult</code>ï¼Œç„¶åæ ¹æ®è¯·æ±‚åˆ°çš„ <code>TokenResult</code> å†³å®šæ˜¯å¦è¿›è¡Œé™æµã€‚åœ¨è¿™ä¹‹é—´å¦‚æœå‘ç”Ÿäº†æ¯”å¦‚æœªé…ç½® <code>TokenService</code> æˆ–è€…æŠ›å‡ºäº†å¼‚å¸¸ï¼Œåˆ™ä¼šé™çº§ä¸ºé‡‡ç”¨æœ¬åœ°çš„é™æµç­–ç•¥æ¥è¿›è¡Œé™æµã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// FlowRuleChecker.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">canPassCheck</span><span style="color:#f92672">(</span><span style="color:#75715e">/*@NonNull*/</span> FlowRule rule<span style="color:#f92672">,</span> Context context<span style="color:#f92672">,</span> DefaultNode node<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> acquireCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> prioritized<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// å¦‚æœæ˜¯é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rule<span style="color:#f92672">.</span><span style="color:#a6e22e">isClusterMode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> passClusterCheck<span style="color:#f92672">(</span>rule<span style="color:#f92672">,</span> context<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">,</span> prioritized<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">return</span> passLocalCheck<span style="color:#f92672">(</span>rule<span style="color:#f92672">,</span> context<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">,</span> prioritized<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">passClusterCheck</span><span style="color:#f92672">(</span>FlowRule rule<span style="color:#f92672">,</span> Context context<span style="color:#f92672">,</span> DefaultNode node<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> acquireCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> prioritized<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        TokenService clusterService <span style="color:#f92672">=</span> pickClusterService<span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clusterService <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> fallbackToLocalOrPass<span style="color:#f92672">(</span>rule<span style="color:#f92672">,</span> context<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">,</span> prioritized<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">long</span> flowId <span style="color:#f92672">=</span> rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getClusterConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getFlowId</span><span style="color:#f92672">();</span>
        TokenResult result <span style="color:#f92672">=</span> clusterService<span style="color:#f92672">.</span><span style="color:#a6e22e">requestToken</span><span style="color:#f92672">(</span>flowId<span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">,</span> prioritized<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> applyTokenResult<span style="color:#f92672">(</span>result<span style="color:#f92672">,</span> rule<span style="color:#f92672">,</span> context<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">,</span> prioritized<span style="color:#f92672">);</span>
        <span style="color:#75715e">// If client is absent, then fallback to local mode.
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        RecordLog<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[FlowRuleChecker] Request cluster token unexpected failed&#34;</span><span style="color:#f92672">,</span> ex<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// Fallback to local flow control when token client or server for this rule is not available.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// If fallback is not enabled, then directly pass.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> fallbackToLocalOrPass<span style="color:#f92672">(</span>rule<span style="color:#f92672">,</span> context<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">,</span> prioritized<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸Šè¿° <code>pickClusterService</code> çš„å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> TokenService <span style="color:#a6e22e">pickClusterService</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ClusterStateManager<span style="color:#f92672">.</span><span style="color:#a6e22e">isClient</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> TokenClientProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">getClient</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ClusterStateManager<span style="color:#f92672">.</span><span style="color:#a6e22e">isServer</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> EmbeddedClusterTokenServerProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">getServer</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“ä»¥é›†ç¾¤å¯åŠ¨çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿”å›çš„å°±æ˜¯ <code>TokenClientProvider.getClient()</code>ã€‚åœ¨è¿™ä¸ª Client å†…éƒ¨ï¼Œ<code>requestToken</code> æ–¹æ³•å°è£…çš„å°±æ˜¯<strong>å‘é€é™æµè¯·æ±‚</strong>çš„å‚æ•°ï¼Œè·å–é™æµå“åº”çš„è¿‡ç¨‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// DefaultClusterTokenClient.java
</span><span style="color:#75715e"></span><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> TokenResult <span style="color:#a6e22e">requestToken</span><span style="color:#f92672">(</span>Long flowId<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> acquireCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> prioritized<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>notValidRequest<span style="color:#f92672">(</span>flowId<span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> badRequest<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    FlowRequestData data <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FlowRequestData<span style="color:#f92672">().</span><span style="color:#a6e22e">setCount</span><span style="color:#f92672">(</span>acquireCount<span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">setFlowId</span><span style="color:#f92672">(</span>flowId<span style="color:#f92672">).</span><span style="color:#a6e22e">setPriority</span><span style="color:#f92672">(</span>prioritized<span style="color:#f92672">);</span>
    ClusterRequest<span style="color:#f92672">&lt;</span>FlowRequestData<span style="color:#f92672">&gt;</span> request <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClusterRequest<span style="color:#f92672">&lt;&gt;(</span>ClusterConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">MSG_TYPE_FLOW</span><span style="color:#f92672">,</span> data<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        TokenResult result <span style="color:#f92672">=</span> sendTokenRequest<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
        logForResult<span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ClusterClientStatLogUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">(</span>ex<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> TokenResult<span style="color:#f92672">(</span>TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">FAIL</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥ç»§ç»­çœ‹ï¼Œè·å–åˆ°çš„ <code>TokenResult</code>ï¼Œæœ‰å“ªäº›ç»“æœï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// FlowRuleChecker.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">applyTokenResult</span><span style="color:#f92672">(</span><span style="color:#75715e">/*@NonNull*/</span> TokenResult result<span style="color:#f92672">,</span> FlowRule rule<span style="color:#f92672">,</span> Context context<span style="color:#f92672">,</span>
                                                        DefaultNode node<span style="color:#f92672">,</span>
                                                        <span style="color:#66d9ef">int</span> acquireCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> prioritized<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getStatus</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">OK</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">SHOULD_WAIT</span><span style="color:#f92672">:</span>
            <span style="color:#75715e">// Wait for next tick.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getWaitInMs</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">NO_RULE_EXISTS</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">case</span> TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">BAD_REQUEST</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">case</span> TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">FAIL</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">case</span> TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">TOO_MANY_REQUEST</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> fallbackToLocalOrPass<span style="color:#f92672">(</span>rule<span style="color:#f92672">,</span> context<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">,</span> prioritized<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">case</span> TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">BLOCKED</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>é€šè¿‡ä¸Šè¿°ä»£ç ç‰‡æ®µå¯çŸ¥ï¼Œåªæœ‰ <code>TokenResult</code> æ˜ç¡®è¿”å›äº† <code>OK</code> æˆ–è€… <code>SHOULD_WAIT</code> çš„æ—¶å€™æ‰ä¼šä¸è¿›è¡Œé™æµï¼›å…¶ä»–æƒ…å†µï¼Œæ¯”å¦‚è§„åˆ™ä¸å­˜åœ¨ã€è¯·æ±‚ä¸åˆæ³•ã€éœ€è¦é˜»å¡ç­‰ï¼Œä¸€å¾‹æ‰§è¡Œé™æµç­–ç•¥ã€‚</p>
<h2 id="server-ç«¯">Server ç«¯</h2>
<h3 id="åˆå§‹åŒ–-netty">åˆå§‹åŒ– Netty</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// NettyTransportServer.java
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// é»˜è®¤ 2 * CPU æ ¸æ•° ä¸ª Worker çº¿ç¨‹
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_EVENT_LOOP_THREADS <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span>
        SystemPropertyUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;io.netty.eventLoopThreads&#34;</span><span style="color:#f92672">,</span> Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">availableProcessors</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> 2<span style="color:#f92672">));</span>

<span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    ServerBootstrap b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ServerBootstrap<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">bossGroup</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NioEventLoopGroup<span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">workerGroup</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NioEventLoopGroup<span style="color:#f92672">(</span>DEFAULT_EVENT_LOOP_THREADS<span style="color:#f92672">);</span>
    b<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">(</span>bossGroup<span style="color:#f92672">,</span> workerGroup<span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">(</span>NioServerSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">option</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">SO_BACKLOG</span><span style="color:#f92672">,</span> 128<span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">handler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LoggingHandler<span style="color:#f92672">(</span>LogLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">INFO</span><span style="color:#f92672">))</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">childHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ChannelInitializer<span style="color:#f92672">&lt;</span>SocketChannel<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initChannel</span><span style="color:#f92672">(</span>SocketChannel ch<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
                ChannelPipeline p <span style="color:#f92672">=</span> ch<span style="color:#f92672">.</span><span style="color:#a6e22e">pipeline</span><span style="color:#f92672">();</span>
                p<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LengthFieldBasedFrameDecoder<span style="color:#f92672">(</span>1024<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 2<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 2<span style="color:#f92672">));</span>
                p<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> NettyRequestDecoder<span style="color:#f92672">());</span>
                p<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LengthFieldPrepender<span style="color:#f92672">(</span>2<span style="color:#f92672">));</span>
                p<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> NettyResponseEncoder<span style="color:#f92672">());</span>
                p<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenServerHandler<span style="color:#f92672">(</span>connectionPool<span style="color:#f92672">));</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">})</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">childOption</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">ALLOCATOR</span><span style="color:#f92672">,</span> PooledByteBufAllocator<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">childOption</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">SO_SNDBUF</span><span style="color:#f92672">,</span> 32 <span style="color:#f92672">*</span> 1024<span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">childOption</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">CONNECT_TIMEOUT_MILLIS</span><span style="color:#f92672">,</span> 10000<span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">childOption</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">SO_TIMEOUT</span><span style="color:#f92672">,</span> 10<span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">childOption</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">TCP_NODELAY</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">childOption</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">SO_RCVBUF</span><span style="color:#f92672">,</span> 32 <span style="color:#f92672">*</span> 1024<span style="color:#f92672">);</span>
    b<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span>port<span style="color:#f92672">).</span><span style="color:#a6e22e">addListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> GenericFutureListener<span style="color:#f92672">&lt;</span>ChannelFuture<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">operationComplete</span><span style="color:#f92672">(</span>ChannelFuture future<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>future<span style="color:#f92672">.</span><span style="color:#a6e22e">cause</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æ‰“å°å¯åŠ¨å¤±è´¥æ—¥å¿—
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Server ç«¯çš„ Netty å¯åŠ¨ï¼ŒåŒæ ·å€ŸåŠ© <code>PENDING</code> çŠ¶æ€é¿å…å¤šæ¬¡å¯åŠ¨/åœæ­¢ Serverã€‚å¦å¤– Server ç«¯è¿˜å»ºç«‹äº†ä¸€ä¸ªè¿æ¥æ± ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConnectionPool</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Format: (&#34;ip:port&#34;, connection)
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Connection<span style="color:#f92672">&gt;</span> CONNECTION_MAP <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Connection<span style="color:#f92672">&gt;();</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨ <code>TokenServerHandler</code> ä¸­ï¼Œå½“æœ‰æ–°çš„è¿æ¥ã€æˆ–è€…æœ‰è¿æ¥æ–­æ‰ã€æˆ–è€…æœ‰æ–°çš„æ¶ˆæ¯å‘é€è¿‡æ¥çš„æ—¶å€™ï¼Œéƒ½ä¼šç›¸åº”çš„ç»´æŠ¤è¿æ¥æ± ä¸­çš„è¿æ¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenServerHandler</span> <span style="color:#66d9ef">extends</span> ChannelInboundHandlerAdapter <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">channelActive</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ·»åŠ åˆ°è¿æ¥æ± é‡Œé¢
</span><span style="color:#75715e"></span>        globalConnectionPool<span style="color:#f92672">.</span><span style="color:#a6e22e">createConnection</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">channelInactive</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ä»è¿æ¥æ± ä¸­ç§»é™¤è¿™ä¸ªè¿æ¥
</span><span style="color:#75715e"></span>        String remoteAddress <span style="color:#f92672">=</span> getRemoteAddress<span style="color:#f92672">(</span>ctx<span style="color:#f92672">);</span>
        globalConnectionPool<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;unchecked&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">channelRead</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">,</span> Object msg<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        globalConnectionPool<span style="color:#f92672">.</span><span style="color:#a6e22e">refreshLastReadTime</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>è¿æ¥æ± ä¸­ç»´æŠ¤çš„è¿æ¥ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¯ä»¥å®šæ—¶åœ°<strong>å…³é—­</strong>ç©ºé—²çš„è¿æ¥ã€‚</p>
<p>å½“ Netty Server æœ‰é™æµè¯·æ±‚è¿‡æ¥åœ°æ—¶å€™ï¼Œå…¶ä¼šæ ¹æ®ç±»å‹æ‰¾åˆ°åˆé€‚çš„ <code>RequestProcessor</code>ï¼Œç„¶åè®©è¿™ä¸ªå¤„ç†å™¨å»å¤„ç†è¯·æ±‚ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">channelRead</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">,</span> Object msg<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg <span style="color:#66d9ef">instanceof</span> ClusterRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ClusterRequest request <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ClusterRequest<span style="color:#f92672">)</span>msg<span style="color:#f92672">;</span>

        <span style="color:#75715e">// Pick request processor for request type.
</span><span style="color:#75715e"></span>        RequestProcessor<span style="color:#f92672">&lt;?,</span> <span style="color:#f92672">?&gt;</span> processor <span style="color:#f92672">=</span> RequestProcessorProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessor</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">());</span>
        ClusterResponse<span style="color:#f92672">&lt;?&gt;</span> response <span style="color:#f92672">=</span> processor<span style="color:#f92672">.</span><span style="color:#a6e22e">processRequest</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
        writeResponse<span style="color:#f92672">(</span>ctx<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="tokenservice">TokenService</h3>
<p>åœ¨ Processor å†…éƒ¨ï¼Œä¼šä½¿ç”¨ <code>TokenService</code> å»åˆ¤æ–­æ˜¯å¦éœ€è¦é™æµã€‚ä½¿ç”¨å“ªä¸€ä¸ª <code>TokenService</code> æ˜¯æ ¹æ® <code>TokenServiceProvider</code> å»å†³å®šçš„ï¼Œå…¶åº•å±‚å°±æ˜¯ SPI æœºåˆ¶ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// TokenServiceProvider.java
</span><span style="color:#75715e"></span>SpiLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">loadFirstInstanceOrDefault</span><span style="color:#f92672">(</span>TokenService<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> DefaultTokenService<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</code></pre></div><p>åœ¨ <code>TokenService</code> å†…éƒ¨ï¼Œå…¶æ ¹æ® <code>flowId</code> æ‰¾åˆ°å¯¹åº”çš„<strong>é™æµè§„åˆ™</strong>ï¼Œç„¶åå†é€šè¿‡ <code>ClusterFlowChecker</code> å»è·å–é›†ç¾¤çš„ Tokenï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// DefaultTokenService.java
</span><span style="color:#75715e"></span><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> TokenResult <span style="color:#a6e22e">requestToken</span><span style="color:#f92672">(</span>Long ruleId<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> acquireCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> prioritized<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// The rule should be valid.
</span><span style="color:#75715e"></span>    FlowRule rule <span style="color:#f92672">=</span> ClusterFlowRuleManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getFlowRuleById</span><span style="color:#f92672">(</span>ruleId<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rule <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> TokenResult<span style="color:#f92672">(</span>TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">NO_RULE_EXISTS</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">return</span> ClusterFlowChecker<span style="color:#f92672">.</span><span style="color:#a6e22e">acquireClusterToken</span><span style="color:#f92672">(</span>rule<span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">,</span> prioritized<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>ClusterFlowRuleManager</code> å†…éƒ¨é€šè¿‡ä½¿ç”¨ä¸€ä¸ª <code>ConcurrentHashMap</code> ç»´æŠ¤äº† <code>&lt;flowId, clusterRule&gt;</code> çš„æ˜ å°„ï¼Œè€Œè¿™ä¸ªæ˜ å°„æ˜¯ç”¨æˆ·é€šè¿‡ <code>loadRules</code> æ–¹æ³•æ‰‹åŠ¨å°†é™æµè§„åˆ™åŠ è½½åˆ°å†…å­˜ä¸­çš„ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// ClusterFlowRuleManager.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loadRules</span><span style="color:#f92672">(</span>String namespace<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>FlowRule<span style="color:#f92672">&gt;</span> rules<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    NamespaceFlowProperty<span style="color:#f92672">&lt;</span>FlowRule<span style="color:#f92672">&gt;</span> property <span style="color:#f92672">=</span> PROPERTY_MAP<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>namespace<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>property <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        property<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">().</span><span style="color:#a6e22e">updateValue</span><span style="color:#f92672">(</span>rules<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å…¶ä¸­ <code>ClusterFlowChecker</code> çš„æ ¸å¿ƒç®—æ³•å¦‚ä¸‹ï¼Œå°±æ˜¯çœ‹å½“å‰å¯ç”¨çš„èµ„æºæ˜¯å¦è¶…è¿‡äº†æœ€å¤§çš„èµ„æºæ•°é‡ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// ClusterFlowChecker.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> TokenResult <span style="color:#a6e22e">acquireClusterToken</span><span style="color:#f92672">(</span><span style="color:#75715e">/*@Valid*/</span> FlowRule rule<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> acquireCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> prioritized<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Long id <span style="color:#f92672">=</span> rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getClusterConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getFlowId</span><span style="color:#f92672">();</span>
    ClusterMetric metric <span style="color:#f92672">=</span> ClusterMetricStatistics<span style="color:#f92672">.</span><span style="color:#a6e22e">getMetric</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>

    <span style="color:#75715e">// å¹³å‡ä¸€ç§’é’Ÿé€šè¿‡å¤šå°‘ä¸ª COUNT
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">double</span> latestQps <span style="color:#f92672">=</span> metric<span style="color:#f92672">.</span><span style="color:#a6e22e">getAvg</span><span style="color:#f92672">(</span>ClusterFlowEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">PASS</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// æ€»å…±å¤šå°‘ä¸ª COUNT
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">double</span> globalThreshold <span style="color:#f92672">=</span> calcGlobalThreshold<span style="color:#f92672">(</span>rule<span style="color:#f92672">)</span> <span style="color:#f92672">*</span> ClusterServerConfigManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getExceedCount</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// å‰©ä½™å¤šå°‘ä¸ª COUNT
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">double</span> nextRemaining <span style="color:#f92672">=</span> globalThreshold <span style="color:#f92672">-</span> latestQps <span style="color:#f92672">-</span> acquireCount<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nextRemaining <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        metric<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>ClusterFlowEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">PASS</span><span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">);</span>
        metric<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>ClusterFlowEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">PASS_REQUEST</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>

        <span style="color:#75715e">// Remaining count is cut down to a smaller integer.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> TokenResult<span style="color:#f92672">(</span>TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">OK</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">setRemaining</span><span style="color:#f92672">((</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> nextRemaining<span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">setWaitInMs</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        metric<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>ClusterFlowEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">BLOCK</span><span style="color:#f92672">,</span> acquireCount<span style="color:#f92672">);</span>
        metric<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>ClusterFlowEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">BLOCK_REQUEST</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>

        <span style="color:#75715e">// blocked
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> TokenResult<span style="color:#f92672">(</span>TokenResultStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">BLOCKED</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">setRemaining</span><span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">setWaitInMs</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div>
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#æ¨¡å—æ„æˆ">æ¨¡å—æ„æˆ</a></li>
    <li><a href="#client-ç«¯">Client ç«¯</a>
      <ul>
        <li><a href="#åˆå§‹åŒ–-bootstrap">åˆå§‹åŒ– Bootstrap</a></li>
        <li><a href="#æ¶ˆæ¯ç±»å‹">æ¶ˆæ¯ç±»å‹</a></li>
        <li><a href="#é™æµçš„æ¶ˆæ¯æ ¼å¼">é™æµçš„æ¶ˆæ¯æ ¼å¼</a></li>
        <li><a href="#è¯·æ±‚é™æµ-token">è¯·æ±‚é™æµ Token</a></li>
      </ul>
    </li>
    <li><a href="#server-ç«¯">Server ç«¯</a>
      <ul>
        <li><a href="#åˆå§‹åŒ–-netty">åˆå§‹åŒ– Netty</a></li>
        <li><a href="#tokenservice">TokenService</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>



</html>












