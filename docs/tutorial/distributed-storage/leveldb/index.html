<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="leveldb æºç åˆ†æä¸å®ç°"><meta property="og:title" content="leveldb æºç åˆ†æä¸å®ç°" />
<meta property="og:description" content="leveldb æºç åˆ†æä¸å®ç°  æºä»£ç åŸºäº 1.22 ä¹‹åçš„ç‰ˆæœ¬
 ç‰¹æ€§ leveldb æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ libraryï¼Œå®ƒçš„é”®æ˜¯æœ‰åºæ’åˆ—çš„ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥æä¾›è‡ªå®šä¹‰çš„é”®æ¯”è¾ƒå™¨ï¼Œå¤šä¸ªæ“ä½œä¹Ÿå¯ä»¥åˆå¹¶ä¸ºä¸€èµ·ï¼Œè¿›è¡ŒåŸå­æ“ä½œæ›´æ–°ã€‚å…¶æ¶æ„å¦‚ä¸‹:
ç¼–è¯‘ mkdir -p build &amp;&amp; cd build cmake -DCMAKE_BUILD_TYPE=Release .. &amp;&amp; cmake --build . å¦‚æœ Ubuntu æç¤º No CMAKE_CXX_COMPILER could be found :
sudo apt-get update &amp;&amp; sudo apt-get install build-essential æ‰“å¼€æ•°æ®åº“ Options // Options to control the behavior of a database (passed to DB::Open) struct LEVELDB_EXPORT Options { // Create an Options object with default values for all fields." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/tutorial/distributed-storage/leveldb/" />

<title>leveldb æºç åˆ†æä¸å®ç° | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.2c8703ef3571e9e1469d79306fda1ed51333153e6ba74aff763a8bc7a9fdaea2.css" integrity="sha256-LIcD7zVx6eFGnXkwb9oe1RMzFT5rp0r/djqLx6n9rqI=">


<script defer src="/en.search.min.1e7619796b61414a9016ae3ce0c51191e796bfabae1a014100792c00d2d6c838.js" integrity="sha256-HnYZeWthQUqQFq484MURkeeWv6uuGgFBAHksANLWyDg="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/front-end-optimization-guide/" >
      å‰ç«¯ä¼˜åŒ–æŒ‡å—
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/algorithm/" >
      ç®—æ³•
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-command/" >
      UNIX å¸¸ç”¨å‘½ä»¤å¤§å…¨
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/unix-optimize/" >
      UNIX æ€§èƒ½ä¼˜åŒ–
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/vue3/" >
      Vue.js æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/git/" >
      Git æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/network/" >
      ç½‘ç»œåè®®
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/awk/" >
      AWK æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/devops/" >
      DevOps
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/sentinel/" >
      é˜¿é‡Œå·´å·´ Sentinel
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/zipkin/" >
      Zipkin æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/eureka/" >
      Netflix Eureka æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed-storage/" >
      åˆ†å¸ƒå¼å­˜å‚¨
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/tutorial/distributed-storage/c_cpp/" >
      C &amp; C&#43;&#43;
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/distributed-storage/leveldb/"  class="active">
      leveldb æºç åˆ†æä¸å®ç°
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/tutorial/distributed-storage/leveldb-read/" >
      leveldb æºç åˆ†æä¸å®ç° - è¯»å–
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/maven/" >
      Maven æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/java/" >
      Java æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/spring/" >
      Spring æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/distributed/" >
      åˆ†å¸ƒå¼ç³»ç»Ÿä¸æ¶æ„è®¾è®¡
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/database/" >
      æ•°æ®åº“
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/redis/" >
      Redis
  </a>


    

    






  </li>


      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>leveldb æºç åˆ†æä¸å®ç°</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ç‰¹æ€§">ç‰¹æ€§</a></li>
    <li><a href="#ç¼–è¯‘">ç¼–è¯‘</a></li>
    <li><a href="#æ‰“å¼€æ•°æ®åº“">æ‰“å¼€æ•°æ®åº“</a>
      <ul>
        <li><a href="#options">Options</a></li>
        <li><a href="#versionedit">VersionEdit</a></li>
      </ul>
    </li>
    <li><a href="#put">Put</a>
      <ul>
        <li><a href="#slice">Slice</a></li>
        <li><a href="#åº•å±‚å­˜å‚¨æ•°æ®çš„åœ°æ–¹">åº•å±‚å­˜å‚¨æ•°æ®çš„åœ°æ–¹</a></li>
        <li><a href="#å†™å…¥é¡ºåº">å†™å…¥é¡ºåº</a></li>
        <li><a href="#å†™-log-æ—¥å¿—æ–‡ä»¶">å†™ Log æ—¥å¿—æ–‡ä»¶</a></li>
        <li><a href="#å†™åˆ°-memtable-å†…å­˜æ•°æ®åº“ä¸­">å†™åˆ° MemTable å†…å­˜æ•°æ®åº“ä¸­</a></li>
      </ul>
    </li>
    <li><a href="#delete">Delete</a></li>
    <li><a href="#snapshot-å¿«ç…§">Snapshot å¿«ç…§</a>
      <ul>
        <li><a href="#åˆ›å»ºå¿«ç…§">åˆ›å»ºå¿«ç…§</a></li>
      </ul>
    </li>
    <li><a href="#æ•°æ®åº“æ–‡ä»¶">æ•°æ®åº“æ–‡ä»¶</a>
      <ul>
        <li><a href="#æ•°æ®åº“æ‰€æœ‰æ–‡ä»¶">æ•°æ®åº“æ‰€æœ‰æ–‡ä»¶</a></li>
        <li><a href="#log-logold">LOG, LOG.old</a></li>
        <li><a href="#log"><code>*.log</code></a></li>
        <li><a href="#lock">LOCK</a></li>
      </ul>
    </li>
    <li><a href="#compaction">Compaction</a></li>
    <li><a href="#ç‰ˆæœ¬ç®¡ç†">ç‰ˆæœ¬ç®¡ç†</a>
      <ul>
        <li><a href="#ç¯å½¢åŒç«¯é“¾è¡¨">ç¯å½¢åŒç«¯é“¾è¡¨</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script><h1 id="leveldb-æºç åˆ†æä¸å®ç°">leveldb æºç åˆ†æä¸å®ç°</h1>
<blockquote>
<p>æºä»£ç åŸºäº <strong>1.22</strong> ä¹‹åçš„ç‰ˆæœ¬</p>
</blockquote>
<h2 id="ç‰¹æ€§">ç‰¹æ€§</h2>
<p>leveldb æ˜¯ä¸€ä¸ª<strong>é”®å€¼å¯¹</strong> libraryï¼Œå®ƒçš„é”®æ˜¯<strong>æœ‰åº</strong>æ’åˆ—çš„ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥æä¾›è‡ªå®šä¹‰çš„é”®æ¯”è¾ƒå™¨ï¼Œå¤šä¸ªæ“ä½œä¹Ÿå¯ä»¥åˆå¹¶ä¸ºä¸€èµ·ï¼Œè¿›è¡Œ<strong>åŸå­æ“ä½œæ›´æ–°</strong>ã€‚å…¶æ¶æ„å¦‚ä¸‹:</p>
<p><img src="/images/docs/tutorial/distributed-storage/leveldb/architecture.png" alt=""></p>
<h2 id="ç¼–è¯‘">ç¼–è¯‘</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p build <span style="color:#f92672">&amp;&amp;</span> cd build
cmake -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release .. <span style="color:#f92672">&amp;&amp;</span> cmake --build .
</code></pre></div><p>å¦‚æœ <code>Ubuntu</code> æç¤º <code>No CMAKE_CXX_COMPILER could be found</code> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt-get update <span style="color:#f92672">&amp;&amp;</span> sudo apt-get install build-essential
</code></pre></div><h2 id="æ‰“å¼€æ•°æ®åº“">æ‰“å¼€æ•°æ®åº“</h2>
<h3 id="options">Options</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">// Options to control the behavior of a database (passed to DB::Open)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">LEVELDB_EXPORT</span> Options {
  <span style="color:#75715e">// Create an Options object with default values for all fields.
</span><span style="color:#75715e"></span>  Options();

  <span style="color:#75715e">// -------------------
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Parameters that affect behavior
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// Comparator ç”¨æ¥å†³å®š key åœ¨ table ä¸­çš„é¡ºåº.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Default: a comparator that uses lexicographic byte-wise ordering
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// REQUIRES: The client must ensure that the comparator supplied
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// here has the same name and orders keys *exactly* the same as the
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// comparator provided to previous open calls on the same DB.
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> Comparator<span style="color:#f92672">*</span> comparator;

  <span style="color:#75715e">// If true, the database will be created if it is missing.
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> create_if_missing <span style="color:#f92672">=</span> false;

  <span style="color:#75715e">// If true, an error is raised if the database already exists.
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> error_if_exists <span style="color:#f92672">=</span> false;

  <span style="color:#75715e">// If true, the implementation will do aggressive checking of the
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// data it is processing and will stop early if it detects any
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// errors.  This may have unforeseen ramifications: for example, a
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// corruption of one DB entry may cause a large number of entries to
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// become unreadable or for the entire DB to become unopenable.
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> paranoid_checks <span style="color:#f92672">=</span> false;

  <span style="color:#75715e">// Use the specified object to interact with the environment,
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// e.g. to read/write files, schedule background work, etc.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Default: Env::Default()
</span><span style="color:#75715e"></span>  Env<span style="color:#f92672">*</span> env;

  <span style="color:#75715e">// Any internal progress/error information generated by the db will
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// be written to info_log if it is non-null, or to a file stored
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// in the same directory as the DB contents if info_log is null.
</span><span style="color:#75715e"></span>  Logger<span style="color:#f92672">*</span> info_log <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;

  <span style="color:#75715e">// -------------------
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Parameters that affect performance
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ•°æ® (backed by an unsorted log
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// on disk) before converting to a sorted on-disk file.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// æ•°å€¼è¾ƒå¤§æœ‰åŠ©äºæå‡æ€§èƒ½ especially during bulk loads.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Up to two write buffers may be held in memory at the same time,
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// so you may wish to adjust this parameter to control memory usage.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// ä¸è¿‡ï¼Œæ•°å€¼è¾ƒå¤§ä¹Ÿå¯èƒ½é€ æˆåœ¨ä¸‹æ¬¡æ‰“å¼€ leveldb æ•°æ®åº“çš„æ—¶å€™åŠ è½½æ—¶é—´è¿‡é•¿
</span><span style="color:#75715e"></span>  size_t write_buffer_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>;

  <span style="color:#75715e">// DB æœ€å¤šå¯ä»¥æ‰“å¼€å¤šå°‘æ–‡ä»¶.  You may need to
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// increase this if your database has a large working set (budget
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// one open file per 2MB of working set).
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> max_open_files <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>;

  <span style="color:#75715e">// Control over blocks (user data is stored in a set of blocks, and
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// a block is the unit of reading from disk).
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// If non-null, use the specified cache for blocks.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// If null, leveldb will automatically create and use an 8MB internal cache.
</span><span style="color:#75715e"></span>  Cache<span style="color:#f92672">*</span> block_cache <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;

  <span style="color:#75715e">// Approximate size of user data packed per block.  Note that the
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// block size specified here corresponds to uncompressed data.  The
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// actual size of the unit read from disk may be smaller if
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// compression is enabled.  This parameter can be changed dynamically.
</span><span style="color:#75715e"></span>  size_t block_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>;

  <span style="color:#75715e">// Number of keys between restart points for delta encoding of keys.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// This parameter can be changed dynamically.  Most clients should
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// leave this parameter alone.
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> block_restart_interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;

  <span style="color:#75715e">// Leveldb will write up to this amount of bytes to a file before
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// switching to a new one.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Most clients should leave this parameter alone.  However if your
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// filesystem is more efficient with larger files, you could
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// consider increasing the value.  The downside will be longer
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// compactions and hence longer latency/performance hiccups.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Another reason to increase this parameter might be when you are
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// initially populating a large database.
</span><span style="color:#75715e"></span>  size_t max_file_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>;

  <span style="color:#75715e">// Compress blocks using the specified compression algorithm.  This
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// parameter can be changed dynamically.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Default: kSnappyCompression, which gives lightweight but fast
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// compression.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Typical speeds of kSnappyCompression on an Intel(R) Core(TM)2 2.4GHz:
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//    ~200-500MB/s compression
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//    ~400-800MB/s decompression
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Note that these speeds are significantly faster than most
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// persistent storage speeds, and therefore it is typically never
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// worth switching to kNoCompression.  Even if the input data is
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// incompressible, the kSnappyCompression implementation will
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// efficiently detect that and will switch to uncompressed mode.
</span><span style="color:#75715e"></span>  CompressionType compression <span style="color:#f92672">=</span> kSnappyCompression;

  <span style="color:#75715e">// EXPERIMENTAL: If true, append to existing MANIFEST and log files
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// when a database is opened.  This can significantly speed up open.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Default: currently false, but may become true later.
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> reuse_logs <span style="color:#f92672">=</span> false;

  <span style="color:#75715e">// If non-null, use the specified filter policy to reduce disk reads.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Many applications will benefit from passing the result of
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// NewBloomFilterPolicy() here.
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> FilterPolicy<span style="color:#f92672">*</span> filter_policy <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
};
</code></pre></div><h3 id="versionedit">VersionEdit</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VersionEdit</span> {

	<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
	 <span style="color:#66d9ef">friend</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VersionSet</span>;

	 <span style="color:#66d9ef">typedef</span> std<span style="color:#f92672">::</span>set<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&gt;&gt;</span> DeletedFileSet;

	 std<span style="color:#f92672">::</span>string comparator_;
	 <span style="color:#66d9ef">uint64_t</span> log_number_;
	 <span style="color:#66d9ef">uint64_t</span> prev_log_number_;
	 <span style="color:#66d9ef">uint64_t</span> next_file_number_;
	 SequenceNumber last_sequence_;
	 <span style="color:#66d9ef">bool</span> has_comparator_;
	 <span style="color:#66d9ef">bool</span> has_log_number_;
	 <span style="color:#66d9ef">bool</span> has_prev_log_number_;
	 <span style="color:#66d9ef">bool</span> has_next_file_number_;
	 <span style="color:#66d9ef">bool</span> has_last_sequence_;

	 std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, InternalKey<span style="color:#f92672">&gt;&gt;</span> compact_pointers_;
	 DeletedFileSet deleted_files_;
	 std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, FileMetaData<span style="color:#f92672">&gt;&gt;</span> new_files_;

}
</code></pre></div><h2 id="put">Put</h2>
<h3 id="slice">Slice</h3>
<p><code>Slice</code> çš„<strong>åº•å±‚</strong>æ•°æ®ç»“æ„ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LEVELDB_EXPORT</span> Slice {
 <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> data_;
  size_t size_;
};
</code></pre></div><h3 id="åº•å±‚å­˜å‚¨æ•°æ®çš„åœ°æ–¹">åº•å±‚å­˜å‚¨æ•°æ®çš„åœ°æ–¹</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// db_impl.h
</span><span style="color:#75715e"></span>MemTable<span style="color:#f92672">*</span> mem_; <span style="color:#75715e">// ç¼“å­˜
</span><span style="color:#75715e"></span>MemTable<span style="color:#f92672">*</span> imm_ <span style="color:#a6e22e">GUARDED_BY</span>(mutex_); <span style="color:#75715e">// æ•°æ®åº“
</span></code></pre></div><h3 id="å†™å…¥é¡ºåº">å†™å…¥é¡ºåº</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// å…ˆå†™åˆ° Log æ–‡ä»¶ä¸­
</span><span style="color:#75715e"></span>status <span style="color:#f92672">=</span> log_<span style="color:#f92672">-&gt;</span>AddRecord(WriteBatchInternal<span style="color:#f92672">::</span>Contents(write_batch));
<span style="color:#66d9ef">bool</span> sync_error <span style="color:#f92672">=</span> false;
<span style="color:#66d9ef">if</span> (status.ok() <span style="color:#f92672">&amp;&amp;</span> options.sync) {
  status <span style="color:#f92672">=</span> logfile_<span style="color:#f92672">-&gt;</span>Sync();
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>status.ok()) {
    sync_error <span style="color:#f92672">=</span> true;
  }
}

<span style="color:#75715e">// å¦‚æœå†™åˆ° Log æ–‡ä»¶æˆåŠŸ
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (status.ok()) {
  <span style="color:#75715e">// åˆ™å†™åˆ°æ•°æ®åº“ä¸­
</span><span style="color:#75715e"></span>  status <span style="color:#f92672">=</span> WriteBatchInternal<span style="color:#f92672">::</span>InsertInto(write_batch, mem_);
}
</code></pre></div><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ•°æ®å…ˆ<strong>é¡ºåºå†™å…¥</strong>åˆ°ä½äºç£ç›˜ä¸Šçš„ log æ–‡ä»¶ä¸­ï¼Œå¦‚æœå†™å…¥æˆåŠŸï¼Œåˆ™å†å†™å…¥åˆ° <code>MemTable</code> ä¸­:</p>
<p><img src="/images/docs/tutorial/distributed-storage/leveldb/write-process.png" alt=""></p>
<h3 id="å†™-log-æ—¥å¿—æ–‡ä»¶">å†™ Log æ—¥å¿—æ–‡ä»¶</h3>
<p>æ—¥å¿—å­˜å‚¨åœ¨ <code>WriteBatch</code> çš„ <code>std::string rep_</code> é‡Œé¢ï¼Œå…¶å­˜å‚¨çš„å†…å®¹å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">void</span> WriteBatch<span style="color:#f92672">::</span>Put(<span style="color:#66d9ef">const</span> Slice<span style="color:#f92672">&amp;</span> key, <span style="color:#66d9ef">const</span> Slice<span style="color:#f92672">&amp;</span> value) {
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  rep_.push_back(<span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(kTypeValue));
  PutLengthPrefixedSlice(<span style="color:#f92672">&amp;</span>rep_, key);
  PutLengthPrefixedSlice(<span style="color:#f92672">&amp;</span>rep_, value);
}

<span style="color:#75715e">// coding.cc
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">PutLengthPrefixedSlice</span>(std<span style="color:#f92672">::</span>string<span style="color:#f92672">*</span> dst, <span style="color:#66d9ef">const</span> Slice<span style="color:#f92672">&amp;</span> value) {
  PutVarint32(dst, value.size());
  dst<span style="color:#f92672">-&gt;</span>append(value.data(), value.size());
}
</code></pre></div><p>å†™å…¥ Log æ—¥å¿—çš„æ—¶å€™ï¼Œå¯¹è®°å½•çš„ç±»å‹å’Œæ•°æ®è®¡ç®— CRC ç¼–ç ï¼Œè¿™ä¸ªç¼–ç ä½œä¸º <code>buf</code> æ•°ç»„çš„å‰ 4 ä½ï¼Œ<code>buf</code> æ•°ç»„çš„å 3 ä½ä¾æ¬¡å¡«å……ä¸Š:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">buf[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(length <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>);
buf[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(length <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>);
buf[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(t);
</code></pre></div><p><code>buf</code> æ•°ç»„çš„å†…å®¹å°±æ˜¯è¿™æ¡è®°å½•çš„<strong>å¤´</strong>çš„å†…å®¹ï¼Œ<code>ptr</code> æŒ‡å‘çš„æ˜¯è¿™æ¡è®°å½•çš„å®é™…æ•°æ®:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// log_writer.cc
</span><span style="color:#75715e">// Write the header and the payload
</span><span style="color:#75715e"></span>Status s <span style="color:#f92672">=</span> dest_<span style="color:#f92672">-&gt;</span>Append(Slice(buf, kHeaderSize));
<span style="color:#66d9ef">if</span> (s.ok()) {
  s <span style="color:#f92672">=</span> dest_<span style="color:#f92672">-&gt;</span>Append(Slice(ptr, length));
  <span style="color:#66d9ef">if</span> (s.ok()) {
    s <span style="color:#f92672">=</span> dest_<span style="color:#f92672">-&gt;</span>Flush();
  }
}
</code></pre></div><p><strong>å¤´</strong>çš„é•¿åº¦ä¸º 7 ä½:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// log_format.h
</span><span style="color:#75715e">// Header is checksum (4 bytes), length (2 bytes), type (1 byte).
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> kHeaderSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</code></pre></div><p><code>Append</code> å†…éƒ¨è°ƒç”¨äº† <code>std:memcpy</code> å‡½æ•°ã€‚</p>
<h3 id="å†™åˆ°-memtable-å†…å­˜æ•°æ®åº“ä¸­">å†™åˆ° MemTable å†…å­˜æ•°æ®åº“ä¸­</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">void</span> MemTable<span style="color:#f92672">::</span>Add(SequenceNumber s, ValueType type, <span style="color:#66d9ef">const</span> Slice<span style="color:#f92672">&amp;</span> key,
                   <span style="color:#66d9ef">const</span> Slice<span style="color:#f92672">&amp;</span> value) {
  <span style="color:#75715e">// ä½¿ç”¨ Arena åˆ†é…å†…å­˜
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> buf <span style="color:#f92672">=</span> arena_.Allocate(encoded_len);
  <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> p <span style="color:#f92672">=</span> EncodeVarint32(buf, internal_key_size);

  <span style="color:#75715e">// å°† key æ‹·è´åˆ° buf ä¸­
</span><span style="color:#75715e"></span>  std<span style="color:#f92672">::</span>memcpy(p, key.data(), key_size);

  <span style="color:#75715e">// å°† value æ‹·è´åˆ° buf ä¸­
</span><span style="color:#75715e"></span>  std<span style="color:#f92672">::</span>memcpy(p, value.data(), val_size);

  <span style="color:#75715e">// æ’å…¥åˆ° table ä¸­
</span><span style="color:#75715e"></span>  table_.Insert(buf);
}
</code></pre></div><p>å¦‚ä¸‹æ˜¯ <code>std::memcpy</code> çš„ç­¾å:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// Copies count bytes from the object pointed to by src to the object pointed to by dest.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">memcpy</span>( <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> dest, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> src, std<span style="color:#f92672">::</span>size_t count );
</code></pre></div><p>ä¸Šè¿°ä»£ç æœ€åä¸€è¡Œå‡ºç°çš„ <code>table_.Insert(buf)</code>ï¼Œæ­¤å¤„çš„ <code>Table</code> å…¶å®å°±æ˜¯<strong>è·³è¡¨</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// memtable.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> SkipList<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>, KeyComparator<span style="color:#f92672">&gt;</span> Table;
</code></pre></div><p>å› æ­¤åœ¨ <code>MemTable</code> ä¸­åˆ†é…çš„ <code>buf</code> æœ€ç»ˆå°†ä¼šå­˜å‚¨åˆ°<strong>è·³è¡¨</strong>ä¸­ã€‚</p>
<h2 id="delete">Delete</h2>
<p><code>Delete</code> çš„åº•å±‚å¾ˆåƒ <code>Put</code> æ“ä½œ:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// write_batch.cc
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Delete</span>(<span style="color:#66d9ef">const</span> Slice<span style="color:#f92672">&amp;</span> key) <span style="color:#66d9ef">override</span> {
  mem_<span style="color:#f92672">-&gt;</span>Add(sequence_, kTypeDeletion, key, Slice());
  sequence_<span style="color:#f92672">++</span>;
}
</code></pre></div><p>åªæ˜¯ <code>key</code> çš„è¢«æ ‡è®°ä¸º <code>kTypeDeletion</code> æ ‡ç­¾äº†ã€‚</p>
<h2 id="snapshot-å¿«ç…§">Snapshot å¿«ç…§</h2>
<h3 id="åˆ›å»ºå¿«ç…§">åˆ›å»ºå¿«ç…§</h3>
<p>ä» <code>VersionSet</code> ä¸­è·å–æœ€åä¸€ä¸ªåºå· <code>LastSequence</code>ï¼Œç„¶åæ ¹æ®è¿™æœ€åä¸€ä¸ªåºå·åˆ›å»ºä¸€ä¸ªå¿«ç…§:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// db_impl.cc
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> Snapshot<span style="color:#f92672">*</span> DBImpl<span style="color:#f92672">::</span>GetSnapshot() {
  MutexLock <span style="color:#a6e22e">l</span>(<span style="color:#f92672">&amp;</span>mutex_);
  <span style="color:#66d9ef">return</span> snapshots_.New(versions_<span style="color:#f92672">-&gt;</span>LastSequence());
}
</code></pre></div><p>å…¶ä¸­ <code>versions_</code> çš„å®šä¹‰:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">VersionSet<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> versions_ <span style="color:#a6e22e">GUARDED_BY</span>(mutex_);
</code></pre></div><h2 id="æ•°æ®åº“æ–‡ä»¶">æ•°æ®åº“æ–‡ä»¶</h2>
<h3 id="æ•°æ®åº“æ‰€æœ‰æ–‡ä»¶">æ•°æ®åº“æ‰€æœ‰æ–‡ä»¶</h3>
<p>æ•°æ®åº“åå­—å‘½åçš„æ–‡ä»¶å¤¹çš„ç›®å½•ï¼ŒåŒ…å«çš„æ–‡ä»¶æœ‰å¦‚ä¸‹å‡ ç§ç±»å‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// filename.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">FileType</span> {
  kLogFile, <span style="color:#75715e">// 000025.log
</span><span style="color:#75715e"></span>  kDBLockFile, <span style="color:#75715e">// LOCK
</span><span style="color:#75715e"></span>  kTableFile, <span style="color:#75715e">// xxxxxx.ldb, *.sst
</span><span style="color:#75715e"></span>  kDescriptorFile, <span style="color:#75715e">// MANIFEST-000023
</span><span style="color:#75715e"></span>  kCurrentFile, <span style="color:#75715e">// CURRENT
</span><span style="color:#75715e"></span>  kTempFile, <span style="color:#75715e">// *.dbtmp
</span><span style="color:#75715e"></span>  kInfoLogFile  <span style="color:#75715e">// LOG, LOG.old 
</span><span style="color:#75715e"></span>};
</code></pre></div><p>ä¸‹é¢å±•ç¤ºçš„æ˜¯ä¸€ä¸ªç¤ºä¾‹ç›®å½•ç»“æ„:</p>
<p><img src="/images/docs/tutorial/distributed-storage/leveldb/leveldb-files.png" alt=""></p>
<h3 id="log-logold">LOG, LOG.old</h3>
<p>æ–‡ä»¶å†…å®¹ç¤ºä¾‹:</p>
<pre><code>2020/10/25-15:37:29.918667 140486263023424 Recovering log #25
2020/10/25-15:37:29.918906 140486263023424 Level-0 table #27: started
2020/10/25-15:37:29.923419 140486263023424 Level-0 table #27: 133 bytes OK
2020/10/25-15:37:29.930591 140486263023424 Delete type=0 #25
2020/10/25-15:37:29.930639 140486263023424 Delete type=3 #23
2020/10/25-15:37:29.930944 140486263019264 Compacting 4@0 + 1@1 files
2020/10/25-15:37:29.931234 140486263019264 compacted to: files[ 4 1 0 0 0 0 0 ]
</code></pre><p>æ–‡ä»¶å†…å®¹æ˜¯é€šè¿‡ <code>Log</code> æ–¹æ³•å†™å…¥è¿›å»çš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">Log(options_.info_log, <span style="color:#e6db74">&#34;compacted to: %s&#34;</span>, versions_<span style="color:#f92672">-&gt;</span>LevelSummary(<span style="color:#f92672">&amp;</span>tmp));
</code></pre></div><h3 id="log"><code>*.log</code></h3>
<p>ä½äº <code>db_impl.h</code> ä¸­çš„ <code>logfile_</code> å’Œ <code>log_</code> æŒ‡å‘çš„æ–‡ä»¶å°±æ˜¯ <code>log</code> æ–‡ä»¶:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// db_impl.h
</span><span style="color:#75715e"></span>WritableFile<span style="color:#f92672">*</span> logfile_;
log<span style="color:#f92672">::</span>Writer<span style="color:#f92672">*</span> log_;
</code></pre></div><p><code>log</code> æ–‡ä»¶ä¸­çš„å†…å®¹æ˜¯æ˜¯é€šè¿‡ <code>AddRecord</code> å†™è¿›å»çš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">status <span style="color:#f92672">=</span> log_<span style="color:#f92672">-&gt;</span>AddRecord(WriteBatchInternal<span style="color:#f92672">::</span>Contents(write_batch));
</code></pre></div><p>å¦‚ä¸‹æ˜¯ç”¨ Vim æ‰“å¼€çš„æŸä¸ª <code>log</code> æ–‡ä»¶æ‰€çœ‹åˆ°çš„å†…å®¹:</p>
<p><img src="/images/docs/tutorial/distributed-storage/leveldb/log_file_content.png" alt=""></p>
<h3 id="lock">LOCK</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// Lock over the persistent DB state.  Non-null iff successfully acquired.
</span><span style="color:#75715e"></span>FileLock<span style="color:#f92672">*</span> db_lock_;
</code></pre></div><h2 id="compaction">Compaction</h2>
<p>å½“å†…å­˜ä¸­çš„ <code>MemTable</code> è¾¾åˆ°ä¸€å®šå¤§å°çš„æ—¶å€™ï¼ŒCompaction å¯ä»¥å°†å…¶å†…å®¹ä¿æŒåˆ°<strong>ç£ç›˜</strong>ä¸­ã€‚</p>
<p><img src="/images/docs/tutorial/distributed-storage/leveldb/minor-compaction.png" alt=""></p>
<h2 id="ç‰ˆæœ¬ç®¡ç†">ç‰ˆæœ¬ç®¡ç†</h2>
<h3 id="ç¯å½¢åŒç«¯é“¾è¡¨">ç¯å½¢åŒç«¯é“¾è¡¨</h3>
<p><code>AppendVersion</code> çš„è¿‡ç¨‹:</p>
<pre><code>[prev] &lt;-&gt; [dummy]
</code></pre><p>è½¬ä¸º:</p>
<pre><code>[prev] &lt;-&gt; [current] &lt;-&gt; [dummy]
</code></pre><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://github.com/google/leveldb/blob/master/doc/impl.md">impl</a></li>
<li><a href="https://www.cnblogs.com/haippy/archive/2011/12/04/2276064.html">æ•°æ®åˆ†æä¸å¤„ç†ä¹‹äºŒï¼ˆLeveldb å®ç°åŸç†ï¼‰</a></li>
</ul>

<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ç‰¹æ€§">ç‰¹æ€§</a></li>
    <li><a href="#ç¼–è¯‘">ç¼–è¯‘</a></li>
    <li><a href="#æ‰“å¼€æ•°æ®åº“">æ‰“å¼€æ•°æ®åº“</a>
      <ul>
        <li><a href="#options">Options</a></li>
        <li><a href="#versionedit">VersionEdit</a></li>
      </ul>
    </li>
    <li><a href="#put">Put</a>
      <ul>
        <li><a href="#slice">Slice</a></li>
        <li><a href="#åº•å±‚å­˜å‚¨æ•°æ®çš„åœ°æ–¹">åº•å±‚å­˜å‚¨æ•°æ®çš„åœ°æ–¹</a></li>
        <li><a href="#å†™å…¥é¡ºåº">å†™å…¥é¡ºåº</a></li>
        <li><a href="#å†™-log-æ—¥å¿—æ–‡ä»¶">å†™ Log æ—¥å¿—æ–‡ä»¶</a></li>
        <li><a href="#å†™åˆ°-memtable-å†…å­˜æ•°æ®åº“ä¸­">å†™åˆ° MemTable å†…å­˜æ•°æ®åº“ä¸­</a></li>
      </ul>
    </li>
    <li><a href="#delete">Delete</a></li>
    <li><a href="#snapshot-å¿«ç…§">Snapshot å¿«ç…§</a>
      <ul>
        <li><a href="#åˆ›å»ºå¿«ç…§">åˆ›å»ºå¿«ç…§</a></li>
      </ul>
    </li>
    <li><a href="#æ•°æ®åº“æ–‡ä»¶">æ•°æ®åº“æ–‡ä»¶</a>
      <ul>
        <li><a href="#æ•°æ®åº“æ‰€æœ‰æ–‡ä»¶">æ•°æ®åº“æ‰€æœ‰æ–‡ä»¶</a></li>
        <li><a href="#log-logold">LOG, LOG.old</a></li>
        <li><a href="#log"><code>*.log</code></a></li>
        <li><a href="#lock">LOCK</a></li>
      </ul>
    </li>
    <li><a href="#compaction">Compaction</a></li>
    <li><a href="#ç‰ˆæœ¬ç®¡ç†">ç‰ˆæœ¬ç®¡ç†</a>
      <ul>
        <li><a href="#ç¯å½¢åŒç«¯é“¾è¡¨">ç¯å½¢åŒç«¯é“¾è¡¨</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1279346965'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279346965%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</body>



</html>












