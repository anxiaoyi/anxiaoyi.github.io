<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹"><meta property="og:title" content="RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹" />
<meta property="og:description" content="RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹ è®²è¿° RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹
ä¸€ã€æ¶ˆæ¯è¿‡æ»¤ç±»å‹ Producer åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™å¯ä»¥æŒ‡å®šæ¶ˆæ¯çš„æ ‡ç­¾ç±»å‹ï¼Œè¿˜å¯ä»¥ä¸ºæ¯ä¸€ä¸ªæ¶ˆæ¯æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ªé¢å¤–çš„å±æ€§:
// æŒ‡å®šæ ‡ç­¾ Message msg = new Message(&#34;TopicTest&#34;, &#34;TagA&#34;, (&#34;Hello RocketMQ&#34;).getBytes(RemotingHelper.DEFAULT_CHARSET)); // æ·»åŠ å±æ€§ a msg.putUserProperty(&#34;a&#34;, 5); æ ¹æ®æ ‡ç­¾å’Œå±æ€§çš„ä¸åŒï¼ŒRocketMQ å®¢æˆ·ç«¯åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™æœ‰ä¸‰ç§æ¶ˆæ¯è¿‡æ»¤ç±»å‹:
(1) æ ‡ç­¾åŒ¹é… consumer.subscribe(&#34;TopicTest&#34;, &#34;TagA | TagB | TagC&#34;); (2) SQL åŒ¹é… consumer.subscribe(&#34;TopicTest&#34;, MessageSelector.bySql( &#34;(TAGS is not null and TAGS in (&#39;TagA&#39;, &#39;TagB&#39;))&#34; &#43; &#34;and (a is not null and a between 0 3)&#34;)); (3) è‡ªå®šä¹‰åŒ¹é… å®¢æˆ·ç«¯å®ç° MessageFilter ç±»ï¼Œè‡ªå®šä¹‰è¿‡æ»¤é€»è¾‘:
ClassLoader classLoader = Thread.currentThread().getContextClassLoader(); File classFile = new File(classLoader." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/rocketmq/rocketmq-message-filter-flow/" />

<title>RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹ | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.215f2c356498a041f9de3ebaab0d56c45dd9a6292b641970f0f751a7bcec3c63.css" integrity="sha256-IV8sNWSYoEH53j66qw1WxF3ZpikrZBlw8PdRp7zsPGM=">


<script defer src="/en.search.min.dcb2f0e8864dc2dc2ee72cc44fa4537c670fe65a2c835fe9e9d03856665ecbea.js" integrity="sha256-3LLw6IZNwtwu5yzET6RTfGcP5losg1/p6dA4VmZey&#43;o="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      ğŸ‘‰æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-send-message-flow/" >
      RocketMQ æ¶ˆæ¯å‘é€æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-store-flow/" >
      RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-receive-flow/" >
      RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-filter-flow/"  class="active">
      RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-indexing-flow/" >
      RocketMQ æ¶ˆæ¯ç´¢å¼•æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-timing-message-and-retry-message/" >
      RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-master-slave-sync/" >
      RocketMQ ä¸»å¤‡åŒæ­¥
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€æ¶ˆæ¯è¿‡æ»¤ç±»å‹">ä¸€ã€æ¶ˆæ¯è¿‡æ»¤ç±»å‹</a>
      <ul>
        <li><a href="#1-æ ‡ç­¾åŒ¹é…">(1) æ ‡ç­¾åŒ¹é…</a></li>
        <li><a href="#2-sql-åŒ¹é…">(2) SQL åŒ¹é…</a></li>
        <li><a href="#3-è‡ªå®šä¹‰åŒ¹é…">(3) è‡ªå®šä¹‰åŒ¹é…</a></li>
      </ul>
    </li>
    <li><a href="#äºŒæ ‡ç­¾åŒ¹é…">äºŒã€æ ‡ç­¾åŒ¹é…</a></li>
    <li><a href="#ä¸‰sql-åŒ¹é…">ä¸‰ã€SQL åŒ¹é…</a>
      <ul>
        <li><a href="#1-æ³¨å†Œè¿‡æ»¤ä¿¡æ¯">(1) æ³¨å†Œè¿‡æ»¤ä¿¡æ¯</a></li>
        <li><a href="#2-ç”Ÿæˆ-bloomfilterdata">(2) ç”Ÿæˆ BloomFilterData</a></li>
        <li><a href="#3-ç¼–è¯‘-sql-è¯­å¥">(3) ç¼–è¯‘ SQL è¯­å¥</a></li>
        <li><a href="#4-è®¡ç®—ä½æ˜ å°„">(4) è®¡ç®—ä½æ˜ å°„</a></li>
        <li><a href="#5-å­˜å‚¨ä½æ˜ å°„">(5) å­˜å‚¨ä½æ˜ å°„</a></li>
        <li><a href="#6-æ¶ˆæ¯è¿‡æ»¤">(6) æ¶ˆæ¯è¿‡æ»¤</a></li>
      </ul>
    </li>
    <li><a href="#å››è‡ªå®šä¹‰åŒ¹é…">å››ã€è‡ªå®šä¹‰åŒ¹é…</a>
      <ul>
        <li><a href="#1-è¿‡æ»¤æœåŠ¡å™¨">(1) è¿‡æ»¤æœåŠ¡å™¨</a></li>
        <li><a href="#2-è¿‡æ»¤ç±»">(2) è¿‡æ»¤ç±»</a></li>
        <li><a href="#3-è¿‡æ»¤æ¶ˆæ¯">(3) è¿‡æ»¤æ¶ˆæ¯</a></li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown"><h1 id="rocketmq-æ¶ˆæ¯è¿‡æ»¤æµç¨‹">RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹</h1>
<p>è®²è¿° RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹</p>
<h2 id="ä¸€æ¶ˆæ¯è¿‡æ»¤ç±»å‹">ä¸€ã€æ¶ˆæ¯è¿‡æ»¤ç±»å‹</h2>
<p>Producer åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™å¯ä»¥æŒ‡å®šæ¶ˆæ¯çš„æ ‡ç­¾ç±»å‹ï¼Œè¿˜å¯ä»¥ä¸ºæ¯ä¸€ä¸ªæ¶ˆæ¯æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ªé¢å¤–çš„å±æ€§:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// æŒ‡å®šæ ‡ç­¾
</span><span style="color:#75715e"></span>Message msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Message<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;TopicTest&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;TagA&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello RocketMQ&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span>RemotingHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_CHARSET</span><span style="color:#f92672">));</span>
<span style="color:#75715e">// æ·»åŠ å±æ€§ a
</span><span style="color:#75715e"></span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">putUserProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">,</span> 5<span style="color:#f92672">);</span>
</code></pre></div><p>æ ¹æ®æ ‡ç­¾å’Œå±æ€§çš„ä¸åŒï¼ŒRocketMQ å®¢æˆ·ç«¯åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™æœ‰ä¸‰ç§æ¶ˆæ¯è¿‡æ»¤ç±»å‹:</p>
<h3 id="1-æ ‡ç­¾åŒ¹é…">(1) æ ‡ç­¾åŒ¹é…</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">consumer<span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;TopicTest&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;TagA | TagB | TagC&#34;</span><span style="color:#f92672">);</span>
</code></pre></div><h3 id="2-sql-åŒ¹é…">(2) SQL åŒ¹é…</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">consumer<span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;TopicTest&#34;</span><span style="color:#f92672">,</span>
                MessageSelector<span style="color:#f92672">.</span><span style="color:#a6e22e">bySql</span><span style="color:#f92672">(</span>
                    <span style="color:#e6db74">&#34;(TAGS is not null and TAGS in (&#39;TagA&#39;, &#39;TagB&#39;))&#34;</span> <span style="color:#f92672">+</span> 
                <span style="color:#e6db74">&#34;and (a is not null and a between 0  3)&#34;</span><span style="color:#f92672">));</span>
</code></pre></div><h3 id="3-è‡ªå®šä¹‰åŒ¹é…">(3) è‡ªå®šä¹‰åŒ¹é…</h3>
<p>å®¢æˆ·ç«¯å®ç° <code>MessageFilter</code> ç±»ï¼Œè‡ªå®šä¹‰è¿‡æ»¤é€»è¾‘:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ClassLoader classLoader <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getContextClassLoader</span><span style="color:#f92672">();</span>
File classFile <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>classLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;MessageFilterImpl.java&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getFile</span><span style="color:#f92672">());</span>

String filterCode <span style="color:#f92672">=</span> MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">file2String</span><span style="color:#f92672">(</span>classFile<span style="color:#f92672">);</span>
consumer<span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;TopicTest&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;org.apache.rocketmq.example.filter.MessageFilterImpl&#34;</span><span style="color:#f92672">,</span>filterCode<span style="color:#f92672">);</span>
</code></pre></div><p>å¯¹äº <code>MessageFilter</code> ç±»å®ç° <code>match</code> æ–¹æ³•å³å¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageFilterImpl</span> <span style="color:#66d9ef">implements</span> MessageFilter <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">match</span><span style="color:#f92672">(</span>MessageExt msg<span style="color:#f92672">,</span> FilterContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        String property <span style="color:#f92672">=</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SequenceId&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>property <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">int</span> id <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">parseInt</span><span style="color:#f92672">(</span>property<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(((</span>id <span style="color:#f92672">%</span> 10<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
                <span style="color:#f92672">(</span>id <span style="color:#f92672">&gt;</span> 100<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸‹é¢æˆ‘ä»¬ä¸€ä¸€è®²è§£å„è‡ªèƒŒåçš„æœºåˆ¶ä¸å®ç°åŸç†ã€‚</p>
<h2 id="äºŒæ ‡ç­¾åŒ¹é…">äºŒã€æ ‡ç­¾åŒ¹é…</h2>
<p>å½“ä¸ºæ¶ˆæ¯æŒ‡å®šæ¶ˆæ¯æ ‡ç­¾ç±»å‹çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ‰€æŒ‡å®šçš„æ ‡ç­¾ä¾‹å¦‚ <code>TagA</code> æ˜¯ä½œä¸ºä¸€ä¸ªå±æ€§æ”¾å…¥åˆ°äº†è¿™æ¡æ¶ˆæ¯ä¸­çš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Message</span> <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setTags</span><span style="color:#f92672">(</span>String tags<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putProperty</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_TAGS</span><span style="color:#f92672">,</span> tags<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“è¿™æ¡æ¶ˆæ¯åˆ°è¾¾ Broker æœåŠ¡å™¨ç«¯åï¼Œç”¨æˆ·è®¾ç½®çš„æ ‡ç­¾ä¼šè®¡ç®—ä¸ºæ ‡ç­¾ç ï¼Œé»˜è®¤çš„è®¡ç®—æ–¹å¼é‡‡ç”¨çš„æ ‡ç­¾å­—ç¬¦ä¸²çš„ <code>hashCode()</code> ä½œä¸ºè®¡ç®—ç»“æœçš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLog</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> DispatchRequest <span style="color:#a6e22e">checkMessageAndReturnSize</span><span style="color:#f92672">(</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">nio</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ByteBuffer</span> byteBuffer<span style="color:#f92672">,</span>
                                                     <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> checkCRC<span style="color:#f92672">,</span>
                                                     <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> readBody<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        String tags <span style="color:#f92672">=</span> propertiesMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_TAGS</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tags <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> tags<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            tagsCode <span style="color:#f92672">=</span> MessageExtBrokerInner
                <span style="color:#f92672">.</span><span style="color:#a6e22e">tagsString2tagsCode</span><span style="color:#f92672">(</span>MessageExt<span style="color:#f92672">.</span><span style="color:#a6e22e">parseTopicFilterType</span><span style="color:#f92672">(</span>sysFlag<span style="color:#f92672">),</span> tags<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“è®¡ç®—å‡ºæ¥æ ‡ç­¾ç ä¹‹åï¼Œè¿™æ¡æ¶ˆæ¯çš„æ ‡ç­¾ç ä¼šè¢«å­˜æ”¾è‡³<strong>æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶</strong>ä¸­ï¼Œç”¨æ¥ä¸æ¶ˆè´¹è€…å®¢æˆ·ç«¯æ¶ˆè´¹é˜Ÿåˆ—çš„æ ‡ç­¾ç è¿›è¡ŒåŒ¹é…ã€‚æ¶ˆè´¹è€…å®¢æˆ·ç«¯è®¢é˜…æ¶ˆè´¹è¯é¢˜çš„æ—¶å€™ï¼Œä¼šæŒ‡å®šæƒ³è¦åŒ¹é…çš„æ ‡ç­¾ç±»å‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">consumer<span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;TopicTest&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;TagA | TagB | TagC&#34;</span><span style="color:#f92672">);</span>
</code></pre></div><p>è¿™æ®µä»£ç åœ¨å†…éƒ¨å®ç°ä¸­åˆ©ç”¨ <code>FilterAPI</code> æ„å»ºäº†ä¸€ä¸ª <code>SubscriptionData</code> å¯¹è±¡:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMQPushConsumerImpl</span> <span style="color:#66d9ef">implements</span> MQConsumerInner <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span>String topic<span style="color:#f92672">,</span> String subExpression<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> MQClientException <span style="color:#f92672">{</span>
        SubscriptionData subscriptionData <span style="color:#f92672">=</span> FilterAPI
            <span style="color:#f92672">.</span><span style="color:#a6e22e">buildSubscriptionData</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">(),</span>
                                   topic<span style="color:#f92672">,</span>
                                   subExpression<span style="color:#f92672">);</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“ç”¨æˆ·æœªæŒ‡å®šæ ‡ç­¾æˆ–è€…æŒ‡å®šä¸ºæ˜Ÿå·æ ‡ç­¾çš„æ—¶å€™ï¼Œåˆ™ä»£è¡¨ç”¨æˆ·æ¥å—æ‰€æœ‰æ ‡ç­¾çš„æ¶ˆæ¯ã€‚å¦‚æœç”¨æˆ·æŒ‡å®šäº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ ‡ç­¾ï¼Œé‚£ä¹ˆä¼šå°†æ¯ä¸€ä¸ªæ ‡ç­¾å–å…¶ <code>hashCode()</code> æ”¾å…¥åˆ° <code>codeSet</code> <code>ä¸­ã€‚SubscriptionData</code> è¿˜æœ‰ä¸€ä¸ª <code>expressionType</code> å­—æ®µï¼Œåœ¨ä½¿ç”¨æ ‡ç­¾åŒ¹é…çš„æ—¶å€™ï¼Œå…¶ä¸ä¼šè®¾ç½®è¿™ä¸ªè¿™ä¸ªå­—æ®µçš„å€¼ï¼Œå› æ­¤å…¶ä¿ç•™ä¸º <code>null</code>ã€‚åœ¨è¿™äº›ä¿¡æ¯è®¾ç½®å¥½ä»¥åï¼Œå½“å®¢æˆ·ç«¯å‘é€å¿ƒè·³åŒ…çš„æ—¶å€™ï¼Œä¼šå°†è¿™äº›è¯é¢˜çš„æ³¨å†Œä¿¡æ¯ä¸€å¹¶ä¸Šä¼ è‡³ Broker æœåŠ¡å™¨ç«¯ï¼Œæ–¹ä¾¿åœ¨ Broker ç«¯è¿›è¡ŒåŒ¹é…ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SubscriptionData</span> <span style="color:#66d9ef">implements</span> Comparable<span style="color:#f92672">&lt;</span>SubscriptionData<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">static</span> String SUB_ALL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> tagsSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;();</span>
    <span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> codeSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;();</span>

    <span style="color:#66d9ef">private</span> String expressionType<span style="color:#f92672">;</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“ Broker ç«¯æœåŠ¡å™¨åœ¨å–æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ¯å–å‡ºæ¥ä¸€æ¡æ¶ˆæ¯ï¼Œéƒ½ä¼šæ‰§è¡Œä¸¤é“è¿‡æ»¤æœºåˆ¶:</p>
<ul>
<li><code>ConsumeQueue</code> æ–‡ä»¶åŒ¹é…</li>
<li><code>CommitLog</code> æ–‡ä»¶åŒ¹é…</li>
</ul>
<p>ä»»ä¸€æ£€æŸ¥æ²¡æœ‰é€šè¿‡åï¼Œç»ä¸ä¼šæ”¾è¡Œè¿™æ¡æ¶ˆæ¯ç»™å®¢æˆ·ç«¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMessageStore</span> <span style="color:#66d9ef">implements</span> MessageStore <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> GetMessageResult <span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String group<span style="color:#f92672">,</span> <span style="color:#75715e">/** å…¶ä»–å‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;</span> i <span style="color:#f92672">&lt;</span> bufferConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> i <span style="color:#f92672">&lt;</span> maxFilterMessageCount<span style="color:#f92672">;</span> i <span style="color:#f92672">+=</span> ConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">CQ_STORE_UNIT_SIZE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

            <span style="color:#75715e">// ConsumeQueue æ–‡ä»¶åŒ¹é…
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>messageFilter <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>messageFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">isMatchedByConsumeQueue</span><span style="color:#f92672">(</span>isTagsCodeLegal <span style="color:#f92672">?</span> tagsCode <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> extRet <span style="color:#f92672">?</span> cqExtUnit <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getBufferTotalSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    status <span style="color:#f92672">=</span> GetMessageStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">NO_MATCHED_MESSAGE</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// CommitLog æ–‡ä»¶åŒ¹é…
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>messageFilter <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>messageFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">isMatchedByCommitLog</span><span style="color:#f92672">(</span>selectResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getByteBuffer</span><span style="color:#f92672">().</span><span style="color:#a6e22e">slice</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getBufferTotalSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    status <span style="color:#f92672">=</span> GetMessageStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">NO_MATCHED_MESSAGE</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">// release...
</span><span style="color:#75715e"></span>                selectResult<span style="color:#f92672">.</span><span style="color:#a6e22e">release</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

        <span style="color:#f92672">}</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æ¶ˆæ¯è¿‡æ»¤å™¨çš„é»˜è®¤å®ç°æ˜¯ <code>ExpressionMessageFilter</code> ï¼Œæ¶ˆæ¯è¿‡æ»¤çš„é»˜è®¤å®ç°ç­–ç•¥å°±æ˜¯çœ‹è¿™ä¸ªè¯é¢˜çš„æ ‡ç­¾ç é›†åˆä¸­æ˜¯å¦åŒ…æ‹¬å½“å‰è¿™æ¡æ¶ˆæ¯çš„æ ‡ç­¾ç :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExpressionMessageFilter</span> <span style="color:#66d9ef">implements</span> MessageFilter <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isMatchedByConsumeQueue</span><span style="color:#f92672">(</span>Long tagsCode<span style="color:#f92672">,</span> ConsumeQueueExt<span style="color:#f92672">.</span><span style="color:#a6e22e">CqExtUnit</span> cqExtUnit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ExpressionType<span style="color:#f92672">.</span><span style="color:#a6e22e">isTagType</span><span style="color:#f92672">(</span>subscriptionData<span style="color:#f92672">.</span><span style="color:#a6e22e">getExpressionType</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tagsCode <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>subscriptionData<span style="color:#f92672">.</span><span style="color:#a6e22e">getSubString</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>SubscriptionData<span style="color:#f92672">.</span><span style="color:#a6e22e">SUB_ALL</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">return</span> subscriptionData<span style="color:#f92672">.</span><span style="color:#a6e22e">getCodeSet</span><span style="color:#f92672">().</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>tagsCode<span style="color:#f92672">.</span><span style="color:#a6e22e">intValue</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isMatchedByCommitLog</span><span style="color:#f92672">(</span>ByteBuffer msgBuffer<span style="color:#f92672">,</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> properties<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ExpressionType<span style="color:#f92672">.</span><span style="color:#a6e22e">isTagType</span><span style="color:#f92672">(</span>subscriptionData<span style="color:#f92672">.</span><span style="color:#a6e22e">getExpressionType</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸‹å›¾æ˜¯ä¸€å¹…æ ‡ç­¾åŒ¹é…çš„ç®€è¦æµç¨‹å›¾:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/tag_match.png" alt="æ ‡ç­¾åŒ¹é…æµç¨‹å›¾"></p>
<h2 id="ä¸‰sql-åŒ¹é…">ä¸‰ã€SQL åŒ¹é…</h2>
<p>åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¯ä»¥ä¸ºæ¯ä¸€æ¡æ¶ˆæ¯é™„å¸¦ä¸€ä¸ªæˆ–è€…å¤šä¸ªå±æ€§å€¼ï¼ŒSQL åŒ¹é…æŒ‡çš„å°±æ˜¯ä¾æ®è¿™äº›<strong>å±æ€§å€¼</strong>å’Œ <strong>TAG æ ‡ç­¾</strong> æ˜¯å¦æ»¡è¶³ä¸€å®šçš„ SQL è¯­å¥æ¡ä»¶ï¼Œæ¥è¿‡æ»¤æ¶ˆæ¯ã€‚ç”¨æˆ·å¦‚æœæƒ³è¦å¼€å¯ SQL åŒ¹é…ï¼Œé‚£ä¹ˆéœ€è¦åœ¨ Broker å¯åŠ¨çš„æ—¶å€™ï¼Œå¯ç”¨å¦‚ä¸‹å‡ ä¸ªé…ç½®ä¿¡æ¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">brokerConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">setEnablePropertyFilter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
brokerConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">setEnableCalcFilterBitMap</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>

messageStoreConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">setEnableConsumeQueueExt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</code></pre></div><h3 id="1-æ³¨å†Œè¿‡æ»¤ä¿¡æ¯">(1) æ³¨å†Œè¿‡æ»¤ä¿¡æ¯</h3>
<p>æˆ‘ä»¬åœ¨æ¶ˆè´¹è€…å¦‚ä½•æ¥å—æ¶ˆæ¯ä¸€æ–‡ä¸­æåˆ°è¿‡ï¼Œæ¶ˆè´¹è€…å¯åŠ¨ä¹‹åï¼Œä¼šé€šè¿‡å¿ƒè·³åŒ…å®šæ—¶ç»™ Broker æœåŠ¡å™¨æ±‡æŠ¥è‡ªå·±çš„ä¿¡æ¯ã€‚è€Œ Broker æœåŠ¡å™¨åœ¨æ”¶åˆ°æ¶ˆè´¹è€…çš„å¿ƒè·³åŒ…ä¹‹åï¼Œä¼šäº§ç”Ÿä¸€ä¸ªæ³¨å†Œäº‹ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerManager</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">registerConsumer</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String group<span style="color:#f92672">,</span>
                                    <span style="color:#75715e">/** å…¶ä»–å‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerIdsChangeListener</span><span style="color:#f92672">.</span><span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>ConsumerGroupEvent<span style="color:#f92672">.</span><span style="color:#a6e22e">REGISTER</span><span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> subList<span style="color:#f92672">);</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><code>DefaultConsumerIdsChangeListener</code> æ˜¯é»˜è®¤çš„æ¶ˆè´¹è€…åˆ—è¡¨æ³¨å†Œäº‹ä»¶é€šçŸ¥å™¨çš„å®ç°ç±»ï¼Œå…¶åœ¨æ”¶åˆ°æ³¨å†Œäº‹ä»¶ä»¥åï¼Œä¼šå°†ç”¨æˆ·åœ¨æ¶ˆè´¹è€…ç«¯è®¢é˜…çš„è¯é¢˜ä¿¡æ¯æ³¨å†Œåˆ° <code>ConsumerFilterManager</code> ä¸­:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultConsumerIdsChangeListener</span> <span style="color:#66d9ef">implements</span> ConsumerIdsChangeListener <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle</span><span style="color:#f92672">(</span>ConsumerGroupEvent event<span style="color:#f92672">,</span> String group<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>event<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            
        <span style="color:#66d9ef">case</span> REGISTER<span style="color:#f92672">:</span>
            Collection<span style="color:#f92672">&lt;</span>SubscriptionData<span style="color:#f92672">&gt;</span> subscriptionDataList <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Collection<span style="color:#f92672">&lt;</span>SubscriptionData<span style="color:#f92672">&gt;)</span> args<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerFilterManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>group<span style="color:#f92672">,</span> subscriptionDataList<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/consumer_filter_manager.png" alt="æ¶ˆè´¹è€…è¿‡æ»¤å™¨æ•°æ®ç»“æ„"></p>
<p><code>ConsumerFilterData</code> ä¸­åŒ…å«äº†æ¶ˆè´¹è€…å®¢æˆ·ç«¯æ³¨å†Œçš„ SQL è¡¨è¾¾å¼ï¼Œç”±ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºæ¯ä¸€ä¸ªè¯é¢˜æ‰€å¯¹åº”çš„ <code>FilterDataMapByTopic</code> ï¼Œå¯ä»¥æ³¨å†Œå¤šä¸ª SQL è¡¨è¾¾å¼ã€‚ä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™å¤šä¸ª SQL è¡¨è¾¾å¼æ˜¯æŒ‰ç…§ç»„æ¥åšåŒºåˆ†çš„ï¼Œå°±æ˜¯è¯´ä¸€ä¸ªç»„åªèƒ½æœ‰ä¸€ä¸ª SQL è¡¨è¾¾å¼ï¼Œå®¢æˆ·ç«¯å¦‚æœåœ¨ä¸€ä¸ªç»„ä¸­æ³¨å†Œäº†å¤šä¸ªä¸åŒçš„ SQL è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆåæ³¨å†Œçš„ä¼šè¦†ç›–æ‰å‰æ³¨å†Œçš„ã€‚å› æ­¤ï¼Œå¦‚æœæƒ³è¦å¯¹åŒä¸€ä¸ªç»„ä½¿ç”¨ä¸åŒçš„ SQL è¯­å¥æ¥è¿‡æ»¤è‡ªå·±æƒ³è¦çš„ä¿¡æ¯ï¼Œè¿™äº›ä¸åŒçš„ SQL è¯­å¥å¿…é¡»åˆ’åˆ†åˆ°ä¸åŒçš„ç»„é‡Œé¢æ‰å¯è¡Œã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/sql_in_consumer_group.png" alt="ç»„ä¸ SQL è¡¨è¾¾å¼çš„å¯¹åº”å…³ç³»"></p>
<h3 id="2-ç”Ÿæˆ-bloomfilterdata">(2) ç”Ÿæˆ BloomFilterData</h3>
<p>å¸ƒéš†è¿‡æ»¤å™¨ (BloomFilter) æ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡å¾ˆé«˜çš„æ•°æ®ç»“æ„ï¼Œå…¶å¯ä»¥ç”¨æ¥åˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦<strong>å¯èƒ½å­˜åœ¨äºæŸä¸ªé›†åˆ</strong>ä¸­ã€‚å½“åˆ¤æ–­ç»“æœè¿”å› true çš„æ—¶å€™ï¼Œè¡¨ç¤º<strong>å¯èƒ½å­˜åœ¨</strong>ï¼Œå½“è¿”å› false çš„æ—¶å€™ï¼Œè¡¨ç¤ºè¿™ä¸ªå…ƒç´ <strong>ä¸€å®šä¸å­˜åœ¨</strong>äºè¿™ä¸ªé›†åˆä¸­ã€‚</p>
<p>å®ƒçš„åŸç†æ˜¯å½“ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥é›†åˆæ—¶ï¼Œé€šè¿‡ <code>k</code> ä¸ª Hash å‡½æ•°å°†è¿™ä¸ªå…ƒç´ æ˜ å°„æˆä¸€ä¸ªé•¿åº¦ä¸º <code>m</code> ä½æ•°ç»„ï¼ˆBit arrayï¼‰ä¸­çš„ <code>k</code> ä¸ªç‚¹ï¼ŒæŠŠå®ƒä»¬ç½®ä¸º 1ã€‚æ£€ç´¢æ—¶ï¼Œæˆ‘ä»¬åªè¦çœ‹çœ‹è¿™äº›ç‚¹æ˜¯ä¸æ˜¯éƒ½æ˜¯ 1 å°±ï¼ˆå¤§çº¦ï¼‰çŸ¥é“é›†åˆä¸­æœ‰æ²¡æœ‰å®ƒäº†ï¼š</p>
<ul>
<li>å¦‚æœè¿™äº›ç‚¹æœ‰ä»»ä½•ä¸€ä¸ª 0ï¼Œåˆ™è¢«æ£€ç´¢å…ƒç´ ä¸€å®šä¸åœ¨ã€‚</li>
<li>å¦‚æœéƒ½æ˜¯ 1ï¼Œ åˆ™è¢«æ£€ç´¢å…ƒç´ å¾ˆå¯èƒ½åœ¨ã€‚</li>
</ul>
<p>å¦‚ä¸‹æ˜¯ä¸€ä¸ªé‡‡ç”¨ä½æ•°ç»„é•¿åº¦ä¸º <code>m=18</code> ä»¥åŠå“ˆå¸Œå‡½æ•°ä¸ªæ•°ä¸º <code>k=3</code> å®ç°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œâ€x,y,zâ€ æ¯ä¸€ä¸ªå­—æ¯éƒ½éœ€è¦ç»è¿‡ 3 æ¬¡å“ˆå¸Œå‡½æ•°çš„è®¡ç®—ï¼Œç„¶åæ˜ å°„åˆ° 3 ä¸ªä¸åŒçš„æ§½ä¸­ã€‚ç”±äºå­—æ¯ â€œwâ€ åœ¨ç»è¿‡ 3 æ¬¡å“ˆå¸Œå‡½æ•°è®¡ç®—åï¼Œå…¶ä¸­ä¸€æ¬¡äº§ç”Ÿçš„å“ˆå¸Œå€¼å¹¶æœªå‘½ä¸­å·²æœ‰çš„æ§½ï¼Œå› æ­¤å¯ä»¥ç¡®å®šçš„æ˜¯ â€œwâ€ è‚¯å®šä¸å­˜åœ¨äºè¿™ä¸ªé›†åˆä¸­ã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/1298px-Bloom_filter.svg.png" alt="å¸ƒéš†è¿‡æ»¤å™¨"></p>
<p>åœ¨ RocketMQ çš„å®ç°ä¸­ï¼Œå…¶æœ‰å››ä¸ªæœ€å…³é”®çš„å€¼:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BloomFilter</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">// æœ€å¤§é”™è¯¯ç‡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> f<span style="color:#f92672">;</span>
    <span style="color:#75715e">// å¯èƒ½æ’å…¥ n ä¸ªå…ƒç´ 
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> n<span style="color:#f92672">;</span>
    <span style="color:#75715e">// k ä¸ªå“ˆå¸Œå‡½æ•°
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> k<span style="color:#f92672">;</span>
    <span style="color:#75715e">// æ•°ç»„æ€»å…± m ä½
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> m<span style="color:#f92672">;</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>RocketMQ å®ç°çš„å¸ƒéš†è¿‡æ»¤å™¨æ˜¯æ ¹æ®é”™è¯¯ç‡ <code>f</code> å’Œå¯èƒ½æ’å…¥çš„å…ƒç´ æ•°é‡ <code>n</code> è®¡ç®—å‡ºæ¥çš„ <code>k</code> å’Œ <code>m</code>ï¼Œåœ¨é»˜è®¤é…ç½®æƒ…å†µä¸‹ï¼Œå³å¦‚ä¸‹ n = 32 å’Œ f = 20ï¼Œè®¡ç®—å‡ºæ¥éœ€è¦ k = 3 ä¸ªå“ˆå¸Œå‡½æ•°å’Œ m = 112 ä½çš„æ•°ç»„ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BrokerConfig</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">// Expect num of consumers will use filter.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> expectConsumerNumUseFilter <span style="color:#f92672">=</span> 32<span style="color:#f92672">;</span>
    <span style="color:#75715e">// Error rate of bloom filter, 1~100.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> maxErrorRateOfBloomFilter <span style="color:#f92672">=</span> 20<span style="color:#f92672">;</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æˆ‘ä»¬è¿™é‡Œå¤§è‡´äº†è§£ä»¥ä¸‹å¸ƒéš†è¿‡æ»¤å™¨çš„ä¸€ä¸ªåŸºæœ¬æƒ³æ³•å³å¯ï¼Œå…·ä½“ç®—æ³•æ¯”è¾ƒå¤æ‚ï¼Œä¹Ÿä¸åœ¨è®¨è®ºèŒƒç•´ä»¥å†…ã€‚å½“å®¢æˆ·ç«¯æ³¨å†Œè¿‡æ»¤ä¿¡æ¯çš„æ—¶å€™ï¼Œå…¶ä¼šæ ¹æ® â€œ<strong>ç»„#è¯é¢˜</strong>â€ è¿™ä¸ªå­—ç¬¦ä¸²è®¡ç®—å‡ºç›¸åº”çš„<strong>ä½æ˜ å°„æ•°æ®</strong>ï¼Œä¹Ÿå³è¿™ä¸ªå­—ç¬¦ä¸²ç»è¿‡å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„è‹¥å¹²ä¸ªå“ˆå¸Œå‡½æ•°å¾—åˆ°çš„<strong>å‡ ä¸ªä¸åŒçš„å“ˆå¸Œå€¼</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerFilterManager</span> <span style="color:#66d9ef">extends</span> ConfigManager <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">register</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String topic<span style="color:#f92672">,</span> <span style="color:#75715e">/** å…¶å®ƒå‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        BloomFilterData bloomFilterData <span style="color:#f92672">=</span>
            bloomFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">generate</span><span style="color:#f92672">(</span>consumerGroup <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#f92672">+</span> topic<span style="color:#f92672">);</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ConsumerFilterManager ä¸­çš„è¯é¢˜è¿‡æ»¤ä¿¡æ¯æ•°æ®ï¼Œ<strong>æ¯éš” 10 ç§’</strong>è¿›è¡Œä¸€æ¬¡ç£ç›˜æŒä¹…åŒ–:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BrokerController</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">initialize</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> CloneNotSupportedException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduledExecutorService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    BrokerController<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerFilterManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">persist</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">},</span> 1000 <span style="color:#f92672">*</span> 10<span style="color:#f92672">,</span> 1000 <span style="color:#f92672">*</span> 10<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>   
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ç£ç›˜æ–‡ä»¶ <code>consumerFilter.json</code> ä¸­ä¿å­˜çš„æ•°æ®ä¿¡æ¯å¦‚ä¸‹ç¤ºä¾‹:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/2018_03_28_16_47_45.png" alt="è¿‡æ»¤å™¨æ–‡ä»¶æ•°æ®ç»“æ„æ ¼å¼"></p>
<p>ä¸Šè¿°å¤§è‡´æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/heartbeat_consumer_filter_flow.png" alt="å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ»¤æµç¨‹"></p>
<h3 id="3-ç¼–è¯‘-sql-è¯­å¥">(3) ç¼–è¯‘ SQL è¯­å¥</h3>
<p><a href="https://javacc.org/">JavaCC (Java Compiler Compiler)</a> æ˜¯ä¸€ä¸ªèƒ½ç”Ÿæˆè¯­æ³•å’Œè¯æ³•åˆ†æå™¨çš„ç”Ÿæˆç¨‹åºï¼Œå®ƒé€šè¿‡é˜…è¯»ä¸€ä¸ªè‡ªå®šä¹‰çš„è¯­æ³•æ ‡å‡†æ–‡ä»¶ (é€šå¸¸ä»¥ <code>jj</code> ä¸ºåç¼€å) ï¼Œç„¶åå°±èƒ½ç”Ÿæˆèƒ½å¤Ÿè§£æè¯¥è¯­æ³•çš„æ‰«æå™¨å’Œè§£æå™¨çš„ä»£ç ã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/new-javacc-logo.png" alt="JavaCC"></p>
<p>é€šè¿‡æ‰§è¡Œ <code>javacc SelectorParser.jj</code> å‘½ä»¤ä»¥åï¼Œå…¶ä¼šç”Ÿæˆå¦‚ä¸‹ä¸ƒä¸ª Java æ–‡ä»¶ï¼Œç”¨ä»¥è§£æ SQL è¯­æ³•:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/2018_03_28_17_39_01.png" alt="JavaCC ç”Ÿæˆçš„æ–‡ä»¶"></p>
<p>è¿‡æ»¤å™¨å·¥å‚ <code>FilterFactory</code> åœ¨åˆæ¬¡ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šæ³¨å†Œä¸€ä¸ª <code>SqlFilter</code> ç±»ï¼Œè¿™ä¸ªç±»èƒ½å¤Ÿå°†æ¶ˆè´¹è€…ç«¯æŒ‡å®šçš„ SQL è¯­å¥ç¼–è¯‘è§£æä¸º <code>Expression</code> è¡¨è¾¾å¼å¯¹è±¡ï¼Œæ–¹ä¾¿åç»­æ¶ˆæ¯çš„å¿«é€ŸåŒ¹é…ä¸è¿‡æ»¤ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SqlFilter</span> <span style="color:#66d9ef">implements</span> FilterSpi <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Expression <span style="color:#a6e22e">compile</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String expr<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> MQFilterException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> SelectorParser<span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>expr<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><h3 id="4-è®¡ç®—ä½æ˜ å°„">(4) è®¡ç®—ä½æ˜ å°„</h3>
<p>å½“ Broker æœåŠ¡å™¨æ¥æ”¶åˆ°æ–°çš„æ¶ˆæ¯åˆ°æ¥ä¹‹åï¼Œä¸€ç›´åœ¨åå°è¿è¡Œçš„ <code>ReputMessageService</code> ä¼šè´Ÿè´£å°†è¿™æ¡æ¶ˆæ¯å°è£…ä¸ºä¸€ä¸ª <code>DispatchRequest</code> åˆ†å‘è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚ä¼šä¼ é€’ç»™æå‰æ„å»ºå¥½çš„<strong>åˆ†å‘è¯·æ±‚é“¾</strong>ã€‚åœ¨ <code>DefaultMessageStore</code> çš„æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¾æ¬¡æ·»åŠ äº†<strong>æ„å»ºæ¶ˆè´¹é˜Ÿåˆ—</strong>å’Œ<strong>æ„å»ºç´¢å¼•</strong>çš„åˆ†å‘è¯·æ±‚æœåŠ¡:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMessageStore</span> <span style="color:#66d9ef">implements</span> MessageStore <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DefaultMessageStore</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MessageStoreConfig messageStoreConfig<span style="color:#f92672">,</span> <span style="color:#75715e">/** å…¶å®ƒå‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatcherList</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatcherList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> CommitLogDispatcherBuildConsumeQueue<span style="color:#f92672">());</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dispatcherList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> CommitLogDispatcherBuildIndex<span style="color:#f92672">());</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>è€Œåœ¨ Broker åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°å…¶åˆæ·»åŠ äº†<strong>è®¡ç®—ä½æ˜ å°„</strong>çš„åˆ†å‘è¯·æ±‚æœåŠ¡ï¼Œå¹¶ä¸”å°†æ­¤åˆ†å‘æœåŠ¡æ”¾åœ¨é“¾è¡¨çš„ç¬¬ä¸€ä¸ªä½ç½®:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BrokerController</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">initialize</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> CloneNotSupportedException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDispatcherList</span><span style="color:#f92672">()</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">addFirst</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> CommitLogDispatcherCalcBitMap<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerConfig</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerFilterManager</span><span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ç”±æ­¤ï¼Œåœ¨æ¯æ¬¡æ”¶åˆ°æ–°çš„æ¶ˆæ¯ä¹‹åï¼Œåˆ†å‘è¯·æ±‚çš„éœ€è¦ç»è¿‡å¦‚ä¸‹<strong>ä¸‰ä¸ªåˆ†å‘è¯·æ±‚æœåŠ¡</strong>è¿›è¡Œå¤„ç†:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/dispatch_request_flow.png" alt="æ¶ˆæ¯åˆ†å‘æœåŠ¡"></p>
<p>æˆ‘ä»¬åœ¨è¿™éƒ¨åˆ†åªä»‹ç»è®¡ç®—ä½æ˜ å°„çš„æœåŠ¡ç±»å®ç°ã€‚å¦‚ä¸‹ï¼Œ<code>dispatch</code> æ–¹æ³•ç”¨æ¥åˆ†å‘è¯·æ±‚é‡Œé¢çš„æ¶ˆæ¯ï¼Œå¯¹äºè¿™æ¯ä¸€æ¡æ¶ˆæ¯ï¼Œé¦–å…ˆæ ¹æ®è¯é¢˜å–å¾—æ‰€æœ‰çš„<strong>æ¶ˆè´¹è¿‡æ»¤æ•°æ®</strong>ã€‚è¿™æ¯ä¸€æ¡æ•°æ®ä»£è¡¨çš„å°±æ˜¯ä¸€æ¡ SQL è¿‡æ»¤è¯­å¥ä¿¡æ¯ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°æ–¹ï¼Œéœ€è¦<strong>ä¸€ä¸€éå†</strong>è¿™äº›è¿‡æ»¤ä¿¡æ¯ï¼Œä»è€Œå®Œæˆè®¡ç®—ä½æœåŠ¡çš„éœ€æ±‚:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLogDispatcherCalcBitMap</span> <span style="color:#66d9ef">implements</span> CommitLogDispatcher <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatch</span><span style="color:#f92672">(</span>DispatchRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Collection<span style="color:#f92672">&lt;</span>ConsumerFilterData<span style="color:#f92672">&gt;</span> filterDatas <span style="color:#f92672">=</span> consumerFilterManager<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">());</span>
        Iterator<span style="color:#f92672">&lt;</span>ConsumerFilterData<span style="color:#f92672">&gt;</span> iterator <span style="color:#f92672">=</span> filterDatas<span style="color:#f92672">.</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
        
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            ConsumerFilterData filterData <span style="color:#f92672">=</span> iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨æ‹¿åˆ° <code>ConsumerFilterData</code> ä¿¡æ¯ä¹‹åï¼Œå…¶ä¼šæ ¹æ®è¿™æ¡ä¿¡æ¯å†…çš„ SQL è¯­å¥<strong>ç¼–è¯‘åçš„è¡¨è¾¾å¼</strong>æ¥å¯¹è¿™æ¡æ¶ˆæ¯è¿›è¡Œæ£€æŸ¥åŒ¹é… (evaluate)ï¼Œçœ‹è¿™æ¡æ¶ˆæ¯æ˜¯å¦æ»¡è¶³ SQL è¯­å¥æ‰€è®¾ç½®çš„æ¡ä»¶ã€‚å¦‚æœæ»¡è¶³ï¼Œé‚£ä¹ˆä¼šå°†å…ˆå‰åœ¨å®¢æˆ·ç«¯æ³¨å†Œé˜¶æ®µè®¡ç®—å¥½çš„ <code>BloomFilterData</code> ä¸­çš„<strong>æ˜ å°„ä½</strong>ä¿¡æ¯è®¾ç½®åˆ° <code>filterBitMap</code> ä¸­ï¼Œå³å°†ç›¸åº”çš„ä½æ•°ç»„ <code>BitsArray</code> ä¸­çš„<strong>ç›¸åº”ä½</strong>è®¾ç½®ä¸º 1 ã€‚åœ¨éªŒè¯å®Œæ‰€æœ‰çš„ SQL è¯­å¥ä¹‹åï¼Œä¼šå°†è¿™äº›æ‰€æœ‰çš„å­—èŠ‚æ•°ç»„æ”¾ç½®åˆ° <code>request</code> è¯·æ±‚ä¹‹ä¸­ï¼Œä»¥ä¾¿äº¤ç”±ä¸‹ä¸€ä¸ªè¯·æ±‚åˆ†å‘æœåŠ¡è¿›è¡Œä½¿ç”¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatch</span><span style="color:#f92672">(</span>DispatchRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    BitsArray filterBitMap <span style="color:#f92672">=</span> BitsArray<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerFilterManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBloomFilter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getM</span><span style="color:#f92672">());</span>

    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        ConsumerFilterData filterData <span style="color:#f92672">=</span> iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
            
        MessageEvaluationContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageEvaluationContext<span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getPropertiesMap</span><span style="color:#f92672">());</span>
        Object ret <span style="color:#f92672">=</span> filterData<span style="color:#f92672">.</span><span style="color:#a6e22e">getCompiledExpression</span><span style="color:#f92672">().</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>

        <span style="color:#75715e">// eval true
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ret <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> ret <span style="color:#66d9ef">instanceof</span> Boolean <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>Boolean<span style="color:#f92672">)</span> ret<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            consumerFilterManager
                <span style="color:#f92672">.</span><span style="color:#a6e22e">getBloomFilter</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">hashTo</span><span style="color:#f92672">(</span>filterData<span style="color:#f92672">.</span><span style="color:#a6e22e">getBloomFilterData</span><span style="color:#f92672">(),</span>
                        filterBitMap<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    request<span style="color:#f92672">.</span><span style="color:#a6e22e">setBitMap</span><span style="color:#f92672">(</span>filterBitMap<span style="color:#f92672">.</span><span style="color:#a6e22e">bytes</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="5-å­˜å‚¨ä½æ˜ å°„">(5) å­˜å‚¨ä½æ˜ å°„</h3>
<p><code>MessageStore</code> åœ¨å¼€å¯<strong>æ‰©å±•æ¶ˆè´¹é˜Ÿåˆ—</strong>çš„é…ç½®ä¹‹åï¼Œæ¯ä¸€ä¸ªæ¶ˆè´¹é˜Ÿåˆ—åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œéƒ½ä¼šé¢å¤–åˆ›å»ºä¸€ä¸ªæ‰©å±•æ¶ˆè´¹é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ªæ‰©å±•æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶çš„å¤§å°é»˜è®¤ä¸º 48MB:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeQueue</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConsumeQueue</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String topic<span style="color:#f92672">,</span> <span style="color:#75715e">/** å…¶å®ƒå‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>defaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStoreConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isEnableConsumeQueueExt</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeQueueExt</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumeQueueExt<span style="color:#f92672">(</span>topic<span style="color:#f92672">,</span> <span style="color:#75715e">/** å…¶å®ƒå‚æ•° **/</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨è®¡ç®—ä½æ˜ å°„ä¸€èŠ‚ä¸­ï¼Œè®¡ç®—å¥½ä½å­—èŠ‚æ•°ç»„ä¹‹åï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦é€šè¿‡ç¬¬äºŒä¸ªåˆ†å‘è¯·æ±‚æœåŠ¡ <code>CommitLogDispatcherBuildConsumeQueue</code> æ¥å­˜å‚¨è¿™äº›å­—èŠ‚ä¿¡æ¯ã€‚é€šè¿‡å¦‚ä¸‹ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒå°†è¯·æ±‚ä¸­çš„<strong>ä½æ˜ å°„ä¿¡æ¯</strong>ã€<strong>æ¶ˆæ¯å­˜å‚¨æ—¶é—´</strong>ã€<strong>æ ‡ç­¾ç </strong>è¿™ä¸‰æ¡ä¿¡æ¯å°è£…ä¸º <code>ConsumeQueueExt.CqExtUnit</code> ï¼Œç„¶åæ”¾å…¥åˆ°æ‰©å±•æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸­ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeQueue</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">putMessagePositionInfoWrapper</span><span style="color:#f92672">(</span>DispatchRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">long</span> tagsCode <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getTagsCode</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isExtWriteEnable<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            ConsumeQueueExt<span style="color:#f92672">.</span><span style="color:#a6e22e">CqExtUnit</span> cqExtUnit <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumeQueueExt<span style="color:#f92672">.</span><span style="color:#a6e22e">CqExtUnit</span><span style="color:#f92672">();</span>
            cqExtUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">setFilterBitMap</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getBitMap</span><span style="color:#f92672">());</span>
            cqExtUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">setMsgStoreTime</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getStoreTimestamp</span><span style="color:#f92672">());</span>
            cqExtUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">setTagsCode</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getTagsCode</span><span style="color:#f92672">());</span>

            <span style="color:#66d9ef">long</span> extAddr <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeQueueExt</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>cqExtUnit<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isExtAddr<span style="color:#f92672">(</span>extAddr<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                tagsCode <span style="color:#f92672">=</span> extAddr<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æˆ‘ä»¬æ³¨æ„åˆ°åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ<code>put</code> å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª long ç±»å‹çš„<strong>æ‰©å±•åœ°å€</strong>ï¼Œå½“è¿™ä¸ªæ•°å€¼æ»¡è¶³ <code>isExtAddr</code> è¦æ±‚åï¼Œå…¶ä¼šå°†å½“å‰çš„æ ‡ç­¾ç è®¾ç½®ä¸ºåˆšæ‰è¿”å›çš„æ‰©å±•åœ°å€ã€‚é‚£ä¹ˆè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢?</p>
<p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ <code>ConsumeQueueExt</code> æ–‡ä»¶åœ¨å­˜æ”¾æ•°æ®æˆåŠŸåæ˜¯å¦‚ä½•è¿”å›ä¿¡æ¯çš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeQueueExt</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> MAX_ADDR <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span> <span style="color:#f92672">-</span> 1L<span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> CqExtUnit cqExtUnit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mappedFile<span style="color:#f92672">.</span><span style="color:#a6e22e">appendMessage</span><span style="color:#f92672">(</span>cqExtUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tempContainer</span><span style="color:#f92672">),</span> 0<span style="color:#f92672">,</span> size<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> decorate<span style="color:#f92672">(</span>wrotePosition <span style="color:#f92672">+</span> mappedFile<span style="color:#f92672">.</span><span style="color:#a6e22e">getFileFromOffset</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> 1<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">decorate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> offset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isExtAddr<span style="color:#f92672">(</span>offset<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> offset <span style="color:#f92672">+</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> offset<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isExtAddr</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> address<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> address <span style="color:#f92672">&lt;=</span> MAX_ADDR<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><code>MAX_ADDR</code> æ˜¯ä¸€ä¸ªå¾ˆå°å¾ˆå°çš„å€¼ï¼Œä¸º <code>-2147483649</code>ï¼Œ å³å†™å…¥ä½ç½®å¦‚æœä¸å°äºè¿™ä¸ªå€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤å®šä¸ºå®ƒä¸æ˜¯æ‰©å±•åœ°å€ã€‚éœ€è¦å°†ä¿®æ­£åçš„ <strong>å†™å…¥åç§»é‡ + <code>Long.MIN_VALUE</code></strong> ç¡®å®šä¸ºæ‰©å±•åœ°å€ã€‚å½“è¯»å–ä¿¡æ¯çš„æ—¶å€™ï¼Œå…¶å…ˆè¯»å– <code>ConsumeQueue</code> æ–‡ä»¶ä¸­çš„æœ€åçš„ Hash æ ‡ç­¾ç å€¼ï¼Œå¦‚æœå…¶é€šè¿‡ <code>isExtAddr()</code> å‡½æ•°è¿”å›çš„æ˜¯ trueï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªåœ°å€ï¼Œå†é€šè¿‡ä¸€ä¸ªå«åš <code>unDecorate()</code> å‡½æ•°å°†å…¶ä¿®æ­£ä¸ºæ­£ç¡®çš„ <code>ConsumeQueueExt</code> æ–‡ä»¶çš„å†™å…¥åœ°å€ï¼Œä»è€Œæ¥ç€è¯»å–æƒ³è¦çš„ä¿¡æ¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">unDecorate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> address<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isExtAddr<span style="color:#f92672">(</span>address<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> address <span style="color:#f92672">-</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> address<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬å‘ç° <code>ConsumeQueue</code> ä¸­çš„æœ€åä¸€ä¸ª long å‹æ•°å€¼ï¼Œå¯èƒ½å­˜å‚¨çš„æ˜¯æ ‡ç­¾ Hash ç ï¼Œä¹Ÿå¯èƒ½å­˜å‚¨çš„æ˜¯æ‰©å±•æ¶ˆè´¹é˜Ÿåˆ—çš„å†™å…¥åœ°å€ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ <code>isExtAddr()</code> æ¥åˆ†æƒ…å†µåˆ¤æ–­ã€‚</p>
<p>ä¸‹å›¾ä¸º <code>ConsumeQueue</code> æ–‡ä»¶å’Œ <code>ConsumeQueueExt</code> æ–‡ä»¶ä¸­å­˜å–ä¿¡æ¯çš„ä¸åŒ:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/ext_addr_vs_tags_code.png" alt="æ‰©å±•æ¶ˆæ¯å­˜å–æ–¹å¼"></p>
<h3 id="6-æ¶ˆæ¯è¿‡æ»¤">(6) æ¶ˆæ¯è¿‡æ»¤</h3>
<p>åœ¨ä¸Šå°èŠ‚æˆ‘ä»¬æåˆ°äº†æœ‰å…³<strong>æ‰©å±•æ¶ˆè´¹é˜Ÿåˆ—åœ°å€</strong>å’Œ<strong>æ ‡ç­¾ Hash ç </strong>å­˜å‚¨çš„ä¸åŒï¼Œæ‰€ä»¥å½“åœ¨å–æ¶ˆæ¯çš„æ—¶å€™ï¼Œå…ˆå¾—ä»æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸­å–å‡º <code>tagsCode</code>ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦æ˜¯æ‰©å±•æ¶ˆè´¹é˜Ÿåˆ—åœ°å€ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»æ‰©å±•æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸­è¯»å–æ­£ç¡®çš„æ ‡ç­¾ Hash ç ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMessageStore</span> <span style="color:#66d9ef">implements</span> MessageStore <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> GetMessageResult <span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String group<span style="color:#f92672">,</span> <span style="color:#75715e">/** å…¶å®ƒå‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ConsumeQueueExt<span style="color:#f92672">.</span><span style="color:#a6e22e">CqExtUnit</span> cqExtUnit <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumeQueueExt<span style="color:#f92672">.</span><span style="color:#a6e22e">CqExtUnit</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;</span> i <span style="color:#f92672">&lt;</span> bufferConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> i <span style="color:#f92672">&lt;</span> maxFilterMessageCount<span style="color:#f92672">;</span> i <span style="color:#f92672">+=</span> ConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">CQ_STORE_UNIT_SIZE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">long</span> tagsCode <span style="color:#f92672">=</span> bufferConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getByteBuffer</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getLong</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">boolean</span> extRet <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> isTagsCodeLegal <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>consumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">isExtAddr</span><span style="color:#f92672">(</span>tagsCode<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                extRet <span style="color:#f92672">=</span> consumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getExt</span><span style="color:#f92672">(</span>tagsCode<span style="color:#f92672">,</span> cqExtUnit<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>extRet<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    tagsCode <span style="color:#f92672">=</span> cqExtUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">getTagsCode</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    isTagsCodeLegal <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“è·å–åˆ°è¿™æ¡æ¶ˆæ¯åœ¨æ‰©å±•æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸­å­˜å–çš„ä¿¡æ¯åï¼Œå°±ä¼šå’Œæ ‡ç­¾åŒ¹é…ä¸€èŠ‚æ‰€è®²è¿°çš„ä¸€è‡´ï¼Œä¼šè¿›è¡Œä¸¤é“è¿‡æ»¤æœºåˆ¶ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€é“ <code>ConsumeQueue</code> æ–‡ä»¶åŒ¹é…:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExpressionMessageFilter</span> <span style="color:#66d9ef">implements</span> MessageFilter <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isMatchedByConsumeQueue</span><span style="color:#f92672">(</span>Long tagsCode<span style="color:#f92672">,</span> ConsumeQueueExt<span style="color:#f92672">.</span><span style="color:#a6e22e">CqExtUnit</span> cqExtUnit<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> filterBitMap <span style="color:#f92672">=</span> cqExtUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">getFilterBitMap</span><span style="color:#f92672">();</span>
        BloomFilter bloomFilter <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerFilterManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBloomFilter</span><span style="color:#f92672">();</span>
        BitsArray bitsArray <span style="color:#f92672">=</span> BitsArray<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>filterBitMap<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> bloomFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">isHit</span><span style="color:#f92672">(</span>consumerFilterData<span style="color:#f92672">.</span><span style="color:#a6e22e">getBloomFilterData</span><span style="color:#f92672">(),</span> bitsArray<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><code>ExpressionMessageFilter</code> ä¾æ® <code>CqExtUnit</code> ä¸­å­˜å‚¨çš„ä½æ•°ç»„é‡æ–°åˆ›å»ºäº†æ¯”ç‰¹æ•°ç»„ <code>bitsArray</code>ï¼Œè¿™ä¸ªæ•°ç»„ä¿¡æ¯ä¸­å·²ç»å­˜å‚¨äº†ä¸åŒ SQL è¡¨è¾¾å¼æ˜¯å¦åŒ¹é…è¿™æ¡æ¶ˆæ¯çš„ç»“æœã€‚<code>isHit()</code> å‡½æ•°ä¼šä¸€ä¸€æ£€æŸ¥ <code>BloomFilterData</code> ä¸­å­˜å‚¨çš„ä½ä¿¡æ¯æ˜¯å¦æ˜ å°„åœ¨ <code>BitsArray</code> ä¸­ã€‚åªè¦æœ‰ä»»ä½•ä¸€ä½æ²¡æœ‰æ˜ å°„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç«‹åˆ»åˆ¤æ–­å‡ºè¿™æ¡æ¶ˆæ¯è‚¯å®šä¸ç¬¦åˆ SQL è¯­å¥çš„æ¡ä»¶ã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/bloomfilter_ishit.png" alt="å‘½ä¸­å¸ƒéš†è¿‡æ»¤å™¨"></p>
<p>å› ä¸ºå¸ƒéš†è¿‡æ»¤å™¨æœ‰ä¸€å®šçš„é”™è¯¯ç‡ï¼Œå…¶åªèƒ½ç²¾ç¡®çš„åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ä¸€å®šä¸åœ¨é›†åˆä¸­ï¼Œè¿”å›æˆåŠŸçš„åªèƒ½ç¡®å®šä¸ºæ¶ˆæ¯å¯èƒ½åœ¨é›†åˆä¸­ã€‚å› æ­¤é€šè¿‡å¸ƒéš†è¿‡æ»¤å™¨æ£€æŸ¥åè¿˜éœ€è¦ç»è¿‡ç¬¬äºŒé“è¿‡æ»¤æœºåˆ¶ï¼Œå³ SQL ç¼–è¯‘åçš„è¡¨è¾¾å¼äº²è‡ªéªŒè¯æ˜¯å¦åŒ¹é…:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExpressionMessageFilter</span> <span style="color:#66d9ef">implements</span> MessageFilter <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isMatchedByCommitLog</span><span style="color:#f92672">(</span>ByteBuffer msgBuffer<span style="color:#f92672">,</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> properties<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        MessageEvaluationContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageEvaluationContext<span style="color:#f92672">(</span>tempProperties<span style="color:#f92672">);</span>
        Object ret <span style="color:#f92672">=</span> realFilterData<span style="color:#f92672">.</span><span style="color:#a6e22e">getCompiledExpression</span><span style="color:#f92672">().</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ret <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!(</span>ret <span style="color:#66d9ef">instanceof</span> Boolean<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>Boolean<span style="color:#f92672">)</span> ret<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>é€šè¿‡åœ¨éªŒè¯ SQL è¡¨è¾¾å¼æ˜¯å¦æ»¡è¶³ä¹‹å‰ï¼Œæå‰éªŒè¯æ˜¯å¦å‘½ä¸­å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¯ä»¥æœ‰æ•ˆçš„é¿å…è®¸å¤šä¸å¿…è¦çš„éªŒè¯:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/sql_filter.png" alt="SQL è¿‡æ»¤"></p>
<h2 id="å››è‡ªå®šä¹‰åŒ¹é…">å››ã€è‡ªå®šä¹‰åŒ¹é…</h2>
<p>æ¶ˆæ¯çš„è‡ªå®šä¹‰åŒ¹é…éœ€è¦å¼€å¯è¿‡æ»¤æœåŠ¡å™¨ã€ä¸Šä¼ è¿‡æ»¤ç±»ã€è¿‡æ»¤æœåŠ¡å™¨å§”æ‰˜è¿‡æ»¤æ¶ˆæ¯ç­‰æ­¥éª¤ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€ä¸€è¿›è¡Œè¯´æ˜ã€‚</p>
<h3 id="1-è¿‡æ»¤æœåŠ¡å™¨">(1) è¿‡æ»¤æœåŠ¡å™¨</h3>
<p>åœ¨å¯åŠ¨ Broker æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå¦‚æœæŒ‡å®šäº†ä¸‹é¢ä¸€è¡Œè®¾ç½®:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">brokerConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">setFilterServerNums</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> filterServerNums<span style="color:#f92672">);</span>
</code></pre></div><p>å³å°†<strong>è¿‡æ»¤æœåŠ¡å™¨</strong>çš„æ•°é‡è®¾å®šä¸ºå¤§äº 0ï¼Œé‚£ä¹ˆ Broker æœåŠ¡å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œå°†ä¼šå¯åŠ¨ <code>filterServerNums</code> ä¸ª<strong>è¿‡æ»¤æœåŠ¡å™¨</strong>ã€‚è¿‡æ»¤æœåŠ¡å™¨æ˜¯é€šè¿‡è°ƒç”¨ <code>shell</code> å‘½ä»¤çš„æ–¹å¼ï¼Œå¯ç”¨<strong>ç‹¬ç«‹è¿›ç¨‹</strong>è¿›è¡Œå¯åŠ¨çš„ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FilterServerManager</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createFilterServer</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> more <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBrokerConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getFilterServerNums</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">filterServerTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
        String cmd <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">buildStartCommand</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> more<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            FilterServerUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">callShell</span><span style="color:#f92672">(</span>cmd<span style="color:#f92672">,</span> log<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>è¿‡æ»¤æœåŠ¡å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šå¯åŠ¨<strong>å®šæ—¶å™¨</strong>æ¯éš” 10 ç§’æ³¨å†Œä¸€æ¬¡åˆ° Broker æœåŠ¡å™¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FiltersrvController</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">initialize</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduledExecutorService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    FiltersrvController<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerFilterServerToBroker</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">},</span> 3<span style="color:#f92672">,</span> 10<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>Broker æœåŠ¡å™¨åœ¨æ”¶åˆ°æ¥è‡ªè¿‡æ»¤æœåŠ¡å™¨çš„æ³¨å†Œä¿¡æ¯ä¹‹åï¼Œä¼šæŠŠè¿‡æ»¤æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯ã€æ³¨å†Œæ—¶é—´ç­‰æ”¾åˆ°<strong>è¿‡æ»¤æœåŠ¡å™¨</strong>è¡¨ä¸­:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FilterServerManager</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ConcurrentMap<span style="color:#f92672">&lt;</span>Channel<span style="color:#f92672">,</span> FilterServerInfo<span style="color:#f92672">&gt;</span> filterServerTable <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>Channel<span style="color:#f92672">,</span> FilterServerInfo<span style="color:#f92672">&gt;(</span>16<span style="color:#f92672">);</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>åŒæ ·ï¼ŒBroker æœåŠ¡å™¨ä¹Ÿéœ€è¦å®šæ—¶å°†<strong>è¿‡æ»¤æœåŠ¡å™¨åœ°å€ä¿¡æ¯</strong>åŒæ­¥ç»™æ‰€æœ‰ <strong>Namesrv å‘½åæœåŠ¡å™¨</strong>ï¼Œä¸Šè¿°æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/filtersrv_startup_and_register.png" alt="è¿‡æ»¤æœåŠ¡å™¨å¯åŠ¨å’Œæ³¨å†Œæµç¨‹"></p>
<h3 id="2-è¿‡æ»¤ç±»">(2) è¿‡æ»¤ç±»</h3>
<p>å½“æ¶ˆè´¹è€…é€šè¿‡ä½¿ç”¨è‡ªå®šä¹‰åŒ¹é…è¿‡æ»¤æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå°†å­˜å‚¨è®¢é˜…ä¿¡æ¯çš„ <code>SubscriptionData</code> ä¸­çš„ <code>filterClassSource</code> è®¾ç½®ä¸º <code>true</code>ï¼Œä»¥è¡¨å¾è¿™ä¸ªå®¢æˆ·ç«¯éœ€è¦è¿‡æ»¤ç±»æ¥è¿›è¡Œæ¶ˆæ¯çš„åŒ¹é…å’Œè¿‡æ»¤ã€‚</p>
<p>æ¶ˆè´¹è€…å®¢æˆ·ç«¯åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼š<strong>å®šæ—¶</strong>åœ°ä¸Šä¼ æœ¬åœ°çš„<strong>è¿‡æ»¤ç±»æºç </strong>åˆ°è¿‡æ»¤æœåŠ¡å™¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MQClientInstance</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startScheduledTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduledExecutorService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    MQClientInstance<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendHeartbeatToAllBrokerWithLock</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">},</span> 1000<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clientConfig</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getHeartbeatBrokerInterval</span><span style="color:#f92672">(),</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sendHeartbeatToAllBrokerWithLock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uploadFilterClassSource</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å…¶ä¸­è¿‡æ»¤æœåŠ¡å™¨çš„åœ°å€åˆ—è¡¨æ˜¯åœ¨ä» Namesrv æœåŠ¡å™¨è·å–è¯é¢˜è·¯ç”±ä¿¡æ¯çš„æ—¶å€™å–å¾—çš„ï¼Œè¯é¢˜è·¯ç”±ä¿¡æ¯ä¸å…‰å­˜å‚¨äº†æ¶ˆæ¯é˜Ÿåˆ—æ•°æ®ï¼Œè¿˜å­˜å‚¨äº†å„ä¸ª Broker æ‰€å…³è”çš„è¿‡æ»¤æœåŠ¡å™¨åˆ—è¡¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TopicRouteData</span> <span style="color:#66d9ef">extends</span> RemotingSerializable <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#75715e">/* brokerAddr */</span><span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span><span style="color:#75715e">/* Filter Server */</span><span style="color:#f92672">&gt;</span> filterServerTable<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“è¿‡æ»¤æœåŠ¡å™¨æ¥æ”¶åˆ°æ¥è‡ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯çš„æºç ä¹‹åï¼Œå…¶ä¼šé¦–å…ˆé¦–å…ˆç”Ÿæˆä¸€ä¸ªé”®ä¸º <strong>è¯é¢˜@ç»„</strong> çš„å­—ç¬¦ä¸²æ¥æŸ¥é˜…è¿‡æ»¤ç±»ä¿¡æ¯æ˜¯å¦å·²ç»å­˜åœ¨äºå†…å­˜é‡Œé¢çš„ <code>filterClassTable</code> è¡¨ä¸­ä¸”æ–‡ä»¶é€šè¿‡ CRC æ ¡éªŒã€‚å¦‚æœæ²¡æœ‰å­˜åœ¨æˆ–æ ¡éªŒå¤±è´¥ï¼Œé‚£ä¹ˆå°±éœ€è¦å…ˆç¼–è¯‘å¹¶åŠ è½½è¿™ä¸ªç±»:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DynaCode</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">compileAndLoadClass</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        String<span style="color:#f92672">[]</span> sourceFiles <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">uploadSrcFile</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">compile</span><span style="color:#f92672">(</span>sourceFiles<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadClass</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">loadClass</span><span style="color:#f92672">.</span><span style="color:#a6e22e">keySet</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼–è¯‘åçš„ç±»å­˜æ”¾äº <code>$HOME/rocketmq_filter_class/$PID</code> ç›®å½•ä¸‹ï¼Œç±»çš„æºæ–‡ä»¶å’Œç±»çš„å­—èŠ‚ç æ–‡ä»¶åä¹Ÿä¼šç›¸åº”çš„åŠ ä¸Šå½“å‰æ—¶é—´æˆ³æ¥ç¡®å®š:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/2018_04_02_16_57_30.png" alt="è¿‡æ»¤ç±»å­˜æ”¾ä½ç½®"></p>
<p>ä¸Šè¿°æµç¨‹å›¾å¦‚ä¸‹:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/upload_filter_class_to_filtersrv.png" alt="ä¸Šä¼ è¿‡æ»¤ç±»"></p>
<h3 id="3-è¿‡æ»¤æ¶ˆæ¯">(3) è¿‡æ»¤æ¶ˆæ¯</h3>
<p>å½“æ¶ˆè´¹è€…å®¢æˆ·ç«¯å¯ç”¨è‡ªå®šä¹‰åŒ¹é…è¿‡æ»¤æ¶ˆæ¯åï¼Œå‘å¾€æœåŠ¡å™¨çš„æ•°æ®ä¸­ä¹ŸåŒ…å«äº†<strong>è¿‡æ»¤æ ‡å¿—ä½</strong>ï¼Œè¿™æ ·æ¯æ¬¡æ‹‰å–æ¶ˆæ¯çš„æœåŠ¡å™¨ä¹Ÿç”±åŸæ¥çš„ Broker æœåŠ¡å™¨å˜æ›´ä¸º <code>Filtersrv</code> è¿‡æ»¤æœåŠ¡å™¨ï¼Œå…¶ä¸­è¿‡æ»¤æœåŠ¡å™¨åœ°å€çš„é€‰æ‹©æ˜¯éšæœºç¡®å®šçš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PullAPIWrapper</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> PullResult <span style="color:#a6e22e">pullKernelImpl</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MessageQueue mq<span style="color:#f92672">,</span> <span style="color:#75715e">/** å…¶å®ƒå‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>findBrokerResult <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>PullSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">hasClassFilterFlag</span><span style="color:#f92672">(</span>sysFlagInner<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ä»è¿‡æ»¤æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯
</span><span style="color:#75715e"></span>                brokerAddr <span style="color:#f92672">=</span> computPullFromWhichFilterServer<span style="color:#f92672">(</span>mq<span style="color:#f92672">.</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">(),</span> brokerAddr<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>è¿‡æ»¤æœåŠ¡å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œå†…éƒ¨è¿˜å¯åŠ¨äº†ä¸€ä¸ª <code>PullConsumer</code> å®¢æˆ·ç«¯ï¼Œç”¨ä»¥ä» Broker æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FiltersrvController</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> DefaultMQPullConsumer defaultMQPullConsumer <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">new</span> DefaultMQPullConsumer<span style="color:#f92672">(</span>MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">FILTERSRV_CONSUMER_GROUP</span><span style="color:#f92672">);</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPullConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“è¿‡æ»¤æœåŠ¡å™¨æ”¶åˆ°çœŸæ­£çš„æ¶ˆè´¹è€…å‘æ¥çš„æ¶ˆè´¹æ¶ˆæ¯çš„è¯·æ±‚ä¹‹åï¼Œå…¶ä¼šå§”æ‰˜å†…éƒ¨çš„ <code>PullConsumer</code> ä½¿ç”¨åŒ…å«åœ¨è¯·æ±‚ä½“å†…çš„åç§»é‡å» Broker æœåŠ¡å™¨æ‹‰å–æ‰€æœ‰æ¶ˆæ¯ï¼Œæ­¤æ—¶è¿™äº›æ¶ˆæ¯æ˜¯å®Œå…¨æ²¡æœ‰è¿‡æ»¤çš„ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultRequestProcessor</span> <span style="color:#66d9ef">implements</span> NettyRequestProcessor <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> RemotingCommand <span style="color:#a6e22e">pullMessageForward</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ChannelHandlerContext ctx<span style="color:#f92672">,</span>
                                               <span style="color:#66d9ef">final</span> RemotingCommand request<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>

        MessageQueue mq <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageQueue<span style="color:#f92672">();</span>
        
        mq<span style="color:#f92672">.</span><span style="color:#a6e22e">setTopic</span><span style="color:#f92672">(</span>requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">());</span>
        mq<span style="color:#f92672">.</span><span style="color:#a6e22e">setQueueId</span><span style="color:#f92672">(</span>requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">getQueueId</span><span style="color:#f92672">());</span>
        mq<span style="color:#f92672">.</span><span style="color:#a6e22e">setBrokerName</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">filtersrvController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBrokerName</span><span style="color:#f92672">());</span>

        <span style="color:#75715e">// è®¾ç½®åç§»é‡å’Œæœ€å¤§æ•°é‡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">long</span> offset <span style="color:#f92672">=</span> requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">getQueueOffset</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">int</span> maxNums <span style="color:#f92672">=</span> requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxMsgNums</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// å§”æ‰˜å†…éƒ¨æ¶ˆè´¹è€…ä» Broker æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯
</span><span style="color:#75715e"></span>        pullConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">pullBlockIfNotFound</span><span style="color:#f92672">(</span>mq<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> offset<span style="color:#f92672">,</span> maxNums<span style="color:#f92672">,</span> pullCallback<span style="color:#f92672">);</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>è¿‡æ»¤æœåŠ¡å™¨ä» Broker æœåŠ¡å™¨è·å–åˆ°å®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨ä¹‹åï¼Œä¼šéå†æ¶ˆæ¯åˆ—è¡¨ï¼Œç„¶åä½¿ç”¨è¿‡æ»¤ç±»ä¸€ä¸€è¿›è¡ŒåŒ¹é…ï¼Œæœ€ç»ˆå°†åŒ¹é…æˆåŠŸçš„æ¶ˆæ¯åˆ—è¡¨è¿”å›ç»™å®¢æˆ·ç«¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultRequestProcessor</span> <span style="color:#66d9ef">implements</span> NettyRequestProcessor <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> RemotingCommand <span style="color:#a6e22e">pullMessageForward</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ChannelHandlerContext ctx<span style="color:#f92672">,</span>
                                               <span style="color:#66d9ef">final</span> RemotingCommand request<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> PullCallback pullCallback <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PullCallback<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>

                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onSuccess</span><span style="color:#f92672">(</span>PullResult pullResult<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getPullStatus</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">case</span> FOUND<span style="color:#f92672">:</span>
                        List<span style="color:#f92672">&lt;</span>MessageExt<span style="color:#f92672">&gt;</span> msgListOK <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>MessageExt<span style="color:#f92672">&gt;();</span>
                        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>MessageExt msg <span style="color:#f92672">:</span> pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgFoundList</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                            <span style="color:#75715e">// ä½¿ç”¨è¿‡æ»¤ç±»è¿‡æ»¤æ¶ˆæ¯
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">boolean</span> match <span style="color:#f92672">=</span> findFilterClass<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageFilter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">match</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> filterContext<span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>match<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                                msgListOK<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
                            <span style="color:#f92672">}</span>
                        <span style="color:#f92672">}</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                    <span style="color:#f92672">}</span>

                <span style="color:#f92672">}</span>

            <span style="color:#f92672">};</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸Šè¿°æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/filter_message_by_filtersrv.png" alt="è¿‡æ»¤æµç¨‹å›¾"></p>
<p>æ‰«æä¸‹é¢äºŒç»´ç ï¼Œåœ¨æ‰‹æœºç«¯é˜…è¯»ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-filter-flow/qrcode.png" alt=""></p>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>

  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'Hw2fQnNQyghcgeRvQosC5cIy-gzGzoHsz',
        appKey: '0ULuPWcxGRLCaHz84icXvBgn',
        notify: 'false', 
        verify: 'false', 
        avatar:'mm', 
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆå§...',
        visitor: 'true'
    });
  </script></div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€æ¶ˆæ¯è¿‡æ»¤ç±»å‹">ä¸€ã€æ¶ˆæ¯è¿‡æ»¤ç±»å‹</a>
      <ul>
        <li><a href="#1-æ ‡ç­¾åŒ¹é…">(1) æ ‡ç­¾åŒ¹é…</a></li>
        <li><a href="#2-sql-åŒ¹é…">(2) SQL åŒ¹é…</a></li>
        <li><a href="#3-è‡ªå®šä¹‰åŒ¹é…">(3) è‡ªå®šä¹‰åŒ¹é…</a></li>
      </ul>
    </li>
    <li><a href="#äºŒæ ‡ç­¾åŒ¹é…">äºŒã€æ ‡ç­¾åŒ¹é…</a></li>
    <li><a href="#ä¸‰sql-åŒ¹é…">ä¸‰ã€SQL åŒ¹é…</a>
      <ul>
        <li><a href="#1-æ³¨å†Œè¿‡æ»¤ä¿¡æ¯">(1) æ³¨å†Œè¿‡æ»¤ä¿¡æ¯</a></li>
        <li><a href="#2-ç”Ÿæˆ-bloomfilterdata">(2) ç”Ÿæˆ BloomFilterData</a></li>
        <li><a href="#3-ç¼–è¯‘-sql-è¯­å¥">(3) ç¼–è¯‘ SQL è¯­å¥</a></li>
        <li><a href="#4-è®¡ç®—ä½æ˜ å°„">(4) è®¡ç®—ä½æ˜ å°„</a></li>
        <li><a href="#5-å­˜å‚¨ä½æ˜ å°„">(5) å­˜å‚¨ä½æ˜ å°„</a></li>
        <li><a href="#6-æ¶ˆæ¯è¿‡æ»¤">(6) æ¶ˆæ¯è¿‡æ»¤</a></li>
      </ul>
    </li>
    <li><a href="#å››è‡ªå®šä¹‰åŒ¹é…">å››ã€è‡ªå®šä¹‰åŒ¹é…</a>
      <ul>
        <li><a href="#1-è¿‡æ»¤æœåŠ¡å™¨">(1) è¿‡æ»¤æœåŠ¡å™¨</a></li>
        <li><a href="#2-è¿‡æ»¤ç±»">(2) è¿‡æ»¤ç±»</a></li>
        <li><a href="#3-è¿‡æ»¤æ¶ˆæ¯">(3) è¿‡æ»¤æ¶ˆæ¯</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>



</html>












