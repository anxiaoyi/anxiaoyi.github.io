<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="RocketMQ 消息索引流程"><meta property="og:title" content="RocketMQ 消息索引流程" />
<meta property="og:description" content="RocketMQ 消息索引流程 讲述 RocketMQ 消息索引服务
一、消息查询方式 对于 Producer 发送到 Broker 服务器的消息，RocketMQ 支持多种方式来方便地查询消息:
(1) 根据键查询消息 如下所示，在构建消息的时候，指定了这条消息的键为 “OrderID001”:
Message msg = new Message(&#34;TopicTest&#34;, &#34;TagA&#34;, &#34;OrderID001&#34;, // Keys  &#34;Hello world&#34;.getBytes(RemotingHelper.DEFAULT_CHARSET)); 那么，当这条消息发送成功后，我们可以使用 queryMsgByKey 命令查询到这条消息的详细信息:
MQAdminStartup.main(new String[] { &#34;queryMsgByKey&#34;, &#34;-n&#34;, &#34;localhost:9876&#34;, &#34;-t&#34;, &#34;TopicTest&#34;, &#34;-k&#34;, &#34;OrderID001&#34; }); (2) 根据ID(偏移量)查询消息 消息在发送成功之后，其返回的 SendResult 类中包含了这条消息的唯一偏移量 ID (注意此处指的是 offsetMsgId):
用户可以使用 queryMsgById 命令查询这条消息的详细信息:
MQAdminStartup.main(new String[] { &#34;queryMsgById&#34;, &#34;-n&#34;, &#34;localhost:9876&#34;, &#34;-i&#34;, &#34;0A6C73D900002A9F0000000000004010&#34; }); (3) 根据唯一键查询消息 消息在发送成功之后，其返回的 SendResult 类中包含了这条消息的唯一 ID:
用户可以使用 queryMsgByUniqueKey 命令查询这条消息的详细信息:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/rocketmq/rocketmq-message-indexing-flow/" />

<title>RocketMQ 消息索引流程 | 赵坤的个人网站</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.edc993575be58655f3e49634e3ca6db09cc38ac9aa03ecdbe81d941636e35273.css" integrity="sha256-7cmTV1vlhlXz5JY048ptsJzDismqA&#43;zb6B2UFjbjUnM=">


<script defer src="/en.search.min.c1e25a1f4406d6b6a573baec1903b114a528e1a3b231911153255ffa9e818e27.js" integrity="sha256-weJaH0QG1ralc7rsGQOxFKUo4aOyMZERUyVf&#43;p6Bjic="></script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>赵坤的个人网站</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>









  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ 源码分析
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-send-message-flow/" >
      RocketMQ 消息发送流程
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-store-flow/" >
      RocketMQ 消息存储流程
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-receive-flow/" >
      RocketMQ 消息接受流程
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-filter-flow/" >
      RocketMQ 消息过滤流程
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-indexing-flow/"  class="active">
      RocketMQ 消息索引流程
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-timing-message-and-retry-message/" >
      RocketMQ 定时消息和重试消息
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-master-slave-sync/" >
      RocketMQ 主备同步
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript 专栏
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      书籍
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      程序员面试题
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      云&#43;社区技术沙龙
  </a>


    

    






  </li>


      
    
  </ul>
  



  














</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>RocketMQ 消息索引流程</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#一消息查询方式">一、消息查询方式</a>
      <ul>
        <li><a href="#1-根据键查询消息">(1) 根据键查询消息</a></li>
        <li><a href="#2-根据id偏移量查询消息">(2) 根据ID(偏移量)查询消息</a></li>
        <li><a href="#3-根据唯一键查询消息">(3) 根据唯一键查询消息</a></li>
        <li><a href="#4-根据消息队列偏移量查询消息">(4) 根据消息队列偏移量查询消息</a></li>
      </ul>
    </li>
    <li><a href="#二id-偏移量-查询">二、ID (偏移量) 查询</a>
      <ul>
        <li><a href="#1-生成-id">(1) 生成 ID</a></li>
        <li><a href="#2-使用-id-查询">(2) 使用 ID 查询</a></li>
      </ul>
    </li>
    <li><a href="#三消息队列偏移量查询">三、消息队列偏移量查询</a></li>
    <li><a href="#四消息索引服务">四、消息索引服务</a>
      <ul>
        <li><a href="#1-索引文件结构">(1) 索引文件结构</a></li>
        <li><a href="#2-添加消息">(2) 添加消息</a></li>
        <li><a href="#3-查询消息">(3) 查询消息</a></li>
      </ul>
    </li>
    <li><a href="#五唯一键查询消息">五、唯一键查询消息</a>
      <ul>
        <li><a href="#1-构建键">(1) 构建键</a></li>
        <li><a href="#2-索引键">(2) 索引键</a></li>
        <li><a href="#3-使用键查询">(3) 使用键查询</a></li>
      </ul>
    </li>
    <li><a href="#六键查询消息">六、键查询消息</a>
      <ul>
        <li><a href="#1-构建键-1">(1) 构建键</a></li>
        <li><a href="#2-索引键-1">(2) 索引键</a></li>
        <li><a href="#3-使用键查询-1">(3) 使用键查询</a></li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown"><h1 id="rocketmq-消息索引流程">RocketMQ 消息索引流程</h1>
<p>讲述 RocketMQ 消息索引服务</p>
<h2 id="一消息查询方式">一、消息查询方式</h2>
<p>对于 Producer 发送到 Broker 服务器的消息，RocketMQ 支持多种方式来方便地查询消息:</p>
<h3 id="1-根据键查询消息">(1) 根据键查询消息</h3>
<p>如下所示，在构建消息的时候，指定了这条消息的键为 “OrderID001”:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Message msg <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">new</span> Message<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;TopicTest&#34;</span><span style="color:#f92672">,</span>
                <span style="color:#e6db74">&#34;TagA&#34;</span><span style="color:#f92672">,</span>
                <span style="color:#e6db74">&#34;OrderID001&#34;</span><span style="color:#f92672">,</span> <span style="color:#75715e">// Keys
</span><span style="color:#75715e"></span>                <span style="color:#e6db74">&#34;Hello world&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span>RemotingHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_CHARSET</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>那么，当这条消息发送成功后，我们可以使用 <code>queryMsgByKey</code> 命令查询到这条消息的详细信息:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">MQAdminStartup<span style="color:#f92672">.</span><span style="color:#a6e22e">main</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[</span><span style="color:#f92672">]</span> <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;queryMsgByKey&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-n&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;localhost:9876&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-t&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;TopicTest&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-k&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;OrderID001&#34;</span>
    <span style="color:#f92672">}</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><h3 id="2-根据id偏移量查询消息">(2) 根据ID(偏移量)查询消息</h3>
<p>消息在发送成功之后，其返回的 <code>SendResult</code> 类中包含了这条消息的唯一偏移量 ID (注意此处指的是 <code>offsetMsgId</code>):</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-indexing-flow/2018_04_03_11_19_23.png" alt="消息发送成功返回偏移量"></p>
<p>用户可以使用 <code>queryMsgById</code> 命令查询这条消息的详细信息:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">MQAdminStartup<span style="color:#f92672">.</span><span style="color:#a6e22e">main</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[</span><span style="color:#f92672">]</span> <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;queryMsgById&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-n&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;localhost:9876&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-i&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;0A6C73D900002A9F0000000000004010&#34;</span>
    <span style="color:#f92672">}</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><h3 id="3-根据唯一键查询消息">(3) 根据唯一键查询消息</h3>
<p>消息在发送成功之后，其返回的 SendResult 类中包含了这条消息的<strong>唯一 ID</strong>:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-indexing-flow/2018_04_03_11_19_47.png" alt="消息唯一 ID"></p>
<p>用户可以使用 <code>queryMsgByUniqueKey</code> 命令查询这条消息的详细信息:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">MQAdminStartup<span style="color:#f92672">.</span><span style="color:#a6e22e">main</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[</span><span style="color:#f92672">]</span> <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;queryMsgByUniqueKey&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-n&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;localhost:9876&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-i&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;0A6C73D939B318B4AAC20CBA5D920000&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-t&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;TopicTest&#34;</span>
    <span style="color:#f92672">}</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><h3 id="4-根据消息队列偏移量查询消息">(4) 根据消息队列偏移量查询消息</h3>
<p>消息发送成功之后的 <code>SendResult</code> 中还包含了消息队列的其它信息，如消息队列 ID、消息队列偏移量等信息:</p>
<pre><code>SendResult [sendStatus=SEND_OK,
            msgId=0A6C73D93EC518B4AAC20CC4ACD90000,
            offsetMsgId=0A6C73D900002A9F000000000000484E,
            messageQueue=MessageQueue [topic=TopicTest,
                                    brokerName=zk-pc,
                                    queueId=3],
            queueOffset=24]
</code></pre><p>根据这些信息，使用 <code>queryMsgByOffset</code> 命令也可以查询到这条消息的详细信息:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">MQAdminStartup<span style="color:#f92672">.</span><span style="color:#a6e22e">main</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[</span><span style="color:#f92672">]</span> <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;queryMsgByOffset&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-n&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;localhost:9876&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-t&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;TopicTest&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-b&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;zk-pc&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-i&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;3&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;-o&#34;</span><span style="color:#f92672">,</span>
        <span style="color:#e6db74">&#34;24&#34;</span>
    <span style="color:#f92672">}</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><h2 id="二id-偏移量-查询">二、ID (偏移量) 查询</h2>
<h3 id="1-生成-id">(1) 生成 ID</h3>
<p>ID (偏移量) 是在消息发送到 Broker 服务器存储的时候生成的，其包含如下几个字段：</p>
<ul>
<li>Broker 服务器 IP 地址</li>
<li>Broker 服务器端口号</li>
<li>消息文件 <code>CommitLog</code> 写偏移量</li>
</ul>
<p><img src="/images/docs/rocketmq/rocketmq-message-indexing-flow/msgid_generated_in_broker.png" alt="生成 ID"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLog</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultAppendMessageCallback</span> <span style="color:#66d9ef">implements</span> AppendMessageCallback <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">public</span> AppendMessageResult <span style="color:#a6e22e">doAppend</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> fileFromOffset<span style="color:#f92672">,</span> <span style="color:#75715e">/** 其它参数 **/</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            String msgId <span style="color:#f92672">=</span> MessageDecoder
                <span style="color:#f92672">.</span><span style="color:#a6e22e">createMessageId</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msgIdMemory</span><span style="color:#f92672">,</span>
                                 msgInner<span style="color:#f92672">.</span><span style="color:#a6e22e">getStoreHostBytes</span><span style="color:#f92672">(</span>hostHolder<span style="color:#f92672">)</span><span style="color:#f92672">,</span>
                                 wroteOffset<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="2-使用-id-查询">(2) 使用 ID 查询</h3>
<p>Admin 端查询的时候，首先对 <code>msgId</code> 进行解析，取出 Broker 服务器的 IP 、端口号和消息偏移量:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageDecoder</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> MessageId <span style="color:#a6e22e">decodeMessageId</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String msgId<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> UnknownHostException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span><span style="color:#f92672">]</span> ip <span style="color:#f92672">=</span> UtilAll<span style="color:#f92672">.</span><span style="color:#a6e22e">string2bytes</span><span style="color:#f92672">(</span>msgId<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> 8<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span><span style="color:#f92672">]</span> port <span style="color:#f92672">=</span> UtilAll<span style="color:#f92672">.</span><span style="color:#a6e22e">string2bytes</span><span style="color:#f92672">(</span>msgId<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>8<span style="color:#f92672">,</span> 16<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// offset
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span><span style="color:#f92672">]</span> data <span style="color:#f92672">=</span> UtilAll<span style="color:#f92672">.</span><span style="color:#a6e22e">string2bytes</span><span style="color:#f92672">(</span>msgId<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>16<span style="color:#f92672">,</span> 32<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>获取到<strong>偏移量</strong>之后，Admin 会对 Broker 服务器发送一个 <code>VIEW_MESSAGE_BY_ID</code> 的请求命令，Broker 服务器在收到请求后，会依据偏移量定位到 <code>CommitLog</code> 文件中的相应位置,然后取出消息，返回给 Admin 端:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMessageStore</span> <span style="color:#66d9ef">implements</span> MessageStore <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> SelectMappedBufferResult <span style="color:#a6e22e">selectOneMessageByOffset</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> commitLogOffset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SelectMappedBufferResult sbr <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commitLog</span>
            <span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(</span>commitLogOffset<span style="color:#f92672">,</span> 4<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 1 TOTALSIZE
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> size <span style="color:#f92672">=</span> sbr<span style="color:#f92672">.</span><span style="color:#a6e22e">getByteBuffer</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commitLog</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(</span>commitLogOffset<span style="color:#f92672">,</span> size<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-indexing-flow/query_message_by_msg_offset_id.png" alt="根据偏移量定为消息"></p>
<h2 id="三消息队列偏移量查询">三、消息队列偏移量查询</h2>
<p>根据队列偏移量查询是最简单的一种查询方式，Admin 会启动一个 <code>PullConsumer</code> ，然后利用用户传递给 Admin 的队列 ID、队列偏移量等信息，从服务器拉取一条消息过来:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">QueryMsgByOffsetSubCommand</span> <span style="color:#66d9ef">implements</span> SubCommand <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>CommandLine commandLine<span style="color:#f92672">,</span> Options options<span style="color:#f92672">,</span> RPCHook rpcHook<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> SubCommandException <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 根据参数构建 MessageQueue
</span><span style="color:#75715e"></span>        MessageQueue mq <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageQueue<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        mq<span style="color:#f92672">.</span><span style="color:#a6e22e">setTopic</span><span style="color:#f92672">(</span>topic<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        mq<span style="color:#f92672">.</span><span style="color:#a6e22e">setBrokerName</span><span style="color:#f92672">(</span>brokerName<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        mq<span style="color:#f92672">.</span><span style="color:#a6e22e">setQueueId</span><span style="color:#f92672">(</span>Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">parseInt</span><span style="color:#f92672">(</span>queueId<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// 从 Broker 服务器拉取消息
</span><span style="color:#75715e"></span>        PullResult pullResult <span style="color:#f92672">=</span> defaultMQPullConsumer<span style="color:#f92672">.</span><span style="color:#a6e22e">pull</span><span style="color:#f92672">(</span>mq<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">,</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">parseLong</span><span style="color:#f92672">(</span>offset<span style="color:#f92672">)</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-indexing-flow/query_msg_by_message_queue_offset.png" alt="使用消息队列偏移量查询"></p>
<h2 id="四消息索引服务">四、消息索引服务</h2>
<p>在继续讲解剩下两种查询方式之前，我们必须先介绍以下 Broker 端的消息索引服务。</p>
<p>在之前提到过，每当一条消息发送过来之后，其会封装为一个 <code>DispatchRequest</code> 来下发给各个转发服务，而 <code>CommitLogDispatcherBuildIndex</code> 构建索引服务便是其中之一:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLogDispatcherBuildIndex</span> <span style="color:#66d9ef">implements</span> CommitLogDispatcher <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatch</span><span style="color:#f92672">(</span>DispatchRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DefaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageStoreConfig</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isMessageIndexEnable</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            DefaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">indexService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">buildIndex</span><span style="color:#f92672">(</span>request<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="1-索引文件结构">(1) 索引文件结构</h3>
<p>消息的索引信息是存放在磁盘上的，文件以时间戳命名的，默认存放在 <code>$HOME/store/index</code> 目录下。由下图来看，一个索引文件的结构被分成了三部分:</p>
<ul>
<li>前 40 个字节存放固定的索引头信息，包含了存放在这个索引文件中的消息的<strong>最小/大存储时间</strong>、<strong>最小/大偏移量</strong>等状况</li>
<li>中间一段存储了 500 万个哈希槽位，每个槽内部存储的是索引文件的地址 (索引槽)</li>
<li>最后一段存储了 2000 万个索引内容信息，是实际的索引信息存储的地方。每一个槽位存储了这条消息的键哈希值、存储偏移量、存储时间戳与下一个索引槽地址</li>
</ul>
<p><img src="/images/docs/rocketmq/rocketmq-message-indexing-flow/indexfile_structure.png" alt="索引文件数据结构"></p>
<p>RocketMQ 在内存中还维护了一个<strong>索引文件列表</strong>，对于每一个索引文件，前一个文件的最大存储时间是下一个文件的最小存储时间，前一个文件的最大偏移量是下一个文件的最大偏移量。每一个索引文件都索引了在某个时间段内、某个偏移量段内的所有消息，当文件满了，就会用前一个文件的最大偏移量和最大存储时间作为起始值，创建下一个索引文件:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-indexing-flow/indexfile_list.png" alt="索引文件列表"></p>
<h3 id="2-添加消息">(2) 添加消息</h3>
<p>当有新的消息过来后，<strong>构建索引服务</strong>会取出这条消息的键，然后对字符串 “话题#键” 构建索引。构建索引的步骤如下:</p>
<ul>
<li><strong>找出哈希槽</strong>: 生成字符串哈希码，取余落到 500W 个槽位之一，并取出其中的值，默认为 0</li>
<li><strong>找出索引槽</strong>: <code>IndexHeader</code> 维护了 <code>indexCount</code>，实际存储的索引槽就是直接依次顺延添加的</li>
<li><strong>存储索引内容</strong>: 找到索引槽后，放入键哈希值、存储偏移量、存储时间戳与下一个索引槽地址。下一个索引槽地址就是第一步哈希槽中取出的值，0 代表这个槽位是第一次被索引，而不为 0 代表这个槽位之前的索引槽地址。由此，通过索引槽地址可以将相同哈希槽的消息串联起来，像单链表那样。</li>
<li><strong>更新哈希槽</strong>: 更新原有哈希槽中存储的值</li>
</ul>
<p>我们以实际例子来说明。假设我们需要依次为键的哈希值为 “{16,29,29,8,16,16}” 这几条消息构建索引，我们在这个地方忽略了索引信息中存储的存储时间和偏移量字段，只是存储<strong>键哈希和下一索引槽信息</strong>，那么:</p>
<ul>
<li>放入 16: 将 “16|0” 存储在第 1 个索引槽中，并更新哈希槽为 16 的值为 1，即哈希槽为 16 的第一个索引块的地址为 1</li>
<li>放入 29: 将 “29|0” 存储在第 2 个索引槽中，并更新哈希槽为 29 的值为 2，即哈希槽为 29 的第一个索引块的地址为 2</li>
<li>放入 29: 取出哈希槽为 29 中的值 2，然后将 “29|2” 存储在第 3 个索引槽中，并更新哈希槽为 29 的值为 3，即哈希槽为 29 的第一个索引块的地址为 3。而在找到索引块为 3 的索引信息后，又能取出上一个索引块的地址 2，构成链表为： “[29]-&gt;3-&gt;2”</li>
<li>放入 8: 将 “8|0” 存储在第 4 个索引槽中，并更新哈希槽为 8 的值为 4，即哈希槽为 8 的第一个索引块的地址为 4</li>
<li>放入 16: 取出哈希槽为 16 中的值 1，然后将 “16|1” 存储在第 5 个索引槽中，并更新哈希槽为 16 的值为 5。构成链表为: “[16]-&gt;5-&gt;1”</li>
<li>放入 16: 取出哈希槽为 16 中的值 5，然后将 “16|5” 存储在第 6 个索引槽中，并更新哈希槽为 16 的值为 6。构成链表为: “[16]-&gt;6-&gt;5-&gt;1”</li>
</ul>
<p>整个过程如下图所示:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-indexing-flow/put_key_example.png" alt="对消息索引流程"></p>
<h3 id="3-查询消息">(3) 查询消息</h3>
<p>当需要根据键来查询消息的时候，其会按照倒序回溯整个索引文件列表，对于每一个在时间上能够匹配用户传入的 <code>begin</code> 和 <code>end</code> 时间戳参数的索引文件，会一一进行消息查询：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IndexService</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> QueryOffsetResult <span style="color:#a6e22e">queryOffset</span><span style="color:#f92672">(</span>String topic<span style="color:#f92672">,</span> String key<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> maxNum<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> begin<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> end<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 倒序
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">indexFileList</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">;</span> i<span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 位于时间段内
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>f<span style="color:#f92672">.</span><span style="color:#a6e22e">isTimeMatched</span><span style="color:#f92672">(</span>begin<span style="color:#f92672">,</span> end<span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// 消息查询
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>而具体到每一个索引文件，其查询匹配消息的过程如下所示:</p>
<ul>
<li><strong>确定哈希槽</strong>: 根据键生成哈希值，定位到哈希槽</li>
<li><strong>定位索引槽</strong>: 哈希槽中的值存储的就是链表的第一个索引槽地址</li>
<li><strong>遍历索引槽</strong>: 沿着索引槽地址，依次取出下一个索引槽地址，即沿着链表遍历，直至遇见下一个索引槽地址为非法地址 0 停止</li>
<li><strong>收集偏移量</strong>: 在遇到匹配的消息之后，会将相应的物理偏移量放到列表中，最后根据物理偏移量，从 <code>CommitLog</code> 文件中取出消息</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMessageStore</span> <span style="color:#66d9ef">implements</span> MessageStore <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> QueryMessageResult <span style="color:#a6e22e">queryMessage</span><span style="color:#f92672">(</span>String topic<span style="color:#f92672">,</span> String key<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> maxNum<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> begin<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> end<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> m <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> m <span style="color:#f92672">&lt;</span> queryOffsetResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getPhyOffsets</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span> m<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">long</span> offset <span style="color:#f92672">=</span> queryOffsetResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getPhyOffsets</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>m<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">// 根据偏移量从 CommitLog 文件中取出消息
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>以查询哈希值 16 的消息为例，图示如下:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-indexing-flow/query_message_hash_16_example.png" alt="查询哈希值 16 的消息"></p>
<h2 id="五唯一键查询消息">五、唯一键查询消息</h2>
<h3 id="1-构建键">(1) 构建键</h3>
<p>消息的<strong>唯一键</strong>是在客户端发送消息前构建的:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMQProducerImpl</span> <span style="color:#66d9ef">implements</span> MQProducerInner <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> SendResult <span style="color:#a6e22e">sendKernelImpl</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Message msg<span style="color:#f92672">,</span> <span style="color:#75715e">/** 其它参数 **/</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> XXXException <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#f92672">!</span><span style="color:#f92672">(</span>msg <span style="color:#66d9ef">instanceof</span> MessageBatch<span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            MessageClientIDSetter<span style="color:#f92672">.</span><span style="color:#a6e22e">setUniqID</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>创建唯一 ID 的算法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageClientIDSetter</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">createUniqID</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">(</span>LEN <span style="color:#f92672">*</span> 2<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>FIX_STRING<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>UtilAll<span style="color:#f92672">.</span><span style="color:#a6e22e">bytes2string</span><span style="color:#f92672">(</span>createUniqIDBuffer<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> sb<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>唯一键是根据客户端的<strong>进程 ID</strong>、<strong>IP 地址</strong>、<strong>ClassLoader 哈希码</strong>、<strong>时间戳</strong>、<strong>计数器</strong>这几个值来生成的一个唯一的键，然后作为这条消息的附属属性发送到 Broker 服务器的:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageClientIDSetter</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setUniqID</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Message msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">putProperty</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span style="color:#f92672">,</span> createUniqID<span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="2-索引键">(2) 索引键</h3>
<p>当服务器收到客户端发送过来的消息之后，索引服务便会取出客户端生成的 <code>uniqKey</code> 并为之建立索引，放入到索引文件中:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IndexService</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">buildIndex</span><span style="color:#f92672">(</span>DispatchRequest req<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>req<span style="color:#f92672">.</span><span style="color:#a6e22e">getUniqKey</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            indexFile <span style="color:#f92672">=</span> putKey<span style="color:#f92672">(</span>indexFile<span style="color:#f92672">,</span> msg<span style="color:#f92672">,</span> buildKey<span style="color:#f92672">(</span>topic<span style="color:#f92672">,</span> req<span style="color:#f92672">.</span><span style="color:#a6e22e">getUniqKey</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="3-使用键查询">(3) 使用键查询</h3>
<p>客户端在生成消息唯一键的时候，在 <code>ByteBuffer</code> 的第 11 位到第 14 位放置的是<strong>当前的时间与当月第一天</strong>的时间的毫秒差:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageClientIDSetter</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span><span style="color:#f92672">]</span> <span style="color:#a6e22e">createUniqIDBuffer</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> current <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>current <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> nextStartTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            setStartTime<span style="color:#f92672">(</span>current<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// 时间差 [当前时间 - 这个月 1 号的时间]
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// putInt 占据的是第 11 位到第 14 位
</span><span style="color:#75715e"></span>        buffer<span style="color:#f92672">.</span><span style="color:#a6e22e">putInt</span><span style="color:#f92672">(</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">-</span> startTime<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setStartTime</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> millis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Calendar cal <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">setTimeInMillis</span><span style="color:#f92672">(</span>millis<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">DAY_OF_MONTH</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">HOUR_OF_DAY</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MINUTE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">SECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 开始时间设置为这个月的 1 号
</span><span style="color:#75715e"></span>        startTime <span style="color:#f92672">=</span> cal<span style="color:#f92672">.</span><span style="color:#a6e22e">getTimeInMillis</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>我们知道<strong>消息索引</strong>服务的查询需要用户传入 <code>begin</code> 和 <code>end</code> 这连个时间值，以进行这段时间内的匹配。所以 RocketMQ 为了加速消息的查询，于是在 Admin 端对特定 ID 进行查询的时候，首先取出了这段<strong>时间差值</strong>，然后与当月时间进行相加得到 <code>begin</code> 时间值:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageClientIDSetter</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Date <span style="color:#a6e22e">getNearlyTimeFromID</span><span style="color:#f92672">(</span>String msgID<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ByteBuffer buf <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>8<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span><span style="color:#f92672">]</span> bytes <span style="color:#f92672">=</span> UtilAll<span style="color:#f92672">.</span><span style="color:#a6e22e">string2bytes</span><span style="color:#f92672">(</span>msgID<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        buf<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">)</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        buf<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">)</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        buf<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">)</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        buf<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">)</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 取出第 11 位到 14 位
</span><span style="color:#75715e"></span>        buf<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>bytes<span style="color:#f92672">,</span> 10<span style="color:#f92672">,</span> 4<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        
        buf<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">(</span>0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 得到时间差值
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">long</span> spanMS <span style="color:#f92672">=</span> buf<span style="color:#f92672">.</span><span style="color:#a6e22e">getLong</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        
        Calendar cal <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> now <span style="color:#f92672">=</span> cal<span style="color:#f92672">.</span><span style="color:#a6e22e">getTimeInMillis</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">DAY_OF_MONTH</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">HOUR_OF_DAY</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MINUTE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">SECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> monStartTime <span style="color:#f92672">=</span> cal<span style="color:#f92672">.</span><span style="color:#a6e22e">getTimeInMillis</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>monStartTime <span style="color:#f92672">+</span> spanMS <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> now<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            cal<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MONTH</span><span style="color:#f92672">,</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            monStartTime <span style="color:#f92672">=</span> cal<span style="color:#f92672">.</span><span style="color:#a6e22e">getTimeInMillis</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// 设置为这个月(或者上个月) + 时间差值
</span><span style="color:#75715e"></span>        cal<span style="color:#f92672">.</span><span style="color:#a6e22e">setTimeInMillis</span><span style="color:#f92672">(</span>monStartTime <span style="color:#f92672">+</span> spanMS<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> cal<span style="color:#f92672">.</span><span style="color:#a6e22e">getTime</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>由于发送消息的客户端和查询消息的 Admin 端可能不在一台服务器上，而且从函数的命名 <code>getNearlyTimeFromID</code> 与上述实现来看，Admin 端的时间戳得到的是一个近似起始值，它尽可能地加速用户的查询。而且太旧的消息(超过一个月的消息)是查询不到的。</p>
<p>当 <code>begin</code> 时间戳确定以后，Admin 便会将其它必要的信息如<strong>话题</strong>、<strong>Key</strong>等信息封装到 <code>QUERY_MESSAGE</code> 的包中，然后向 Broker 服务器传递这个请求，来进行消息的查询。Broker 服务器在获取到这个查询消息的请求后，便会根据 <code>Key</code> 从索引文件中查询符合的消息，最终返回到 Admin 端。</p>
<h2 id="六键查询消息">六、键查询消息</h2>
<h3 id="1-构建键-1">(1) 构建键</h3>
<p>我们提到过，在发送消息的时候，可以填充一个 <code>keys</code> 的值，这个值将会作为消息的一个属性被发送到 Broker 服务器上:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Message</span> <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setKeys</span><span style="color:#f92672">(</span>String keys<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putProperty</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_KEYS</span><span style="color:#f92672">,</span> keys<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="2-索引键-1">(2) 索引键</h3>
<p>当服务器收到客户端发送过来的消息之后，索引服务便会取出这条消息的 <code>keys</code> 并将其用<strong>空格</strong>进行分割，分割后的每一个字符串都会作为一个单独的<strong>键</strong>，创建索引，放入到索引文件中:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IndexService</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">buildIndex</span><span style="color:#f92672">(</span>DispatchRequest req<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>keys <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> keys<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 使用空格进行分割
</span><span style="color:#75715e"></span>            String<span style="color:#f92672">[</span><span style="color:#f92672">]</span> keyset <span style="color:#f92672">=</span> keys<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">KEY_SEPARATOR</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> keyset<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                String key <span style="color:#f92672">=</span> keyset<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    indexFile <span style="color:#f92672">=</span> putKey<span style="color:#f92672">(</span>indexFile<span style="color:#f92672">,</span> msg<span style="color:#f92672">,</span> buildKey<span style="color:#f92672">(</span>topic<span style="color:#f92672">,</span> key<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>由此我们也可以得知，<code>keys</code> 键的设置通过使用空格分割字符串，一条消息可以指定多个键。</p>
<h3 id="3-使用键查询-1">(3) 使用键查询</h3>
<p><code>keys</code> 键查询的方式也是通过将参数封装为 <code>QUERY_MESSAGE</code> 请求包中去请求服务器返回相应的信息。由于键本身不能和时间戳相关联，因此 <code>begin</code> 值设置的是 0，这是和第五节的不同之处:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">QueryMsgByKeySubCommand</span> <span style="color:#66d9ef">implements</span> SubCommand <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">queryByKey</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> DefaultMQAdminExt admin<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String topic<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String key<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> MQClientException<span style="color:#f92672">,</span> InterruptedException <span style="color:#f92672">{</span>
        <span style="color:#75715e">// begin: 0
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// end: Long.MAX_VALUE
</span><span style="color:#75715e"></span>        QueryResult queryResult <span style="color:#f92672">=</span> admin<span style="color:#f92672">.</span><span style="color:#a6e22e">queryMessage</span><span style="color:#f92672">(</span>topic<span style="color:#f92672">,</span> key<span style="color:#f92672">,</span> 64<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div></article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">

</div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#一消息查询方式">一、消息查询方式</a>
      <ul>
        <li><a href="#1-根据键查询消息">(1) 根据键查询消息</a></li>
        <li><a href="#2-根据id偏移量查询消息">(2) 根据ID(偏移量)查询消息</a></li>
        <li><a href="#3-根据唯一键查询消息">(3) 根据唯一键查询消息</a></li>
        <li><a href="#4-根据消息队列偏移量查询消息">(4) 根据消息队列偏移量查询消息</a></li>
      </ul>
    </li>
    <li><a href="#二id-偏移量-查询">二、ID (偏移量) 查询</a>
      <ul>
        <li><a href="#1-生成-id">(1) 生成 ID</a></li>
        <li><a href="#2-使用-id-查询">(2) 使用 ID 查询</a></li>
      </ul>
    </li>
    <li><a href="#三消息队列偏移量查询">三、消息队列偏移量查询</a></li>
    <li><a href="#四消息索引服务">四、消息索引服务</a>
      <ul>
        <li><a href="#1-索引文件结构">(1) 索引文件结构</a></li>
        <li><a href="#2-添加消息">(2) 添加消息</a></li>
        <li><a href="#3-查询消息">(3) 查询消息</a></li>
      </ul>
    </li>
    <li><a href="#五唯一键查询消息">五、唯一键查询消息</a>
      <ul>
        <li><a href="#1-构建键">(1) 构建键</a></li>
        <li><a href="#2-索引键">(2) 索引键</a></li>
        <li><a href="#3-使用键查询">(3) 使用键查询</a></li>
      </ul>
    </li>
    <li><a href="#六键查询消息">六、键查询消息</a>
      <ul>
        <li><a href="#1-构建键-1">(1) 构建键</a></li>
        <li><a href="#2-索引键-1">(2) 索引键</a></li>
        <li><a href="#3-使用键查询-1">(3) 使用键查询</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

<footer style="width: 100%; position: fixed; bottom:0; height: 40px; padding-top: 10px; background-color:#fafafa; text-align: center">
  <a style="color: #bbb; font-size: 12px;" href="http://www.beian.miit.gov.cn" target="_blank">京ICP备17006948号</href>
</footer>

</html>












