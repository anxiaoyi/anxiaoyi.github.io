<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="RocketMQ ä¸»å¤‡åŒæ­¥"><meta property="og:title" content="RocketMQ ä¸»å¤‡åŒæ­¥" />
<meta property="og:description" content="RocketMQ ä¸»å¤‡åŒæ­¥ ä»‹ç» RocketMQ çš„ä¸»å¤‡åŒæ­¥æœºåˆ¶
ä¸€ã€ç®€ä»‹ RocketMQ é€šè¿‡ Master-Slave ä¸»å¤‡æœºåˆ¶ï¼Œæ¥å®ç°æ•´ä¸ªç³»ç»Ÿçš„é«˜å¯ç”¨ï¼Œå…·ä½“è¡¨ç°åœ¨:
 Master ç£ç›˜åæ‰ï¼ŒSlave ä¾ç„¶ä¿å­˜äº†ä¸€ä»½ Master å®•æœºï¼Œä¸å½±å“æ¶ˆè´¹è€…ç»§ç»­æ¶ˆè´¹  äºŒã€æ­å»ºç¯å¢ƒ æˆ‘ä»¬åœ¨ä¸€å°æœºå™¨ä¸Šæ­å»ºä¸€ä¸ª Master ä¸€ä¸ª Slave çš„ç¯å¢ƒ:
ä¸ºäº†èƒ½å¤Ÿå°† Master å’Œ Slave æ­å»ºåœ¨åŒä¸€å°è®¡ç®—æœºä¸Šï¼Œæˆ‘ä»¬é™¤äº†éœ€è¦å°† Broker çš„è§’è‰²è®¾ç½®ä¸º SLAVE ï¼Œè¿˜éœ€è¦ä¸ºå…¶æŒ‡å®šå•ç‹¬çš„ brokerIdã€ storePathRootDirã€ storePathCommitLogã€‚
// SLAVE è§’è‰² messageStoreConfig.setBrokerRole(BrokerRole.SLAVE); // ä¸€ä¸ªæœºå™¨å¦‚æœè¦å¯åŠ¨å¤šä¸ª Brokerï¼Œé‚£ä¹ˆæ¯ä¸ª Broker çš„ store æ ¹ç›®å½•å¿…é¡»ä¸åŒ messageStoreConfig.setStorePathRootDir(storePathRootDir); // ä¸€ä¸ªæœºå™¨å¦‚æœè¦å¯åŠ¨å¤šä¸ª Brokerï¼Œé‚£ä¹ˆæ¯ä¸ª Broker çš„ storePathCommitLog æ ¹ç›®å½•å¿…é¡»ä¸åŒ messageStoreConfig.setStorePathCommitLog(storePathCommitLog); // è®¾ç½® Slave çš„ Master HA åœ°å€ messageStoreConfig.setHaMasterAddress(&#34;localhost:10912&#34;); // SLAVE è§’è‰²çš„ brokerId å¿…é¡»å¤§äº 0 brokerConfig.setBrokerId(1); æ³¨æ„ Slave å’Œ Master çš„ brokerName å¿…é¡»ä¸€è‡´ï¼Œå³å®ƒä»¬å¿…é¡»å¤„äºåŒä¸€ä¸ª BrokerData æ•°æ®ç»“æ„é‡Œé¢ã€‚å®é™…ä¸Šåœ¨åšäº†å¦‚ä¸Šçš„ä¿®æ”¹ä¹‹åï¼Œ Slave å’Œ Master ä¾æ—§ä¸èƒ½åŒæ—¶è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå› ä¸º Slave æœ¬èº«ä¹Ÿå¯ä»¥ç§°ä¸º Masterï¼Œæ¥å—æ¥è‡ªå…¶ä»– Slave çš„è¯·æ±‚ï¼Œå› æ­¤å½“è¿è¡Œ Slave çš„æ—¶å€™ï¼Œéœ€è¦å°† HAService é‡Œé¢çš„å¯åŠ¨ AcceptSocketService è¿è¡Œçš„ç›¸å…³æ–¹æ³•æ³¨é‡Šæ‰ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/rocketmq/rocketmq-master-slave-sync/" />

<title>RocketMQ ä¸»å¤‡åŒæ­¥ | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.a04069c4ba149e24630fa6fbc98cd4da6e386beb4688b0aae5809dbb5660cd77.css" integrity="sha256-oEBpxLoUniRjD6b7yYzU2m44a&#43;tGiLCq5YCdu1ZgzXc=">


<script defer src="/en.search.min.cd1b5e5e5fd143b5ff81c1931d8dffbf1312415faa0dbdf2cf9c0250dc47e7a4.js" integrity="sha256-zRteXl/RQ7X/gcGTHY3/vxMSQV&#43;qDb3yz5wCUNxH56Q="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      ğŸ‘‰æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-send-message-flow/" >
      RocketMQ æ¶ˆæ¯å‘é€æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-store-flow/" >
      RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-receive-flow/" >
      RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-filter-flow/" >
      RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-indexing-flow/" >
      RocketMQ æ¶ˆæ¯ç´¢å¼•æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-timing-message-and-retry-message/" >
      RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-master-slave-sync/"  class="active">
      RocketMQ ä¸»å¤‡åŒæ­¥
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>RocketMQ ä¸»å¤‡åŒæ­¥</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</a></li>
    <li><a href="#äºŒæ­å»ºç¯å¢ƒ">äºŒã€æ­å»ºç¯å¢ƒ</a></li>
    <li><a href="#ä¸‰å»ºç«‹è¿æ¥">ä¸‰ã€å»ºç«‹è¿æ¥</a></li>
    <li><a href="#å››æ•°æ®ä¼ è¾“">å››ã€æ•°æ®ä¼ è¾“</a>
      <ul>
        <li><a href="#1-æ¶ˆæ¯å¼‚æ­¥ä¼ è¾“">(1) æ¶ˆæ¯å¼‚æ­¥ä¼ è¾“</a></li>
        <li><a href="#2-æ¶ˆæ¯åŒæ­¥ä¼ è¾“">(2) æ¶ˆæ¯åŒæ­¥ä¼ è¾“</a></li>
      </ul>
    </li>
    <li><a href="#äº”ä¸»å¤‡æ¶ˆè´¹">äº”ã€ä¸»å¤‡æ¶ˆè´¹</a></li>
    <li><a href="#å…­æ¶ˆè´¹å»ºè®®">å…­ã€æ¶ˆè´¹å»ºè®®</a></li>
    <li><a href="#ä¸ƒå¼‚å¸¸å¤„ç†">ä¸ƒã€å¼‚å¸¸å¤„ç†</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown"><h1 id="rocketmq-ä¸»å¤‡åŒæ­¥">RocketMQ ä¸»å¤‡åŒæ­¥</h1>
<p>ä»‹ç» RocketMQ çš„ä¸»å¤‡åŒæ­¥æœºåˆ¶</p>
<h2 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</h2>
<p>RocketMQ é€šè¿‡ Master-Slave ä¸»å¤‡æœºåˆ¶ï¼Œæ¥å®ç°æ•´ä¸ªç³»ç»Ÿçš„é«˜å¯ç”¨ï¼Œå…·ä½“è¡¨ç°åœ¨:</p>
<ul>
<li>Master ç£ç›˜åæ‰ï¼ŒSlave ä¾ç„¶ä¿å­˜äº†ä¸€ä»½</li>
<li>Master å®•æœºï¼Œä¸å½±å“æ¶ˆè´¹è€…ç»§ç»­æ¶ˆè´¹</li>
</ul>
<h2 id="äºŒæ­å»ºç¯å¢ƒ">äºŒã€æ­å»ºç¯å¢ƒ</h2>
<p>æˆ‘ä»¬åœ¨ä¸€å°æœºå™¨ä¸Šæ­å»ºä¸€ä¸ª Master ä¸€ä¸ª Slave çš„ç¯å¢ƒ:</p>
<p><img src="/images/docs/rocketmq/rocketmq-master-slave-sync/master_slave_sync_architecture.png" alt="ä¸»å¤‡æ¶æ„"></p>
<p>ä¸ºäº†èƒ½å¤Ÿå°† Master å’Œ Slave æ­å»ºåœ¨åŒä¸€å°è®¡ç®—æœºä¸Šï¼Œæˆ‘ä»¬é™¤äº†éœ€è¦å°† Broker çš„è§’è‰²è®¾ç½®ä¸º <code>SLAVE</code> ï¼Œè¿˜éœ€è¦ä¸ºå…¶æŒ‡å®šå•ç‹¬çš„ <code>brokerId</code>ã€ <code>storePathRootDir</code>ã€ <code>storePathCommitLog</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// SLAVE è§’è‰²
</span><span style="color:#75715e"></span>messageStoreConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">setBrokerRole</span><span style="color:#f92672">(</span>BrokerRole<span style="color:#f92672">.</span><span style="color:#a6e22e">SLAVE</span><span style="color:#f92672">);</span>

<span style="color:#75715e">// ä¸€ä¸ªæœºå™¨å¦‚æœè¦å¯åŠ¨å¤šä¸ª Brokerï¼Œé‚£ä¹ˆæ¯ä¸ª Broker çš„ store æ ¹ç›®å½•å¿…é¡»ä¸åŒ
</span><span style="color:#75715e"></span>messageStoreConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">setStorePathRootDir</span><span style="color:#f92672">(</span>storePathRootDir<span style="color:#f92672">);</span>
<span style="color:#75715e">// ä¸€ä¸ªæœºå™¨å¦‚æœè¦å¯åŠ¨å¤šä¸ª Brokerï¼Œé‚£ä¹ˆæ¯ä¸ª Broker çš„ storePathCommitLog æ ¹ç›®å½•å¿…é¡»ä¸åŒ
</span><span style="color:#75715e"></span>messageStoreConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">setStorePathCommitLog</span><span style="color:#f92672">(</span>storePathCommitLog<span style="color:#f92672">);</span>
<span style="color:#75715e">// è®¾ç½® Slave çš„ Master HA åœ°å€
</span><span style="color:#75715e"></span>messageStoreConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">setHaMasterAddress</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;localhost:10912&#34;</span><span style="color:#f92672">);</span>

<span style="color:#75715e">// SLAVE è§’è‰²çš„ brokerId å¿…é¡»å¤§äº 0
</span><span style="color:#75715e"></span>brokerConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">setBrokerId</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
</code></pre></div><p>æ³¨æ„ Slave å’Œ Master çš„ <code>brokerName</code> å¿…é¡»ä¸€è‡´ï¼Œå³å®ƒä»¬å¿…é¡»å¤„äºåŒä¸€ä¸ª <code>BrokerData</code> æ•°æ®ç»“æ„é‡Œé¢ã€‚å®é™…ä¸Šåœ¨åšäº†å¦‚ä¸Šçš„ä¿®æ”¹ä¹‹åï¼Œ Slave å’Œ Master ä¾æ—§ä¸èƒ½åŒæ—¶è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå› ä¸º Slave æœ¬èº«ä¹Ÿå¯ä»¥ç§°ä¸º Masterï¼Œæ¥å—æ¥è‡ªå…¶ä»– Slave çš„è¯·æ±‚ï¼Œå› æ­¤å½“è¿è¡Œ Slave çš„æ—¶å€™ï¼Œéœ€è¦å°† <code>HAService</code> é‡Œé¢çš„å¯åŠ¨ <code>AcceptSocketService</code> è¿è¡Œçš„ç›¸å…³æ–¹æ³•æ³¨é‡Šæ‰ã€‚</p>
<h2 id="ä¸‰å»ºç«‹è¿æ¥">ä¸‰ã€å»ºç«‹è¿æ¥</h2>
<p>å½“ä¸€ä¸ª Broker åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ <code>HAService</code> çš„ <code>start()</code> æ–¹æ³•:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HAService</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">acceptSocketService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beginAccept</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">acceptSocketService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">groupTransferService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">haClient</span><span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><code>AcceptSocketService</code> æœåŠ¡çš„åŠŸèƒ½æ˜¯ Master ç­‰å¾…æ¥å—æ¥è‡ªå…¶å®ƒå®¢æˆ·ç«¯ Slave çš„è¿æ¥ï¼Œå½“æˆåŠŸå»ºç«‹è¿æ¥åï¼Œä¼šå°†è¿™æ¡è¿æ¥ <code>HAConnection</code> æ”¾å…¥åˆ° <code>connectionList</code> è¿æ¥åˆ—è¡¨é‡Œé¢ã€‚è€Œ <code>HAClient</code> æœåŠ¡çš„åŠŸèƒ½æ˜¯ Slave ä¸»åŠ¨å‘èµ·åŒå…¶å®ƒ Master çš„è¿æ¥ã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-master-slave-sync/master-slave-build-connections.png" alt="ä¸»å¤‡å»ºç«‹è¿æ¥"></p>
<h2 id="å››æ•°æ®ä¼ è¾“">å››ã€æ•°æ®ä¼ è¾“</h2>
<p>å½“å¯åŠ¨ <code>HAService</code> ä¹‹åï¼Œä¸€æ—¦ Master å‘ç°å’Œ Slave ä¸åŒæ­¥ï¼Œé‚£ä¹ˆMaster ä¼šè‡ªåŠ¨å¼€å§‹åŒæ­¥æ¶ˆæ¯åˆ° Slaveï¼Œæ— éœ€å…¶å®ƒçš„è§¦å‘æœºåˆ¶ã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-master-slave-sync/master-slave-sync-data.png" alt="ä¸»å¤‡æ•°æ®ä¼ è¾“"></p>
<h3 id="1-æ¶ˆæ¯å¼‚æ­¥ä¼ è¾“">(1) æ¶ˆæ¯å¼‚æ­¥ä¼ è¾“</h3>
<p>å¦‚æœ Master Broker çš„è§’è‰²æ˜¯ <code>ASYNC_MASTER</code>ï¼Œé‚£ä¹ˆæ¶ˆæ¯ç­‰å¾…ä» Master åŒæ­¥åˆ° Slave çš„æ–¹å¼æ˜¯<strong>å¼‚æ­¥ä¼ è¾“</strong>çš„æ–¹å¼ã€‚è¿™æ„å‘³å½“ä¸€æ¡æ¶ˆæ¯å‘é€åˆ° Master Broker çš„æ—¶å€™ï¼ŒMaster Broker åœ¨å­˜å‚¨å®Œè¿™æ¡æ¶ˆæ¯åˆ°æœ¬åœ°ä¹‹åï¼Œå¹¶ä¸ä¼šç­‰å¾…æ¶ˆæ¯åŒæ­¥åˆ° Slave Broker æ‰è¿”å›ã€‚è¿™ç§æ–¹å¼ä¼šç¼©çŸ­å‘é€æ¶ˆæ¯çš„å“åº”æ—¶é—´ã€‚</p>
<h3 id="2-æ¶ˆæ¯åŒæ­¥ä¼ è¾“">(2) æ¶ˆæ¯åŒæ­¥ä¼ è¾“</h3>
<p>å¦‚æœ Master Broker çš„è§’è‰²æ˜¯ <code>SYNC_MASTER</code>ï¼Œé‚£ä¹ˆæ¶ˆæ¯ç­‰å¾…ä» Master åŒæ­¥åˆ° Slave çš„æ–¹å¼æ˜¯<strong>åŒæ­¥ä¼ è¾“</strong>çš„æ–¹å¼ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿›å…¥åŒæ­¥æ–¹å¼è¿˜å¾—æ»¡è¶³å¦å¤–ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>æ¶ˆæ¯ä½“çš„ <code>PROPERTY_WAIT_STORE_MSG_OK</code> å±æ€§å€¼ä¸º <code>true</code>ï¼Œå³è¿™æ¡æ¶ˆæ¯å…è®¸ç­‰å¾…</li>
<li>Slave ç›¸æ¯” Master è½ä¸‹çš„åŒæ­¥è¿›åº¦ä¸èƒ½è¶…è¿‡ 256MB</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLog</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleHA</span><span style="color:#f92672">(</span>AppendMessageResult result<span style="color:#f92672">,</span> PutMessageResult putMessageResult<span style="color:#f92672">,</span> MessageExt messageExt<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>BrokerRole<span style="color:#f92672">.</span><span style="color:#a6e22e">SYNC_MASTER</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStoreConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getBrokerRole</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            HAService service <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getHaService</span><span style="color:#f92672">();</span>

            <span style="color:#75715e">// æ¶ˆæ¯æ˜¯å¦å…è®¸ç­‰å¾…åŒæ­¥
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>messageExt<span style="color:#f92672">.</span><span style="color:#a6e22e">isWaitStoreMsgOK</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                
                <span style="color:#75715e">// Slave æ˜¯å¦æ²¡æœ‰è½ä¸‹ Master å¤ªå¤š
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>service<span style="color:#f92672">.</span><span style="color:#a6e22e">isSlaveOK</span><span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getWroteOffset</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">getWroteBytes</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// ç­‰å¾…åŒæ­¥å®Œæˆ
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span>
                
                <span style="color:#75715e">// Slave problem
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// Tell the producer, slave not available
</span><span style="color:#75715e"></span>                    putMessageResult<span style="color:#f92672">.</span><span style="color:#a6e22e">setPutMessageStatus</span><span style="color:#f92672">(</span>PutMessageStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">SLAVE_NOT_AVAILABLE</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å…¶ä¸­ <code>isSlaveOK</code> æ–¹æ³•å°±æ˜¯ç”¨æ¥æ£€æµ‹ Slave å’Œ Master è½ä¸‹çš„åŒæ­¥è¿›åº¦æ˜¯å¦å¤ªå¤§çš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HAService</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isSlaveOK</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> masterPutWhere<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">boolean</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">connectionCount</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">;</span>

        result <span style="color:#f92672">=</span>
            result

            <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">((</span>masterPutWhere <span style="color:#f92672">-</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">push2SlaveMaxOffset</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">())</span> <span style="color:#f92672">&lt;</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStoreConfig</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">getHaSlaveFallbehindMax</span><span style="color:#f92672">());</span> <span style="color:#75715e">// é»˜è®¤ 256 * 1024 * 1024 = 256 MB
</span><span style="color:#75715e"></span>        
        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å¦‚æœä¸Šé¢ä¸¤ä¸ªæ¡ä»¶ä¸æ»¡è¶³çš„è¯ï¼Œé‚£ä¹ˆ Master ä¾¿ä¸ä¼šå†ç­‰å¾…æ¶ˆæ¯åŒæ­¥åˆ° Slave ä¹‹åå†è¿”å›ï¼Œèƒ½å°½æ—©è¿”å›ä¾¿å°½æ—©è¿”å›äº†ã€‚</p>
<p>æ¶ˆæ¯ç­‰å¾…æ˜¯å¦åŒæ­¥åˆ° Slave æ˜¯å€ŸåŠ© <code>CountDownLatch</code> æ¥å®ç°çš„ã€‚å½“æ¶ˆæ¯éœ€è¦ç­‰å¾…çš„æ—¶å€™ï¼Œä¾¿ä¼šæ„å»ºä¸€ä¸ª <code>GroupCommitRequest</code> ï¼Œæ¯ä¸ªè¯·æ±‚åœ¨å…¶å†…éƒ¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ª <code>CountDownLatch</code> ï¼Œç„¶åé€šè¿‡è°ƒç”¨ <code>await(timeout)</code> æ–¹æ³•æ¥ç­‰å¾…æ¶ˆæ¯åŒæ­¥åˆ° Slave ä¹‹åï¼Œæˆ–è€…è¶…æ—¶ä¹‹åè‡ªåŠ¨è¿”å›ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GroupCommitRequest</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> CountDownLatch countDownLatch <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CountDownLatch<span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">wakeupCustomer</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> flushOK<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flushOK</span> <span style="color:#f92672">=</span> flushOK<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">countDownLatch</span><span style="color:#f92672">.</span><span style="color:#a6e22e">countDown</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">waitForFlush</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> timeout<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">countDownLatch</span><span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">(</span>timeout<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flushOK</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Interrupted&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æˆ‘ä»¬å†é‡ç‚¹æ¥çœ‹å‡ ä¸ªå¾ªç¯ä½“å’Œå”¤é†’ç‚¹:</p>
<ul>
<li><code>GroupTransferService</code> æœåŠ¡çš„<strong>æ˜¯å¦å¤„ç†è¯·æ±‚</strong>çš„å¾ªç¯ä½“å’Œå”¤é†’ç‚¹:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GroupTransferService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">putRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> CommitLog<span style="color:#f92672">.</span><span style="color:#a6e22e">GroupCommitRequest</span> request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ”¾å…¥è¯·æ±‚ï¼Œå”¤é†’
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasNotified<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            waitPoint<span style="color:#f92672">.</span><span style="color:#a6e22e">countDown</span><span style="color:#f92672">();</span> <span style="color:#75715e">// notify
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¾ªç¯ä½“
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isStopped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// putRequest ä¼šæå‰å”¤é†’è¿™å¥è¯
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">waitForRunning</span><span style="color:#f92672">(</span>10<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">doWaitTransfer</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getServiceName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; service has exception. &#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li><code>HAConnection</code> çš„<strong>æ˜¯å¦è¿›è¡Œæ¶ˆæ¯ä¼ è¾“</strong>çš„å¾ªç¯ä½“å’Œå”¤é†’ç‚¹ï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WriteSocketService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å¾ªç¯ä½“
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isStopped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            SelectMappedBufferResult selectResult <span style="color:#f92672">=</span>
                HAConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">haService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDefaultMessageStore</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getCommitLogData</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nextTransferFromWhere</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>selectResult <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ä¼ è¾“ï¼ˆå†™å…¥ï¼‰æ¶ˆæ¯
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ç­‰å¾… 100 æ¯«ç§’æˆ–è€…æå‰è¢«å”¤é†’
</span><span style="color:#75715e"></span>                HAConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">haService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getWaitNotifyObject</span><span style="color:#f92672">().</span><span style="color:#a6e22e">allWaitForRunning</span><span style="color:#f92672">(</span>100<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLog</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleHA</span><span style="color:#f92672">(</span>AppendMessageResult result<span style="color:#f92672">,</span>
                         PutMessageResult putMessageResult<span style="color:#f92672">,</span>
                         MessageExt messageExt<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        GroupCommitRequest request <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> GroupCommitRequest<span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getWroteOffset</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span>
                                   result<span style="color:#f92672">.</span><span style="color:#a6e22e">getWroteBytes</span><span style="color:#f92672">());</span>
        service<span style="color:#f92672">.</span><span style="color:#a6e22e">putRequest</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
        <span style="color:#75715e">// æå‰å”¤é†’ WriteSocketService
</span><span style="color:#75715e"></span>        service<span style="color:#f92672">.</span><span style="color:#a6e22e">getWaitNotifyObject</span><span style="color:#f92672">().</span><span style="color:#a6e22e">wakeupAll</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>Slave æ±‡æŠ¥è¿›åº¦å”¤é†’ <code>GroupTransferService</code>ï¼Œ ç­‰å¾…åŒæ­¥å®Œæˆå”¤é†’ <code>GroupCommitRequest</code> çš„ <code>CountDownLatch</code>:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReadSocketService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">processReadEvent</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å”¤é†’ GroupTransferService
</span><span style="color:#75715e"></span>        HAConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">haService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">notifyTransferSome</span><span style="color:#f92672">(</span>HAConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">slaveAckOffset</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GroupTransferService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#75715e">// è¢«å”¤é†’
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">notifyTransferSome</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">notifyTransferObject</span><span style="color:#f92672">.</span><span style="color:#a6e22e">wakeup</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doWaitTransfer</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>CommitLog<span style="color:#f92672">.</span><span style="color:#a6e22e">GroupCommitRequest</span> req <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requestsRead</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">boolean</span> transferOK <span style="color:#f92672">=</span> HAService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">push2SlaveMaxOffset</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> req<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextOffset</span><span style="color:#f92672">();</span>

            <span style="color:#75715e">// 5 æ¬¡é‡è¯•
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> <span style="color:#f92672">!</span>transferOK <span style="color:#f92672">&amp;&amp;</span> i <span style="color:#f92672">&lt;</span> 5<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ç­‰å¾…è¢«å”¤é†’æˆ–è€…è¶…æ—¶
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">notifyTransferObject</span><span style="color:#f92672">.</span><span style="color:#a6e22e">waitForRunning</span><span style="color:#f92672">(</span>1000<span style="color:#f92672">);</span>
                transferOK <span style="color:#f92672">=</span> HAService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">push2SlaveMaxOffset</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> req<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextOffset</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// å”¤é†’ GroupCommitRequest çš„ CountDownLatch
</span><span style="color:#75715e"></span>            req<span style="color:#f92672">.</span><span style="color:#a6e22e">wakeupCustomer</span><span style="color:#f92672">(</span>transferOK<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GroupCommitRequest</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">// è¢«å”¤é†’
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">wakeupCustomer</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> flushOK<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flushOK</span> <span style="color:#f92672">=</span> flushOK<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">countDownLatch</span><span style="color:#f92672">.</span><span style="color:#a6e22e">countDown</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸‹å›¾æ˜¯ä¸Šå›¾ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯<strong>å”¤é†’é“¾</strong>:</p>
<p><img src="/images/docs/rocketmq/rocketmq-master-slave-sync/wait-notify-sync.png" alt="å”¤é†’é“¾"></p>
<h2 id="äº”ä¸»å¤‡æ¶ˆè´¹">äº”ã€ä¸»å¤‡æ¶ˆè´¹</h2>
<p>å½“æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹çš„æ—¶å€™ï¼Œå¦‚æœ Master çªç„¶å®•æœºï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ° Slave æœºå™¨ä¸Šç»§ç»­è¿›è¡Œæ¶ˆè´¹ã€‚</p>
<h2 id="å…­æ¶ˆè´¹å»ºè®®">å…­ã€æ¶ˆè´¹å»ºè®®</h2>
<p>RocketMQ æä¾›äº†è‡ªåŠ¨ä» Slave è¯»å–è€æ•°æ®çš„åŠŸèƒ½ã€‚è¿™ä¸ªåŠŸèƒ½ä¸»è¦ç”± <code>slaveReadEnable</code> è¿™ä¸ªå‚æ•°æ§åˆ¶ã€‚é»˜è®¤æ˜¯å…³çš„ï¼ˆ<code>slaveReadEnable = false</code>ï¼‰ã€‚æ¨èæŠŠå®ƒæ‰“å¼€ï¼Œä¸»ä»éƒ½è¦å¼€ã€‚è¿™ä¸ªå‚æ•°æ‰“å¼€ä¹‹åï¼Œåœ¨å®¢æˆ·ç«¯æ¶ˆè´¹æ•°æ®æ—¶ï¼Œä¼šåˆ¤æ–­ï¼Œå½“å‰è¯»å–æ¶ˆæ¯çš„ç‰©ç†åç§»é‡è·Ÿæœ€æ–°çš„ä½ç½®çš„å·®å€¼ï¼Œæ˜¯ä¸æ˜¯è¶…è¿‡äº†å†…å­˜å®¹é‡çš„ä¸€ä¸ªç™¾åˆ†æ¯”ï¼ˆ<code>accessMessageInMemoryMaxRatio = 40</code> by defaultï¼‰ã€‚å¦‚æœè¶…è¿‡äº†ï¼Œå°±ä¼šå‘Šè¯‰å®¢æˆ·ç«¯å»å¤‡æœºä¸Šæ¶ˆè´¹æ•°æ®ã€‚å¦‚æœé‡‡ç”¨å¼‚æ­¥ä¸»ä»ï¼Œä¹Ÿå°±æ˜¯ <code>brokerRole</code> ç­‰äº <code>ASYNC_AMSTER</code> çš„æ—¶å€™ï¼Œä½ çš„å¤‡æœº IO æ‰“çˆ†ï¼Œå…¶å®å½±å“ä¸å¤ªå¤§ã€‚ä½†æ˜¯å¦‚æœä½ é‡‡ç”¨åŒæ­¥ä¸»ä»ï¼Œé‚£è¿˜æ˜¯æœ‰å½±å“ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œæœ€å¥½æŒ‚ä¸¤ä¸ªå¤‡æœºã€‚å› ä¸º RocketMQ çš„ä¸»ä»åŒæ­¥å¤åˆ¶ï¼Œåªè¦ä¸€ä¸ªå¤‡æœºå“åº”äº†ç¡®è®¤å†™å…¥å°±å¯ä»¥äº†ï¼Œä¸€å° IO æ‰“çˆ†ï¼Œé—®é¢˜ä¸å¤§ã€‚å‚è€ƒè‡ª<a href="http://jm.taobao.org/2018/11/06/%E6%BB%B4%E6%BB%B4%E5%87%BA%E8%A1%8C%E5%9F%BA%E4%BA%8ERocketMQ%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%AE%9E%E8%B7%B5/">é˜¿é‡Œä¸­é—´ä»¶å›¢é˜Ÿåšå®¢</a>ã€‚</p>
<h2 id="ä¸ƒå¼‚å¸¸å¤„ç†">ä¸ƒã€å¼‚å¸¸å¤„ç†</h2>
<p>Q: Master(Slave) è¯»å–æ¥è‡ª Slave(Master) çš„æ¶ˆæ¯å¼‚å¸¸ (IOExceptionã€ read() è¿”å› -1 ç­‰) çš„æ—¶å€™æ€ä¹ˆå¤„ç†?
A: æ‰“å°æ—¥å¿— + å…³é—­è¿™æ¡è¿æ¥</p>
<p>Q: Master(Slave) é•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°æ¥è‡ª Slave(Master) çš„è¿›åº¦æ±‡æŠ¥æ€ä¹ˆå¤„ç†?
A: æ¯æ¬¡è¯»å–ä¹‹åæ›´æ–° <code>lastReadTimestamp</code> æˆ–è€… <code>lastWriteTimestamp</code>ï¼Œä¸€æ—¦å‘ç°åœ¨ <code>haHousekeepingInterval</code> é—´éš”å†… (é»˜è®¤ 20ç§’) è¿™ä¸ªæ—¶é—´æˆ³éƒ½æ²¡æœ‰æ”¹å˜çš„è¯ï¼Œå…³é—­è¿™æ¡è¿æ¥</p>
<p>Q: Slave æ£€æµ‹åˆ°æ¥è‡ª Master æ±‡æŠ¥çš„æœ¬æ¬¡ä¼ è¾“åç§»é‡å’Œæœ¬åœ°çš„ä¼ è¾“åç§»é‡ä¸åŒæ—¶æ€ä¹ˆå¤„ç†?
A: æ‰“å°æ—¥å¿— + å…³é—­è¿™æ¡è¿æ¥</p>
<p>Q: Master å¦‚ä½•çŸ¥é“ Slave æ˜¯å¦çœŸæ­£çš„å­˜å‚¨äº†åˆšæ‰å‘é€è¿‡å»çš„æ¶ˆæ¯?
A: Slave å­˜å‚¨å®Œæ¯•ä¹‹åï¼Œé€šè¿‡å‘ Master æ±‡æŠ¥è¿›åº¦æ¥å®Œæˆã€‚ç›¸å½“äº TCP çš„ ACK æœºåˆ¶ã€‚</p>
<p>Q: Master å®•æ‰
A: æ— è®º Maser æ˜¯ä¸»åŠ¨å…³é—­ Materï¼Œè¿˜æ˜¯ Master å› ä¸ºå¼‚å¸¸è€Œé€€å‡ºï¼ŒSlave éƒ½ä¼šæ¯éš” 5 ç§’é‡è¿ä¸€æ¬¡ Master</p>
<p>æ‰«æä¸‹é¢äºŒç»´ç ï¼Œåœ¨æ‰‹æœºç«¯é˜…è¯»ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-master-slave-sync/qrcode.png" alt=""></p>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>

  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'Hw2fQnNQyghcgeRvQosC5cIy-gzGzoHsz',
        appKey: '0ULuPWcxGRLCaHz84icXvBgn',
        notify: 'false', 
        verify: 'false', 
        avatar:'mm', 
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆå§...',
        visitor: 'true'
    });
  </script></div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</a></li>
    <li><a href="#äºŒæ­å»ºç¯å¢ƒ">äºŒã€æ­å»ºç¯å¢ƒ</a></li>
    <li><a href="#ä¸‰å»ºç«‹è¿æ¥">ä¸‰ã€å»ºç«‹è¿æ¥</a></li>
    <li><a href="#å››æ•°æ®ä¼ è¾“">å››ã€æ•°æ®ä¼ è¾“</a>
      <ul>
        <li><a href="#1-æ¶ˆæ¯å¼‚æ­¥ä¼ è¾“">(1) æ¶ˆæ¯å¼‚æ­¥ä¼ è¾“</a></li>
        <li><a href="#2-æ¶ˆæ¯åŒæ­¥ä¼ è¾“">(2) æ¶ˆæ¯åŒæ­¥ä¼ è¾“</a></li>
      </ul>
    </li>
    <li><a href="#äº”ä¸»å¤‡æ¶ˆè´¹">äº”ã€ä¸»å¤‡æ¶ˆè´¹</a></li>
    <li><a href="#å…­æ¶ˆè´¹å»ºè®®">å…­ã€æ¶ˆè´¹å»ºè®®</a></li>
    <li><a href="#ä¸ƒå¼‚å¸¸å¤„ç†">ä¸ƒã€å¼‚å¸¸å¤„ç†</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  

  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1279346965'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279346965%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</body>



</html>












