<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹"><meta property="og:title" content="RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹" />
<meta property="og:description" content="RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹  åŸºäº RocketMQ 4.2.0 ç‰ˆæœ¬è¿›è¡Œçš„æºç åˆ†æã€‚
 æœ¬ç¯‡è®²è¿° RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹
ä¸€ã€æ¶ˆè´¹è€…æ³¨å†Œ ç”Ÿäº§è€…è´Ÿè´£å¾€æœåŠ¡å™¨ Broker å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åˆ™ä» Broker è·å–æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…è·å–æ¶ˆæ¯é‡‡ç”¨çš„æ˜¯è®¢é˜…è€…æ¨¡å¼ï¼Œå³æ¶ˆè´¹è€…å®¢æˆ·ç«¯å¯ä»¥ä»»æ„è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¯é¢˜æ¥æ¶ˆè´¹æ¶ˆæ¯:
public class Consumer { public static void main(String[] args) throws InterruptedException, MQClientException { /* * è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¯é¢˜ */ consumer.subscribe(&#34;TopicTest&#34;, &#34;*&#34;); } } å½“æ¶ˆè´¹è€…å®¢æˆ·ç«¯å¯åŠ¨ä»¥åï¼Œå…¶ä¼šæ¯éš” 30 ç§’ä»å‘½åæœåŠ¡å™¨æŸ¥è¯¢ä¸€æ¬¡ç”¨æˆ·è®¢é˜…çš„æ‰€æœ‰è¯é¢˜è·¯ç”±ä¿¡æ¯:
public class MQClientInstance { private void startScheduledTask() { this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() { @Override public void run() { // ä»å‘½åæœåŠ¡å™¨æ‹‰å–è¯é¢˜ä¿¡æ¯  MQClientInstance.this.updateTopicRouteInfoFromNameServer(); } }, 10, this.clientConfig.getPollNameServerInterval(), TimeUnit.MILLISECONDS); } } æˆ‘ä»¬ç”± RocketMQ æ¶ˆæ¯å‘é€æµç¨‹ è¿™ç¯‡æ–‡ç« çŸ¥é“ RocketMQ åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ¯æ¡æ¶ˆæ¯ä¼šä»¥è½®å¾ªçš„æ–¹å¼å‡è¡¡åœ°åˆ†å‘çš„ä¸åŒ Broker çš„ä¸åŒé˜Ÿåˆ—ä¸­å»ã€‚ç”±æ­¤ï¼Œæ¶ˆè´¹è€…å®¢æˆ·ç«¯ä»æœåŠ¡å™¨å‘½åæœåŠ¡å™¨è·å–ä¸‹æ¥çš„ä¾¿æ˜¯è¯é¢˜çš„æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/rocketmq/rocketmq-message-receive-flow/" />

<title>RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹ | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.7ebac727e739c3b4aee6328926e3b77ac1ddd5e9035221b7ec206fda1a413a4d.css" integrity="sha256-frrHJ&#43;c5w7Su5jKJJuO3esHd1ekDUiG37CBv2hpBOk0=">


<script defer src="/en.search.min.3ca8b225182094327479e1b309cdc92719f0c2e3706bb9c15531561c1d4d9eda.js" integrity="sha256-PKiyJRgglDJ0eeGzCc3JJxnwwuNwa7nBVTFWHB1Nnto="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-send-message-flow/" >
      RocketMQ æ¶ˆæ¯å‘é€æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-store-flow/" >
      RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-receive-flow/"  class="active">
      RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-filter-flow/" >
      RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-indexing-flow/" >
      RocketMQ æ¶ˆæ¯ç´¢å¼•æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-timing-message-and-retry-message/" >
      RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-master-slave-sync/" >
      RocketMQ ä¸»å¤‡åŒæ­¥
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-transaction/" >
      RocketMQ äº‹åŠ¡æ¶ˆæ¯
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-acl/" >
      RocketMQ ACL æƒé™æ§åˆ¶
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-logicqueue/" >
      RocketMQ é€»è¾‘é˜Ÿåˆ—
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€æ¶ˆè´¹è€…æ³¨å†Œ">ä¸€ã€æ¶ˆè´¹è€…æ³¨å†Œ</a></li>
    <li><a href="#äºŒæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡">äºŒã€æ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡</a>
      <ul>
        <li><a href="#1-å¹¿æ’­æ¨¡å¼">(1) å¹¿æ’­æ¨¡å¼</a></li>
        <li><a href="#2-é›†ç¾¤æ¨¡å¼">(2) é›†ç¾¤æ¨¡å¼</a></li>
      </ul>
    </li>
    <li><a href="#ä¸‰broker-æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶">ä¸‰ã€Broker æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶</a></li>
    <li><a href="#å››æ¶ˆæ¯é˜Ÿåˆ—åç§»é‡">å››ã€æ¶ˆæ¯é˜Ÿåˆ—åç§»é‡</a>
      <ul>
        <li><a href="#1-é›†ç¾¤æ¨¡å¼">(1) é›†ç¾¤æ¨¡å¼</a></li>
        <li><a href="#2-å¹¿æ’­æ¨¡å¼">(2) å¹¿æ’­æ¨¡å¼</a></li>
      </ul>
    </li>
    <li><a href="#äº”æ‹‰å–æ¶ˆæ¯">äº”ã€æ‹‰å–æ¶ˆæ¯</a></li>
    <li><a href="#å…­æ¶ˆè´¹æ¶ˆæ¯">å…­ã€æ¶ˆè´¹æ¶ˆæ¯</a>
      <ul>
        <li><a href="#1-å¹¶å‘æ¶ˆè´¹">(1) å¹¶å‘æ¶ˆè´¹</a></li>
        <li><a href="#2-æœ‰åºæ¶ˆè´¹">(2) æœ‰åºæ¶ˆè´¹</a></li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script><h1 id="rocketmq-æ¶ˆæ¯æ¥å—æµç¨‹">RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹</h1>
<blockquote>
<p>åŸºäº RocketMQ 4.2.0 ç‰ˆæœ¬è¿›è¡Œçš„æºç åˆ†æã€‚</p>
</blockquote>
<p>æœ¬ç¯‡è®²è¿° RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹</p>
<h2 id="ä¸€æ¶ˆè´¹è€…æ³¨å†Œ">ä¸€ã€æ¶ˆè´¹è€…æ³¨å†Œ</h2>
<p><strong>ç”Ÿäº§è€…</strong>è´Ÿè´£å¾€æœåŠ¡å™¨ Broker å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åˆ™ä» Broker è·å–æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…è·å–æ¶ˆæ¯é‡‡ç”¨çš„æ˜¯<strong>è®¢é˜…è€…æ¨¡å¼</strong>ï¼Œå³æ¶ˆè´¹è€…å®¢æˆ·ç«¯å¯ä»¥ä»»æ„è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¯é¢˜æ¥æ¶ˆè´¹æ¶ˆæ¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Consumer</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">,</span> MQClientException <span style="color:#f92672">{</span>
        <span style="color:#75715e">/*
</span><span style="color:#75715e">         * è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¯é¢˜
</span><span style="color:#75715e">         */</span>
        consumer<span style="color:#f92672">.</span><span style="color:#a6e22e">subscribe</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;TopicTest&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“æ¶ˆè´¹è€…å®¢æˆ·ç«¯å¯åŠ¨ä»¥åï¼Œå…¶ä¼šæ¯éš” 30 ç§’ä»å‘½åæœåŠ¡å™¨æŸ¥è¯¢ä¸€æ¬¡<strong>ç”¨æˆ·è®¢é˜…çš„æ‰€æœ‰è¯é¢˜è·¯ç”±ä¿¡æ¯</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MQClientInstance</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startScheduledTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduledExecutorService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// ä»å‘½åæœåŠ¡å™¨æ‹‰å–è¯é¢˜ä¿¡æ¯
</span><span style="color:#75715e"></span>                    MQClientInstance<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updateTopicRouteInfoFromNameServer</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">},</span> 10<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clientConfig</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPollNameServerInterval</span><span style="color:#f92672">(),</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æˆ‘ä»¬ç”± <a href="/docs/rocketmq/rocketmq-send-message-flow/">RocketMQ æ¶ˆæ¯å‘é€æµç¨‹</a> è¿™ç¯‡æ–‡ç« çŸ¥é“ RocketMQ åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ¯æ¡æ¶ˆæ¯ä¼šä»¥è½®å¾ªçš„æ–¹å¼å‡è¡¡åœ°åˆ†å‘çš„ä¸åŒ Broker çš„ä¸åŒé˜Ÿåˆ—ä¸­å»ã€‚ç”±æ­¤ï¼Œæ¶ˆè´¹è€…å®¢æˆ·ç«¯ä»æœåŠ¡å™¨å‘½åæœåŠ¡å™¨è·å–ä¸‹æ¥çš„ä¾¿æ˜¯è¯é¢˜çš„æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/topic_all_message_queue.png" alt="æ‰€æœ‰è¯é¢˜é˜Ÿåˆ—"></p>
<p>åœ¨è·å–è¯é¢˜è·¯ç”±ä¿¡æ¯çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯è¿˜ä¼šå°†è¯é¢˜è·¯ç”±ä¿¡æ¯ä¸­çš„<strong>æ‰€æœ‰ Broker åœ°å€</strong>ä¿å­˜åˆ°æœ¬åœ°:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MQClientInstance</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">updateTopicRouteInfoFromNameServer</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String topic<span style="color:#f92672">,</span>
                                                      <span style="color:#66d9ef">boolean</span> isDefault<span style="color:#f92672">,</span>
                                                      DefaultMQProducer defaultMQProducer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>changed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            TopicRouteData cloneTopicRouteData <span style="color:#f92672">=</span> topicRouteData<span style="color:#f92672">.</span><span style="color:#a6e22e">cloneTopicRouteData</span><span style="color:#f92672">();</span>

            <span style="color:#75715e">// æ›´æ–° Broker åœ°å€åˆ—è¡¨
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>BrokerData bd <span style="color:#f92672">:</span> topicRouteData<span style="color:#f92672">.</span><span style="color:#a6e22e">getBrokerDatas</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerAddrTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>bd<span style="color:#f92672">.</span><span style="color:#a6e22e">getBrokerName</span><span style="color:#f92672">(),</span> bd<span style="color:#f92672">.</span><span style="color:#a6e22e">getBrokerAddrs</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“æ¶ˆè´¹è€…å®¢æˆ·ç«¯è·å–åˆ°äº† Broker åœ°å€åˆ—è¡¨ä¹‹åï¼Œå…¶ä¾¿ä¼šæ¯éš” 30 ç§’ç»™æœåŠ¡å™¨å‘é€ä¸€æ¡<strong>å¿ƒè·³æ•°æ®åŒ…</strong>ï¼Œå‘ŠçŸ¥æ‰€æœ‰ Broker æœåŠ¡å™¨è¿™å°æ¶ˆè´¹è€…å®¢æˆ·ç«¯çš„å­˜åœ¨ã€‚åœ¨æ¯æ¬¡å‘é€å¿ƒè·³åŒ…çš„åŒæ—¶ï¼Œå…¶æ•°æ®åŒ…å†…è¿˜ä¼šæå¸¦è¿™ä¸ªå®¢æˆ·ç«¯æ¶ˆæ¯è®¢é˜…çš„ä¸€äº›ç»„ä¿¡æ¯ï¼Œæ¯”å¦‚ç”¨æˆ·è®¢é˜…äº†å“ªå‡ ä¸ªè¯é¢˜ç­‰ï¼Œä¸æ­¤ç›¸å¯¹åº”ï¼Œæ¯å° Broker æœåŠ¡å™¨ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä»½å½“å‰æ‰€æœ‰çš„<strong>æ¶ˆè´¹è€…å®¢æˆ·ç«¯åˆ—è¡¨ä¿¡æ¯</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerManager</span> <span style="color:#f92672">{</span>
 
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ConcurrentMap<span style="color:#f92672">&lt;</span>String<span style="color:#75715e">/* Group */</span><span style="color:#f92672">,</span> ConsumerGroupInfo<span style="color:#f92672">&gt;</span> consumerTable <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> ConsumerGroupInfo<span style="color:#f92672">&gt;(</span>1024<span style="color:#f92672">);</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æ¶ˆè´¹è€…å®¢æˆ·ç«¯ä¸ Broker æœåŠ¡å™¨è¿›è¡Œæ²Ÿé€šçš„æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/broker_consumer_info.png" alt="æ¶ˆè´¹è€…ä¸ Broker æ²Ÿé€š"></p>
<h2 id="äºŒæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡">äºŒã€æ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡</h2>
<p>æˆ‘ä»¬çŸ¥é“æ— è®ºå‘é€æ¶ˆæ¯è¿˜æ˜¯æ¥å—æ¶ˆæ¯éƒ½éœ€è¦æŒ‡å®šæ¶ˆæ¯çš„è¯é¢˜ï¼Œç„¶è€Œå®é™…ä¸Šæ¶ˆæ¯åœ¨ Broker æœåŠ¡å™¨ä¸Šå¹¶ä¸æ˜¯ä»¥è¯é¢˜ä¸ºå•ä½è¿›è¡Œå­˜å‚¨çš„ï¼Œè€Œæ˜¯é‡‡ç”¨äº†æ¯”è¯é¢˜æ›´ç»†ç²’åº¦çš„é˜Ÿåˆ—æ¥è¿›è¡Œå­˜å‚¨çš„ã€‚å½“ä½ å‘é€äº† 10 æ¡ç›¸åŒè¯é¢˜çš„æ¶ˆæ¯ï¼Œè¿™ 10 æ¡è¯é¢˜å¯èƒ½å­˜å‚¨åœ¨äº†ä¸åŒ Broker æœåŠ¡å™¨çš„ä¸åŒé˜Ÿåˆ—ä¸­ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬è¯´ RocketMQ ç®¡ç†æ¶ˆæ¯çš„å•ä½ä¸æ˜¯<strong>è¯é¢˜</strong>ï¼Œè€Œæ˜¯<strong>é˜Ÿåˆ—</strong>ã€‚</p>
<p>å½“æˆ‘ä»¬è®¨è®ºæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡çš„æ—¶å€™ï¼Œå°±æ˜¯åœ¨è®¨è®ºæœåŠ¡å™¨ç«¯çš„æ‰€æœ‰é˜Ÿåˆ—å¦‚ä½•ç»™æ‰€æœ‰æ¶ˆè´¹è€…æ¶ˆè´¹çš„é—®é¢˜ã€‚åœ¨ RocketMQ ä¸­ï¼Œå®¢æˆ·ç«¯æœ‰ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ï¼Œä¸€ç§æ˜¯<strong>å¹¿æ’­æ¨¡å¼</strong>ï¼Œå¦å¤–ä¸€ç§æ˜¯<strong>é›†ç¾¤æ¨¡å¼</strong>ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å‡è®¾æ€»å…±æœ‰ä¸¤å° Broker æœåŠ¡å™¨ï¼Œå‡è®¾ç”¨æˆ·ä½¿ç”¨ Producer å·²ç»å‘é€äº† 8 æ¡æ¶ˆæ¯ï¼Œè¿™ 8 æ¡æ¶ˆæ¯ç°åœ¨å‡è¡¡çš„åˆ†å¸ƒåœ¨ä¸¤å° Broker æœåŠ¡å™¨çš„ 8 ä¸ªé˜Ÿåˆ—ä¸­ï¼Œæ¯ä¸ªé˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªæ¶ˆæ¯ã€‚ç°åœ¨æœ‰ 3 å°éƒ½è®¢é˜…äº† Test è¯é¢˜çš„æ¶ˆè´¹è€…å®ä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹åœ¨ä¸åŒæ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œä¸åŒçš„æ¶ˆè´¹è€…ä¼šæ”¶åˆ°å“ªå‡ æ¡æ¶ˆæ¯ã€‚</p>
<h3 id="1-å¹¿æ’­æ¨¡å¼">(1) å¹¿æ’­æ¨¡å¼</h3>
<p>å¹¿æ’­æ¨¡å¼æ˜¯æŒ‡æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯éƒ½ä¼šå¹¿æ’­ç»™æ‰€æœ‰çš„æ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸€ä¸ªæ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°è¿™ 8 æ¡æ¶ˆæ¯:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/broadcasting_mode.png" alt="å¹¿æ’­æ¨¡å¼"></p>
<h3 id="2-é›†ç¾¤æ¨¡å¼">(2) é›†ç¾¤æ¨¡å¼</h3>
<p>é›†ç¾¤æ¨¡å¼æ˜¯æŒ‡æ‰€æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—ä¼šæŒ‰ç…§æŸç§åˆ†é…ç­–ç•¥æ¥åˆ†ç»™ä¸åŒçš„æ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œæ¯”å¦‚æ¶ˆè´¹è€… A æ¶ˆè´¹å‰ 3 ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€… B æ¶ˆè´¹ä¸­é—´ 3 ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ç­‰ç­‰ã€‚æˆ‘ä»¬ç°åœ¨ç€é‡çœ‹ RocketMQ ä¸ºæˆ‘ä»¬æä¾›çš„ä¸‰ä¸ªæ¯”è¾ƒé‡è¦çš„æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ç­–ç•¥:</p>
<h4 id="1-å¹³å‡åˆ†é…ç­–ç•¥">1. å¹³å‡åˆ†é…ç­–ç•¥</h4>
<p>å¹³å‡åˆ†é…ç­–ç•¥ä¸‹ï¼Œä¸‰ä¸ªæ¶ˆè´¹è€…çš„æ¶ˆè´¹æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>Consumer-1 æ¶ˆè´¹å‰ 3 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
<li>Consumer-2 æ¶ˆè´¹ä¸­é—´ 3 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
<li>Consumer-3 æ¶ˆè´¹æœ€å 2 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
</ul>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/allocate_message_queue_strategy_average.png" alt="å¹³å‡åˆ†é…ç­–ç•¥"></p>
<h4 id="2-å¹³å‡åˆ†é…è½®å¾ªç­–ç•¥">2. å¹³å‡åˆ†é…è½®å¾ªç­–ç•¥</h4>
<p>å¹³å‡åˆ†é…è½®å¾ªç­–ç•¥ä¸‹ï¼Œä¸‰ä¸ªæ¶ˆè´¹è€…çš„æ¶ˆè´¹æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>Consumer-1 æ¶ˆè´¹ 1ã€4ã€7æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
<li>Consumer-2 æ¶ˆè´¹ 2ã€5ã€8æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
<li>Consumer-3 æ¶ˆè´¹ 3ã€6æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
</ul>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/allocate_messagequeue_averagely_by_circle.png" alt="å¹³å‡åˆ†é…è½®å¾ª"></p>
<h4 id="3-ä¸€è‡´æ€§å“ˆå¸Œç­–ç•¥">3. ä¸€è‡´æ€§å“ˆå¸Œç­–ç•¥</h4>
<p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯æ ¹æ®è¿™ä¸‰å°æ¶ˆè´¹è€…å„è‡ªçš„æŸä¸ªæœ‰ä»£è¡¨æ€§çš„å±æ€§(æˆ‘ä»¬å‡è®¾å°±æ˜¯å®¢æˆ·ç«¯ID)æ¥è®¡ç®—å‡ºä¸‰ä¸ª Hash å€¼ï¼Œæ­¤å¤„ä¸ºäº†å‡å°‘ç”±äº Hash å‡½æ•°é€‰å–çš„ä¸ç†æƒ³çš„æƒ…å†µï¼Œ RocketMQ ç®—æ³•å¯¹äºæ¯ä¸ªæ¶ˆè´¹è€…é€šè¿‡åœ¨å®¢æˆ·ç«¯IDåé¢æ·»åŠ  1ã€2ã€3 ç´¢å¼•æ¥ä½¿æ¯ä¸€ä¸ªæ¶ˆè´¹è€…å¤šç”Ÿæˆå‡ ä¸ªå“ˆå¸Œå€¼ã€‚é‚£ä¹ˆç°åœ¨æˆ‘ä»¬éœ€è¦å“ˆå¸Œçš„å°±æ˜¯ä¹ä¸ªå­—ç¬¦ä¸²:</p>
<ul>
<li>Consumer-1-1</li>
<li>Consumer-1-2</li>
<li>Consumer-1-3</li>
<li>Consumer-2-1</li>
<li>Consumer-2-2</li>
<li>Consumer-2-3</li>
<li>Consumer-3-1</li>
<li>Consumer-3-2</li>
<li>Consumer-3-3</li>
</ul>
<p>è®¡ç®—å®Œè¿™ 9 ä¸ªå“ˆå¸Œå€¼ä»¥åï¼Œæˆ‘ä»¬æŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºæ¥æ’åˆ—æˆä¸€ä¸ªç¯ (å¦‚å›¾æ‰€ç¤º)ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ä¸€ä¸€å¯¹è¿™ 8 ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿè¦è®¡ç®—ä¸€ä¸‹ Hash å€¼ï¼Œå½“ Hash å€¼è½åœ¨ä¸¤ä¸ªåœˆä¹‹é—´çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±é€‰å–æ²¿ç€ç¯çš„æ–¹å‘çš„é‚£ä¸ªèŠ‚ç‚¹ä½œä¸ºè¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º (æ³¨æ„: å›¾åªæ˜¯ç¤ºä¾‹ï¼Œå¹¶éçœŸæ­£çš„æ¶ˆè´¹æƒ…å†µ):</p>
<p>åœ¨ä¸€è‡´æ€§å“ˆå¸Œç­–ç•¥ä¸‹ï¼Œä¸‰ä¸ªæ¶ˆè´¹è€…çš„æ¶ˆè´¹æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>Consumer-1 æ¶ˆè´¹ 1ã€2ã€3ã€4æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
<li>Consumer-2 æ¶ˆè´¹ 5ã€8æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
<li>Consumer-3 æ¶ˆè´¹ 6ã€7æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
</ul>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/allocate_message_queue_consistent_hash.png" alt="ä¸€è‡´æ€§å“ˆå¸Œ"></p>
<p>æ¶ˆæ¯é˜Ÿåˆ—çš„è´Ÿè½½å‡è¡¡æ˜¯ç”±ä¸€ä¸ªä¸åœè¿è¡Œçš„<strong>å‡è¡¡æœåŠ¡</strong>æ¥å®šæ—¶æ‰§è¡Œçš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RebalanceService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>
    <span style="color:#75715e">// é»˜è®¤ 20 ç§’ä¸€æ¬¡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">long</span> waitInterval <span style="color:#f92672">=</span>
        Long<span style="color:#f92672">.</span><span style="color:#a6e22e">parseLong</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;rocketmq.client.rebalance.waitInterval&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;20000&#34;</span><span style="color:#f92672">));</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isStopped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">waitForRunning</span><span style="color:#f92672">(</span>waitInterval<span style="color:#f92672">);</span>
            <span style="color:#75715e">// é‡æ–°æ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„è´Ÿè½½å‡è¡¡
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mqClientFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">doRebalance</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>æ¥ç€å¾€ä¸‹çœ‹ï¼Œä¼šçŸ¥é“åœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œå½“å‰è¿™å°æ¶ˆè´¹è€…æ¶ˆè´¹å’Œè¯é¢˜ç›¸å…³çš„æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œé›†ç¾¤æ¨¡å¼ä¼šå…ˆæŒ‰ç…§æŸç§åˆ†é…ç­–ç•¥æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†é…ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯å½“å‰è¿™å°æ¶ˆè´¹è€…éœ€è¦æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RebalanceImpl</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rebalanceByTopic</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String topic<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isOrder<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>messageModel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å¹¿æ’­æ¨¡å¼
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> BROADCASTING<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æ¶ˆè´¹è¿™ä¸ªè¯é¢˜çš„æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—
</span><span style="color:#75715e"></span>            Set<span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">&gt;</span> mqSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">topicSubscribeInfoTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>topic<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mqSet <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
            <span style="color:#75715e">// é›†ç¾¤æ¨¡å¼
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> CLUSTERING<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
            <span style="color:#75715e">// æŒ‰ç…§æŸç§è´Ÿè½½å‡è¡¡ç­–ç•¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—å’Œæ¶ˆè´¹å®¢æˆ·ç«¯ä¹‹é—´çš„åˆ†é…
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// allocateResult å°±æ˜¯å½“å‰è¿™å°æ¶ˆè´¹è€…è¢«åˆ†é…åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—
</span><span style="color:#75715e"></span>            allocateResult <span style="color:#f92672">=</span> strategy<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>
                                               <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerGroup</span><span style="color:#f92672">,</span>
                                               <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClientId</span><span style="color:#f92672">(),</span>
                                               mqAll<span style="color:#f92672">,</span>
                                               cidAll<span style="color:#f92672">);</span>

            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="ä¸‰broker-æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶">ä¸‰ã€Broker æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶</h2>
<p>ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ Broker æœåŠ¡å™¨ç«¯ã€‚é¦–å…ˆæˆ‘ä»¬åº”è¯¥çŸ¥é“ï¼Œæ¶ˆæ¯å¾€ Broker å­˜å‚¨å°±æ˜¯åœ¨å‘ <code>CommitLog</code> æ¶ˆæ¯æ–‡ä»¶ä¸­å†™å…¥æ•°æ®çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚åœ¨ Broker å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå…¶ä¼šå¯åŠ¨ä¸€ä¸ªå«åš <code>ReputMessageService</code> çš„æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡æ¯éš” 1 ç§’ä¼šæ£€æŸ¥ä¸€ä¸‹è¿™ä¸ª <code>CommitLog</code> æ˜¯å¦æœ‰æ–°çš„æ•°æ®å†™å…¥ã€‚<code>ReputMessageService</code> è‡ªèº«ç»´æŠ¤äº†ä¸€ä¸ªåç§»é‡ <code>reputFromOffset</code>ï¼Œç”¨ä»¥å¯¹æ¯”å’Œ <code>CommitLog</code> æ–‡ä»¶ä¸­çš„æ¶ˆæ¯æ€»åç§»é‡çš„å·®è·ã€‚å½“è¿™ä¸¤ä¸ªåç§»é‡ä¸åŒçš„æ—¶å€™ï¼Œå°±ä»£è¡¨æœ‰æ–°çš„æ¶ˆæ¯åˆ°æ¥äº†:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReputMessageService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> reputFromOffset <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isCommitLogAvailable</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// çœ‹å½“å‰æœ‰æ²¡æœ‰æ–°çš„æ¶ˆæ¯åˆ°æ¥
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">reputFromOffset</span> <span style="color:#f92672">&lt;</span> DefaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commitLog</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxOffset</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isStopped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">doReput</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                DefaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getServiceName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; service has exception. &#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨æœ‰æ–°çš„æ¶ˆæ¯åˆ°æ¥ä¹‹åï¼Œ<code>doReput()</code> å‡½æ•°ä¼šå–å‡ºæ–°åˆ°æ¥çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯éƒ½ä¼šå°è£…ä¸ºä¸€ä¸ª <code>DispatchRequest</code> è¯·æ±‚ï¼Œè¿›è€Œå°†è¿™æ¡è¯·æ±‚åˆ†å‘ç»™ä¸åŒçš„è¯·æ±‚æ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« ä¸­åªä¼šå…³æ³¨åˆ©ç”¨æ¶ˆæ¯åˆ›å»ºæ¶ˆè´¹é˜Ÿåˆ—çš„æœåŠ¡ <code>CommitLogDispatcherBuildConsumeQueue</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReputMessageService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#75715e">// ... éƒ¨åˆ†ä»£ç æœ‰åˆ å‡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doReput</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        SelectMappedBufferResult result <span style="color:#f92672">=</span> DefaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commitLog</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getData</span><span style="color:#f92672">(</span>reputFromOffset<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">reputFromOffset</span> <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">getStartOffset</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> readSize <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> readSize <span style="color:#f92672">&lt;</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> doNext<span style="color:#f92672">;</span> <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// è¯»å–ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åå°è£…ä¸º DispatchRequest
</span><span style="color:#75715e"></span>                DispatchRequest dispatchRequest <span style="color:#f92672">=</span>
                    DefaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commitLog</span><span style="color:#f92672">.</span><span style="color:#a6e22e">checkMessageAndReturnSize</span><span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getByteBuffer</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">int</span> size <span style="color:#f92672">=</span> dispatchRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgSize</span><span style="color:#f92672">();</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dispatchRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">isSuccess</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// åˆ†å‘è¿™ä¸ª DispatchRequest è¯·æ±‚
</span><span style="color:#75715e"></span>                    DefaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">doDispatch</span><span style="color:#f92672">(</span>dispatchRequest<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">reputFromOffset</span> <span style="color:#f92672">+=</span> size<span style="color:#f92672">;</span>
                    readSize <span style="color:#f92672">+=</span> size<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>

                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p><code>CommitLogDispatcherBuildConsumeQueue</code> æœåŠ¡ä¼šæ ¹æ®è¿™æ¡è¯·æ±‚æŒ‰ç…§ä¸åŒçš„é˜Ÿåˆ— ID åˆ›å»ºä¸åŒçš„æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ï¼Œå¹¶åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä»½æ¶ˆè´¹é˜Ÿåˆ—åˆ—è¡¨ã€‚ç„¶åå°† <code>DispatchRequest</code> è¯·æ±‚ä¸­è¿™æ¡æ¶ˆæ¯çš„æ¶ˆæ¯åç§»é‡ã€æ¶ˆæ¯å¤§å°ä»¥åŠæ¶ˆæ¯åœ¨å‘é€æ—¶å€™é™„å¸¦çš„æ ‡ç­¾çš„ Hash å€¼å†™å…¥åˆ°ç›¸åº”çš„æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸­å»ã€‚</p>
<p>æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶çš„åˆ›å»ºä¸<a href="/docs/rocketmq/rocketmq-message-store-flow/#%E4%BA%8C%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA">æ¶ˆæ¯å­˜å‚¨ CommitLog æ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹</a>æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯è·¯å¾„ä¸åŒï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<p>å¯»æ‰¾æ¶ˆè´¹é˜Ÿåˆ—çš„ä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMessageStore</span> <span style="color:#66d9ef">implements</span> MessageStore <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ConcurrentMap<span style="color:#f92672">&lt;</span>String<span style="color:#75715e">/* topic */</span><span style="color:#f92672">,</span> ConcurrentMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#75715e">/* queueId */</span><span style="color:#f92672">,</span> ConsumeQueue<span style="color:#f92672">&gt;&gt;</span> consumeQueueTable<span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">putMessagePositionInfo</span><span style="color:#f92672">(</span>DispatchRequest dispatchRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ConsumeQueue cq <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">findConsumeQueue</span><span style="color:#f92672">(</span>dispatchRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">(),</span> dispatchRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getQueueId</span><span style="color:#f92672">());</span>
        cq<span style="color:#f92672">.</span><span style="color:#a6e22e">putMessagePositionInfoWrapper</span><span style="color:#f92672">(</span>dispatchRequest<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å‘æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸­å­˜å‚¨æ•°æ®çš„ä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeQueue</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">putMessagePositionInfo</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> size<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> tagsCode<span style="color:#f92672">,</span>
                                           <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> cqOffset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">// å­˜å‚¨åç§»é‡ã€å¤§å°ã€æ ‡ç­¾ç 
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">byteBufferIndex</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">byteBufferIndex</span><span style="color:#f92672">.</span><span style="color:#a6e22e">limit</span><span style="color:#f92672">(</span>CQ_STORE_UNIT_SIZE<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">byteBufferIndex</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putLong</span><span style="color:#f92672">(</span>offset<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">byteBufferIndex</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putInt</span><span style="color:#f92672">(</span>size<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">byteBufferIndex</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putLong</span><span style="color:#f92672">(</span>tagsCode<span style="color:#f92672">);</span>

        <span style="color:#75715e">// è·å–æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> expectLogicOffset <span style="color:#f92672">=</span> cqOffset <span style="color:#f92672">*</span> CQ_STORE_UNIT_SIZE<span style="color:#f92672">;</span>
        MappedFile mappedFile <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getLastMappedFile</span><span style="color:#f92672">(</span>expectLogicOffset<span style="color:#f92672">);</span>
        
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mappedFile <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> mappedFile<span style="color:#f92672">.</span><span style="color:#a6e22e">appendMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">byteBufferIndex</span><span style="color:#f92672">.</span><span style="color:#a6e22e">array</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ä»¥ä¸Šé˜è¿°äº†æ¶ˆè´¹é˜Ÿåˆ—åˆ›å»ºå¹¶å­˜å‚¨æ¶ˆæ¯çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œä½†æ˜¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸­çš„æ¶ˆæ¯æ˜¯éœ€è¦æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­å»çš„ã€‚æŒä¹…åŒ–çš„è¿‡ç¨‹æ˜¯é€šè¿‡åå°æœåŠ¡ <code>FlushConsumeQueueService</code> æ¥å®šæ—¶æŒä¹…åŒ–çš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FlushConsumeQueueService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFlush</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> retryTimes<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        ConcurrentMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> ConcurrentMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> ConsumeQueue<span style="color:#f92672">&gt;&gt;</span> tables <span style="color:#f92672">=</span> DefaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeQueueTable</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ConcurrentMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> ConsumeQueue<span style="color:#f92672">&gt;</span> maps <span style="color:#f92672">:</span> tables<span style="color:#f92672">.</span><span style="color:#a6e22e">values</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ConsumeQueue cq <span style="color:#f92672">:</span> maps<span style="color:#f92672">.</span><span style="color:#a6e22e">values</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">boolean</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> retryTimes <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>result<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// åˆ·æ–°åˆ°ç£ç›˜
</span><span style="color:#75715e"></span>                    result <span style="color:#f92672">=</span> cq<span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">(</span>flushConsumeQueueLeastPages<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸Šè¿°è¿‡ç¨‹ä½“ç°åœ¨ç£ç›˜æ–‡ä»¶çš„å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ<code>commitLog</code> æ–‡ä»¶å¤¹ä¸‹é¢å­˜æ”¾çš„æ˜¯å®Œæ•´çš„æ¶ˆæ¯ï¼Œæ¥ä¸€æ¡æ¶ˆæ¯ï¼Œå‘æ–‡ä»¶ä¸­è¿½åŠ ä¸€æ¡æ¶ˆæ¯ã€‚åŒæ—¶ï¼Œæ ¹æ®è¿™ä¸€æ¡æ¶ˆæ¯å±äº <code>TopicTest</code> è¯é¢˜ä¸‹çš„å“ªä¸€ä¸ªé˜Ÿåˆ—ï¼Œåˆä¼šå¾€ç›¸åº”çš„ <code>consumequeue</code> æ–‡ä»¶ä¸‹çš„ç›¸åº”æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸­è¿½åŠ æ¶ˆæ¯çš„åç§»é‡ã€æ¶ˆæ¯å¤§å°å’Œæ ‡ç­¾ç :</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/2018_03_16_11_54_01.png" alt="æ–‡ä»¶å­˜å‚¨æ–¹å¼"></p>
<p>æ€»æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/broker_consume_queue.png" alt="æ¶ˆè´¹é˜Ÿåˆ—"></p>
<h2 id="å››æ¶ˆæ¯é˜Ÿåˆ—åç§»é‡">å››ã€æ¶ˆæ¯é˜Ÿåˆ—åç§»é‡</h2>
<p>Broker æœåŠ¡å™¨å­˜å‚¨äº†å„ä¸ªæ¶ˆè´¹é˜Ÿåˆ—ï¼Œå®¢æˆ·ç«¯éœ€è¦æ¶ˆè´¹æ¯ä¸ªæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚æ¶ˆè´¹æ¨¡å¼çš„ä¸åŒï¼Œæ¯ä¸ªå®¢æˆ·ç«¯æ‰€æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿä¸åŒã€‚é‚£ä¹ˆå®¢æˆ·ç«¯å¦‚ä½•è®°å½•è‡ªå·±æ‰€æ¶ˆè´¹çš„é˜Ÿåˆ—æ¶ˆè´¹åˆ°å“ªé‡Œäº†å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯<strong>æ¶ˆè´¹é˜Ÿåˆ—åç§»é‡</strong>ã€‚</p>
<p>é’ˆå¯¹åŒä¸€è¯é¢˜ï¼Œåœ¨<strong>é›†ç¾¤æ¨¡å¼</strong>ä¸‹ï¼Œç”±äºæ¯ä¸ªå®¢æˆ·ç«¯æ‰€æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸åŒï¼Œæ‰€ä»¥æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å·²ç»æ¶ˆè´¹åˆ°å“ªé‡Œçš„æ¶ˆè´¹åç§»é‡æ˜¯<strong>è®°å½•åœ¨ Broker æœåŠ¡å™¨ç«¯</strong>çš„ã€‚è€Œåœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œç”±äºæ¯ä¸ªå®¢æˆ·ç«¯åˆ†é…æ¶ˆè´¹è¿™ä¸ªè¯é¢˜çš„æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å·²ç»æ¶ˆè´¹åˆ°å“ªé‡Œçš„æ¶ˆè´¹åç§»é‡æ˜¯è®°å½•åœ¨<strong>å®¢æˆ·ç«¯æœ¬åœ°</strong>çš„ã€‚</p>
<p>ä¸‹é¢åˆ†åˆ«è®²è¿°ä¸¤ç§æ¨¡å¼ä¸‹åç§»é‡æ˜¯å¦‚ä½•è·å–å’Œæ›´æ–°çš„:</p>
<h3 id="1-é›†ç¾¤æ¨¡å¼">(1) é›†ç¾¤æ¨¡å¼</h3>
<p>åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€…å®¢æˆ·ç«¯åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸€ä¸ª <code>offsetTable</code> è¡¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RemoteBrokerOffsetStore</span> <span style="color:#66d9ef">implements</span> OffsetStore <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> ConcurrentMap<span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">,</span> AtomicLong<span style="color:#f92672">&gt;</span> offsetTable <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">,</span> AtomicLong<span style="color:#f92672">&gt;();</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>åŒæ ·åœ¨ Broker æœåŠ¡å™¨ç«¯ä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªåç§»é‡è¡¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumerOffsetManager</span> <span style="color:#66d9ef">extends</span> ConfigManager <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> ConcurrentMap<span style="color:#f92672">&lt;</span>String<span style="color:#75715e">/* topic@group */</span><span style="color:#f92672">,</span> ConcurrentMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;&gt;</span> offsetTable <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> ConcurrentMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;&gt;(</span>512<span style="color:#f92672">);</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨æ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œ<code>RebalanceService</code> æœåŠ¡ä¼šå®šæ—¶åœ° (é»˜è®¤ 20 ç§’) ä» Broker æœåŠ¡å™¨è·å–å½“å‰å®¢æˆ·ç«¯æ‰€éœ€è¦æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶ä¸å½“å‰æ¶ˆè´¹è€…å®¢æˆ·ç«¯çš„æ¶ˆè´¹é˜Ÿåˆ—è¿›è¡Œå¯¹æ¯”ï¼Œçœ‹æ˜¯å¦æœ‰å˜åŒ–ã€‚å¯¹äºæ¯ä¸ªæ¶ˆè´¹é˜Ÿåˆ—ï¼Œä¼šä» Broker æœåŠ¡å™¨æŸ¥è¯¢è¿™ä¸ªé˜Ÿåˆ—å½“å‰çš„æ¶ˆè´¹åç§»é‡ã€‚ç„¶åæ ¹æ®è¿™å‡ ä¸ªæ¶ˆè´¹é˜Ÿåˆ—ï¼Œåˆ›å»ºå¯¹åº”çš„æ‹‰å–è¯·æ±‚ <code>PullRequest</code> å‡†å¤‡ä» Broker æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/create_pull_request_from_messagequeue.png" alt="å®šæ—¶åˆ›å»ºè¯·æ±‚æ‹‰å–"></p>
<p>å½“ä» Broker æœåŠ¡å™¨æ‹‰å–ä¸‹æ¥æ¶ˆæ¯ä»¥åï¼Œåªæœ‰å½“ç”¨æˆ·æˆåŠŸæ¶ˆè´¹çš„æ—¶å€™ï¼Œæ‰ä¼šæ›´æ–°æœ¬åœ°çš„åç§»é‡è¡¨ã€‚æœ¬åœ°çš„åç§»é‡è¡¨å†é€šè¿‡å®šæ—¶æœåŠ¡æ¯éš” 5 ç§’åŒæ­¥åˆ° Broker æœåŠ¡å™¨ç«¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MQClientInstance</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startScheduledTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduledExecutorService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    MQClientInstance<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">persistAllConsumerOffset</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">},</span> 1000 <span style="color:#f92672">*</span> 10<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clientConfig</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPersistConsumerOffsetInterval</span><span style="color:#f92672">(),</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>è€Œç»´æŠ¤åœ¨ Broker æœåŠ¡å™¨ç«¯çš„åç§»é‡è¡¨ä¹Ÿä¼šæ¯éš” 5 ç§’é’Ÿåºåˆ—åŒ–åˆ°ç£ç›˜ä¸­:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BrokerController</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">initialize</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> CloneNotSupportedException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduledExecutorService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    BrokerController<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumerOffsetManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">persist</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">},</span> 1000 <span style="color:#f92672">*</span> 10<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerConfig</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getFlushConsumerOffsetInterval</span><span style="color:#f92672">(),</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¿å­˜çš„æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/2018_03_16_22_52_14.png" alt="æ–‡ä»¶ä¿å­˜å½¢å¼"></p>
<p>ä¸Šè¿°æ•´ä½“æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œçº¢æ¡†æ¡†ä½çš„æ˜¯è¿™ä¸ªè¯é¢˜ä¸‹é¢çš„é˜Ÿåˆ—çš„ IDï¼Œç®­å¤´æŒ‡å‘çš„åˆ†åˆ«æ˜¯æ¯ä¸ªé˜Ÿåˆ—çš„æ¶ˆè´¹åç§»é‡ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/consume_queue_offset_update.png" alt="æ¶ˆè´¹é˜Ÿåˆ—åç§»é‡"></p>
<h3 id="2-å¹¿æ’­æ¨¡å¼">(2) å¹¿æ’­æ¨¡å¼</h3>
<p>å¯¹äºå¹¿æ’­æ¨¡å¼è€Œè¨€ï¼Œæ¯ä¸ªæ¶ˆè´¹é˜Ÿåˆ—çš„åç§»é‡è‚¯å®šä¸èƒ½å­˜å‚¨åœ¨ Broker æœåŠ¡å™¨ç«¯ï¼Œå› ä¸ºå¤šä¸ªæ¶ˆè´¹è€…å¯¹äºåŒä¸€ä¸ªé˜Ÿåˆ—çš„æ¶ˆè´¹å¯èƒ½ä¸ä¸€è‡´ï¼Œåç§»é‡ä¼šäº’ç›¸è¦†ç›–æ‰ã€‚å› æ­¤ï¼Œåœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯çš„æ¶ˆè´¹åç§»é‡æ˜¯å­˜å‚¨åœ¨æœ¬åœ°çš„ï¼Œç„¶åæ¯éš” 5 ç§’å°†å†…å­˜ä¸­çš„ <code>offsetTable</code> æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚å½“é¦–æ¬¡ä»æœåŠ¡å™¨è·å–å¯æ¶ˆè´¹é˜Ÿåˆ—çš„æ—¶å€™ï¼Œåç§»é‡ä¸åƒé›†ç¾¤æ¨¡å¼ä¸‹æ˜¯ä» Broker æœåŠ¡å™¨è¯»å–çš„ï¼Œè€Œæ˜¯ç›´æ¥ä»æœ¬åœ°æ–‡ä»¶ä¸­è¯»å–çš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LocalFileOffsetStore</span> <span style="color:#66d9ef">implements</span> OffsetStore <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">readOffset</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MessageQueue mq<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> ReadOffsetType type<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mq <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>type<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
             <span style="color:#66d9ef">case</span> READ_FROM_STORE<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æœ¬åœ°è¯»å–
</span><span style="color:#75715e"></span>                offsetSerializeWrapper <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">readLocalOffset</span><span style="color:#f92672">();</span>
                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/create_pull_request_from_messagequeue_broadcasting.png" alt="å¹¿æ’­æ¨¡å¼åç§»é‡"></p>
<p>å½“æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸåï¼Œåç§»é‡çš„æ›´æ–°ä¹Ÿæ˜¯æŒä¹…åŒ–åˆ°æœ¬åœ°ï¼Œè€Œéæ›´æ–°åˆ° Broker æœåŠ¡å™¨ä¸­ã€‚è¿™é‡Œæä¸€ä¸‹ï¼Œåœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„åç§»é‡é»˜è®¤æ”¾åœ¨ç”¨æˆ·ç›®å½•ä¸‹çš„ <code>.rocketmq_offsets</code> ç›®å½•ä¸‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LocalFileOffsetStore</span> <span style="color:#66d9ef">implements</span> OffsetStore <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">persistAll</span><span style="color:#f92672">(</span>Set<span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">&gt;</span> mqs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        String jsonString <span style="color:#f92672">=</span> offsetSerializeWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">toJson</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
        MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">string2File</span><span style="color:#f92672">(</span>jsonString<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">storePath</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/2018_03_16_23_15_16.png" alt="å¹¿æ’­æ¨¡å¼åç§»é‡å­˜å‚¨æ ¼å¼"></p>
<p>ç®€è¦æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/consume_queue_offset_update_broadcasting.png" alt="å¹¿æ’­æ¨¡å¼åç§»é‡æ›´æ–°æµç¨‹"></p>
<h2 id="äº”æ‹‰å–æ¶ˆæ¯">äº”ã€æ‹‰å–æ¶ˆæ¯</h2>
<p>åœ¨å®¢æˆ·ç«¯è¿è¡Œç€ä¸€ä¸ªä¸“é—¨ç”¨æ¥æ‹‰å–æ¶ˆæ¯çš„åå°æœåŠ¡ <code>PullMessageService</code>ï¼Œå…¶æ¥å—æ¯ä¸ªé˜Ÿåˆ—åˆ›å»º <code>PullRequest</code> æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼Œç„¶åæ‹‰å–æ¶ˆæ¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PullMessageService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isStopped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            PullRequest pullRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pullRequestQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">take</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pullRequest <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pullMessage</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æ¯ä¸€ä¸ª <code>PullRequest</code> éƒ½å…³è”ç€ä¸€ä¸ª <code>MessageQueue</code> å’Œä¸€ä¸ª <code>ProcessQueue</code>ï¼Œåœ¨ <code>ProcessQueue</code> çš„å†…éƒ¨è¿˜ç»´æŠ¤äº†ä¸€ä¸ªç”¨æ¥ç­‰å¾…ç”¨æˆ·æ¶ˆè´¹çš„æ¶ˆæ¯æ ‘ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PullRequest</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> MessageQueue messageQueue<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> ProcessQueue processQueue<span style="color:#f92672">;</span>
    
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProcessQueue</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> TreeMap<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">,</span> MessageExt<span style="color:#f92672">&gt;</span> msgTreeMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TreeMap<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">,</span> MessageExt<span style="color:#f92672">&gt;();</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“çœŸæ­£å°è¯•æ‹‰å–æ¶ˆæ¯ä¹‹å‰ï¼Œå…¶ä¼šæ£€æŸ¥å½“å‰è¯·æ±‚çš„å†…éƒ¨ç¼“å­˜çš„æ¶ˆæ¯æ•°é‡ã€æ¶ˆæ¯å¤§å°ã€æ¶ˆæ¯é˜ˆå€¼è·¨åº¦æ˜¯å¦è¶…è¿‡äº†æŸä¸ªé˜ˆå€¼ï¼Œå¦‚æœè¶…è¿‡æŸä¸ªé˜ˆå€¼ï¼Œåˆ™æ¨è¿Ÿ 50 æ¯«ç§’é‡æ–°æ‰§è¡Œè¿™ä¸ªè¯·æ±‚:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMQPushConsumerImpl</span> <span style="color:#66d9ef">implements</span> MQConsumerInner <span style="color:#f92672">{</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pullMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> PullRequest pullRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    
        <span style="color:#66d9ef">final</span> ProcessQueue processQueue <span style="color:#f92672">=</span> pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessQueue</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">long</span> cachedMessageCount <span style="color:#f92672">=</span> processQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgCount</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">long</span> cachedMessageSizeInMiB <span style="color:#f92672">=</span> processQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgSize</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">/</span> <span style="color:#f92672">(</span>1024 <span style="color:#f92672">*</span> 1024<span style="color:#f92672">);</span>

        <span style="color:#75715e">// ç¼“å­˜æ¶ˆæ¯æ•°é‡é˜ˆå€¼ï¼Œé»˜è®¤ä¸º 1000
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cachedMessageCount <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPullThresholdForQueue</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ç¼“å­˜æ¶ˆæ¯å¤§å°é˜ˆå€¼ï¼Œé»˜è®¤ä¸º 100 MB
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cachedMessageSizeInMiB <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPullThresholdSizeForQueue</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">consumeOrderly</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æœ€å°åç§»é‡å’Œæœ€å¤§åç§»é‡çš„é˜ˆå€¼è·¨åº¦ï¼Œé»˜è®¤ä¸º 2000 åç§»é‡ï¼Œæ¶ˆè´¹é€Ÿåº¦ä¸èƒ½å¤ªæ…¢
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>processQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxSpan</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumeConcurrentlyMaxSpan</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executePullRequestLater</span><span style="color:#f92672">(</span>pullRequest<span style="color:#f92672">,</span> PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“æ‰§è¡Œå®Œä¸€äº›å¿…è¦çš„æ£€æŸ¥ä¹‹åï¼Œå®¢æˆ·ç«¯ä¼šå°†ç”¨æˆ·æŒ‡å®šçš„è¿‡æ»¤ä¿¡æ¯ä»¥åŠä¸€äº›å…¶å®ƒå¿…è¦æ¶ˆè´¹å­—æ®µå°è£…åˆ°è¯·æ±‚ä¿¡æ¯ä½“ä¸­ï¼Œç„¶åæ‰å¼€å§‹ä» Broker æœåŠ¡å™¨æ‹‰å–è¿™ä¸ªè¯·æ±‚ä»å½“å‰åç§»é‡å¼€å§‹çš„æ¶ˆæ¯ï¼Œé»˜è®¤ä¸€æ¬¡æ€§æœ€å¤šæ‹‰å– 32 æ¡ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”ä¼šå‘Šè¯‰å®¢æˆ·ç«¯è¿™ä¸ªé˜Ÿåˆ—ä¸‹æ¬¡å¼€å§‹æ‹‰å–æ—¶çš„åç§»é‡ã€‚å®¢æˆ·ç«¯æ¯æ¬¡éƒ½ä¼šæ³¨å†Œä¸€ä¸ª <code>PullCallback</code> å›è°ƒï¼Œç”¨ä»¥æ¥å—æœåŠ¡å™¨è¿”å›çš„å“åº”ä¿¡æ¯ï¼Œæ ¹æ®å“åº”ä¿¡æ¯çš„ä¸åŒçŠ¶æ€ä¿¡æ¯ï¼Œç„¶åä¿®æ­£è¿™ä¸ªè¯·æ±‚çš„åç§»é‡ï¼Œå¹¶è¿›è¡Œä¸‹æ¬¡è¯·æ±‚:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pullMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> PullRequest pullRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    PullCallback pullCallback <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PullCallback<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onSuccess</span><span style="color:#f92672">(</span>PullResult pullResult<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pullResult <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getPullStatus</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">case</span> FOUND<span style="color:#f92672">:</span>
                        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        
                    <span style="color:#66d9ef">case</span> NO_NEW_MSG<span style="color:#f92672">:</span>
                        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        
                    <span style="color:#66d9ef">case</span> NO_MATCHED_MSG<span style="color:#f92672">:</span>
                        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        
                    <span style="color:#66d9ef">case</span> OFFSET_ILLEGAL<span style="color:#f92672">:</span>
                        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        
                    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onException</span><span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">};</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸Šè¿°æ˜¯å®¢æˆ·ç«¯æ‹‰å–æ¶ˆæ¯æ—¶çš„ä¸€äº›æœºåˆ¶ï¼Œç°åœ¨å†è¯´ä¸€ä¸‹ Broker æœåŠ¡å™¨ç«¯ä¸æ­¤ç›¸å¯¹åº”çš„é€»è¾‘ã€‚</p>
<p>æœåŠ¡å™¨åœ¨æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ä¹‹åï¼Œä¼šæ ¹æ®è¯é¢˜å’Œé˜Ÿåˆ— ID å®šä½åˆ°å¯¹åº”çš„<strong>æ¶ˆè´¹é˜Ÿåˆ—</strong>ã€‚ç„¶åæ ¹æ®è¿™æ¡è¯·æ±‚ä¼ å…¥çš„ offset æ¶ˆè´¹é˜Ÿåˆ—åç§»é‡ï¼Œå®šä½åˆ°å¯¹åº”çš„<strong>æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶</strong>ã€‚åç§»é‡æŒ‡å®šçš„æ˜¯æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶çš„æ¶ˆè´¹ä¸‹é™ï¼Œè€Œæœ€å¤§ä¸Šé™æ˜¯ç”±å¦‚ä¸‹ç®—æ³•æ¥è¿›è¡Œçº¦æŸçš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> maxFilterMessageCount <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>16000<span style="color:#f92672">,</span> maxMsgNums <span style="color:#f92672">*</span> ConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">CQ_STORE_UNIT_SIZE</span><span style="color:#f92672">);</span>
</code></pre></div><p>æœ‰äº†ä¸Šé™å’Œä¸‹é™ï¼Œå®¢æˆ·ç«¯ä¾¿ä¼šå¼€å§‹ä»æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶ä¸­å–å‡ºæ¯ä¸ªæ¶ˆæ¯çš„<strong>åç§»é‡å’Œæ¶ˆæ¯å¤§å°</strong>ï¼Œç„¶åå†æ ¹æ®è¿™ä¸¤ä¸ªå€¼å» <code>CommitLog</code> æ–‡ä»¶ä¸­å¯»æ‰¾ç›¸åº”çš„å®Œæ•´çš„æ¶ˆæ¯ï¼Œå¹¶æ·»åŠ åˆ°æœ€åçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç²¾ç®€è¿‡çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMessageStore</span> <span style="color:#66d9ef">implements</span> MessageStore <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> GetMessageResult <span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String group<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String topic<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> queueId<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> offset<span style="color:#f92672">,</span>
                                       <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> maxMsgNums<span style="color:#f92672">,</span>
                                       <span style="color:#66d9ef">final</span> MessageFilter messageFilter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        ConsumeQueue consumeQueue <span style="color:#f92672">=</span> findConsumeQueue<span style="color:#f92672">(</span>topic<span style="color:#f92672">,</span> queueId<span style="color:#f92672">);</span>
    
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>consumeQueue <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// é¦–å…ˆæ ¹æ®æ¶ˆè´¹é˜Ÿåˆ—çš„åç§»é‡å®šä½æ¶ˆè´¹é˜Ÿåˆ—
</span><span style="color:#75715e"></span>            SelectMappedBufferResult bufferConsumeQueue <span style="color:#f92672">=</span> consumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getIndexBuffer</span><span style="color:#f92672">(</span>offset<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bufferConsumeQueue <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    status <span style="color:#f92672">=</span> GetMessageStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">NO_MATCHED_MESSAGE</span><span style="color:#f92672">;</span>

                    <span style="color:#75715e">// æœ€å¤§æ¶ˆæ¯é•¿åº¦
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> maxFilterMessageCount <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>16000<span style="color:#f92672">,</span> maxMsgNums <span style="color:#f92672">*</span> ConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">CQ_STORE_UNIT_SIZE</span><span style="color:#f92672">);</span>
                    <span style="color:#75715e">// å–æ¶ˆæ¯
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;</span> i <span style="color:#f92672">&lt;</span> bufferConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> i <span style="color:#f92672">&lt;</span> maxFilterMessageCount<span style="color:#f92672">;</span> i <span style="color:#f92672">+=</span> ConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">CQ_STORE_UNIT_SIZE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">long</span> offsetPy <span style="color:#f92672">=</span> bufferConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getByteBuffer</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getLong</span><span style="color:#f92672">();</span>
                        <span style="color:#66d9ef">int</span> sizePy <span style="color:#f92672">=</span> bufferConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">getByteBuffer</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">();</span>

                        <span style="color:#75715e">// æ ¹æ®æ¶ˆæ¯çš„åç§»é‡å’Œæ¶ˆæ¯çš„å¤§å°ä» CommitLog æ–‡ä»¶ä¸­å–å‡ºä¸€æ¡æ¶ˆæ¯
</span><span style="color:#75715e"></span>                        SelectMappedBufferResult selectResult <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commitLog</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(</span>offsetPy<span style="color:#f92672">,</span> sizePy<span style="color:#f92672">);</span>
                        getResult<span style="color:#f92672">.</span><span style="color:#a6e22e">addMessage</span><span style="color:#f92672">(</span>selectResult<span style="color:#f92672">);</span>
                        
                        status <span style="color:#f92672">=</span> GetMessageStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">FOUND</span><span style="color:#f92672">;</span>
                    <span style="color:#f92672">}</span>

                    <span style="color:#75715e">// å¢åŠ ä¸‹æ¬¡å¼€å§‹çš„åç§»é‡
</span><span style="color:#75715e"></span>                    nextBeginOffset <span style="color:#f92672">=</span> offset <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">/</span> ConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">CQ_STORE_UNIT_SIZE</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                    bufferConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">release</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å®¢æˆ·ç«¯å’Œ Broker æœåŠ¡å™¨ç«¯å®Œæ•´æ‹‰å–æ¶ˆæ¯çš„æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/pull_message_from_broker.png" alt="å®¢æˆ·ç«¯å’Œ Broker æœåŠ¡å™¨ç«¯å®Œæ•´æ‹‰å–æ¶ˆæ¯çš„æµç¨‹å›¾"></p>
<h2 id="å…­æ¶ˆè´¹æ¶ˆæ¯">å…­ã€æ¶ˆè´¹æ¶ˆæ¯</h2>
<p>ä¾èµ–äºç”¨æˆ·æŒ‡å®šçš„æ¶ˆæ¯å›è°ƒå‡½æ•°çš„ä¸åŒï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹åˆ†ä¸ºä¸¤ç§: <strong>å¹¶å‘æ¶ˆè´¹</strong>å’Œ<strong>æœ‰åºæ¶ˆè´¹</strong>ã€‚</p>
<p>å¹¶å‘æ¶ˆè´¹æ²¡æœ‰è€ƒè™‘æ¶ˆæ¯å‘é€çš„é¡ºåºï¼Œå®¢æˆ·ç«¯ä»æœåŠ¡å™¨è·å–åˆ°æ¶ˆæ¯å°±ä¼šç›´æ¥å›è°ƒç»™ç”¨æˆ·ã€‚è€Œæœ‰åºæ¶ˆè´¹ä¼šè€ƒè™‘æ¯ä¸ªé˜Ÿåˆ—æ¶ˆæ¯å‘é€çš„é¡ºåºï¼Œæ³¨æ„æ­¤å¤„å¹¶ä¸æ˜¯æ¯ä¸ªè¯é¢˜æ¶ˆæ¯å‘é€çš„é¡ºåºï¼Œä¸€å®šè¦è®°ä½ RocketMQ æ§åˆ¶æ¶ˆæ¯çš„æœ€ç»†ç²’åº¦æ˜¯<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚å½“æˆ‘ä»¬è®²æœ‰åºæ¶ˆè´¹çš„æ—¶å€™ï¼Œå°±æ˜¯åœ¨è¯´å¯¹äºæŸä¸ªè¯é¢˜çš„æŸä¸ªé˜Ÿåˆ—ï¼Œå‘å¾€è¿™ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯æ¥å—æ¶ˆæ¯çš„é¡ºåºä¸å‘é€çš„é¡ºåºå®Œå…¨ä¸€è‡´ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«çœ‹è¿™ä¸¤ç§æ¶ˆè´¹æ¨¡å¼æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<h3 id="1-å¹¶å‘æ¶ˆè´¹">(1) å¹¶å‘æ¶ˆè´¹</h3>
<p>å½“ç”¨æˆ·æ³¨å†Œæ¶ˆæ¯å›è°ƒç±»çš„æ—¶å€™ï¼Œå¦‚æœæ³¨å†Œçš„æ˜¯ <code>MessageListenerConcurrently</code> å›è°ƒç±»ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºç”¨æˆ·ä¸å…³å¿ƒæ¶ˆæ¯çš„é¡ºåºé—®é¢˜ã€‚æˆ‘ä»¬åœ¨ä¸Šæ–‡æåˆ°è¿‡æ¯ä¸ª <code>PullRequest</code> éƒ½å…³è”äº†ä¸€ä¸ªå¤„ç†é˜Ÿåˆ— <code>ProcessQueue</code>ï¼Œè€Œæ¯ä¸ªå¤„ç†é˜Ÿåˆ—åˆéƒ½å…³è”äº†ä¸€é¢—æ¶ˆæ¯æ ‘ <code>msgTreeMap</code>ã€‚å½“å®¢æˆ·ç«¯æ‹‰å–åˆ°æ–°çš„æ¶ˆæ¯ä»¥åï¼Œå…¶å…ˆå°†æ¶ˆæ¯æ”¾å…¥åˆ°è¿™ä¸ªè¯·æ±‚æ‰€å…³è”çš„å¤„ç†é˜Ÿåˆ—çš„æ¶ˆæ¯æ ‘ä¸­ï¼Œç„¶åæäº¤ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è¯·æ±‚ï¼Œç”¨ä»¥å›è°ƒç”¨æˆ·ç«¯çš„ä»£ç æ¶ˆè´¹æ¶ˆæ¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMQPushConsumerImpl</span> <span style="color:#66d9ef">implements</span> MQConsumerInner <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pullMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> PullRequest pullRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        PullCallback pullCallback <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PullCallback<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onSuccess</span><span style="color:#f92672">(</span>PullResult pullResult<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pullResult <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getPullStatus</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">case</span> FOUND<span style="color:#f92672">:</span>
                            <span style="color:#75715e">// æ¶ˆæ¯æ”¾å…¥å¤„ç†é˜Ÿåˆ—çš„æ¶ˆæ¯æ ‘ä¸­
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">boolean</span> dispathToConsume <span style="color:#f92672">=</span> processQueue
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">putMessage</span><span style="color:#f92672">(</span>pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgFoundList</span><span style="color:#f92672">());</span>

                            <span style="color:#75715e">// æäº¤ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è¯·æ±‚
</span><span style="color:#75715e"></span>                            DefaultMQPushConsumerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">consumeMessageService</span>
                                <span style="color:#f92672">.</span><span style="color:#a6e22e">submitConsumeRequest</span><span style="color:#f92672">(</span>
                                                      pullResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgFoundList</span><span style="color:#f92672">(),</span>
                                                      processQueue<span style="color:#f92672">,</span>
                                                      pullRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">(),</span>
                                                      dispathToConsume<span style="color:#f92672">);</span>
                            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

            <span style="color:#f92672">};</span>

    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“æäº¤ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è¯·æ±‚åï¼Œå¯¹äº<strong>å¹¶å‘æ¶ˆè´¹</strong>ï¼Œå…¶å®ç°å¦‚ä¸‹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeMessageConcurrentlyService</span> <span style="color:#66d9ef">implements</span> ConsumeMessageService <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeRequest</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            status <span style="color:#f92672">=</span> listener<span style="color:#f92672">.</span><span style="color:#a6e22e">consumeMessage</span><span style="color:#f92672">(</span>Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">unmodifiableList</span><span style="color:#f92672">(</span>msgs<span style="color:#f92672">),</span> context<span style="color:#f92672">);</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>msgs</code> æ˜¯ç›´æ¥ä»æœåŠ¡å™¨ç«¯æ‹¿åˆ°çš„æœ€æ–°æ¶ˆæ¯ï¼Œç›´æ¥å–‚ç»™äº†å®¢æˆ·ç«¯è¿›è¡Œæ¶ˆè´¹ï¼Œå¹¶æœªåšä»»ä½•æœ‰åºå¤„ç†ã€‚å½“æ¶ˆè´¹æˆåŠŸåï¼Œä¼šä»æ¶ˆæ¯æ ‘ä¸­å°†è¿™äº›æ¶ˆæ¯å†ç»™åˆ é™¤æ‰:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeMessageConcurrentlyService</span> <span style="color:#66d9ef">implements</span> ConsumeMessageService <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processConsumeResult</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ConsumeConcurrentlyStatus status<span style="color:#f92672">,</span> <span style="color:#75715e">/** å…¶å®ƒå‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ä»æ¶ˆæ¯æ ‘ä¸­åˆ é™¤æ¶ˆæ¯
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">long</span> offset <span style="color:#f92672">=</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">removeMessage</span><span style="color:#f92672">(</span>consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>offset <span style="color:#f92672">&gt;=</span> 0 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getProcessQueue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isDropped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getOffsetStore</span><span style="color:#f92672">()</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">updateOffset</span><span style="color:#f92672">(</span>consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageQueue</span><span style="color:#f92672">(),</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/consume_message_service.png" alt="å¹¶å‘æ¶ˆè´¹"></p>
<h3 id="2-æœ‰åºæ¶ˆè´¹">(2) æœ‰åºæ¶ˆè´¹</h3>
<p>RocketMQ çš„æœ‰åºæ¶ˆè´¹ä¸»è¦ä¾é <strong>ä¸¤æŠŠé”</strong>ï¼Œä¸€æŠŠæ˜¯ç»´æŠ¤åœ¨ Broker ç«¯ï¼Œä¸€æŠŠç»´æŠ¤åœ¨æ¶ˆè´¹è€…å®¢æˆ·ç«¯ã€‚Broker ç«¯æœ‰ä¸€ä¸ª <code>RebalanceLockManager</code> æœåŠ¡ï¼Œå…¶å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª <code>mqLockTable</code> æ¶ˆæ¯é˜Ÿåˆ—é”è¡¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RebalanceLockManager</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ConcurrentMap<span style="color:#f92672">&lt;</span>String<span style="color:#75715e">/* group */</span><span style="color:#f92672">,</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">,</span> LockEntry<span style="color:#f92672">&gt;&gt;</span> mqLockTable <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">,</span> LockEntry<span style="color:#f92672">&gt;&gt;(</span>1024<span style="color:#f92672">);</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨æœ‰åºæ¶ˆè´¹çš„æ—¶å€™ï¼ŒBroker éœ€è¦ç¡®ä¿ä»»ä½•ä¸€ä¸ªé˜Ÿåˆ—åœ¨ä»»ä½•æ—¶å€™éƒ½åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åœ¨æ¶ˆè´¹å®ƒï¼Œéƒ½åœ¨è¢«ä¸€ä¸ªå®¢æˆ·ç«¯æ‰€é”å®šã€‚å½“å®¢æˆ·ç«¯åœ¨æœ¬åœ°æ ¹æ®æ¶ˆæ¯é˜Ÿåˆ—æ„å»º <code>PullRequest</code> ä¹‹å‰ï¼Œä¼šä¸ Broker æ²Ÿé€šå°è¯•é”å®šè¿™ä¸ªé˜Ÿåˆ—ï¼Œå¦å¤–å½“è¿›è¡Œæœ‰åºæ¶ˆè´¹çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¹Ÿä¼šå‘¨æœŸæ€§åœ° (é»˜è®¤æ˜¯ 20 ç§’) é”å®šæ‰€æœ‰å½“å‰éœ€è¦æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeMessageOrderlyService</span> <span style="color:#66d9ef">implements</span> ConsumeMessageService <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>MessageModel<span style="color:#f92672">.</span><span style="color:#a6e22e">CLUSTERING</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>ConsumeMessageOrderlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageModel</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduledExecutorService</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    <span style="color:#a6e22e">@Override</span>
                    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                        ConsumeMessageOrderlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lockMQPeriodically</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">},</span> 1000 <span style="color:#f92672">*</span> 1<span style="color:#f92672">,</span> ProcessQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">REBALANCE_LOCK_INTERVAL</span><span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ç”±ä¸Šè¿°è¿™æ®µä»£ç ä¹Ÿèƒ½çœ‹å‡ºï¼Œåªåœ¨é›†ç¾¤æ¨¡å¼ä¸‹æ‰ä¼šå‘¨æœŸæ€§åœ°é”å®š Broker ç«¯çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå› æ­¤åœ¨<strong>å¹¿æ’­æ¨¡å¼ä¸‹æ˜¯ä¸æ”¯æŒè¿›è¡Œæœ‰åºæ¶ˆè´¹çš„</strong>ã€‚</p>
<p>è€Œåœ¨ Broker è¿™ç«¯ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯æ‰€é”å®šçš„æ¶ˆæ¯é˜Ÿåˆ—å¯¹åº”çš„é”é¡¹ <code>LogEntry</code> æœ‰ä¸€ä¸ªä¸Šæ¬¡é”å®šæ—¶çš„æ—¶é—´æˆ³ï¼Œå½“è¶…è¿‡é”çš„è¶…æ—¶æ—¶é—´ (é»˜è®¤æ˜¯ 60 ç§’) åï¼Œä¹Ÿä¼šåˆ¤å®šè¿™ä¸ªå®¢æˆ·ç«¯å·²ç»ä¸å†æŒæœ‰è¿™æŠŠé”ï¼Œä»¥è®©å…¶ä»–å®¢æˆ·ç«¯èƒ½å¤Ÿæœ‰åºæ¶ˆè´¹è¿™ä¸ªé˜Ÿåˆ—ã€‚</p>
<p>åœ¨å‰é¢æˆ‘ä»¬è¯´åˆ°è¿‡ <code>RebalanceService</code> å‡è¡¡æœåŠ¡ä¼šå®šæ—¶åœ°ä¾æ®ä¸åŒæ¶ˆè´¹è€…æ•°é‡åˆ†é…æ¶ˆè´¹é˜Ÿåˆ—ã€‚æˆ‘ä»¬å‡è®¾ Consumer-1 æ¶ˆè´¹è€…å®¢æˆ·ç«¯ä¸€å¼€å§‹éœ€è¦æ¶ˆè´¹ 3 ä¸ªæ¶ˆè´¹é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ—¶å€™åˆåŠ å…¥äº† Consumer-2 æ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”åˆ†é…åˆ°äº† MessageQueue-2 æ¶ˆè´¹é˜Ÿåˆ—ã€‚å½“ Consumer-1 å†…éƒ¨çš„å‡è¡¡æœåŠ¡æ£€æµ‹åˆ°å½“å‰æ¶ˆè´¹é˜Ÿåˆ—éœ€è¦ç§»é™¤ MessageQueue-2 é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¼šé¦–å…ˆè§£é™¤ Broker ç«¯çš„é”ï¼Œç¡®ä¿æ–°åŠ å…¥çš„ Consumer-2 æ¶ˆè´¹è€…å®¢æˆ·ç«¯èƒ½å¤ŸæˆåŠŸé”ä½è¿™ä¸ªé˜Ÿåˆ—ï¼Œä»¥è¿›è¡Œæœ‰åºæ¶ˆè´¹ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RebalanceImpl</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">updateProcessQueueTableInRebalance</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String topic<span style="color:#f92672">,</span>
                                                       <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">&gt;</span> mqSet<span style="color:#f92672">,</span>
                                                       <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> isOrder<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>it<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mq<span style="color:#f92672">.</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>topic<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å½“å‰å®¢æˆ·ç«¯ä¸éœ€è¦å¤„ç†è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—äº†
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>mqSet<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>mq<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                    pq<span style="color:#f92672">.</span><span style="color:#a6e22e">setDropped</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    <span style="color:#75715e">// è§£é”
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">removeUnnecessaryMessageQueue</span><span style="color:#f92672">(</span>mq<span style="color:#f92672">,</span> pq<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>

                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/remove_unnessary_message_queue.png" alt="æœ‰åºæ¶ˆè´¹åŠ é”"></p>
<p>æ¶ˆè´¹è€…å®¢æˆ·ç«¯æ¯ä¸€æ¬¡æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼Œå¦‚æœæœ‰å‘ç°æ–°çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆéƒ½ä¼šå°†è¿™äº›æ¶ˆæ¯å°è£…ä¸º <code>ConsumeRequest</code> æ¥å–‚ç»™æ¶ˆè´¹çº¿ç¨‹æ± ï¼Œä»¥å¾…æ¶ˆè´¹ã€‚å¦‚æœæ¶ˆæ¯ç‰¹åˆ«å¤šï¼Œè¿™æ ·ä¸€ä¸ªé˜Ÿåˆ—å¯èƒ½æœ‰å¤šä¸ªæ¶ˆè´¹è¯·æ±‚æ­£åœ¨ç­‰å¾…å®¢æˆ·ç«¯æ¶ˆè´¹ï¼Œç”¨æˆ·å¯èƒ½ä¼šå…ˆæ¶ˆè´¹åç§»é‡å¤§çš„æ¶ˆæ¯ï¼Œåæ¶ˆè´¹åç§»é‡å°çš„æ¶ˆæ¯ã€‚æ‰€ä»¥æ¶ˆè´¹åŒä¸€é˜Ÿåˆ—çš„æ—¶å€™ï¼Œéœ€è¦ä¸€æŠŠé”ä»¥æ¶ˆè´¹è¯·æ±‚é¡ºåºåŒ–:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeMessageOrderlyService</span> <span style="color:#66d9ef">implements</span> ConsumeMessageService <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeRequest</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> Object objLock <span style="color:#f92672">=</span> messageQueueLock<span style="color:#f92672">.</span><span style="color:#a6e22e">fetchLockObject</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageQueue</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>objLock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/message_order_consume.png" alt="æœ‰åºæ¶ˆè´¹é”"></p>
<p>RocketMQ çš„æ¶ˆæ¯æ ‘æ˜¯ç”¨ <code>TreeMap</code> å®ç°çš„ï¼Œå…¶å†…éƒ¨åŸºäºæ¶ˆæ¯åç§»é‡ç»´æŠ¤äº†æ¶ˆæ¯çš„æœ‰åºæ€§ã€‚æ¯æ¬¡æ¶ˆè´¹è¯·æ±‚éƒ½ä¼šä»<strong>æ¶ˆæ¯æ ‘ä¸­æ‹¿å–</strong>åç§»é‡æœ€å°çš„å‡ æ¡æ¶ˆæ¯ (é»˜è®¤ä¸º 1 æ¡)ç»™ç”¨æˆ·ï¼Œä»¥æ­¤æ¥è¾¾åˆ°æœ‰åºæ¶ˆè´¹çš„ç›®çš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeMessageOrderlyService</span> <span style="color:#66d9ef">implements</span> ConsumeMessageService <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeRequest</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> consumeBatchSize <span style="color:#f92672">=</span>
                ConsumeMessageOrderlyService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumeMessageBatchMaxSize</span><span style="color:#f92672">();</span>
            List<span style="color:#f92672">&lt;</span>MessageExt<span style="color:#f92672">&gt;</span> msgs <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">processQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">takeMessags</span><span style="color:#f92672">(</span>consumeBatchSize<span style="color:#f92672">);</span>
            
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/order_take_message.png" alt="æœ‰åºæ¶ˆè´¹æ ‘"></p>
<p>æ‰«æä¸‹é¢äºŒç»´ç ï¼Œåœ¨æ‰‹æœºç«¯é˜…è¯»ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-receive-flow/qrcode.png" alt=""></p>

<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€æ¶ˆè´¹è€…æ³¨å†Œ">ä¸€ã€æ¶ˆè´¹è€…æ³¨å†Œ</a></li>
    <li><a href="#äºŒæ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡">äºŒã€æ¶ˆæ¯é˜Ÿåˆ—è´Ÿè½½å‡è¡¡</a>
      <ul>
        <li><a href="#1-å¹¿æ’­æ¨¡å¼">(1) å¹¿æ’­æ¨¡å¼</a></li>
        <li><a href="#2-é›†ç¾¤æ¨¡å¼">(2) é›†ç¾¤æ¨¡å¼</a></li>
      </ul>
    </li>
    <li><a href="#ä¸‰broker-æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶">ä¸‰ã€Broker æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶</a></li>
    <li><a href="#å››æ¶ˆæ¯é˜Ÿåˆ—åç§»é‡">å››ã€æ¶ˆæ¯é˜Ÿåˆ—åç§»é‡</a>
      <ul>
        <li><a href="#1-é›†ç¾¤æ¨¡å¼">(1) é›†ç¾¤æ¨¡å¼</a></li>
        <li><a href="#2-å¹¿æ’­æ¨¡å¼">(2) å¹¿æ’­æ¨¡å¼</a></li>
      </ul>
    </li>
    <li><a href="#äº”æ‹‰å–æ¶ˆæ¯">äº”ã€æ‹‰å–æ¶ˆæ¯</a></li>
    <li><a href="#å…­æ¶ˆè´¹æ¶ˆæ¯">å…­ã€æ¶ˆè´¹æ¶ˆæ¯</a>
      <ul>
        <li><a href="#1-å¹¶å‘æ¶ˆè´¹">(1) å¹¶å‘æ¶ˆè´¹</a></li>
        <li><a href="#2-æœ‰åºæ¶ˆè´¹">(2) æœ‰åºæ¶ˆè´¹</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>



</html>












