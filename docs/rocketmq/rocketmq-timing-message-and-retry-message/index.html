<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯"><meta property="og:title" content="RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯" />
<meta property="og:description" content="RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯ è®²è¿° RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯
ä¸€ã€å®šæ—¶æ¶ˆæ¯æ¦‚è¿° RocketMQ æ”¯æŒ Producer ç«¯å‘é€å®šæ—¶æ¶ˆæ¯ï¼Œå³è¯¥æ¶ˆæ¯è¢«å‘é€ä¹‹åï¼Œåˆ°ä¸€æ®µæ—¶é—´ä¹‹åæ‰èƒ½è¢« Consumer æ¶ˆè´¹è€…ç«¯æ¶ˆè´¹ã€‚ä½†æ˜¯å½“å‰å¼€æºç‰ˆæœ¬çš„ RocketMQ æ‰€æ”¯æŒçš„å®šæ—¶æ—¶é—´æ˜¯æœ‰é™çš„ã€ä¸åŒçº§åˆ«çš„ç²¾åº¦çš„æ—¶é—´ï¼Œå¹¶ä¸æ˜¯ä»»æ„æ— é™åˆ¶çš„å®šæ—¶æ—¶é—´ã€‚å› æ­¤åœ¨æ¯æ¡æ¶ˆæ¯ä¸Šè®¾ç½®å®šæ—¶æ—¶é—´çš„ API å«åš setDelayTimeLevelï¼Œè€Œé setDelayTime è¿™æ ·çš„å‘½å:
Message msg = new Message(&#34;TopicTest&#34; /* Topic */, &#34;TagA&#34; /* Tag */, (&#34;Hello RocketMQ &#34; &#43; i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */); msg.setDelayTimeLevel(i &#43; 1); é»˜è®¤ Broker æœåŠ¡å™¨ç«¯æœ‰ 18 ä¸ªå®šæ—¶çº§åˆ«:
public class MessageStoreConfig { private String messageDelayLevel = &#34;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&#34;; } è¿™ 18 ä¸ªå®šæ—¶çº§åˆ«åœ¨æœåŠ¡å™¨ç«¯å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè¢«è§£æå¹¶æ”¾ç½®åˆ°è¡¨ delayLevelTable ä¸­ã€‚è§£æçš„è¿‡ç¨‹å°±æ˜¯ä¸Šè¿°å­—ç¬¦ä¸²æŒ‰ç…§ç©ºæ ¼æ‹†åˆ†å¼€ï¼Œç„¶åæ ¹æ®æ—¶é—´å•ä½çš„ä¸åŒå†è¿›ä¸€æ­¥è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ¯«ç§’æ—¶é—´ã€‚çº§åˆ«å°±æ˜¯æ ¹æ®è¿™äº›æ¯«ç§’æ—¶é—´çš„é¡ºåºè€Œç¡®å®šçš„ï¼Œä¾‹å¦‚ä¸Šè¿° 1s å»¶è¿Ÿå°±æ˜¯çº§åˆ« 1ï¼Œ 5s å»¶è¿Ÿå°±æ˜¯çº§åˆ« 2ï¼Œä»¥æ­¤ç±»æ¨:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/rocketmq/rocketmq-timing-message-and-retry-message/" />

<title>RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯ | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.215f2c356498a041f9de3ebaab0d56c45dd9a6292b641970f0f751a7bcec3c63.css" integrity="sha256-IV8sNWSYoEH53j66qw1WxF3ZpikrZBlw8PdRp7zsPGM=">


<script defer src="/en.search.min.49ce351a2b99d886c52282fa6dfd56d0adda82958da49fbf310ed19b20a683fe.js" integrity="sha256-Sc41GiuZ2IbFIoL6bf1W0K3agpWNpJ&#43;/MQ7RmyCmg/4="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      ğŸ‘‰æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-send-message-flow/" >
      RocketMQ æ¶ˆæ¯å‘é€æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-store-flow/" >
      RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-receive-flow/" >
      RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-filter-flow/" >
      RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-indexing-flow/" >
      RocketMQ æ¶ˆæ¯ç´¢å¼•æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-timing-message-and-retry-message/"  class="active">
      RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-master-slave-sync/" >
      RocketMQ ä¸»å¤‡åŒæ­¥
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€å®šæ—¶æ¶ˆæ¯æ¦‚è¿°">ä¸€ã€å®šæ—¶æ¶ˆæ¯æ¦‚è¿°</a></li>
    <li><a href="#äºŒå®šæ—¶æ¶ˆæ¯é¢„å­˜å‚¨">äºŒã€å®šæ—¶æ¶ˆæ¯é¢„å­˜å‚¨</a></li>
    <li><a href="#ä¸‰å®šæ—¶æ¶ˆæ¯å†å­˜å‚¨">ä¸‰ã€å®šæ—¶æ¶ˆæ¯å†å­˜å‚¨</a></li>
    <li><a href="#å››æ¶ˆæ¯é‡è¯•æ¦‚è¿°">å››ã€æ¶ˆæ¯é‡è¯•æ¦‚è¿°</a></li>
    <li><a href="#äº”producer-æ¶ˆæ¯å‘é€é‡è¯•">äº”ã€Producer æ¶ˆæ¯å‘é€é‡è¯•</a></li>
    <li><a href="#å…­consumer-æ¶ˆæ¯æ¥å—é‡è¯•">å…­ã€Consumer æ¶ˆæ¯æ¥å—é‡è¯•</a>
      <ul>
        <li><a href="#1-è®¢é˜…é‡è¯•è¯é¢˜">(1) è®¢é˜…é‡è¯•è¯é¢˜</a></li>
        <li><a href="#2-å¤±è´¥æ¶ˆæ¯å‘å¾€é‡è¯•è¯é¢˜">(2) å¤±è´¥æ¶ˆæ¯å‘å¾€é‡è¯•è¯é¢˜</a></li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown"><h1 id="rocketmq-å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯">RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯</h1>
<p>è®²è¿° RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯</p>
<h2 id="ä¸€å®šæ—¶æ¶ˆæ¯æ¦‚è¿°">ä¸€ã€å®šæ—¶æ¶ˆæ¯æ¦‚è¿°</h2>
<p>RocketMQ æ”¯æŒ Producer ç«¯å‘é€å®šæ—¶æ¶ˆæ¯ï¼Œå³è¯¥æ¶ˆæ¯è¢«å‘é€ä¹‹åï¼Œåˆ°ä¸€æ®µæ—¶é—´ä¹‹åæ‰èƒ½è¢« Consumer æ¶ˆè´¹è€…ç«¯æ¶ˆè´¹ã€‚ä½†æ˜¯å½“å‰å¼€æºç‰ˆæœ¬çš„ RocketMQ æ‰€æ”¯æŒçš„å®šæ—¶æ—¶é—´æ˜¯<strong>æœ‰é™çš„ã€ä¸åŒçº§åˆ«çš„ç²¾åº¦</strong>çš„æ—¶é—´ï¼Œå¹¶ä¸æ˜¯ä»»æ„æ— é™åˆ¶çš„å®šæ—¶æ—¶é—´ã€‚å› æ­¤åœ¨æ¯æ¡æ¶ˆæ¯ä¸Šè®¾ç½®å®šæ—¶æ—¶é—´çš„ API å«åš <code>setDelayTimeLevel</code>ï¼Œè€Œé <code>setDelayTime</code> è¿™æ ·çš„å‘½å:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Message msg <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">new</span> Message<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;TopicTest&#34;</span> <span style="color:#75715e">/* Topic */</span><span style="color:#f92672">,</span>
                <span style="color:#e6db74">&#34;TagA&#34;</span> <span style="color:#75715e">/* Tag */</span><span style="color:#f92672">,</span>
                <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello RocketMQ &#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span>RemotingHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_CHARSET</span><span style="color:#f92672">)</span> <span style="color:#75715e">/* Message body */</span><span style="color:#f92672">);</span>
msg<span style="color:#f92672">.</span><span style="color:#a6e22e">setDelayTimeLevel</span><span style="color:#f92672">(</span>i <span style="color:#f92672">+</span> 1<span style="color:#f92672">);</span>
</code></pre></div><p>é»˜è®¤ Broker æœåŠ¡å™¨ç«¯æœ‰ 18 ä¸ªå®šæ—¶çº§åˆ«:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageStoreConfig</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> String messageDelayLevel <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&#34;</span><span style="color:#f92672">;</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>è¿™ 18 ä¸ªå®šæ—¶çº§åˆ«åœ¨æœåŠ¡å™¨ç«¯å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè¢«è§£æå¹¶æ”¾ç½®åˆ°è¡¨ <code>delayLevelTable</code> ä¸­ã€‚è§£æçš„è¿‡ç¨‹å°±æ˜¯ä¸Šè¿°å­—ç¬¦ä¸²æŒ‰ç…§ç©ºæ ¼æ‹†åˆ†å¼€ï¼Œç„¶åæ ¹æ®æ—¶é—´å•ä½çš„ä¸åŒå†è¿›ä¸€æ­¥è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ¯«ç§’æ—¶é—´ã€‚çº§åˆ«å°±æ˜¯æ ¹æ®è¿™äº›æ¯«ç§’æ—¶é—´çš„é¡ºåºè€Œç¡®å®šçš„ï¼Œä¾‹å¦‚ä¸Šè¿° 1s å»¶è¿Ÿå°±æ˜¯çº§åˆ« 1ï¼Œ 5s å»¶è¿Ÿå°±æ˜¯çº§åˆ« 2ï¼Œä»¥æ­¤ç±»æ¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScheduleMessageService</span> <span style="color:#66d9ef">extends</span> ConfigManager <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">parseDelayLevel</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> levelArray<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                
            <span style="color:#66d9ef">int</span> level <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> 1<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">long</span> delayTimeMillis <span style="color:#f92672">=</span> tu <span style="color:#f92672">*</span> num<span style="color:#f92672">;</span>

            <span style="color:#75715e">// çº§åˆ«:å»¶è¿Ÿæ—¶é—´
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delayLevelTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>level<span style="color:#f92672">,</span> delayTimeMillis<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="äºŒå®šæ—¶æ¶ˆæ¯é¢„å­˜å‚¨">äºŒã€å®šæ—¶æ¶ˆæ¯é¢„å­˜å‚¨</h2>
<p>å®¢æˆ·ç«¯åœ¨ä¸ºæŸæ¡æ¶ˆæ¯è®¾ç½®ä¸Šå®šæ—¶çº§åˆ«çš„æ—¶å€™ï¼Œå®é™…ä¸Šçº§åˆ«è¿™ä¸ªå­—æ®µä¼šè¢«ä½œä¸º<strong>é™„å±å±æ€§</strong>æ”¾åˆ°æ¶ˆæ¯ä¸­:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Message</span> <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setDelayTimeLevel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> level<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putProperty</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_DELAY_TIME_LEVEL</span><span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>level<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æˆ‘ä»¬<a href="/docs/rocketmq/rocketmq-message-store-flow/">å…ˆå‰çš„æ–‡ç« </a>æåˆ°è¿‡ï¼Œå‘é€åˆ° Broker æœåŠ¡å™¨çš„æ¶ˆæ¯ä¼šè¢«å­˜å‚¨åˆ° <code>CommitLog</code> æ¶ˆæ¯æ–‡ä»¶ä¸­ã€‚é‚£ä¹ˆåœ¨æ­¤å¤„å³ä½¿æ˜¯å®šæ—¶æ¶ˆæ¯ä¹Ÿä¸ä¾‹å¤–ï¼Œå°†å®šæ—¶æ¶ˆæ¯å­˜å‚¨ä¸‹æ¥æ˜¯ä¸ºäº†<strong>ä¿è¯æ¶ˆæ¯æœ€å¤§ç¨‹åº¦åœ°ä¸ä¸¢å¤±</strong>ã€‚ç„¶è€Œæ¯•ç«Ÿå’Œæ™®é€šæ¶ˆæ¯ä¸åŒï¼Œåœ¨é‡åˆ°å®šæ—¶æ¶ˆæ¯åï¼Œ<code>CommitLog</code> ä¼šå°†è¿™æ¡æ¶ˆæ¯çš„è¯é¢˜å’Œé˜Ÿåˆ— ID <strong>æ›¿æ¢</strong>æˆä¸“é—¨ç”¨äºå®šæ—¶çš„è¯é¢˜å’Œç›¸åº”çš„çº§åˆ«å¯¹åº”çš„é˜Ÿåˆ— IDã€‚çœŸå®çš„è¯é¢˜å’Œé˜Ÿåˆ— ID ä¼šä½œä¸ºå±æ€§æ”¾ç½®åˆ°è¿™æ¡æ¶ˆæ¯ä¸­ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLog</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> PutMessageResult <span style="color:#a6e22e">putMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MessageExtBrokerInner msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">// Delay Delivery
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getDelayTimeLevel</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

            topic <span style="color:#f92672">=</span> ScheduleMessageService<span style="color:#f92672">.</span><span style="color:#a6e22e">SCHEDULE_TOPIC</span><span style="color:#f92672">;</span>
            queueId <span style="color:#f92672">=</span> ScheduleMessageService<span style="color:#f92672">.</span><span style="color:#a6e22e">delayLevel2QueueId</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getDelayTimeLevel</span><span style="color:#f92672">());</span>

            <span style="color:#75715e">// Backup real topic, queueId
</span><span style="color:#75715e"></span>            MessageAccessor<span style="color:#f92672">.</span><span style="color:#a6e22e">putProperty</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_REAL_TOPIC</span><span style="color:#f92672">,</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">());</span>
            MessageAccessor<span style="color:#f92672">.</span><span style="color:#a6e22e">putProperty</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_REAL_QUEUE_ID</span><span style="color:#f92672">,</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getQueueId</span><span style="color:#f92672">()));</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">setPropertiesString</span><span style="color:#f92672">(</span>MessageDecoder<span style="color:#f92672">.</span><span style="color:#a6e22e">messageProperties2String</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperties</span><span style="color:#f92672">()));</span>

            <span style="color:#75715e">// æ›¿æ¢ Topic å’Œ QueueID
</span><span style="color:#75715e"></span>            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">setTopic</span><span style="color:#f92672">(</span>topic<span style="color:#f92672">);</span>
            msg<span style="color:#f92672">.</span><span style="color:#a6e22e">setQueueId</span><span style="color:#f92672">(</span>queueId<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>éšåï¼Œè¿™æ¡æ¶ˆæ¯ä¼šè¢«å­˜å‚¨åœ¨ <code>CommitLog</code> æ¶ˆæ¯æ–‡ä»¶ä¸­ã€‚è€Œæˆ‘ä»¬çŸ¥é“åå°<strong>é‡æ”¾æ¶ˆæ¯æœåŠ¡</strong> <code>ReputMessageService</code> ä¼šä¸€ç›´ç›‘ç£ <code>CommitLog</code> æ–‡ä»¶æ˜¯å¦æ·»åŠ äº†æ–°çš„æ¶ˆæ¯ã€‚å½“æœ‰äº†æ–°çš„æ¶ˆæ¯åï¼Œé‡æ”¾æ¶ˆæ¯æœåŠ¡ä¼šå–å‡ºæ¶ˆæ¯å¹¶å°è£…ä¸º <code>DispatchRequest</code> è¯·æ±‚ï¼Œç„¶åå°†å…¶åˆ†å‘ç»™ä¸åŒçš„ä¸‰ä¸ªåˆ†å‘æœåŠ¡ï¼Œ<strong>å»ºç«‹æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶æœåŠ¡</strong>å°±æ˜¯è¿™å…¶ä¸­ä¹‹ä¸€ã€‚è€Œæ­¤å¤„å½“å–æ¶ˆæ¯å°è£…ä¸º <code>DispatchRequest</code> çš„æ—¶å€™ï¼Œå½“é‡åˆ°å®šæ—¶æ¶ˆæ¯æ—¶ï¼Œåˆå¤šåšäº†ä¸€äº›é¢å¤–çš„äº‹æƒ…ã€‚</p>
<p>å½“é‡è§å®šæ—¶æ¶ˆæ¯æ—¶ï¼Œ<code>CommitLog</code> <strong>è®¡ç®— <code>tagsCode</code> æ ‡ç­¾ç ä¸æ™®é€šæ¶ˆæ¯ä¸åŒ</strong>ã€‚å¯¹äºå®šæ—¶æ¶ˆæ¯ï¼Œ<code>tagsCode</code> å€¼è®¾ç½®çš„æ˜¯è¿™æ¡æ¶ˆæ¯çš„æŠ•é€’æ—¶é—´ï¼Œå³å»ºç«‹æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶çš„æ—¶å€™ï¼Œæ–‡ä»¶ä¸­çš„ <code>tagsCode</code> å­˜å‚¨çš„æ˜¯è¿™æ¡æ¶ˆæ¯æœªæ¥åœ¨ä»€ä¹ˆæ—¶å€™è¢«æŠ•é€’:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLog</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> DispatchRequest <span style="color:#a6e22e">checkMessageAndReturnSize</span><span style="color:#f92672">(</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">nio</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ByteBuffer</span> byteBuffer<span style="color:#f92672">,</span>
                                                     <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> checkCRC<span style="color:#f92672">,</span>
                                                     <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> readBody<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Timing message processing
</span><span style="color:#75715e"></span>        <span style="color:#f92672">{</span>
            String t <span style="color:#f92672">=</span> propertiesMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_DELAY_TIME_LEVEL</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ScheduleMessageService<span style="color:#f92672">.</span><span style="color:#a6e22e">SCHEDULE_TOPIC</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>topic<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">int</span> delayLevel <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">parseInt</span><span style="color:#f92672">(</span>t<span style="color:#f92672">);</span>

                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delayLevel <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    tagsCode <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getScheduleMessageService</span><span style="color:#f92672">()</span>
                        <span style="color:#f92672">.</span><span style="color:#a6e22e">computeDeliverTimestamp</span><span style="color:#f92672">(</span>delayLevel<span style="color:#f92672">,</span>storeTimestamp<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å¦‚ä¸‹æ˜¯ï¼Œå‘é€äº† 10 æ¡å®šæ—¶çº§åˆ«åˆ†åˆ«ä¸º 1-10 çš„æ¶ˆæ¯ä»¥åï¼Œ<code>$HOME/store/consumequeue</code> æ–‡ä»¶ä¸‹çš„<strong>æ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶</strong>çš„åˆ†å¸ƒæƒ…å†µ:</p>
<p><img src="/images/docs/rocketmq/rocketmq-timing-message-and-retry-message/2018_04_09_11_48_04.png" alt="æ¶ˆè´¹é˜Ÿåˆ—çš„æ–‡ä»¶åˆ†å¸ƒ"></p>
<p>ä¸åŒçš„å®šæ—¶çº§åˆ«å¯¹åº”äºä¸åŒçš„é˜Ÿåˆ— IDï¼Œå®šæ—¶çº§åˆ«å‡ 1 å¾—åˆ°çš„å°±æ˜¯é˜Ÿåˆ— ID çš„å€¼ã€‚å› æ­¤çº§åˆ« 1-10 å¯¹åº”çš„æ˜¯ 0-9 çš„é˜Ÿåˆ— ID:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScheduleMessageService</span> <span style="color:#66d9ef">extends</span> ConfigManager <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">delayLevel2QueueId</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> delayLevel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> delayLevel <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="ä¸‰å®šæ—¶æ¶ˆæ¯å†å­˜å‚¨">ä¸‰ã€å®šæ—¶æ¶ˆæ¯å†å­˜å‚¨</h2>
<p>Broker å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå¼€å¯ä¸€ä¸ª<strong>è°ƒåº¦æ¶ˆæ¯æœåŠ¡</strong>ï¼Œæ­¤æœåŠ¡ä¼šç›‘æ§æ‰€æœ‰<strong>å®šæ—¶æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼Œæ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¼šåˆ›å»ºä¸€ä¸ªä¸“é—¨çš„<strong>å»¶æ—¶æ¶ˆæ¯æŠ•é€’ä»»åŠ¡</strong>ç”¨ä»¥åˆ°è¾¾è§„å®šæ—¶é—´åæŠ•é€’æ­¤æ¶ˆæ¯:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScheduleMessageService</span> <span style="color:#66d9ef">extends</span> ConfigManager <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delayLevelTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            Integer level <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
            Long timeDelay <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
            Long offset <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>level<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>timeDelay <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">timer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">schedule</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DeliverDelayedMessageTimerTask<span style="color:#f92672">(</span>level<span style="color:#f92672">,</span> offset<span style="color:#f92672">),</span> FIRST_DELAY_TIME<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æ¯ä¸ªæ¶ˆæ¯é˜Ÿé‡Œçš„æ¶ˆæ¯æŠ•é€’ä»»åŠ¡ï¼Œä¼šæ£€æŸ¥è‡ªå·±è·Ÿè¸ªçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶ä»æ­¤æ¶ˆæ¯é˜Ÿåˆ—æ‰€å¯¹åº”çš„<strong>å®šæ—¶çº§åˆ«çš„åç§»é‡</strong>ä¸­æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å®šæ—¶æ¶ˆæ¯åˆ°æ¥ã€‚å…¶ä¸­å®šæ—¶çº§åˆ«çš„åç§»é‡æ˜¯ç»´æŠ¤åœ¨å†…å­˜ä¸­çš„åç§»é‡è¡¨ <code>offsetTable</code> ä¸­ã€‚æ¯éš” 10 ç§’é’Ÿï¼Œè¿™ä¸ªè¡¨ä¼šè¢«æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šçš„ <code>delayOffset.json</code> æ–‡ä»¶ä¸­ä¸€æ¬¡:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScheduleMessageService</span> <span style="color:#66d9ef">extends</span> ConfigManager <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ConcurrentMap<span style="color:#f92672">&lt;</span>Integer <span style="color:#75715e">/* level */</span><span style="color:#f92672">,</span> Long<span style="color:#75715e">/* offset */</span><span style="color:#f92672">&gt;</span> offsetTable <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;(</span>32<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ¯éš” 10 ç§’é’ŸæŒä¹…åŒ–ä¸€æ¬¡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">timer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TimerTask<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                <span style="color:#a6e22e">@Override</span>
                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                    ScheduleMessageService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">persist</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">},</span>
            10000<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStoreConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getFlushDelayOffsetInterval</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><code>delayOffset.json</code> æ–‡ä»¶ä¸­å­˜å‚¨çš„ç¤ºä¾‹ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-timing-message-and-retry-message/2018_04_09_17_49_36.png" alt="å®šæ—¶åç§»é‡ç»´æŠ¤æ–‡ä»¶"></p>
<p><code>DeliverDelayedMessageTimerTask</code> ä»»åŠ¡ä¼šä»æ¶ˆè´¹ä»»åŠ¡é˜Ÿåˆ—æ–‡ä»¶ä¸­å–å‡ºæœ€æ–°çš„å®šæ—¶æ¶ˆæ¯çš„ <code>tagsCode</code> ï¼Œå¹¶è®¡ç®—å‡ºçš„å½“å‰æ˜¯å¦å·²ç»åˆ°äº†è¿™æ¡æ¶ˆæ¯æŠ•é€’çš„æ—¶é—´ã€‚å¦‚æœåˆ°äº†ï¼Œå³ <code>countdown &lt; 0</code>ï¼Œé‚£ä¹ˆä¾¿ä¼šä» <code>CommitLog</code> æ–‡ä»¶ä¸­å–å‡ºæ¶ˆæ¯ï¼Œä¿®æ­£æ¶ˆæ¯çš„è¯é¢˜å’Œé˜Ÿåˆ— ID ç­‰ä¿¡æ¯ï¼Œç„¶åé‡æ–°å­˜å‚¨æ­¤æ¡æ¶ˆæ¯ã€‚å¦‚æœè¿˜æ²¡æœ‰åˆ°ï¼Œé‚£ä¹ˆä¾¿ä¼šé‡æ–°æ‰§è¡Œä¸€ä¸ªå®šæ—¶æ—¶é—´è®¾ç½®ä¸º <code>countdown</code> æ¯«ç§’çš„å®šæ—¶ä»»åŠ¡ã€‚åœ¨å®Œæˆä¹‹åï¼Œä¼šæ›´æ–°å½“å‰çš„åç§»é‡è¡¨ï¼Œä¸ºä¸‹ä¸€æ¬¡åšå‡†å¤‡:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeliverDelayedMessageTimerTask</span> <span style="color:#66d9ef">extends</span> TimerTask <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">executeOnTimeup</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;</span> i <span style="color:#f92672">&lt;</span> bufferCQ<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">();</span> i <span style="color:#f92672">+=</span> ConsumeQueue<span style="color:#f92672">.</span><span style="color:#a6e22e">CQ_STORE_UNIT_SIZE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æ˜¯å¦åˆ°æ—¶é—´
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">long</span> countdown <span style="color:#f92672">=</span> deliverTimestamp <span style="color:#f92672">-</span> now<span style="color:#f92672">;</span>

            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>countdown <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// å–å‡ºæ¶ˆæ¯
</span><span style="color:#75715e"></span>                MessageExt msgExt <span style="color:#f92672">=</span>
                    ScheduleMessageService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lookMessageByOffset</span><span style="color:#f92672">(</span>offsetPy<span style="color:#f92672">,</span> sizePy<span style="color:#f92672">);</span>
                <span style="color:#75715e">// ä¿®æ­£æ¶ˆæ¯ï¼Œè®¾ç½®ä¸Šæ­£ç¡®çš„è¯é¢˜å’Œé˜Ÿåˆ— ID
</span><span style="color:#75715e"></span>                MessageExtBrokerInner msgInner <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageTimeup</span><span style="color:#f92672">(</span>msgExt<span style="color:#f92672">);</span>
                <span style="color:#75715e">// é‡æ–°å­˜å‚¨æ¶ˆæ¯
</span><span style="color:#75715e"></span>                PutMessageResult putMessageResult <span style="color:#f92672">=</span>
                    ScheduleMessageService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">putMessage</span><span style="color:#f92672">(</span>msgInner<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// countdown åæŠ•é€’æ­¤æ¶ˆæ¯
</span><span style="color:#75715e"></span>                ScheduleMessageService<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">timer</span>
                    <span style="color:#f92672">.</span><span style="color:#a6e22e">schedule</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DeliverDelayedMessageTimerTask<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">delayLevel</span><span style="color:#f92672">,</span> nextOffset<span style="color:#f92672">),</span> countdown<span style="color:#f92672">);</span>
                <span style="color:#75715e">// æ›´æ–°åç§»é‡
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#75715e">// end of for
</span><span style="color:#75715e"></span>
        <span style="color:#75715e">// æ›´æ–°åç§»é‡
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="å››æ¶ˆæ¯é‡è¯•æ¦‚è¿°">å››ã€æ¶ˆæ¯é‡è¯•æ¦‚è¿°</h2>
<p>æ¶ˆæ¯é‡è¯•åˆ†ä¸º<strong>æ¶ˆæ¯å‘é€é‡è¯•</strong>å’Œ<strong>æ¶ˆæ¯æ¥å—é‡è¯•</strong>ï¼Œæ¶ˆæ¯å‘é€é‡è¯•æ˜¯æŒ‡æ¶ˆæ¯ä» Producer ç«¯å‘é€åˆ° Broker æœåŠ¡å™¨çš„å¤±è´¥ä»¥åçš„é‡è¯•æƒ…å†µï¼Œæ¶ˆæ¯æ¥å—é‡è¯•æ˜¯æŒ‡ Consumer åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™å‡ºç°å¼‚å¸¸æˆ–è€…å¤±è´¥çš„é‡è¯•æƒ…å†µã€‚</p>
<p>Producer ç«¯é€šè¿‡é…ç½®å¦‚ä¸‹è¿™ä¸¤ä¸ªä¸¤ä¸ª API å¯ä»¥åˆ†åˆ«é…ç½®åœ¨<strong>åŒæ­¥å‘é€</strong>å’Œ<strong>å¼‚æ­¥å‘é€</strong>æ¶ˆæ¯å¤±è´¥çš„æ—¶å€™çš„é‡è¯•æ¬¡æ•°:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DefaultMQProducer producer <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">new</span> DefaultMQProducer<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;please_rename_unique_group_name&#34;</span><span style="color:#f92672">);</span>
producer<span style="color:#f92672">.</span><span style="color:#a6e22e">setRetryTimesWhenSendAsyncFailed</span><span style="color:#f92672">(</span>3<span style="color:#f92672">);</span>
producer<span style="color:#f92672">.</span><span style="color:#a6e22e">setRetryTimesWhenSendFailed</span><span style="color:#f92672">(</span>3<span style="color:#f92672">);</span>
</code></pre></div><p>Consumer ç«¯åœ¨æ¶ˆè´¹çš„æ—¶å€™ï¼Œå¦‚æœæ¥æ”¶æ¶ˆæ¯çš„å›è°ƒå‡½æ•°å‡ºç°äº†ä»¥ä¸‹å‡ ç§æƒ…å†µ:</p>
<ul>
<li>æŠ›å‡ºå¼‚å¸¸</li>
<li>è¿”å› <code>NULL</code> çŠ¶æ€</li>
<li>è¿”å› <code>RECONSUME_LATER</code> çŠ¶æ€</li>
<li>è¶…æ—¶ 15 åˆ†é’Ÿæ²¡æœ‰å“åº”</li>
</ul>
<p>é‚£ä¹ˆ Consumer ä¾¿ä¼šå°†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯é‡æ–°è°ƒåº¦ç›´åˆ°æˆåŠŸæ¶ˆè´¹:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">consumer<span style="color:#f92672">.</span><span style="color:#a6e22e">registerMessageListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> MessageListenerConcurrently<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> ConsumeConcurrentlyStatus <span style="color:#a6e22e">consumeMessage</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>MessageExt<span style="color:#f92672">&gt;</span> msgs<span style="color:#f92672">,</span>
                                                        ConsumeConcurrentlyContext context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æŠ›å‡ºå¼‚å¸¸
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// è¿”å› NULL æˆ–è€… RECONSUME_LATER çŠ¶æ€
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> ConsumeConcurrentlyStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">RECONSUME_LATER</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
</code></pre></div><h2 id="äº”producer-æ¶ˆæ¯å‘é€é‡è¯•">äº”ã€Producer æ¶ˆæ¯å‘é€é‡è¯•</h2>
<p>å‘é€å¤±è´¥çš„é‡è¯•æ–¹å¼ï¼Œä¸»è¦è¡¨ç°åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šæœ€å¤šå°è¯• <code>getRetryTimesWhenSendFailed()</code> æ¬¡å‘é€ï¼Œå½“æˆåŠŸå‘é€ä»¥åï¼Œä¼šç›´æ¥è¿”å›å‘é€ç»“æœç»™è°ƒç”¨è€…ã€‚å½“å‘é€å¤±è´¥ä»¥åï¼Œä¼šç»§ç»­è¿›è¡Œä¸‹ä¸€æ¬¡å‘é€å°è¯•ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMQProducerImpl</span> <span style="color:#66d9ef">implements</span> MQProducerInner <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> SendResult <span style="color:#a6e22e">sendDefaultImpl</span><span style="color:#f92672">(</span>Message msg<span style="color:#f92672">,</span> <span style="color:#75715e">/** å…¶ä»–å‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> MQClientException<span style="color:#f92672">,</span>
                                                                             RemotingException<span style="color:#f92672">,</span>
                                                                             MQBrokerException<span style="color:#f92672">,</span>
                                                                             InterruptedException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> timesTotal <span style="color:#f92672">=</span> communicationMode <span style="color:#f92672">==</span>
            CommunicationMode<span style="color:#f92672">.</span><span style="color:#a6e22e">SYNC</span> <span style="color:#f92672">?</span>
            1 <span style="color:#f92672">+</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQProducer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getRetryTimesWhenSendFailed</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span>
            1<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> times <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(;</span> times <span style="color:#f92672">&lt;</span> timesTotal<span style="color:#f92672">;</span> times<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// å°è¯•å‘é€æ¶ˆæ¯ï¼Œå‘é€æˆåŠŸ returnï¼Œå‘é€å¤±è´¥ continue
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="å…­consumer-æ¶ˆæ¯æ¥å—é‡è¯•">å…­ã€Consumer æ¶ˆæ¯æ¥å—é‡è¯•</h2>
<h3 id="1-è®¢é˜…é‡è¯•è¯é¢˜">(1) è®¢é˜…é‡è¯•è¯é¢˜</h3>
<p>Consumer åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸€ä¸ªå‡½æ•° <code>copySubscription()</code> ï¼Œå½“ç”¨æˆ·æ³¨å†Œçš„æ¶ˆæ¯æ¨¡å‹ä¸º<strong>é›†ç¾¤æ¨¡å¼</strong>çš„æ—¶å€™ï¼Œä¼šæ ¹æ®ç”¨æˆ·æŒ‡å®šçš„<strong>ç»„</strong>åˆ›å»º<strong>é‡è¯•ç»„è¯é¢˜</strong>å¹¶æ”¾å…¥åˆ°æ³¨å†Œä¿¡æ¯ä¸­:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultMQPushConsumerImpl</span> <span style="color:#66d9ef">implements</span> MQConsumerInner <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> MQClientException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">serviceState</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> CREATE_JUST<span style="color:#f92672">:</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">copySubscription</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">serviceState</span> <span style="color:#f92672">=</span> ServiceState<span style="color:#f92672">.</span><span style="color:#a6e22e">RUNNING</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">copySubscription</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> MQClientException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageModel</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> BROADCASTING<span style="color:#f92672">:</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            
        <span style="color:#66d9ef">case</span> CLUSTERING<span style="color:#f92672">:</span>
            <span style="color:#75715e">// é‡è¯•è¯é¢˜ç»„
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> String retryTopic <span style="color:#f92672">=</span> MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">getRetryTopic</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">());</span>
            SubscriptionData subscriptionData <span style="color:#f92672">=</span> FilterAPI<span style="color:#f92672">.</span><span style="color:#a6e22e">buildSubscriptionData</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getConsumerGroup</span><span style="color:#f92672">(),</span>
                                                                                retryTopic<span style="color:#f92672">,</span> SubscriptionData<span style="color:#f92672">.</span><span style="color:#a6e22e">SUB_ALL</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rebalanceImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getSubscriptionInner</span><span style="color:#f92672">().</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>retryTopic<span style="color:#f92672">,</span> subscriptionData<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å‡è®¾ç”¨æˆ·æŒ‡å®šçš„ç»„ä¸º â€œORDERâ€ï¼Œé‚£ä¹ˆé‡è¯•è¯é¢˜åˆ™ä¸º â€œ%RETRY%ORDERâ€ï¼Œå³å‰é¢åŠ ä¸Šäº† â€œ%RETRY%â€ è¿™ä¸ªå­—ç¬¦ä¸²ã€‚</p>
<p>Consumer åœ¨ä¸€å¼€å§‹å¯åŠ¨çš„æ—¶å€™ï¼Œå°±ä¸ºç”¨æˆ·è‡ªåŠ¨æ³¨å†Œäº†è®¢é˜…ç»„çš„é‡è¯•è¯é¢˜ã€‚å³ç”¨æˆ·ä¸å•å•åªæ¥å—è¿™ä¸ªç»„çš„è¯é¢˜çš„æ¶ˆæ¯ï¼Œä¹Ÿæ¥å—è¿™ä¸ªç»„çš„é‡è¯•è¯é¢˜çš„æ¶ˆæ¯ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±ä¸ºä¸‹æ–‡ç”¨æˆ·å¦‚ä½•é‡è¯•æ¥å—æ¶ˆæ¯å¥ å®šäº†åŸºç¡€ã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-timing-message-and-retry-message/retry_consumer_group.png" alt="æ¶ˆè´¹ç»„é‡è¯•ä¿¡æ¯"></p>
<h3 id="2-å¤±è´¥æ¶ˆæ¯å‘å¾€é‡è¯•è¯é¢˜">(2) å¤±è´¥æ¶ˆæ¯å‘å¾€é‡è¯•è¯é¢˜</h3>
<p>å½“ Consumer å®¢æˆ·ç«¯åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™ï¼ŒæŠ›å‡ºäº†å¼‚å¸¸ã€è¿”å›äº†éæ­£ç¡®æ¶ˆè´¹çš„çŠ¶æ€ç­‰é”™è¯¯çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™ <code>ConsumeMessageConcurrentlyService</code> ä¼šæ”¶é›†æ‰€æœ‰å¤±è´¥çš„æ¶ˆæ¯ï¼Œç„¶åå°†æ¯ä¸€æ¡æ¶ˆæ¯å°è£…è¿› <code>CONSUMER_SEND_MSG_BACK</code> çš„è¯·æ±‚ä¸­ï¼Œå¹¶å°†å…¶å‘é€åˆ° Broker æœåŠ¡å™¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsumeMessageConcurrentlyService</span> <span style="color:#66d9ef">implements</span> ConsumeMessageService <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processConsumeResult</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ConsumeConcurrentlyStatus status<span style="color:#f92672">,</span>
                                     <span style="color:#75715e">/** å…¶ä»–å‚æ•° **/</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQPushConsumer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageModel</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> BROADCASTING<span style="color:#f92672">:</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> CLUSTERING<span style="color:#f92672">:</span>
            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> ackIndex <span style="color:#f92672">+</span> 1<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
                MessageExt msg <span style="color:#f92672">=</span> consumeRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgs</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                <span style="color:#75715e">// é‡æ–°å°†æ¶ˆæ¯å‘å¾€ Broker æœåŠ¡å™¨
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">boolean</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendMessageBack</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> context<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯é‡æ–°å‘é€åˆ°æœåŠ¡å™¨åï¼ŒBroker ä¼šä¸ºå…¶æŒ‡å®šæ–°çš„è¯é¢˜<strong>é‡è¯•è¯é¢˜</strong>ï¼Œå¹¶æ ¹æ®å½“å‰è¿™æ¡æ¶ˆæ¯çš„å·²æœ‰çš„é‡è¯•æ¬¡æ•°æ¥é€‰æ‹©å®šæ—¶çº§åˆ«ï¼Œå³å°†è¿™æ¡æ¶ˆæ¯å˜æˆå®šæ—¶æ¶ˆæ¯æŠ•æ”¾åˆ°é‡è¯•è¯é¢˜æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚å¯è§æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åå¹¶ä¸æ˜¯ç«‹å³è¿›è¡Œæ–°çš„æŠ•é€’ï¼Œè€Œæ˜¯æœ‰ä¸€å®šçš„å»¶è¿Ÿæ—¶é—´çš„ã€‚å»¶è¿Ÿæ—¶é—´éšç€é‡è¯•æ¬¡æ•°çš„å¢åŠ è€Œå¢åŠ ï¼Œä¹Ÿå³æŠ•é€’çš„æ—¶é—´çš„é—´éš”ä¹Ÿè¶Šæ¥è¶Šé•¿:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SendMessageProcessor</span>
    <span style="color:#66d9ef">extends</span> AbstractSendMessageProcessor
    <span style="color:#66d9ef">implements</span> NettyRequestProcessor <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> RemotingCommand <span style="color:#a6e22e">consumerSendMsgBack</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ChannelHandlerContext ctx<span style="color:#f92672">,</span>
                                                <span style="color:#66d9ef">final</span> RemotingCommand request<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> RemotingCommandException <span style="color:#f92672">{</span>

        <span style="color:#75715e">// æŒ‡å®šä¸ºé‡è¯•è¯é¢˜
</span><span style="color:#75715e"></span>        String newTopic <span style="color:#f92672">=</span> MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">getRetryTopic</span><span style="color:#f92672">(</span>requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">getGroup</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">int</span> queueIdInt <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">abs</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">random</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">()</span> <span style="color:#f92672">%</span> 99999999<span style="color:#f92672">)</span> <span style="color:#f92672">%</span> subscriptionGroupConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">getRetryQueueNums</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// æŒ‡å®šä¸ºå»¶æ—¶ä¿¡æ¯ï¼Œè®¾å®šå»¶æ—¶çº§åˆ«
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>0 <span style="color:#f92672">==</span> delayLevel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            delayLevel <span style="color:#f92672">=</span> 3 <span style="color:#f92672">+</span> msgExt<span style="color:#f92672">.</span><span style="color:#a6e22e">getReconsumeTimes</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        msgExt<span style="color:#f92672">.</span><span style="color:#a6e22e">setDelayTimeLevel</span><span style="color:#f92672">(</span>delayLevel<span style="color:#f92672">);</span>

        <span style="color:#75715e">// é‡è¯•æ¬¡æ•°å¢åŠ 
</span><span style="color:#75715e"></span>        msgInner<span style="color:#f92672">.</span><span style="color:#a6e22e">setReconsumeTimes</span><span style="color:#f92672">(</span>msgExt<span style="color:#f92672">.</span><span style="color:#a6e22e">getReconsumeTimes</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> 1<span style="color:#f92672">);</span>

        <span style="color:#75715e">// é‡æ–°å­˜å‚¨
</span><span style="color:#75715e"></span>        PutMessageResult putMessageResult <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStore</span><span style="color:#f92672">().</span><span style="color:#a6e22e">putMessage</span><span style="color:#f92672">(</span>msgInner<span style="color:#f92672">);</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“ç„¶ï¼Œæ¶ˆæ¯å¦‚æœä¸€ç›´æ¶ˆè´¹ä¸æˆåŠŸï¼Œé‚£ä¹Ÿä¸ä¼šä¸€ç›´æ— é™æ¬¡çš„å°è¯•é‡æ–°æŠ•é€’çš„ã€‚å½“é‡è¯•æ¬¡æ•°å¤§äºæœ€å¤§é‡è¯•æ¬¡æ•° (é»˜è®¤ä¸º 16 æ¬¡) çš„æ—¶å€™ï¼Œè¯¥æ¶ˆæ¯å°†ä¼šè¢«é€å¾€<strong>æ­»ä¿¡è¯é¢˜é˜Ÿåˆ—</strong>ï¼Œè®¤å®šè¿™æ¡è¯é¢˜æŠ•é€’æ— é—¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SendMessageProcessor</span>
    <span style="color:#66d9ef">extends</span> AbstractSendMessageProcessor
    <span style="color:#66d9ef">implements</span> NettyRequestProcessor <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> RemotingCommand <span style="color:#a6e22e">consumerSendMsgBack</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> ChannelHandlerContext ctx<span style="color:#f92672">,</span>
                                                <span style="color:#66d9ef">final</span> RemotingCommand request<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> RemotingCommandException <span style="color:#f92672">{</span>
        <span style="color:#75715e">// é‡è¯•æ¬¡æ•°å¤§äºæœ€å¤§é‡è¯•æ¬¡æ•°
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>msgExt<span style="color:#f92672">.</span><span style="color:#a6e22e">getReconsumeTimes</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> maxReconsumeTimes
            <span style="color:#f92672">||</span> delayLevel <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æ­»ä¿¡é˜Ÿåˆ—è¯é¢˜
</span><span style="color:#75715e"></span>            newTopic <span style="color:#f92672">=</span> MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">getDLQTopic</span><span style="color:#f92672">(</span>requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">getGroup</span><span style="color:#f92672">());</span>
            queueIdInt <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">abs</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">random</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">()</span> <span style="color:#f92672">%</span> 99999999<span style="color:#f92672">)</span> <span style="color:#f92672">%</span> DLQ_NUMS_PER_GROUP<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-timing-message-and-retry-message/2018_04_12_16_29_46.png" alt="æ­»ä¿¡è¯é¢˜é˜Ÿåˆ—"></p>
<p>ä¸Šè¿°å®¢æˆ·ç«¯æ¶ˆè´¹å¤±è´¥ä¿¡æ¯çš„æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="/images/docs/rocketmq/rocketmq-timing-message-and-retry-message/consumer_retry_message_consume_flow.png" alt="æ¶ˆè´¹å¤±è´¥ä¿¡æ¯å®Œæ•´æµç¨‹å›¾"></p>
<p>æ‰«æä¸‹é¢äºŒç»´ç ï¼Œåœ¨æ‰‹æœºç«¯é˜…è¯»ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-timing-message-and-retry-message/qrcode.png" alt=""></p>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>

  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'Hw2fQnNQyghcgeRvQosC5cIy-gzGzoHsz',
        appKey: '0ULuPWcxGRLCaHz84icXvBgn',
        notify: 'false', 
        verify: 'false', 
        avatar:'mm', 
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆå§...',
        visitor: 'true'
    });
  </script></div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€å®šæ—¶æ¶ˆæ¯æ¦‚è¿°">ä¸€ã€å®šæ—¶æ¶ˆæ¯æ¦‚è¿°</a></li>
    <li><a href="#äºŒå®šæ—¶æ¶ˆæ¯é¢„å­˜å‚¨">äºŒã€å®šæ—¶æ¶ˆæ¯é¢„å­˜å‚¨</a></li>
    <li><a href="#ä¸‰å®šæ—¶æ¶ˆæ¯å†å­˜å‚¨">ä¸‰ã€å®šæ—¶æ¶ˆæ¯å†å­˜å‚¨</a></li>
    <li><a href="#å››æ¶ˆæ¯é‡è¯•æ¦‚è¿°">å››ã€æ¶ˆæ¯é‡è¯•æ¦‚è¿°</a></li>
    <li><a href="#äº”producer-æ¶ˆæ¯å‘é€é‡è¯•">äº”ã€Producer æ¶ˆæ¯å‘é€é‡è¯•</a></li>
    <li><a href="#å…­consumer-æ¶ˆæ¯æ¥å—é‡è¯•">å…­ã€Consumer æ¶ˆæ¯æ¥å—é‡è¯•</a>
      <ul>
        <li><a href="#1-è®¢é˜…é‡è¯•è¯é¢˜">(1) è®¢é˜…é‡è¯•è¯é¢˜</a></li>
        <li><a href="#2-å¤±è´¥æ¶ˆæ¯å‘å¾€é‡è¯•è¯é¢˜">(2) å¤±è´¥æ¶ˆæ¯å‘å¾€é‡è¯•è¯é¢˜</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>



</html>












