<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="RocketMQ ACL æƒé™æ§åˆ¶"><meta property="og:title" content="RocketMQ ACL æƒé™æ§åˆ¶" />
<meta property="og:description" content="RocketMQ ACL æƒé™æ§åˆ¶  åŸºäº RocketMQ 4.8.0 ç‰ˆæœ¬è¿›è¡Œçš„æºç åˆ†æã€‚
 RocketMQ ä» 4.4.0 ç‰ˆæœ¬å¼•å…¥äº† ACL æƒé™æ§åˆ¶åŠŸèƒ½ã€‚å¯ä»¥ç»™è¯é¢˜æŒ‡å®šæƒé™ï¼Œåªæœ‰æ‹¥æœ‰æƒé™çš„æ¶ˆè´¹è€…æ‰å¯ä»¥è¿›è¡Œæ¶ˆè´¹ã€‚å…¶ä½™ ACL ç‰¹æ€§è¯·æŸ¥çœ‹æƒé™æ§åˆ¶ã€‚
å¦‚ä½•ä½¿ç”¨ é¦–å…ˆå®šä¹‰ä¸€ä¸ª RPCHookï¼š
private static final String ACL_ACCESS_KEY = &#34;RocketMQ&#34;; private static final String ACL_SECRET_KEY = &#34;1234567&#34;; static RPCHook getAclRPCHook() { return new AclClientRPCHook(new SessionCredentials(ACL_ACCESS_KEY,ACL_SECRET_KEY)); } ç„¶åå‘é€æ¶ˆæ¯çš„æ—¶å€™æŒ‡å®š RPCHookï¼š
DefaultMQProducer producer = new DefaultMQProducer(&#34;ProducerGroupName&#34;, getAclRPCHook()); æ¥å—æ¶ˆæ¯çš„æ—¶å€™ä¹Ÿéœ€è¦æŒ‡å®šå…·æœ‰åŒæ · ACCESS_KEY å’Œ SECRET_KEY çš„ RPCHookï¼š
DefaultMQPullConsumer consumer = new DefaultMQPullConsumer(&#34;please_rename_unique_group_name_6&#34;, getAclRPCHook()); Producer æŒ‡å®š RPCHook ä»ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¯ä»¥ä¸º Producer æŒ‡å®šä¸€ä¸ª RPCHookï¼Œéšåæ­¤ RPCHook ä¼šè¢«æ³¨å†Œè¿›æ¥ï¼š" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/rocketmq/rocketmq-acl/" />

<title>RocketMQ ACL æƒé™æ§åˆ¶ | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.c8ac34190f548946cdf00c75980f55bfec0ade2e9e49918cccdcace897f8b279.css" integrity="sha256-yKw0GQ9UiUbN8Ax1mA9Vv&#43;wK3i6eSZGMzNys6Jf4snk=">


<script defer src="/en.search.min.1b8c72779b437dbdd16e7a809d5467ac72aaeb0944f1c8f7e644c8ac48c82848.js" integrity="sha256-G4xyd5tDfb3RbnqAnVRnrHKq6wlE8cj35kTIrEjIKEg="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-send-message-flow/" >
      RocketMQ æ¶ˆæ¯å‘é€æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-store-flow/" >
      RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-receive-flow/" >
      RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-filter-flow/" >
      RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-indexing-flow/" >
      RocketMQ æ¶ˆæ¯ç´¢å¼•æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-timing-message-and-retry-message/" >
      RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-master-slave-sync/" >
      RocketMQ ä¸»å¤‡åŒæ­¥
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-transaction/" >
      RocketMQ äº‹åŠ¡æ¶ˆæ¯
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-acl/"  class="active">
      RocketMQ ACL æƒé™æ§åˆ¶
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>RocketMQ ACL æƒé™æ§åˆ¶</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</a></li>
    <li><a href="#producer-æŒ‡å®š-rpchook">Producer æŒ‡å®š RPCHook</a></li>
    <li><a href="#aclclientrpchook">AclClientRPCHook</a>
      <ul>
        <li><a href="#ç”Ÿæˆç­¾å">ç”Ÿæˆç­¾å</a></li>
        <li><a href="#æ·»åŠ æ‰©å±•å­—æ®µ">æ·»åŠ æ‰©å±•å­—æ®µ</a></li>
      </ul>
    </li>
    <li><a href="#broker-æƒé™éªŒè¯">Broker æƒé™éªŒè¯</a>
      <ul>
        <li><a href="#åˆå§‹åŒ–-accessvalidator">åˆå§‹åŒ– AccessValidator</a></li>
        <li><a href="#ç”Ÿæˆ-accessresource">ç”Ÿæˆ AccessResource</a></li>
        <li><a href="#æ ¡éªŒæƒé™">æ ¡éªŒæƒé™</a></li>
        <li><a href="#acl-æƒé™ç®¡ç†å™¨">ACL æƒé™ç®¡ç†å™¨</a></li>
      </ul>
    </li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown">
  
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script><h1 id="rocketmq-acl-æƒé™æ§åˆ¶">RocketMQ ACL æƒé™æ§åˆ¶</h1>
<blockquote>
<p>åŸºäº RocketMQ 4.8.0 ç‰ˆæœ¬è¿›è¡Œçš„æºç åˆ†æã€‚</p>
</blockquote>
<p>RocketMQ ä» 4.4.0 ç‰ˆæœ¬å¼•å…¥äº† ACL æƒé™æ§åˆ¶åŠŸèƒ½ã€‚<strong>å¯ä»¥ç»™è¯é¢˜æŒ‡å®šæƒé™ï¼Œåªæœ‰æ‹¥æœ‰æƒé™çš„æ¶ˆè´¹è€…æ‰å¯ä»¥è¿›è¡Œæ¶ˆè´¹</strong>ã€‚å…¶ä½™ ACL ç‰¹æ€§è¯·æŸ¥çœ‹<a href="https://github.com/apache/rocketmq/blob/develop/docs/cn/acl/user_guide.md">æƒé™æ§åˆ¶</a>ã€‚</p>
<h2 id="å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</h2>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ª <code>RPCHook</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String ACL_ACCESS_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;RocketMQ&#34;</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String ACL_SECRET_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1234567&#34;</span><span style="color:#f92672">;</span>

<span style="color:#66d9ef">static</span> RPCHook <span style="color:#a6e22e">getAclRPCHook</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> AclClientRPCHook<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SessionCredentials<span style="color:#f92672">(</span>ACL_ACCESS_KEY<span style="color:#f92672">,</span>ACL_SECRET_KEY<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ç„¶åå‘é€æ¶ˆæ¯çš„æ—¶å€™æŒ‡å®š <code>RPCHook</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">DefaultMQProducer producer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DefaultMQProducer<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ProducerGroupName&#34;</span><span style="color:#f92672">,</span> getAclRPCHook<span style="color:#f92672">());</span>
</code></pre></div><p>æ¥å—æ¶ˆæ¯çš„æ—¶å€™ä¹Ÿéœ€è¦æŒ‡å®šå…·æœ‰åŒæ · <code>ACCESS_KEY</code> å’Œ <code>SECRET_KEY</code> çš„ <code>RPCHook</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">DefaultMQPullConsumer consumer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DefaultMQPullConsumer<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;please_rename_unique_group_name_6&#34;</span><span style="color:#f92672">,</span> getAclRPCHook<span style="color:#f92672">());</span>
</code></pre></div><h2 id="producer-æŒ‡å®š-rpchook">Producer æŒ‡å®š RPCHook</h2>
<p>ä»ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¯ä»¥ä¸º Producer æŒ‡å®šä¸€ä¸ª RPCHookï¼Œéšåæ­¤ <code>RPCHook</code> ä¼šè¢«æ³¨å†Œè¿›æ¥ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// org.apache.rocketmq.client.impl.MQClientAPIImpl.class
</span><span style="color:#75715e"></span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remotingClient</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerRPCHook</span><span style="color:#f92672">(</span>rpcHook<span style="color:#f92672">);</span>
</code></pre></div><p>æ³¨å†Œçš„å®è´¨å°±æ˜¯å°†å…¶æ”¾å…¥äº† <code>rpcHooks</code> åˆ—è¡¨ä¸­ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// org.apache.rocketmq.remoting.netty.NettyRemotingAbstract.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span> List<span style="color:#f92672">&lt;</span>RPCHook<span style="color:#f92672">&gt;</span> rpcHooks <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>RPCHook<span style="color:#f92672">&gt;();</span>
</code></pre></div><p>åœ¨ Producer ç«¯è°ƒç”¨åº•å±‚ API å‘é€å‘½ä»¤çš„å‰åï¼Œè°ƒç”¨ <code>RPCHook</code> ä¸Šé¢çš„ <code>doBeforeRequest</code> å’Œ <code>doAfterRequest</code> æ–¹æ³•ï¼Œä¾¿äºåœ¨å‘é€å‘½ä»¤çš„å‰å<strong>æ‹¦æˆª</strong>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> RemotingCommand <span style="color:#a6e22e">invokeSync</span><span style="color:#f92672">(</span>String addr<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> RemotingCommand request<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> timeoutMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    doBeforeRpcHooks<span style="color:#f92672">(</span>addr<span style="color:#f92672">,</span> request<span style="color:#f92672">);</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    doAfterRpcHooks<span style="color:#f92672">(</span>RemotingHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">parseChannelRemoteAddr</span><span style="color:#f92672">(</span>channel<span style="color:#f92672">),</span> request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>   
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doBeforeRpcHooks</span><span style="color:#f92672">(</span>String addr<span style="color:#f92672">,</span> RemotingCommand request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rpcHooks<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>RPCHook rpcHook<span style="color:#f92672">:</span> rpcHooks<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            rpcHook<span style="color:#f92672">.</span><span style="color:#a6e22e">doBeforeRequest</span><span style="color:#f92672">(</span>addr<span style="color:#f92672">,</span> request<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doAfterRpcHooks</span><span style="color:#f92672">(</span>String addr<span style="color:#f92672">,</span> RemotingCommand request<span style="color:#f92672">,</span> RemotingCommand response<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rpcHooks<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>RPCHook rpcHook<span style="color:#f92672">:</span> rpcHooks<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            rpcHook<span style="color:#f92672">.</span><span style="color:#a6e22e">doAfterResponse</span><span style="color:#f92672">(</span>addr<span style="color:#f92672">,</span> request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="aclclientrpchook">AclClientRPCHook</h2>
<p>ä¸‹é¢æ¥çœ‹ <code>AclClientRPCHook</code> åœ¨å‘é€å‘½ä»¤çš„å‰ååšäº†ä»€ä¹ˆäº‹æƒ…ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doBeforeRequest</span><span style="color:#f92672">(</span>String remoteAddr<span style="color:#f92672">,</span> RemotingCommand request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> total <span style="color:#f92672">=</span> AclUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">combineRequestContent</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span>
        parseRequestContent<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getAccessKey</span><span style="color:#f92672">(),</span> sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityToken</span><span style="color:#f92672">()));</span>
    String signature <span style="color:#f92672">=</span> AclUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">calSignature</span><span style="color:#f92672">(</span>total<span style="color:#f92672">,</span> sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecretKey</span><span style="color:#f92672">());</span>
    request<span style="color:#f92672">.</span><span style="color:#a6e22e">addExtField</span><span style="color:#f92672">(</span>SIGNATURE<span style="color:#f92672">,</span> signature<span style="color:#f92672">);</span>
    request<span style="color:#f92672">.</span><span style="color:#a6e22e">addExtField</span><span style="color:#f92672">(</span>ACCESS_KEY<span style="color:#f92672">,</span> sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getAccessKey</span><span style="color:#f92672">());</span>
    
    <span style="color:#75715e">// The SecurityToken value is unneccessary,user can choose this one.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityToken</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        request<span style="color:#f92672">.</span><span style="color:#a6e22e">addExtField</span><span style="color:#f92672">(</span>SECURITY_TOKEN<span style="color:#f92672">,</span> sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityToken</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doAfterResponse</span><span style="color:#f92672">(</span>String remoteAddr<span style="color:#f92672">,</span> RemotingCommand request<span style="color:#f92672">,</span> RemotingCommand response<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ç©ºå®ç°
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><h3 id="ç”Ÿæˆç­¾å">ç”Ÿæˆç­¾å</h3>
<p><code>parseRequestContent</code> æ–¹æ³•å†…éƒ¨å°† <code>request</code> çš„<strong>è‡ªå®šä¹‰å¤´éƒ¨</strong>ä¸Šé¢çš„æ‰€æœ‰å­—æ®µçš„ <code>name</code> å’Œ <code>value</code> æ”¾å…¥åˆ°äº†ä¸€ä¸ª <code>SortedMap</code> ä¸­ï¼ŒåŒæ—¶å°† <code>ACCESS_KEY</code> å’Œ <code>SECURITY_TOKEN</code> (å¦‚æœæœ‰)ä¹Ÿæ”¾å…¥äº†è¿›å»ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>ACCESS_KEY<span style="color:#f92672">,</span> ak<span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>securityToken <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>SECURITY_TOKEN<span style="color:#f92672">,</span> securityToken<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“ç„¶è·å–ç±»ä¸Šé¢çš„æ‰€æœ‰å­—æ®µæ˜¯é€šè¿‡åå°„å®ç°çš„ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œä¹Ÿæ˜¯ä½¿ç”¨äº† <code>Map</code> è¿›è¡Œäº†ç¼“å­˜ã€‚ç¼“å­˜çš„åªæ˜¯ <code>Field</code> å­—æ®µï¼Œè€Œé <code>value</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">protected</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> CommandCustomHeader<span style="color:#f92672">&gt;,</span> Field<span style="color:#f92672">[]&gt;</span> fieldCache <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;</span>Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> CommandCustomHeader<span style="color:#f92672">&gt;,</span> Field<span style="color:#f92672">[]&gt;();</span>
</code></pre></div><p>ä¹‹æ‰€ä»¥è·å–åˆ°æ‰€æœ‰å­—æ®µçš„å€¼ï¼Œæ˜¯ä¸ºäº†è®¡ç®—ç­¾åã€‚è®¡ç®—ç­¾åçš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>é¦–å…ˆå°†ä¸Šè¿°æ‰€æœ‰å­—æ®µçš„å€¼æ‹¼æ¥åŸå­—ç¬¦ä¸²ï¼Œç„¶åè·å–å­—èŠ‚æ•°ç»„ï¼Œå†ä¸è¯·æ±‚æœ¬èº«çš„ <code>body</code> çš„å­—èŠ‚æ•°ç»„æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œè·å–åˆ°æœ€ç»ˆçš„ <code>byte[]</code> æ•°ç»„ã€‚</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// AclUtils.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">combineRequestContent</span><span style="color:#f92672">(</span>RemotingCommand request<span style="color:#f92672">,</span> SortedMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> fieldsMap<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> fieldsMap<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>SessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">SIGNATURE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
            sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">return</span> AclUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">combineBytes</span><span style="color:#f92672">(</span>sb<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span>CHARSET<span style="color:#f92672">),</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getBody</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>ç„¶åé€šè¿‡ <code>calSignature</code> æ–¹æ³•è®¡ç®—ç­¾åï¼Œåœ¨å†…éƒ¨é»˜è®¤é‡‡ç”¨ <code>SigningAlgorithm.HmacSHA1</code> ç®—æ³•è·å–åˆ°ç­¾ååçš„ <code>byte[]</code> æ•°ç»„ï¼Œå†é€šè¿‡ <code>Base64.encodeBase64</code> å°†å…¶è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œè¿”å›æœ€ç»ˆçš„ç­¾åã€‚</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// AclClientRPCHook.java
</span><span style="color:#75715e"></span>String signature <span style="color:#f92672">=</span> AclUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">calSignature</span><span style="color:#f92672">(</span>total<span style="color:#f92672">,</span> sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecretKey</span><span style="color:#f92672">());</span>
</code></pre></div><h3 id="æ·»åŠ æ‰©å±•å­—æ®µ">æ·»åŠ æ‰©å±•å­—æ®µ</h3>
<p>ç”Ÿæˆç­¾åä»¥åï¼Œå°†ç­¾åã€<code>ACCESS_KEY</code>ã€<code>SECURITY_TOKEN</code> (å¦‚æœæœ‰) æ·»åŠ åˆ°<strong>è¯·æ±‚</strong>çš„æ‰©å±•å­—æ®µä¸­ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">request<span style="color:#f92672">.</span><span style="color:#a6e22e">addExtField</span><span style="color:#f92672">(</span>SIGNATURE<span style="color:#f92672">,</span> signature<span style="color:#f92672">);</span>
request<span style="color:#f92672">.</span><span style="color:#a6e22e">addExtField</span><span style="color:#f92672">(</span>ACCESS_KEY<span style="color:#f92672">,</span> sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getAccessKey</span><span style="color:#f92672">());</span>

<span style="color:#75715e">// The SecurityToken value is unneccessary,user can choose this one.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityToken</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    request<span style="color:#f92672">.</span><span style="color:#a6e22e">addExtField</span><span style="color:#f92672">(</span>SECURITY_TOKEN<span style="color:#f92672">,</span> sessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityToken</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="broker-æƒé™éªŒè¯">Broker æƒé™éªŒè¯</h2>
<h3 id="åˆå§‹åŒ–-accessvalidator">åˆå§‹åŒ– AccessValidator</h3>
<p>Broker åœ¨åˆå§‹åŒ– ACL çš„æ—¶å€™ä¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ç”¨äº† ACLï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// BrokerController.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerConfig</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isAclEnable</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å¦‚æœç”¨æˆ·å¼€å¯äº† ACLï¼Œé‚£ä¹ˆä¼šä» <code>META-INF</code> è·¯å¾„ä¸‹å»åŠ è½½æ‰€æœ‰å®ç°äº† <code>AccessValidator</code> æ¥å£çš„å®ç°ç±»ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// ServiceProvider.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String ACL_VALIDATOR_ID <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;META-INF/service/org.apache.rocketmq.acl.AccessValidator&#34;</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// BrokerController.java
</span><span style="color:#75715e"></span>List<span style="color:#f92672">&lt;</span>AccessValidator<span style="color:#f92672">&gt;</span> accessValidators <span style="color:#f92672">=</span> ServiceProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">load</span><span style="color:#f92672">(</span>ServiceProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">ACL_VALIDATOR_ID</span><span style="color:#f92672">,</span> AccessValidator<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>accessValidators <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> accessValidators<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å¦‚æœæœ‰ <code>AccessValidator</code> çš„å®ç°ï¼Œé‚£ä¹ˆä¼šæ³¨å†Œåˆ° Server ç«¯çš„ <code>rpcHooks</code> åˆ—è¡¨ä¸­ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>AccessValidator accessValidator<span style="color:#f92672">:</span> accessValidators<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> AccessValidator validator <span style="color:#f92672">=</span> accessValidator<span style="color:#f92672">;</span>
    accessValidatorMap<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>validator<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span>validator<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerServerRPCHook</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RPCHook<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doBeforeRequest</span><span style="color:#f92672">(</span>String remoteAddr<span style="color:#f92672">,</span> RemotingCommand request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//Do not catch the exception
</span><span style="color:#75715e"></span>            validator<span style="color:#f92672">.</span><span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span>validator<span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> remoteAddr<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doAfterResponse</span><span style="color:#f92672">(</span>String remoteAddr<span style="color:#f92672">,</span> RemotingCommand request<span style="color:#f92672">,</span> RemotingCommand response<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>è€Œ Broker ä¸­çš„ <code>META-INF/service/org.apache.rocketmq.acl.AccessValidator</code> æ–‡ä»¶å­˜å‚¨çš„å†…å®¹å¦‚ä¸‹ï¼Œå³é‡‡ç”¨ <code>PlainAccessValidator</code> ä½œä¸ºé»˜è®¤çš„æƒé™è®¿é—®æ ¡éªŒå™¨ã€‚</p>
<pre><code>org.apache.rocketmq.acl.plain.PlainAccessValidator
</code></pre><p>æ¥ä¸‹æ¥å°±ä»‹ç» <code>PlainAccessValidator</code> å†…éƒ¨æ˜¯å¦‚ä½•è¿›è¡Œæƒé™æ ¡éªŒçš„ã€‚</p>
<h3 id="ç”Ÿæˆ-accessresource">ç”Ÿæˆ AccessResource</h3>
<p>Broker ç«¯æ”¶åˆ°<strong>è¯·æ±‚</strong>åï¼Œä¼šå°†è¯·æ±‚è§£æä¸º <code>AccessResource</code>ã€‚è§£æçš„è¿‡ç¨‹å°±æ˜¯å°† <code>RemotingCommand</code> ä¸­é™„å¸¦çš„ IP åœ°å€ã€<code>ACCESS_KEY</code>ã€ç­¾åã€<code>SECRET_TOKEN</code> ç­‰æ·»åŠ åˆ° <code>PlainAccessResource</code> ä¸­ã€‚å¹¶æ ¹æ®ä¸åŒçš„å‘½ä»¤ï¼Œç»™èµ„æºæ·»åŠ ä¸Š<strong>ä¸åŒçš„è®¿é—®æƒé™</strong>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> AccessResource <span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>RemotingCommand request<span style="color:#f92672">,</span> String remoteAddr<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    PlainAccessResource accessResource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PlainAccessResource<span style="color:#f92672">();</span>

    <span style="color:#75715e">// å°†è¿œç¨‹çš„åœ°å€æ”¾åˆ°ç™½åå•é‡Œé¢
</span><span style="color:#75715e"></span>    accessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">setWhiteRemoteAddress</span><span style="color:#f92672">(</span>remoteAddr<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> remoteAddr<span style="color:#f92672">.</span><span style="color:#a6e22e">lastIndexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;:&#39;</span><span style="color:#f92672">)));</span>

    <span style="color:#75715e">// å°† ACCESS_KEYã€SIGNATUREã€SECRET_TOKEN è§£æå‡ºæ¥
</span><span style="color:#75715e"></span>    accessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessKey</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getExtFields</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>SessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">ACCESS_KEY</span><span style="color:#f92672">));</span>
    accessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">setSignature</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getExtFields</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>SessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">SIGNATURE</span><span style="color:#f92672">));</span>
    accessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">setSecretToken</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getExtFields</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>SessionCredentials<span style="color:#f92672">.</span><span style="color:#a6e22e">SECURITY_TOKEN</span><span style="color:#f92672">));</span>

    <span style="color:#75715e">// æ ¹æ®ä¸åŒçš„è¯·æ±‚ï¼Œæ·»åŠ ä¸åŒçš„èµ„æºè®¿é—®æƒé™
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getCode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> RequestCode<span style="color:#f92672">.</span><span style="color:#a6e22e">SEND_MESSAGE</span><span style="color:#f92672">:</span>
            accessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">addResourceAndPerm</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getExtFields</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;topic&#34;</span><span style="color:#f92672">),</span> Permission<span style="color:#f92672">.</span><span style="color:#a6e22e">PUB</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">case</span> RequestCode<span style="color:#f92672">.</span><span style="color:#a6e22e">QUERY_MESSAGE</span><span style="color:#f92672">:</span>
            accessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">addResourceAndPerm</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getExtFields</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;topic&#34;</span><span style="color:#f92672">),</span> Permission<span style="color:#f92672">.</span><span style="color:#a6e22e">SUB</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å…¶ä¸­ RocketMQ çš„ Topic èµ„æºè®¿é—®æƒé™æ§åˆ¶å®šä¹‰ä¸»è¦å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ†ä¸ºä»¥ä¸‹å››ç§ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Permission</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">byte</span> DENY <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">byte</span> ANY <span style="color:#f92672">=</span> 1 <span style="color:#f92672">&lt;&lt;</span> 1<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">byte</span> PUB <span style="color:#f92672">=</span> 1 <span style="color:#f92672">&lt;&lt;</span> 2<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">byte</span> SUB <span style="color:#f92672">=</span> 1 <span style="color:#f92672">&lt;&lt;</span> 3<span style="color:#f92672">;</span>

<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li><code>DENY</code>: æ‹’ç»</li>
<li><code>ANY</code>: <code>PUB</code> æˆ–è€… <code>SUB</code> æƒé™</li>
<li><code>PUB</code>: <strong>å‘é€</strong>æƒé™ã€‚å³ä» Producer ç«¯å‘é€å‡ºæ¥çš„å‘½ä»¤ï¼Œæ‰€å…·æœ‰çš„æƒé™ã€‚</li>
<li><code>SUB</code>: <strong>è®¢é˜…</strong>æƒé™ã€‚å³ä»æ¶ˆè´¹ç«¯å‘é€å‡ºæ¥çš„å‘½ä»¤ï¼Œæ‰€å…·æœ‰çš„æƒé™ã€‚</li>
</ul>
<p>æ¯”å¦‚ä¸Šè¿°ç¤ºä¾‹ä»£ç ï¼Œ<code>SEND_MESSAGE</code> å‘½ä»¤åªèƒ½æ˜¯ Producer ç«¯å‘é€ï¼Œå› æ­¤å®ƒçš„æƒé™ <code>PUB</code>ï¼›è€Œ <code>QUERY_MESSAGE</code> å‘½ä»¤åªèƒ½æ˜¯ Consumer ç«¯æŸ¥è¯¢ï¼Œå› æ­¤å®ƒçš„æƒé™æ˜¯ <code>SUB</code>ã€‚</p>
<h3 id="æ ¡éªŒæƒé™">æ ¡éªŒæƒé™</h3>
<p>ç”Ÿæˆ AccessResource åï¼Œä¾¿éœ€è¦å¯¹è¿™ä¸ªèµ„æºè¿›è¡Œæƒé™æ ¡éªŒï¼Œæ ¡éªŒçš„å…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ul>
<li>ï¼ˆ1ï¼‰æ£€æŸ¥æ˜¯å¦å‘½ä¸­å…¨å±€ IP ç™½åå•ï¼›å¦‚æœæ˜¯ï¼Œåˆ™è®¤ä¸ºæ ¡éªŒé€šè¿‡ï¼›å¦åˆ™èµ° 2ï¼›</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// PlainPermissionManager.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>RemoteAddressStrategy remoteAddressStrategy <span style="color:#f92672">:</span> globalWhiteRemoteAddressStrategy<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>remoteAddressStrategy<span style="color:#f92672">.</span><span style="color:#a6e22e">match</span><span style="color:#f92672">(</span>plainAccessResource<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>ï¼ˆ2ï¼‰æ£€æŸ¥æ˜¯å¦å‘½ä¸­<strong>ç”¨æˆ· IP ç™½åå•</strong>ï¼›å¦‚æœæ˜¯ï¼Œåˆ™è®¤ä¸ºæ ¡éªŒé€šè¿‡ï¼›å¦åˆ™èµ° 3ï¼›</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// PlainPermissionManager.java
</span><span style="color:#75715e"></span>PlainAccessResource ownedAccess <span style="color:#f92672">=</span> plainAccessResourceMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>plainAccessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">getAccessKey</span><span style="color:#f92672">());</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ownedAccess<span style="color:#f92672">.</span><span style="color:#a6e22e">getRemoteAddressStrategy</span><span style="color:#f92672">().</span><span style="color:#a6e22e">match</span><span style="color:#f92672">(</span>plainAccessResource<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>ï¼ˆ3ï¼‰æ ¡éªŒç­¾åï¼Œæ ¡éªŒä¸é€šè¿‡ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼›æ ¡éªŒé€šè¿‡ï¼Œåˆ™èµ° 4ï¼›</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// PlainPermissionManager.java
</span><span style="color:#75715e"></span>String signature <span style="color:#f92672">=</span> AclUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">calSignature</span><span style="color:#f92672">(</span>plainAccessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">getContent</span><span style="color:#f92672">(),</span> ownedAccess<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecretKey</span><span style="color:#f92672">());</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>signature<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>plainAccessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">getSignature</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AclException<span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Check signature failed for accessKey=%s&#34;</span><span style="color:#f92672">,</span> plainAccessResource<span style="color:#f92672">.</span><span style="color:#a6e22e">getAccessKey</span><span style="color:#f92672">()));</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>ï¼ˆ4ï¼‰å¯¹ç”¨æˆ·è¯·æ±‚æ‰€éœ€çš„æƒé™ å’Œ ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™è¿›è¡Œæ ¡éªŒï¼›ä¸é€šè¿‡ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼›</li>
</ul>
<p>ç”¨æˆ·æ‰€éœ€æƒé™çš„æ ¡éªŒéœ€è¦æ³¨æ„å·²ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>ï¼ˆ1ï¼‰ç‰¹æ®Šçš„è¯·æ±‚ä¾‹å¦‚ <code>UPDATE_AND_CREATE_TOPIC</code> ç­‰ï¼Œåªèƒ½ç”± admin è´¦æˆ·è¿›è¡Œæ“ä½œï¼›</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// PlainPermissionManager.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Permission<span style="color:#f92672">.</span><span style="color:#a6e22e">needAdminPerm</span><span style="color:#f92672">(</span>needCheckedAccess<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestCode</span><span style="color:#f92672">())</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>ownedAccess<span style="color:#f92672">.</span><span style="color:#a6e22e">isAdmin</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AclException<span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Need admin permission for request code=%d, but accessKey=%s is not&#34;</span><span style="color:#f92672">,</span> needCheckedAccess<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestCode</span><span style="color:#f92672">(),</span> ownedAccess<span style="color:#f92672">.</span><span style="color:#a6e22e">getAccessKey</span><span style="color:#f92672">()));</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>ï¼ˆ2ï¼‰å¯¹äºæŸä¸ªèµ„æºï¼Œå¦‚æœæœ‰æ˜¾æ€§é…ç½®æƒé™ï¼Œåˆ™é‡‡ç”¨é…ç½®çš„æƒé™ï¼›å¦‚æœæ²¡æœ‰æ˜¾æ€§é…ç½®æƒé™ï¼Œåˆ™é‡‡ç”¨é»˜è®¤çš„æƒé™ï¼›</li>
</ul>
<h3 id="acl-æƒé™ç®¡ç†å™¨">ACL æƒé™ç®¡ç†å™¨</h3>
<p>ä¸Šè¿°æ ¡éªŒè§„åˆ™çš„ <code>validate</code> æ–¹æ³•æ˜¯æ”¾åœ¨æƒé™ç®¡ç†å™¨ <code>PlainPermissionManager</code> ä¸Šé¢çš„ï¼Œåœ¨æ–°å»ºè¯¥ç±»<strong>å®ä¾‹</strong>çš„æ—¶å€™ï¼Œå…¶å†…éƒ¨ä¼šé¦–å…ˆåŠ è½½ YML æ ¼å¼çš„æƒé™é…ç½®æ–‡ä»¶ï¼Œç„¶ååœ¨ç›‘å¬è¿™ä¸ªæ–‡ä»¶çš„å˜åŒ–ï¼Œåšåˆ°è¿è¡Œæ—¶åŠ¨æ€çš„æ›´æ–°æƒé™ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String DEFAULT_PLAIN_ACL_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/conf/plain_acl.yml&#34;</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">private</span> String fileName <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;rocketmq.acl.plain.file&#34;</span><span style="color:#f92672">,</span> DEFAULT_PLAIN_ACL_FILE<span style="color:#f92672">);</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">load</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    JSONObject plainAclConfData <span style="color:#f92672">=</span> AclUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getYamlDataObject</span><span style="color:#f92672">(</span>fileHome <span style="color:#f92672">+</span> File<span style="color:#f92672">.</span><span style="color:#a6e22e">separator</span> <span style="color:#f92672">+</span> fileName<span style="color:#f92672">,</span> JSONObject<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>RocketMQ åœ¨ <code>distribution/conf</code> ç›®å½•ä¸‹ï¼Œç»™å‡ºäº†ä¸€ä¸ªé»˜è®¤çš„æƒé™é…ç½®æ–‡ä»¶ <code>plain_acl.yml</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">globalWhiteRemoteAddresses</span>:
- <span style="color:#ae81ff">10.10.103</span><span style="color:#ae81ff">.*</span>
- <span style="color:#ae81ff">192.168.0</span><span style="color:#ae81ff">.*</span>

<span style="color:#f92672">accounts</span>:
- <span style="color:#f92672">accessKey</span>: <span style="color:#ae81ff">RocketMQ</span>
  <span style="color:#f92672">secretKey</span>: <span style="color:#ae81ff">12345678</span>
  <span style="color:#f92672">whiteRemoteAddress</span>: <span style="color:#ae81ff">192.168.0</span><span style="color:#ae81ff">.*</span>
  <span style="color:#f92672">admin</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">defaultTopicPerm</span>: <span style="color:#ae81ff">DENY</span>
  <span style="color:#f92672">defaultGroupPerm</span>: <span style="color:#ae81ff">SUB</span>
  <span style="color:#f92672">topicPerms</span>:
  - <span style="color:#ae81ff">topicA=DENY</span>
  - <span style="color:#ae81ff">topicB=PUB|SUB</span>
  - <span style="color:#ae81ff">topicC=SUB</span>
  <span style="color:#f92672">groupPerms</span>:
  <span style="color:#75715e"># the group should convert to retry topic</span>
  - <span style="color:#ae81ff">groupA=DENY</span>
  - <span style="color:#ae81ff">groupB=SUB</span>
  - <span style="color:#ae81ff">groupC=SUB</span>

- <span style="color:#f92672">accessKey</span>: <span style="color:#ae81ff">rocketmq2</span>
  <span style="color:#f92672">secretKey</span>: <span style="color:#ae81ff">12345678</span>
  <span style="color:#f92672">whiteRemoteAddress</span>: <span style="color:#ae81ff">192.168.1</span><span style="color:#ae81ff">.*</span>
  <span style="color:#75715e"># if it is admin, it could access all resources</span>
  <span style="color:#f92672">admin</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><p>å¯¹äºæ­¤æ–‡ä»¶çš„<strong>ç›‘å¬</strong>ï¼Œæ˜¯é€šè¿‡ <code>FileWatchService</code> è¿›è¡Œçš„ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">FileWatchService fileWatchService <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileWatchService<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span> <span style="color:#f92672">{</span>watchFilePath<span style="color:#f92672">},</span> <span style="color:#66d9ef">new</span> FileWatchService<span style="color:#f92672">.</span><span style="color:#a6e22e">Listener</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onChanged</span><span style="color:#f92672">(</span>String path<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;The plain acl yml changed, reload the context&#34;</span><span style="color:#f92672">);</span>
        load<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">});</span>
fileWatchService<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</code></pre></div>
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-8950855178079071"
data-ad-slot="6142361626"
data-ad-format="auto"
data-full-width-responsive="true"></ins>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</a></li>
    <li><a href="#producer-æŒ‡å®š-rpchook">Producer æŒ‡å®š RPCHook</a></li>
    <li><a href="#aclclientrpchook">AclClientRPCHook</a>
      <ul>
        <li><a href="#ç”Ÿæˆç­¾å">ç”Ÿæˆç­¾å</a></li>
        <li><a href="#æ·»åŠ æ‰©å±•å­—æ®µ">æ·»åŠ æ‰©å±•å­—æ®µ</a></li>
      </ul>
    </li>
    <li><a href="#broker-æƒé™éªŒè¯">Broker æƒé™éªŒè¯</a>
      <ul>
        <li><a href="#åˆå§‹åŒ–-accessvalidator">åˆå§‹åŒ– AccessValidator</a></li>
        <li><a href="#ç”Ÿæˆ-accessresource">ç”Ÿæˆ AccessResource</a></li>
        <li><a href="#æ ¡éªŒæƒé™">æ ¡éªŒæƒé™</a></li>
        <li><a href="#acl-æƒé™ç®¡ç†å™¨">ACL æƒé™ç®¡ç†å™¨</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1279346965'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279346965%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</body>



</html>












