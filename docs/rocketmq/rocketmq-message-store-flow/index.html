<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹"><meta property="og:title" content="RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹" />
<meta property="og:description" content="RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹ æœ¬æ–‡è®²è¿° RocketMQ å­˜å‚¨ä¸€æ¡æ¶ˆæ¯çš„æµç¨‹ã€‚
ä¸€ã€å­˜å‚¨ä½ç½® å½“æœ‰ä¸€æ¡æ¶ˆæ¯è¿‡æ¥ä¹‹åï¼ŒBroker é¦–å…ˆéœ€è¦åšçš„æ˜¯ç¡®å®šè¿™æ¡æ¶ˆæ¯åº”è¯¥å­˜å‚¨åœ¨å“ªä¸ªæ–‡ä»¶é‡Œé¢ã€‚åœ¨ RocketMQ ä¸­ï¼Œè¿™ä¸ªç”¨æ¥å­˜å‚¨æ¶ˆæ¯çš„æ–‡ä»¶è¢«ç§°ä¹‹ä¸º MappedFileã€‚è¿™ä¸ªæ–‡ä»¶é»˜è®¤åˆ›å»ºçš„å¤§å°ä¸º 1GBã€‚
ä¸€ä¸ªæ–‡ä»¶ä¸º 1GB å¤§å°ï¼Œä¹Ÿå³ 1024 * 1024 * 1024 = 1073741824 å­—èŠ‚ï¼Œè¿™æ¯ä¸ªæ–‡ä»¶çš„å‘½åæ˜¯æŒ‰ç…§æ€»çš„å­—èŠ‚åç§»é‡æ¥å‘½åçš„ã€‚ä¾‹å¦‚ç¬¬ä¸€ä¸ªæ–‡ä»¶åç§»é‡ä¸º 0ï¼Œé‚£ä¹ˆå®ƒçš„åå­—ä¸º 00000000000000000000ï¼›å½“å½“å‰è¿™ 1G æ–‡ä»¶è¢«å­˜å‚¨æ»¡äº†ä¹‹åï¼Œå°±ä¼šåˆ›å»ºä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸‹ä¸€ä¸ªæ–‡ä»¶çš„åç§»é‡åˆ™ä¸º 1GBï¼Œé‚£ä¹ˆå®ƒçš„åå­—ä¸º 00000000001073741824ï¼Œä»¥æ­¤ç±»æ¨ã€‚
é»˜è®¤æƒ…å†µä¸‹è¿™äº›æ¶ˆæ¯æ–‡ä»¶ä½äº $HOME/store/commitlog ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:
äºŒã€æ–‡ä»¶åˆ›å»º å½“ Broker å¯åŠ¨çš„æ—¶å€™ï¼Œå…¶ä¼šå°†ä½äºå­˜å‚¨ç›®å½•ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯æ–‡ä»¶åŠ è½½åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­:
å½“æœ‰æ–°çš„æ¶ˆæ¯åˆ°æ¥çš„æ—¶å€™ï¼Œå…¶ä¼šé»˜è®¤é€‰æ‹©åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªæ–‡ä»¶æ¥è¿›è¡Œæ¶ˆæ¯çš„ä¿å­˜:
public class MappedFileQueue { public MappedFile getLastMappedFile() { MappedFile mappedFileLast = null; while (!this.mappedFiles.isEmpty()) { try { mappedFileLast = this.mappedFiles.get(this.mappedFiles.size() - 1); break; } catch (IndexOutOfBoundsException e) { //continue;  } catch (Exception e) { log." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/rocketmq/rocketmq-message-store-flow/" />

<title>RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹ | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.215f2c356498a041f9de3ebaab0d56c45dd9a6292b641970f0f751a7bcec3c63.css" integrity="sha256-IV8sNWSYoEH53j66qw1WxF3ZpikrZBlw8PdRp7zsPGM=">


<script defer src="/en.search.min.a64051cde285ea13280c35aad227afde2eb4d1b84ea64a22c3e7e10527b73fe9.js" integrity="sha256-pkBRzeKF6hMoDDWq0iev3i600bhOpkoiw&#43;fhBSe3P&#43;k="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      ğŸ‘‰æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-send-message-flow/" >
      RocketMQ æ¶ˆæ¯å‘é€æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-store-flow/"  class="active">
      RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-receive-flow/" >
      RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-filter-flow/" >
      RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-indexing-flow/" >
      RocketMQ æ¶ˆæ¯ç´¢å¼•æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-timing-message-and-retry-message/" >
      RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-master-slave-sync/" >
      RocketMQ ä¸»å¤‡åŒæ­¥
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€å­˜å‚¨ä½ç½®">ä¸€ã€å­˜å‚¨ä½ç½®</a></li>
    <li><a href="#äºŒæ–‡ä»¶åˆ›å»º">äºŒã€æ–‡ä»¶åˆ›å»º</a></li>
    <li><a href="#ä¸‰æ–‡ä»¶åˆå§‹åŒ–">ä¸‰ã€æ–‡ä»¶åˆå§‹åŒ–</a></li>
    <li><a href="#å››æ¶ˆæ¯æ–‡ä»¶åŠ è½½">å››ã€æ¶ˆæ¯æ–‡ä»¶åŠ è½½</a></li>
    <li><a href="#äº”å†™å…¥æ¶ˆæ¯">äº”ã€å†™å…¥æ¶ˆæ¯</a>
      <ul>
        <li><a href="#1-æ–‡ä»¶å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯">(1) æ–‡ä»¶å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯</a></li>
        <li><a href="#2-æ–‡ä»¶ä¸å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯">(2) æ–‡ä»¶ä¸å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯</a></li>
      </ul>
    </li>
    <li><a href="#å…­æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥">å…­ã€æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥</a>
      <ul>
        <li><a href="#1-å¼‚æ­¥åˆ·ç›˜">(1) å¼‚æ­¥åˆ·ç›˜</a></li>
        <li><a href="#2-åŒæ­¥åˆ·ç›˜">(2) åŒæ­¥åˆ·ç›˜</a></li>
      </ul>
    </li>
    <li><a href="#ä¸ƒæ¶ˆæ¯åˆ·ç›˜ç†å¿µ">ä¸ƒã€æ¶ˆæ¯åˆ·ç›˜ç†å¿µ</a></li>
    <li><a href="#å…«æ¶ˆæ¯åˆ·ç›˜è¿‡ç¨‹">å…«ã€æ¶ˆæ¯åˆ·ç›˜è¿‡ç¨‹</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown"><h1 id="rocketmq-æ¶ˆæ¯å­˜å‚¨æµç¨‹">RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹</h1>
<p>æœ¬æ–‡è®²è¿° RocketMQ å­˜å‚¨ä¸€æ¡æ¶ˆæ¯çš„æµç¨‹ã€‚</p>
<h2 id="ä¸€å­˜å‚¨ä½ç½®">ä¸€ã€å­˜å‚¨ä½ç½®</h2>
<p>å½“æœ‰ä¸€æ¡æ¶ˆæ¯è¿‡æ¥ä¹‹åï¼ŒBroker é¦–å…ˆéœ€è¦åšçš„æ˜¯ç¡®å®šè¿™æ¡æ¶ˆæ¯åº”è¯¥å­˜å‚¨åœ¨å“ªä¸ªæ–‡ä»¶é‡Œé¢ã€‚åœ¨ RocketMQ ä¸­ï¼Œè¿™ä¸ªç”¨æ¥å­˜å‚¨æ¶ˆæ¯çš„æ–‡ä»¶è¢«ç§°ä¹‹ä¸º MappedFileã€‚è¿™ä¸ªæ–‡ä»¶é»˜è®¤åˆ›å»ºçš„å¤§å°ä¸º 1GBã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/mappedfile_size.png" alt="æ¶ˆæ¯æ–‡ä»¶å¤§å°"></p>
<p>ä¸€ä¸ªæ–‡ä»¶ä¸º 1GB å¤§å°ï¼Œä¹Ÿå³ <code>1024 * 1024 * 1024 = 1073741824</code> å­—èŠ‚ï¼Œè¿™æ¯ä¸ªæ–‡ä»¶çš„å‘½åæ˜¯æŒ‰ç…§æ€»çš„å­—èŠ‚åç§»é‡æ¥å‘½åçš„ã€‚ä¾‹å¦‚ç¬¬ä¸€ä¸ªæ–‡ä»¶åç§»é‡ä¸º 0ï¼Œé‚£ä¹ˆå®ƒçš„åå­—ä¸º <code>00000000000000000000</code>ï¼›å½“å½“å‰è¿™ 1G æ–‡ä»¶è¢«å­˜å‚¨æ»¡äº†ä¹‹åï¼Œå°±ä¼šåˆ›å»ºä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸‹ä¸€ä¸ªæ–‡ä»¶çš„åç§»é‡åˆ™ä¸º 1GBï¼Œé‚£ä¹ˆå®ƒçš„åå­—ä¸º <code>00000000001073741824</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/mappedfile_offset_naming.png" alt="æ–‡ä»¶å‘½åè§„åˆ™"></p>
<p>é»˜è®¤æƒ…å†µä¸‹è¿™äº›æ¶ˆæ¯æ–‡ä»¶ä½äº <code>$HOME/store/commitlog</code> ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/2018_02_13_14_16_11.png" alt="æ¶ˆæ¯ç›®å½•"></p>
<h2 id="äºŒæ–‡ä»¶åˆ›å»º">äºŒã€æ–‡ä»¶åˆ›å»º</h2>
<p>å½“ Broker å¯åŠ¨çš„æ—¶å€™ï¼Œå…¶ä¼šå°†ä½äºå­˜å‚¨ç›®å½•ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯æ–‡ä»¶åŠ è½½åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/mappedFiles_list.png" alt="æ¶ˆæ¯æ–‡ä»¶åˆ—è¡¨"></p>
<p>å½“æœ‰æ–°çš„æ¶ˆæ¯åˆ°æ¥çš„æ—¶å€™ï¼Œå…¶ä¼šé»˜è®¤é€‰æ‹©åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªæ–‡ä»¶æ¥è¿›è¡Œæ¶ˆæ¯çš„ä¿å­˜:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/last_mapped_file.png" alt="æœ€åä¸€ä¸ªæ¶ˆæ¯æ–‡ä»¶"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MappedFileQueue</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> MappedFile <span style="color:#a6e22e">getLastMappedFile</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        MappedFile mappedFileLast <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFiles</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                mappedFileLast <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFiles</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFiles</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IndexOutOfBoundsException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">//continue;
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;getLastMappedFile has exception.&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> mappedFileLast<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“ç„¶å¦‚æœè¿™ä¸ª Broker ä¹‹å‰ä»æœªæ¥å—è¿‡æ¶ˆæ¯çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ—è¡¨è‚¯å®šæ˜¯ç©ºçš„ã€‚è¿™æ ·ä¸€æ—¦æœ‰æ–°çš„æ¶ˆæ¯éœ€è¦å­˜å‚¨çš„æ—¶å€™ï¼Œå…¶å°±å¾—éœ€è¦ç«‹å³åˆ›å»ºä¸€ä¸ª <code>MappedFile</code> æ–‡ä»¶æ¥å­˜å‚¨æ¶ˆæ¯ã€‚</p>
<p>RocketMQ æä¾›äº†ä¸€ä¸ªä¸“é—¨ç”¨æ¥å®ä¾‹åŒ– <code>MappedFile</code> æ–‡ä»¶çš„æœåŠ¡ç±» <code>AllocateMappedFileService</code>ã€‚åœ¨å†…å­˜ä¸­ï¼Œä¹ŸåŒæ—¶ç»´æŠ¤äº†ä¸€å¼ è¯·æ±‚è¡¨ <code>requestTable</code> å’Œä¸€ä¸ªä¼˜å…ˆçº§è¯·æ±‚é˜Ÿåˆ— <code>requestQueue</code> ã€‚å½“éœ€è¦åˆ›å»ºæ–‡ä»¶çš„æ—¶å€™ï¼ŒBroker ä¼šåˆ›å»ºä¸€ä¸ª <code>AllocateRequest</code> å¯¹è±¡ï¼Œå…¶åŒ…å«äº†æ–‡ä»¶çš„è·¯å¾„ã€å¤§å°ç­‰ä¿¡æ¯ã€‚ç„¶åå…ˆå°†å…¶æ”¾å…¥ <code>requestTable</code> è¡¨ä¸­ï¼Œå†å°†å…¶æ”¾å…¥ä¼˜å…ˆçº§è¯·æ±‚é˜Ÿåˆ— <code>requestQueue</code> ä¸­:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AllocateMappedFileService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> MappedFile <span style="color:#a6e22e">putRequestAndReturnMappedFile</span><span style="color:#f92672">(</span>String nextFilePath<span style="color:#f92672">,</span>
                                                    String nextNextFilePath<span style="color:#f92672">,</span>
                                                    <span style="color:#66d9ef">int</span> fileSize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
        AllocateRequest nextReq <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AllocateRequest<span style="color:#f92672">(</span>nextFilePath<span style="color:#f92672">,</span> fileSize<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">boolean</span> nextPutOK <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requestTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>nextFilePath<span style="color:#f92672">,</span> nextReq<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nextPutOK<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> offerOK <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requestQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offer</span><span style="color:#f92672">(</span>nextReq<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>æœåŠ¡ç±»ä¼š<strong>ä¸€ç›´</strong>ç­‰å¾…ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜¯å¦æœ‰æ–°çš„è¯·æ±‚åˆ°æ¥ï¼Œå¦‚æœæœ‰ï¼Œä¾¿ä¼šä»é˜Ÿåˆ—ä¸­å–å‡ºè¯·æ±‚ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„ <code>MappedFile</code>ï¼Œå¹¶å°†è¯·æ±‚è¡¨ requestTable ä¸­ <code>AllocateRequest</code> å¯¹è±¡çš„å­—æ®µ <code>mappedFile</code> è®¾ç½®ä¸Šå€¼ã€‚æœ€åå°† <code>AllocateRequest</code> å¯¹è±¡ä¸Šçš„ <code>CountDownLatch</code> çš„è®¡æ•°å™¨å‡ 1 ï¼Œä»¥æ ‡æ˜æ­¤åˆ†é…ç”³è¯·çš„ <code>MappedFile</code> å·²ç»åˆ›å»ºå®Œæ¯•äº†:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AllocateMappedFileService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ä¸€ç›´è¿è¡Œ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isStopped</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mmapOperation</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">mmapOperation</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        req <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requestQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">take</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>req<span style="color:#f92672">.</span><span style="color:#a6e22e">getMappedFile</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            MappedFile mappedFile<span style="color:#f92672">;</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            mappedFile <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MappedFile<span style="color:#f92672">(</span>req<span style="color:#f92672">.</span><span style="color:#a6e22e">getFilePath</span><span style="color:#f92672">(),</span> req<span style="color:#f92672">.</span><span style="color:#a6e22e">getFileSize</span><span style="color:#f92672">());</span>
            <span style="color:#75715e">// è®¾ç½®ä¸Šå€¼
</span><span style="color:#75715e"></span>            req<span style="color:#f92672">.</span><span style="color:#a6e22e">setMappedFile</span><span style="color:#f92672">(</span>mappedFile<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è®¡æ•°å™¨å‡ 1
</span><span style="color:#75715e"></span>        req<span style="color:#f92672">.</span><span style="color:#a6e22e">getCountDownLatch</span><span style="color:#f92672">().</span><span style="color:#a6e22e">countDown</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å…¶ä¸Šè¿°æ•´ä½“æµç¨‹å¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/AllocateMappedFileService.png" alt="åˆ›å»ºæ–‡ä»¶è¿‡ç¨‹"></p>
<p>ç­‰å¾… <code>MappedFile</code> åˆ›å»ºå®Œæ¯•ä¹‹åï¼Œå…¶ä¾¿ä¼šä»è¯·æ±‚è¡¨ <code>requestTable</code> ä¸­å–å‡ºå¹¶åˆ é™¤è¡¨ä¸­è®°å½•:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AllocateMappedFileService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> MappedFile <span style="color:#a6e22e">putRequestAndReturnMappedFile</span><span style="color:#f92672">(</span>String nextFilePath<span style="color:#f92672">,</span>
                                                    String nextNextFilePath<span style="color:#f92672">,</span>
                                                    <span style="color:#66d9ef">int</span> fileSize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        AllocateRequest result <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requestTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>nextFilePath<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ç­‰å¾… MappedFile çš„åˆ›å»ºå®Œæˆ
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">boolean</span> waitOK <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">getCountDownLatch</span><span style="color:#f92672">().</span><span style="color:#a6e22e">await</span><span style="color:#f92672">(</span>waitTimeOut<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>waitOK<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ä»è¯·æ±‚è¡¨ä¸­åˆ é™¤
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requestTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>nextFilePath<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">getMappedFile</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ç„¶åå†å°†å…¶æ”¾åˆ°åˆ—è¡¨ä¸­å»:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MappedFileQueue</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> MappedFile <span style="color:#a6e22e">getLastMappedFile</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> startOffset<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> needCreate<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        MappedFile mappedFile <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">allocateMappedFileService</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// åˆ›å»º MappedFile
</span><span style="color:#75715e"></span>            mappedFile <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">allocateMappedFileService</span>
                <span style="color:#f92672">.</span><span style="color:#a6e22e">putRequestAndReturnMappedFile</span><span style="color:#f92672">(</span>nextFilePath<span style="color:#f92672">,</span>
                                               nextNextFilePath<span style="color:#f92672">,</span>
                                               <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileSize</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mappedFile <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// æ·»åŠ è‡³åˆ—è¡¨ä¸­
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFiles</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>mappedFile<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> mappedFile<span style="color:#f92672">;</span>

    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/transfer_mappedfile_from_requesttable.png" alt="è½¬ç§»æ–‡ä»¶åˆ°åˆ—è¡¨"></p>
<p>è‡³æ­¤ï¼Œ<code>MappedFile</code> å·²ç»åˆ›å»ºå®Œæ¯•ï¼Œä¹Ÿå³å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œäº†ã€‚</p>
<h2 id="ä¸‰æ–‡ä»¶åˆå§‹åŒ–">ä¸‰ã€æ–‡ä»¶åˆå§‹åŒ–</h2>
<p>åœ¨ <code>MappedFile</code> çš„æ„é€ å‡½æ•°ä¸­ï¼Œå…¶ä½¿ç”¨äº† <code>FileChannel</code> ç±»æä¾›çš„ map å‡½æ•°æ¥å°†ç£ç›˜ä¸Šçš„è¿™ä¸ªæ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ã€‚ç„¶åå½“é€šè¿‡ <code>MappedByteBuffer</code> æ¥è¯»å…¥æˆ–è€…å†™å…¥æ–‡ä»¶çš„æ—¶å€™ï¼Œç£ç›˜ä¸Šä¹Ÿä¼šæœ‰ç›¸åº”çš„æ”¹åŠ¨ã€‚é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œé€šå¸¸æ¯”ä¼ ç»Ÿçš„åŸºäºæ–‡ä»¶ IO æµçš„æ–¹å¼è¯»å–æ•ˆç‡é«˜ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MappedFile</span> <span style="color:#66d9ef">extends</span> ReferenceResource <span style="color:#f92672">{</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MappedFile</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String fileName<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> fileSize<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        init<span style="color:#f92672">(</span>fileName<span style="color:#f92672">,</span> fileSize<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String fileName<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> fileSize<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fileChannel</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RandomAccessFile<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;rw&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedByteBuffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fileChannel</span><span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>MapMode<span style="color:#f92672">.</span><span style="color:#a6e22e">READ_WRITE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> fileSize<span style="color:#f92672">);</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="å››æ¶ˆæ¯æ–‡ä»¶åŠ è½½">å››ã€æ¶ˆæ¯æ–‡ä»¶åŠ è½½</h2>
<p>å‰é¢æåˆ°è¿‡ï¼ŒBroker åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šåŠ è½½ç£ç›˜ä¸Šçš„æ–‡ä»¶åˆ°ä¸€ä¸ª <code>mappedFiles</code> åˆ—è¡¨ä¸­ã€‚ä½†æ˜¯åŠ è½½å®Œæ¯•åï¼Œå…¶è¿˜ä¼šå¯¹è¿™ä»½åˆ—è¡¨ä¸­çš„æ¶ˆæ¯æ–‡ä»¶è¿›è¡Œ<strong>éªŒè¯ (æ¢å¤)</strong>ï¼Œç¡®ä¿æ²¡æœ‰é”™è¯¯ã€‚</p>
<p>éªŒè¯çš„åŸºæœ¬æƒ³æ³•æ˜¯é€šè¿‡ä¸€ä¸€è¯»å–åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åå†ä¸€ä¸€è¯»å–æ¯ä¸ªæ–‡ä»¶ä¸­çš„æ¯ä¸ªæ¶ˆæ¯ï¼Œåœ¨è¯»å–çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä¼šæ›´æ–°æ•´ä½“çš„æ¶ˆæ¯å†™å…¥çš„åç§»é‡ï¼Œå¦‚ä¸‹å›¾ä¸­çš„çº¢è‰²ç®­å¤´ (æˆ‘ä»¬å‡è®¾æœ€ç»ˆè¯»å–çš„æ¶ˆæ¯çš„æ€»åç§»é‡ä¸º 905):</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/mappedfile_recover.png" alt="æ¢å¤æ–‡ä»¶"></p>
<p>å½“ç¡®å®šæ¶ˆæ¯æ•´ä½“çš„åç§»é‡ä¹‹åï¼ŒBroker ä¾¿ä¼šç¡®å®šæ¯ä¸€ä¸ªå•ç‹¬çš„ <code>MappedFile</code> æ–‡ä»¶çš„<strong>å„è‡ªçš„åç§»é‡</strong>ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶çš„åç§»é‡æ˜¯é€šè¿‡<strong>å–ä½™</strong>ç®—æ³•ç¡®å®šçš„:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MappedFileQueue</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">truncateDirtyFiles</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> offset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>MappedFile file <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFiles</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">long</span> fileTailOffset <span style="color:#f92672">=</span> file<span style="color:#f92672">.</span><span style="color:#a6e22e">getFileFromOffset</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileSize</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fileTailOffset <span style="color:#f92672">&gt;</span> offset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>offset <span style="color:#f92672">&gt;=</span> file<span style="color:#f92672">.</span><span style="color:#a6e22e">getFileFromOffset</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// ç¡®å®šæ¯ä¸ªæ–‡ä»¶çš„å„è‡ªåç§»é‡
</span><span style="color:#75715e"></span>                    file<span style="color:#f92672">.</span><span style="color:#a6e22e">setWrotePosition</span><span style="color:#f92672">((</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>offset <span style="color:#f92672">%</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileSize</span><span style="color:#f92672">));</span>
                    file<span style="color:#f92672">.</span><span style="color:#a6e22e">setCommittedPosition</span><span style="color:#f92672">((</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>offset <span style="color:#f92672">%</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileSize</span><span style="color:#f92672">));</span>
                    file<span style="color:#f92672">.</span><span style="color:#a6e22e">setFlushedPosition</span><span style="color:#f92672">((</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>offset <span style="color:#f92672">%</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileSize</span><span style="color:#f92672">));</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/update_mappedfile_position.png" alt="æ›´æ–°æ–‡ä»¶ä½ç½®"></p>
<p>åœ¨ç¡®å®šæ¯ä¸ªæ¶ˆæ¯æ–‡ä»¶å„è‡ªçš„å†™å…¥ä½ç½®çš„åŒæ—¶ï¼Œå…¶è¿˜ä¼šåˆ é™¤<strong>èµ·å§‹åç§»é‡</strong>å¤§äºå½“å‰æ€»åç§»é‡çš„æ¶ˆæ¯æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥è§†ä½œè„æ–‡ä»¶ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¯´è¿™äº›æ–‡ä»¶é‡Œé¢ä¸€æ¡æ¶ˆæ¯ä¹Ÿæ²¡æœ‰ã€‚è¿™ä¹Ÿæ˜¯ä¸Šè¿°æ–‡ä»¶ <code>1073741824</code> è¢«æ‰“ä¸Šçº¢å‰çš„åŸå› :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">truncateDirtyFiles</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> offset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    List<span style="color:#f92672">&lt;</span>MappedFile<span style="color:#f92672">&gt;</span> willRemoveFiles <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>MappedFile<span style="color:#f92672">&gt;();</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>MappedFile file <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFiles</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> fileTailOffset <span style="color:#f92672">=</span> file<span style="color:#f92672">.</span><span style="color:#a6e22e">getFileFromOffset</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileSize</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fileTailOffset <span style="color:#f92672">&gt;</span> offset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>offset <span style="color:#f92672">&gt;=</span> file<span style="color:#f92672">.</span><span style="color:#a6e22e">getFileFromOffset</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æ€»åç§»é‡ &lt; æ–‡ä»¶èµ·å§‹åç§»é‡
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// åŠ å…¥åˆ°å¾…åˆ é™¤åˆ—è¡¨ä¸­
</span><span style="color:#75715e"></span>                file<span style="color:#f92672">.</span><span style="color:#a6e22e">destroy</span><span style="color:#f92672">(</span>1000<span style="color:#f92672">);</span>
                willRemoveFiles<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>file<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">deleteExpiredFile</span><span style="color:#f92672">(</span>willRemoveFiles<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="äº”å†™å…¥æ¶ˆæ¯">äº”ã€å†™å…¥æ¶ˆæ¯</h2>
<p>ä¸€æ—¦æˆ‘ä»¬è·å–åˆ° <code>MappedFile</code> æ–‡ä»¶ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¾€è¿™ä¸ªæ–‡ä»¶é‡Œé¢å†™å…¥æ¶ˆæ¯äº†ã€‚å†™å…¥æ¶ˆæ¯å¯èƒ½ä¼šé‡è§å¦‚ä¸‹ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯è¿™æ¡æ¶ˆæ¯å¯ä»¥å®Œå…¨è¿½åŠ åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå¦å¤–ä¸€ç§æ˜¯è¿™æ¡æ¶ˆæ¯å®Œå…¨ä¸èƒ½æˆ–è€…åªæœ‰ä¸€å°éƒ¨åˆ†åªèƒ½å­˜æ”¾åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå…¶ä½™çš„éœ€è¦æ”¾åˆ°æ–°çš„æ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬å¯¹äºè¿™ä¸¤ç§æƒ…å†µåˆ†åˆ«è®¨è®º:</p>
<h3 id="1-æ–‡ä»¶å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯">(1) æ–‡ä»¶å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯</h3>
<p><code>MappedFile</code> ç±»ç»´æŠ¤äº†ä¸€ä¸ªç”¨ä»¥æ ‡è¯†å½“å‰å†™ä½ç½®çš„æŒ‡é’ˆ <code>wrotePosition</code>ï¼Œä»¥åŠä¸€ä¸ªç”¨æ¥æ˜ å°„æ–‡ä»¶åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„ <code>mappedByteBuffer</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MappedFile</span> <span style="color:#66d9ef">extends</span> ReferenceResource <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> AtomicInteger wrotePosition <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicInteger<span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">private</span> MappedByteBuffer mappedByteBuffer<span style="color:#f92672">;</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ç”±è¿™ä¸¤ä¸ªæ•°æ®ç»“æ„æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œå•ä¸ªæ–‡ä»¶çš„æ¶ˆæ¯å†™å…¥è¿‡ç¨‹å…¶å®æ˜¯éå¸¸ç®€å•çš„ã€‚é¦–å…ˆè·å–åˆ°è¿™ä¸ªæ–‡ä»¶çš„å†™å…¥ä½ç½®ï¼Œç„¶åå°†æ¶ˆæ¯å†…å®¹è¿½åŠ åˆ° <code>byteBuffer</code> ä¸­ï¼Œç„¶åå†æ›´æ–°å†™å…¥ä½ç½®ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MappedFile</span> <span style="color:#66d9ef">extends</span> ReferenceResource <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> AppendMessageResult <span style="color:#a6e22e">appendMessagesInner</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MessageExt messageExt<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> AppendMessageCallback cb<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    
        <span style="color:#66d9ef">int</span> currentPos <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">wrotePosition</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentPos <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fileSize</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            ByteBuffer byteBuffer <span style="color:#f92672">=</span>
                writeBuffer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span>
                writeBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">slice</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedByteBuffer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">slice</span><span style="color:#f92672">();</span>

            <span style="color:#75715e">// æ›´æ–° byteBuffer ä½ç½®
</span><span style="color:#75715e"></span>            byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">(</span>currentPos<span style="color:#f92672">);</span>

            <span style="color:#75715e">// å†™å…¥æ¶ˆæ¯å†…å®¹
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
            <span style="color:#75715e">// æ›´æ–° wrotePosition æŒ‡é’ˆçš„ä½ç½®
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">wrotePosition</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addAndGet</span><span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getWroteBytes</span><span style="color:#f92672">());</span>

            <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ç¤ºä¾‹æµç¨‹å¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/message_in_one_mappedfile.png" alt="æ¶ˆæ¯æ–‡ä»¶çš„ä½ç½®æŒ‡é’ˆ"></p>
<h3 id="2-æ–‡ä»¶ä¸å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯">(2) æ–‡ä»¶ä¸å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯</h3>
<p>åœ¨å†™å…¥æ¶ˆæ¯ä¹‹å‰ï¼Œå¦‚æœåˆ¤æ–­å‡ºæ–‡ä»¶å·²ç»æ»¡äº†çš„æƒ…å†µä¸‹ï¼Œå…¶ä¼šç›´æ¥å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>MappedFile</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLog</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> PutMessageResult <span style="color:#a6e22e">putMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MessageExtBrokerInner msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">// æ–‡ä»¶ä¸ºç©º || æ–‡ä»¶å·²ç»æ»¡äº†
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> mappedFile <span style="color:#f92672">||</span> mappedFile<span style="color:#f92672">.</span><span style="color:#a6e22e">isFull</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            mappedFile <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getLastMappedFile</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        
        result <span style="color:#f92672">=</span> mappedFile<span style="color:#f92672">.</span><span style="color:#a6e22e">appendMessage</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">appendMessageCallback</span><span style="color:#f92672">);</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å¦‚æœæ–‡ä»¶æœªæ»¡ï¼Œé‚£ä¹ˆåœ¨å†™å…¥ä¹‹å‰ä¼šå…ˆè®¡ç®—å‡ºæ¶ˆæ¯ä½“é•¿åº¦ <code>msgLen</code>ï¼Œç„¶ååˆ¤æ–­è¿™ä¸ªæ–‡ä»¶å‰©ä¸‹çš„ç©ºé—´æ˜¯å¦æœ‰èƒ½åŠ›å®¹çº³è¿™æ¡æ¶ˆæ¯ã€‚åœ¨è¿™ä¸ªåœ°æ–¹æˆ‘ä»¬è¿˜éœ€è¦ä»‹ç»ä¸‹æ¯æ¡æ¶ˆæ¯çš„å­˜å‚¨æ–¹å¼ã€‚</p>
<p>æ¯æ¡æ¶ˆæ¯çš„å­˜å‚¨æ˜¯æŒ‰ç…§ä¸€ä¸ª 4 å­—èŠ‚çš„é•¿åº¦æ¥åšç•Œé™çš„ï¼Œè¿™ä¸ªé•¿åº¦æœ¬èº«å°±æ˜¯æ•´ä¸ªæ¶ˆæ¯ä½“çš„é•¿åº¦ï¼Œå½“è¯»å®Œè¿™æ•´æ¡æ¶ˆæ¯ä½“çš„é•¿åº¦ä¹‹åï¼Œä¸‹ä¸€æ¬¡å†å–å‡ºæ¥çš„ä¸€ä¸ª 4 å­—èŠ‚çš„æ•°å­—ï¼Œä¾¿åˆæ˜¯ä¸‹ä¸€æ¡æ¶ˆæ¯çš„é•¿åº¦:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/length_based_message_limit.png" alt="æ¶ˆæ¯å­˜å‚¨æ ¼å¼"></p>
<p>å›´ç»•ç€ä¸€æ¡æ¶ˆæ¯ï¼Œè¿˜ä¼šå­˜å‚¨è®¸å¤šå…¶å®ƒå†…å®¹ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåªéœ€è¦äº†è§£å‰ä¸¤ä½æ˜¯ 4 å­—èŠ‚çš„é•¿åº¦å’Œ 4 å­—èŠ‚çš„ MAGICCODE å³å¯:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/message_serialize_header.png" alt="æ¶ˆæ¯å¤´"></p>
<p><code>MAGICCODE</code> çš„å¯é€‰å€¼æœ‰:</p>
<ul>
<li><code>CommitLog.MESSAGE_MAGIC_CODE</code></li>
<li><code>CommitLog.BLANK_MAGIC_CODE</code></li>
</ul>
<p>å½“è¿™ä¸ªæ–‡ä»¶æœ‰èƒ½åŠ›å®¹çº³è¿™æ¡æ¶ˆæ¯ä½“çš„æƒ…å†µä¸‹ï¼Œå…¶ä¾¿ä¼šå­˜å‚¨ <code>MESSAGE_MAGIC_CODE</code> å€¼ï¼›å½“è¿™ä¸ªæ–‡ä»¶æ²¡æœ‰èƒ½åŠ›å®¹çº³è¿™æ¡æ¶ˆæ¯ä½“çš„æƒ…å†µä¸‹ï¼Œå…¶ä¾¿ä¼šå­˜å‚¨ <code>BLANK_MAGIC_CODE</code> å€¼ã€‚æ‰€ä»¥è¿™ä¸ª <code>MAGICCODE</code> æ˜¯ç”¨æ¥ç•Œå®šè¿™æ˜¯ç©ºæ¶ˆæ¯è¿˜æ˜¯ä¸€æ¡æ­£å¸¸çš„æ¶ˆæ¯ã€‚</p>
<p>å½“åˆ¤å®šè¿™ä¸ªæ–‡ä»¶ä¸è¶³ä»¥å®¹çº³æ•´ä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œå…¶å°†æ¶ˆæ¯ä½“é•¿åº¦è®¾ç½®ä¸ºè¿™ä¸ªæ–‡ä»¶å‰©ä½™çš„æœ€å¤§ç©ºé—´é•¿åº¦ï¼Œå°† <code>MAGICCODE</code> è®¾å®šä¸ºè¿™æ˜¯ä¸€ä¸ªç©ºæ¶ˆæ¯æ–‡ä»¶ (éœ€è¦å»ä¸‹ä¸€ä¸ªæ–‡ä»¶å»è¯»)ã€‚ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¶ˆæ¯ä½“é•¿åº¦ å’Œ <code>MAGICCODE</code> æ˜¯åˆ¤åˆ«ä¸€æ¡æ¶ˆæ¯æ ¼å¼çš„æœ€åŸºæœ¬è¦æ±‚ï¼Œè¿™ä¹Ÿæ˜¯ <code>END_FILE_MIN_BLANK_LENGTH</code> çš„å€¼ä¸º 8 çš„åŸå› :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// CommitLog.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DefaultAppendMessageCallback</span> <span style="color:#66d9ef">implements</span> AppendMessageCallback <span style="color:#f92672">{</span>

    <span style="color:#75715e">// File at the end of the minimum fixed length empty
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> END_FILE_MIN_BLANK_LENGTH <span style="color:#f92672">=</span> 4 <span style="color:#f92672">+</span> 4<span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">public</span> AppendMessageResult <span style="color:#a6e22e">doAppend</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> fileFromOffset<span style="color:#f92672">,</span>
                                        <span style="color:#66d9ef">final</span> ByteBuffer byteBuffer<span style="color:#f92672">,</span>
                                        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> maxBlank<span style="color:#f92672">,</span>
                                        <span style="color:#66d9ef">final</span> MessageExtBrokerInner msgInner<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>msgLen <span style="color:#f92672">+</span> END_FILE_MIN_BLANK_LENGTH<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> maxBlank<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
            <span style="color:#75715e">// 1 TOTALSIZE
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msgStoreItemMemory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putInt</span><span style="color:#f92672">(</span>maxBlank<span style="color:#f92672">);</span>
            <span style="color:#75715e">// 2 MAGICCODE
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msgStoreItemMemory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putInt</span><span style="color:#f92672">(</span>CommitLog<span style="color:#f92672">.</span><span style="color:#a6e22e">BLANK_MAGIC_CODE</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">// 3 The remaining space may be any value
</span><span style="color:#75715e"></span>            byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msgStoreItemMemory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">array</span><span style="color:#f92672">(),</span> 0<span style="color:#f92672">,</span> maxBlank<span style="color:#f92672">);</span>
            
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> AppendMessageResult<span style="color:#f92672">(</span>AppendMessageStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">END_OF_FILE</span><span style="color:#f92672">,</span>
                                           <span style="color:#75715e">/** other params **/</span> <span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>ç”±ä¸Šè¿°æ–¹æ³•æˆ‘ä»¬çœ‹å‡ºåœ¨è¿™ç§æƒ…å†µä¸‹è¿”å›çš„ç»“æœæ˜¯ <code>END_OF_FILE</code>ã€‚å½“æ£€æµ‹åˆ°è¿™ç§è¿”å›ç»“æœçš„æ—¶å€™ï¼Œ<code>CommitLog</code> æ¥ç€åˆä¼šç”³è¯·åˆ›å»ºæ–°çš„ <code>MappedFile</code> å¹¶å°è¯•å†™å…¥æ¶ˆæ¯ã€‚è¿½åŠ æ–¹æ³•åŒ (1) ç›¸åŒï¼Œä¸å†èµ˜è¿°:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/file_tail_message.png" alt="æ–‡ä»¶å°¾éƒ¨"></p>
<blockquote>
<p>æ³¨: åœ¨æ¶ˆæ¯æ–‡ä»¶åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä¹Ÿæ˜¯é€šè¿‡åˆ¤æ–­ <code>MAGICCODE</code> çš„ç±»å‹ï¼Œæ¥åˆ¤æ–­æ˜¯å¦ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ª <code>MappedFile</code> æ¥è®¡ç®—æ•´ä½“æ¶ˆæ¯åç§»é‡çš„ã€‚</p>
</blockquote>
<h2 id="å…­æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥">å…­ã€æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥</h2>
<p>å½“æ¶ˆæ¯ä½“è¿½åŠ åˆ° <code>MappedFile</code> ä»¥åï¼Œè¿™æ¡æ¶ˆæ¯å®é™…ä¸Šè¿˜åªæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤è¿˜éœ€è¦å°†å†…å­˜ä¸­çš„å†…å®¹åˆ·åˆ°ç£ç›˜ä¸Šæ‰ç®—çœŸæ­£çš„å­˜å‚¨ä¸‹æ¥ï¼Œæ‰èƒ½ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œåˆ·ç›˜æœ‰ä¸¤ç§ç­–ç•¥: å¼‚æ­¥åˆ·ç›˜å’ŒåŒæ­¥åˆ·ç›˜ã€‚</p>
<h3 id="1-å¼‚æ­¥åˆ·ç›˜">(1) å¼‚æ­¥åˆ·ç›˜</h3>
<p>å½“é…ç½®ä¸ºå¼‚æ­¥åˆ·ç›˜ç­–ç•¥çš„æ—¶å€™ï¼ŒBroker ä¼šè¿è¡Œä¸€ä¸ªæœåŠ¡ <code>FlushRealTimeService</code> ç”¨æ¥åˆ·æ–°ç¼“å†²åŒºçš„æ¶ˆæ¯å†…å®¹åˆ°ç£ç›˜ï¼Œè¿™ä¸ªæœåŠ¡ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ¥åšåˆ·ç›˜è¿™ä»¶äº‹æƒ…ï¼Œé»˜è®¤æƒ…å†µä¸‹æ¯éš” 500ms æ¥æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦åˆ·ç›˜:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FlushRealTimeService</span> <span style="color:#66d9ef">extends</span> FlushCommitLogService <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>

        <span style="color:#75715e">// ä¸åœè¿è¡Œ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isStopped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>

            <span style="color:#75715e">// interval é»˜è®¤å€¼æ˜¯ 500ms
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flushCommitLogTimed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>interval<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">waitForRunning</span><span style="color:#f92672">(</span>interval<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// åˆ·ç›˜
</span><span style="color:#75715e"></span>            CommitLog<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">(</span>flushPhysicQueueLeastPages<span style="color:#f92672">);</span>

        <span style="color:#f92672">}</span>
        
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨è¿½åŠ æ¶ˆæ¯å®Œæ¯•ä¹‹åï¼Œé€šè¿‡<strong>å”¤é†’</strong>è¿™ä¸ªæœåŠ¡ç«‹å³æ£€æŸ¥ä»¥ä¸‹æ˜¯å¦éœ€è¦åˆ·ç›˜:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLog</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleDiskFlush</span><span style="color:#f92672">(</span>AppendMessageResult result<span style="color:#f92672">,</span>
                                PutMessageResult putMessageResult<span style="color:#f92672">,</span>
                                MessageExt messageExt<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Synchronization flush
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>FlushDiskType<span style="color:#f92672">.</span><span style="color:#a6e22e">SYNC_FLUSH</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStoreConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getFlushDiskType</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// Asynchronous flush
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStoreConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isTransientStorePoolEnable</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// æ¶ˆæ¯è¿½åŠ æˆåŠŸåï¼Œç«‹å³å”¤é†’æœåŠ¡
</span><span style="color:#75715e"></span>                flushCommitLogService<span style="color:#f92672">.</span><span style="color:#a6e22e">wakeup</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="2-åŒæ­¥åˆ·ç›˜">(2) åŒæ­¥åˆ·ç›˜</h3>
<p>å½“é…ç½®ä¸ºåŒæ­¥åˆ·ç›˜ç­–ç•¥çš„æ—¶å€™ï¼ŒBroker è¿è¡Œä¸€ä¸ªå«åš <code>GroupCommitService</code> æœåŠ¡ã€‚åœ¨è¿™ä¸ªæœåŠ¡å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª<strong>å†™è¯·æ±‚</strong>é˜Ÿåˆ—å’Œä¸€ä¸ª<strong>è¯»è¯·æ±‚</strong>é˜Ÿåˆ—ï¼Œå…¶ä¸­è¿™ä¸¤ä¸ªé˜Ÿåˆ—æ¯éš” 10ms å°±äº¤æ¢ä¸€ä¸‹â€œèº«ä»½â€ï¼Œè¿™ä¹ˆåšçš„ç›®çš„å…¶å®ä¹Ÿæ˜¯ä¸ºäº†<strong>è¯»å†™åˆ†ç¦»</strong>:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/swap_list.png" alt="è¯»é˜Ÿåˆ—å’Œå†™é˜Ÿåˆ—äº¤æ¢"></p>
<p>åœ¨è¿™ä¸ªæœåŠ¡å†…éƒ¨ï¼Œæ¯éš” 10ms å°±ä¼šæ£€æŸ¥è¯»è¯·æ±‚é˜Ÿåˆ—æ˜¯å¦ä¸ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ä¼šå°†è¯»é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰è¯·æ±‚æ‰§è¡Œåˆ·ç›˜ï¼Œå¹¶æ¸…ç©ºè¯»è¯·æ±‚é˜Ÿåˆ—:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GroupCommitService</span> <span style="color:#66d9ef">extends</span> FlushCommitLogService <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doCommit</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ£€æŸ¥æ‰€æœ‰è¯»é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>GroupCommitRequest req <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requestsRead</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// æ¯ä¸ªè¯·æ±‚æ‰§è¡Œåˆ·ç›˜
</span><span style="color:#75715e"></span>            CommitLog<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mappedFileQueue</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
            req<span style="color:#f92672">.</span><span style="color:#a6e22e">wakeupCustomer</span><span style="color:#f92672">(</span>flushOK<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requestsRead</span><span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>åœ¨è¿½åŠ æ¶ˆæ¯å®Œæ¯•ä¹‹åï¼Œé€šè¿‡åˆ›å»ºä¸€ä¸ªè¯·æ±‚åˆ·ç›˜çš„å¯¹è±¡ï¼Œç„¶åé€šè¿‡ <code>putRequest()</code> æ–¹æ³•æ”¾å…¥å†™è¯·æ±‚é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªæ—¶å€™ä¼šç«‹å³å”¤é†’è¿™ä¸ªæœåŠ¡ï¼Œå†™é˜Ÿåˆ—å’Œè¯»é˜Ÿåˆ—çš„è§’è‰²ä¼šè¿›è¡Œäº¤æ¢ï¼Œäº¤æ¢è§’è‰²ä¹‹åï¼Œè¯»è¯·æ±‚é˜Ÿåˆ—å°±ä¸ä¸ºç©ºï¼Œç»§è€Œå¯ä»¥æ‰§è¡Œæ‰€æœ‰åˆ·ç›˜è¯·æ±‚äº†ã€‚è€Œåœ¨è¿™æœŸé—´ï¼ŒBroker ä¼šä¸€ç›´é˜»å¡ç­‰å¾…æœ€å¤š 5 ç§’é’Ÿï¼Œåœ¨è¿™æœŸé—´å¦‚æœå®Œä¸æˆåˆ·ç›˜è¯·æ±‚çš„è¯ï¼Œé‚£ä¹ˆè§†ä½œåˆ·ç›˜è¶…æ—¶:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLog</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleDiskFlush</span><span style="color:#f92672">(</span>AppendMessageResult result<span style="color:#f92672">,</span>
                                PutMessageResult putMessageResult<span style="color:#f92672">,</span>
                                MessageExt messageExt<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Synchronization flush
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>FlushDiskType<span style="color:#f92672">.</span><span style="color:#a6e22e">SYNC_FLUSH</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStoreConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getFlushDiskType</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>messageExt<span style="color:#f92672">.</span><span style="color:#a6e22e">isWaitStoreMsgOK</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                GroupCommitRequest request <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> GroupCommitRequest<span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getWroteOffset</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">getWroteBytes</span><span style="color:#f92672">());</span>
                service<span style="color:#f92672">.</span><span style="color:#a6e22e">putRequest</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
                <span style="color:#75715e">// ç­‰å¾…åˆ·ç›˜æˆåŠŸ
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">boolean</span> flushOK <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">waitForFlush</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMessageStore</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStoreConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getSyncFlushTimeout</span><span style="color:#f92672">());</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>flushOK<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// åˆ·ç›˜è¶…æ—¶
</span><span style="color:#75715e"></span>                    putMessageResult<span style="color:#f92672">.</span><span style="color:#a6e22e">setPutMessageStatus</span><span style="color:#f92672">(</span>PutMessageStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">FLUSH_DISK_TIMEOUT</span><span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// Asynchronous flush
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>é€šè¿‡æ–¹æ³• <code>putRequest</code> æ”¾å…¥è¯·æ±‚åçš„æœåŠ¡æ‰§è¡Œæµç¨‹:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/putRequest.png" alt="æ”¾å…¥è¯·æ±‚"></p>
<h2 id="ä¸ƒæ¶ˆæ¯åˆ·ç›˜ç†å¿µ">ä¸ƒã€æ¶ˆæ¯åˆ·ç›˜ç†å¿µ</h2>
<p>æˆ‘ä»¬åœ¨è¿™é‡Œå·²ç»çŸ¥é“æ¶ˆæ¯åˆ·ç›˜æœ‰åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ç­–ç•¥ï¼Œå¯¹åº”çš„æ˜¯ <code>GroupCommitService</code> å’Œ <code>FlushRealTimeService</code> è¿™ä¸¤ç§ä¸åŒçš„æœåŠ¡ã€‚</p>
<p>è¿™ä¸¤ç§æœåŠ¡éƒ½æœ‰å®šæ—¶è¯·æ±‚åˆ·ç›˜çš„æœºåˆ¶ï¼Œä½†æ˜¯æœºåˆ¶èƒŒåæœ€ç»ˆè°ƒç”¨çš„åˆ·ç›˜æ–¹å¼å…¨éƒ¨éƒ½é›†ä¸­åœ¨ <code>flush</code> è¿™ä¸ªæ–¹æ³•ä¸Š:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MappedFileQueue</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">flush</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> flushLeastPages<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å†ç»§ç»­å‘ä¸‹åˆ†æè¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå¯¹ç…§ç€è¿™å¼ å›¾è¯´æ˜ä¸€ä¸‹ä½¿ç”¨ <code>MappedByteBuffer</code> æ¥ç®€è¦é˜è¿°è¯»å’Œå†™æ–‡ä»¶çš„ç®€å•è¿‡ç¨‹ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/mmap_readInt_and_writeInt.png" alt="mmap"></p>
<p>æ“ä½œç³»ç»Ÿä¸ºäº†èƒ½å¤Ÿä½¿å¤šä¸ªè¿›ç¨‹åŒæ—¶ä½¿ç”¨å†…å­˜ï¼Œåˆä¿è¯å„ä¸ªè¿›ç¨‹è®¿é—®å†…å­˜äº’ç›¸ç‹¬ç«‹ï¼Œäºæ˜¯ä¸ºæ¯ä¸ªè¿›ç¨‹å¼•å…¥äº†<strong>åœ°å€ç©ºé—´</strong>çš„æ¦‚å¿µï¼Œåœ°å€ç©ºé—´ä¸Šçš„åœ°å€å«åš<strong>è™šæ‹Ÿåœ°å€</strong>ï¼Œè€Œç¨‹åºæƒ³è¦è¿è¡Œå¿…é¡»æ”¾åˆ°<strong>ç‰©ç†åœ°å€</strong>ä¸Šè¿è¡Œæ‰å¯ä»¥ã€‚åœ°å€ç©ºé—´ä¸ºè¿›ç¨‹<strong>è¥é€ å‡ºäº†ä¸€ç§å‡è±¡</strong>ï¼šâ€æ•´å°è®¡ç®—æœºåªæœ‰æˆ‘ä¸€ä¸ªç¨‹åºåœ¨è¿è¡Œï¼Œè¿™å°è®¡ç®—æœºå†…å­˜å¾ˆå¤§â€ã€‚ä¸€ä¸ªåœ°å€ç©ºé—´å†…åŒ…å«ç€è¿™ä¸ªè¿›ç¨‹æ‰€éœ€è¦çš„å…¨éƒ¨çŠ¶æ€ä¿¡æ¯ã€‚é€šå¸¸ä¸€ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ä¼šæŒ‰ç…§é€»è¾‘åˆ†æˆå¥½å¤š<strong>æ®µ</strong>ï¼Œæ¯”å¦‚<strong>ä»£ç æ®µã€å †æ®µã€æ ˆæ®µ</strong>ç­‰ã€‚ä¸ºäº†è¿›ä¸€æ­¥æœ‰æ•ˆåˆ©ç”¨å†…å­˜ï¼Œæ¯ä¸€æ®µåˆç»†åˆ†æˆäº†ä¸åŒçš„<strong>é¡µ (page)</strong>ã€‚ä¸æ­¤ç›¸å¯¹åº”ï¼Œè®¡ç®—æœºçš„ç‰©ç†å†…å­˜è¢«åˆ‡æˆäº†<strong>é¡µå¸§ (page frame)</strong>ï¼Œæ–‡ä»¶è¢«åˆ†æˆäº†<strong>å— (block)</strong>ã€‚æ—¢ç„¶ç¨‹åºå®é™…è¿è¡Œçš„æ—¶å€™è¿˜æ˜¯å¾—ä¾èµ–ç‰©ç†å†…å­˜çš„åœ°å€ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ï¼Œè¿™ä¸ªæ˜ å°„å…³ç³»æ˜¯ç”±**é¡µè¡¨ (page table)**æ¥å®Œæˆçš„ã€‚</p>
<p>å¦å¤–åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿˜æœ‰ä¸€å±‚<strong>ç£ç›˜ç¼“å­˜ (disk cache)<strong>çš„æ¦‚å¿µï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥å‡å°‘å¯¹ç£ç›˜çš„ I/O æ“ä½œã€‚ç£ç›˜ç¼“å­˜æ˜¯ä»¥é¡µä¸ºå•ä½çš„ï¼Œå†…å®¹å°±æ˜¯ç£ç›˜ä¸Šçš„ç‰©ç†å—ï¼Œæ‰€ä»¥åˆç§°ä¹‹ä¸º</strong>é¡µç¼“å­˜ (page cache)</strong>ã€‚å½“è¿›ç¨‹å‘èµ·ä¸€ä¸ªè¯»æ“ä½œ ï¼ˆæ¯”å¦‚ï¼Œè¿›ç¨‹å‘èµ·ä¸€ä¸ª read() ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œå®ƒé¦–å…ˆä¼šæ£€æŸ¥éœ€è¦çš„æ•°æ®æ˜¯å¦åœ¨é¡µç¼“å­˜ä¸­ã€‚å¦‚æœåœ¨ï¼Œåˆ™æ”¾å¼ƒè®¿é—®ç£ç›˜ï¼Œè€Œç›´æ¥ä»é¡µç¼“å­˜ä¸­è¯»å–ã€‚å¦‚æœæ•°æ®æ²¡åœ¨ç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆå†…æ ¸å¿…é¡»è°ƒåº¦å— I/O æ“ä½œä»ç£ç›˜å»è¯»å–æ•°æ®ï¼Œç„¶åå°†è¯»æ¥çš„æ•°æ®æ”¾å…¥é¡µç¼“å­˜ä¸­ã€‚ç³»ç»Ÿå¹¶ä¸ä¸€å®šè¦å°†æ•´ä¸ªæ–‡ä»¶éƒ½ç¼“å­˜ï¼Œå®ƒå¯ä»¥åªå­˜å‚¨ä¸€ä¸ªæ–‡ä»¶çš„ä¸€é¡µæˆ–è€…å‡ é¡µã€‚</p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“è°ƒç”¨ <code>FileChannel.map()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå°†è¿™ä¸ªæ–‡ä»¶<strong>æ˜ å°„</strong>è¿›ç”¨æˆ·ç©ºé—´çš„åœ°å€ç©ºé—´ä¸­ï¼Œæ³¨æ„ï¼Œå»ºç«‹æ˜ å°„ä¸ä¼šæ‹·è´ä»»ä½•æ•°æ®ã€‚æˆ‘ä»¬å‰é¢æåˆ°è¿‡ Broker å¯åŠ¨çš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ªæ¶ˆæ¯æ–‡ä»¶åŠ è½½çš„è¿‡ç¨‹ï¼Œå½“ç¬¬ä¸€æ¬¡å¼€å§‹è¯»å–æ•°æ®çš„æ—¶å€™:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// é¦–æ¬¡è¯»å–æ•°æ®
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> totalSize <span style="color:#f92672">=</span> byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">getInt</span><span style="color:#f92672">();</span>
</code></pre></div><p>è¿™ä¸ªæ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡æŸ¥è¯¢é¡µè¡¨ï¼Œä¼šå‘ç°æ–‡ä»¶çš„è¿™éƒ¨åˆ†æ•°æ®è¿˜ä¸åœ¨å†…å­˜ä¸­ã€‚äºæ˜¯å°±ä¼šè§¦å‘ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸ (page faults)ï¼Œè¿™ä¸ªæ—¶å€™æ“ä½œç³»ç»Ÿä¼šå¼€å§‹ä»ç£ç›˜è¯»å–è¿™ä¸€é¡µæ•°æ®ï¼Œç„¶åå…ˆæ”¾å…¥åˆ°é¡µç¼“å­˜ä¸­ï¼Œç„¶åå†æ”¾å…¥å†…å­˜ä¸­ã€‚åœ¨ç¬¬ä¸€æ¬¡è¯»å–æ–‡ä»¶çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿä¼šè¯»å…¥æ‰€è¯·æ±‚çš„é¡µé¢ï¼Œå¹¶è¯»å…¥ç´§éšå…¶åçš„å°‘æ•°å‡ ä¸ªé¡µé¢ï¼ˆ<strong>ä¸å°‘äºä¸€ä¸ªé¡µé¢ï¼Œé€šå¸¸æ˜¯ä¸‰ä¸ªé¡µé¢</strong>ï¼‰ï¼Œè¿™æ—¶çš„é¢„è¯»ç§°ä¸º<strong>åŒæ­¥é¢„è¯»</strong> (å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²éƒ¨åˆ†æ˜¯éœ€è¦è¯»å–çš„é¡µé¢ï¼Œè“è‰²çš„é‚£ä¸‰ä¸ªæ¡†æ˜¯æ“ä½œç³»ç»Ÿé¢„å…ˆè¯»å–çš„):</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/linux_filecache_readahead.png" alt="åŒæ­¥é¢„è¯»"></p>
<p>å½“ç„¶éšç€æ—¶é—´æ¨ç§»ï¼Œé¢„è¯»å‘½ä¸­çš„è¯ï¼Œé‚£ä¹ˆç›¸åº”çš„é¢„è¯»é¡µé¢æ•°é‡ä¹Ÿä¼šå¢åŠ ï¼Œä½†æ˜¯èƒ½å¤Ÿç¡®è®¤çš„æ˜¯ï¼Œä¸€ä¸ªæ–‡ä»¶è‡³å°‘æœ‰ 4 ä¸ªé¡µé¢å¤„åœ¨é¡µç¼“å­˜ä¸­ã€‚å½“æ–‡ä»¶ä¸€ç›´å¤„äº<strong>é¡ºåºè¯»å–</strong>çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆåŸºæœ¬ä¸Šå¯ä»¥ä¿è¯æ¯æ¬¡<strong>é¢„è¯»å‘½ä¸­</strong>:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/readahead_hit.png" alt="é¢„è¯»å‘½ä¸­"></p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥è¯´æ–‡ä»¶å†™ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“å°è¯•è°ƒç”¨ <code>writeInt()</code> å†™æ•°æ®åˆ°æ–‡ä»¶é‡Œé¢çš„è¯ï¼Œå…¶å†™åˆ°é¡µç¼“å­˜å±‚ï¼Œè¿™ä¸ªæ–¹æ³•å°±ä¼šè¿”å›äº†ã€‚è¿™ä¸ªæ—¶å€™æ•°æ®è¿˜æ²¡æœ‰çœŸæ­£çš„ä¿å­˜åˆ°æ–‡ä»¶ä¸­å»ï¼ŒLinux ä»…ä»…å°†é¡µç¼“å­˜ä¸­çš„è¿™ä¸€é¡µæ•°æ®æ ‡è®°ä¸ºâ€œ<strong>è„</strong>â€ï¼Œå¹¶ä¸”è¢«åŠ å…¥åˆ°è„é¡µé“¾è¡¨ä¸­ã€‚ç„¶åç”±ä¸€ç¾¤è¿›ç¨‹ï¼ˆ<strong>flusher å›å†™è¿›ç¨‹</strong>ï¼‰å‘¨æœŸæ€§å°†è„é¡µé“¾è¡¨ä¸­çš„é¡µå†™ä¼šåˆ°ç£ç›˜ï¼Œä»è€Œè®©ç£ç›˜ä¸­çš„æ•°æ®å’Œå†…å­˜ä¸­ä¿æŒä¸€è‡´ï¼Œæœ€åæ¸…ç†â€œè„â€æ ‡è¯†ã€‚åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹ï¼Œè„é¡µä¼šè¢«å†™å›ç£ç›˜:</p>
<ul>
<li>ç©ºé—²å†…å­˜ä½äºä¸€ä¸ªç‰¹å®šé˜ˆå€¼</li>
<li>è„é¡µåœ¨å†…å­˜ä¸­é©»ç•™è¶…è¿‡ä¸€ä¸ªç‰¹å®šçš„é˜ˆå€¼æ—¶</li>
<li>å½“ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ <code>sync()</code> å’Œ <code>fsync()</code> ç³»ç»Ÿè°ƒç”¨æ—¶</li>
</ul>
<p>å¯è§ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå³ä½¿ä¸é‡‡ç”¨åˆ·ç›˜ç­–ç•¥ï¼Œæ•°æ®æœ€ç»ˆä¹Ÿæ˜¯ä¼šè¢«åŒæ­¥åˆ°ç£ç›˜ä¸­å»çš„:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/write_to_page_cache.png" alt="é¡µå†™å…¥ç¼“å­˜"></p>
<p>ä½†æ˜¯ï¼Œå³ä¾¿æœ‰ <code>flusher</code> çº¿ç¨‹æ¥å®šæ—¶åŒæ­¥æ•°æ®ï¼Œå¦‚æœæ­¤æ—¶æœºå™¨æ–­ç”µçš„è¯ï¼Œæ¶ˆæ¯ä¾ç„¶æœ‰å¯èƒ½ä¸¢å¤±ã€‚RocketMQ ä¸ºäº†ä¿è¯æ¶ˆæ¯å°½å¯èƒ½çš„ä¸ä¸¢å¤±ï¼Œä¸ºäº†æœ€å¤§çš„é«˜å¯é æ€§ï¼Œåšäº†åŒæ­¥å’Œå¼‚æ­¥åˆ·ç›˜ç­–ç•¥ï¼Œæ¥æ‰‹åŠ¨è¿›è¡ŒåŒæ­¥:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/force_sync_data_to_disk.png" alt="å¼ºåˆ¶åˆ·æ–°"></p>
<h2 id="å…«æ¶ˆæ¯åˆ·ç›˜è¿‡ç¨‹">å…«ã€æ¶ˆæ¯åˆ·ç›˜è¿‡ç¨‹</h2>
<p>åœ¨ä»‹ç»å®Œä¸Šè¿°æ¶ˆæ¯åˆ·ç›˜èƒŒåçš„ä¸€äº›æœºåˆ¶å’Œç†å¿µåï¼Œæˆ‘ä»¬å†æ¥åˆ†æåˆ·ç›˜æ•´ä¸ªè¿‡ç¨‹ã€‚é¦–å…ˆï¼Œæ— è®ºåŒæ­¥åˆ·ç›˜è¿˜æ˜¯å¼‚æ­¥åˆ·ç›˜ï¼Œå…¶çº¿ç¨‹éƒ½åœ¨ä¸€ç›´å‘¨æœŸæ€§çš„å°è¯•æ‰§è¡Œåˆ·ç›˜ï¼Œåœ¨çœŸæ­£æ‰§è¡Œåˆ·ç›˜å‡½æ•°çš„è°ƒç”¨ä¹‹å‰ï¼ŒBroker ä¼šæ£€æŸ¥æ–‡ä»¶çš„å†™ä½ç½®æ˜¯å¦å¤§äº <code>flush</code> ä½ç½®ï¼Œé¿å…æ‰§è¡Œæ— æ„ä¹‰çš„åˆ·ç›˜ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/wrote_position_vs_flushed_position.png" alt="å†™å…¥ä½ç½®å’Œåˆ·æ–°ä½ç½®"></p>
<p>å…¶æ¬¡ï¼Œå¯¹äºå¼‚æ­¥åˆ·ç›˜æ¥è®²ï¼ŒBroker æ‰§è¡Œäº†æ›´ä¸ºä¸¥æ ¼çš„åˆ·ç›˜é™åˆ¶ç­–ç•¥ï¼Œå½“åœ¨æŸä¸ªæ—¶é—´ç‚¹å°è¯•æ‰§è¡Œåˆ·ç›˜ä¹‹åï¼Œåœ¨æ¥ä¸‹æ¥ 10 ç§’å†…ï¼Œå¦‚æœæƒ³è¦ç»§ç»­åˆ·ç›˜ï¼Œé‚£ä¹ˆè„é¡µé¢æ•°é‡å¿…é¡»ä¸å°äº 4 é¡µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/FlushRealTimeService_flush_condition.png" alt="åˆ·ç›˜æ¡ä»¶"></p>
<p>ä¸‹é¢æ˜¯æ‰§è¡Œåˆ·ç›˜å‰æœ€åæ£€æŸ¥çš„åˆ·ç›˜æ¡ä»¶ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MappedFile</span> <span style="color:#66d9ef">extends</span> ReferenceResource <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isAbleToFlush</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> flushLeastPages<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> flush <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flushedPosition</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">int</span> write <span style="color:#f92672">=</span> getReadPosition<span style="color:#f92672">();</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isFull</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flushLeastPages <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è®¡ç®—å½“å‰è„é¡µé¢ç®—æ³•
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span>write <span style="color:#f92672">/</span> OS_PAGE_SIZE<span style="color:#f92672">)</span> <span style="color:#f92672">-</span> <span style="color:#f92672">(</span>flush <span style="color:#f92672">/</span> OS_PAGE_SIZE<span style="color:#f92672">))</span> <span style="color:#f92672">&gt;=</span> flushLeastPages<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// wrotePosition &gt; flushedPosition
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> write <span style="color:#f92672">&gt;</span> flush<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“åˆ·ç›˜å®Œæ¯•ä¹‹åï¼Œé¦–å…ˆä¼šæ›´æ–°è¿™ä¸ªæ–‡ä»¶çš„ <code>flush</code> ä½ç½®ï¼Œç„¶åå†æ›´æ–° <code>MappedFileQueue</code> çš„æ•´ä½“çš„ <code>flush</code> ä½ç½®:</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/update_flush_position.png" alt="æ›´æ–° flush ä½ç½®"></p>
<p>å½“åˆ·ç›˜å®Œæ¯•ä¹‹åï¼Œä¾¿ä¼šå°†ç»“æœé€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼Œå‘ŠçŸ¥å‘é€æ¶ˆæ¯æˆåŠŸã€‚è‡³æ­¤ï¼Œæ•´ä¸ªå­˜å‚¨è¿‡ç¨‹å®Œæ¯•ã€‚</p>
<p>æ‰«æä¸‹é¢äºŒç»´ç ï¼Œåœ¨æ‰‹æœºç«¯é˜…è¯»ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-message-store-flow/qrcode.png" alt=""></p>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>

  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'Hw2fQnNQyghcgeRvQosC5cIy-gzGzoHsz',
        appKey: '0ULuPWcxGRLCaHz84icXvBgn',
        notify: 'false', 
        verify: 'false', 
        avatar:'mm', 
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆå§...',
        visitor: 'true'
    });
  </script></div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€å­˜å‚¨ä½ç½®">ä¸€ã€å­˜å‚¨ä½ç½®</a></li>
    <li><a href="#äºŒæ–‡ä»¶åˆ›å»º">äºŒã€æ–‡ä»¶åˆ›å»º</a></li>
    <li><a href="#ä¸‰æ–‡ä»¶åˆå§‹åŒ–">ä¸‰ã€æ–‡ä»¶åˆå§‹åŒ–</a></li>
    <li><a href="#å››æ¶ˆæ¯æ–‡ä»¶åŠ è½½">å››ã€æ¶ˆæ¯æ–‡ä»¶åŠ è½½</a></li>
    <li><a href="#äº”å†™å…¥æ¶ˆæ¯">äº”ã€å†™å…¥æ¶ˆæ¯</a>
      <ul>
        <li><a href="#1-æ–‡ä»¶å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯">(1) æ–‡ä»¶å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯</a></li>
        <li><a href="#2-æ–‡ä»¶ä¸å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯">(2) æ–‡ä»¶ä¸å¯ä»¥å®Œå…¨å­˜å‚¨æ¶ˆæ¯</a></li>
      </ul>
    </li>
    <li><a href="#å…­æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥">å…­ã€æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥</a>
      <ul>
        <li><a href="#1-å¼‚æ­¥åˆ·ç›˜">(1) å¼‚æ­¥åˆ·ç›˜</a></li>
        <li><a href="#2-åŒæ­¥åˆ·ç›˜">(2) åŒæ­¥åˆ·ç›˜</a></li>
      </ul>
    </li>
    <li><a href="#ä¸ƒæ¶ˆæ¯åˆ·ç›˜ç†å¿µ">ä¸ƒã€æ¶ˆæ¯åˆ·ç›˜ç†å¿µ</a></li>
    <li><a href="#å…«æ¶ˆæ¯åˆ·ç›˜è¿‡ç¨‹">å…«ã€æ¶ˆæ¯åˆ·ç›˜è¿‡ç¨‹</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>



</html>












