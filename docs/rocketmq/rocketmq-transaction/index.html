<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="RocketMQ äº‹åŠ¡æ¶ˆæ¯"><meta property="og:title" content="RocketMQ äº‹åŠ¡æ¶ˆæ¯" />
<meta property="og:description" content="RocketMQ äº‹åŠ¡æ¶ˆæ¯  åŸºäº RocketMQ 4.8.0 ç‰ˆæœ¬è¿›è¡Œçš„æºç åˆ†æã€‚
 æºç è°ƒè¯•è¿‡ç¨‹ mkdir .rocketmq/conf cp distribution/conf/logback_namesrv.xml .rocketmq/conf cp distribution/conf/logback_broker.xml .rocketmq/conf NamesrvStartup.java åŠ ä¸Šå¦‚ä¸‹ä»£ç ï¼š
static { System.setProperty(MixAll.ROCKETMQ_HOME_PROPERTY, &#34;.rocketmq&#34;); } BrokerStartup.java åŠ ä¸Šå¦‚ä¸‹ä»£ç :
static { System.setProperty(MixAll.ROCKETMQ_HOME_PROPERTY, &#34;.rocketmq&#34;); System.setProperty(MixAll.NAMESRV_ADDR_PROPERTY, &#34;localhost:9876&#34;); } TransactionProducer.java åŠ ä¸Šå¦‚ä¸‹ä»£ç ï¼š
static { System.setProperty(MixAll.NAMESRV_ADDR_PROPERTY, &#34;localhost:9876&#34;); } è¿è¡Œé¡ºåºï¼š
 NamesrvStartup BrokerStartup TransactionProducer  å‘é€äº‹åŠ¡æ¶ˆæ¯ æˆ‘ä»¬å…ˆæ¥çœ‹å®¢æˆ·ç«¯è°ƒç”¨ Producer å‘é€äº‹åŠ¡æ¶ˆæ¯çš„è¿‡ç¨‹ï¼š
åˆå§‹åŒ–äº‹åŠ¡ç¯å¢ƒ åˆå§‹åŒ–äº‹åŠ¡ç¯å¢ƒæ˜¯ä¸ºäº†æ„å»º checkExecutor çº¿ç¨‹æ± ï¼š
public class TransactionMQProducer extends DefaultMQProducer { @Override public void start() throws MQClientException { this.defaultMQProducerImpl.initTransactionEnv(); super.start(); } } å‘é€æ¶ˆæ¯å¹¶æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ public class TransactionMQProducer extends DefaultMQProducer { @Override public TransactionSendResult sendMessageInTransaction(final Message msg, final Object arg) throws MQClientException { return this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kunzhao.org/docs/rocketmq/rocketmq-transaction/" />

<title>RocketMQ äº‹åŠ¡æ¶ˆæ¯ | èµµå¤çš„ä¸ªäººç½‘ç«™</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/book.min.c8ac34190f548946cdf00c75980f55bfec0ade2e9e49918cccdcace897f8b279.css" integrity="sha256-yKw0GQ9UiUbN8Ax1mA9Vv&#43;wK3i6eSZGMzNys6Jf4snk=">


<script defer src="/en.search.min.0142c687b67421ba13af027a7430a42df65ec4af4bf7fe55a3db417c73a59592.js" integrity="sha256-AULGh7Z0IboTrwJ6dDCkLfZexK9L9/5Vo9tBfHOllZI="></script>
<script>
var _hmt = _hmt || [];
(function() {
  if (location.hostname === "localhost" || 
    location.hostname === "127.0.0.1") {
    return;
  }

  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d04ff9e23cec6cb39ebbee1b4883e269";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script data-ad-client="ca-pub-8950855178079071" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>èµµå¤çš„ä¸ªäººç½‘ç«™</span>
  </a>
</h2>








  

  
  





 
  
    




  
  <ul>
    
      
        

  <li >
    
      

  <a href="/docs/tutorial/" >
      ğŸ’¡ æ•™ç¨‹
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/programmer-interview/" >
      ğŸ‘ ç¨‹åºå‘˜é¢è¯•é¢˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/rocketmq/" >
      RocketMQ æºç åˆ†æ
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-send-message-flow/" >
      RocketMQ æ¶ˆæ¯å‘é€æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-store-flow/" >
      RocketMQ æ¶ˆæ¯å­˜å‚¨æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-receive-flow/" >
      RocketMQ æ¶ˆæ¯æ¥å—æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-filter-flow/" >
      RocketMQ æ¶ˆæ¯è¿‡æ»¤æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-message-indexing-flow/" >
      RocketMQ æ¶ˆæ¯ç´¢å¼•æµç¨‹
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-timing-message-and-retry-message/" >
      RocketMQ å®šæ—¶æ¶ˆæ¯å’Œé‡è¯•æ¶ˆæ¯
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-master-slave-sync/" >
      RocketMQ ä¸»å¤‡åŒæ­¥
  </a>

</li>
      
    
      
        <li>

  <a href="/docs/rocketmq/rocketmq-transaction/"  class="active">
      RocketMQ äº‹åŠ¡æ¶ˆæ¯
  </a>

</li>
      
    
  </ul>
  



  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/books/" >
      ä¹¦ç±
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/javascript/" >
      JavaScript ä¸“æ 
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/it-zone/" >
      IT åœˆ
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/hire/" >
      æ‹›è˜
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/cloud-plus-bbs/" >
      äº‘&#43;ç¤¾åŒºæŠ€æœ¯æ²™é¾™
  </a>


    

    






  </li>


      
    
      
        

  <li >
    
      

  <a href="/docs/tools/" >
      å®ç”¨å·¥å…·
  </a>


    

    






  </li>


      
    
  </ul>
  



  












<ul>
  
  <li>
    <a href="/posts/" >
        åšå®¢
      </a>
  </li>
  
</ul>



</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>RocketMQ äº‹åŠ¡æ¶ˆæ¯</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#æºç è°ƒè¯•è¿‡ç¨‹">æºç è°ƒè¯•è¿‡ç¨‹</a></li>
    <li><a href="#å‘é€äº‹åŠ¡æ¶ˆæ¯">å‘é€äº‹åŠ¡æ¶ˆæ¯</a>
      <ul>
        <li><a href="#åˆå§‹åŒ–äº‹åŠ¡ç¯å¢ƒ">åˆå§‹åŒ–äº‹åŠ¡ç¯å¢ƒ</a></li>
        <li><a href="#å‘é€æ¶ˆæ¯å¹¶æ‰§è¡Œæœ¬åœ°äº‹åŠ¡">å‘é€æ¶ˆæ¯å¹¶æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</a></li>
        <li><a href="#ç»“æŸäº‹åŠ¡">ç»“æŸäº‹åŠ¡</a></li>
      </ul>
    </li>
    <li><a href="#æ¥å—äº‹åŠ¡æ¶ˆæ¯">æ¥å—äº‹åŠ¡æ¶ˆæ¯</a>
      <ul>
        <li><a href="#æ¥å—äº‹åŠ¡å‡†å¤‡æ¶ˆæ¯">æ¥å—äº‹åŠ¡å‡†å¤‡æ¶ˆæ¯</a></li>
        <li><a href="#æ¥æ”¶äº‹åŠ¡ç»“æŸçš„æ¶ˆæ¯">æ¥æ”¶äº‹åŠ¡ç»“æŸçš„æ¶ˆæ¯</a></li>
      </ul>
    </li>
    <li><a href="#æ‰«æäº‹åŠ¡çŠ¶æ€">æ‰«æäº‹åŠ¡çŠ¶æ€</a>
      <ul>
        <li><a href="#server-å®šæ—¶æ‰«æ">Server å®šæ—¶æ‰«æ</a></li>
        <li><a href="#server-æ£€æŸ¥äº‹åŠ¡çŠ¶æ€">Server æ£€æŸ¥äº‹åŠ¡çŠ¶æ€</a></li>
        <li><a href="#å®¢æˆ·ç«¯æ£€æŸ¥äº‹åŠ¡çŠ¶æ€">å®¢æˆ·ç«¯æ£€æŸ¥äº‹åŠ¡çŠ¶æ€</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
<article class="markdown"><h1 id="rocketmq-äº‹åŠ¡æ¶ˆæ¯">RocketMQ äº‹åŠ¡æ¶ˆæ¯</h1>
<blockquote>
<p>åŸºäº RocketMQ 4.8.0 ç‰ˆæœ¬è¿›è¡Œçš„æºç åˆ†æã€‚</p>
</blockquote>
<h2 id="æºç è°ƒè¯•è¿‡ç¨‹">æºç è°ƒè¯•è¿‡ç¨‹</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir .rocketmq/conf
cp distribution/conf/logback_namesrv.xml .rocketmq/conf
cp distribution/conf/logback_broker.xml .rocketmq/conf
</code></pre></div><p><code>NamesrvStartup.java</code> åŠ ä¸Šå¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span>MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">ROCKETMQ_HOME_PROPERTY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;.rocketmq&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>BrokerStartup.java</code> åŠ ä¸Šå¦‚ä¸‹ä»£ç :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span>MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">ROCKETMQ_HOME_PROPERTY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;.rocketmq&#34;</span><span style="color:#f92672">);</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span>MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">NAMESRV_ADDR_PROPERTY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;localhost:9876&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>TransactionProducer.java</code> åŠ ä¸Šå¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span>MixAll<span style="color:#f92672">.</span><span style="color:#a6e22e">NAMESRV_ADDR_PROPERTY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;localhost:9876&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>è¿è¡Œé¡ºåºï¼š</p>
<ul>
<li><code>NamesrvStartup</code></li>
<li><code>BrokerStartup</code></li>
<li><code>TransactionProducer</code></li>
</ul>
<h2 id="å‘é€äº‹åŠ¡æ¶ˆæ¯">å‘é€äº‹åŠ¡æ¶ˆæ¯</h2>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹å®¢æˆ·ç«¯è°ƒç”¨ Producer å‘é€äº‹åŠ¡æ¶ˆæ¯çš„è¿‡ç¨‹ï¼š</p>
<h3 id="åˆå§‹åŒ–äº‹åŠ¡ç¯å¢ƒ">åˆå§‹åŒ–äº‹åŠ¡ç¯å¢ƒ</h3>
<p>åˆå§‹åŒ–äº‹åŠ¡ç¯å¢ƒæ˜¯ä¸ºäº†æ„å»º checkExecutor çº¿ç¨‹æ± ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TransactionMQProducer</span> <span style="color:#66d9ef">extends</span> DefaultMQProducer <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> MQClientException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQProducerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initTransactionEnv</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><h3 id="å‘é€æ¶ˆæ¯å¹¶æ‰§è¡Œæœ¬åœ°äº‹åŠ¡">å‘é€æ¶ˆæ¯å¹¶æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TransactionMQProducer</span> <span style="color:#66d9ef">extends</span> DefaultMQProducer <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> TransactionSendResult <span style="color:#a6e22e">sendMessageInTransaction</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Message msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Object arg<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> MQClientException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQProducerImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendMessageInTransaction</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> arg<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸‹é¢æ¥çœ‹ <code>DefaultMQProducerImpl</code> ç±»çš„å‘é€äº‹åŠ¡æ¶ˆæ¯çš„å…·ä½“å®ç°ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> TransactionSendResult <span style="color:#a6e22e">sendMessageInTransaction</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Message msg<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> LocalTransactionExecuter localTransactionExecuter<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Object arg<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> MQClientException <span style="color:#f92672">{</span>

    <span style="color:#75715e">// æ ‡è¯†è¿™æ¡æ¶ˆæ¯çš„å±æ€§ï¼šTRANSACTION_PREPARED
</span><span style="color:#75715e"></span>    MessageAccessor<span style="color:#f92672">.</span><span style="color:#a6e22e">putProperty</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_TRANSACTION_PREPARED</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">);</span>

    <span style="color:#75715e">// å‘é€æ¶ˆæ¯
</span><span style="color:#75715e"></span>    sendResult <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>

    <span style="color:#75715e">// æ ¹æ®æ¶ˆæ¯çš„å‘é€çŠ¶æ€å†³å®šæ˜¯å¦æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>sendResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getSendStatus</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// å‘é€æ¶ˆæ¯æˆåŠŸ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> SEND_OK<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// è·å–äº‹åŠ¡ ID
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sendResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransactionId</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                msg<span style="color:#f92672">.</span><span style="color:#a6e22e">putUserProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;__transactionId__&#34;</span><span style="color:#f92672">,</span> sendResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransactionId</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}</span>
            String transactionId <span style="color:#f92672">=</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> transactionId <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>transactionId<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                msg<span style="color:#f92672">.</span><span style="color:#a6e22e">setTransactionId</span><span style="color:#f92672">(</span>transactionId<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            <span style="color:#75715e">// æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> localTransactionExecuter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                localTransactionState <span style="color:#f92672">=</span> localTransactionExecuter<span style="color:#f92672">.</span><span style="color:#a6e22e">executeLocalTransactionBranch</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> arg<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>transactionListener <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                log<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Used new transaction API&#34;</span><span style="color:#f92672">);</span>
                localTransactionState <span style="color:#f92672">=</span> transactionListener<span style="color:#f92672">.</span><span style="color:#a6e22e">executeLocalTransaction</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> arg<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// å‘é€æ¶ˆæ¯å¤±è´¥
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> FLUSH_DISK_TIMEOUT<span style="color:#f92672">:</span>
        <span style="color:#66d9ef">case</span> FLUSH_SLAVE_TIMEOUT<span style="color:#f92672">:</span>
        <span style="color:#66d9ef">case</span> SLAVE_NOT_AVAILABLE<span style="color:#f92672">:</span>
            localTransactionState <span style="color:#f92672">=</span> LocalTransactionState<span style="color:#f92672">.</span><span style="color:#a6e22e">ROLLBACK_MESSAGE</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// äº‹åŠ¡ç»“æŸ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endTransaction</span><span style="color:#f92672">(</span>sendResult<span style="color:#f92672">,</span> localTransactionState<span style="color:#f92672">,</span> localException<span style="color:#f92672">);</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒRocketMQ æ˜¯<strong>å…ˆå‘é€æ¶ˆæ¯</strong>ï¼Œç„¶å<strong>å†æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</strong>ã€‚</p>
<h3 id="ç»“æŸäº‹åŠ¡">ç»“æŸäº‹åŠ¡</h3>
<p>åœ¨ <code>endTransaction</code> å†…éƒ¨ï¼Œéœ€è¦æ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡Œçš„çŠ¶æ€ï¼Œæ¥å†³å®šæ˜¯ <code>COMMIT</code> è¿˜æ˜¯ <code>ROLLBACK</code> å·²ç»å‘é€åˆ°æœåŠ¡å™¨çš„æ¶ˆæ¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>localTransactionState<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">case</span> COMMIT_MESSAGE<span style="color:#f92672">:</span>
        requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">setCommitOrRollback</span><span style="color:#f92672">(</span>MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_COMMIT_TYPE</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">case</span> ROLLBACK_MESSAGE<span style="color:#f92672">:</span>
        requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">setCommitOrRollback</span><span style="color:#f92672">(</span>MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_ROLLBACK_TYPE</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">case</span> UNKNOW<span style="color:#f92672">:</span>
        requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">setCommitOrRollback</span><span style="color:#f92672">(</span>MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_NOT_TYPE</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// è°ƒç”¨ API: åªè°ƒç”¨ä¸€æ¬¡ï¼Œä¸é‡è¯•
</span><span style="color:#75715e"></span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMQClientAPIImpl</span><span style="color:#f92672">().</span><span style="color:#a6e22e">endTransactionOneway</span><span style="color:#f92672">(</span>brokerAddr<span style="color:#f92672">,</span> requestHeader<span style="color:#f92672">,</span> remark<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">defaultMQProducer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getSendMsgTimeout</span><span style="color:#f92672">());</span>
</code></pre></div><p>å…¶ä¸­ <code>endTransactionOneway()</code> å‘é€çš„æ˜¯åˆ° Server çš„ <code>END_TRANSACTION</code> å‘½ä»¤ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">RemotingCommand request <span style="color:#f92672">=</span> RemotingCommand<span style="color:#f92672">.</span><span style="color:#a6e22e">createRequestCommand</span><span style="color:#f92672">(</span>RequestCode<span style="color:#f92672">.</span><span style="color:#a6e22e">END_TRANSACTION</span><span style="color:#f92672">,</span> requestHeader<span style="color:#f92672">);</span>
</code></pre></div><h2 id="æ¥å—äº‹åŠ¡æ¶ˆæ¯">æ¥å—äº‹åŠ¡æ¶ˆæ¯</h2>
<p>ä¸Šé¢è®²çš„æ˜¯ Client ç«¯å‘é€äº‹åŠ¡æ¶ˆæ¯çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥çœ‹ Server ç«¯æ˜¯<strong>å¦‚ä½•æ¥å—äº‹åŠ¡æ¶ˆæ¯</strong>çš„ã€‚</p>
<h3 id="æ¥å—äº‹åŠ¡å‡†å¤‡æ¶ˆæ¯">æ¥å—äº‹åŠ¡å‡†å¤‡æ¶ˆæ¯</h3>
<p>Broker æ£€æŸ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯å¦æ˜¯ <code>PROPERTY_TRANSACTION_PREPARED</code> æ¶ˆæ¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// SendMessageProcessor
</span><span style="color:#75715e"></span>String transFlag <span style="color:#f92672">=</span> origProps<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_TRANSACTION_PREPARED</span><span style="color:#f92672">);</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>transFlag <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">parseBoolean</span><span style="color:#f92672">(</span>transFlag<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBrokerConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isRejectTransactionMessage</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// æ²¡æœ‰å‘é€äº‹åŠ¡çš„æƒé™
</span><span style="color:#75715e"></span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">setCode</span><span style="color:#f92672">(</span>ResponseCode<span style="color:#f92672">.</span><span style="color:#a6e22e">NO_PERMISSION</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> CompletableFuture<span style="color:#f92672">.</span><span style="color:#a6e22e">completedFuture</span><span style="color:#f92672">(</span>response<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    putMessageResult <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getTransactionalMessageService</span><span style="color:#f92672">().</span><span style="color:#a6e22e">asyncPrepareMessage</span><span style="color:#f92672">(</span>msgInner<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å¼‚æ­¥å‡†å¤‡æ¶ˆæ¯å†…éƒ¨ï¼Œå…¶å®å°±æ˜¯å­˜å‚¨ <code>half</code> æ¶ˆæ¯çš„è¿‡ç¨‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// org.apache.rocketmq.broker.transaction.queue.TransactionalMessageServiceImpl
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> CompletableFuture<span style="color:#f92672">&lt;</span>PutMessageResult<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">asyncPrepareMessage</span><span style="color:#f92672">(</span>MessageExtBrokerInner messageInner<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> transactionalMessageBridge<span style="color:#f92672">.</span><span style="color:#a6e22e">asyncPutHalfMessage</span><span style="color:#f92672">(</span>messageInner<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å°†æ¶ˆæ¯çš„è¯é¢˜æ›¿æ¢ä¸ºäº† <code>RMQ_SYS_TRANS_HALF_TOPIC</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// å¤‡ä»½åŸæ¥çœŸæ­£çš„ Topic
</span><span style="color:#75715e"></span>MessageAccessor<span style="color:#f92672">.</span><span style="color:#a6e22e">putProperty</span><span style="color:#f92672">(</span>msgInner<span style="color:#f92672">,</span> MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_REAL_TOPIC</span><span style="color:#f92672">,</span> msgInner<span style="color:#f92672">.</span><span style="color:#a6e22e">getTopic</span><span style="color:#f92672">());</span>
msgInner<span style="color:#f92672">.</span><span style="color:#a6e22e">setTopic</span><span style="color:#f92672">(</span>TransactionalMessageUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">buildHalfTopic</span><span style="color:#f92672">());</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">buildHalfTopic</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> TopicValidator<span style="color:#f92672">.</span><span style="color:#a6e22e">RMQ_SYS_TRANS_HALF_TOPIC</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸‹å›¾æ˜¯ï¼Œåˆšå‘é€å®Œ <code>PREPARED</code> æ¶ˆæ¯åï¼Œ<code>consumequeue</code> æ–‡ä»¶å¤¹ä¸­å­˜æ”¾çš„æ–‡ä»¶ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-transaction/WX20210113-210947@2x.png" alt=""></p>
<blockquote>
<p>PREPARED æ¶ˆæ¯ä¸ä¼šè¢«æ¶ˆè´¹å— ?</p>
</blockquote>
<p><code>PREPARED</code> æ¶ˆæ¯åœ¨å­˜å‚¨åˆ°ç£ç›˜ä¹‹å‰ï¼Œä¼šå°†è¯é¢˜æ”¹ä¸º <code>RMQ_SYS_TRANS_HALF_TOPIC</code>ï¼Œå› æ­¤é€šè¿‡è®¢é˜…è¯¥æ¶ˆæ¯å…³è”çš„åŸæ¥çš„è¯é¢˜ï¼Œæ˜¯æ¶ˆè´¹ä¸åˆ°è¯¥æ¶ˆæ¯çš„ã€‚</p>
<p>å¦å¤–å°±æ˜¯åœ¨ Broker åˆ†å‘æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“æ”¶åˆ°äº†ä¸€æ¡æ¶ˆæ¯ï¼Œåå°ä¼šæ ¹æ®æ¶ˆæ¯ï¼Œæ„å»º <code>consume</code> æ–‡ä»¶ (ä¸‹é¢ä»£ç ä¸­çš„ <code>putMessagePositionInfo()</code> æ–¹æ³•å°±æ˜¯ä¸ºäº†æ„å»º<strong>æ¶ˆè´¹</strong>æ–‡ä»¶)ï¼Œä»¥ä¾›æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ä½†æ˜¯åœ¨é‡åˆ° <code>PREPARED</code> æ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±ä¸å†æ„å»º <code>consome</code> æ–‡ä»¶äº†ï¼Œå³æ¶ˆè´¹è€…æ ¹æœ¬çœ‹ä¸åˆ°è¿™æ¡æ¶ˆæ¯ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// DefaultMessageStore.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommitLogDispatcherBuildConsumeQueue</span> <span style="color:#66d9ef">implements</span> CommitLogDispatcher <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatch</span><span style="color:#f92672">(</span>DispatchRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> tranType <span style="color:#f92672">=</span> MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">getTransactionValue</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getSysFlag</span><span style="color:#f92672">());</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>tranType<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">case</span> MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_NOT_TYPE</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">case</span> MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_COMMIT_TYPE</span><span style="color:#f92672">:</span>
                DefaultMessageStore<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">putMessagePositionInfo</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">case</span> MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_PREPARED_TYPE</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">case</span> MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_ROLLBACK_TYPE</span><span style="color:#f92672">:</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="æ¥æ”¶äº‹åŠ¡ç»“æŸçš„æ¶ˆæ¯">æ¥æ”¶äº‹åŠ¡ç»“æŸçš„æ¶ˆæ¯</h3>
<p>å¯¹äº <code>END_TRANSACTION</code> çš„è¯·æ±‚ï¼Œ<code>BrokerController</code> æ³¨å†Œäº†å•ç‹¬çš„å¤„ç†å™¨æ¥å¤„ç†äº‹åŠ¡ç»“æŸçš„å‘½ä»¤ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// BrokerController
</span><span style="color:#75715e"></span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">remotingServer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerProcessor</span><span style="color:#f92672">(</span>RequestCode<span style="color:#f92672">.</span><span style="color:#a6e22e">END_TRANSACTION</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> EndTransactionProcessor<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">endTransactionExecutor</span><span style="color:#f92672">);</span>
</code></pre></div><p><code>EndTransactionProcessor</code> å†…éƒ¨ï¼Œå¤„ç†å‘½ä»¤çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// SLAVE ä¸æ”¯æŒæ¥å— END_TRANSACTION å‘½ä»¤
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>BrokerRole<span style="color:#f92672">.</span><span style="color:#a6e22e">SLAVE</span> <span style="color:#f92672">==</span> brokerController<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessageStoreConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getBrokerRole</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    response<span style="color:#f92672">.</span><span style="color:#a6e22e">setCode</span><span style="color:#f92672">(</span>ResponseCode<span style="color:#f92672">.</span><span style="color:#a6e22e">SLAVE_NOT_AVAILABLE</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> response<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_COMMIT_TYPE</span> <span style="color:#f92672">==</span> requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">getCommitOrRollback</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// COMMIT æ¶ˆæ¯
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_ROLLBACK_TYPE</span> <span style="color:#f92672">==</span> requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">getCommitOrRollback</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ROLLBACK æ¶ˆæ¯
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>(1) <strong>COMMIT æäº¤æ¶ˆæ¯</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">result <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getTransactionalMessageService</span><span style="color:#f92672">().</span><span style="color:#a6e22e">commitMessage</span><span style="color:#f92672">(</span>requestHeader<span style="color:#f92672">);</span>

MessageExtBrokerInner msgInner <span style="color:#f92672">=</span> endMessageTransaction<span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getPrepareMessage</span><span style="color:#f92672">());</span>
msgInner<span style="color:#f92672">.</span><span style="color:#a6e22e">setSysFlag</span><span style="color:#f92672">(</span>MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">resetTransactionValue</span><span style="color:#f92672">(</span>msgInner<span style="color:#f92672">.</span><span style="color:#a6e22e">getSysFlag</span><span style="color:#f92672">(),</span> requestHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">getCommitOrRollback</span><span style="color:#f92672">()));</span>
MessageAccessor<span style="color:#f92672">.</span><span style="color:#a6e22e">clearProperty</span><span style="color:#f92672">(</span>msgInner<span style="color:#f92672">,</span> MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_TRANSACTION_PREPARED</span><span style="color:#f92672">);</span>

RemotingCommand sendResult <span style="color:#f92672">=</span> sendFinalMessage<span style="color:#f92672">(</span>msgInner<span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sendResult<span style="color:#f92672">.</span><span style="color:#a6e22e">getCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> ResponseCode<span style="color:#f92672">.</span><span style="color:#a6e22e">SUCCESS</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getTransactionalMessageService</span><span style="color:#f92672">().</span><span style="color:#a6e22e">deletePrepareMessage</span><span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getPrepareMessage</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸Šè¿°ä»£ç ç¬¬ä¸€è¡Œ <code>commitMessage</code> å†…éƒ¨æ˜¯æ ¹æ® <code>commitLogOffset</code> è¿™ä¸ªåç§»é‡ï¼Œä» <code>commitLog</code> çš„ <code>MappedFile</code> æ–‡ä»¶ä¸­æŸ¥æ‰¾<strong>æ¶ˆæ¯</strong>çš„è¿‡ç¨‹ã€‚</p>
<p>ç¬¬äºŒè¡Œçš„ <code>endMessageTransaction</code> å†…éƒ¨æ ¹æ® <code>preparedMessage</code> æ„å»ºäº†æ–°çš„ Messageï¼Œæ¢å¤äº†è¯é¢˜ã€æ‹·è´äº†è¿™ä¸ªæ¶ˆæ¯ä¸Šå…¶å®ƒçš„å±æ€§ç­‰ä¿¡æ¯ï¼Œæœ€é‡è¦çš„æ˜¯æ¸…é™¤äº† <code>MessageConst.PROPERTY_TRANSACTION_PREPARED</code> å±æ€§ï¼Œä»¥ä¾¿è¿™ä¸ªæ¶ˆæ¯å¯ä»¥<strong>æ„å»ºæ¶ˆè´¹é˜Ÿåˆ—æ–‡ä»¶</strong>ï¼Œä»è€Œè®©æ¶ˆè´¹è€…èƒ½å¤Ÿæ¶ˆè´¹ã€‚</p>
<p>æœ€å <code>sendMessage</code> å†…éƒ¨å°±æ˜¯å°†æ„å»ºå¥½çš„æ–°çš„æ¶ˆæ¯ä½“ï¼Œé‡æ–°è°ƒç”¨ <code>Broker</code> ç«¯çš„å‘é€æ¶ˆæ¯çš„æµç¨‹ï¼Œæ¥å‘é€æ¶ˆæ¯ã€‚æ‰€ä»¥æ¶ˆè´¹ç«¯æ¶ˆè´¹çš„å·²ç»ä¸æ˜¯ä¹‹å‰å‘é€çš„ PREPARED æ¶ˆæ¯ï¼Œè€Œæ˜¯æ ¹æ® PREPARED æ¶ˆæ¯é‡æ–°å…‹éš†å‡ºæ¥çš„æ–°çš„æ¶ˆæ¯ä½“ï¼Œå½“ç„¶å†…å®¹ã€å±æ€§ç­‰è‚¯å®šç»™éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>æœ€å <code>deletePrepareMessage</code> çš„è¿‡ç¨‹ï¼Œå†…éƒ¨å…¶å®åªæ˜¯ç»™è¿™æ¡æ¶ˆæ¯æ‰“ä¸Šäº†ä¸€ä¸ª <code>TransactionalMessageUtil.REMOVETAG</code> æ ‡ç­¾ï¼Œç„¶åé‡æ–° <code>putMessage()</code>ã€‚</p>
<p>ä¸‹å›¾å±•ç¤ºçš„æ˜¯ï¼Œæ‰§è¡Œ <code>COMMIT</code> ä¹‹åçš„ï¼Œ<code>consumequeue</code> å­˜æ”¾æ–‡ä»¶çš„æƒ…å†µï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-transaction/WX20210113-212028@2x.png" alt=""></p>
<p>(2) <strong>ROLLBACK å›æ»šæ¶ˆæ¯</strong></p>
<p>å›æ»šæ¶ˆæ¯ç¬¬ä¸€æ­¥ä¹Ÿæ˜¯æ ¹æ® <code>commitOffset</code> æŸ¥æ‰¾æ¶ˆæ¯ï¼Œç„¶åå†ç»™è¿™æ¡æ¶ˆæ¯æ‰“ä¸Š <code>TransactionalMessageUtil.REMOVETAG</code> çš„è¿‡ç¨‹ã€‚</p>
<p>ä¸‹å›¾æ˜¯æ¶ˆæ¯æ‰§è¡Œ <code>ROLLBACK</code> ä¹‹åçš„ <code>consumequeue</code> æ‰€å­˜å‚¨çš„æ–‡ä»¶çš„çŠ¶æ€ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-transaction/WX20210113-212624@2x.png" alt=""></p>
<h2 id="æ‰«æäº‹åŠ¡çŠ¶æ€">æ‰«æäº‹åŠ¡çŠ¶æ€</h2>
<p>å‡å¦‚ Client æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œè¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œæˆ–è€…å‘é€äº† <code>COMMIT</code> æ¶ˆæ¯æˆ–è€… <code>ROLLBACK</code> æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™æ¡æ¶ˆæ¯ç”±äºç½‘ç»œåŸå› ç­‰æ²¡æœ‰åˆ°è¾¾ Server ç«¯ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´å‡ºäº <code>PREPARED</code> çš„æ¶ˆæ¯è¶Šæ¥è¶Šå¤šã€‚å› æ­¤ Broker ä¼šåœ¨åå°å®šæœŸç»™ Client å‘é€<strong>æ£€æŸ¥äº‹åŠ¡çŠ¶æ€</strong>çš„æ¶ˆæ¯ã€‚</p>
<h3 id="server-å®šæ—¶æ‰«æ">Server å®šæ—¶æ‰«æ</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TransactionalMessageCheckService</span> <span style="color:#66d9ef">extends</span> ServiceThread <span style="color:#f92672">{</span>
    
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> checkInterval <span style="color:#f92672">=</span> brokerController<span style="color:#f92672">.</span><span style="color:#a6e22e">getBrokerConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTransactionCheckInterval</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isStopped</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">waitForRunning</span><span style="color:#f92672">(</span>checkInterval<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onWaitEnd</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> timeout <span style="color:#f92672">=</span> brokerController<span style="color:#f92672">.</span><span style="color:#a6e22e">getBrokerConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTransactionTimeOut</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">int</span> checkMax <span style="color:#f92672">=</span> brokerController<span style="color:#f92672">.</span><span style="color:#a6e22e">getBrokerConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getTransactionCheckMax</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">// æ£€æŸ¥äº‹åŠ¡çŠ¶æ€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getTransactionalMessageService</span><span style="color:#f92672">().</span><span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>timeout<span style="color:#f92672">,</span> checkMax<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getTransactionalMessageCheckListener</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li><code>transactionCheckInterval = 60 * 1000</code>ï¼šæ¯éš” 60s æ‰§è¡Œä¸€æ¬¡ <code>check</code> æ–¹æ³•ã€‚</li>
<li><code>transactionTimeOut = 6 * 1000</code>ï¼šç¬¬ä¸€æ¬¡æ£€æŸ¥äº‹åŠ¡æ¶ˆæ¯çš„æ—¶é—´ï¼Œä¸€æ¡æ¶ˆæ¯åªæœ‰å¤§äºè¿™ä¸ªæ—¶é—´è¿˜æ²¡æœ‰æ”¶åˆ° <code>COMMIT</code> æˆ–è€… <code>ROLLBACK</code>ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œæ£€æŸ¥ã€‚</li>
<li><code>transactionCheckMax = 15</code>ï¼šæœ€å¤šæ‰§è¡Œå¤šå°‘æ¬¡æ£€æŸ¥åï¼Œå¦‚æœä¾ç„¶è¿˜æ²¡æœ‰æ”¶åˆ°è¿™æ¡æ¶ˆæ¯æ˜¯æäº¤è¿˜æ˜¯å›æ»šï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯å°†è¢«ä¸¢å¼ƒã€‚</li>
</ul>
<h3 id="server-æ£€æŸ¥äº‹åŠ¡çŠ¶æ€">Server æ£€æŸ¥äº‹åŠ¡çŠ¶æ€</h3>
<p>åœ¨ <code>check</code> æ–¹æ³•å†…éƒ¨ï¼ŒServer ç«¯éœ€è¦æ‰«ææ˜¯å¦æœ‰æ¶ˆæ¯éœ€è¦å»æ£€æŸ¥äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™ä¼šç»™ Client å‘é€ <code>CHECK_TRANSACTION_STATE</code> å‘½ä»¤ã€‚</p>
<p>é¦–å…ˆï¼ŒBroker å°†è‡ªå·±ä½œä¸ºä¸€ä¸ªå®¢æˆ·ç«¯æ¥å»<strong>è®¢é˜…</strong>æ¶ˆè´¹ <code>RMQ_SYS_TRANS_OP_HALF_TOPIC</code> è¯é¢˜ä¸­çš„æ¶ˆæ¯ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// TransactionalMessageBridge.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> PullResult <span style="color:#a6e22e">getOpMessage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> queueId<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> nums<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String group <span style="color:#f92672">=</span> TransactionalMessageUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">buildConsumerGroup</span><span style="color:#f92672">();</span>
    String topic <span style="color:#f92672">=</span> TransactionalMessageUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">buildOpTopic</span><span style="color:#f92672">();</span>
    SubscriptionData sub <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SubscriptionData<span style="color:#f92672">(</span>topic<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> getMessage<span style="color:#f92672">(</span>group<span style="color:#f92672">,</span> topic<span style="color:#f92672">,</span> queueId<span style="color:#f92672">,</span> offset<span style="color:#f92672">,</span> nums<span style="color:#f92672">,</span> sub<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>é‚£ä¹ˆæ¯ä¸€æ¬¡æ¶ˆè´¹ï¼Œæˆ‘æ€ä¹ˆçŸ¥é“ä¸Šä¸€æ¬¡æ¶ˆè´¹åˆ°å“ªé‡Œäº†å‘¢ï¼Ÿå®é™…ä¸Šï¼Œæœ€æ–°çš„æ¶ˆæ¯åç§»é‡å­˜å‚¨åœ¨äº† <code>offsetTable</code> ä¸­ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// ConsumerOffsetManager.java
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">queryOffset</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String group<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String topic<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> queueId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// topic@group
</span><span style="color:#75715e"></span>    String key <span style="color:#f92672">=</span> topic <span style="color:#f92672">+</span> TOPIC_GROUP_SEPARATOR <span style="color:#f92672">+</span> group<span style="color:#f92672">;</span>
    ConcurrentMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> Long<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">offsetTable</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> map<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Long offset <span style="color:#f92672">=</span> map<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>queueId<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>offset <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span> offset<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>offsetTable</code> åœ¨åå°ä¹Ÿä¼šå®šæ—¶åœ°å°†é‡Œé¢çš„ä¿¡æ¯ä¿å­˜åˆ°ç£ç›˜ä¸Šçš„ <code>config/consumerOffset.json</code> æ–‡ä»¶ä¸­ (å¦‚ä¸‹å›¾æ‰€ç¤º)ã€‚<code>0:9</code> çš„ <code>0</code> ä»£è¡¨ <code>queueId</code>ï¼Œ<code>9</code> ä»£è¡¨æœ€æ–°çš„ <code>offset</code>ã€‚</p>
<p><img src="/images/docs/rocketmq/rocketmq-transaction/WX20210114-212255@2x.png" alt=""></p>
<p>åœ¨è·å–åˆ°ä¸Šä¸€è½® <code>offset</code> åˆ°æœ€æ–°çš„ <code>offset</code> ä¹‹é—´çš„<strong>æ¶ˆæ¯åˆ—è¡¨</strong>åï¼Œé‚£ä¹ˆå°±éœ€è¦<strong>é€ä¸€æ£€æŸ¥</strong>è¿™äº›æ¶ˆæ¯çš„äº‹åŠ¡çŠ¶æ€äº†ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">PullResult pullResult <span style="color:#f92672">=</span> fillOpRemoveMap<span style="color:#f92672">(</span>removeMap<span style="color:#f92672">,</span> opQueue<span style="color:#f92672">,</span> opOffset<span style="color:#f92672">,</span> halfOffset<span style="color:#f92672">,</span> doneOpOffset<span style="color:#f92672">);</span>
<span style="color:#66d9ef">long</span> i <span style="color:#f92672">=</span> halfOffset<span style="color:#f92672">;</span>

<span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    GetResult getResult <span style="color:#f92672">=</span> getHalfMsg<span style="color:#f92672">(</span>messageQueue<span style="color:#f92672">,</span> i<span style="color:#f92672">);</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isNeedCheck<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        listener<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveHalfMsg</span><span style="color:#f92672">(</span>msgExt<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> 
<span style="color:#f92672">}</span>
</code></pre></div><p><code>msgExt</code> çš„å†…éƒ¨çŠ¶æ€ï¼š</p>
<p><img src="/images/docs/rocketmq/rocketmq-transaction/WX20210114-195805@2x.png" alt=""></p>
<p>é‚£ä¹ˆåœ¨æ¯ä¸€è½®å¾ªç¯ä¸­ï¼Œå³æ¯ä¸€æ¡æ¶ˆæ¯å†…éƒ¨ï¼Œé€»è¾‘åˆæ˜¯æ€æ ·æ‰§è¡Œçš„å‘¢ï¼Ÿ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// TransactionalMessageServiceImpl
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> startTime <span style="color:#f92672">&gt;</span> MAX_PROCESS_TIME_LIMIT<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>needDiscard<span style="color:#f92672">(</span>msgExt<span style="color:#f92672">,</span> transactionCheckMax<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> needSkip<span style="color:#f92672">(</span>msgExt<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">long</span> valueOfCurrentMinusBorn <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> msgExt<span style="color:#f92672">.</span><span style="color:#a6e22e">getBornTimestamp</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">long</span> checkImmunityTime <span style="color:#f92672">=</span> transactionTimeout<span style="color:#f92672">;</span>

<span style="color:#66d9ef">boolean</span> isNeedCheck <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>opMsg <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> valueOfCurrentMinusBorn <span style="color:#f92672">&gt;</span> checkImmunityTime<span style="color:#f92672">);</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isNeedCheck<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>putBackHalfMsgQueue<span style="color:#f92672">(</span>msgExt<span style="color:#f92672">,</span> i<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    listener<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveHalfMsg</span><span style="color:#f92672">(</span>msgExt<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span> 
</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°ï¼š</p>
<ul>
<li>é¦–å…ˆå¯¹äº <code>while (true)</code> çš„æ—¶é—´è®¾å®šäº†é™åˆ¶ï¼Œä¸èƒ½è¶…è¿‡ <code>MAX_PROCESS_TIME_LIMIT</code> è¿™ä¸ªå€¼ã€‚</li>
<li>å…¶æ¬¡ï¼Œ<code>needDiscard()</code> è¿™ä¸ªæ–¹æ³•æ£€æŸ¥çš„å°±æ˜¯ä»æ¶ˆæ¯çš„ <code>MessageConst.PROPERTY_TRANSACTION_CHECK_TIMES</code> å±æ€§ä¸­ï¼Œè·å–åˆ°è¿™ä¸ªæ¶ˆæ¯å·²ç»æ£€æŸ¥äº†å¤šå°‘æ¬¡ï¼Œå¦‚æœè¶…è¿‡ <code>transactionCheckMax</code>ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸¢å¼ƒã€‚</li>
<li><code>needSkip()</code> å‡½æ•°åˆ¤æ–­çš„æ˜¯è¿™æ¡æ¶ˆæ¯è‡ªè¯ç”Ÿä»¥æ¥ï¼Œåœ¨ Broker ç«¯æ”¾ç½®çš„æ—¶é—´æ˜¯å¦è¶…è¿‡äº† 3 å¤©ï¼Œå¦‚æœè¶…è¿‡ 3 å¤©ï¼Œè¿™æ¡æ¶ˆæ¯ä¹Ÿæ²¡æœ‰å¿…è¦æ£€æŸ¥äº†ï¼Œå› ä¸º RocketMQ é»˜è®¤å­˜å‚¨æ¶ˆæ¯çš„æœ€é•¿æ—¶é—´å°±æ˜¯ 3 å¤©ã€‚</li>
<li><code>isNeedCheck</code> çœ‹çš„ä¸»è¦å°±æ˜¯æ¶ˆæ¯è¯ç”Ÿçš„æ—¶é—´æ˜¯å¦è¶…è¿‡äº† <code>transactionTimeout</code>ã€‚</li>
<li><code>putBackHalfMsgQueue</code> ä¸»è¦å°±æ˜¯å°†å½“å‰çš„æ¶ˆæ¯ï¼Œæœ€æ–°ä¿®æ”¹çš„å±æ€§ç­‰ï¼Œé‡æ–°æ‹·è´ä¸€ä»½ï¼Œç„¶åå°†<strong>æ–°çš„æ¶ˆæ¯</strong>è¿½åŠ åˆ° <code>MappedFile</code> çš„æœ«å°¾ã€‚</li>
<li><code>resolveHalfMsg</code> å°±æ˜¯åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œå‘é€æ£€æŸ¥äº‹åŠ¡çŠ¶æ€çš„ä»»åŠ¡ï¼š</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">resolveHalfMsg</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> MessageExt msgExt<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    executorService<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                sendCheckMessage<span style="color:#f92672">(</span>msgExt<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Send check message error!&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>sendCheckMessage</code> çš„å†…éƒ¨å®ç°ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// AbstractTransactionalMessageCheckListener.java
</span><span style="color:#75715e"></span>String groupId <span style="color:#f92672">=</span> msgExt<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_PRODUCER_GROUP</span><span style="color:#f92672">);</span>
Channel channel <span style="color:#f92672">=</span> brokerController<span style="color:#f92672">.</span><span style="color:#a6e22e">getProducerManager</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAvaliableChannel</span><span style="color:#f92672">(</span>groupId<span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>channel <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    brokerController<span style="color:#f92672">.</span><span style="color:#a6e22e">getBroker2Client</span><span style="color:#f92672">().</span><span style="color:#a6e22e">checkProducerTransactionState</span><span style="color:#f92672">(</span>groupId<span style="color:#f92672">,</span> channel<span style="color:#f92672">,</span> checkTransactionStateRequestHeader<span style="color:#f92672">,</span> msgExt<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/images/docs/rocketmq/rocketmq-transaction/WX20210114-202318@2x.png" alt=""></p>
<p><code>checkProducerTransactionState</code> çš„å†…éƒ¨å®ç°ï¼Œå°±æ˜¯å‘é€äº† <code>CHECK_TRANSACTION_STATE</code> æŠ¥æ–‡ç»™ Client:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#75715e">// Broker2Client.java
</span><span style="color:#75715e"></span>RemotingCommand request <span style="color:#f92672">=</span>
    RemotingCommand<span style="color:#f92672">.</span><span style="color:#a6e22e">createRequestCommand</span><span style="color:#f92672">(</span>RequestCode<span style="color:#f92672">.</span><span style="color:#a6e22e">CHECK_TRANSACTION_STATE</span><span style="color:#f92672">,</span> requestHeader<span style="color:#f92672">);</span>
request<span style="color:#f92672">.</span><span style="color:#a6e22e">setBody</span><span style="color:#f92672">(</span>MessageDecoder<span style="color:#f92672">.</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span>messageExt<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">));</span>
<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brokerController</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getRemotingServer</span><span style="color:#f92672">().</span><span style="color:#a6e22e">invokeOneway</span><span style="color:#f92672">(</span>channel<span style="color:#f92672">,</span> request<span style="color:#f92672">,</span> 10<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    log<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Check transaction failed because invoke producer exception. group={}, msgId={}, error={}&#34;</span><span style="color:#f92672">,</span>
            group<span style="color:#f92672">,</span> messageExt<span style="color:#f92672">.</span><span style="color:#a6e22e">getMsgId</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="å®¢æˆ·ç«¯æ£€æŸ¥äº‹åŠ¡çŠ¶æ€">å®¢æˆ·ç«¯æ£€æŸ¥äº‹åŠ¡çŠ¶æ€</h3>
<p><code>Producer</code> ä¹Ÿé€šè¿‡ <code>Netty</code> ç›‘å¬åœ¨äº†ä¸€ä¸ªç«¯å£ä¸Šï¼Œè¿™æ ·ä¹Ÿèƒ½æ¥å—æ¥è‡ªå¤–æ¥çš„å‘½ä»¤äº†ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClientRemotingProcessor</span> <span style="color:#66d9ef">extends</span> AsyncNettyRequestProcessor <span style="color:#66d9ef">implements</span> NettyRequestProcessor <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> RemotingCommand <span style="color:#a6e22e">processRequest</span><span style="color:#f92672">(</span>ChannelHandlerContext ctx<span style="color:#f92672">,</span>
        RemotingCommand request<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RemotingCommandException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getCode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">case</span> RequestCode<span style="color:#f92672">.</span><span style="color:#a6e22e">CHECK_TRANSACTION_STATE</span><span style="color:#f92672">:</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">checkTransactionState</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">,</span> request<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å½“æ”¶åˆ° <code>CHECK_TRANSACTION_STATE</code> å‘½ä»¤åï¼ŒClient ä¼šè§£æå‡ºæ¶ˆæ¯çš„äº‹åŠ¡ IDã€å­˜æ”¾æ¶ˆæ¯çš„ Broker åœ°å€ç­‰ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">String transactionId <span style="color:#f92672">=</span> messageExt<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">final</span> String group <span style="color:#f92672">=</span> messageExt<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span>MessageConst<span style="color:#f92672">.</span><span style="color:#a6e22e">PROPERTY_PRODUCER_GROUP</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>group <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    MQProducerInner producer <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mqClientFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">selectProducer</span><span style="color:#f92672">(</span>group<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>producer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// Broker åœ°å€
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">final</span> String addr <span style="color:#f92672">=</span> RemotingHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">parseChannelRemoteAddr</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">());</span>
        producer<span style="color:#f92672">.</span><span style="color:#a6e22e">checkTransactionState</span><span style="color:#f92672">(</span>addr<span style="color:#f92672">,</span> messageExt<span style="color:#f92672">,</span> requestHeader<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ç„¶å <code>checkTransactionState</code> å†…éƒ¨åˆ™é€šè¿‡çº¿ç¨‹æ± æäº¤äº†ä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼Œæ£€æŸ¥äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶åé¦ˆç»™ Brokerã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">localTransactionState <span style="color:#f92672">=</span> transactionListener<span style="color:#f92672">.</span><span style="color:#a6e22e">checkLocalTransaction</span><span style="color:#f92672">(</span>message<span style="color:#f92672">);</span>
<span style="color:#75715e">// COMMIT_TYPE æˆ–è€… ROLLBACK_TYPE ç­‰
</span><span style="color:#75715e"></span>thisHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">setCommitOrRollback</span><span style="color:#f92672">(</span>MessageSysFlag<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_COMMIT_TYPE</span><span style="color:#f92672">);</span>
DefaultMQProducerImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mQClientFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMQClientAPIImpl</span><span style="color:#f92672">().</span><span style="color:#a6e22e">endTransactionOneway</span><span style="color:#f92672">(</span>brokerAddr<span style="color:#f92672">,</span> thisHeader<span style="color:#f92672">,</span> remark<span style="color:#f92672">,</span> 3000<span style="color:#f92672">);</span>
</code></pre></div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="http://rocketmq.apache.org/docs/transaction-example/">Transaction example</a></li>
</ul>
</article>
 

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
  
  <div class="book-comments">  </div>
  
 
      </footer>
      
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#æºç è°ƒè¯•è¿‡ç¨‹">æºç è°ƒè¯•è¿‡ç¨‹</a></li>
    <li><a href="#å‘é€äº‹åŠ¡æ¶ˆæ¯">å‘é€äº‹åŠ¡æ¶ˆæ¯</a>
      <ul>
        <li><a href="#åˆå§‹åŒ–äº‹åŠ¡ç¯å¢ƒ">åˆå§‹åŒ–äº‹åŠ¡ç¯å¢ƒ</a></li>
        <li><a href="#å‘é€æ¶ˆæ¯å¹¶æ‰§è¡Œæœ¬åœ°äº‹åŠ¡">å‘é€æ¶ˆæ¯å¹¶æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</a></li>
        <li><a href="#ç»“æŸäº‹åŠ¡">ç»“æŸäº‹åŠ¡</a></li>
      </ul>
    </li>
    <li><a href="#æ¥å—äº‹åŠ¡æ¶ˆæ¯">æ¥å—äº‹åŠ¡æ¶ˆæ¯</a>
      <ul>
        <li><a href="#æ¥å—äº‹åŠ¡å‡†å¤‡æ¶ˆæ¯">æ¥å—äº‹åŠ¡å‡†å¤‡æ¶ˆæ¯</a></li>
        <li><a href="#æ¥æ”¶äº‹åŠ¡ç»“æŸçš„æ¶ˆæ¯">æ¥æ”¶äº‹åŠ¡ç»“æŸçš„æ¶ˆæ¯</a></li>
      </ul>
    </li>
    <li><a href="#æ‰«æäº‹åŠ¡çŠ¶æ€">æ‰«æäº‹åŠ¡çŠ¶æ€</a>
      <ul>
        <li><a href="#server-å®šæ—¶æ‰«æ">Server å®šæ—¶æ‰«æ</a></li>
        <li><a href="#server-æ£€æŸ¥äº‹åŠ¡çŠ¶æ€">Server æ£€æŸ¥äº‹åŠ¡çŠ¶æ€</a></li>
        <li><a href="#å®¢æˆ·ç«¯æ£€æŸ¥äº‹åŠ¡çŠ¶æ€">å®¢æˆ·ç«¯æ£€æŸ¥äº‹åŠ¡çŠ¶æ€</a></li>
      </ul>
    </li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-8950855178079071"
     data-ad-slot="6142361626"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

  <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1279346965'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279346965%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</body>



</html>












