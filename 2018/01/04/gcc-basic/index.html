<html>
<head>
	
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><title>gcc-basic</title>
	<meta name="keywords" content="代码人生,程序员,赵坤" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>

<body>

<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 id="GCC-Basic"><a href="#GCC-Basic" class="headerlink" title="GCC Basic"></a>GCC Basic</h2><h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1 简介"></a>1 简介</h2><ul>
<li><strong>GCC</strong>: GNU C Compiler =&gt; GNU Compiler Collection</li>
</ul>
<h2 id="2-编译"><a href="#2-编译" class="headerlink" title="2 编译"></a>2 编译</h2><h3 id="编译单个文件"><a href="#编译单个文件" class="headerlink" title="编译单个文件:"></a>编译单个文件:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall hello.c -o hello</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><strong>-o</strong>: 指明输出文件</li>
<li><strong>-Wall</strong>: 开启所有编译警告信息</li>
</ul>
<h3 id="编译多个文件"><a href="#编译多个文件" class="headerlink" title="编译多个文件:"></a>编译多个文件:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall main.c hello_fn.c -o newhello</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="只编译修改的文件"><a href="#只编译修改的文件" class="headerlink" title="只编译修改的文件:"></a>只编译修改的文件:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -c main.c</span><br><span class="line">gcc -Wall -c hello_fn.c</span><br><span class="line">gcc main.o hello_fn.o -o hello</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>-c</strong>: 编译为 object 文件, 生成 main.o</li>
</ul>
<p>注意 object 文件链接的顺序 ( <code>main.o</code> 调用 <code>hello_fn.o</code> ):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.o hello_fn.o -o hello</span><br></pre></td></tr></table></figure>
<p>而不是 (错误):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hello_fn.o main.o -o hello</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="链接外部库"><a href="#链接外部库" class="headerlink" title="链接外部库:"></a>链接外部库:</h3><p>系统库一般存放在:</p>
<ul>
<li><code>/usr/lib</code> or <code>/usr/lib64</code></li>
<li><code>/lib</code> or <code>/lib64</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall calc.c /usr/lib/libm.a -o calc</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall calc.c -lm -o calc</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>-l</strong>: 链接库</li>
<li><strong>-lNAME</strong>: 在标准路径下寻找 <strong>libNAME.a</strong> 库</li>
</ul>
<p>这样的链接顺序是不行的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -lm calc.c -o calc</span><br></pre></td></tr></table></figure>
<h2 id="3-常用编译参数"><a href="#3-常用编译参数" class="headerlink" title="3 常用编译参数"></a>3 常用编译参数</h2><p>GCC 默认搜索头文件路径:</p>
<ul>
<li><code>/usr/local/include/</code></li>
<li><code>/usr/include/</code></li>
</ul>
<p>默认搜索库文件:</p>
<ul>
<li><code>/usr/local/lib/</code></li>
<li><code>/usr/lib/</code></li>
</ul>
<p>参数:</p>
<ul>
<li><strong>-I</strong>: 从头部增加头文件搜索路径</li>
<li><strong>-L</strong>: 从头部增加库搜索路径</li>
</ul>
<p>举例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -I/opt/gdbm-1.8.3/include -L/opt/gdbm-1.8.3/lib dbmain.c -lgdbm</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><strong>C_INCLUDE_PATH</strong>: C 头文件</li>
<li><strong>CPLUS_INCLUDE_PATH</strong>: C++ 头文件</li>
<li><strong>LIBRARY_PATH</strong>: 库文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C_INCLUDE_PATH=.:/opt/gdbm-1.8.3/include:/net/include</span><br><span class="line">LIBRARY_PATH=.:/opt/gdbm-1.8.3/lib:/net/lib</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>.</strong>: 当前路径</li>
<li><strong>-I</strong> 和 <strong>-L</strong>: 都可以重复</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -I. -I/opt/gdbm-1.8.3/include -I/net/include</span><br><span class="line">    -L. -L/opt/gdbm-1.8.3/lib -L/net/lib .....</span><br></pre></td></tr></table></figure>
<hr>
<p>动态库默认搜索路径:</p>
<ul>
<li><code>/usr/local/lib</code></li>
<li><code>/usr/lib</code></li>
</ul>
<p>或者添加环境变量:</p>
<ul>
<li><strong>LD_LIBRARY_PATH</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -static -I/opt/gdbm-1.8.3/include/</span><br><span class="line">    -L/opt/gdbm-1.8.3/lib/ dbmain.c -lgdbm</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>-static</strong>: 强制静态链接, 避免使用动态库:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -static -I/opt/gdbm-1.8.3/include/</span><br><span class="line">    -L/opt/gdbm-1.8.3/lib/ dbmain.c -lgdbm</span><br></pre></td></tr></table></figure>
<p>使用静态链接库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -static -I/opt/gdbm-1.8.3/include/</span><br><span class="line">    -L/opt/gdbm-1.8.3/lib/ dbmain.c -lgdbm</span><br></pre></td></tr></table></figure>
<p>使用动态链接库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -I/opt/gdbm-1.8.3/include</span><br><span class="line">    dbmain.c /opt/gdbm-1.8.3/lib/libgdbm.so</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><strong>-ansi</strong>: 禁止 GNU 对于 C语言 标准扩展</li>
<li><strong>-pedantic</strong>: 禁止所有 GNU C 扩展</li>
<li><strong>-std=c89</strong></li>
<li><strong>-std=c99</strong></li>
</ul>
<h2 id="4-使用预处理器"><a href="#4-使用预处理器" class="headerlink" title="4 使用预处理器"></a>4 使用预处理器</h2><ul>
<li><strong>cpp</strong>: GNU C preprocessor</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">main (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> TEST</span></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">"Test mode\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">"Running...\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -DTEST dtest.c</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>-DNAME</strong>: 定义一个预处理宏 <strong>NAME</strong></li>
</ul>
<p>列举 GNU 默认定义的宏:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpp -dM /dev/null</span><br></pre></td></tr></table></figure>
<hr>
<p>带有值的宏:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -DNUM=100 dtestval.c</span><br><span class="line">gcc -Wall -DNUM=<span class="string">"2+2"</span> dtestval.c</span><br></pre></td></tr></table></figure>
<hr>
<p>观察源代码被预处理器处理后的文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -E test.c</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>-E</strong>: 运行预处理器</li>
</ul>
<h2 id="5-调试"><a href="#5-调试" class="headerlink" title="5 调试"></a>5 调试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -g null.c</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>-g</strong>: 用来记录程序 crash 的时候当时的环境情况</li>
</ul>
<p>出现如下错误的时候，会生成一个 core 文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>
<p><code>ulimit -c</code> 控制 core 文件的最大数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br></pre></td></tr></table></figure>
<p>注意，同一个 <code>terminal</code> 只能被设置一次，否则就会弹出错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash: ulimit: core file size: cannot modify limit: Operation not permitted</span><br></pre></td></tr></table></figure>
<p>可以重新打开一个新的 <code>terminal</code> 来设置:</p>
<p>core 文件可以被 <strong>GNU Debugger <code>gdb</code></strong> 加载:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb a.out core</span><br></pre></td></tr></table></figure>
<p>然后可以接着在 <code>gdb</code> 这个交互式命令中输入:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">print</span> p</span><br><span class="line">(gdb) backtrace</span><br><span class="line">(gdb) ...</span><br></pre></td></tr></table></figure>
<h2 id="6-优化"><a href="#6-优化" class="headerlink" title="6 优化"></a>6 优化</h2><h2 id="7-编译-C-程序"><a href="#7-编译-C-程序" class="headerlink" title="7 编译 C++ 程序"></a>7 编译 C++ 程序</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -Wall hello.cc -o hello</span><br></pre></td></tr></table></figure>
<h2 id="8-平台相关选项"><a href="#8-平台相关选项" class="headerlink" title="8 平台相关选项"></a>8 平台相关选项</h2><ul>
<li><strong>-march=CPU</strong>: 指定 CPU</li>
</ul>
<h2 id="9-Troubleshooting"><a href="#9-Troubleshooting" class="headerlink" title="9 Troubleshooting"></a>9 Troubleshooting</h2><ul>
<li><strong>–help</strong>: 显示帮助</li>
<li><strong>–version</strong>: 版本号</li>
<li><strong>-v</strong>: 命令执行的详细信息</li>
</ul>
<h2 id="10-编译器相关的工具"><a href="#10-编译器相关的工具" class="headerlink" title="10 编译器相关的工具"></a>10 编译器相关的工具</h2><ul>
<li><strong>ar</strong>: 将一系列的 object 文件合并为单个 archive 文件，即库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ar cr libhello.a hello_fn.o bye_fn.o</span><br><span class="line">ar t libhello.a</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>c</strong>: create</li>
<li><strong>r</strong>: replace</li>
<li><strong>t</strong>: table of contents</li>
</ul>
<hr>
<ul>
<li><strong>gprof</strong>: 测量性能</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -c -pg collatz.c</span><br><span class="line">gcc -Wall -pg collatz.o</span><br><span class="line">gprof a.out</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>-gp</strong>: profiling option</li>
</ul>
<hr>
<ul>
<li><strong>gcov</strong>: 测量执行了多少行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -fprofile-arcs -ftest-coverage cov.c</span><br><span class="line">gcov cov.c</span><br></pre></td></tr></table></figure>
<h2 id="11-编译器是如何工作的"><a href="#11-编译器是如何工作的" class="headerlink" title="11 编译器是如何工作的"></a>11 编译器是如何工作的</h2><ul>
<li>预处理: <code>cpp hello.c &gt; hello.i</code></li>
<li>编译: <code>gcc -Wall -S hello.i</code></li>
<li>汇编: <code>as hello.s -o hello.o</code></li>
<li>链接: <code>ld -dynamic-linker /lib/ld-linux.so.2 /usr/lib/crt1.o /usr/lib/crti.o /usr/lib/gcc-lib/i686/3.3.1/crtbegin.o -L/usr/lib/gcc-lib/i686/3.3.1 hello.o -lgcc -lgcc_eh -lc -lgcc -lgcc_eh /usr/lib/gcc-lib/i686/3.3.1/crtend.o /usr/lib/crtn.o</code></li>
<li>运行: <code>./a.out</code></li>
</ul>
<h2 id="12-检查可执行文件和-object-文件的内容"><a href="#12-检查可执行文件和-object-文件的内容" class="headerlink" title="12 检查可执行文件和 object 文件的内容"></a>12 检查可执行文件和 object 文件的内容</h2><ul>
<li><strong>file</strong>: 查看 object 文件或者可执行文件的内容</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file a.out</span><br></pre></td></tr></table></figure>
<p>输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.out: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), not stripped</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ELF</strong>: The internal format of the executable file (ELF stands for “Executable and Linking Format”, other formats such as COFF “Common Object File Format” are used on some older operating systems (e.g. MS-DOS)).</li>
<li><strong>32-bit</strong>: The word size, 一些平台可能是 64 字节</li>
<li><strong>LSB</strong>: least significant byte first word ordering</li>
<li><strong>Inter 80386</strong>: 处理器</li>
<li><strong>version 1 (SYSV)</strong>: 文件格式的版本</li>
<li><strong>dynamically linked</strong>: 使用了动态链接库</li>
<li><strong>not stripped</strong>: The executable contains a symbol table (this can be removed with the strip command).</li>
</ul>
<hr>
<ul>
<li><strong>nm</strong>: 显示符号表, 存储了根据名字标识的函数和变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nm a.out</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><strong>ldd</strong>: 检查可执行文件列出它所需要的动态链接库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldd a.out</span><br></pre></td></tr></table></figure>
<h3 id="Basics-of-Working-with-gdb"><a href="#Basics-of-Working-with-gdb" class="headerlink" title="Basics of Working with gdb"></a>Basics of Working with gdb</h3><p><code>gdb</code> has a command-line interface similar to a Unix shell. You type a command and then press the <code>Enter key</code> (<strong>回车</strong>) to execute it. If you have never worked with <code>gdb</code> before, begin by executing the <code>help</code> command (<strong>帮助命令</strong>).</p>
<p><code>help</code> 还可以 <code>help</code> 子命令，例如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span> running</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.amazon.com/Introduction-GCC-GNU-Compilers/dp/0954161793" target="_blank" rel="noopener">《An Introduction to GCC》</a></li>
<li><a href="https://www.amazon.cn/dp/0596009577" target="_blank" rel="noopener">《Understanding MySQL Internals》</a></li>
</ul>






<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
